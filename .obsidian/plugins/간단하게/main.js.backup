const { Plugin, PluginSettingTab, Setting, ItemView, Notice, Modal, normalizePath } = require('obsidian');

const DEFAULT_SETTINGS = {
    problemsFolder: 'í•™ìŠµê´€ë¦¬/ë¬¸ì œì€í–‰',
    maxProblems: 500,
    dailyGoal: 5,
    targetDate: '2025-12-31',
    defaultSubject: 'ìˆ˜í•™',
    subjects: ['ìˆ˜í•™', 'ë¬¼ë¦¬', 'í™”í•™', 'ìƒë¬¼', 'ì˜ì–´', 'êµ­ì–´', 'í•œêµ­ì‚¬'],
    timerEnabled: true,
    autoRecordTime: true,
    autoRecordOnCheck: true,
    masteredColor: '#10b981',
    reviewingColor: '#f59e0b',
    learningColor: '#ef4444'
};

const VIEW_TYPE_STUDY_DASHBOARD = 'study-dashboard-view';

const PROBLEM_STATUS = {
    LEARNING: 'learning',
    REVIEWING: 'reviewing', 
    MASTERED: 'mastered',
    EMPTY: 'empty'
};

const REVIEW_GRADES = {
    S: { name: 'ì‹ ê¸‰', color: '#800080', minReviews: 10, emoji: 'ğŸ‘‘' },
    A: { name: 'ì œì™•ê¸‰', color: '#FFD700', minReviews: 7, emoji: 'â­' },
    B: { name: 'ì˜ì›…ê¸‰', color: '#B22222', minReviews: 5, emoji: 'ğŸ”¥' },
    C: { name: 'í‰ë¯¼', color: '#708090', minReviews: 3, emoji: 'ğŸ“š' },
    D: { name: 'í•˜ì¸µë¯¼', color: '#654321', minReviews: 2, emoji: 'ğŸ“–' },
    E: { name: 'ë…¸ì˜ˆ', color: '#2F4F4F', minReviews: 1, emoji: 'â›“ï¸' },
    F: { name: 'ê°€ì¶•', color: '#1a1a1a', minReviews: 0, emoji: 'ğŸ·' }
};

const getReviewGrade = (reviewCount, understanding = 0) => {
    if (reviewCount === 0 || understanding === 0) return 'F';
    if (reviewCount >= 10) return 'S';
    if (reviewCount >= 7) return 'A';
    if (reviewCount >= 5) return 'B';
    if (reviewCount >= 3) return 'C';
    if (reviewCount >= 2) return 'D';
    if (reviewCount >= 1) return 'E';
    return 'F';
};

const formatTime = (seconds) => {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
};

class StudyDashboardPlugin extends Plugin {
    async onload() {
        console.log('ğŸ“š Study Dashboard ë¡œë“œ ì‹œì‘');
        await this.loadSettings();
        this.registerView(VIEW_TYPE_STUDY_DASHBOARD, (leaf) => new StudyDashboardView(leaf, this));
        this.addStyles();
        this.addRibbonIcon('graduation-cap', 'ğŸ“š Study Dashboard', () => this.activateView());
        this.registerCommands();
        this.initializeTimerState();
        this.setupCheckboxListener();
        this.setupStopwatchListener();
        this.addSettingTab(new StudyDashboardSettingTab(this.app, this));
        console.log('âœ… Study Dashboard ë¡œë“œ ì™„ë£Œ!');
    }

    async onunload() {
        if (this.timerState?.interval) {
            clearInterval(this.timerState.interval);
        }
        if (this.stopwatchObserver) {
            this.stopwatchObserver.disconnect();
        }
    }
    
    async loadSettings() {
        this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
    }
    
    async saveSettings() {
        await this.saveData(this.settings);
    }
    
    async activateView() {
        this.app.workspace.detachLeavesOfType(VIEW_TYPE_STUDY_DASHBOARD);
        await this.app.workspace.getRightLeaf(false).setViewState({
            type: VIEW_TYPE_STUDY_DASHBOARD,
            active: true
        });
        this.app.workspace.revealLeaf(
            this.app.workspace.getLeavesOfType(VIEW_TYPE_STUDY_DASHBOARD)[0]
        );
    }
    
    registerCommands() {
        this.addCommand({
            id: 'open-study-dashboard',
            name: 'ğŸ“š Study Dashboard ì—´ê¸°',
            callback: () => this.activateView()
        });
        this.addCommand({
            id: 'create-new-problem',
            name: 'â• ìƒˆ ë¬¸ì œ ìƒì„±',
            callback: () => {
                new ProblemCreationModal(this.app, this).open();
            }
        });
        
        this.addCommand({
            id: 'test-timer-stop-modal',
            name: 'â±ï¸ íƒ€ì´ë¨¸ ì •ì§€ ëª¨ë‹¬ í…ŒìŠ¤íŠ¸',
            callback: () => {
                // í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ 5ë¶„ 30ì´ˆ (330ì´ˆ) ì„¤ì •
                this.showTimerStopModal(330);
            }
        });
    }
    
    initializeTimerState() {
        this.timerState = {
            isRunning: false,
            startTime: null,
            seconds: 0,
            interval: null,
            currentSubject: this.settings.defaultSubject,
            currentFile: null
        };
    }

    startTimer() {
        if (this.timerState.isRunning) return;
        
        const activeFile = this.app.workspace.getActiveFile();
        
        // íŒŒì¼ì´ ë¬¸ì œ í´ë” ì•ˆì— ìˆëŠ”ì§€ í™•ì¸
        if (activeFile && activeFile.path && activeFile.path.includes(this.settings.problemsFolder)) {
            this.timerState.currentFile = activeFile;
            console.log('íƒ€ì´ë¨¸ íŒŒì¼ ì„¤ì •ë¨:', activeFile.path);
        } else {
            this.timerState.currentFile = null;
            console.log('íƒ€ì´ë¨¸ íŒŒì¼ ì—†ìŒ - ë¬¸ì œ íŒŒì¼ì´ ì•„ë‹ˆê±°ë‚˜ ì—´ë ¤ìˆì§€ ì•ŠìŒ');
        }
        
        this.timerState.isRunning = true;
        this.timerState.startTime = Date.now();
        this.timerState.seconds = 0;
        this.timerState.interval = setInterval(() => {
            this.timerState.seconds++;
            this.updateTimerDisplay();
        }, 1000);
        
        new Notice('â±ï¸ íƒ€ì´ë¨¸ ì‹œì‘!');
    }

    async stopTimer() {
        if (!this.timerState.isRunning) return;
        
        this.timerState.isRunning = false;
        if (this.timerState.interval) {
            clearInterval(this.timerState.interval);
            this.timerState.interval = null;
        }
        
        const timeSpent = this.timerState.seconds;
        const timeString = formatTime(timeSpent);
        const currentFile = this.timerState.currentFile;
        
        // íƒ€ì´ë¨¸ ìƒíƒœ ì´ˆê¸°í™”
        this.timerState.currentFile = null;
        
        // ìë™ ê¸°ë¡ì´ í™œì„±í™”ë˜ì–´ ìˆê³  íŒŒì¼ì´ ìœ íš¨í•œ ê²½ìš°ì—ë§Œ ëª¨ë‹¬ ì—´ê¸°
        if (this.settings.autoRecordTime && currentFile && currentFile.path) {
            try {
                new UnderstandingModal(this.app, timeString, currentFile, async (understanding) => {
                    await this.addTimeAndUnderstanding(currentFile, timeString, understanding);
                }).open();
            } catch (error) {
                console.error('ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:', error);
                new Notice(`â¹ï¸ íƒ€ì´ë¨¸ ì •ì§€! ì†Œìš”ì‹œê°„: ${timeString}`);
            }
        } else {
            new Notice(`â¹ï¸ íƒ€ì´ë¨¸ ì •ì§€! ì†Œìš”ì‹œê°„: ${timeString}`);
        }
        
        return timeSpent;
    }

    async addTimeAndUnderstanding(file, timeString, understanding) {
        try {
            if (!file) {
                new Notice('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const content = await this.app.vault.read(file);
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
            
            if (!frontmatterMatch) {
                new Notice('âŒ Frontmatterë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const frontmatter = frontmatterMatch[1];
            const timesMatch = frontmatter.match(/times:\s*\[(.*?)\]/s);
            const understandingsMatch = frontmatter.match(/understandings:\s*\[(.*?)\]/s);
            
            let newTimes;
            if (timesMatch) {
                const existingTimes = timesMatch[1].trim();
                newTimes = existingTimes ? `times: [${existingTimes}, "${timeString}"]` : `times: ["${timeString}"]`;
            } else {
                newTimes = `times: ["${timeString}"]`;
            }
            
            let newUnderstandings;
            if (understandingsMatch) {
                const existingUnderstandings = understandingsMatch[1].trim();
                newUnderstandings = existingUnderstandings ? `understandings: [${existingUnderstandings}, ${understanding}]` : `understandings: [${understanding}]`;
            } else {
                newUnderstandings = `understandings: [${understanding}]`;
            }
            
            let newFrontmatter = frontmatter;
            if (timesMatch) {
                newFrontmatter = newFrontmatter.replace(/times:\s*\[.*?\]/s, newTimes);
            } else {
                newFrontmatter = newFrontmatter + '\n' + newTimes;
            }
            
            if (understandingsMatch) {
                newFrontmatter = newFrontmatter.replace(/understandings:\s*\[.*?\]/s, newUnderstandings);
            } else {
                newFrontmatter = newFrontmatter + '\n' + newUnderstandings;
            }
            
            const newContent = content.replace(/^---\n[\s\S]*?\n---/, `---\n${newFrontmatter}\n---`);
            await this.app.vault.modify(file, newContent);
            
            new Notice(`âœ… ê¸°ë¡ ì™„ë£Œ: ${timeString} / ì´í•´ë„ ${understanding}%`);
        } catch (error) {
            console.error('ì‹œê°„ ê¸°ë¡ ì˜¤ë¥˜:', error);
            new Notice('âŒ ì‹œê°„ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    resetTimer() {
        this.stopTimer();
        this.timerState.seconds = 0;
        this.updateTimerDisplay();
        new Notice('ğŸ”„ íƒ€ì´ë¨¸ ì´ˆê¸°í™”');
    }

    updateTimerDisplay() {
        const displays = document.querySelectorAll('.timer-display');
        displays.forEach(display => {
            display.textContent = formatTime(this.timerState.seconds);
        });
    }

    setupCheckboxListener() {
        console.log('ğŸ¯ ì²´í¬ë°•ìŠ¤ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹œì‘');
        
        // ê°„ë‹¨í•œ ì „ì—­ í´ë¦­ ì´ë²¤íŠ¸ë¡œ ì²´í¬ë°•ìŠ¤ ê°ì§€
        this.registerDomEvent(document, 'click', async (evt) => {
            const target = evt.target;
            
            // ì²´í¬ë°•ìŠ¤ì¸ì§€ í™•ì¸
            if (target && target.type === 'checkbox') {
                console.log('ğŸ“‹ ì²´í¬ë°•ìŠ¤ í´ë¦­ë¨:', target);
                
                // ì ì‹œ ëŒ€ê¸° í›„ ì²´í¬ ìƒíƒœ í™•ì¸
                setTimeout(async () => {
                    if (target.checked) {
                        console.log('âœ… ì²´í¬ë°•ìŠ¤ê°€ ì²´í¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        
                        const activeFile = this.app.workspace.getActiveFile();
                        if (activeFile) {
                            console.log('ğŸ“„ í™œì„± íŒŒì¼:', activeFile.path);
                            
                            // ì´í•´ë„ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
                            this.showUnderstandingDropdown(target, activeFile);
                            new Notice('ğŸ’¡ ì´í•´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                        } else {
                            console.log('âŒ í™œì„± íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');
                        }
                    }
                }, 100);
            }
        });
        
        console.log('âœ… ì²´í¬ë°•ìŠ¤ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
    }
        
        console.log('âœ… ì²´í¬ë°•ìŠ¤ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
    }
    }
    
    // ì²´í¬ë°•ìŠ¤ ì˜†ì— ì´í•´ë„ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
    showUnderstandingDropdown(checkbox, file) {
        console.log('showUnderstandingDropdown í˜¸ì¶œë¨:', checkbox);
        
        // ê¸°ì¡´ ë“œë¡­ë‹¤ìš´ ì œê±°
        const existingDropdown = document.querySelector('.understanding-dropdown-container');
        if (existingDropdown) {
            existingDropdown.remove();
        }
        
        // ì²´í¬ë°•ìŠ¤ì˜ ë¶€ëª¨ ìš”ì†Œ ì°¾ê¸°
        const listItem = checkbox.closest('li') || checkbox.closest('.task-list-item');
        console.log('listItem ì°¾ìŒ:', listItem);
        if (!listItem) {
            console.error('listItemì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // ë“œë¡­ë‹¤ìš´ ì»¨í…Œì´ë„ˆ ìƒì„±
        const dropdownContainer = document.createElement('div');
        dropdownContainer.className = 'understanding-dropdown-container';
        dropdownContainer.style.cssText = `
            display: inline-flex !important;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            padding: 8px 12px;
            background: #ff6b6b !important;
            border: 2px solid #ff4757 !important;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(255,107,107,0.3);
            animation: fadeIn 0.3s ease;
            z-index: 9999;
            position: relative;
        `;
        
        // ë ˆì´ë¸” ì¶”ê°€
        const label = document.createElement('span');
        label.textContent = 'ì´í•´ë„:';
        label.style.cssText = `
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
        `;
        
        // ë“œë¡­ë‹¤ìš´ ìƒì„±
        const select = document.createElement('select');
        select.style.cssText = `
            padding: 4px 8px;
            border: 1px solid var(--background-modifier-border);
            border-radius: 4px;
            background: var(--background-primary);
            color: var(--text-normal);
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 120px;
        `;
        
        // ìˆ˜ê¸° ì…ë ¥ í•„ë“œ ì¶”ê°€
        const manualInput = document.createElement('input');
        manualInput.type = 'number';
        manualInput.min = '0';
        manualInput.max = '100';
        manualInput.placeholder = 'ì§ì ‘ì…ë ¥';
        manualInput.style.cssText = `
            padding: 4px 8px;
            border: 1px solid var(--background-modifier-border);
            border-radius: 4px;
            background: var(--background-primary);
            color: var(--text-normal);
            font-size: 0.85rem;
            width: 80px;
            margin-left: 5px;
            display: none;
        `;
        
        // ì˜µì…˜ ì¶”ê°€
        const options = [
            { value: '', text: 'ì„ íƒí•˜ì„¸ìš”', color: '#6b7280' },
            { value: '100', text: 'ì™„ë²½ (100%)', color: '#10b981' },
            { value: '85', text: 'ìš°ìˆ˜ (85%)', color: '#3b82f6' },
            { value: '70', text: 'ì–‘í˜¸ (70%)', color: '#8b5cf6' },
            { value: '50', text: 'ë³´í†µ (50%)', color: '#f59e0b' },
            { value: '30', text: 'ë¶€ì¡± (30%)', color: '#ef4444' },
            { value: '15', text: 'ë¯¸í¡ (15%)', color: '#6b7280' },
            { value: '0', text: 'ì´í•´ì•ˆë¨ (0%)', color: '#374151' },
            { value: 'manual', text: 'ì§ì ‘ì…ë ¥', color: '#8b5cf6' }
        ];
        
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.text;
            option.style.color = opt.color;
            select.appendChild(option);
        });
        
        // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
        select.addEventListener('change', () => {
            if (select.value === 'manual') {
                manualInput.style.display = 'inline-block';
                manualInput.focus();
            } else {
                manualInput.style.display = 'none';
                manualInput.value = '';
            }
        });
        
        // í™•ì¸ ë²„íŠ¼
        const confirmBtn = document.createElement('button');
        confirmBtn.textContent = 'âœ…';
        confirmBtn.style.cssText = `
            padding: 4px 8px;
            border: none;
            background: var(--interactive-accent);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
        `;
        
        // ì·¨ì†Œ ë²„íŠ¼
        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'âŒ';
        cancelBtn.style.cssText = `
            padding: 4px 8px;
            border: none;
            background: var(--background-modifier-border);
            color: var(--text-normal);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        `;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        confirmBtn.addEventListener('click', async () => {
            const understanding = parseInt(select.value);
            if (isNaN(understanding)) {
                new Notice('âš ï¸ ì´í•´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            await this.addUnderstandingToFile(file, understanding);
            dropdownContainer.remove();
            new Notice(`âœ… ì´í•´ë„ ${understanding}% ê¸°ë¡ ì™„ë£Œ!`);
        });
        
        cancelBtn.addEventListener('click', () => {
            dropdownContainer.remove();
            new Notice('âŒ ì´í•´ë„ ì…ë ¥ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        
        // ë“œë¡­ë‹¤ìš´ êµ¬ì„±
        dropdownContainer.appendChild(label);
        dropdownContainer.appendChild(select);
        dropdownContainer.appendChild(confirmBtn);
        dropdownContainer.appendChild(cancelBtn);
        
        // DOMì— ì¶”ê°€ (ì—¬ëŸ¬ ìœ„ì¹˜ ì‹œë„)
        console.log('ë“œë¡­ë‹¤ìš´ì„ DOMì— ì¶”ê°€ ì‹œë„');
        
        // 1. listItemì— ì§ì ‘ ì¶”ê°€
        listItem.appendChild(dropdownContainer);
        console.log('listItemì— ì¶”ê°€ ì™„ë£Œ');
        
        // 2. ë§Œì•½ ë³´ì´ì§€ ì•Šìœ¼ë©´ bodyì— ì ˆëŒ€ ìœ„ì¹˜ë¡œ ì¶”ê°€
        setTimeout(() => {
            const rect = checkbox.getBoundingClientRect();
            if (!document.contains(dropdownContainer) || dropdownContainer.offsetParent === null) {
                console.log('ëŒ€ì²´ ìœ„ì¹˜ì— ë“œë¡­ë‹¤ìš´ ì¶”ê°€');
                dropdownContainer.style.position = 'fixed';
                dropdownContainer.style.top = `${rect.bottom + 5}px`;
                dropdownContainer.style.left = `${rect.left}px`;
                dropdownContainer.style.zIndex = '10000';
                document.body.appendChild(dropdownContainer);
            }
        }, 100);
        
        // í¬ì»¤ìŠ¤ ì„¤ì •
        select.focus();
        
        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        if (!document.querySelector('#understanding-dropdown-styles')) {
            const style = document.createElement('style');
            style.id = 'understanding-dropdown-styles';
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-5px); }
                    to { opacity: 1; transform: translateY(0); }
                }
                .understanding-dropdown-container select:hover {
                    border-color: var(--interactive-accent);
                }
                .understanding-dropdown-container button:hover {
                    transform: scale(1.05);
                    transition: transform 0.2s ease;
                }
            `;
            document.head.appendChild(style);
        }
        
        // í™•ì¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        confirmBtn.addEventListener('click', async () => {
            const selectedValue = select.value;
            if (!selectedValue) {
                new Notice('âš ï¸ ì´í•´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            await this.addUnderstandingToFile(file, parseInt(selectedValue));
            dropdownContainer.remove();
            
            new Notice(`âœ… ì´í•´ë„ ${selectedValue}% ì €ì¥ ì™„ë£Œ!`);
        });
        
        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        cancelBtn.addEventListener('click', () => {
            dropdownContainer.remove();
        });
        
        // ë“œë¡­ë‹¤ìš´ ì»¨í…Œì´ë„ˆì— ìš”ì†Œë“¤ ì¶”ê°€
        dropdownContainer.appendChild(label);
        dropdownContainer.appendChild(select);
        dropdownContainer.appendChild(confirmBtn);
        dropdownContainer.appendChild(cancelBtn);
        
        // ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œì— ë“œë¡­ë‹¤ìš´ ì¶”ê°€
        listItem.appendChild(dropdownContainer);
        
        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        if (!document.querySelector('#understanding-dropdown-styles')) {
            const style = document.createElement('style');
            style.id = 'understanding-dropdown-styles';
            style.textContent = `
                @keyframes fadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(-10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
            `;
            document.head.appendChild(style);
        }
    }
    
    // ì´í•´ë„ë¥¼ íŒŒì¼ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    async addUnderstandingToFile(file, understanding) {
        try {
            const content = await this.app.vault.read(file);
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
            
            let newContent = content;
            
            if (frontmatterMatch) {
                const frontmatter = frontmatterMatch[1];
                const understandingsMatch = frontmatter.match(/understandings:\s*\[(.*?)\]/);
                
                let newUnderstandings;
                if (understandingsMatch) {
                    const existingUnderstandings = understandingsMatch[1].trim();
                    newUnderstandings = existingUnderstandings ? 
                        `understandings: [${existingUnderstandings}, ${understanding}]` : 
                        `understandings: [${understanding}]`;
                    newContent = content.replace(/understandings:\s*\[.*?\]/, newUnderstandings);
                } else {
                    newContent = content.replace(
                        frontmatterMatch[0],
                        `---\n${frontmatter}understandings: [${understanding}]\n---`
                    );
                }
            } else {
                newContent = `---\nunderstandings: [${understanding}]\n---\n\n${content}`;
            }
            
            await this.app.vault.modify(file, newContent);
        } catch (error) {
            console.error('ì´í•´ë„ ì¶”ê°€ ì˜¤ë¥˜:', error);
            new Notice('âŒ ì´í•´ë„ ê¸°ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async handleCheckboxChange(target) {
        if (!this.settings.autoRecordOnCheck) return;
        
        const activeFile = this.app.workspace.getActiveFile();
        if (!activeFile || !activeFile.path.includes(this.settings.problemsFolder)) return;
        
        try {
            const content = await this.app.vault.read(activeFile);
            const line = this.getLineFromCheckbox(target);
            
            if (line && (line.includes('ì°¨ ë³µìŠµ') || line.includes('ë³µìŠµ') || line.includes('ğŸ”¥') || line.includes('ğŸ”„'))) {
                // ì‹œê°„ ê¸°ë¡
                const now = new Date();
                const timeString = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                await this.addTimeToFile(activeFile, timeString);
                
                // ì´í•´ë„ ëª¨ë‹¬
                let existingUnderstandings = [];
                const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
                
                if (frontmatterMatch) {
                    const frontmatter = frontmatterMatch[1];
                    const understandingsMatch = frontmatter.match(/understandings:\s*\[(.*?)\]/s);
                    
                    if (understandingsMatch) {
                        existingUnderstandings = understandingsMatch[1]
                            .split(',')
                            .map(u => parseInt(u.trim()))
                            .filter(u => !isNaN(u));
                    }
                }
                
                const modal = new TimerStopModal(this.app, this, 0, existingUnderstandings);
                modal.open();
                
                new Notice('âœ… ìë™ ê¸°ë¡ ì™„ë£Œ! ì´í•´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }
        } catch (error) {
            console.error('ì²´í¬ë°•ìŠ¤ ë³€í™” ì²˜ë¦¬ ì˜¤ë¥˜:', error);
        }
    }

    setupStopwatchListener() {
        // ìŠ¤í†±ì›Œì¹˜ í”ŒëŸ¬ê·¸ì¸ê³¼ì˜ ì—°ë™ì„ ìœ„í•œ ë¦¬ìŠ¤ë„ˆ
        this.registerDomEvent(document, 'stopwatch-stopped', async (evt) => {
            try {
                const { time, formattedTime } = evt.detail;
                const activeFile = this.app.workspace.getActiveFile();
                
                if (!activeFile || !activeFile.path.includes(this.settings.problemsFolder)) {
                    return;
                }
                
                // ìŠ¤í†±ì›Œì¹˜ì—ì„œ ë°›ì€ ì‹œê°„ì„ times ë°°ì—´ì— ì¶”ê°€
                await this.addTimeToFile(activeFile, formattedTime || this.formatStopwatchTime(time));
                
                // íƒ€ì´ë¨¸ ì •ì§€ ëª¨ë‹¬ í‘œì‹œ (ì´í•´ë„ ì„ íƒìš©)
                if (this.settings.autoRecordTime) {
                    const timeInSeconds = this.parseTimeToSeconds(formattedTime || time);
                    await this.showTimerStopModal(timeInSeconds);
                }
                
            } catch (error) {
                console.error('ìŠ¤í†±ì›Œì¹˜ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            }
        });
        
        // DOMì—ì„œ ìŠ¤í†±ì›Œì¹˜ ì •ì§€ ë²„íŠ¼ í´ë¦­ ê°ì§€
        this.registerDomEvent(document, 'click', async (evt) => {
            const target = evt.target;
            
            // ë‹¤ì–‘í•œ ìŠ¤í†±ì›Œì¹˜ í”ŒëŸ¬ê·¸ì¸ì˜ ì •ì§€ ë²„íŠ¼ ê°ì§€
            const isStopwatchStop = target.closest('.stopwatch-container, .timer-container, .stopwatch, .timer-widget') && 
                (target.classList.contains('stop-btn') || 
                 target.classList.contains('stop') ||
                 target.classList.contains('pause') ||
                 target.textContent.includes('ì •ì§€') || 
                 target.textContent.includes('Stop') ||
                 target.textContent.includes('Pause') ||
                 target.textContent.includes('â– ') ||
                 target.innerHTML.includes('â¸') ||
                 target.innerHTML.includes('â¹'));
            
            if (isStopwatchStop) {
                setTimeout(async () => {
                    try {
                        const activeFile = this.app.workspace.getActiveFile();
                        if (!activeFile || !activeFile.path.includes(this.settings.problemsFolder)) {
                            return;
                        }
                        
                        // ìŠ¤í†±ì›Œì¹˜ ì»¨í…Œì´ë„ˆì—ì„œ í˜„ì¬ ì‹œê°„ ì½ê¸°
                        const stopwatchContainer = target.closest('.stopwatch-container, .timer-container, .stopwatch, .timer-widget');
                        const timeDisplay = stopwatchContainer?.querySelector(
                            '.time-display, .stopwatch-time, .timer-display, .time, .duration, .elapsed-time, .current-time'
                        );
                        
                        if (timeDisplay) {
                            const timeText = timeDisplay.textContent || timeDisplay.innerText;
                            if (timeText && timeText !== '00:00:00' && timeText !== '00:00') {
                                await this.addTimeToFile(activeFile, timeText);
                                new Notice(`â° ìŠ¤í†±ì›Œì¹˜ ì‹œê°„ ê¸°ë¡: ${timeText}`);
                                
                                // íƒ€ì´ë¨¸ ì •ì§€ ëª¨ë‹¬ í‘œì‹œ
                                if (this.settings.autoRecordTime) {
                                    const timeInSeconds = this.parseTimeToSeconds(timeText);
                                    await this.showTimerStopModal(timeInSeconds);
                                }
                            }
                        }
                        
                    } catch (error) {
                        console.error('ìŠ¤í†±ì›Œì¹˜ ì •ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    }
                }, 200); // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ DOM ì—…ë°ì´íŠ¸ ê¸°ë‹¤ë¦¼
            }
        });
        
        // MutationObserverë¥¼ ì‚¬ìš©í•œ ìŠ¤í†±ì›Œì¹˜ ìƒíƒœ ë³€í™” ê°ì§€
        this.stopwatchObserver = new MutationObserver((mutations) => {
            mutations.forEach(async (mutation) => {
                if (mutation.type === 'childList' || mutation.type === 'characterData') {
                    const target = mutation.target;
                    
                    // ìŠ¤í†±ì›Œì¹˜ ì‹œê°„ í‘œì‹œê°€ ë³€ê²½ëœ ê²½ìš°
                    if (target.classList && (
                        target.classList.contains('time-display') ||
                        target.classList.contains('stopwatch-time') ||
                        target.classList.contains('timer-display')
                    )) {
                        // ì‹œê°„ì´ ì •ì§€ëœ ê²ƒì„ ê°ì§€í•˜ê¸° ìœ„í•œ ë¡œì§
                        // (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” ë” ì •êµí•œ ê°ì§€ ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŒ)
                    }
                }
            });
        });
        
        // document.bodyë¥¼ ê´€ì°°í•˜ì—¬ ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” ìŠ¤í†±ì›Œì¹˜ ê°ì§€
        if (document.body) {
            this.stopwatchObserver.observe(document.body, {
                childList: true,
                subtree: true,
                characterData: true
            });
        }
    }

    formatStopwatchTime(timeValue) {
        // ìŠ¤í†±ì›Œì¹˜ì—ì„œ ë°›ì€ ì‹œê°„ì„ HH:MM:SS í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        if (typeof timeValue === 'number') {
            // ë°€ë¦¬ì´ˆì¸ ê²½ìš°
            const totalSeconds = Math.floor(timeValue / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        return timeValue;
    }

    parseTimeToSeconds(timeString) {
        if (!timeString) return 0;
        
        // "5ë¶„ 30ì´ˆ" í˜•ì‹ ì²˜ë¦¬
        const koreanMatch = timeString.match(/(?:(\d+)ì‹œê°„\s*)?(?:(\d+)ë¶„\s*)?(?:(\d+)ì´ˆ)?/);
        if (koreanMatch) {
            const hours = parseInt(koreanMatch[1]) || 0;
            const minutes = parseInt(koreanMatch[2]) || 0;
            const seconds = parseInt(koreanMatch[3]) || 0;
            return hours * 3600 + minutes * 60 + seconds;
        }
        
        // "05:30" ë˜ëŠ” "01:05:30" í˜•ì‹ ì²˜ë¦¬
        const parts = timeString.split(':');
        if (parts.length === 3) {
            return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
        } else if (parts.length === 2) {
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }
        
        // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° (ì´ˆ ë‹¨ìœ„)
        const numericValue = parseInt(timeString);
        return isNaN(numericValue) ? 0 : numericValue;
    }

    getLineFromCheckbox(checkbox) {
        let element = checkbox;
        while (element && element.tagName !== 'LI') {
            element = element.parentElement;
        }
        return element ? element.textContent : null;
    }

    async addTimeToFile(file, timeString) {
        try {
            const content = await this.app.vault.read(file);
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
            if (!frontmatterMatch) return;
            const frontmatter = frontmatterMatch[1];
            const timesMatch = frontmatter.match(/times:\s*\[(.*?)\]/s);
            let newTimes;
            if (timesMatch) {
                const existingTimes = timesMatch[1].trim();
                if (existingTimes) {
                    newTimes = `times: [${existingTimes}, "${timeString}"]`;
                } else {
                    newTimes = `times: ["${timeString}"]`;
                }
            } else {
                newTimes = `times: ["${timeString}"]`;
            }
            let newFrontmatter;
            if (timesMatch) {
                newFrontmatter = frontmatter.replace(/times:\s*\[.*?\]/s, newTimes);
            } else {
                newFrontmatter = frontmatter + '\n' + newTimes;
            }
            const newContent = content.replace(/^---\n[\s\S]*?\n---/, `---\n${newFrontmatter}\n---`);
            await this.app.vault.modify(file, newContent);
            new Notice(`â° ì²´í¬ ì‹œê°„ ê¸°ë¡: ${timeString}`);
        } catch (error) {
            console.error('ì²´í¬ë°•ìŠ¤ ì‹œê°„ ê¸°ë¡ ì˜¤ë¥˜:', error);
        }
    }

    // íƒ€ì´ë¨¸ ì •ì§€ ì‹œ í˜¸ì¶œë˜ëŠ” ë©”ì„œë“œ
    async showTimerStopModal(timerDuration) {
        try {
            // í˜„ì¬ í™œì„± íŒŒì¼ì—ì„œ ê¸°ì¡´ ì´í•´ë„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const activeFile = this.app.workspace.getActiveFile();
            let existingUnderstandings = [];
            
            if (activeFile && activeFile.extension === 'md') {
                const content = await this.app.vault.read(activeFile);
                const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
                
                if (frontmatterMatch) {
                    const frontmatter = frontmatterMatch[1];
                    const understandingsMatch = frontmatter.match(/understandings:\s*\[(.*?)\]/s);
                    
                    if (understandingsMatch) {
                        existingUnderstandings = understandingsMatch[1]
                            .split(',')
                            .map(u => parseInt(u.trim()))
                            .filter(u => !isNaN(u));
                    }
                }
            }
            
            // íƒ€ì´ë¨¸ ì •ì§€ ëª¨ë‹¬ ì—´ê¸°
            const modal = new TimerStopModal(this.app, this, timerDuration, existingUnderstandings);
            modal.open();
            
        } catch (error) {
            console.error('íƒ€ì´ë¨¸ ì •ì§€ ëª¨ë‹¬ ì˜¤ë¥˜:', error);
            new Notice('âŒ íƒ€ì´ë¨¸ ì •ì§€ ëª¨ë‹¬ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    async checkProblemExists(subject, number) {
        try {
            const subjectFolder = normalizePath(`${this.settings.problemsFolder}/${subject}`);
            const files = this.app.vault.getMarkdownFiles()
                .filter(file => file && file.path && file.path.startsWith(subjectFolder));
            const existingFile = files.find(file => {
                if (!file || !file.basename) return false;
                const match = file.basename.match(/^(\d+)_/);
                return match && parseInt(match[1]) === number;
            });
            return existingFile;
        } catch (error) {
            console.error('checkProblemExists ì˜¤ë¥˜:', error);
            return null;
        }
    }

    async createProblem(subject, number, title, difficulty = 3) {
        try {
            const subjectFolder = normalizePath(`${this.settings.problemsFolder}/${subject}`);
            try {
                await this.app.vault.createFolder(subjectFolder);
            } catch (folderError) {
            }
            const existingFile = await this.checkProblemExists(subject, number);
            if (existingFile) {
                new Notice(`âŒ ${subject} ${number}ë²ˆ ë¬¸ì œê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤: ${existingFile.basename}`);
                return false;
            }
            const fileName = `${String(number).padStart(3, '0')}_${title.replace(/[^\wê°€-í£]/g, '_')}.md`;
            const filePath = normalizePath(`${subjectFolder}/${fileName}`);
            const today = new Date().toISOString().split('T')[0];
            const content = `---
number: ${number}
title: "${title}"
subject: ${subject}
difficulty: ${difficulty}
reviewCount: 0
times: []
understandings: []
understanding: 0
created: ${today}
tags: [anki-card, ${subject}, study-dashboard]
---

# ${number}. ${title}

> ğŸ“š **ì¶œì²˜**: (ì¶œì²˜ëª…) (í˜ì´ì§€)  
> ğŸ“– **ë‹¨ì›**: ${subject}  
> â­ **ë‚œì´ë„**: ${difficulty}/5

---

## ğŸ“Š ë³µìŠµ ì§„í–‰ í˜„í™©

\`\`\`dataviewjs
// ğŸ“Š í˜„ì¬ íŒŒì¼ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
const current = dv.current();
const content = await dv.io.load(current.file.path);

// ğŸ” ì²´í¬ëœ ë³µìŠµ íšŸìˆ˜ ê³„ì‚°
const checkedCount = (content.match(/- \\[x\\] .*?ë³µìŠµ/gi) || []).length;
const times = current.times || [];
const understandings = current.understandings || [];
const avgUnderstanding = understandings.length > 0 
    ? Math.round(understandings.reduce((a, b) => a + b, 0) / understandings.length) 
    : 0;

// ğŸ¯ ë“±ê¸‰ ì‹œìŠ¤í…œ
const getGrade = (count, understand) => {
    const grades = [
        { min: 10, name: 'ì‹ ê¸‰', emoji: 'ğŸ‘‘', level: 'S', color: '#ff6b6b' },
        { min: 7, name: 'ì œì™•ê¸‰', emoji: 'â­', level: 'A', color: '#4ecdc4' },
        { min: 5, name: 'ì˜ì›…ê¸‰', emoji: 'ğŸ”¥', level: 'B', color: '#45b7d1' },
        { min: 3, name: 'í‰ë¯¼', emoji: 'ğŸ“š', level: 'C', color: '#96ceb4' },
        { min: 2, name: 'í•˜ì¸µë¯¼', emoji: 'ğŸ“–', level: 'D', color: '#feca57' },
        { min: 1, name: 'ë…¸ì˜ˆ', emoji: 'â›“ï¸', level: 'E', color: '#ff9ff3' },
        { min: 0, name: 'ê°€ì¶•', emoji: 'ğŸ·', level: 'F', color: '#54a0ff' }
    ];
    return grades.find(g => count >= g.min) || grades[grades.length - 1];
};

// â° ì‹œê°„ í¬ë§·íŒ… (í•œêµ­ì–´ í˜•ì‹ìœ¼ë¡œ ê°œì„ )
const formatTime = (timeStr) => {
    if (!timeStr || timeStr === '-') return '-';
    
    const str = String(timeStr);
    
    // HH:MM:SS ë˜ëŠ” HH:MM:SS.mmm í˜•ì‹ ì²˜ë¦¬
    const timeMatch = str.match(/^(\d{1,2}):(\d{2}):(\d{2})(?:\.(\d{3}))?$/);
    if (timeMatch) {
        const hours = parseInt(timeMatch[1]);
        const minutes = parseInt(timeMatch[2]);
        const seconds = parseInt(timeMatch[3]);
        
        // ì‹œë¶„ì´ˆ í˜•ì‹ìœ¼ë¡œ ë°˜í™˜
        if (hours > 0) {
            return \`\${String(hours).padStart(2, '0')}ì‹œ \${String(minutes).padStart(2, '0')}ë¶„ \${String(seconds).padStart(2, '0')}ì´ˆ\`;
        } else {
            return \`\${String(minutes).padStart(2, '0')}ë¶„ \${String(seconds).padStart(2, '0')}ì´ˆ\`;
        }
    }
    
    // MM:SS í˜•ì‹ ì²˜ë¦¬
    const shortMatch = str.match(/^(\d{1,2}):(\d{2})$/);
    if (shortMatch) {
        const minutes = parseInt(shortMatch[1]);
        const seconds = parseInt(shortMatch[2]);
        return \`\${String(minutes).padStart(2, '0')}ë¶„ \${String(seconds).padStart(2, '0')}ì´ˆ\`;
    }
    
    // ì´ˆ ë‹¨ìœ„ ìˆ«ì ì²˜ë¦¬
    const numericTime = parseInt(str);
    if (!isNaN(numericTime)) {
        const hours = Math.floor(numericTime / 3600);
        const minutes = Math.floor((numericTime % 3600) / 60);
        const seconds = numericTime % 60;
        
        if (hours > 0) {
            return \`\${String(hours).padStart(2, '0')}ì‹œ \${String(minutes).padStart(2, '0')}ë¶„ \${String(seconds).padStart(2, '0')}ì´ˆ\`;
        } else {
            return \`\${String(minutes).padStart(2, '0')}ë¶„ \${String(seconds).padStart(2, '0')}ì´ˆ\`;
        }
    }
    
    return str;
};

// ğŸ“ˆ í†µê³„ ê³„ì‚°
const grade = getGrade(checkedCount, avgUnderstanding);
const progress = Math.min((checkedCount / 10) * 100, 100);
const lastTime = times.length > 0 ? formatTime(times[times.length - 1]) : '-';

// ğŸ¨ ìƒë‹¨ í†µê³„ ì¹´ë“œ
const statsCard = \`
<div style="
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 25px;
    border-radius: 20px;
    margin: 20px 0;
    color: white;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
">
    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
        <div style="font-size: 4rem; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));">
            \${grade.emoji}
        </div>
        <div style="flex: 1;">
            <div style="font-size: 1.8rem; font-weight: 800; margin-bottom: 5px;">
                \${grade.level}ê¸‰ - \${grade.name}
            </div>
            <div style="font-size: 1rem; opacity: 0.9;">
                ë³µìŠµ \${checkedCount}/10íšŒ ì™„ë£Œ (\${progress.toFixed(0)}%)
            </div>
        </div>
    </div>
    
    <div style="
        background: rgba(255,255,255,0.1);
        border-radius: 15px;
        padding: 3px;
        margin-bottom: 20px;
    ">
        <div style="
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            height: 12px;
            border-radius: 12px;
            width: \${progress}%;
            transition: width 0.3s ease;
        "></div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 700;">\${checkedCount}íšŒ</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">ë³µìŠµ ì™„ë£Œ</div>
        </div>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 700;">\${avgUnderstanding}%</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">í‰ê·  ì´í•´ë„</div>
        </div>
        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; text-align: center;">
            <div style="font-size: 1.5rem; font-weight: 700;">\${lastTime}</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">ìµœê·¼ ì‹œê°„</div>
        </div>
    </div>
</div>
\`;

// ğŸ“‹ í…Œì´ë¸” ìƒì„±
const createTable = () => {
    const tableData = [];
    let cumulative = 0;
    
    for (let i = 1; i <= 10; i++) {
        const isCompleted = i <= checkedCount;
        const isCurrent = i === checkedCount + 1;
        
        // ìƒíƒœ ê²°ì •
        let status, statusColor, statusIcon;
        if (isCompleted) {
            status = 'ì™„ë£Œ';
            statusColor = '#2ecc71';
            statusIcon = 'âœ…';
        } else if (isCurrent) {
            status = 'ì§„í–‰ì¤‘';
            statusColor = '#f39c12';
            statusIcon = 'â³';
        } else {
            status = 'ëŒ€ê¸°ì¤‘';
            statusColor = '#95a5a6';
            statusIcon = 'â¬œ';
        }
        
        // ë°ì´í„° ìˆ˜ì§‘
        const time = i <= times.length ? formatTime(times[i - 1]) : '-';
        const understanding = i <= understandings.length ? understandings[i - 1] : null;
        const understandingDisplay = understanding !== null ? \`\${understanding}%\` : '-';
        
        if (understanding !== null) {
            cumulative += understanding;
        }
        
        const avgDisplay = understanding !== null ? \`\${Math.round(cumulative / i)}%\` : '-';
        
        // ì´í•´ë„ ìƒ‰ìƒ
        let understandingColor = '#95a5a6';
        if (understanding !== null) {
            if (understanding >= 85) understandingColor = '#2ecc71';
            else if (understanding >= 70) understandingColor = '#3498db';
            else if (understanding >= 50) understandingColor = '#f39c12';
            else understandingColor = '#e74c3c';
        }
        
        tableData.push([
            \`<div style="
                background: linear-gradient(135deg, #6c5ce7, #a29bfe);
                color: white;
                width: 35px;
                height: 35px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 0.9rem;
                margin: 0 auto;
            ">\${i}</div>\`,
            
            \`<span style="
                background: \${statusColor};
                color: white;
                padding: 6px 12px;
                border-radius: 20px;
                font-size: 0.8rem;
                font-weight: 600;
                display: inline-flex;
                align-items: center;
                gap: 5px;
                white-space: nowrap;
            ">\${statusIcon} \${status}</span>\`,
            
            \`<span style="color: var(--text-normal); font-weight: 500;">\${time}</span>\`,
            
            \`<span style="
                background: \${understandingColor};
                color: white;
                padding: 4px 10px;
                border-radius: 15px;
                font-size: 0.8rem;
                font-weight: 600;
                display: inline-block;
                min-width: 45px;
                text-align: center;
            ">\${understandingDisplay}</span>\`,
            
            \`<span style="
                color: var(--interactive-accent);
                font-weight: 700;
                font-size: 1rem;
            ">\${avgDisplay}</span>\`
        ]);
    }
    
    return tableData;
};

// ğŸ¨ í…Œì´ë¸” ë Œë”ë§
const tableData = createTable();
const headers = ['ğŸ”¢ íšŒì°¨', 'ğŸ“Š ìƒíƒœ', 'â° ì†Œìš”ì‹œê°„', 'ğŸ¯ ì´í•´ë„', 'ğŸ“ˆ ëˆ„ì í‰ê· '];

// ìƒë‹¨ ì¹´ë“œ ì¶œë ¥
dv.paragraph(statsCard);

// í…Œì´ë¸” ì¶œë ¥
dv.table(headers, tableData);
\`\`\`

---

## â±ï¸ ë¬¸ì œ í’€ì´ íƒ€ì´ë¨¸

\`\`\`stopwatch
title: "${subject} ${number}ë²ˆ - ${title}"
showMilliseconds: true
autoStart: false
theme: purple
recordToField: times
\`\`\`

> [!tip]+ ğŸ¯ ìë™ ì‹œê°„ ê¸°ë¡ í™œì„±í™”!
> 
> **ë°©ë²• 1: íƒ€ì´ë¨¸ ì‚¬ìš©**  
> íƒ€ì´ë¨¸ ì •ì§€ ì‹œ ìë™ìœ¼ë¡œ timesì— ê¸°ë¡ë¨!
> 
> **ë°©ë²• 2: ì²´í¬ë°•ìŠ¤ ì‚¬ìš©**  
> ì²´í¬ë°•ìŠ¤ ì²´í¬ ì‹œ ìë™ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ì´ timesì— ê¸°ë¡ë¨!

---

## ğŸ“¸ ë¬¸ì œ

> [!info]+ ğŸ–¼ï¸ ë¬¸ì œ ì´ë¯¸ì§€
> 
> ì´ë¯¸ì§€ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”

---

## ğŸ’¡ íŒíŠ¸

> [!hint]- ğŸ’¡ íŒíŠ¸ ë³´ê¸°
> 
> íŒíŠ¸ ë‚´ìš©

---

## âœ… ì •ë‹µ ë° í’€ì´

> [!success]- ğŸ” ì •ë‹µ ë³´ê¸°
> 
> **ì •ë‹µ:** 
> 
> **í’€ì´:**

---

## ğŸ“ ë©”ëª¨

> [!note]- ğŸ“ ê°œì¸ ë©”ëª¨
> 
> - 
> - 

---

## âœ… ë³µìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸

> [!tip]+ ğŸ¯ ìŠ¤ë§ˆíŠ¸ ë³µìŠµ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‚¬ìš©ë²•
> 
> **ğŸ“‹ ì´ë ‡ê²Œ ì‚¬ìš©í•˜ì„¸ìš”:**
> 1. âœ… **ì²´í¬ë°•ìŠ¤ í´ë¦­** â†’ í˜„ì¬ ì‹œê°„ ìë™ ê¸°ë¡
> 2. ğŸ“Š **ì´í•´ë„ ì„ íƒ ëª¨ë‹¬** â†’ 0~100% ì¤‘ ì„ íƒ
> 3. ğŸ¯ **ìë™ ì €ì¥** â†’ ëŒ€ì‹œë³´ë“œì— ì‹¤ì‹œê°„ ë°˜ì˜
> 
> **ğŸ’¡ íŒ:** ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ë©´ ì´í•´ë„ ì…ë ¥ì°½ì´ ìë™ìœ¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤!
> 
> **âš™ï¸ ìë™ ê¸°ëŠ¥ì´ ì‘ë™í•˜ì§€ ì•Šë‚˜ìš”?**
> - í”ŒëŸ¬ê·¸ì¸ ì„¤ì • â†’ "Study Dashboard" â†’ "ì²´í¬ë°•ìŠ¤ ìë™ ê¸°ë¡" í™œì„±í™” í™•ì¸
> - ë˜ëŠ” ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬ í•´ì œ í›„ ë‹¤ì‹œ ì²´í¬í•´ë³´ì„¸ìš”

### ğŸ“š ë³µìŠµ ì§„í–‰ ì²´í¬

- [ ] **1ì°¨ ë³µìŠµ** ï¿½ | ê¸°ë³¸ ì´í•´ ë‹¨ê³„
- [ ] **2ì°¨ ë³µìŠµ** ï¿½ | ì •í™•ë„ í–¥ìƒ ë‹¨ê³„  
- [ ] **3ì°¨ ë³µìŠµ** ğŸ¯ | ì†ë„ í–¥ìƒ ë‹¨ê³„
- [ ] **4ì°¨ ë³µìŠµ** âš¡ | ì™„ë²½ ì´í•´ ë‹¨ê³„
- [ ] **5ì°¨ ë³µìŠµ** ï¿½ | ì‘ìš© ëŠ¥ë ¥ ë‹¨ê³„
- [ ] **6ì°¨ ë³µìŠµ** ï¿½ | ì‹¬í™” í•™ìŠµ ë‹¨ê³„
- [ ] **7ì°¨ ë³µìŠµ** ğŸ’ | ë§ˆìŠ¤í„° ë‹¨ê³„
- [ ] **8ì°¨ ë³µìŠµ** ï¿½ | ì „ë¬¸ê°€ ë‹¨ê³„
- [ ] **9ì°¨ ë³µìŠµ** â­ | ì™„ë²½ ìˆ™ë‹¬ ë‹¨ê³„
- [ ] **10ì°¨ ë³µìŠµ** ğŸ† | ì‹ ê¸‰ ë‹¬ì„±!

> [!success]+ ï¿½ ìë™ ê¸°ë¡ ì‹œìŠ¤í…œ
> 
> **âœ… ì²´í¬ ì‹œ ìë™ ê¸°ë¡:**
> - â° í˜„ì¬ ì‹œê°„ â†’ \`times\` ë°°ì—´ì— ì¶”ê°€
> - ğŸ§  ì´í•´ë„ ì„ íƒ ëª¨ë‹¬ â†’ \`understandings\` ë°°ì—´ì— ì¶”ê°€
> - ï¿½ í‰ê·  ì´í•´ë„ ìë™ ê³„ì‚°
> 
> **ğŸ® ì´í•´ë„ ë“±ê¸‰:**
> - ğŸ† **Sê¸‰ (90-100%)**: ì‹ ê¸‰ - ì™„ë²½ ì´í•´
> - â­ **Aê¸‰ (80-89%)**: ì œì™•ê¸‰ - ê±°ì˜ ì™„ë²½
> - ğŸ”¥ **Bê¸‰ (70-79%)**: ì˜ì›…ê¸‰ - ì˜ ì´í•´í•¨
> - ï¿½ **Cê¸‰ (60-69%)**: í‰ë¯¼ - ë³´í†µ ì´í•´
> - ğŸ“– **Dê¸‰ (40-59%)**: í•˜ì¸µë¯¼ - ì¡°ê¸ˆ ì´í•´
> - â›“ï¸ **Eê¸‰ (20-39%)**: ë…¸ì˜ˆ - ê±°ì˜ ëª¨ë¦„
> - ğŸ· **Fê¸‰ (0-19%)**: ê°€ì¶• - ì „í˜€ ëª¨ë¦„

> [!warning]+ ğŸ¯ ë³µìŠµ ì™„ë£Œ í›„ ê¸°ë¡ ë°©ë²•
> 
> ### ğŸŸ¢ ìë™ ê¸°ë¡ (ì¶”ì²œ - ë§¤ìš° ê°„í¸!):
> 1. âœ… **ì²´í¬ë°•ìŠ¤ë§Œ í´ë¦­í•˜ì„¸ìš”!**
> 2. ğŸ¯ **ì´í•´ë„ ì„ íƒ ëª¨ë‹¬ì´ ìë™ íŒì—…**
> 3. ğŸ“Š **0~100% ì¤‘ì—ì„œ ì„ íƒ** (10% ë‹¨ìœ„)
> 4. âœ… **í™•ì¸ ë²„íŠ¼** â†’ ëª¨ë“  ë°ì´í„° ìë™ ì €ì¥!
> 
> ### ğŸ”§ ìˆ˜ë™ ê¸°ë¡ (ê³ ê¸‰ ì‚¬ìš©ììš©):
> - Frontmatterì— ì§ì ‘ ì¶”ê°€:
>    \\\`\\\`\\\`yaml
>    times: ["00:05:30", "00:04:20"]
>    understandings: [70, 85]
>    \\\`\\\`\\\`

---

## ğŸ“ˆ ê¸°ë¡ ì˜ˆì‹œ

> [!example]- ğŸ“Š ìë™ ê¸°ë¡ëœ ì˜ˆì‹œ
> 
> \\\`\\\`\\\`yaml
> times: ["00:05:30", "00:04:20", "00:03:45"]
> understandings: [60, 75, 85]
> \\\`\\\`\\\`
> 
> - 1ì°¨: 5ë¶„ 30ì´ˆ ì†Œìš”, ì´í•´ë„ 60%
> - 2ì°¨: 4ë¶„ 20ì´ˆ ì†Œìš”, ì´í•´ë„ 75%
> - 3ì°¨: 3ë¶„ 45ì´ˆ ì†Œìš”, ì´í•´ë„ 85%
> 
> **ì²´í¬ë°•ìŠ¤ëŠ” ì²˜ìŒì— ë¹ˆ ìƒíƒœì…ë‹ˆë‹¤:**
> - [ ] 1ì°¨ ë³µìŠµ ì‹œ ìë™ìœ¼ë¡œ ì‹œê°„ê³¼ ì´í•´ë„ê°€ ê¸°ë¡ë©ë‹ˆë‹¤
> - [ ] 2ì°¨ ë³µìŠµ ì‹œ ìë™ìœ¼ë¡œ ì‹œê°„ê³¼ ì´í•´ë„ê°€ ê¸°ë¡ë©ë‹ˆë‹¤
> - [ ] 3ì°¨ ë³µìŠµ ì‹œ ìë™ìœ¼ë¡œ ì‹œê°„ê³¼ ì´í•´ë„ê°€ ê¸°ë¡ë©ë‹ˆë‹¤

---

*ìë™ ì‹œê°„ ê¸°ë¡ ê¸°ëŠ¥ìœ¼ë¡œ ë” í¸ë¦¬í•˜ê²Œ!*
`;
            await this.app.vault.create(filePath, content);
            const newFile = this.app.vault.getAbstractFileByPath(filePath);
            if (newFile) {
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(newFile);
                const editor = leaf.view.editor;
                if (editor) {
                    const lineCount = editor.lineCount();
                    for (let i = 0; i < lineCount; i++) {
                        const line = editor.getLine(i);
                        if (line.startsWith(`# ${number}.`)) {
                            editor.setCursor({ line: i, ch: line.length });
                            editor.focus();
                            break;
                        }
                    }
                }
            }
            new Notice(`âœ… '${title}' ë¬¸ì œê°€ ${subject} í´ë”ì— ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            setTimeout(() => {
                this.refreshDashboard();
            }, 300);
            return true;
        } catch (error) {
            console.error('ë¬¸ì œ íŒŒì¼ ìƒì„± ì˜¤ë¥˜:', error);
            new Notice(`âŒ ë¬¸ì œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            return false;
        }
    }

    async createBulkProblems(subject, startNumber, endNumber) {
        let created = 0;
        let skipped = 0;
        const total = endNumber - startNumber + 1;
        for (let i = startNumber; i <= endNumber; i++) {
            try {
                const result = await this.createProblem(subject, i, `ë¬¸ì œ ${i}`, 3);
                if (result) {
                    created++;
                } else {
                    skipped++;
                }
                await new Promise(resolve => setTimeout(resolve, 50));
            } catch (error) {
                console.error(`ë¬¸ì œ ${i} ìƒì„± ì‹¤íŒ¨:`, error);
                skipped++;
            }
        }
        new Notice(`âœ… ${created}ê°œ ìƒì„±, ${skipped}ê°œ ê±´ë„ˆëœ€ (ì´ ${total}ê°œ ì¤‘)`);
        this.refreshDashboard();
    }

    refreshDashboard() {
        const dashboardView = this.app.workspace.getLeavesOfType(VIEW_TYPE_STUDY_DASHBOARD)[0];
        if (dashboardView?.view?.refresh) {
            dashboardView.view.refresh();
        }
    }

    async openProblemFile(subject, number) {
        try {
            const subjectFolder = normalizePath(`${this.settings.problemsFolder}/${subject}`);
            const folderFiles = this.app.vault.getAbstractFileByPath(subjectFolder);
            if (!folderFiles) {
                new Notice(`âŒ ${subject} í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            const files = this.app.vault.getMarkdownFiles()
                .filter(file => file && file.path && file.path.startsWith(subjectFolder));
            if (!files || files.length === 0) {
                new Notice(`âŒ ${subject} í´ë”ì— ë¬¸ì œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
            const targetFile = files.find(file => {
                if (!file || !file.basename) return false;
                const match = file.basename.match(/^(\d+)_/);
                return match && parseInt(match[1]) === number;
            });
            if (targetFile) {
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(targetFile);
                new Notice(`ğŸ“– ë¬¸ì œ ${number}ë²ˆ ì—´ê¸°`);
            } else {
                new Notice(`âŒ ë¬¸ì œ ${number}ë²ˆ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }
        } catch (error) {
            console.error('íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜:', error);
            new Notice(`âŒ íŒŒì¼ì„ ì—¬ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
        }
    }
    addStyles() {
        const css = `
        .study-dashboard-container {
            padding: 20px;
            background: var(--background-primary);
            color: var(--text-normal);
            height: 100%;
            overflow-y: auto;
        }
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, var(--interactive-accent) 0%, var(--interactive-accent-hover) 100%);
            border-radius: 15px;
            color: white;
        }
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0;
        }
        .dashboard-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin: 10px 0 0 0;
        }
        .max-problems-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        .max-problem-btn {
            padding: 8px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        .max-problem-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        .max-problem-btn.active {
            background: rgba(255,255,255,0.9);
            color: var(--interactive-accent);
            border-color: white;
        }
        .timer-section {
            background: var(--background-secondary);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid var(--background-modifier-border);
        }
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: var(--interactive-accent);
            margin: 20px 0;
        }
        .timer-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        .timer-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }
        .timer-btn.start {
            background: #10b981;
        }
        .timer-btn.stop {
            background: #ef4444;
        }
        .timer-btn.reset {
            background: #6b7280;
        }
        .timer-btn:hover {
            transform: translateY(-2px);
        }
        .subject-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .subject-tab {
            padding: 10px 20px;
            border: 2px solid var(--background-modifier-border);
            border-radius: 25px;
            background: var(--background-secondary);
            color: var(--text-normal);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .subject-tab.active {
            background: var(--interactive-accent);
            color: white;
            border-color: var(--interactive-accent);
        }
        .subject-tab:hover {
            background: var(--interactive-accent-hover);
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: var(--background-secondary);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid var(--background-modifier-border);
        }
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--interactive-accent);
            margin-bottom: 10px;
        }
        .stat-label {
            font-size: 1rem;
            color: var(--text-muted);
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 20px 0;
            flex-wrap: wrap;
            align-items: center;
        }
        .action-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            background: var(--interactive-accent);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .action-btn:hover {
            background: var(--interactive-accent-hover);
            transform: translateY(-2px);
        }
        .problems-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 8px;
            margin: 20px 0;
        }
        .problem-cell {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: white;
            position: relative;
        }
        .problem-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .problem-cell.empty {
            background: var(--background-modifier-border);
            color: var(--text-muted);
        }
        .problem-cell.grade-S {
            background: #800080;
            box-shadow: 0 0 10px rgba(128, 0, 128, 0.5);
        }
        .problem-cell.grade-A {
            background: #FFD700;
            color: #000;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        .problem-cell.grade-B {
            background: #B22222;
        }
        .problem-cell.grade-C {
            background: #708090;
        }
        .problem-cell.grade-D {
            background: #654321;
        }
        .problem-cell.grade-E {
            background: #2F4F4F;
        }
        .problem-cell.grade-F {
            background: #1a1a1a;
        }
        .grade-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 10px;
            opacity: 0.8;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: var(--background-modifier-border);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: var(--interactive-accent);
            transition: width 0.5s ease;
        }
        `;
        const style = document.createElement('style');
        style.textContent = css;
        document.head.appendChild(style);
    }
}

class StudyDashboardView extends ItemView {
    constructor(leaf, plugin) {
        super(leaf);
        this.plugin = plugin;
        this.currentSubject = this.plugin.settings.defaultSubject;
        this.maxProblems = this.plugin.settings.maxProblems;
        this.displayCount = 100;
    }
    
    getViewType() { 
        return VIEW_TYPE_STUDY_DASHBOARD; 
    }
    
    getDisplayText() { 
        return 'ğŸ“š Study Dashboard'; 
    }
    
    getIcon() { 
        return 'graduation-cap'; 
    }
    
    async onOpen() {
        const container = this.containerEl.children[1];
        container.empty();
        container.addClass('study-dashboard-container');
        await this.renderDashboard(container);
    }
    
    async renderDashboard(container) {
        container.empty();
        this.renderHeader(container);
        this.renderTimerSection(container);
        this.renderSubjectTabs(container);
        await this.renderStats(container);
        this.renderActionButtons(container);
        await this.renderProblemsGrid(container);
    }
    
    renderHeader(container) {
        const header = container.createDiv('dashboard-header');
        header.createEl('h1', { 
            cls: 'dashboard-title',
            text: 'ğŸ“š Study Dashboard' 
        });
        header.createEl('p', { 
            cls: 'dashboard-subtitle',
            text: `${this.currentSubject} ê³¼ëª© - ${this.maxProblems}ë¬¸ì œ ì‹œìŠ¤í…œ` 
        });
        const selectorDiv = header.createDiv('max-problems-selector');
        [100, 200, 500].forEach(num => {
            const btn = selectorDiv.createEl('button', {
                cls: 'max-problem-btn' + (num === this.maxProblems ? ' active' : ''),
                text: `${num}ë¬¸ì œ`
            });
            btn.addEventListener('click', async () => {
                this.maxProblems = num;
                this.plugin.settings.maxProblems = num;
                await this.plugin.saveSettings();
                if (this.displayCount > num) {
                    this.displayCount = 100;
                }
                this.renderDashboard(container);
            });
        });
    }
    
    renderTimerSection(container) {
        const timerSection = container.createDiv('timer-section');
        timerSection.createEl('h2', { text: 'â±ï¸ ê³µë¶€ íƒ€ì´ë¨¸' });
        const timerDisplay = timerSection.createDiv('timer-display');
        timerDisplay.textContent = formatTime(this.plugin.timerState.seconds);
        const controls = timerSection.createDiv('timer-controls');
        const startBtn = controls.createEl('button', {
            cls: 'timer-btn start',
            text: 'â–¶ï¸ ì‹œì‘'
        });
        startBtn.addEventListener('click', () => {
            this.plugin.startTimer();
        });
        const stopBtn = controls.createEl('button', {
            cls: 'timer-btn stop',
            text: 'â¹ï¸ ì •ì§€'
        });
        stopBtn.addEventListener('click', () => {
            this.plugin.stopTimer();
        });
        const resetBtn = controls.createEl('button', {
            cls: 'timer-btn reset',
            text: 'ğŸ”„ ì´ˆê¸°í™”'
        });
        resetBtn.addEventListener('click', () => {
            this.plugin.resetTimer();
        });
    }
    
    renderSubjectTabs(container) {
        const tabs = container.createDiv('subject-tabs');
        this.plugin.settings.subjects.forEach(subject => {
            const tab = tabs.createEl('button', {
                cls: 'subject-tab' + (subject === this.currentSubject ? ' active' : ''),
                text: subject
            });
            tab.addEventListener('click', () => {
                this.currentSubject = subject;
                this.renderDashboard(container);
            });
        });
    }
    
    async renderStats(container) {
        const statsGrid = container.createDiv('stats-grid');
        const problemsData = await this.loadProblemsData();
        const total = Object.keys(problemsData).length;
        const gradeStats = this.calculateGradeStats(problemsData);
        const completed = gradeStats.S + gradeStats.A + gradeStats.B;
        const reviewing = gradeStats.C + gradeStats.D;
        const learning = gradeStats.E + gradeStats.F;
        const progressPercent = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;
        const stats = [
            { label: 'ì´ ë¬¸ì œ', value: total.toString(), color: '#3b82f6' },
            { label: 'ì™„ë£Œ (S/A/B)', value: completed.toString(), color: '#10b981' },
            { label: 'ë³µìŠµì¤‘ (C/D)', value: reviewing.toString(), color: '#f59e0b' },
            { label: 'í•™ìŠµì¤‘ (E/F)', value: learning.toString(), color: '#ef4444' },
            { label: 'ì§„í–‰ë¥ ', value: `${progressPercent}%`, color: '#8b5cf6' },
            { label: 'ì˜¤ëŠ˜ ëª©í‘œ', value: '5/5', color: '#06b6d4' }
        ];
        stats.forEach(stat => {
            const card = statsGrid.createDiv('stat-card');
            const value = card.createDiv('stat-value');
            value.textContent = stat.value;
            value.style.color = stat.color;
            card.createDiv('stat-label').textContent = stat.label;
        });
    }

    renderActionButtons(container) {
        const actions = container.createDiv('action-buttons');
        const rangeSelectWrapper = actions.createDiv();
        rangeSelectWrapper.style.cssText = 'display: flex; align-items: center; gap: 10px;';
        const rangeLabel = rangeSelectWrapper.createEl('label', {
            text: 'ğŸ“Š í‘œì‹œ:',
            attr: { style: 'font-weight: bold; color: var(--text-normal);' }
        });
        const rangeSelect = rangeSelectWrapper.createEl('select');
        rangeSelect.style.cssText = 'padding: 8px 15px; border-radius: 20px; border: 2px solid var(--interactive-accent); background: var(--background-primary); color: var(--text-normal); font-weight: bold; cursor: pointer;';
        [100, 200, 300, 400, 500].forEach(num => {
            if (num <= this.maxProblems) {
                const option = rangeSelect.createEl('option', {
                    value: num.toString(),
                    text: `${num}ë¬¸ì œ`
                });
                if (num === this.displayCount) {
                    option.selected = true;
                }
            }
        });
        rangeSelect.addEventListener('change', () => {
            this.displayCount = parseInt(rangeSelect.value);
            this.renderDashboard(container);
        });
        const newProblemBtn = actions.createEl('button', {
            cls: 'action-btn',
            text: 'â• ìƒˆ ë¬¸ì œ ìƒì„±'
        });
        newProblemBtn.addEventListener('click', () => {
            new ProblemCreationModal(this.app, this.plugin, this.currentSubject).open();
        });
        const bulkCreateBtn = actions.createEl('button', {
            cls: 'action-btn',
            text: 'ğŸ“ ì¼ê´„ ìƒì„±'
        });
        bulkCreateBtn.addEventListener('click', () => {
            new BulkCreationModal(this.app, this.plugin, this.currentSubject).open();
        });
        const refreshBtn = actions.createEl('button', {
            cls: 'action-btn',
            text: 'ğŸ”„ ìƒˆë¡œê³ ì¹¨'
        });
        refreshBtn.addEventListener('click', () => {
            this.renderDashboard(container);
        });
    }
    async renderProblemsGrid(container) {
        const section = container.createDiv();
        section.createEl('h3', { 
            text: `ğŸ“ ${this.currentSubject} ë¬¸ì œ 1-${this.displayCount}ë²ˆ (ì „ì²´ ${this.maxProblems}ë¬¸ì œ)` 
        });
        const problemsData = await this.loadProblemsData();
        const progressContainer = section.createDiv();
        const completed = Object.keys(problemsData).length;
        const percentage = ((completed / this.maxProblems) * 100).toFixed(1);
        progressContainer.createEl('p', { text: `ì „ì²´ ì§„í–‰ë¥ : ${completed}/${this.maxProblems} ë¬¸ì œ (${percentage}%)` });
        const progressBar = progressContainer.createDiv('progress-bar');
        const progressFill = progressBar.createDiv('progress-fill');
        progressFill.style.width = `${percentage}%`;
        const gradeStats = this.calculateGradeStats(problemsData);
        const statsText = section.createDiv();
        statsText.style.cssText = 'text-align: center; margin: 15px 0; font-size: 0.95rem;';
        statsText.innerHTML = `
            ğŸ‘‘ Sê¸‰: ${gradeStats.S}ê°œ | 
            â­ Aê¸‰: ${gradeStats.A}ê°œ | 
            ğŸ”¥ Bê¸‰: ${gradeStats.B}ê°œ | 
            ğŸ“š Cê¸‰: ${gradeStats.C}ê°œ | 
            ğŸ“– Dê¸‰: ${gradeStats.D}ê°œ | 
            â›“ï¸ Eê¸‰: ${gradeStats.E}ê°œ | 
            ğŸ· Fê¸‰: ${gradeStats.F}ê°œ
        `;
        const grid = section.createDiv('problems-grid');
        for (let i = 1; i <= this.displayCount; i++) {
            const cell = grid.createDiv('problem-cell');
            const problemData = problemsData[i];
            if (problemData) {
                const grade = getReviewGrade(problemData.reviewCount || 0, problemData.understanding || 0);
                cell.addClass(`grade-${grade}`);
                cell.textContent = i;
                const badge = cell.createSpan('grade-badge');
                badge.textContent = REVIEW_GRADES[grade].emoji;
                cell.setAttribute('title', 
                    `${i}ë²ˆ ë¬¸ì œ\n` +
                    `ë“±ê¸‰: ${REVIEW_GRADES[grade].name} (${grade}ê¸‰)\n` +
                    `ë³µìŠµ: ${problemData.reviewCount || 0}íšŒ\n` +
                    `ì´í•´ë„: ${problemData.understanding || 0}/100`
                );
            } else {
                cell.addClass('empty');
                cell.textContent = i;
                cell.setAttribute('title', `${i}ë²ˆ ë¬¸ì œ (ë¯¸ìƒì„±)`);
            }
            cell.addEventListener('click', async () => {
                if (cell.hasClass('empty')) {
                    new ProblemCreationModal(this.app, this.plugin, this.currentSubject, i).open();
                } else {
                    await this.plugin.openProblemFile(this.currentSubject, i);
                }
            });
        }
    }

    async loadProblemsData() {
        const problemsData = {};
        try {
            const subjectFolder = normalizePath(`${this.plugin.settings.problemsFolder}/${this.currentSubject}`);
            const folderFiles = this.app.vault.getAbstractFileByPath(subjectFolder);
            if (!folderFiles) {
                return problemsData;
            }
            const allFiles = this.app.vault.getMarkdownFiles();
            if (!allFiles || !Array.isArray(allFiles)) {
                console.error('getMarkdownFiles() returned invalid data');
                return problemsData;
            }
            const files = allFiles.filter(file => file && file.path && file.path.startsWith(subjectFolder));
            for (const file of files) {
                try {
                    const content = await this.app.vault.read(file);
                    const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
                    if (frontmatterMatch) {
                        const frontmatter = frontmatterMatch[1];
                        const numberMatch = frontmatter.match(/number:\s*(\d+)/);
                        const reviewMatch = frontmatter.match(/reviewCount:\s*(\d+)/);
                        const understandingMatch = frontmatter.match(/understanding:\s*(\d+)/);
                        if (numberMatch) {
                            const number = parseInt(numberMatch[1]);
                            const reviewCheckMatches = content.match(/- \[x\] \d+ì°¨ ë³µìŠµ/gi);
                            const reviewCount = reviewCheckMatches ? reviewCheckMatches.length : 
                                              (reviewMatch ? parseInt(reviewMatch[1]) : 0);
                            problemsData[number] = {
                                reviewCount: reviewCount,
                                understanding: understandingMatch ? parseInt(understandingMatch[1]) : 0,
                                file: file
                            };
                        }
                    }
                } catch (error) {
                    console.error(`íŒŒì¼ ì½ê¸° ì˜¤ë¥˜: ${file.path}`, error);
                }
            }
        } catch (error) {
            console.error('ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        }
        return problemsData;
    }

    calculateGradeStats(problemsData) {
        const stats = { S: 0, A: 0, B: 0, C: 0, D: 0, E: 0, F: 0 };
        for (const [num, data] of Object.entries(problemsData)) {
            const grade = getReviewGrade(data.reviewCount || 0, data.understanding || 0);
            stats[grade]++;
        }
        return stats;
    }
    
    refresh() {
        const container = this.containerEl.children[1];
        this.renderDashboard(container);
    }
}

class UnderstandingModal extends Modal {
    constructor(app, timeString, file, onSave) {
        super(app);
        this.timeString = timeString;
        this.file = file;
        this.onSave = onSave;
    }
    
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('understanding-modal');
        
        const header = contentEl.createDiv('modal-header-custom');
        header.createEl('h2', { text: 'â±ï¸ íƒ€ì´ë¨¸ ì •ì§€', cls: 'modal-title-custom' });
        header.createEl('div', { text: this.timeString, cls: 'timer-display-custom' });
        header.createEl('div', { text: 'ì†Œìš” ì‹œê°„', cls: 'timer-label-custom' });
        
        const body = contentEl.createDiv('modal-body-custom');
        
        const formGroup = body.createDiv('form-group-custom');
        formGroup.createEl('label', { text: 'ì´í•´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”', cls: 'form-label-custom' });
        
        const select = formGroup.createEl('select', { cls: 'form-select-custom' });
        select.createEl('option', { text: 'ì´í•´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”', value: '' });
        select.createEl('option', { text: 'ì™„ë²½ ì´í•´ (100%)', value: '100' });
        select.createEl('option', { text: 'ëŒ€ë¶€ë¶„ ì´í•´ (85%)', value: '85' });
        select.createEl('option', { text: 'ì–´ëŠì •ë„ ì´í•´ (70%)', value: '70' });
        select.createEl('option', { text: 'ë°˜ë°˜ ì´í•´ (50%)', value: '50' });
        select.createEl('option', { text: 'ì¡°ê¸ˆ ì´í•´ (30%)', value: '30' });
        select.createEl('option', { text: 'ê±°ì˜ ëª¨ë¦„ (15%)', value: '15' });
        select.createEl('option', { text: 'ì „í˜€ ëª¨ë¦„ (0%)', value: '0' });
        
        const footer = contentEl.createDiv('modal-footer-custom');
        
        const cancelBtn = footer.createEl('button', { text: 'ì·¨ì†Œ', cls: 'btn-cancel-custom' });
        cancelBtn.addEventListener('click', () => this.close());
        
        const saveBtn = footer.createEl('button', { text: 'âœ… ì €ì¥', cls: 'btn-save-custom' });
        saveBtn.addEventListener('click', async () => {
            const understanding = select.value;
            if (!understanding) {
                new Notice('âš ï¸ ì´í•´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            await this.onSave(parseInt(understanding));
            this.close();
        });
        
        this.addModalStyles();
    }
    
    addModalStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .understanding-modal .modal-header-custom {
                text-align: center;
                margin-bottom: 25px;
            }
            .understanding-modal .modal-title-custom {
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 15px;
            }
            .understanding-modal .timer-display-custom {
                font-size: 2rem;
                font-weight: bold;
                color: var(--interactive-accent);
                font-family: 'Courier New', monospace;
                margin-bottom: 5px;
            }
            .understanding-modal .timer-label-custom {
                font-size: 0.9rem;
                color: var(--text-muted);
            }
            .understanding-modal .modal-body-custom {
                margin-bottom: 25px;
            }
            .understanding-modal .form-group-custom {
                margin-bottom: 20px;
            }
            .understanding-modal .form-label-custom {
                display: block;
                font-size: 0.95rem;
                font-weight: 600;
                margin-bottom: 8px;
            }
            .understanding-modal .form-select-custom {
                width: 100%;
                padding: 12px 15px;
                font-size: 1rem;
                border: 2px solid var(--background-modifier-border);
                border-radius: 8px;
                background: var(--background-primary);
                color: var(--text-normal);
                cursor: pointer;
            }
            .understanding-modal .form-select-custom:focus {
                outline: none;
                border-color: var(--interactive-accent);
            }
            .understanding-modal .modal-footer-custom {
                display: flex;
                gap: 10px;
            }
            .understanding-modal .btn-cancel-custom,
            .understanding-modal .btn-save-custom {
                flex: 1;
                padding: 12px 20px;
                border: none;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 600;
                cursor: pointer;
            }
            .understanding-modal .btn-cancel-custom {
                background: var(--background-modifier-border);
                color: var(--text-normal);
            }
            .understanding-modal .btn-save-custom {
                background: var(--interactive-accent);
                color: white;
            }
            .understanding-modal .btn-save-custom:hover {
                background: var(--interactive-accent-hover);
            }
            .understanding-modal .modal-header-custom {
                text-align: center;
                margin-bottom: 25px;
            }
            .understanding-modal .modal-title-custom {
                font-size: 1.5rem;
                font-weight: bold;
                margin-bottom: 15px;
            }
            .understanding-modal .timer-display-custom {
                font-size: 2rem;
                font-weight: bold;
                color: var(--interactive-accent);
                font-family: 'Courier New', monospace;
                margin-bottom: 5px;
            }
            .understanding-modal .timer-label-custom {
                font-size: 0.9rem;
                color: var(--text-muted);
            }
            .understanding-modal .info-box-custom {
                background: var(--background-secondary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 8px;
                padding: 15px;
                margin-top: 20px;
            }
            .understanding-modal .info-row-custom {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }
            .understanding-modal .info-row-custom:last-child {
                margin-bottom: 0;
            }
            .understanding-modal .info-label-custom {
                font-size: 0.9rem;
                color: var(--text-muted);
            }
            .understanding-modal .info-value-custom {
                font-size: 1rem;
                font-weight: 600;
                color: var(--text-normal);
            }
            .understanding-modal .review-counter-custom {
                display: inline-flex;
                align-items: center;
                gap: 5px;
                font-weight: 600;
            }
            .understanding-modal .counter-badge-custom {
                background: var(--interactive-accent);
                color: white;
                padding: 2px 8px;
                border-radius: 12px;
                font-size: 0.85rem;
            }
        `;
        document.head.appendChild(style);
    }
}

class ProblemCreationModal extends Modal {
    constructor(app, plugin, subject = null, number = null) {
        super(app);
        this.plugin = plugin;
        this.subject = subject || plugin.settings.defaultSubject;
        this.number = number;
    }
    
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.createEl('h2', { text: 'â• ìƒˆ ë¬¸ì œ ìƒì„±' });
        const subjectDiv = contentEl.createDiv();
        subjectDiv.createEl('label', { text: 'ê³¼ëª©:' });
        const subjectSelect = subjectDiv.createEl('select');
        this.plugin.settings.subjects.forEach(subject => {
            const option = subjectSelect.createEl('option', { 
                value: subject, 
                text: subject 
            });
            if (subject === this.subject) {
                option.selected = true;
            }
        });
        const numberDiv = contentEl.createDiv();
        numberDiv.createEl('label', { text: 'ë¬¸ì œ ë²ˆí˜¸:' });
        const numberInput = numberDiv.createEl('input', { 
            type: 'number',
            value: this.number?.toString() || '1',
            attr: { min: '1', max: this.plugin.settings.maxProblems.toString() }
        });
        const titleDiv = contentEl.createDiv();
        titleDiv.createEl('label', { text: 'ë¬¸ì œ ì œëª©:' });
        const titleInput = titleDiv.createEl('input', { 
            type: 'text',
            placeholder: 'ë¬¸ì œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”...'
        });
        setTimeout(() => titleInput.focus(), 100);
        const difficultyDiv = contentEl.createDiv();
        difficultyDiv.createEl('label', { text: 'ë‚œì´ë„ (1-5):' });
        const difficultyInput = difficultyDiv.createEl('input', { 
            type: 'number',
            value: '3',
            attr: { min: '1', max: '5' }
        });
        const buttonDiv = contentEl.createDiv();
        buttonDiv.style.marginTop = '20px';
        buttonDiv.style.textAlign = 'center';
        const createBtn = buttonDiv.createEl('button', { 
            text: 'âœ… ìƒì„±',
            cls: 'mod-cta'
        });
        createBtn.addEventListener('click', async () => {
            const subject = subjectSelect.value;
            const number = parseInt(numberInput.value);
            const title = titleInput.value || `ë¬¸ì œ ${number}`;
            const difficulty = parseInt(difficultyInput.value);
            await this.plugin.createProblem(subject, number, title, difficulty);
            this.close();
        });
        titleInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                createBtn.click();
            }
        });
        const cancelBtn = buttonDiv.createEl('button', { text: 'âŒ ì·¨ì†Œ' });
        cancelBtn.addEventListener('click', () => this.close());
    }
}

class BulkCreationModal extends Modal {
    constructor(app, plugin, subject) {
        super(app);
        this.plugin = plugin;
        this.subject = subject || plugin.settings.defaultSubject;
    }
    
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.createEl('h2', { text: 'ğŸ“ ë¬¸ì œ ì¼ê´„ ìƒì„±' });
        const subjectDiv = contentEl.createDiv();
        subjectDiv.createEl('label', { text: 'ê³¼ëª©:' });
        const subjectSelect = subjectDiv.createEl('select');
        this.plugin.settings.subjects.forEach(subject => {
            const option = subjectSelect.createEl('option', { 
                value: subject, 
                text: subject 
            });
            if (subject === this.subject) {
                option.selected = true;
            }
        });
        const startDiv = contentEl.createDiv();
        startDiv.createEl('label', { text: 'ì‹œì‘ ë²ˆí˜¸:' });
        const startInput = startDiv.createEl('input', { 
            type: 'number',
            value: '1',
            attr: { min: '1' }
        });
        const endDiv = contentEl.createDiv();
        endDiv.createEl('label', { text: 'ë ë²ˆí˜¸:' });
        const endInput = endDiv.createEl('input', { 
            type: 'number',
            value: '50',
            attr: { min: '1', max: this.plugin.settings.maxProblems.toString() }
        });
        const buttonDiv = contentEl.createDiv();
        buttonDiv.style.marginTop = '20px';
        buttonDiv.style.textAlign = 'center';
        const createBtn = buttonDiv.createEl('button', { 
            text: 'âœ… ì¼ê´„ ìƒì„±',
            cls: 'mod-cta'
        });
        createBtn.addEventListener('click', async () => {
            const subject = subjectSelect.value;
            const start = parseInt(startInput.value);
            const end = parseInt(endInput.value);
            if (start > end) {
                new Notice('âŒ ì‹œì‘ ë²ˆí˜¸ê°€ ë ë²ˆí˜¸ë³´ë‹¤ í´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            await this.plugin.createBulkProblems(subject, start, end);
            this.close();
        });
        const cancelBtn = buttonDiv.createEl('button', { text: 'âŒ ì·¨ì†Œ' });
        cancelBtn.addEventListener('click', () => this.close());
    }
}

class TimerStopModal extends Modal {
    constructor(app, plugin, timerDuration, existingUnderstandings = []) {
        super(app);
        this.plugin = plugin;
        this.timerDuration = timerDuration;
        this.existingUnderstandings = existingUnderstandings;
    }
    
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('understanding-modal');
        
        // ëª¨ë‹¬ í—¤ë”
        const header = contentEl.createDiv();
        header.addClass('modal-header-custom');
        header.createEl('h2', { text: 'â±ï¸ íƒ€ì´ë¨¸ ì •ì§€', cls: 'modal-title-custom' });
        
        const timerDisplay = header.createDiv();
        timerDisplay.addClass('timer-display-custom');
        timerDisplay.textContent = this.formatTime(this.timerDuration);
        
        const timerLabel = header.createDiv();
        timerLabel.addClass('timer-label-custom');
        timerLabel.textContent = 'ì†Œìš” ì‹œê°„';
        
        // ëª¨ë‹¬ ë°”ë””
        const body = contentEl.createDiv();
        body.addClass('modal-body-custom');
        
        const formGroup = body.createDiv();
        formGroup.addClass('form-group-custom');
        
        const label = formGroup.createEl('label', { 
            text: 'ì´í•´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”',
            cls: 'form-label-custom'
        });
        
        const select = formGroup.createEl('select', { cls: 'form-select-custom' });
        select.createEl('option', { value: '0', text: 'ì´í•´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”' });
        select.createEl('option', { value: '100', text: 'ì™„ë²½ ì´í•´ (100%)' });
        select.createEl('option', { value: '85', text: 'ëŒ€ë¶€ë¶„ ì´í•´ (85%)' });
        select.createEl('option', { value: '70', text: 'ì–´ëŠì •ë„ ì´í•´ (70%)' });
        select.createEl('option', { value: '50', text: 'ë°˜ë°˜ ì´í•´ (50%)' });
        select.createEl('option', { value: '30', text: 'ì¡°ê¸ˆ ì´í•´ (30%)' });
        select.createEl('option', { value: '15', text: 'ê±°ì˜ ëª¨ë¦„ (15%)' });
        select.createEl('option', { value: '0', text: 'ì „í˜€ ëª¨ë¦„ (0%)' });
        
        // ì •ë³´ ë°•ìŠ¤
        const infoBox = body.createDiv();
        infoBox.addClass('info-box-custom');
        
        const reviewRow = infoBox.createDiv();
        reviewRow.addClass('info-row-custom');
        reviewRow.createEl('span', { text: 'ë³µìŠµ íšŸìˆ˜', cls: 'info-label-custom' });
        const reviewValue = reviewRow.createEl('span', { cls: 'info-value-custom' });
        reviewValue.innerHTML = `<span class="review-counter-custom">${this.existingUnderstandings.length}<span class="counter-badge-custom">+1</span></span>`;
        
        const avgRow = infoBox.createDiv();
        avgRow.addClass('info-row-custom');
        avgRow.createEl('span', { text: 'í‰ê·  ì´í•´ë„', cls: 'info-label-custom' });
        const avgValue = avgRow.createEl('span', { cls: 'info-value-custom' });
        avgValue.textContent = this.calculateAverage(this.existingUnderstandings) + '%';
        
        // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
        select.addEventListener('change', () => {
            const selectedValue = parseInt(select.value);
            if (selectedValue === 0 && select.selectedIndex === 0) {
                avgValue.textContent = this.calculateAverage(this.existingUnderstandings) + '%';
            } else {
                const newUnderstandings = [...this.existingUnderstandings, selectedValue];
                avgValue.textContent = this.calculateAverage(newUnderstandings) + '%';
            }
        });
        
        // ëª¨ë‹¬ í‘¸í„°
        const footer = contentEl.createDiv();
        footer.addClass('modal-footer-custom');
        
        const cancelBtn = footer.createEl('button', { 
            text: 'ì·¨ì†Œ',
            cls: 'btn-cancel-custom'
        });
        cancelBtn.addEventListener('click', () => this.close());
        
        const saveBtn = footer.createEl('button', { 
            text: 'âœ… ì €ì¥',
            cls: 'btn-save-custom'
        });
        saveBtn.addEventListener('click', async () => {
            const understanding = parseInt(select.value);
            if (understanding === 0 && select.selectedIndex === 0) {
                new Notice('âš ï¸ ì´í•´ë„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            await this.saveTimerData(understanding);
            this.close();
        });
    }
    
    formatTime(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        
        if (hours > 0) {
            return `${hours.toString().padStart(2, '0')}ì‹œ ${minutes.toString().padStart(2, '0')}ë¶„ ${secs.toString().padStart(2, '0')}ì´ˆ`;
        } else {
            return `${minutes.toString().padStart(2, '0')}ë¶„ ${secs.toString().padStart(2, '0')}ì´ˆ`;
        }
    }
    
    calculateAverage(understandings) {
        if (understandings.length === 0) return 0;
        const sum = understandings.reduce((a, b) => a + b, 0);
        return Math.round(sum / understandings.length);
    }
    
    async saveTimerData(understanding) {
        try {
            const timeString = this.formatTime(this.timerDuration);
            
            // í˜„ì¬ í™œì„± íŒŒì¼ í™•ì¸
            const activeFile = this.app.workspace.getActiveFile();
            if (!activeFile || activeFile.extension !== 'md') {
                new Notice('âš ï¸ ë§ˆí¬ë‹¤ìš´ íŒŒì¼ì´ ì—´ë ¤ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            // íŒŒì¼ ë‚´ìš© ì½ê¸°
            const content = await this.app.vault.read(activeFile);
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
            
            if (!frontmatterMatch) {
                new Notice('âš ï¸ Frontmatterê°€ ì—†ëŠ” íŒŒì¼ì…ë‹ˆë‹¤.');
                return;
            }
            
            let frontmatter = frontmatterMatch[1];
            
            // times ë°°ì—´ ì—…ë°ì´íŠ¸
            const timesMatch = frontmatter.match(/times:\s*\[(.*?)\]/s);
            let newTimesArray;
            
            if (timesMatch) {
                const existingTimes = timesMatch[1].split(',').map(t => t.trim().replace(/"/g, '')).filter(t => t);
                existingTimes.push(`"${timeString}"`);
                newTimesArray = `times: [${existingTimes.join(', ')}]`;
                frontmatter = frontmatter.replace(/times:\s*\[.*?\]/s, newTimesArray);
            } else {
                newTimesArray = `times: ["${timeString}"]`;
                frontmatter = frontmatter + '\n' + newTimesArray;
            }
            
            // understandings ë°°ì—´ ì—…ë°ì´íŠ¸
            const understandingsMatch = frontmatter.match(/understandings:\s*\[(.*?)\]/s);
            let newUnderstandingsArray;
            
            if (understandingsMatch) {
                const existingUnderstandings = understandingsMatch[1].split(',').map(u => u.trim()).filter(u => u);
                existingUnderstandings.push(understanding.toString());
                newUnderstandingsArray = `understandings: [${existingUnderstandings.join(', ')}]`;
                frontmatter = frontmatter.replace(/understandings:\s*\[.*?\]/s, newUnderstandingsArray);
            } else {
                newUnderstandingsArray = `understandings: [${understanding}]`;
                frontmatter = frontmatter + '\n' + newUnderstandingsArray;
            }
            
            // understanding ê°’ ì—…ë°ì´íŠ¸
            const understandingMatch = frontmatter.match(/understanding:\s*\d+/);
            if (understandingMatch) {
                frontmatter = frontmatter.replace(/understanding:\s*\d+/, `understanding: ${understanding}`);
            } else {
                frontmatter = frontmatter + '\n' + `understanding: ${understanding}`;
            }
            
            // íŒŒì¼ ì—…ë°ì´íŠ¸
            const newContent = content.replace(/^---\n[\s\S]*?\n---/, `---\n${frontmatter}\n---`);
            await this.app.vault.modify(activeFile, newContent);
            
            new Notice(`âœ… íƒ€ì´ë¨¸ ë°ì´í„° ì €ì¥ ì™„ë£Œ!\nì†Œìš”ì‹œê°„: ${timeString}\nì´í•´ë„: ${understanding}%`);
            
        } catch (error) {
            console.error('íƒ€ì´ë¨¸ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            new Notice('âŒ ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
}

class StudyDashboardSettingTab extends PluginSettingTab {
    constructor(app, plugin) {
        super(app, plugin);
        this.plugin = plugin;
    }

    display() {
        const { containerEl } = this;
        containerEl.empty();
        containerEl.createEl('h2', { text: 'ğŸ“š Study Dashboard ì„¤ì •' });
        containerEl.createEl('h3', { text: 'â±ï¸ íƒ€ì´ë¨¸ & ìë™ ê¸°ë¡' });
        new Setting(containerEl)
            .setName('íƒ€ì´ë¨¸ ê¸°ëŠ¥')
            .setDesc('ëŒ€ì‹œë³´ë“œì— íƒ€ì´ë¨¸ ê¸°ëŠ¥ì„ í‘œì‹œí•©ë‹ˆë‹¤')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.timerEnabled)
                .onChange(async (value) => {
                    this.plugin.settings.timerEnabled = value;
                    await this.plugin.saveSettings();
                }));
        new Setting(containerEl)
            .setName('â±ï¸ íƒ€ì´ë¨¸ ì •ì§€ ì‹œ ìë™ ì‹œê°„ ê¸°ë¡')
            .setDesc('íƒ€ì´ë¨¸ ì •ì§€ ì‹œ í˜„ì¬ ì—´ë¦° ë¬¸ì œ íŒŒì¼ì˜ times ë°°ì—´ì— ìë™ìœ¼ë¡œ ì‹œê°„ì„ ì¶”ê°€í•©ë‹ˆë‹¤')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.autoRecordTime)
                .onChange(async (value) => {
                    this.plugin.settings.autoRecordTime = value;
                    await this.plugin.saveSettings();
                    new Notice(value ? 'âœ… íƒ€ì´ë¨¸ ìë™ ê¸°ë¡ í™œì„±í™”' : 'âŒ íƒ€ì´ë¨¸ ìë™ ê¸°ë¡ ë¹„í™œì„±í™”');
                }));
        new Setting(containerEl)
            .setName('âœ… ì²´í¬ë°•ìŠ¤ ì²´í¬ ì‹œ ìë™ ì‹œê°„ ê¸°ë¡')
            .setDesc('ë³µìŠµ ì²´í¬ë°•ìŠ¤ë¥¼ ì²´í¬í•  ë•Œ ìë™ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ì„ times ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.autoRecordOnCheck)
                .onChange(async (value) => {
                    this.plugin.settings.autoRecordOnCheck = value;
                    await this.plugin.saveSettings();
                    new Notice(value ? 'âœ… ì²´í¬ë°•ìŠ¤ ìë™ ê¸°ë¡ í™œì„±í™”' : 'âŒ ì²´í¬ë°•ìŠ¤ ìë™ ê¸°ë¡ ë¹„í™œì„±í™”');
                }));
        containerEl.createEl('hr');
        containerEl.createEl('h3', { text: 'ğŸ“ ê³¼ëª© ê´€ë¦¬' });
        const subjectsContainer = containerEl.createDiv();
        subjectsContainer.style.cssText = 'margin: 20px 0; padding: 15px; background: var(--background-secondary); border-radius: 10px;';
        this.renderSubjectsList(subjectsContainer);
        const addSubjectDiv = containerEl.createDiv();
        addSubjectDiv.style.cssText = 'margin: 20px 0; display: flex; gap: 10px; align-items: center;';
        const newSubjectInput = addSubjectDiv.createEl('input', {
            type: 'text',
            placeholder: 'ìƒˆ ê³¼ëª©ëª… ì…ë ¥...',
            attr: { style: 'flex: 1; padding: 8px; border-radius: 5px; border: 2px solid var(--interactive-accent);' }
        });
        const addBtn = addSubjectDiv.createEl('button', {
            text: 'â• ê³¼ëª© ì¶”ê°€',
            cls: 'mod-cta'
        });
        addBtn.addEventListener('click', async () => {
            const newSubject = newSubjectInput.value.trim();
            if (!newSubject) {
                new Notice('âŒ ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (this.plugin.settings.subjects.includes(newSubject)) {
                new Notice('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³¼ëª©ì…ë‹ˆë‹¤.');
                return;
            }
            this.plugin.settings.subjects.push(newSubject);
            await this.plugin.saveSettings();
            const subjectFolder = normalizePath(`${this.plugin.settings.problemsFolder}/${newSubject}`);
            try {
                await this.app.vault.createFolder(subjectFolder);
                new Notice(`âœ… '${newSubject}' ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            } catch (error) {
                new Notice(`âœ… '${newSubject}' ê³¼ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (í´ë”ëŠ” ì´ë¯¸ ì¡´ì¬í•¨)`);
            }
            newSubjectInput.value = '';
            this.renderSubjectsList(subjectsContainer);
            this.plugin.refreshDashboard();
        });
        containerEl.createEl('hr');
        containerEl.createEl('h3', { text: 'âš™ï¸ ê¸°ë³¸ ì„¤ì •' });
        new Setting(containerEl)
            .setName('ë¬¸ì œ í´ë”')
            .setDesc('ë¬¸ì œ íŒŒì¼ë“¤ì´ ì €ì¥ë  í´ë” ê²½ë¡œ')
            .addText(text => text
                .setPlaceholder('í•™ìŠµê´€ë¦¬/ë¬¸ì œì€í–‰')
                .setValue(this.plugin.settings.problemsFolder)
                .onChange(async (value) => {
                    this.plugin.settings.problemsFolder = value;
                    await this.plugin.saveSettings();
                }));
        new Setting(containerEl)
            .setName('ìµœëŒ€ ë¬¸ì œ ìˆ˜')
            .setDesc('ìƒì„±í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ë¬¸ì œ ê°œìˆ˜')
            .addDropdown(dropdown => dropdown
                .addOption('100', '100ë¬¸ì œ')
                .addOption('200', '200ë¬¸ì œ')
                .addOption('500', '500ë¬¸ì œ')
                .setValue(this.plugin.settings.maxProblems.toString())
                .onChange(async (value) => {
                    this.plugin.settings.maxProblems = parseInt(value);
                    await this.plugin.saveSettings();
                }));
        new Setting(containerEl)
            .setName('ì¼ì¼ í•™ìŠµ ëª©í‘œ')
            .setDesc('í•˜ë£¨ì— í’€ì–´ì•¼ í•  ë¬¸ì œ ìˆ˜')
            .addText(text => text
                .setPlaceholder('5')
                .setValue(this.plugin.settings.dailyGoal.toString())
                .onChange(async (value) => {
                    this.plugin.settings.dailyGoal = parseInt(value) || 5;
                    await this.plugin.saveSettings();
                }));
        new Setting(containerEl)
            .setName('ê¸°ë³¸ ê³¼ëª©')
            .setDesc('ëŒ€ì‹œë³´ë“œë¥¼ ì—´ ë•Œ ê¸°ë³¸ìœ¼ë¡œ ì„ íƒë  ê³¼ëª©')
            .addDropdown(dropdown => {
                this.plugin.settings.subjects.forEach(subject => {
                    dropdown.addOption(subject, subject);
                });
                dropdown.setValue(this.plugin.settings.defaultSubject);
                dropdown.onChange(async (value) => {
                    this.plugin.settings.defaultSubject = value;
                    await this.plugin.saveSettings();
                });
            });
    }

    renderSubjectsList(container) {
        container.empty();
        container.createEl('p', { 
            text: 'í˜„ì¬ ê³¼ëª© ëª©ë¡:',
            attr: { style: 'font-weight: bold; margin-bottom: 10px;' }
        });
        const listDiv = container.createDiv();
        listDiv.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        this.plugin.settings.subjects.forEach(subject => {
            const itemDiv = listDiv.createDiv();
            itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--background-primary); border-radius: 8px;';
            const nameSpan = itemDiv.createEl('span', {
                text: `ğŸ“š ${subject}`,
                attr: { style: 'font-weight: 500;' }
            });
            const deleteBtn = itemDiv.createEl('button', {
                text: 'ğŸ—‘ï¸ ì‚­ì œ',
                attr: { style: 'padding: 4px 12px; background: #ef4444; color: white; border: none; border-radius: 5px; cursor: pointer;' }
            });
            deleteBtn.addEventListener('click', async () => {
                if (this.plugin.settings.subjects.length <= 1) {
                    new Notice('âŒ ìµœì†Œ 1ê°œì˜ ê³¼ëª©ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
                    return;
                }
                const confirmDelete = confirm(`'${subject}' ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì£¼ì˜: í´ë”ì™€ íŒŒì¼ì€ ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œì—ì„œë§Œ ì œê±°ë©ë‹ˆë‹¤.`);
                if (confirmDelete) {
                    this.plugin.settings.subjects = this.plugin.settings.subjects.filter(s => s !== subject);
                    if (this.plugin.settings.defaultSubject === subject) {
                        this.plugin.settings.defaultSubject = this.plugin.settings.subjects[0];
                    }
                    await this.plugin.saveSettings();
                    new Notice(`âœ… '${subject}' ê³¼ëª©ì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    this.renderSubjectsList(container);
                    this.plugin.refreshDashboard();
                }
            });
        });
    }
}

module.exports = StudyDashboardPlugin;