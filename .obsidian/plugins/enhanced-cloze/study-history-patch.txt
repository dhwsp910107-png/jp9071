// StudyHistoryModalì„ ì°¾ì•„ì„œ ì•„ë˜ ì½”ë“œë¡œ êµì²´í•˜ì„¸ìš”:

class StudyHistoryModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('study-history-modal');

        contentEl.createEl('h2', { text: 'ğŸ“‹ í•™ìŠµ ì„¸ì…˜ ê¸°ë¡' });
        
        const stats = this.plugin.settings.stats;
        const history = stats.studyHistory || [];

        if (history.length === 0) {
            contentEl.createEl('p', { 
                text: 'ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤. í€´ì¦ˆë¥¼ ì™„ë£Œí•˜ê±°ë‚˜ í•™ìŠµì„ ì •ì§€í•˜ë©´ ê¸°ë¡ì´ ìŒ“ì…ë‹ˆë‹¤.',
                cls: 'setting-item-description'
            }).style.cssText = 'padding: 20px; text-align: center; color: var(--text-muted);';
            return;
        }

        // í—¤ë” ë²„íŠ¼
        const headerButtons = contentEl.createDiv();
        headerButtons.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const resetBtn = headerButtons.createEl('button', { text: 'ğŸ—‘ï¸ ê¸°ë¡ ì´ˆê¸°í™”' });
        resetBtn.style.cssText = 'flex: 1; padding: 8px 16px; background: var(--background-modifier-error); color: white;';
        resetBtn.onclick = async () => {
            if (confirm('ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                this.plugin.settings.stats = {
                    totalAttempts: 0,
                    totalCorrect: 0,
                    totalTime: 0,
                    lastStudyDate: null,
                    studyHistory: [],
                    folderStats: {},
                    fileStats: {}
                };
                await this.plugin.saveSettings();
                new Notice('í•™ìŠµ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                this.onOpen();
            }
        };

        // í•™ìŠµ ì„¸ì…˜ ëª©ë¡
        contentEl.createEl('h3', { text: `ğŸ“„ ì „ì²´ í•™ìŠµ ì„¸ì…˜ (${history.length}ê°œ)` });
        
        const sessionList = contentEl.createDiv({ cls: 'session-list' });
        sessionList.style.cssText = 'max-height: 60vh; overflow-y: auto; border: 1px solid var(--background-modifier-border); border-radius: 6px;';

        // ìµœê·¼ ìˆœìœ¼ë¡œ ì •ë ¬
        const sortedHistory = history.sort((a, b) => b.timestamp - a.timestamp);

        for (const record of sortedHistory) {
            const sessionDiv = sessionList.createDiv({ cls: 'session-item' });
            sessionDiv.style.cssText = 'padding: 12px; border-bottom: 1px solid var(--background-modifier-border); display: flex; justify-content: space-between; align-items: center;';

            const infoDiv = sessionDiv.createDiv();
            infoDiv.style.flex = '1';
            
            const date = new Date(record.timestamp);
            const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            const folderName = record.folderName || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const fileName = record.fileName || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const statusIcon = record.completed ? 'âœ…' : 'â±ï¸';
            
            infoDiv.createEl('div', { text: `${statusIcon} ${dateStr}` }).style.cssText = 'font-weight: 500; margin-bottom: 4px;';
            infoDiv.createEl('div', { 
                text: `ğŸ“ ${folderName} / ğŸ“„ ${fileName}`,
                cls: 'setting-item-description'
            }).style.fontSize = '0.9em';

            const statsDiv = sessionDiv.createDiv();
            statsDiv.style.cssText = 'text-align: right; display: flex; flex-direction: column; gap: 4px;';
            
            const statusBadge = statsDiv.createEl('span', { 
                text: record.completed ? 'ì™„ë£Œ' : 'ì‹œê°„ì´ˆê³¼'
            });
            statusBadge.style.cssText = `padding: 2px 8px; border-radius: 4px; font-size: 0.85em; background: ${record.completed ? 'var(--color-green)' : 'var(--color-orange)'}; color: white; display: inline-block;`;
            
            statsDiv.createEl('span', { 
                text: `${Math.round(record.duration)}ì´ˆ`,
                cls: 'setting-item-description'
            }).style.fontSize = '0.85em';
        }
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}
