// Learning Strategy Planner Plugin - Enhanced Version
// Î∂ÅÎßàÌÅ¨, Ìè¥Îçî, ÎÇúÏù¥ÎèÑ, ÌÜµÍ≥Ñ, Ïù¥ÎØ∏ÏßÄ ÏßÄÏõê

const { Plugin, ItemView, Modal, PluginSettingTab, Setting, Notice, TFile } = require('obsidian');

const VIEW_TYPE = 'learning-planner-view';

const DEFAULT_SETTINGS = {
    // Í∏∞Î≥∏ ÏÑ§Ï†ï
    learningFolder: 'Learning Plans',
    bookmarksFolder: '‚≠ê Î∂ÅÎßàÌÅ¨',
    autoSave: true,
    
    // ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞
    quizzes: {},
    bookmarks: [],
    
    // Ìè¥Îçî Í¥ÄÎ¶¨
    questionFolders: ['Í∏∞Î≥∏', 'Ï§ëÍ∏â', 'Í≥†Í∏â', 'ÌäπÎ≥Ñ'],
    
    // ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï
    difficulties: ['Ïâ¨ÏõÄ', 'Î≥¥ÌÜµ', 'Ïñ¥Î†§ÏõÄ', 'Îß§Ïö∞ Ïñ¥Î†§ÏõÄ'],
    defaultDifficulty: 'Î≥¥ÌÜµ',
    
    // ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï (enhanced-cloze Ïä§ÌÉÄÏùº)
    enableTimer: true,
    defaultTimerDuration: 30,
    timerWarningThreshold: 5,
    autoStartTimer: false,
    enableVibration: true,
    timerPosition: 'top', // 'top', 'bottom', 'floating'
    enableAutoRevealOnTimeout: true,
    timerDurationsByFolder: {},
    
    // ÏûêÎèô Îí§ÏßëÍ∏∞ ÏÑ§Ï†ï
    enableAutoReveal: false,
    autoRevealDelay: 3,
    
    // ÌÜµÍ≥Ñ Ï∂îÏ†Å (enhanced-cloze Ïä§ÌÉÄÏùºÎ°ú ÌôïÏû•)
    stats: {
        totalQuizzes: 0,
        totalQuestions: 0,
        totalCorrect: 0,
        totalWrong: 0,
        totalTime: 0,
        lastStudyDate: null,
        studyHistory: [],
        folderStats: {},
        difficultyStats: {},
        fileStats: {} // ÌååÏùºÎ≥Ñ ÌÜµÍ≥Ñ Ï∂îÍ∞Ä
    },
    
    // Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
    attachmentFolderName: 'Ï≤®Î∂ÄÌååÏùº',
    enableImages: true,
    
    // UI ÏÑ§Ï†ï
    shuffleQuestions: true,
    shuffleOptions: true,
    showHintAfterWrong: true,
    reducedAnimations: false,
    
    // Î£®Ìã¥ ÌîåÎûòÎÑà Í∏∞Îä• (routine-planner ÌÜµÌï©)
    routineEnabled: true,
    routineFolder: 'Routine',
    folderStructure: 'monthly', // 'monthly', 'weekly', 'daily'
    autoCreateFolder: true,
    syncWithFiles: true,
    routineTemplates: [
        { id: '1', name: 'ÏòÅÏñ¥ ÌïôÏäµ', items: ['ÏòÅÏñ¥ Í∞ïÏùò 2Í∞ï', 'ÏòÅÏñ¥ Îâ¥Ïä§ ÏùΩÍ∏∞', 'Anki Îã®Ïñ¥'] },
        { id: '2', name: 'ÏùºÎ≥∏Ïñ¥ ÌïôÏäµ', items: ['ÏùºÎ≥∏Ïñ¥ Í∞ïÏùò 2Í∞ï', 'Anki Îã®Ïñ¥'] },
        { id: '3', name: 'Í∑∏Î¶º Ïó∞Ïäµ', items: ['ÌÅ¨Î°úÌÇ§ 3Ïû•', 'Ïù∏Ï≤¥ ÎìúÎ°úÏûâ'] }
    ],
    weekStart: 0,
    themeColor: '#f59e0b',
    
    // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ Î∞è Î©îÎ™® Îç∞Ïù¥ÌÑ∞ (enhanced-cloze Ïä§ÌÉÄÏùº)
    dailyChecklists: {}, // { 'YYYY-MM-DD': { items: [{text, completed}], notes: ['note1', 'note2'] } }
    weeklyChecklists: {}, // { 'YYYY-Www': { items: [], notes: [] } }
    monthlyChecklists: {}, // { 'YYYY-MM': { items: [], notes: [] } }
    
    // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÌÖúÌîåÎ¶ø
    checklistTemplates: [
        { id: '1', name: 'Í∏∞Î≥∏ ÏùºÏùº Î£®Ìã¥', type: 'daily', items: ['ÏïÑÏπ® Î≥µÏäµ', 'Ï†ÄÎÖÅ Î≥µÏäµ', 'Ïò§Îãµ Ï†ïÎ¶¨'] },
        { id: '2', name: 'Ï£ºÍ∞Ñ Î™©Ìëú', type: 'weekly', items: ['ÌïµÏã¨ Í∞úÎÖê Ï†ïÎ¶¨', 'Î™®ÏùòÍ≥†ÏÇ¨ ÌíÄÍ∏∞', 'ÏïΩÏ†ê Î≥¥ÏôÑ'] },
        { id: '3', name: 'ÏõîÍ∞Ñ Ìï†Ïùº', type: 'monthly', items: ['Ï†ÑÏ≤¥ Î≥µÏäµ', 'Îã§Ïùå Îã¨ Í≥ÑÌöç', 'ÌïôÏäµ ÌÜµÍ≥Ñ Î∂ÑÏÑù'] }
    ],
    
    // ÎåÄÏãúÎ≥¥Îìú ÏÑ§Ï†ï
    showTimerInDashboard: true,
    dashboardAutoRefresh: true,
    dashboardMemo: ''
};

// ==================== Î©îÏù∏ ÌîåÎü¨Í∑∏Ïù∏ ÌÅ¥ÎûòÏä§ ====================
class LearningStrategyPlugin extends Plugin {
    async onload() {
        console.log('ÌïôÏäµ Ï†ÑÎûµ ÌîåÎûòÎÑà ÌîåÎü¨Í∑∏Ïù∏ Î°úÎî©...');
        
        await this.loadSettings();
        
        this.registerView(VIEW_TYPE, (leaf) => new LearningPlannerView(leaf, this));

        this.addRibbonIcon('book-open', 'ÌïôÏäµ ÌîåÎûòÎÑà', () => {
            this.activateView();
        });

        this.addCommand({
            id: 'open-learning-planner',
            name: 'ÌïôÏäµ ÌîåÎûòÎÑà Ïó¥Í∏∞',
            callback: () => this.activateView()
        });

        this.addCommand({
            id: 'create-quiz',
            name: 'ÏÉà ÌÄ¥Ï¶à ÎßåÎì§Í∏∞',
            callback: () => new QuizCreatorModal(this.app, this).open()
        });

        this.addCommand({
            id: 'view-bookmarks',
            name: 'Î∂ÅÎßàÌÅ¨ Î≥¥Í∏∞',
            callback: () => new BookmarkListModal(this.app, this).open()
        });

        this.addCommand({
            id: 'view-statistics',
            name: 'ÌÜµÍ≥Ñ Î≥¥Í∏∞',
            callback: () => new StatisticsModal(this.app, this).open()
        });
        
        this.addSettingTab(new LearningStrategySettingTab(this.app, this));
    }
    
    async loadSettings() {
        this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
        
        // ÌÜµÍ≥Ñ Ï¥àÍ∏∞Ìôî
        if (!this.settings.stats) {
            this.settings.stats = DEFAULT_SETTINGS.stats;
        }
    }
    
    async saveSettings() {
        await this.saveData(this.settings);
    }

    async activateView() {
        const { workspace } = this.app;
        let leaf = workspace.getLeavesOfType(VIEW_TYPE)[0];
        
        if (!leaf) {
            leaf = workspace.getRightLeaf(false);
            await leaf.setViewState({ type: VIEW_TYPE, active: true });
        }
        
        workspace.revealLeaf(leaf);
    }
    
    // ÌïôÏäµ Í∏∞Î°ù Ï†ÄÏû• (enhanced-cloze Ïä§ÌÉÄÏùº)
    async recordStudySession(quizId, folder, duration, correct, total) {
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0];
        
        // ÌïôÏäµ ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
        if (!this.settings.stats.studyHistory) {
            this.settings.stats.studyHistory = [];
        }
        
        this.settings.stats.studyHistory.push({
            date: dateStr,
            timestamp: now.toISOString(),
            quizId: quizId,
            folder: folder,
            duration: duration,
            correct: correct,
            total: total,
            accuracy: total > 0 ? Math.round((correct / total) * 100) : 0
        });
        
        // Ï†ÑÏó≠ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        this.settings.stats.totalCorrect += correct;
        this.settings.stats.totalWrong += (total - correct);
        this.settings.stats.totalTime += duration;
        this.settings.stats.lastStudyDate = dateStr;
        
        // Ìè¥ÎçîÎ≥Ñ ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        if (!this.settings.stats.folderStats) {
            this.settings.stats.folderStats = {};
        }
        if (!this.settings.stats.folderStats[folder]) {
            this.settings.stats.folderStats[folder] = {
                attempts: 0,
                correct: 0,
                time: 0
            };
        }
        this.settings.stats.folderStats[folder].attempts += total;
        this.settings.stats.folderStats[folder].correct += correct;
        this.settings.stats.folderStats[folder].time += duration;
        
        await this.saveSettings();
    }
    
    // Ìè¥ÎçîÎ≥Ñ ÌÜµÍ≥Ñ Í∞ÄÏ†∏Ïò§Í∏∞
    getFolderStats(folder) {
        if (!this.settings.stats.folderStats) {
            return { attempts: 0, correct: 0, time: 0 };
        }
        return this.settings.stats.folderStats[folder] || { attempts: 0, correct: 0, time: 0 };
    }
    
    // Î∂ÅÎßàÌÅ¨ Ï∂îÍ∞Ä/Ï†úÍ±∞
    toggleBookmark(quizId, questionIndex) {
        const bookmarkKey = `${quizId}_${questionIndex}`;
        const existingIndex = this.settings.bookmarks.findIndex(b => b.key === bookmarkKey);
        
        if (existingIndex >= 0) {
            this.settings.bookmarks.splice(existingIndex, 1);
            return false;
        } else {
            this.settings.bookmarks.push({
                key: bookmarkKey,
                quizId: quizId,
                questionIndex: questionIndex,
                timestamp: Date.now()
            });
            return true;
        }
    }
    
    isBookmarked(quizId, questionIndex) {
        const bookmarkKey = `${quizId}_${questionIndex}`;
        return this.settings.bookmarks.some(b => b.key === bookmarkKey);
    }
    
    // Ïñ∏Ïñ¥ ÏûêÎèô Í∞êÏßÄ (quiz-sp2 Í∏∞Îä• ÌÜµÌï©)
    detectLanguage(text) {
        if (!text || text.trim().length === 0) {
            return 'ko-KR';
        }

        const trimmed = text.trim();
        const totalChars = trimmed.length;
        
        let koreanChars = 0;
        let japaneseChars = 0;
        let chineseChars = 0;
        let englishChars = 0;
        
        for (let i = 0; i < trimmed.length; i++) {
            const char = trimmed[i];
            const code = char.charCodeAt(0);
            
            if ((code >= 0xAC00 && code <= 0xD7A3) || 
                (code >= 0x1100 && code <= 0x11FF) || 
                (code >= 0x3131 && code <= 0x318E)) {
                koreanChars++;
            }
            else if ((code >= 0x3040 && code <= 0x309F) || (code >= 0x30A0 && code <= 0x30FF)) {
                japaneseChars++;
            }
            else if ((code >= 0x4E00 && code <= 0x9FFF) || (code >= 0x3400 && code <= 0x4DBF)) {
                chineseChars++;
            }
            else if ((code >= 65 && code <= 90) || (code >= 97 && code <= 122)) {
                englishChars++;
            }
        }
        
        const koreanRatio = koreanChars / totalChars;
        const japaneseRatio = japaneseChars / totalChars;
        const chineseRatio = chineseChars / totalChars;
        const englishRatio = englishChars / totalChars;
        
        if (koreanRatio >= 0.1) return 'ko-KR';
        if (japaneseRatio >= 0.1) return 'ja-JP';
        if (chineseRatio >= 0.1) return 'zh-CN';
        if (englishRatio >= 0.3) return 'en-US';
        
        return 'ko-KR';
    }

    // Ïò§ÌîÑÎùºÏù∏ TTS (quiz-sp2 Í∏∞Îä• ÌÜµÌï©)
    async speakText(text, options = {}) {
        if (!text || text.trim().length === 0) {
            new Notice('ÏùΩÏùÑ ÌÖçÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
            return;
        }

        if (!window.speechSynthesis) {
            new Notice('‚ö†Ô∏è Ïù¥ Î∏åÎùºÏö∞Ï†ÄÎäî ÏùåÏÑ± ÏùΩÍ∏∞Î•º ÏßÄÏõêÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
            return;
        }

        try {
            window.speechSynthesis.cancel();

            const detectedLang = this.detectLanguage(text);
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = detectedLang;
            utterance.rate = options.rate || 1.0;
            utterance.pitch = options.pitch || 1.0;
            utterance.volume = options.volume || 1.0;

            const voices = window.speechSynthesis.getVoices();
            const langPrefix = detectedLang.split('-')[0];
            
            let selectedVoice = voices.find(v => 
                v.lang.startsWith(langPrefix) && 
                (v.name.toLowerCase().includes('samsung') || 
                 v.name.includes('ÏÇºÏÑ±') ||
                 v.voiceURI.toLowerCase().includes('samsung'))
            );

            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith(langPrefix));
            }

            if (selectedVoice) {
                utterance.voice = selectedVoice;
                
                if (selectedVoice.name.toLowerCase().includes('samsung') || 
                    selectedVoice.name.includes('ÏÇºÏÑ±')) {
                    utterance.rate = Math.max(0.5, Math.min(2.0, utterance.rate));
                    utterance.pitch = Math.max(0.5, Math.min(2.0, utterance.pitch));
                }
            }

            utterance.onstart = () => {
                // Ï°∞Ïö©Ìûà Ïû¨ÏÉù
            };

            utterance.onerror = (event) => {
                // interrupted Ïò§Î•òÎäî Î¨¥Ïãú (Ï†ïÏÉÅÏ†ÅÏù∏ Ï§ëÎã®)
                if (event.error !== 'interrupted') {
                    console.error('TTS Ïò§Î•ò:', event.error);
                }
            };

            // Í∏∞Ï°¥ ÏùåÏÑ± Ï§ëÏßÄ ÌõÑ Ïû¨ÏÉù
            window.speechSynthesis.cancel();
            setTimeout(() => {
                window.speechSynthesis.speak(utterance);
            }, 100);
            
        } catch (error) {
            console.error('TTS Error:', error);
            new Notice('‚ùå ÏùåÏÑ± ÏùΩÍ∏∞ Ïã§Ìå®: ' + error.message);
        }
    }
    
    // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏ (enhanced-cloze Ïä§ÌÉÄÏùºÎ°ú ÌôïÏû•)
    updateStats(quizId, correct, time, folder, difficulty) {
        const stats = this.settings.stats;
        
        stats.totalQuestions++;
        if (correct) stats.totalCorrect++;
        else stats.totalWrong++;
        stats.totalTime += time;
        stats.lastStudyDate = Date.now();
        
        // Ìè¥ÎçîÎ≥Ñ ÌÜµÍ≥Ñ (enhanced-cloze Ïä§ÌÉÄÏùº)
        if (!stats.folderStats[folder]) {
            stats.folderStats[folder] = { 
                attempts: 0, 
                correct: 0, 
                time: 0,
                fileStats: {} 
            };
        }
        stats.folderStats[folder].attempts++;
        if (correct) stats.folderStats[folder].correct++;
        stats.folderStats[folder].time += time;
        
        // ÌååÏùºÎ≥Ñ ÌÜµÍ≥Ñ (enhanced-cloze Ïä§ÌÉÄÏùº)
        if (!stats.fileStats[quizId]) {
            stats.fileStats[quizId] = { 
                attempts: 0, 
                correct: 0, 
                time: 0,
                lastStudy: null
            };
        }
        stats.fileStats[quizId].attempts++;
        if (correct) stats.fileStats[quizId].correct++;
        stats.fileStats[quizId].time += time;
        stats.fileStats[quizId].lastStudy = Date.now();
        
        // ÎÇúÏù¥ÎèÑÎ≥Ñ ÌÜµÍ≥Ñ
        if (!stats.difficultyStats[difficulty]) {
            stats.difficultyStats[difficulty] = { total: 0, correct: 0, time: 0 };
        }
        stats.difficultyStats[difficulty].total++;
        if (correct) stats.difficultyStats[difficulty].correct++;
        stats.difficultyStats[difficulty].time += time;
        
        // ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä (enhanced-cloze Ïä§ÌÉÄÏùºÎ°ú ÏÉÅÏÑ∏Ìôî)
        stats.studyHistory.push({
            quizId,
            correct,
            duration: time,
            folder,
            difficulty,
            timestamp: Date.now(),
            date: new Date().toLocaleDateString('ko-KR')
        });
        
        // ÌûàÏä§ÌÜ†Î¶¨ ÏµúÎåÄ 1000Í∞úÎ°ú Ï†úÌïú
        if (stats.studyHistory.length > 1000) {
            stats.studyHistory = stats.studyHistory.slice(-1000);
        }

        this.saveSettings();
    }
    
    onunload() {
        console.log('ÌïôÏäµ Ï†ÑÎûµ ÌîåÎûòÎÑà ÌîåÎü¨Í∑∏Ïù∏ Ïñ∏Î°úÎìú');
    }
}

// ==================== LearningPlannerView ÌÅ¥ÎûòÏä§ ====================
class LearningPlannerView extends ItemView {
    constructor(leaf, plugin) {
        super(leaf);
        this.plugin = plugin;
        this.currentView = 'quiz'; // 'quiz', 'test-daily', 'test-weekly', 'test-monthly'
        this.currentDate = new Date();
    }

    getViewType() {
        return VIEW_TYPE;
    }

    getDisplayText() {
        return 'ÌïôÏäµ Ï†ÑÎûµ ÌîåÎûòÎÑà';
    }

    async onOpen() {
        const container = this.containerEl.children[1];
        container.empty();
        container.addClass('lp-container');

        await this.renderDashboard(container);
    }
    
    async renderDashboard(container) {
        // Ìó§Îçî - Í∏ÄÎùºÏä§Î™®ÌîºÏ¶ò Ïä§ÌÉÄÏùº
        const header = container.createDiv({ cls: 'lp-header' });
        header.style.cssText = 'margin-bottom: 32px; padding: 32px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%); backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(139, 92, 246, 0.2); box-shadow: 0 8px 32px rgba(99, 102, 241, 0.15);';
        
        const title = header.createEl('h2', { text: '‚ú® ÌïôÏäµ Ï†ÑÎûµ ÌîåÎûòÎÑà' });
        title.style.cssText = 'margin: 0 0 24px 0; font-size: 2.5em; font-weight: 900; background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; letter-spacing: -1px;';
        
        // ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò - ÎÑ§Ïò® Ïä§ÌÉÄÏùº
        const tabNav = header.createDiv({ cls: 'lp-tab-nav' });
        tabNav.style.cssText = 'display: flex; gap: 12px; margin: 20px 0; padding: 8px; background: rgba(15, 23, 42, 0.6); border-radius: 16px; backdrop-filter: blur(10px); flex-wrap: wrap; justify-content: center;';
        
        const createTab = (text, view) => {
            const tab = tabNav.createEl('button', { text, cls: 'lp-tab-btn' });
            const isActive = this.currentView === view;
            tab.style.cssText = `padding: 14px 28px; background: ${isActive ? 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)' : 'rgba(30, 41, 59, 0.5)'}; color: ${isActive ? '#fff' : '#94a3b8'}; border: ${isActive ? '2px solid #8b5cf6' : '1px solid rgba(148, 163, 184, 0.2)'}; border-radius: 12px; cursor: pointer; font-weight: ${isActive ? '700' : '500'}; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: ${isActive ? '0 8px 24px rgba(99, 102, 241, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.1)' : '0 2px 8px rgba(0, 0, 0, 0.1)'}; position: relative; overflow: hidden;`;
            
            const clickHandler = () => {
                this.currentView = view;
                this.onOpen();
            };
            
            tab.onclick = clickHandler;
            tab.addEventListener('touchend', (e) => {
                e.preventDefault();
                clickHandler();
            });
            
            if (!isActive) {
                tab.addEventListener('mouseenter', () => {
                    tab.style.background = 'linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.3) 100%)';
                    tab.style.borderColor = '#8b5cf6';
                    tab.style.transform = 'translateY(-3px) scale(1.05)';
                    tab.style.boxShadow = '0 12px 28px rgba(139, 92, 246, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1)';
                    tab.style.color = '#e0e7ff';
                });
                tab.addEventListener('mouseleave', () => {
                    tab.style.background = 'rgba(30, 41, 59, 0.5)';
                    tab.style.borderColor = 'rgba(148, 163, 184, 0.2)';
                    tab.style.transform = 'translateY(0) scale(1)';
                    tab.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                    tab.style.color = '#94a3b8';
                });
            }
        };
        
        createTab('üìù ÌÄ¥Ï¶à Í¥ÄÎ¶¨', 'quiz');
        createTab('üìÖ ÏùºÎ≥Ñ ÌÖåÏä§Ìä∏', 'test-daily');
        createTab('üìÜ Ï£ºÍ∞Ñ ÌÖåÏä§Ìä∏', 'test-weekly');
        createTab('üìä ÏõîÍ∞Ñ ÌÖåÏä§Ìä∏', 'test-monthly');

        // Ìó§Îçî Î≤ÑÌäºÎì§
        const headerButtons = header.createDiv({ cls: 'lp-header-buttons' });
        headerButtons.style.cssText = 'display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap;';
        
        const refreshBtn = headerButtons.createEl('button', { text: 'üîÑ ÏÉàÎ°úÍ≥†Ïπ®', cls: 'lp-btn' });
        refreshBtn.style.cssText = 'padding: 12px 24px; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); color: #fff; border: 2px solid rgba(236, 72, 153, 0.5); border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 14px; box-shadow: 0 8px 24px rgba(236, 72, 153, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);';
        refreshBtn.onclick = () => this.onOpen();
        refreshBtn.addEventListener('mouseenter', () => {
            refreshBtn.style.transform = 'translateY(-4px) scale(1.05)';
            refreshBtn.style.boxShadow = '0 16px 40px rgba(236, 72, 153, 0.6), inset 0 2px 0 rgba(255, 255, 255, 0.3)';
            refreshBtn.style.background = 'linear-gradient(135deg, #f43f5e 0%, #ec4899 100%)';
        });
        refreshBtn.addEventListener('mouseleave', () => {
            refreshBtn.style.transform = 'translateY(0) scale(1)';
            refreshBtn.style.boxShadow = '0 8px 24px rgba(236, 72, 153, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2)';
            refreshBtn.style.background = 'linear-gradient(135deg, #ec4899 0%, #f43f5e 100%)';
        });

        // Î™©Ìëú ÏöîÏïΩ (Î™®Îì† ÌÉ≠ÏóêÏÑú ÌëúÏãú)
        this.renderGoalsSummary(container);

        // ÌÉ≠Î≥Ñ ÏΩòÌÖêÏ∏†
        if (this.currentView === 'quiz') {
            await this.renderQuizView(container);
        } else if (this.currentView === 'test-daily') {
            await this.renderTestDailyTab(container);
        } else if (this.currentView === 'test-weekly') {
            await this.renderTestWeeklyTab(container);
        } else if (this.currentView === 'test-monthly') {
            await this.renderTestMonthlyTab(container);
        }

        // Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
        this.addStyles();
    }
    
    renderHeader(header) {
        // ÏÇ≠Ï†úÎêú Î©îÏÑúÎìú (renderDashboardÏóê ÌÜµÌï©)
    }
    
    async renderQuizView(container) {
        // Ìè¥ÎçîÎ≥Ñ ÌÄ¥Ï¶à Í∑∏Î¶¨Îìú (enhanced-cloze Ïä§ÌÉÄÏùº) - ÏµúÏÉÅÎã® Î∞∞Ïπò
        await this.renderFolderGrid(container);

        // ÏßÅÏÇ¨Í∞ÅÌòï Ïï°ÏÖò Î≤ÑÌäº Î∞î
        this.renderActionBar(container);

        // Í∞ÑÎã®Ìïú ÌÜµÍ≥Ñ Î∞î (Ïà®ÍπÄ)
        // this.renderSimpleStats(container);

        // Îπ†Î•∏ Ïï°ÏÖò (Ïà®ÍπÄ)
        // this.renderQuickActions(container);

        // ÏµúÍ∑º ÌÄ¥Ï¶à Î™©Î°ù
        this.renderRecentQuizzes(container);
    }
    
    // Í∞ÑÎã®Ìïú ÌÜµÍ≥Ñ (enhanced-cloze Ïä§ÌÉÄÏùº)
    renderSimpleStats(container) {
        const stats = this.plugin.settings.stats;
        const quizCount = Object.keys(this.plugin.settings.quizzes || {}).length;
        let totalQuestions = 0;
        Object.values(this.plugin.settings.quizzes || {}).forEach(q => {
            totalQuestions += q.questions?.length || 0;
        });
        const accuracy = stats.totalQuestions > 0 
            ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100)
            : 0;

        const statsBar = container.createDiv();
        statsBar.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; padding: 24px; background: linear-gradient(135deg, rgba(30, 41, 59, 0.4) 0%, rgba(15, 23, 42, 0.6) 100%); backdrop-filter: blur(16px); border-radius: 20px; margin-bottom: 28px; border: 1px solid rgba(139, 92, 246, 0.2); box-shadow: 0 8px 32px rgba(99, 102, 241, 0.15);';

        const statItem = (icon, label, value, color) => {
            const item = statsBar.createDiv();
            item.style.cssText = 'text-align: center; padding: 20px; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 16px; background: rgba(30, 41, 59, 0.3); border: 1px solid rgba(139, 92, 246, 0.1);';
            item.addEventListener('mouseenter', () => {
                item.style.transform = 'scale(1.08) translateY(-6px) rotate(2deg)';
                item.style.background = `linear-gradient(135deg, ${color}15 0%, ${color}25 100%)`;
                item.style.borderColor = color;
                item.style.boxShadow = `0 16px 40px ${color}40, inset 0 1px 0 rgba(255, 255, 255, 0.1)`;
            });
            item.addEventListener('mouseleave', () => {
                item.style.transform = 'scale(1) translateY(0) rotate(0deg)';
                item.style.background = 'rgba(30, 41, 59, 0.3)';
                item.style.borderColor = 'rgba(139, 92, 246, 0.1)';
                item.style.boxShadow = 'none';
            });
            item.innerHTML = `
                <div style="font-size: 3em; margin-bottom: 12px; filter: drop-shadow(0 4px 12px ${color}60);">${icon}</div>
                <div style="font-size: 2.2em; font-weight: 900; background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">${value}</div>
                <div style="font-size: 0.85em; color: #94a3b8; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">${label}</div>
            `;
        };

        statItem('üìö', 'ÌÄ¥Ï¶à', quizCount, '#3b82f6');
        statItem('üìù', 'Î¨∏Ï†ú', totalQuestions, '#8b5cf6');
        statItem('‚≠ê', 'Î∂ÅÎßàÌÅ¨', this.plugin.settings.bookmarks.length, '#f59e0b');
        statItem('‚úÖ', 'Ï†ïÎãµÎ•†', `${accuracy}%`, accuracy >= 70 ? '#10b981' : '#ef4444');
    }
    
    // Î™©Ìëú ÏöîÏïΩ Î†åÎçîÎßÅ (enhanced-cloze Í∏∞Îä• ÌÜµÌï©)
    renderGoalsSummary(container) {
        const summarySection = container.createDiv();
        summarySection.style.cssText = 'background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(16, 185, 129, 0.08) 100%); padding: 24px; border-radius: 14px; margin-bottom: 24px; border: 2px solid rgba(59, 130, 246, 0.3); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);';
        
        const summaryGrid = summarySection.createDiv();
        summaryGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 14px;';
        
        // Ï£ºÍ∞Ñ Î™©Ìëú
        const weekKey = this.getWeekKey(new Date());
        const weeklyData = this.plugin.settings.weeklyChecklists?.[weekKey];
        
        this.renderGoalBox(summaryGrid, 'üéØ Ï£ºÍ∞Ñ Î™©Ìëú', weeklyData, weekKey, 'weekly', '#3b82f6');
        
        // ÏõîÍ∞Ñ Î™©Ìëú
        const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
        const monthlyData = this.plugin.settings.monthlyChecklists?.[monthKey];
        
        this.renderGoalBox(summaryGrid, 'üìã ÏõîÍ∞Ñ Î™©Ìëú', monthlyData, monthKey, 'monthly', '#10b981');
    }
    
    renderGoalBox(container, title, data, key, type, color) {
        const box = container.createDiv();
        box.style.cssText = `background: var(--background-primary); padding: 16px; border-radius: 10px; border-left: 4px solid ${color}; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;`;
        
        box.addEventListener('mouseenter', () => {
            box.style.transform = 'translateY(-3px)';
            box.style.boxShadow = '0 6px 16px rgba(0,0,0,0.12)';
        });
        box.addEventListener('mouseleave', () => {
            box.style.transform = 'translateY(0)';
            box.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)';
        });
        
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Í∞úÏÑ† (Ïä§ÌÅ¨Î°§Í≥º ÌÉ≠ Íµ¨Î∂Ñ)
        let touchStartY = 0;
        let touchStartX = 0;
        box.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            touchStartX = e.touches[0].clientX;
        });
        box.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const touchEndX = e.changedTouches[0].clientX;
            const deltaY = Math.abs(touchEndY - touchStartY);
            const deltaX = Math.abs(touchEndX - touchStartX);
            
            // Ïù¥Îèô Í±∞Î¶¨Í∞Ä 10px ÎØ∏ÎßåÏù¥Î©¥ ÌÉ≠ÏúºÎ°ú Ïù∏Ïãù
            if (deltaY < 10 && deltaX < 10) {
                e.preventDefault();
                this.currentView = type === 'weekly' ? 'routine-weekly' : 'routine-monthly';
                this.onOpen();
            }
        });
        
        const titleEl = box.createEl('div', { text: title });
        titleEl.style.cssText = `font-weight: 600; margin-bottom: 10px; color: ${color}; font-size: 1em;`;
        
        // Î©îÎ™® ÏÑπÏÖò
        if (data && data.notes && data.notes.length > 0) {
            const notesDiv = box.createDiv();
            notesDiv.style.cssText = 'margin-bottom: 8px;';
            data.notes.forEach((note, idx) => {
                const noteEl = notesDiv.createDiv();
                noteEl.style.cssText = `padding: 6px 8px; background: var(--background-secondary); border-radius: 4px; margin-bottom: 4px; font-size: 0.9em; color: var(--text-normal); cursor: pointer;`;
                noteEl.textContent = `üí¨ ${note}`;
                noteEl.onclick = (e) => {
                    e.stopPropagation();
                    new NoteEditModal(this.app, note, (newText) => {
                        const settings = type === 'weekly' ? this.plugin.settings.weeklyChecklists : this.plugin.settings.monthlyChecklists;
                        if (!settings[key]) settings[key] = { items: [], notes: [] };
                        settings[key].notes[idx] = newText;
                        this.plugin.saveSettings();
                        this.onOpen();
                    }, () => {
                        const settings = type === 'weekly' ? this.plugin.settings.weeklyChecklists : this.plugin.settings.monthlyChecklists;
                        settings[key].notes.splice(idx, 1);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }).open();
                };
            });
        }
        
        // Î™©Ìëú Ìï≠Î™© (ÏµúÎåÄ 3Í∞úÎßå ÌëúÏãú)
        if (data && data.items && data.items.length > 0) {
            const completed = data.items.filter(item => item.completed).length;
            const total = data.items.length;
            
            const progressDiv = box.createDiv();
            progressDiv.style.cssText = 'margin: 8px 0;';
            
            const progressBar = progressDiv.createDiv();
            progressBar.style.cssText = 'height: 6px; background: var(--background-modifier-border); border-radius: 3px; overflow: hidden;';
            
            const fill = progressBar.createDiv();
            fill.style.cssText = `width: ${(completed / total) * 100}%; height: 100%; background: ${color}; transition: width 0.3s;`;
            
            const progressText = progressDiv.createDiv();
            progressText.style.cssText = 'font-size: 0.85em; color: var(--text-muted); margin-top: 4px;';
            progressText.textContent = `${completed}/${total} ÏôÑÎ£å (${Math.round((completed / total) * 100)}%)`;
            
            // Ï≤òÏùå 3Í∞ú Ìï≠Î™©Îßå ÌëúÏãú
            data.items.slice(0, 3).forEach(item => {
                const itemEl = box.createDiv();
                itemEl.style.cssText = 'font-size: 0.85em; padding: 4px 0; color: var(--text-muted);';
                itemEl.textContent = `${item.completed ? '‚úì' : '‚óã'} ${item.text}`;
            });
            
            if (total > 3) {
                const moreEl = box.createDiv();
                moreEl.style.cssText = 'font-size: 0.85em; color: var(--text-muted); font-style: italic;';
                moreEl.textContent = `+${total - 3}Í∞ú Îçî...`;
            }
        } else {
            box.createDiv({ text: 'Î™©Ìëú ÏóÜÏùå' }).style.cssText = 'font-size: 0.9em; color: var(--text-muted); font-style: italic;';
        }
        
        // Î≤ÑÌäº
        const btnContainer = box.createDiv();
        btnContainer.style.cssText = 'display: flex; gap: 6px; margin-top: 10px;';
        
        const addBtn = btnContainer.createEl('button', { text: '+ Î©îÎ™®' });
        addBtn.style.cssText = 'flex: 1; padding: 6px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer;';
        addBtn.onclick = (e) => {
            e.stopPropagation();
            new NoteAddModal(this.app, (text) => {
                const settings = type === 'weekly' ? this.plugin.settings.weeklyChecklists : this.plugin.settings.monthlyChecklists;
                if (!settings[key]) settings[key] = { items: [], notes: [] };
                if (!settings[key].notes) settings[key].notes = [];
                settings[key].notes.push(text);
                this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
        
        const addGoalBtn = btnContainer.createEl('button', { text: '+ Î™©Ìëú' });
        addGoalBtn.style.cssText = 'flex: 1; padding: 6px; background: var(--background-modifier-border); border: none; border-radius: 4px; font-size: 0.85em; cursor: pointer;';
        addGoalBtn.onclick = (e) => {
            e.stopPropagation();
            new GoalItemAddModal(this.app, async (text) => {
                const settings = type === 'weekly' ? this.plugin.settings.weeklyChecklists : this.plugin.settings.monthlyChecklists;
                if (!settings[key]) settings[key] = { items: [], notes: [] };
                if (!settings[key].items) settings[key].items = [];
                settings[key].items.push({ text, completed: false });
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
    }
    
    getWeekKey(date) {
        const year = date.getFullYear();
        const firstDayOfYear = new Date(year, 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        return `${year}-W${String(weekNumber).padStart(2, '0')}`;
    }

    renderStatsCards(container) {
        const stats = this.plugin.settings.stats;
        const quizzes = Object.values(this.plugin.settings.quizzes || {});
        
        let totalQuestions = 0;
        quizzes.forEach(quiz => {
            totalQuestions += quiz.questions?.length || 0;
        });

        const statsSection = container.createDiv({ cls: 'lp-stats-section' });
        const statsGrid = statsSection.createDiv({ cls: 'lp-stats-grid' });

        // Ï¥ù ÌÄ¥Ï¶à Ïàò
        this.createStatCard(statsGrid, 'üìä Ï¥ù ÌÄ¥Ï¶à', quizzes.length, 'var(--color-blue)');
        
        // Ï¥ù Î¨∏Ï†ú Ïàò
        this.createStatCard(statsGrid, '‚ùì Ï¥ù Î¨∏Ï†ú', totalQuestions, 'var(--color-green)');
        
        // Î∂ÅÎßàÌÅ¨
        this.createStatCard(statsGrid, '‚≠ê Î∂ÅÎßàÌÅ¨', this.plugin.settings.bookmarks.length, 'var(--color-yellow)');
        
        // Ï†ïÎãµÎ•†
        const accuracy = stats.totalQuestions > 0 
            ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100)
            : 0;
        this.createStatCard(statsGrid, '‚úÖ Ï†ïÎãµÎ•†', `${accuracy}%`, 'var(--color-purple)');
    }

    createStatCard(container, label, value, color) {
        const card = container.createDiv({ cls: 'lp-stat-card' });
        card.style.borderLeft = `4px solid ${color}`;
        
        const valueEl = card.createDiv({ cls: 'lp-stat-value' });
        valueEl.textContent = value.toString();
        valueEl.style.color = color;
        
        card.createDiv({ cls: 'lp-stat-label', text: label });
    }

    renderActionBar(container) {
        const actionBar = container.createDiv();
        actionBar.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 28px; padding: 16px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.08) 100%); backdrop-filter: blur(12px); border-radius: 16px; border: 1px solid rgba(139, 92, 246, 0.2);';

        const createButton = (text, icon, gradient, onClick) => {
            const btn = actionBar.createEl('button', { text: `${icon} ${text}` });
            btn.style.cssText = `padding: 16px 20px; background: ${gradient}; color: #fff; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1em; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2); position: relative; overflow: hidden;`;
            
            btn.addEventListener('mouseenter', () => {
                btn.style.transform = 'translateY(-3px) scale(1.02)';
                btn.style.boxShadow = '0 12px 32px rgba(139, 92, 246, 0.4)';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.transform = 'translateY(0) scale(1)';
                btn.style.boxShadow = '0 4px 16px rgba(99, 102, 241, 0.2)';
            });
            
            btn.onclick = onClick;
            return btn;
        };

        createButton('ÌÄ¥Ï¶à Î™©Î°ù', 'üìö', 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)', () => {
            new QuizListModal(this.app, this.plugin).open();
        });

        createButton('ÏÉÅÏÑ∏ Í∏∞Î°ù', 'üìä', 'linear-gradient(135deg, #8b5cf6 0%, #a855f7 100%)', () => {
            new StudyHistoryModal(this.app, this.plugin).open();
        });

        createButton('ÏÉà ÌÄ¥Ï¶à', '‚ûï', 'linear-gradient(135deg, #ec4899 0%, #f43f5e 100%)', () => {
            new QuizCreatorModal(this.app, this.plugin).open();
        });
    }

    renderQuickActions(container) {
        const actionsDiv = container.createDiv();
        actionsDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 20px;';

        const createBtn = actionsDiv.createEl('button', { text: '‚ûï ÏÉà ÌÄ¥Ï¶à' });
        createBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;';
        createBtn.onclick = () => {
            new QuizCreatorModal(this.app, this.plugin).open();
        };

        const historyBtn = actionsDiv.createEl('button', { text: 'üìö ÌïôÏäµ Í∏∞Î°ù' });
        historyBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--background-primary-alt); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-size: 0.95em;';
        historyBtn.onclick = () => {
            new StudyHistoryModal(this.app, this.plugin).open();
        };
    }

    async renderFolderGrid(container) {
        const section = container.createDiv({ cls: 'folder-section' });
        section.style.cssText = 'margin-bottom: 32px;';
        
        // Ìó§Îçî
        const headerDiv = section.createDiv();
        headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid var(--background-modifier-border);';
        
        const titleEl = headerDiv.createEl('h3', { text: 'üìÇ Ìè¥ÎçîÎ≥Ñ ÌÄ¥Ï¶à' });
        titleEl.style.cssText = 'margin: 0; font-size: 1.4em; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;';
        
        const manageFolderBtn = headerDiv.createEl('button', { text: 'üìÅ Í¥ÄÎ¶¨' });
        manageFolderBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; font-weight: 600; font-size: 0.9em; cursor: pointer; transition: all 0.2s;';
        manageFolderBtn.addEventListener('mouseenter', () => {
            manageFolderBtn.style.transform = 'scale(1.05)';
            manageFolderBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        });
        manageFolderBtn.addEventListener('mouseleave', () => {
            manageFolderBtn.style.transform = 'scale(1)';
            manageFolderBtn.style.boxShadow = 'none';
        });
        manageFolderBtn.addEventListener('click', () => {
            new FolderManagementModal(this.app, this.plugin).open();
        });

        const folders = this.plugin.settings.questionFolders || ['Í∏∞Î≥∏'];
        const quizzes = Object.values(this.plugin.settings.quizzes || {});
        const bookmarks = this.plugin.settings.bookmarks || [];
        
        // Ìè¥Îçî Í∑∏Î¶¨Îìú
        const folderGrid = section.createDiv();
        folderGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 16px;';

        // Î∂ÅÎßàÌÅ¨ Ïπ¥Îìú
        if (bookmarks.length > 0) {
            this.createFolderCard(folderGrid, '‚≠ê Î∂ÅÎßàÌÅ¨', bookmarks.length, 0, null, 'bookmark');
        }

        // Í∏∞Î≥∏ Ìè¥Îçî Ïö∞ÏÑ† Î∞∞Ïπò
        const sortedFolders = folders.filter(f => f === 'Í∏∞Î≥∏').concat(folders.filter(f => f !== 'Í∏∞Î≥∏'));

        // Ìè¥Îçî Ïπ¥ÎìúÎì§
        for (const folder of sortedFolders) {
            const folderQuizzes = quizzes.filter(q => (q.folder || 'Í∏∞Î≥∏') === folder);
            const folderStats = this.plugin.getFolderStats(folder);
            
            this.createFolderCard(folderGrid, folder, folderQuizzes.length, folderStats.attempts, folderStats, 'folder');
        }
    }

    createFolderCard(container, name, quizCount, attempts, stats, type) {
        const card = container.createDiv();
        card.style.cssText = `
            position: relative;
            padding: 20px;
            background: linear-gradient(135deg, var(--background-primary-alt) 0%, var(--background-primary) 100%);
            border: 2px solid var(--background-modifier-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
        `;

        // Î∞∞Í≤Ω Îç∞ÏΩîÎ†àÏù¥ÏÖò
        const deco = card.createDiv();
        deco.style.cssText = `
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            pointer-events: none;
        `;

        // Ìó§Îçî
        const header = card.createDiv();
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; position: relative; z-index: 1;';
        
        const titleContainer = header.createDiv();
        titleContainer.style.cssText = 'flex: 1; min-width: 0;';
        
        const title = titleContainer.createEl('h4', { text: type === 'bookmark' ? name : `üìÅ ${name}` });
        title.style.cssText = 'margin: 0 0 4px 0; font-size: 1.2em; font-weight: 700; color: var(--text-normal); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;';
        
        const subtitle = titleContainer.createEl('div', { text: `${quizCount}Í∞ú ÌÄ¥Ï¶à` });
        subtitle.style.cssText = 'font-size: 0.85em; color: var(--text-muted);';

        // ÌÜµÍ≥Ñ ÏòÅÏó≠
        if (stats && attempts > 0) {
            const accuracy = Math.round((stats.correct / stats.attempts) * 100);
            const statsContainer = card.createDiv();
            statsContainer.style.cssText = 'display: flex; gap: 12px; margin-bottom: 16px; padding: 12px; background: var(--background-secondary-alt); border-radius: 8px; position: relative; z-index: 1;';
            
            const createStat = (label, value, color) => {
                const stat = statsContainer.createDiv();
                stat.style.cssText = 'flex: 1; text-align: center;';
                
                const valueEl = stat.createEl('div', { text: value });
                valueEl.style.cssText = `font-size: 1.3em; font-weight: 700; color: ${color}; margin-bottom: 4px;`;
                
                const labelEl = stat.createEl('div', { text: label });
                labelEl.style.cssText = 'font-size: 0.75em; color: var(--text-muted); text-transform: uppercase;';
            };
            
            createStat('ÏãúÎèÑ', `${attempts}`, '#3b82f6');
            createStat('Ï†ïÎãµÎ•†', `${accuracy}%`, accuracy >= 80 ? '#10b981' : accuracy >= 60 ? '#f59e0b' : '#ef4444');
            createStat('ÏãúÍ∞Ñ', `${Math.round(stats.time / 60)}Î∂Ñ`, '#8b5cf6');
        } else {
            const emptyStats = card.createDiv();
            emptyStats.style.cssText = 'padding: 12px; text-align: center; background: var(--background-secondary-alt); border-radius: 8px; color: var(--text-muted); font-size: 0.9em; margin-bottom: 16px; position: relative; z-index: 1;';
            emptyStats.textContent = 'ÏïÑÏßÅ ÌïôÏäµ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§';
        }

        // Î≤ÑÌäº ÏòÅÏó≠
        const btnContainer = card.createDiv();
        btnContainer.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; position: relative; z-index: 1;';
        
        const createButton = (icon, tooltip, bgColor, onClick) => {
            const btn = btnContainer.createEl('button', { text: icon });
            btn.style.cssText = `
                padding: 12px;
                background: ${bgColor};
                color: white;
                border: none;
                border-radius: 6px;
                font-size: 1.1em;
                cursor: pointer;
                transition: all 0.2s;
                font-weight: 600;
            `;
            btn.title = tooltip;
            btn.addEventListener('mouseenter', () => {
                btn.style.transform = 'translateY(-2px)';
                btn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.transform = 'translateY(0)';
                btn.style.boxShadow = 'none';
            });
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                onClick();
            });
        };

        if (type === 'bookmark') {
            createButton('üéØ', 'ÌÄ¥Ï¶à ÏãúÏûë', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', () => {
                new QuizModal(this.app, this.plugin, null, '‚≠ê Î∂ÅÎßàÌÅ¨').open();
            });
            createButton('üìã', 'Î™©Î°ù', 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', () => {
                new BookmarkListModal(this.app, this.plugin).open();
            });
            createButton('üìä', 'ÌÜµÍ≥Ñ', 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', () => {
                new Notice('Î∂ÅÎßàÌÅ¨ ÌÜµÍ≥Ñ Í∏∞Îä• Ï§ÄÎπÑÏ§ë');
            });
        } else {
            createButton('‚ûï', 'ÏÉà ÌÄ¥Ï¶à', 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)', () => {
                new QuizCreatorModal(this.app, this.plugin).open();
            });
            createButton('üìã', 'Î™©Î°ù', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', () => {
                new QuizListModal(this.app, this.plugin, name).open();
            });
            createButton('üìä', 'ÌÜµÍ≥Ñ', 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', () => {
                new FolderQuizModal(this.app, this.plugin, name).open();
            });
        }

        // Ìò∏Î≤Ñ Ìö®Í≥º
        card.addEventListener('mouseenter', () => {
            card.style.transform = 'translateY(-8px) scale(1.02)';
            card.style.boxShadow = '0 12px 24px rgba(0,0,0,0.15)';
            card.style.borderColor = 'var(--interactive-accent)';
        });
        card.addEventListener('mouseleave', () => {
            card.style.transform = 'translateY(0) scale(1)';
            card.style.boxShadow = 'none';
            card.style.borderColor = 'var(--background-modifier-border)';
        });

        // Ïπ¥Îìú ÌÅ¥Î¶≠ÏúºÎ°ú ÏÉÅÏÑ∏ Î™®Îã¨ Ïó¥Í∏∞
        card.addEventListener('click', () => {
            if (type === 'bookmark') {
                new BookmarkListModal(this.app, this.plugin).open();
            } else {
                new FolderQuizModal(this.app, this.plugin, name).open();
            }
        });
    }

    renderRecentQuizzes(container) {
        const section = container.createDiv();
        section.style.cssText = 'margin-bottom: 24px;';
        
        const header = section.createDiv();
        header.style.cssText = 'margin-bottom: 14px; padding-bottom: 10px; border-bottom: 2px solid var(--background-modifier-border);';
        const titleEl = header.createEl('h3', { text: 'üìù ÏµúÍ∑º ÌÄ¥Ï¶à' });
        titleEl.style.cssText = 'margin: 0; font-size: 1.3em; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;';

        const quizzes = Object.entries(this.plugin.settings.quizzes || {});

        if (quizzes.length === 0) {
            section.createEl('p', { 
                text: 'Ï†ÄÏû•Îêú ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§. ÏÉà ÌÄ¥Ï¶àÎ•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!',
                cls: 'lp-empty-message'
            }).style.cssText = 'color: var(--text-muted); font-style: italic; text-align: center; padding: 20px;';
            return;
        }

        // ÏµúÏã†Ïàú Ï†ïÎ†¨
        quizzes.sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0));

        const quizList = section.createDiv();
        quizList.style.cssText = 'display: grid; gap: 8px;';

        quizzes.slice(0, 5).forEach(([quizId, quiz]) => {
            const quizItem = quizList.createDiv();
            quizItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; background: var(--background-primary-alt); border: 1px solid var(--background-modifier-border); border-radius: 10px; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;';

            quizItem.addEventListener('mouseenter', () => {
                quizItem.style.background = 'var(--background-secondary)';
                quizItem.style.transform = 'translateX(6px)';
                quizItem.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            });
            quizItem.addEventListener('mouseleave', () => {
                quizItem.style.background = 'var(--background-primary-alt)';
                quizItem.style.transform = 'translateX(0)';
                quizItem.style.boxShadow = 'none';
            });

            const quizInfo = quizItem.createDiv();
            quizInfo.style.cssText = 'flex: 1;';
            
            const titleRow = quizInfo.createDiv();
            titleRow.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 4px;';
            titleRow.createEl('span', { text: quiz.subject || 'Ï†úÎ™© ÏóÜÏùå' }).style.cssText = 'font-weight: 600;';
            
            if (quiz.folder) {
                titleRow.createEl('span', { text: quiz.folder }).style.cssText = 'font-size: 0.8em; padding: 2px 8px; background: var(--interactive-accent); color: white; border-radius: 10px;';
            }

            const meta = quizInfo.createDiv();
            meta.style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
            meta.textContent = `${quiz.questions?.length || 0}Í∞ú Î¨∏Ï†ú`;

            const actions = quizItem.createDiv();
            actions.style.cssText = 'display: flex; gap: 8px;';

            const startBtn = actions.createEl('button', { text: '‚ñ∂ ÏãúÏûë' });
            startBtn.style.cssText = 'padding: 8px 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95em; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);';
            startBtn.addEventListener('mouseenter', () => {
                startBtn.style.transform = 'translateY(-2px)';
                startBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
            });
            startBtn.addEventListener('mouseleave', () => {
                startBtn.style.transform = 'translateY(0)';
                startBtn.style.boxShadow = '0 2px 8px rgba(102, 126, 234, 0.3)';
            });
            startBtn.onclick = () => {
                new QuizModal(this.app, this.plugin, quizId).open();
            };

            const editBtn = actions.createEl('button', { text: '‚úèÔ∏è' });
            editBtn.style.cssText = 'padding: 6px 10px; background: var(--background-modifier-border); border: none; border-radius: 4px; cursor: pointer;';
            editBtn.onclick = () => {
                new QuizListEditModal(this.app, this.plugin, quizId).open();
            };
        });
    }

    renderFolderGrid(container) {
        const folderSection = container.createDiv({ cls: 'lp-folder-section' });
        
        const headerDiv = folderSection.createDiv();
        headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
        
        headerDiv.createEl('h3', { text: 'üìÅ Ìè¥ÎçîÎ≥Ñ ÌÄ¥Ï¶à' });

        const folderGrid = folderSection.createDiv({ cls: 'lp-folder-grid' });

        // Î∂ÅÎßàÌÅ¨ Ìè¥Îçî (ÌäπÎ≥Ñ ÌëúÏãú)
        const bookmarkFolder = folderGrid.createDiv({ cls: 'lp-folder-card lp-folder-bookmark' });
        const bookmarkCount = this.plugin.settings.bookmarks.length;
        
        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Í∞úÏÑ† (Î™®Î∞îÏùº)
        let bookmarkTouchStartY = 0;
        bookmarkFolder.addEventListener('touchstart', (e) => {
            bookmarkTouchStartY = e.touches[0].clientY;
        });
        bookmarkFolder.addEventListener('touchend', (e) => {
            const touchEndY = e.changedTouches[0].clientY;
            const delta = Math.abs(touchEndY - bookmarkTouchStartY);
            if (delta < 10) {
                // Ïä§ÌÅ¨Î°§Ïù¥ ÏïÑÎãå ÌÉ≠ÏúºÎ°ú Í∞ÑÏ£º
                e.preventDefault();
            }
        });
        
        const bookmarkHeader = bookmarkFolder.createDiv();
        bookmarkHeader.style.cssText = 'margin-bottom: 12px;';
        bookmarkHeader.innerHTML = `
            <div class="lp-folder-icon">‚≠ê</div>
            <div class="lp-folder-name">Î∂ÅÎßàÌÅ¨</div>
            <div class="lp-folder-count">${bookmarkCount}Í∞ú</div>
        `;

        // Î∂ÅÎßàÌÅ¨ Ïï°ÏÖò Î≤ÑÌäº
        const bookmarkActions = bookmarkFolder.createDiv();
        bookmarkActions.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';
        
        const bookmarkQuizBtn = bookmarkActions.createEl('button', { text: 'üéØ ÌÄ¥Ï¶à' });
        bookmarkQuizBtn.style.cssText = 'padding: 8px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer;';
        bookmarkQuizBtn.onclick = () => {
            if (bookmarkCount === 0) {
                new Notice('Î∂ÅÎßàÌÅ¨Îêú Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§');
                return;
            }
            new QuizModal(this.app, this.plugin, null, '‚≠ê Î∂ÅÎßàÌÅ¨').open();
        };

        const bookmarkListBtn = bookmarkActions.createEl('button', { text: 'üìã Î™©Î°ù' });
        bookmarkListBtn.style.cssText = 'padding: 8px; background: var(--background-modifier-border); border: none; border-radius: 4px; cursor: pointer;';
        bookmarkListBtn.onclick = () => {
            new BookmarkListModal(this.app, this.plugin).open();
        };

        // ÏùºÎ∞ò Ìè¥ÎçîÎì§
        const folders = this.plugin.settings.questionFolders || ['Í∏∞Î≥∏'];
        const quizzes = Object.values(this.plugin.settings.quizzes || {});
        
        folders.forEach(folder => {
            const folderQuizzes = quizzes.filter(q => q.folder === folder);
            let questionCount = 0;
            folderQuizzes.forEach(q => questionCount += q.questions?.length || 0);

            const folderCard = folderGrid.createDiv({ cls: 'lp-folder-card' });
            
            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Í∞úÏÑ† (Î™®Î∞îÏùº)
            let touchStartY = 0;
            folderCard.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
            });
            folderCard.addEventListener('touchend', (e) => {
                const touchEndY = e.changedTouches[0].clientY;
                const delta = Math.abs(touchEndY - touchStartY);
                if (delta < 10) {
                    // Ïä§ÌÅ¨Î°§Ïù¥ ÏïÑÎãå ÌÉ≠ÏúºÎ°ú Í∞ÑÏ£º
                    e.preventDefault();
                }
            });
            
            // Ìè¥Îçî Ìó§Îçî
            const folderHeader = folderCard.createDiv();
            folderHeader.style.cssText = 'margin-bottom: 12px;';
            folderHeader.innerHTML = `
                <div class="lp-folder-icon">üìÇ</div>
                <div class="lp-folder-name">${folder}</div>
                <div class="lp-folder-count">${questionCount}Í∞ú</div>
                <div class="lp-folder-quizzes">${folderQuizzes.length}Í∞ú ÌÄ¥Ï¶à</div>
            `;

            // Ìè¥Îçî ÌÜµÍ≥Ñ
            const folderStats = this.plugin.settings.stats.folderStats?.[folder] || { attempts: 0, correct: 0, time: 0 };
            if (folderStats.attempts > 0) {
                const accuracy = Math.round((folderStats.correct / folderStats.attempts) * 100);
                const statsDiv = folderCard.createDiv();
                statsDiv.style.cssText = 'display: flex; justify-content: space-around; padding: 8px; background: var(--background-secondary); border-radius: 4px; margin-bottom: 12px; font-size: 0.85em;';
                
                statsDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: ${accuracy >= 70 ? '#10b981' : '#ef4444'};">${accuracy}%</div>
                        <div style="color: var(--text-muted); font-size: 0.9em;">Ï†ïÎãµÎ•†</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: var(--interactive-accent);">${folderStats.attempts}</div>
                        <div style="color: var(--text-muted); font-size: 0.9em;">ÏãúÎèÑ</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: var(--text-muted);">${Math.round(folderStats.time / 60)}Î∂Ñ</div>
                        <div style="color: var(--text-muted); font-size: 0.9em;">ÏãúÍ∞Ñ</div>
                    </div>
                `;
            }

            // Ìè¥Îçî Ïï°ÏÖò Î≤ÑÌäº (3Í∞ú: ÌÄ¥Ï¶à, Î™©Î°ù, Í∏∞Î°ù)
            const folderActions = folderCard.createDiv();
            folderActions.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;';
            
            const quizBtn = folderActions.createEl('button', { text: 'üéØ ÌÄ¥Ï¶à' });
            quizBtn.style.cssText = 'padding: 8px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;';
            quizBtn.onclick = () => {
                if (folderQuizzes.length === 0) {
                    new Notice(`"${folder}" Ìè¥ÎçîÏóê ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§`);
                    return;
                }
                new FolderQuizSelectModal(this.app, this.plugin, folder).open();
            };

            const listBtn = folderActions.createEl('button', { text: 'üìã Î™©Î°ù' });
            listBtn.style.cssText = 'padding: 8px; background: var(--background-modifier-border); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;';
            listBtn.onclick = () => {
                if (folderQuizzes.length === 0) {
                    new Notice(`"${folder}" Ìè¥ÎçîÏóê ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§`);
                    return;
                }
                const quizFiles = folderQuizzes.map(q => ({
                    basename: q.subject || 'Ï†úÎ™© ÏóÜÏùå',
                    path: q.id,
                    stat: { mtime: q.createdAt || Date.now() },
                    quiz: q
                }));
                new RecentFilesModal(this.app, this.plugin, quizFiles).open();
            };

            const recordBtn = folderActions.createEl('button', { text: 'üìä Í∏∞Î°ù' });
            recordBtn.style.cssText = 'padding: 8px; background: var(--background-secondary); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;';
            recordBtn.onclick = () => {
                new FolderDetailModal(this.app, this.plugin, folder).open();
            };
        });
    }

    async renderRoutineDailyView(container) {
        const dateKey = this.getDateKey(this.currentDate);
        let dayData = this.plugin.settings.dailyChecklists?.[dateKey];
        
        if (!dayData) {
            dayData = { items: [], notes: [] };
            if (!this.plugin.settings.dailyChecklists) {
                this.plugin.settings.dailyChecklists = {};
            }
            this.plugin.settings.dailyChecklists[dateKey] = dayData;
        }
        
        const section = container.createDiv();
        section.style.cssText = 'margin-bottom: 20px;';
        
        // ÎÇ†Ïßú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        const dateNav = section.createDiv();
        dateNav.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; padding: 16px; background: linear-gradient(135deg, var(--background-primary-alt) 0%, var(--background-secondary) 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);';
        
        const prevBtn = dateNav.createEl('button', { text: '‚óÄ' });
        prevBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);';
        prevBtn.addEventListener('mouseenter', () => {
            prevBtn.style.transform = 'translateX(-3px)';
            prevBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
        });
        prevBtn.addEventListener('mouseleave', () => {
            prevBtn.style.transform = 'translateX(0)';
            prevBtn.style.boxShadow = '0 2px 6px rgba(102, 126, 234, 0.3)';
        });
        prevBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() - 1);
            this.onOpen();
        };
        
        dateNav.createEl('h3', { text: this.formatDateKorean(this.currentDate) });
        
        const nextBtn = dateNav.createEl('button', { text: '‚ñ∂' });
        nextBtn.style.cssText = 'padding: 6px 12px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer;';
        nextBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() + 1);
            this.onOpen();
        };
        
        // Î£®Ìã¥ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
        const routineSection = section.createDiv();
        routineSection.style.cssText = 'margin-bottom: 20px; padding: 18px; background: linear-gradient(135deg, var(--background-primary-alt) 0%, var(--background-secondary) 100%); border-radius: 12px; border: 1px solid var(--background-modifier-border); box-shadow: 0 2px 8px rgba(0,0,0,0.06);';
        const routineTitle = routineSection.createEl('h4', { text: '‚úÖ Ïò§ÎäòÏùò Î£®Ìã¥' });
        routineTitle.style.cssText = 'margin: 0 0 12px 0; font-size: 1.15em; font-weight: 700;';
        
        if (dayData.items && dayData.items.length > 0) {
            dayData.items.forEach((item, index) => {
                const itemDiv = routineSection.createDiv();
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 10px; padding: 8px; margin: 8px 0; background: var(--background-secondary); border-radius: 4px;';
                
                const checkbox = itemDiv.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed;
                checkbox.onchange = async () => {
                    item.completed = checkbox.checked;
                    await this.plugin.saveSettings();
                    this.onOpen();
                };
                
                const text = itemDiv.createEl('span', { text: item.text });
                text.style.cssText = item.completed ? 'text-decoration: line-through; color: var(--text-muted);' : '';
                
                const deleteBtn = itemDiv.createEl('button', { text: '√ó' });
                deleteBtn.style.cssText = 'margin-left: auto; padding: 4px 8px; background: var(--background-modifier-error); color: white; border: none; border-radius: 3px; cursor: pointer;';
                deleteBtn.onclick = async () => {
                    dayData.items.splice(index, 1);
                    await this.plugin.saveSettings();
                    this.onOpen();
                };
            });
        }
        
        const addBtn = routineSection.createEl('button', { text: '+ Î£®Ìã¥ Ï∂îÍ∞Ä' });
        addBtn.style.cssText = 'width: 100%; padding: 8px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px;';
        addBtn.onclick = () => {
            new RoutineAddModal(this.app, async (text) => {
                if (!dayData.items) dayData.items = [];
                dayData.items.push({ text, completed: false });
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
        
        // Î©îÎ™® ÏÑπÏÖò
        const noteSection = section.createDiv();
        noteSection.style.cssText = 'padding: 16px; background: var(--background-primary-alt); border-radius: 8px;';
        noteSection.createEl('h4', { text: 'üí¨ Î©îÎ™®' });
        
        if (dayData.notes && dayData.notes.length > 0) {
            dayData.notes.forEach((note, index) => {
                const noteDiv = noteSection.createDiv();
                noteDiv.style.cssText = 'padding: 8px; margin: 8px 0; background: var(--background-secondary); border-radius: 4px; cursor: pointer;';
                noteDiv.textContent = note;
                noteDiv.onclick = () => {
                    new NoteEditModal(this.app, note, (newText) => {
                        dayData.notes[index] = newText;
                        this.plugin.saveSettings();
                        this.onOpen();
                    }, () => {
                        dayData.notes.splice(index, 1);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }).open();
                };
            });
        }
        
        const addNoteBtn = noteSection.createEl('button', { text: '+ Î©îÎ™® Ï∂îÍ∞Ä' });
        addNoteBtn.style.cssText = 'width: 100%; padding: 8px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px;';
        addNoteBtn.onclick = () => {
            new NoteAddModal(this.app, async (text) => {
                if (!dayData.notes) dayData.notes = [];
                dayData.notes.push(text);
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
    }

    async renderRoutineWeeklyView(container) {
        const weekKey = this.getWeekKey(new Date());
        let weekData = this.plugin.settings.weeklyChecklists?.[weekKey];
        
        if (!weekData) {
            weekData = { items: [], notes: [] };
            if (!this.plugin.settings.weeklyChecklists) {
                this.plugin.settings.weeklyChecklists = {};
            }
            this.plugin.settings.weeklyChecklists[weekKey] = weekData;
        }
        
        const section = container.createDiv();
        section.style.cssText = 'max-width: 900px; margin: 0 auto;';
        
        // Ï£ºÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        const weekNav = section.createDiv();
        weekNav.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(99, 102, 241, 0.1) 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);';
        
        const prevBtn = weekNav.createEl('button', { text: '‚óÄ Ïù¥Ï†Ñ Ï£º' });
        prevBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);';
        prevBtn.addEventListener('mouseenter', () => {
            prevBtn.style.transform = 'translateX(-3px)';
            prevBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
        });
        prevBtn.addEventListener('mouseleave', () => {
            prevBtn.style.transform = 'translateX(0)';
            prevBtn.style.boxShadow = '0 2px 6px rgba(102, 126, 234, 0.3)';
        });
        prevBtn.onclick = () => {
            const currentDate = new Date();
            currentDate.setDate(currentDate.getDate() - 7);
            this.getWeekKey(currentDate);
            this.onOpen();
        };
        
        const weekTitle = weekNav.createDiv();
        weekTitle.style.cssText = 'font-size: 1.3em; font-weight: 700; color: #3b82f6;';
        weekTitle.textContent = `üìÖ ${weekKey} Ï£ºÍ∞Ñ Î™©Ìëú`;
        
        const nextBtn = weekNav.createEl('button', { text: 'Îã§Ïùå Ï£º ‚ñ∂' });
        nextBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);';
        nextBtn.addEventListener('mouseenter', () => {
            nextBtn.style.transform = 'translateX(3px)';
            nextBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
        });
        nextBtn.addEventListener('mouseleave', () => {
            nextBtn.style.transform = 'translateX(0)';
            nextBtn.style.boxShadow = '0 2px 6px rgba(102, 126, 234, 0.3)';
        });
        nextBtn.onclick = () => {
            const currentDate = new Date();
            currentDate.setDate(currentDate.getDate() + 7);
            this.getWeekKey(currentDate);
            this.onOpen();
        };
        
        // ÏßÑÌñâÎ•† ÌëúÏãú
        if (weekData.items && weekData.items.length > 0) {
            const completed = weekData.items.filter(item => item.completed).length;
            const total = weekData.items.length;
            const percent = Math.round((completed / total) * 100);
            
            const progressSection = section.createDiv();
            progressSection.style.cssText = 'margin-bottom: 20px; padding: 16px; background: var(--background-primary-alt); border-radius: 10px; border: 1px solid var(--background-modifier-border);';
            
            const progressText = progressSection.createDiv();
            progressText.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;';
            progressText.innerHTML = `
                <span style="font-weight: 600; color: var(--text-normal);">‚úÖ ÏßÑÌñâÎ•†</span>
                <span style="font-weight: 700; color: #3b82f6; font-size: 1.2em;">${completed}/${total} (${percent}%)</span>
            `;
            
            const progressBar = progressSection.createDiv();
            progressBar.style.cssText = 'background: var(--background-modifier-border); height: 10px; border-radius: 5px; overflow: hidden;';
            const progressFill = progressBar.createDiv();
            progressFill.style.cssText = `background: linear-gradient(90deg, #3b82f6 0%, #6366f1 100%); width: ${percent}%; height: 100%; transition: width 0.3s;`;
        }
        
        // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÑ≠ÏÖò
        const checklistSection = section.createDiv();
        checklistSection.style.cssText = 'margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, var(--background-primary-alt) 0%, var(--background-secondary) 100%); border-radius: 12px; border: 1px solid var(--background-modifier-border); box-shadow: 0 2px 8px rgba(0,0,0,0.06);';
        
        const checklistTitle = checklistSection.createEl('h4', { text: 'üéØ Ï£ºÍ∞Ñ Ìï≠Î™©' });
        checklistTitle.style.cssText = 'margin: 0 0 16px 0; font-size: 1.15em; font-weight: 700; color: #3b82f6;';
        
        if (weekData.items && weekData.items.length > 0) {
            weekData.items.forEach((item, index) => {
                const itemDiv = checklistSection.createDiv();
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; margin: 10px 0; background: var(--background-primary); border-radius: 8px; border: 1px solid var(--background-modifier-border); transition: all 0.2s;';
                itemDiv.addEventListener('mouseenter', () => {
                    itemDiv.style.transform = 'translateX(4px)';
                    itemDiv.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.2)';
                });
                itemDiv.addEventListener('mouseleave', () => {
                    itemDiv.style.transform = 'translateX(0)';
                    itemDiv.style.boxShadow = 'none';
                });
                
                const checkbox = itemDiv.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed;
                checkbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';
                checkbox.onchange = async () => {
                    item.completed = checkbox.checked;
                    await this.plugin.saveSettings();
                    this.onOpen();
                };
                
                const text = itemDiv.createEl('span', { text: item.text });
                text.style.cssText = item.completed 
                    ? 'flex: 1; text-decoration: line-through; color: var(--text-muted); font-size: 1em;' 
                    : 'flex: 1; color: var(--text-normal); font-weight: 500; font-size: 1em;';
                
                const deleteBtn = itemDiv.createEl('button', { text: 'üóëÔ∏è' });
                deleteBtn.style.cssText = 'padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; transition: all 0.2s;';
                deleteBtn.addEventListener('mouseenter', () => {
                    deleteBtn.style.background = '#dc2626';
                    deleteBtn.style.transform = 'scale(1.1)';
                });
                deleteBtn.addEventListener('mouseleave', () => {
                    deleteBtn.style.background = '#ef4444';
                    deleteBtn.style.transform = 'scale(1)';
                });
                deleteBtn.onclick = async () => {
                    if (confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        weekData.items.splice(index, 1);
                        await this.plugin.saveSettings();
                        this.onOpen();
                    }
                };
            });
        } else {
            checklistSection.createDiv({ text: 'Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§. ÏïÑÎûò Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.' }).style.cssText = 'color: var(--text-muted); font-style: italic; text-align: center; padding: 20px;';
        }
        
        const addBtn = checklistSection.createEl('button', { text: '+ Ìï≠Î™© Ï∂îÍ∞Ä' });
        addBtn.style.cssText = 'width: 100%; padding: 12px; background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 12px; transition: all 0.3s; box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);';
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.transform = 'translateY(-2px)';
            addBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.transform = 'translateY(0)';
            addBtn.style.boxShadow = '0 2px 6px rgba(59, 130, 246, 0.3)';
        });
        addBtn.onclick = () => {
            new TestItemAddModal(this.app, async (text) => {
                if (!weekData.items) weekData.items = [];
                weekData.items.push({ text, completed: false });
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
        
        // Î©îÎ™® ÏÑ≠ÏÖò
        const noteSection = section.createDiv();
        noteSection.style.cssText = 'padding: 20px; background: var(--background-primary-alt); border-radius: 10px; border: 1px solid var(--background-modifier-border);';
        
        const noteTitle = noteSection.createEl('h4', { text: 'üí¨ Î©îÎ™®' });
        noteTitle.style.cssText = 'margin: 0 0 14px 0; font-size: 1.1em; font-weight: 700;';
        
        if (weekData.notes && weekData.notes.length > 0) {
            weekData.notes.forEach((note, index) => {
                const noteDiv = noteSection.createDiv();
                noteDiv.style.cssText = 'padding: 12px; margin: 8px 0; background: var(--background-secondary); border-radius: 8px; cursor: pointer; border-left: 3px solid #3b82f6; transition: all 0.2s;';
                noteDiv.textContent = note;
                noteDiv.addEventListener('mouseenter', () => {
                    noteDiv.style.transform = 'translateX(4px)';
                    noteDiv.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.2)';
                });
                noteDiv.addEventListener('mouseleave', () => {
                    noteDiv.style.transform = 'translateX(0)';
                    noteDiv.style.boxShadow = 'none';
                });
                noteDiv.onclick = () => {
                    new TestNoteEditModal(this.app, note, (newText) => {
                        weekData.notes[index] = newText;
                        this.plugin.saveSettings();
                        this.onOpen();
                    }, () => {
                        weekData.notes.splice(index, 1);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }).open();
                };
            });
        }
        
        const addNoteBtn = noteSection.createEl('button', { text: '+ Î©îÎ™® Ï∂îÍ∞Ä' });
        addNoteBtn.style.cssText = 'width: 100%; padding: 10px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px; transition: all 0.2s;';
        addNoteBtn.addEventListener('mouseenter', () => {
            addNoteBtn.style.transform = 'translateY(-2px)';
        });
        addNoteBtn.addEventListener('mouseleave', () => {
            addNoteBtn.style.transform = 'translateY(0)';
        });
        addNoteBtn.onclick = () => {
            new TestNoteAddModal(this.app, async (text) => {
                if (!weekData.notes) weekData.notes = [];
                weekData.notes.push(text);
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
    }

    async renderRoutineMonthlyView(container) {
        const currentDate = new Date();
        const monthKey = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
        let monthData = this.plugin.settings.monthlyChecklists?.[monthKey];
        
        if (!monthData) {
            monthData = { items: [], notes: [] };
            if (!this.plugin.settings.monthlyChecklists) {
                this.plugin.settings.monthlyChecklists = {};
            }
            this.plugin.settings.monthlyChecklists[monthKey] = monthData;
        }
        
        const section = container.createDiv();
        section.style.cssText = 'max-width: 900px; margin: 0 auto;';
        
        // ÏõîÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        const monthNav = section.createDiv();
        monthNav.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);';
        
        const prevBtn = monthNav.createEl('button', { text: '‚óÄ Ïù¥Ï†Ñ Îã¨' });
        prevBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);';
        prevBtn.addEventListener('mouseenter', () => {
            prevBtn.style.transform = 'translateX(-3px)';
            prevBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
        });
        prevBtn.addEventListener('mouseleave', () => {
            prevBtn.style.transform = 'translateX(0)';
            prevBtn.style.boxShadow = '0 2px 6px rgba(16, 185, 129, 0.3)';
        });
        prevBtn.onclick = () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            this.onOpen();
        };
        
        const monthTitle = monthNav.createDiv();
        monthTitle.style.cssText = 'font-size: 1.3em; font-weight: 700; color: #10b981;';
        monthTitle.textContent = `üìä ${currentDate.getFullYear()}ÎÖÑ ${currentDate.getMonth() + 1}Ïõî Î™©Ìëú`;
        
        const nextBtn = monthNav.createEl('button', { text: 'Îã§Ïùå Îã¨ ‚ñ∂' });
        nextBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);';
        nextBtn.addEventListener('mouseenter', () => {
            nextBtn.style.transform = 'translateX(3px)';
            nextBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
        });
        nextBtn.addEventListener('mouseleave', () => {
            nextBtn.style.transform = 'translateX(0)';
            nextBtn.style.boxShadow = '0 2px 6px rgba(16, 185, 129, 0.3)';
        });
        nextBtn.onclick = () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            this.onOpen();
        };
        
        // ÏßÑÌñâÎ•† ÌëúÏãú
        if (monthData.items && monthData.items.length > 0) {
            const completed = monthData.items.filter(item => item.completed).length;
            const total = monthData.items.length;
            const percent = Math.round((completed / total) * 100);
            
            const progressSection = section.createDiv();
            progressSection.style.cssText = 'margin-bottom: 20px; padding: 16px; background: var(--background-primary-alt); border-radius: 10px; border: 1px solid var(--background-modifier-border);';
            
            const progressText = progressSection.createDiv();
            progressText.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;';
            progressText.innerHTML = `
                <span style="font-weight: 600; color: var(--text-normal);">‚úÖ ÏßÑÌñâÎ•†</span>
                <span style="font-weight: 700; color: #10b981; font-size: 1.2em;">${completed}/${total} (${percent}%)</span>
            `;
            
            const progressBar = progressSection.createDiv();
            progressBar.style.cssText = 'background: var(--background-modifier-border); height: 10px; border-radius: 5px; overflow: hidden;';
            const progressFill = progressBar.createDiv();
            progressFill.style.cssText = `background: linear-gradient(90deg, #10b981 0%, #059669 100%); width: ${percent}%; height: 100%; transition: width 0.3s;`;
        }
        
        // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÑ≠ÏÖò
        const checklistSection = section.createDiv();
        checklistSection.style.cssText = 'margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, var(--background-primary-alt) 0%, var(--background-secondary) 100%); border-radius: 12px; border: 1px solid var(--background-modifier-border); box-shadow: 0 2px 8px rgba(0,0,0,0.06);';
        
        const checklistTitle = checklistSection.createEl('h4', { text: 'üìä ÏõîÍ∞Ñ Ìï≠Î™©' });
        checklistTitle.style.cssText = 'margin: 0 0 16px 0; font-size: 1.15em; font-weight: 700; color: #10b981;';
        
        if (monthData.items && monthData.items.length > 0) {
            monthData.items.forEach((item, index) => {
                const itemDiv = checklistSection.createDiv();
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; margin: 10px 0; background: var(--background-primary); border-radius: 8px; border: 1px solid var(--background-modifier-border); transition: all 0.2s;';
                itemDiv.addEventListener('mouseenter', () => {
                    itemDiv.style.transform = 'translateX(4px)';
                    itemDiv.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.2)';
                });
                itemDiv.addEventListener('mouseleave', () => {
                    itemDiv.style.transform = 'translateX(0)';
                    itemDiv.style.boxShadow = 'none';
                });
                
                const checkbox = itemDiv.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed;
                checkbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';
                checkbox.onchange = async () => {
                    item.completed = checkbox.checked;
                    await this.plugin.saveSettings();
                    this.onOpen();
                };
                
                const text = itemDiv.createEl('span', { text: item.text });
                text.style.cssText = item.completed 
                    ? 'flex: 1; text-decoration: line-through; color: var(--text-muted); font-size: 1em;' 
                    : 'flex: 1; color: var(--text-normal); font-weight: 500; font-size: 1em;';
                
                const deleteBtn = itemDiv.createEl('button', { text: 'üóëÔ∏è' });
                deleteBtn.style.cssText = 'padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em; transition: all 0.2s;';
                deleteBtn.addEventListener('mouseenter', () => {
                    deleteBtn.style.background = '#dc2626';
                    deleteBtn.style.transform = 'scale(1.1)';
                });
                deleteBtn.addEventListener('mouseleave', () => {
                    deleteBtn.style.background = '#ef4444';
                    deleteBtn.style.transform = 'scale(1)';
                });
                deleteBtn.onclick = async () => {
                    if (confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        monthData.items.splice(index, 1);
                        await this.plugin.saveSettings();
                        this.onOpen();
                    }
                };
            });
        } else {
            checklistSection.createDiv({ text: 'Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§. ÏïÑÎûò Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.' }).style.cssText = 'color: var(--text-muted); font-style: italic; text-align: center; padding: 20px;';
        }
        
        const addBtn = checklistSection.createEl('button', { text: '+ Ìï≠Î™© Ï∂îÍ∞Ä' });
        addBtn.style.cssText = 'width: 100%; padding: 12px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 12px; transition: all 0.3s; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);';
        addBtn.addEventListener('mouseenter', () => {
            addBtn.style.transform = 'translateY(-2px)';
            addBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
        });
        addBtn.addEventListener('mouseleave', () => {
            addBtn.style.transform = 'translateY(0)';
            addBtn.style.boxShadow = '0 2px 6px rgba(16, 185, 129, 0.3)';
        });
        addBtn.onclick = () => {
            new TestItemAddModal(this.app, async (text) => {
                if (!monthData.items) monthData.items = [];
                monthData.items.push({ text, completed: false });
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
        
        // Î©îÎ™® ÏÑ≠ÏÖò
        const noteSection = section.createDiv();
        noteSection.style.cssText = 'padding: 20px; background: var(--background-primary-alt); border-radius: 10px; border: 1px solid var(--background-modifier-border);';
        
        const noteTitle = noteSection.createEl('h4', { text: 'üí¨ Î©îÎ™®' });
        noteTitle.style.cssText = 'margin: 0 0 14px 0; font-size: 1.1em; font-weight: 700;';
        
        if (monthData.notes && monthData.notes.length > 0) {
            monthData.notes.forEach((note, index) => {
                const noteDiv = noteSection.createDiv();
                noteDiv.style.cssText = 'padding: 12px; margin: 8px 0; background: var(--background-secondary); border-radius: 8px; cursor: pointer; border-left: 3px solid #10b981; transition: all 0.2s;';
                noteDiv.textContent = note;
                noteDiv.addEventListener('mouseenter', () => {
                    noteDiv.style.transform = 'translateX(4px)';
                    noteDiv.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.2)';
                });
                noteDiv.addEventListener('mouseleave', () => {
                    noteDiv.style.transform = 'translateX(0)';
                    noteDiv.style.boxShadow = 'none';
                });
                noteDiv.onclick = () => {
                    new TestNoteEditModal(this.app, note, (newText) => {
                        monthData.notes[index] = newText;
                        this.plugin.saveSettings();
                        this.onOpen();
                    }, () => {
                        monthData.notes.splice(index, 1);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }).open();
                };
            });
        }
        
        const addNoteBtn = noteSection.createEl('button', { text: '+ Î©îÎ™® Ï∂îÍ∞Ä' });
        addNoteBtn.style.cssText = 'width: 100%; padding: 10px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 10px; transition: all 0.2s;';
        addNoteBtn.addEventListener('mouseenter', () => {
            addNoteBtn.style.transform = 'translateY(-2px)';
        });
        addNoteBtn.addEventListener('mouseleave', () => {
            addNoteBtn.style.transform = 'translateY(0)';
        });
        addNoteBtn.onclick = () => {
            new TestNoteAddModal(this.app, async (text) => {
                if (!monthData.notes) monthData.notes = [];
                monthData.notes.push(text);
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
    }

    formatDateKorean(date) {
        const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
        return `${date.getFullYear()}ÎÖÑ ${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº (${days[date.getDay()]})`;
    }
    
    getDateKey(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    addStyles() {
        if (document.getElementById('lp-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-styles';

        const quizzes = Object.entries(this.plugin.settings.quizzes || {});

        if (quizzes.length === 0) {
            quizSection.createDiv({ 
                cls: 'lp-empty-message',
                text: 'Ï†ÄÏû•Îêú ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§. ÏÉà ÌÄ¥Ï¶àÎ•º ÎßåÎì§Ïñ¥Î≥¥ÏÑ∏Ïöî!'
            });
            return;
        }

        // ÏµúÏã†Ïàú Ï†ïÎ†¨
        quizzes.sort((a, b) => (b[1].createdAt || 0) - (a[1].createdAt || 0));

        const quizList = quizSection.createDiv({ cls: 'lp-quiz-list' });

        quizzes.slice(0, 5).forEach(([quizId, quiz]) => {
            const quizItem = quizList.createDiv({ cls: 'lp-quiz-item' });

            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Í∞úÏÑ† (Î™®Î∞îÏùº)
            let quizTouchStartY = 0;
            quizItem.addEventListener('touchstart', (e) => {
                quizTouchStartY = e.touches[0].clientY;
            });
            quizItem.addEventListener('touchend', (e) => {
                const touchEndY = e.changedTouches[0].clientY;
                const delta = Math.abs(touchEndY - quizTouchStartY);
                if (delta < 10) {
                    // Ïä§ÌÅ¨Î°§Ïù¥ ÏïÑÎãå ÌÉ≠ÏúºÎ°ú Í∞ÑÏ£º
                    e.preventDefault();
                }
            });

            const quizInfo = quizItem.createDiv({ cls: 'lp-quiz-info' });
            
            const titleRow = quizInfo.createDiv({ cls: 'lp-quiz-title-row' });
            titleRow.createEl('h4', { text: quiz.subject || 'Ï†úÎ™© ÏóÜÏùå' });
            
            if (quiz.folder) {
                titleRow.createEl('span', { 
                    text: quiz.folder, 
                    cls: 'lp-quiz-folder-tag' 
                });
            }
            
            if (quiz.difficulty) {
                const difficultyTag = titleRow.createEl('span', { 
                    text: quiz.difficulty,
                    cls: 'lp-quiz-difficulty-tag'
                });
                difficultyTag.setAttribute('data-difficulty', quiz.difficulty);
            }

            const meta = quizInfo.createDiv({ cls: 'lp-quiz-meta' });
            meta.createEl('span', { text: `${quiz.questions?.length || 0}Í∞ú Î¨∏Ï†ú` });
            
            if (quiz.createdAt) {
                const date = new Date(quiz.createdAt);
                meta.createEl('span', { text: '‚Ä¢' });
                meta.createEl('span', { text: date.toLocaleDateString('ko-KR') });
            }

            const actions = quizItem.createDiv({ cls: 'lp-quiz-actions' });

            const startBtn = actions.createEl('button', {
                text: '‚ñ∂ ÏãúÏûë',
                cls: 'lp-btn-start'
            });
            startBtn.onclick = () => {
                new QuizModal(this.app, this.plugin, quizId).open();
            };

            const editBtn = actions.createEl('button', {
                text: '‚úèÔ∏è',
                cls: 'lp-btn-edit'
            });
            editBtn.onclick = () => {
                new QuizListEditModal(this.app, this.plugin, quizId).open();
            };

            const deleteBtn = actions.createEl('button', { 
                text: 'üóëÔ∏è',
                cls: 'lp-btn-delete'
            });
            deleteBtn.onclick = async (e) => {
                e.stopPropagation();
                if (confirm(`"${quiz.subject}" ÌÄ¥Ï¶àÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    delete this.plugin.settings.quizzes[quizId];
                    await this.plugin.saveSettings();
                    this.onOpen();
                    new Notice('ÌÄ¥Ï¶àÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                }
            };
        });
    }
    
    // ========== ÏùºÎ≥Ñ/Ï£ºÍ∞Ñ/ÏõîÎ≥Ñ ÌÖåÏä§Ìä∏ ÌÉ≠ Î©îÏÑúÎìú (enhanced-cloze Ïä§ÌÉÄÏùº) ==========
    async renderTestDailyTab(container) {
        const section = container.createDiv({ cls: 'lp-test-section' });
        section.style.cssText = 'background-color: #1e2330; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);';
        
        // ÎÇ†Ïßú ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        const dateNav = section.createDiv({ cls: 'lp-date-nav' });
        dateNav.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 12px; background-color: #242936; border-radius: 8px;';
        
        const prevBtn = dateNav.createEl('button', { cls: 'lp-date-btn', text: '‚óÄ Ïù¥Ï†Ñ' });
        prevBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        prevBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() - 1);
            this.onOpen();
        };
        
        const dateTitle = dateNav.createDiv({ cls: 'lp-date-title' });
        dateTitle.style.cssText = 'font-size: 1.3em; font-weight: 700; color: #fbbf24;';
        dateTitle.setText(this.formatDateKorean(this.currentDate));
        
        const nextBtn = dateNav.createEl('button', { cls: 'lp-date-btn', text: 'Îã§Ïùå ‚ñ∂' });
        nextBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        nextBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() + 1);
            this.onOpen();
        };
        
        const todayBtn = dateNav.createEl('button', { cls: 'lp-today-btn', text: 'üìÖ Ïò§Îäò' });
        todayBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        todayBtn.onclick = () => {
            this.currentDate = new Date();
            this.onOpen();
        };
        
        // ÏùºÏùº Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
        await this.renderDailyChecklist(section, this.currentDate);
    }
    
    async renderTestWeeklyTab(container) {
        const section = container.createDiv({ cls: 'lp-test-section' });
        section.style.cssText = 'background-color: #1e2330; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);';
        
        const weekKey = this.getWeekKey(this.currentDate);
        const weeklyData = this.plugin.settings.weeklyChecklists?.[weekKey];
        
        // Ï£ºÍ∞Ñ Ï†úÎ™©
        const titleDiv = section.createDiv();
        titleDiv.style.cssText = 'margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #3b82f6;';
        
        const titleEl = titleDiv.createEl('h3', { text: `üìÜ Ï£ºÍ∞Ñ Î™©Ìëú (${weekKey})` });
        titleEl.style.cssText = 'margin: 0; color: #fbbf24; font-size: 1.5em;';
        
        // Ï£ºÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        const weekNav = section.createDiv();
        weekNav.style.cssText = 'display: flex; gap: 10px; margin-bottom: 20px;';
        
        const prevWeekBtn = weekNav.createEl('button', { text: '‚óÄ Ïù¥Ï†Ñ Ï£º' });
        prevWeekBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        prevWeekBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() - 7);
            this.onOpen();
        };
        
        const nextWeekBtn = weekNav.createEl('button', { text: 'Îã§Ïùå Ï£º ‚ñ∂' });
        nextWeekBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        nextWeekBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() + 7);
            this.onOpen();
        };
        
        const thisWeekBtn = weekNav.createEl('button', { text: 'üìÖ Ïù¥Î≤à Ï£º' });
        thisWeekBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        thisWeekBtn.onclick = () => {
            this.currentDate = new Date();
            this.onOpen();
        };
        
        // Î©îÎ™® ÏÑπÏÖò
        await this.renderNotesSection(section, weeklyData, weekKey, 'weekly');
        
        // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
        await this.renderChecklistSection(section, weeklyData, weekKey, 'weekly');
        
        // ÌÖúÌîåÎ¶ø Ï†ÅÏö© Î≤ÑÌäº
        this.renderTemplateButtons(section, weekKey, 'weekly');
    }
    
    async renderTestMonthlyTab(container) {
        const section = container.createDiv({ cls: 'lp-test-section' });
        section.style.cssText = 'background-color: #1e2330; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);';
        
        const monthKey = `${this.currentDate.getFullYear()}-${String(this.currentDate.getMonth() + 1).padStart(2, '0')}`;
        const monthlyData = this.plugin.settings.monthlyChecklists?.[monthKey];
        
        // ÏõîÍ∞Ñ Ï†úÎ™©
        const titleDiv = section.createDiv();
        titleDiv.style.cssText = 'margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #10b981;';
        
        const titleEl = titleDiv.createEl('h3', { text: `üìä ÏõîÍ∞Ñ Î™©Ìëú (${monthKey})` });
        titleEl.style.cssText = 'margin: 0; color: #fbbf24; font-size: 1.5em;';
        
        // ÏõîÍ∞Ñ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        const monthNav = section.createDiv();
        monthNav.style.cssText = 'display: flex; gap: 10px; margin-bottom: 20px;';
        
        const prevMonthBtn = monthNav.createEl('button', { text: '‚óÄ Ïù¥Ï†Ñ Îã¨' });
        prevMonthBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        prevMonthBtn.onclick = () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.onOpen();
        };
        
        const nextMonthBtn = monthNav.createEl('button', { text: 'Îã§Ïùå Îã¨ ‚ñ∂' });
        nextMonthBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        nextMonthBtn.onclick = () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.onOpen();
        };
        
        const thisMonthBtn = monthNav.createEl('button', { text: 'üìÖ Ïù¥Î≤à Îã¨' });
        thisMonthBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700;';
        thisMonthBtn.onclick = () => {
            this.currentDate = new Date();
            this.onOpen();
        };
        
        // Î©îÎ™® ÏÑπÏÖò
        await this.renderNotesSection(section, monthlyData, monthKey, 'monthly');
        
        // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
        await this.renderChecklistSection(section, monthlyData, monthKey, 'monthly');
        
        // ÌÖúÌîåÎ¶ø Ï†ÅÏö© Î≤ÑÌäº
        this.renderTemplateButtons(section, monthKey, 'monthly');
    }
    
    async renderDailyChecklist(container, date) {
        const dateKey = this.getDateKey(date);
        let dayData = this.plugin.settings.dailyChecklists?.[dateKey];
        
        if (!dayData) {
            dayData = { items: [], notes: [] };
            if (!this.plugin.settings.dailyChecklists) this.plugin.settings.dailyChecklists = {};
            this.plugin.settings.dailyChecklists[dateKey] = dayData;
        }
        
        // Î©îÎ™® ÏÑπÏÖò
        await this.renderNotesSection(container, dayData, dateKey, 'daily');
        
        // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
        await this.renderChecklistSection(container, dayData, dateKey, 'daily');
        
        // ÌÖúÌîåÎ¶ø Ï†ÅÏö© Î≤ÑÌäº
        this.renderTemplateButtons(container, dateKey, 'daily');
    }
    
    async renderNotesSection(container, data, key, type) {
        const notesSection = container.createDiv({ cls: 'lp-notes-section' });
        notesSection.style.cssText = 'background-color: #242936; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #fbbf24;';
        
        const noteTitle = notesSection.createEl('h4', { text: 'üìù Î©îÎ™®' });
        noteTitle.style.cssText = 'margin: 0 0 12px 0; color: #fbbf24; font-size: 1.1em;';
        
        const notesList = notesSection.createDiv();
        
        if (data && data.notes && data.notes.length > 0) {
            data.notes.forEach((note, idx) => {
                const noteItem = notesList.createDiv();
                noteItem.style.cssText = 'padding: 10px; background-color: #2d3548; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;';
                
                const noteText = noteItem.createEl('span', { text: note });
                noteText.style.cssText = 'color: #f3f4f6; flex: 1; white-space: pre-wrap;';
                
                const noteButtons = noteItem.createDiv();
                noteButtons.style.cssText = 'display: flex; gap: 6px;';
                
                const editBtn = noteButtons.createEl('button', { text: '‚úèÔ∏è' });
                editBtn.style.cssText = 'padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;';
                editBtn.onclick = () => {
                    new NoteEditModal(this.app, note, (newText) => {
                        const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                        type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                        this.plugin.settings.monthlyChecklists;
                        if (!settings[key]) settings[key] = { items: [], notes: [] };
                        settings[key].notes[idx] = newText;
                        this.plugin.saveSettings();
                        this.onOpen();
                    }, () => {
                        const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                        type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                        this.plugin.settings.monthlyChecklists;
                        settings[key].notes.splice(idx, 1);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }).open();
                };
                
                const deleteBtn = noteButtons.createEl('button', { text: 'üóëÔ∏è' });
                deleteBtn.style.cssText = 'padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;';
                deleteBtn.onclick = () => {
                    if (confirm('Ïù¥ Î©îÎ™®Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                        type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                        this.plugin.settings.monthlyChecklists;
                        settings[key].notes.splice(idx, 1);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }
                };
            });
        } else {
            const emptyMsg = notesList.createDiv({ text: 'Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§. ÏïÑÎûò Î≤ÑÌäºÏúºÎ°ú Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî.' });
            emptyMsg.style.cssText = 'color: #9ca3af; font-style: italic; padding: 10px; text-align: center;';
        }
        
        const addNoteBtn = notesSection.createEl('button', { text: '+ Î©îÎ™® Ï∂îÍ∞Ä' });
        addNoteBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); color: #000; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; margin-top: 10px; width: 100%;';
        addNoteBtn.onclick = () => {
            new NoteAddModal(this.app, (text) => {
                const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                this.plugin.settings.monthlyChecklists;
                if (!settings[key]) settings[key] = { items: [], notes: [] };
                if (!settings[key].notes) settings[key].notes = [];
                settings[key].notes.push(text);
                this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
    }
    
    async renderChecklistSection(container, data, key, type) {
        const checklistSection = container.createDiv({ cls: 'lp-checklist-section' });
        checklistSection.style.cssText = 'background-color: #242936; padding: 16px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #10b981;';
        
        const checkTitle = checklistSection.createEl('h4', { text: '‚úÖ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏' });
        checkTitle.style.cssText = 'margin: 0 0 12px 0; color: #10b981; font-size: 1.1em;';
        
        const checkList = checklistSection.createDiv();
        
        if (data && data.items && data.items.length > 0) {
            data.items.forEach((item, idx) => {
                const checkItem = checkList.createDiv();
                checkItem.style.cssText = 'padding: 10px; background-color: #2d3548; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px;';
                
                const checkbox = checkItem.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed || false;
                checkbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';
                checkbox.onchange = () => {
                    const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                    type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                    this.plugin.settings.monthlyChecklists;
                    if (!settings[key]) settings[key] = { items: [], notes: [] };
                    settings[key].items[idx].completed = checkbox.checked;
                    this.plugin.saveSettings();
                    this.onOpen();
                };
                
                const itemText = checkItem.createEl('span', { text: item.text });
                itemText.style.cssText = `color: #f3f4f6; flex: 1; ${item.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}`;
                
                const deleteBtn = checkItem.createEl('button', { text: 'üóëÔ∏è' });
                deleteBtn.style.cssText = 'padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;';
                deleteBtn.onclick = () => {
                    if (confirm('Ïù¥ Ìï≠Î™©ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                        type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                        this.plugin.settings.monthlyChecklists;
                        settings[key].items.splice(idx, 1);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }
                };
            });
            
            // ÏßÑÌñâÎ•† ÌëúÏãú
            const completed = data.items.filter(i => i.completed).length;
            const total = data.items.length;
            const percent = Math.round((completed / total) * 100);
            
            const progressDiv = checklistSection.createDiv();
            progressDiv.style.cssText = 'margin-top: 12px; padding-top: 12px; border-top: 1px solid #3a4154;';
            
            const progressText = progressDiv.createDiv({ text: `ÏôÑÎ£å: ${completed}/${total} (${percent}%)` });
            progressText.style.cssText = 'color: #9ca3af; font-size: 0.9em; margin-bottom: 6px;';
            
            const progressBar = progressDiv.createDiv();
            progressBar.style.cssText = 'height: 6px; background-color: #1e2330; border-radius: 3px; overflow: hidden;';
            
            const progressFill = progressBar.createDiv();
            progressFill.style.cssText = `width: ${percent}%; height: 100%; background: linear-gradient(135deg, #10b981, #059669); transition: width 0.3s;`;
        } else {
            const emptyMsg = checkList.createDiv({ text: 'Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.' });
            emptyMsg.style.cssText = 'color: #9ca3af; font-style: italic; padding: 10px; text-align: center;';
        }
        
        const addItemBtn = checklistSection.createEl('button', { text: '+ Ìï≠Î™© Ï∂îÍ∞Ä' });
        addItemBtn.style.cssText = 'padding: 8px 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; margin-top: 10px; width: 100%;';
        addItemBtn.onclick = () => {
            new ChecklistItemModal(this.app, (text) => {
                const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                this.plugin.settings.monthlyChecklists;
                if (!settings[key]) settings[key] = { items: [], notes: [] };
                if (!settings[key].items) settings[key].items = [];
                settings[key].items.push({ text, completed: false });
                this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
    }
    
    renderTemplateButtons(container, key, type) {
        const templates = this.plugin.settings.checklistTemplates.filter(t => t.type === type);
        
        if (templates.length === 0) return;
        
        const templateSection = container.createDiv();
        templateSection.style.cssText = 'background-color: #242936; padding: 16px; border-radius: 8px; border-left: 4px solid #8b5cf6;';
        
        const templateTitle = templateSection.createEl('h4', { text: 'üìã ÌÖúÌîåÎ¶ø Ï†ÅÏö©' });
        templateTitle.style.cssText = 'margin: 0 0 12px 0; color: #8b5cf6; font-size: 1.1em;';
        
        const templateGrid = templateSection.createDiv();
        templateGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;';
        
        templates.forEach(template => {
            const templateBtn = templateGrid.createEl('button', { text: template.name });
            templateBtn.style.cssText = 'padding: 10px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;';
            templateBtn.onclick = () => {
                const settings = type === 'daily' ? this.plugin.settings.dailyChecklists : 
                                type === 'weekly' ? this.plugin.settings.weeklyChecklists : 
                                this.plugin.settings.monthlyChecklists;
                
                if (!settings[key]) settings[key] = { items: [], notes: [] };
                if (!settings[key].items) settings[key].items = [];
                
                template.items.forEach(itemText => {
                    settings[key].items.push({ text: itemText, completed: false });
                });
                
                this.plugin.saveSettings();
                this.onOpen();
                new Notice(`ÌÖúÌîåÎ¶ø "${template.name}" Ï†ÅÏö© ÏôÑÎ£å!`);
            };
        });
    }
    
    formatDateKorean(date) {
        const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
        return `${date.getFullYear()}ÎÖÑ ${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº (${days[date.getDay()]})`;
    }
    
    getDateKey(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }
    
    // ========== Î£®Ìã¥ ÌîåÎûòÎÑà Î∑∞ Î©îÏÑúÎìú (routine-planner Ïû¨ÌÜµÌï©) ==========
    async renderRoutineCalendarView(container) {
        const subtitle = container.createDiv({ cls: 'lp-subtitle' });
        subtitle.createEl('span', { text: 'Î£®Ìã¥ Ï∫òÎ¶∞ÎçîÎ°ú ÏùºÏ†ï Í¥ÄÎ¶¨' });

        const calendarContainer = container.createDiv({ cls: 'rp-calendar-container' });
        
        // Ïõî ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò
        const monthNav = calendarContainer.createDiv({ cls: 'rp-month-nav' });
        
        const prevBtn = monthNav.createEl('button', { cls: 'rp-month-btn' });
        prevBtn.textContent = '‚óÄ';
        prevBtn.onclick = () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.onOpen();
        };
        
        const monthTitle = monthNav.createDiv({ cls: 'rp-month-title' });
        monthTitle.textContent = `${this.currentDate.getFullYear()}ÎÖÑ ${this.currentDate.getMonth() + 1}Ïõî`;
        
        const nextBtn = monthNav.createEl('button', { cls: 'rp-month-btn' });
        nextBtn.textContent = '‚ñ∂';
        nextBtn.onclick = () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.onOpen();
        };
        
        const todayBtn = monthNav.createEl('button', { cls: 'rp-today-btn' });
        todayBtn.textContent = 'Today';
        todayBtn.onclick = () => {
            this.currentDate = new Date();
            this.onOpen();
        };
        
        // ÏöîÏùº Ìó§Îçî
        const weekHeader = calendarContainer.createDiv({ cls: 'rp-week-header' });
        const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
        days.forEach(day => {
            const dayEl = weekHeader.createDiv({ cls: 'rp-week-day' });
            dayEl.textContent = day;
        });
        
        // Ï∫òÎ¶∞Îçî Í∑∏Î¶¨Îìú
        const calendarGrid = calendarContainer.createDiv({ cls: 'rp-calendar-grid' });
        await this.renderCalendarDays(calendarGrid);
        
        // Î£®Ìã¥ ÌÖúÌîåÎ¶ø ÏÑπÏÖò
        this.renderRoutineTemplates(container);
    }
    
    async renderCalendarDays(grid) {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        
        // Îπà Ïπ∏ Ï±ÑÏö∞Í∏∞
        for (let i = 0; i < firstDay; i++) {
            grid.createDiv({ cls: 'rp-calendar-day empty' });
        }
        
        // ÎÇ†Ïßú Ï±ÑÏö∞Í∏∞
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = grid.createDiv({ cls: 'rp-calendar-day' });
            const date = new Date(year, month, day);
            
            if (date.toDateString() === today.toDateString()) {
                dayEl.addClass('today');
            }
            
            const dayNum = dayEl.createDiv({ cls: 'rp-day-num' });
            dayNum.textContent = day.toString();
            
            // Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
            const dateKey = this.getDateKey(date);
            const dayData = this.plugin.settings.dailyChecklists?.[dateKey];
            
            if (dayData && dayData.items && dayData.items.length > 0) {
                const completedCount = dayData.items.filter(item => item.completed).length;
                const totalCount = dayData.items.length;
                
                const progress = dayEl.createDiv({ cls: 'rp-day-progress' });
                progress.textContent = `${completedCount}/${totalCount}`;
                
                if (completedCount === totalCount) {
                    dayEl.addClass('completed');
                } else if (completedCount > 0) {
                    dayEl.addClass('in-progress');
                }
            }
            
            dayEl.onclick = () => {
                this.currentDate = date;
                this.currentView = 'routine-daily';
                this.onOpen();
            };
        }
    }
    
    renderRoutineTemplates(container) {
        const templateSection = container.createDiv({ cls: 'rp-template-section' });
        templateSection.createEl('h3', { text: 'üìã Î£®Ìã¥ ÌÖúÌîåÎ¶ø' });
        
        const templateGrid = templateSection.createDiv({ cls: 'rp-template-grid' });
        
        this.plugin.settings.routineTemplates.forEach(template => {
            const templateCard = templateGrid.createDiv({ cls: 'rp-template-card' });
            
            const templateName = templateCard.createEl('h4', { text: template.name });
            
            const templateItems = templateCard.createDiv({ cls: 'rp-template-items' });
            template.items.slice(0, 3).forEach(item => {
                templateItems.createEl('div', { text: `‚Ä¢ ${item}`, cls: 'rp-template-item' });
            });
            
            if (template.items.length > 3) {
                templateItems.createEl('div', { text: `... +${template.items.length - 3}Í∞ú`, cls: 'rp-template-more' });
            }
            
            const applyBtn = templateCard.createEl('button', {
                text: 'Ï†ÅÏö©',
                cls: 'rp-template-apply-btn'
            });
            applyBtn.onclick = async () => {
                await this.applyRoutineTemplate(template);
            };
        });
    }
    
    async applyRoutineTemplate(template) {
        const dateKey = this.getDateKey(this.currentDate);
        
        if (!this.plugin.settings.dailyChecklists) {
            this.plugin.settings.dailyChecklists = {};
        }
        
        if (!this.plugin.settings.dailyChecklists[dateKey]) {
            this.plugin.settings.dailyChecklists[dateKey] = { items: [], notes: [] };
        }
        
        template.items.forEach(item => {
            this.plugin.settings.dailyChecklists[dateKey].items.push({
                text: item,
                completed: false
            });
        });
        
        await this.plugin.saveSettings();
        this.currentView = 'routine-daily';
        await this.onOpen();
        
        new Notice(`"${template.name}" ÌÖúÌîåÎ¶øÏù¥ Ï†ÅÏö©ÎêòÏóàÏäµÎãàÎã§!`);
    }
    
    async renderRoutineDailyView(container) {
        const dateKey = this.getDateKey(this.currentDate);
        let dayData = this.plugin.settings.dailyChecklists?.[dateKey];
        
        if (!dayData) {
            dayData = { items: [], notes: [] };
            if (!this.plugin.settings.dailyChecklists) {
                this.plugin.settings.dailyChecklists = {};
            }
            this.plugin.settings.dailyChecklists[dateKey] = dayData;
        }
        
        const scrollContainer = container.createDiv({ cls: 'rp-daily-scroll-container' });
        
        // ÎÇ†Ïßú Ìó§Îçî
        const dateHeader = scrollContainer.createDiv({ cls: 'rp-date-header' });
        
        const prevDayBtn = dateHeader.createEl('button', { cls: 'rp-date-nav-btn' });
        prevDayBtn.textContent = '‚óÄ';
        prevDayBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() - 1);
            this.onOpen();
        };
        
        const dateTitle = dateHeader.createDiv({ cls: 'rp-date-title' });
        dateTitle.textContent = this.formatDateKorean(this.currentDate);
        
        const nextDayBtn = dateHeader.createEl('button', { cls: 'rp-date-nav-btn' });
        nextDayBtn.textContent = '‚ñ∂';
        nextDayBtn.onclick = () => {
            this.currentDate.setDate(this.currentDate.getDate() + 1);
            this.onOpen();
        };
        
        // Î£®Ìã¥ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÑπÏÖò
        const routineSection = scrollContainer.createDiv({ cls: 'rp-section' });
        routineSection.createEl('h3', { text: '‚úÖ Ïò§ÎäòÏùò Î£®Ìã¥' });
        
        const routineList = routineSection.createDiv({ cls: 'rp-routine-list' });
        
        if (dayData.items && dayData.items.length > 0) {
            dayData.items.forEach((item, index) => {
                const routineItem = routineList.createDiv({ cls: 'rp-routine-item' });
                
                const checkbox = routineItem.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed;
                checkbox.onchange = async () => {
                    item.completed = checkbox.checked;
                    await this.plugin.saveSettings();
                    this.onOpen();
                };
                
                const text = routineItem.createDiv({ cls: 'rp-routine-text' });
                text.textContent = item.text;
                if (item.completed) {
                    text.addClass('checked');
                }
                
                const deleteBtn = routineItem.createEl('button', { cls: 'rp-delete-btn' });
                deleteBtn.textContent = '√ó';
                deleteBtn.onclick = async () => {
                    dayData.items.splice(index, 1);
                    await this.plugin.saveSettings();
                    this.onOpen();
                };
            });
        }
        
        const addRoutineBtn = routineSection.createEl('button', { cls: 'rp-add-btn' });
        addRoutineBtn.textContent = '+ Î£®Ìã¥ Ï∂îÍ∞Ä';
        addRoutineBtn.onclick = () => {
            new RoutineAddModal(this.app, async (text) => {
                if (!dayData.items) dayData.items = [];
                dayData.items.push({ text, completed: false });
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
        
        // Î©îÎ™® ÏÑπÏÖò
        const noteSection = scrollContainer.createDiv({ cls: 'rp-section' });
        noteSection.createEl('h3', { text: 'üí¨ Î©îÎ™®' });
        
        const noteList = noteSection.createDiv({ cls: 'rp-note-list' });
        
        if (dayData.notes && dayData.notes.length > 0) {
            dayData.notes.forEach((note, index) => {
                const noteItem = noteList.createDiv({ cls: 'rp-note-item' });
                noteItem.textContent = note;
                
                const deleteBtn = noteItem.createEl('button', { cls: 'rp-delete-btn-inline' });
                deleteBtn.textContent = '√ó';
                deleteBtn.onclick = async () => {
                    dayData.notes.splice(index, 1);
                    await this.plugin.saveSettings();
                    this.onOpen();
                };
            });
        }
        
        const addNoteBtn = noteSection.createEl('button', { cls: 'rp-add-btn' });
        addNoteBtn.textContent = '+ Î©îÎ™® Ï∂îÍ∞Ä';
        addNoteBtn.onclick = () => {
            new NoteAddModal(this.app, async (text) => {
                if (!dayData.notes) dayData.notes = [];
                dayData.notes.push(text);
                await this.plugin.saveSettings();
                this.onOpen();
            }).open();
        };
    }
    
    formatDateKorean(date) {
        const days = ['Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†'];
        return `${date.getFullYear()}ÎÖÑ ${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº (${days[date.getDay()]})`;
    }
    
    getDateKey(date) {
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }

    async renderCalendarDays(grid) {
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const today = new Date();
        
        for (let i = 0; i < firstDay; i++) {
            grid.createDiv({ cls: 'rp-calendar-day empty' });
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dayEl = grid.createDiv({ cls: 'rp-calendar-day' });
            const date = new Date(year, month, day);
            
            if (date.toDateString() === today.toDateString()) {
                dayEl.addClass('today');
            }
            
            dayEl.createDiv({ cls: 'rp-day-num', text: day.toString() });
            
            const dateKey = this.getDateKey(date);
            const dayData = this.plugin.settings.dailyChecklists?.[dateKey];
            
            if (dayData && dayData.items && dayData.items.length > 0) {
                const completedCount = dayData.items.filter(r => r.completed).length;
                const totalCount = dayData.items.length;
                
                const progress = dayEl.createDiv({ cls: 'rp-day-progress' });
                progress.setText(`${completedCount}/${totalCount}`);
                
                if (completedCount === totalCount) dayEl.addClass('completed');
                else if (completedCount > 0) dayEl.addClass('in-progress');
            }
            
            // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Í∞úÏÑ† (Î™®Î∞îÏùº)
            let dayTouchStartY = 0;
            dayEl.addEventListener('touchstart', (e) => {
                dayTouchStartY = e.touches[0].clientY;
            });
            dayEl.addEventListener('touchend', (e) => {
                const touchEndY = e.changedTouches[0].clientY;
                const delta = Math.abs(touchEndY - dayTouchStartY);
                if (delta < 10) {
                    // Ïä§ÌÅ¨Î°§Ïù¥ ÏïÑÎãå ÌÉ≠ÏúºÎ°ú Í∞ÑÏ£º
                    this.currentDate = date;
                    this.currentView = 'routine-daily';
                    this.onOpen();
                }
            });
            
            dayEl.onclick = () => {
                this.currentDate = date;
                this.currentView = 'routine-daily';
                this.onOpen();
            };
        }
    }

    addStyles() {
        // Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ï†úÍ±∞ ÌõÑ Îã§Ïãú Ï∂îÍ∞Ä (ÏóÖÎç∞Ïù¥Ìä∏ Î∞òÏòÅ)
        const existingStyle = document.getElementById('lp-styles');
        if (existingStyle) {
            existingStyle.remove();
        }

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-styles';
        styleEl.textContent = `
            /* Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà - Îã§ÌÅ¨ ÎÑ§Ïò® ÌÖåÎßà */
            .lp-container {
                padding: 32px;
                max-width: 1400px;
                margin: 0 auto;
                background: linear-gradient(180deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
                min-height: 100vh;
                color: #e2e8f0;
                position: relative;
            }
            
            .lp-container::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                            radial-gradient(circle at 80% 70%, rgba(168, 85, 247, 0.1) 0%, transparent 50%);
                pointer-events: none;
                z-index: 0;
            }
            
            .lp-container > * {
                position: relative;
                z-index: 1;
            }

            .lp-header {
                margin-bottom: 32px;
                padding: 32px;
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(168, 85, 247, 0.1) 100%);
                backdrop-filter: blur(20px);
                border-radius: 24px;
                border: 1px solid rgba(139, 92, 246, 0.2);
                box-shadow: 0 8px 32px rgba(99, 102, 241, 0.15);
            }

            .lp-header h2 {
                margin: 0 0 24px 0;
                font-size: 2.5em;
                font-weight: 900;
                background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                text-align: center;
                letter-spacing: -1px;
                animation: titlePulse 3s ease-in-out infinite;
            }
            
            @keyframes titlePulse {
                0%, 100% { filter: brightness(1); }
                50% { filter: brightness(1.2); }
            }

            .lp-subtitle {
                color: #9ca3af;
                font-size: 1em;
                font-weight: 500;
            }

            .lp-stats-section {
                margin-bottom: 24px;
            }

            .lp-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .lp-stat-card {
                background: linear-gradient(135deg, rgba(30, 41, 59, 0.6) 0%, rgba(15, 23, 42, 0.8) 100%);
                padding: 24px;
                border-radius: 20px;
                text-align: center;
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                border: 1px solid rgba(139, 92, 246, 0.2);
                box-shadow: 0 4px 16px rgba(99, 102, 241, 0.1);
                cursor: pointer;
                backdrop-filter: blur(10px);
                position: relative;
                overflow: hidden;
            }
            
            .lp-stat-card::before {
                content: '';
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient(45deg, transparent, rgba(139, 92, 246, 0.1), transparent);
                transform: rotate(45deg);
                transition: all 0.5s;
            }
            
            .lp-stat-card:hover::before {
                transform: rotate(45deg) translate(50%, 50%);
            }

            .lp-stat-card:hover {
                transform: translateY(-8px) scale(1.05);
                box-shadow: 0 16px 40px rgba(139, 92, 246, 0.3);
                border-color: rgba(168, 85, 247, 0.5);
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.3) 100%);
            }

            .lp-stat-value {
                font-size: 2.8em;
                font-weight: 900;
                margin-bottom: 8px;
                background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                position: relative;
                z-index: 1;
            }

            .lp-stat-label {
                color: #94a3b8;
                font-size: 0.9em;
                font-weight: 600;
                letter-spacing: 1px;
                text-transform: uppercase;
                position: relative;
                z-index: 1;
            }

            .lp-actions-section {
                margin-bottom: 30px;
            }

            .lp-actions-section h3,
            .lp-folder-section h3,
            .lp-quiz-section h3 {
                margin-bottom: 18px;
                font-size: 1.4em;
                font-weight: 700;
                color: #fbbf24;
                padding-left: 12px;
                border-left: 4px solid #f59e0b;
                letter-spacing: 0.5px;
            }

            .lp-actions-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 12px;
            }

            .lp-action-btn {
                padding: 16px 24px;
                border: 2px solid rgba(139, 92, 246, 0.3);
                border-radius: 14px;
                font-size: 1em;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                box-shadow: 0 4px 16px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
                background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                color: #fff;
                position: relative;
                overflow: hidden;
            }
            
            .lp-action-btn::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.2);
                transform: translate(-50%, -50%);
                transition: width 0.5s, height 0.5s;
            }
            
            .lp-action-btn:hover::before {
                width: 300px;
                height: 300px;
            }

            .lp-action-btn:hover {
                transform: translateY(-4px) scale(1.05);
                box-shadow: 0 12px 32px rgba(139, 92, 246, 0.5), inset 0 2px 0 rgba(255, 255, 255, 0.2);
                border-color: rgba(168, 85, 247, 0.6);
            }

            .lp-action-btn:active {
                transform: translateY(-2px) scale(1.02);
            }

            .lp-action-primary {
                background: var(--interactive-accent);
                color: white;
            }

            .lp-action-bookmark {
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                color: #000;
            }

            .lp-action-stats {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }

            .lp-action-records {
                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                color: white;
            }

            .lp-action-secondary {
                background: var(--background-secondary);
                color: var(--text-normal);
                border: 2px solid var(--background-modifier-border);
            }

            .lp-folder-section {
                margin-bottom: 30px;
            }

            .lp-folder-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .lp-folder-card {
                background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.7) 100%);
                padding: 28px;
                border-radius: 20px;
                text-align: center;
                cursor: pointer;
                transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                border: 1px solid rgba(139, 92, 246, 0.2);
                box-shadow: 0 4px 16px rgba(99, 102, 241, 0.15);
                backdrop-filter: blur(12px);
                position: relative;
                overflow: hidden;
            }
            
            .lp-folder-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.2), transparent);
                transition: left 0.5s;
            }
            
            .lp-folder-card:hover::before {
                left: 100%;
            }

            .lp-folder-card:hover {
                transform: translateY(-10px) scale(1.05) rotate(1deg);
                box-shadow: 0 20px 50px rgba(139, 92, 246, 0.4);
                border-color: rgba(168, 85, 247, 0.6);
                background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.4) 100%);
            }

            .lp-folder-bookmark {
                background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                border: 2px solid #fbbf24;
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
            }

            .lp-folder-bookmark:hover {
                box-shadow: 0 6px 20px rgba(251, 191, 36, 0.5);
                border-color: #fcd34d;
            }

            .lp-folder-icon {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .lp-folder-name {
                font-weight: 600;
                margin-bottom: 5px;
                color: #f3f4f6;
            }

            .lp-folder-count {
                color: #9ca3af;
                font-size: 0.9em;
            }

            .lp-folder-quizzes {
                color: #9ca3af;
                font-size: 0.85em;
                margin-top: 4px;
            }

            .lp-quiz-section {
                margin-bottom: 30px;
            }

            .lp-quiz-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .lp-quiz-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 18px 24px;
                background-color: #242936;
                border-radius: 10px;
                border-left: 5px solid #f59e0b;
                transition: all 0.2s ease;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
                cursor: pointer;
                border: 1px solid #2d3548;
            }

            .lp-quiz-item:hover {
                transform: translateX(5px);
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
                border-left-width: 7px;
                background-color: #2d3548;
            }

            .lp-quiz-info {
                flex: 1;
            }

            .lp-quiz-title-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 8px;
            }

            .lp-quiz-title-row h4 {
                margin: 0;
                font-size: 1.1em;
                color: #f3f4f6;
            }

            .lp-quiz-folder-tag {
                padding: 3px 10px;
                background: #2d3548;
                border-radius: 12px;
                font-size: 0.85em;
                color: #9ca3af;
            }

            .lp-quiz-difficulty-tag {
                padding: 3px 10px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 500;
            }

            .lp-quiz-difficulty-tag[data-difficulty="Ïâ¨ÏõÄ"] {
                background: #4CAF50;
                color: white;
            }

            .lp-quiz-difficulty-tag[data-difficulty="Î≥¥ÌÜµ"] {
                background: #2196F3;
                color: white;
            }

            .lp-quiz-difficulty-tag[data-difficulty="Ïñ¥Î†§ÏõÄ"] {
                background: #FF9800;
                color: white;
            }

            .lp-quiz-difficulty-tag[data-difficulty="Îß§Ïö∞ Ïñ¥Î†§ÏõÄ"] {
                background: #F44336;
                color: white;
            }

            .lp-quiz-meta {
                display: flex;
                gap: 8px;
                color: #9ca3af;
                font-size: 0.9em;
            }

            .lp-quiz-actions {
                display: flex;
                gap: 8px;
            }

            .lp-btn-start {
                padding: 10px 24px;
                background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
                color: #000;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 700;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            }

            .lp-btn-start:hover {
                background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
            }

            .lp-btn-edit {
                padding: 10px 20px;
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 700;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            }

            .lp-btn-edit:hover {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
            }

            .lp-btn-delete {
                padding: 10px 16px;
                background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s ease;
                box-shadow: 0 3px 8px rgba(244, 67, 54, 0.3);
            }

            .lp-btn-delete:hover {
                background: linear-gradient(135deg, #da190b 0%, #c41700 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 15px rgba(244, 67, 54, 0.4);
            }

            .lp-empty-message {
                text-align: center;
                padding: 40px;
                color: var(--text-muted);
                font-size: 1.1em;
            }

            .lp-section-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }
            
            /* Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
            .lp-container::-webkit-scrollbar,
            .lp-quiz-list::-webkit-scrollbar {
                width: 10px;
            }
            
            .lp-container::-webkit-scrollbar-track,
            .lp-quiz-list::-webkit-scrollbar-track {
                background: #151923;
                border-radius: 5px;
            }
            
            .lp-container::-webkit-scrollbar-thumb,
            .lp-quiz-list::-webkit-scrollbar-thumb {
                background: linear-gradient(135deg, #f59e0b, #fbbf24);
                border-radius: 5px;
            }
            
            .lp-container::-webkit-scrollbar-thumb:hover,
            .lp-quiz-list::-webkit-scrollbar-thumb:hover {
                background: linear-gradient(135deg, #fbbf24, #f59e0b);
            }
            
            /* Î™®Î∞îÏùº Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
            @media (max-width: 768px) {
                .lp-container {
                    padding: 12px;
                }
                
                .lp-header h2 {
                    font-size: 1.5em;
                }
                
                .lp-subtitle {
                    font-size: 0.95em;
                }
                
                .lp-stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                }
                
                .lp-stat-card {
                    padding: 14px;
                }
                
                .lp-stat-value {
                    font-size: 1.5em;
                }
                
                .lp-stat-label {
                    font-size: 0.8em;
                }
                
                .lp-actions-grid {
                    grid-template-columns: 1fr;
                    gap: 10px;
                }
                
                .lp-action-btn {
                    padding: 14px;
                    font-size: 0.95em;
                    min-height: 48px;
                }
                
                .lp-folder-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                }
                
                .lp-folder-card {
                    padding: 14px;
                }
                
                .lp-folder-icon {
                    font-size: 2em;
                }
                
                .lp-quiz-item {
                    padding: 12px 14px;
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 10px;
                }
                
                .lp-quiz-title-row {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 6px;
                }
                
                .lp-quiz-actions {
                    width: 100%;
                    justify-content: flex-end;
                }
                
                .lp-btn-start,
                .lp-btn-edit,
                .lp-btn-delete {
                    padding: 10px 14px;
                    font-size: 0.9em;
                    min-height: 44px;
                }
            }
            
            /* ÏÜåÌòï Î™®Î∞îÏùº (360px Ïù¥Ìïò) */
            @media (max-width: 480px) {
                .lp-container {
                    padding: 10px;
                }
                
                .lp-header {
                    padding-bottom: 15px;
                    margin-bottom: 20px;
                }
                
                .lp-header h2 {
                    font-size: 1.3em;
                }
                
                .lp-stats-grid {
                    grid-template-columns: 1fr;
                }
                
                .lp-folder-grid {
                    grid-template-columns: 1fr;
                }
                
                .lp-quiz-meta {
                    flex-direction: column;
                    gap: 4px;
                }
            }
            
            /* Î£®Ìã¥ ÌîåÎûòÎÑà Ïä§ÌÉÄÏùº */
            .lp-header-title-section {
                text-align: center;
                margin-bottom: 15px;
            }
            
            .lp-view-nav {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: 10px;
            }
            
            .lp-view-btn {
                padding: 10px 20px;
                background-color: #2d3548;
                color: #f3f4f6;
                border: 1px solid #3a4154;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s ease;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            }
            
            .lp-view-btn:hover {
                background-color: #353d52;
                border-color: #f59e0b;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            }
            
            .lp-view-btn.active {
                background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
                color: #000;
                border-color: #f59e0b;
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
                font-weight: 700;
            }
            
            .rp-calendar-container {
                max-width: 900px;
                margin: 0 auto;
            }
            
            .rp-month-nav {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding: 10px;
                background-color: #1e2330;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            
            .rp-month-btn, .rp-today-btn {
                padding: 10px 20px;
                background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
                color: #000;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 700;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            }
            
            .rp-month-btn:hover, .rp-today-btn:hover {
                opacity: 0.85;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.5);
            }
            
            .rp-month-title {
                font-size: 1.5rem;
                font-weight: bold;
                color: #fbbf24;
            }
                font-weight: bold;
                color: var(--text-normal);
            }
            
            .rp-week-header {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
                margin-bottom: 8px;
            }
            
            .rp-week-day {
                text-align: center;
                font-weight: bold;
                color: var(--text-muted);
                padding: 8px;
            }
            
            .rp-calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 8px;
            }
            
            .rp-calendar-day {
                aspect-ratio: 1;
                background-color: #242936;
                border-radius: 10px;
                padding: 10px;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                border: 1px solid #2d3548;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            }
            
            .rp-calendar-day:hover {
                transform: scale(1.05);
                border-color: #f59e0b;
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
                background-color: #2d3548;
            }
            
            .rp-calendar-day.empty {
                background: transparent;
                cursor: default;
                box-shadow: none;
            }
            
            .rp-calendar-day.empty:hover {
                transform: none;
            }
            
            .rp-calendar-day.today {
                border: 2px solid #3b82f6;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
            }
            
            .rp-calendar-day.completed {
                background: linear-gradient(135deg, #065f46 0%, #047857 100%);
                border-color: #10b981;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            }
            
            .rp-calendar-day.in-progress {
                background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
                border-color: #3b82f6;
                box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            }
            
            .rp-day-num {
                font-weight: bold;
                font-size: 1.1rem;
                color: #f3f4f6;
            }
            
            .rp-day-progress {
                font-size: 0.75rem;
                color: #fbbf24;
                text-align: right;
            }
            
            .rp-daily-scroll-container {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            
            .rp-date-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 30px;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
            }
            
            .rp-date-nav-btn {
                padding: 8px 16px;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                font-size: 1rem;
                transition: all 0.2s;
            }
            
            .rp-date-nav-btn:hover {
                opacity: 0.8;
            }
            
            .rp-date-title {
                font-size: 1.5rem;
                font-weight: bold;
                color: var(--text-normal);
                text-align: center;
            }
            
            .rp-section {
                margin-bottom: 30px;
                padding: 20px;
                background-color: #1e2330;
                border-radius: 8px;
                border: 1px solid #2d3548;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            
            .rp-section h3 {
                margin-top: 0;
                margin-bottom: 15px;
                color: #fbbf24;
                font-weight: 700;
            }
                color: var(--text-normal);
                font-size: 1.2rem;
            }
            
            .rp-routine-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .rp-routine-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 10px;
                background: var(--background-secondary);
                border-radius: 6px;
                border: 1px solid var(--background-modifier-border);
                transition: all 0.2s;
            }
            
            .rp-routine-item:hover {
                border-color: var(--interactive-accent);
            }
            
            .rp-routine-item input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }
            
            .rp-routine-text {
                flex: 1;
                color: var(--text-normal);
                font-size: 1rem;
            }
            
            .rp-routine-text.checked {
                text-decoration: line-through;
                opacity: 0.6;
            }
            
            .rp-delete-btn {
                padding: 4px 8px;
                background: #dc2626;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1.2rem;
                line-height: 1;
                transition: all 0.2s;
            }
            
            .rp-delete-btn:hover {
                background: #b91c1c;
            }
            
            .rp-add-btn {
                width: 100%;
                padding: 10px;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.2s;
            }
            
            .rp-add-btn:hover {
                opacity: 0.8;
            }
            
            .rp-note-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .rp-note-item {
                padding: 12px;
                background: var(--background-secondary);
                border-radius: 6px;
                border: 1px solid var(--background-modifier-border);
                color: var(--text-normal);
                position: relative;
                padding-right: 40px;
            }
            
            .rp-delete-btn-inline {
                position: absolute;
                top: 8px;
                right: 8px;
                padding: 4px 8px;
                background: #dc2626;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1rem;
                line-height: 1;
                transition: all 0.2s;
            }
            
            .rp-delete-btn-inline:hover {
                background: #b91c1c;
            }
            
            .rp-template-section {
                margin-top: 30px;
            }
            
            .rp-template-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }
            
            .rp-template-card {
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
                border: 1px solid var(--background-modifier-border);
            }
            
            .rp-template-name {
                font-weight: bold;
                font-size: 1.1rem;
                margin-bottom: 10px;
                color: var(--text-normal);
            }
            
            .rp-template-items {
                font-size: 0.9rem;
                color: var(--text-muted);
                margin-bottom: 10px;
            }
            
            .rp-template-apply-btn {
                width: 100%;
                padding: 8px;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.2s;
            }
            
            .rp-template-apply-btn:hover {
                opacity: 0.8;
            }
        `;
        document.head.appendChild(styleEl);
    }

    async onClose() {
        // cleanup
    }
}

// ==================== QuizCreatorModal ÌÅ¥ÎûòÏä§ ====================
class QuizCreatorModal extends Modal {
    constructor(app, plugin, folder = null) {
        super(app);
        this.plugin = plugin;
        this.folder = folder;
        this.questions = [];
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-quiz-creator');

        contentEl.createEl('h2', { text: '‚úèÔ∏è ÏÉà ÌÄ¥Ï¶à ÎßåÎì§Í∏∞' });

        // ÌÄ¥Ï¶à Ï†ïÎ≥¥ ÏÑπÏÖò
        const infoSection = contentEl.createDiv({ cls: 'lp-qc-info-section' });

        // Ï†úÎ™©
        const titleGroup = infoSection.createDiv({ cls: 'lp-qc-form-group' });
        titleGroup.createEl('label', { text: 'ÌÄ¥Ï¶à Ï†úÎ™©' });
        this.subjectInput = titleGroup.createEl('input', {
            type: 'text',
            placeholder: 'Ïòà: ÏòÅÏñ¥ Îã®Ïñ¥ ÌÄ¥Ï¶à',
            cls: 'lp-qc-input'
        });

        // Ìè¥Îçî ÏÑ†ÌÉù
        const folderGroup = infoSection.createDiv({ cls: 'lp-qc-form-group' });
        folderGroup.createEl('label', { text: 'Ìè¥Îçî' });
        this.folderSelect = folderGroup.createEl('select', { cls: 'lp-qc-select' });
        this.plugin.settings.questionFolders.forEach(folder => {
            const option = this.folderSelect.createEl('option', { text: folder, value: folder });
            if (this.folder && folder === this.folder) {
                option.selected = true;
            }
        });

        // ÎÇúÏù¥ÎèÑ ÏÑ†ÌÉù
        const difficultyGroup = infoSection.createDiv({ cls: 'lp-qc-form-group' });
        difficultyGroup.createEl('label', { text: 'ÎÇúÏù¥ÎèÑ' });
        this.difficultySelect = difficultyGroup.createEl('select', { cls: 'lp-qc-select' });
        this.plugin.settings.difficulties.forEach(diff => {
            this.difficultySelect.createEl('option', { text: diff, value: diff });
        });

        // ÏßàÎ¨∏ Î™©Î°ù
        contentEl.createEl('h3', { text: 'ÏßàÎ¨∏ Î™©Î°ù', cls: 'lp-qc-section-title' });
        this.questionsContainer = contentEl.createDiv({ cls: 'lp-qc-questions' });

        // ÏßàÎ¨∏ Ï∂îÍ∞Ä Î≤ÑÌäº
        const addBtn = contentEl.createEl('button', {
            text: '‚ûï ÏßàÎ¨∏ Ï∂îÍ∞Ä',
            cls: 'lp-qc-btn-add'
        });
        addBtn.onclick = () => this.addQuestion();

        // Ïï°ÏÖò Î≤ÑÌäº
        const actions = contentEl.createDiv({ cls: 'lp-qc-actions' });

        const saveBtn = actions.createEl('button', {
            text: 'üíæ Ï†ÄÏû•',
            cls: 'lp-qc-btn-save'
        });
        saveBtn.onclick = () => this.saveQuiz();

        const cancelBtn = actions.createEl('button', {
            text: 'Ï∑®ÏÜå',
            cls: 'lp-qc-btn-cancel'
        });
        cancelBtn.onclick = () => this.close();

        // Ï¥àÍ∏∞ ÏßàÎ¨∏ 1Í∞ú Ï∂îÍ∞Ä
        this.addQuestion();

        this.addQuizCreatorStyles();
    }

    addQuestion() {
        const questionId = Date.now() + Math.random();
        const qDiv = this.questionsContainer.createDiv({ cls: 'lp-qc-question' });
        qDiv.setAttribute('data-id', questionId);

        const header = qDiv.createDiv({ cls: 'lp-qc-question-header' });
        header.createEl('span', { text: `ÏßàÎ¨∏ ${this.questions.length + 1}`, cls: 'lp-qc-question-number' });

        const deleteBtn = header.createEl('button', {
            text: 'üóëÔ∏è',
            cls: 'lp-qc-btn-delete-q'
        });
        deleteBtn.onclick = () => {
            qDiv.remove();
            this.questions = this.questions.filter(q => q.id !== questionId);
            this.updateQuestionNumbers();
        };

        // ÏßàÎ¨∏ ÌÖçÏä§Ìä∏
        qDiv.createEl('label', { text: 'ÏßàÎ¨∏', cls: 'lp-qc-label' });
        const questionInput = qDiv.createEl('textarea', {
            placeholder: 'ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
            cls: 'lp-qc-textarea'
        });
        questionInput.rows = 2;

        // Ïù¥ÎØ∏ÏßÄ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        const imageLabel = qDiv.createDiv({ cls: 'lp-qc-image-group' });
        imageLabel.createEl('label', { text: 'Ïù¥ÎØ∏ÏßÄ (ÏÑ†ÌÉù)', cls: 'lp-qc-label' });
        
        const imageControls = imageLabel.createDiv();
        imageControls.style.cssText = 'display: flex; gap: 8px; align-items: center;';
        
        const imageInput = imageControls.createEl('input', {
            type: 'text',
            placeholder: '![[Ïù¥ÎØ∏ÏßÄ.png]] ÎòêÎäî Ïù¥ÎØ∏ÏßÄ URL',
            cls: 'lp-qc-input'
        });
        imageInput.style.cssText = 'flex: 1;';
        
        const uploadBtn = imageControls.createEl('button', {
            text: 'üìÅ ÏóÖÎ°úÎìú',
            cls: 'lp-qc-btn-upload'
        });
        uploadBtn.style.cssText = 'padding: 8px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap;';
        uploadBtn.onclick = async (e) => {
            e.preventDefault();
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    try {
                        // ObsidianÏùò Ï≤®Î∂ÄÌååÏùº Ìè¥ÎçîÏóê Ï†ÄÏû•
                        const arrayBuffer = await file.arrayBuffer();
                        const fileName = `quiz-${Date.now()}-${file.name}`;
                        const path = `${this.app.vault.adapter.basePath}/Ï≤®Î∂ÄÌååÏùº/${fileName}`;
                        
                        // ÌååÏùº Ï†ÄÏû•
                        await this.app.vault.adapter.writeBinary(path, arrayBuffer);
                        
                        // Obsidian ÎßÅÌÅ¨ ÌòïÏãùÏúºÎ°ú ÏûÖÎ†•
                        imageInput.value = `![[Ï≤®Î∂ÄÌååÏùº/${fileName}]]`;
                        new Notice('Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§!');
                    } catch (error) {
                        console.error('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®:', error);
                        new Notice('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                    }
                }
            };
            fileInput.click();
        };

        // ÎãµÎ≥Ä
        qDiv.createEl('label', { text: 'Ï†ïÎãµ', cls: 'lp-qc-label' });
        const answerInput = qDiv.createEl('textarea', {
            placeholder: 'Ï†ïÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
            cls: 'lp-qc-textarea'
        });
        answerInput.rows = 2;

        // ÌûåÌä∏ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        qDiv.createEl('label', { text: 'ÌûåÌä∏ (ÏÑ†ÌÉù)', cls: 'lp-qc-label' });
        const hintInput = qDiv.createEl('input', {
            type: 'text',
            placeholder: 'ÌûåÌä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
            cls: 'lp-qc-input'
        });

        this.questions.push({
            id: questionId,
            questionEl: questionInput,
            imageEl: imageInput,
            answerEl: answerInput,
            hintEl: hintInput
        });
    }

    updateQuestionNumbers() {
        const items = this.questionsContainer.querySelectorAll('.lp-qc-question');
        items.forEach((item, index) => {
            const numberEl = item.querySelector('.lp-qc-question-number');
            if (numberEl) numberEl.textContent = `ÏßàÎ¨∏ ${index + 1}`;
        });
    }

    async saveQuiz() {
        const subject = this.subjectInput.value.trim();
        const folder = this.folderSelect.value;
        const difficulty = this.difficultySelect.value;

        if (!subject) {
            new Notice('ÌÄ¥Ï¶à Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
            return;
        }

        const questions = this.questions
            .map(q => ({
                question: q.questionEl.value.trim(),
                image: q.imageEl.value.trim(),
                answer: q.answerEl.value.trim(),
                hint: q.hintEl.value.trim()
            }))
            .filter(q => q.question && q.answer);

        if (questions.length === 0) {
            new Notice('ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò ÏßàÎ¨∏Í≥º ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
            return;
        }

        const quizId = 'quiz_' + Date.now();
        const quiz = {
            id: quizId,
            subject,
            folder,
            difficulty,
            questions,
            createdAt: Date.now()
        };

        this.plugin.settings.quizzes[quizId] = quiz;
        this.plugin.settings.stats.totalQuizzes++;
        await this.plugin.saveSettings();

        new Notice(`‚úÖ "${subject}" ÌÄ¥Ï¶àÍ∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§! (${questions.length}Í∞ú Î¨∏Ï†ú)`);
        this.close();

        // Î∑∞ ÏÉàÎ°úÍ≥†Ïπ®
        const leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE);
        if (leaves.length > 0 && leaves[0].view instanceof LearningPlannerView) {
            leaves[0].view.onOpen();
        }
    }

    addQuizCreatorStyles() {
        if (document.getElementById('lp-qc-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-qc-styles';
        styleEl.textContent = `
            .lp-quiz-creator {
                padding: 20px;
                max-width: 700px;
            }

            .lp-quiz-creator h2 {
                margin-bottom: 20px;
                color: var(--text-normal);
            }

            .lp-qc-section-title {
                margin: 25px 0 15px 0;
                color: var(--text-normal);
            }

            .lp-qc-info-section {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }

            .lp-qc-info-section .lp-qc-form-group:first-child {
                grid-column: 1 / -1;
            }

            .lp-qc-form-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .lp-qc-form-group label,
            .lp-qc-label {
                font-weight: 600;
                color: var(--text-normal);
                font-size: 0.95em;
            }

            .lp-qc-input,
            .lp-qc-select,
            .lp-qc-textarea {
                padding: 10px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 6px;
                background: var(--background-primary);
                color: var(--text-normal);
                font-family: inherit;
                font-size: 0.95em;
            }

            .lp-qc-textarea {
                resize: vertical;
                min-height: 60px;
            }

            .lp-qc-input:focus,
            .lp-qc-select:focus,
            .lp-qc-textarea:focus {
                outline: none;
                border-color: var(--interactive-accent);
            }

            .lp-qc-questions {
                display: flex;
                flex-direction: column;
                gap: 15px;
                margin-bottom: 20px;
                max-height: 400px;
                overflow-y: auto;
                padding-right: 5px;
            }

            .lp-qc-question {
                background: var(--background-secondary);
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid var(--interactive-accent);
            }

            .lp-qc-question-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .lp-qc-question-number {
                font-weight: 600;
                color: var(--text-normal);
            }

            .lp-qc-btn-delete-q {
                padding: 5px 10px;
                background: #f44336;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }

            .lp-qc-btn-delete-q:hover {
                background: #da190b;
            }

            .lp-qc-label {
                display: block;
                margin: 12px 0 6px 0;
            }

            .lp-qc-label:first-of-type {
                margin-top: 0;
            }

            .lp-qc-btn-add {
                width: 100%;
                padding: 12px;
                background: var(--interactive-accent);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                margin-bottom: 20px;
            }

            .lp-qc-btn-add:hover {
                background: var(--interactive-accent-hover);
            }

            .lp-qc-actions {
                display: flex;
                gap: 10px;
            }

            .lp-qc-btn-save,
            .lp-qc-btn-cancel {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                font-size: 1em;
            }

            .lp-qc-btn-save {
                background: #4CAF50;
                color: white;
            }

            .lp-qc-btn-save:hover {
                background: #45a049;
            }

            .lp-qc-btn-cancel {
                background: var(--background-secondary);
                color: var(--text-normal);
                border: 1px solid var(--background-modifier-border);
            }

            .lp-qc-btn-cancel:hover {
                background: var(--background-modifier-hover);
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== Timer ÌÅ¥ÎûòÏä§ ====================
class QuizTimer {
    constructor(container, duration, onWarning, onExpire) {
        this.container = container;
        this.duration = duration;
        this.remaining = duration;
        this.onWarning = onWarning;
        this.onExpire = onExpire;
        this.interval = null;
        this.timerEl = null;
    }

    create() {
        this.timerEl = this.container.createDiv({ cls: 'lp-timer' });
        this.update();
    }

    start() {
        if (this.interval) return;
        
        this.interval = setInterval(() => {
            this.remaining--;
            this.update();

            if (this.remaining <= 5 && this.onWarning) {
                this.onWarning(this.remaining);
            }

            if (this.remaining <= 0) {
                this.stop();
                if (this.onExpire) this.onExpire();
            }
        }, 1000);
    }

    stop() {
        if (this.interval) {
            clearInterval(this.interval);
            this.interval = null;
        }
    }

    update() {
        if (!this.timerEl) return;

        const minutes = Math.floor(this.remaining / 60);
        const seconds = this.remaining % 60;
        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        this.timerEl.innerHTML = `
            <div class="lp-timer-icon">‚è±Ô∏è</div>
            <div class="lp-timer-value">${timeStr}</div>
        `;

        if (this.remaining <= 5) {
            this.timerEl.addClass('lp-timer-warning');
        } else {
            this.timerEl.removeClass('lp-timer-warning');
        }
    }

    destroy() {
        this.stop();
        if (this.timerEl) this.timerEl.remove();
    }
}

// ==================== QuizModal ÌÅ¥ÎûòÏä§ ====================
class QuizModal extends Modal {
    constructor(app, plugin, quizId = null, folder = null) {
        super(app);
        this.plugin = plugin;
        this.quizId = quizId;
        this.folder = folder;
        this.currentIndex = 0;
        this.questions = [];
        this.userAnswers = [];
        this.startTime = Date.now();
        this.timer = null;
        this.revealed = false;
        
        // Î™®Î∞îÏùº Ïä§ÏôÄÏù¥ÌîÑÎ•º ÏúÑÌïú Î≥ÄÏàò
        this.touchStartX = 0;
        this.touchEndX = 0;
        this.touchStartY = 0;
        this.touchEndY = 0;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-quiz-modal');

        this.loadQuestions();

        if (this.questions.length === 0) {
            contentEl.createDiv({ 
                cls: 'lp-quiz-empty',
                text: 'Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§' 
            });
            return;
        }

        this.renderQuestion();
        this.addQuizStyles();
    }

    loadQuestions() {
        if (this.folder === '‚≠ê Î∂ÅÎßàÌÅ¨') {
            // Î∂ÅÎßàÌÅ¨Îêú Î¨∏Ï†úÎì§ Î°úÎìú
            this.plugin.settings.bookmarks.forEach(bookmark => {
                const quiz = this.plugin.settings.quizzes[bookmark.quizId];
                if (quiz && quiz.questions[bookmark.questionIndex]) {
                    this.questions.push({
                        ...quiz.questions[bookmark.questionIndex],
                        quizId: bookmark.quizId,
                        questionIndex: bookmark.questionIndex,
                        folder: quiz.folder,
                        difficulty: quiz.difficulty
                    });
                }
            });
        } else if (this.quizId) {
            // ÌäπÏ†ï ÌÄ¥Ï¶à
            const quiz = this.plugin.settings.quizzes[this.quizId];
            if (quiz) {
                this.questions = quiz.questions.map((q, i) => ({
                    ...q,
                    quizId: this.quizId,
                    questionIndex: i,
                    folder: quiz.folder,
                    difficulty: quiz.difficulty
                }));
            }
        }

        // ÏÖîÌîå
        if (this.plugin.settings.shuffleQuestions) {
            this.questions = this.shuffleArray(this.questions);
        }
    }

    renderQuestion() {
        const { contentEl } = this;
        contentEl.empty();

        const question = this.questions[this.currentIndex];

        // Ìó§Îçî
        const header = contentEl.createDiv({ cls: 'lp-quiz-header' });
        
        const progress = header.createDiv({ cls: 'lp-quiz-progress' });
        progress.createEl('span', { 
            text: `${this.currentIndex + 1} / ${this.questions.length}`,
            cls: 'lp-quiz-progress-text'
        });

        const progressBar = progress.createDiv({ cls: 'lp-quiz-progress-bar' });
        const progressFill = progressBar.createDiv({ cls: 'lp-quiz-progress-fill' });
        progressFill.style.width = `${((this.currentIndex + 1) / this.questions.length) * 100}%`;

        // Î∂ÅÎßàÌÅ¨ Î≤ÑÌäº
        const bookmarkBtn = header.createEl('button', {
            text: this.plugin.isBookmarked(question.quizId, question.questionIndex) ? '‚≠ê' : '‚òÜ',
            cls: 'lp-quiz-bookmark-btn'
        });
        bookmarkBtn.onclick = async () => {
            const isBookmarked = this.plugin.toggleBookmark(question.quizId, question.questionIndex);
            await this.plugin.saveSettings();
            bookmarkBtn.textContent = isBookmarked ? '‚≠ê' : '‚òÜ';
            new Notice(isBookmarked ? 'Î∂ÅÎßàÌÅ¨Ïóê Ï∂îÍ∞ÄÎê®' : 'Î∂ÅÎßàÌÅ¨ÏóêÏÑú Ï†úÍ±∞Îê®');
        };

        // TTS Î≤ÑÌäº Ï∂îÍ∞Ä (quiz-sp2 Í∏∞Îä• ÌÜµÌï©)
        const ttsBtn = header.createEl('button', {
            text: 'üîä',
            cls: 'lp-quiz-tts-btn'
        });
        ttsBtn.title = 'ÏßàÎ¨∏ ÏùΩÍ∏∞';
        ttsBtn.onclick = () => {
            this.plugin.speakText(question.question);
        };

        // ÌÉÄÏù¥Î®∏
        if (this.plugin.settings.enableTimer) {
            const timerContainer = header.createDiv({ cls: 'lp-quiz-timer-container' });
            this.timer = new QuizTimer(
                timerContainer,
                this.plugin.settings.defaultTimerDuration,
                (remaining) => {
                    // Í≤ΩÍ≥†
                },
                () => {
                    new Notice('‚è∞ ÏãúÍ∞Ñ Ï¥àÍ≥º!');
                    this.revealAnswer();
                }
            );
            this.timer.create();
            if (this.plugin.settings.autoStartTimer) {
                this.timer.start();
            }
        }

        // ÏßàÎ¨∏ ÏòÅÏó≠
        const questionArea = contentEl.createDiv({ cls: 'lp-quiz-question-area' });

        // ÌÉúÍ∑∏Îì§
        const tags = questionArea.createDiv({ cls: 'lp-quiz-tags' });
        if (question.folder) {
            tags.createEl('span', { 
                text: question.folder,
                cls: 'lp-quiz-tag lp-quiz-tag-folder'
            });
        }
        if (question.difficulty) {
            const diffTag = tags.createEl('span', { 
                text: question.difficulty,
                cls: 'lp-quiz-tag lp-quiz-tag-difficulty'
            });
            diffTag.setAttribute('data-difficulty', question.difficulty);
        }

        // ÏßàÎ¨∏ ÌÖçÏä§Ìä∏
        questionArea.createEl('div', { 
            text: question.question,
            cls: 'lp-quiz-question-text'
        });

        // Ïù¥ÎØ∏ÏßÄ
        if (question.image) {
            this.renderImage(questionArea, question.image);
        }

        // ÎãµÎ≥Ä ÏòÅÏó≠
        const answerArea = contentEl.createDiv({ cls: 'lp-quiz-answer-area' });
        
        this.answerInput = answerArea.createEl('textarea', {
            placeholder: 'ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...',
            cls: 'lp-quiz-answer-input'
        });
        this.answerInput.rows = 3;

        // Ï†ïÎãµ ÌëúÏãú ÏòÅÏó≠ (Ïà®ÍπÄ)
        this.correctAnswerDiv = answerArea.createDiv({ cls: 'lp-quiz-correct-answer' });
        this.correctAnswerDiv.style.display = 'none';

        // ÌûåÌä∏
        if (question.hint) {
            const hintDiv = answerArea.createDiv({ cls: 'lp-quiz-hint' });
            hintDiv.innerHTML = `üí° ÌûåÌä∏: <span>${question.hint}</span>`;
        }

        // Ïª®Ìä∏Î°§ Î∞î
        const controlBar = contentEl.createDiv({ cls: 'lp-quiz-control-bar' });

        // Ïù¥Ï†Ñ Î≤ÑÌäº
        const prevBtn = controlBar.createEl('button', {
            text: '‚¨ÖÔ∏è',
            cls: 'lp-control-btn'
        });
        prevBtn.title = 'Ïù¥Ï†Ñ Î¨∏Ï†ú';
        prevBtn.disabled = this.currentIndex === 0;
        prevBtn.onclick = () => {
            if (this.currentIndex > 0) {
                if (this.timer) this.timer.stop();
                this.currentIndex--;
                this.revealed = false;
                this.renderQuestion();
            }
        };

        // ÏùºÏãúÏ†ïÏßÄ Î≤ÑÌäº
        const pauseBtn = controlBar.createEl('button', {
            text: this.isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è',
            cls: 'lp-control-btn'
        });
        pauseBtn.title = this.isPaused ? 'Ïû¨Í∞ú' : 'ÏùºÏãúÏ†ïÏßÄ';
        pauseBtn.onclick = () => {
            this.isPaused = !this.isPaused;
            if (this.timer) {
                if (this.isPaused) {
                    this.timer.stop();
                } else {
                    this.timer.start();
                }
            }
            pauseBtn.setText(this.isPaused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è');
            pauseBtn.title = this.isPaused ? 'Ïû¨Í∞ú' : 'ÏùºÏãúÏ†ïÏßÄ';
        };

        // Ìé∏Ïßë Î≤ÑÌäº
        const editBtn = controlBar.createEl('button', {
            text: '‚úèÔ∏è',
            cls: 'lp-control-btn'
        });
        editBtn.title = 'Î¨∏Ï†ú Ìé∏Ïßë';
        editBtn.onclick = () => {
            if (this.timer) this.timer.stop();
            new QuizEditModal(this.app, this.plugin, question.quizId, question.questionIndex).open();
        };

        // ÏÇ≠Ï†ú Î≤ÑÌäº
        const deleteBtn = controlBar.createEl('button', {
            text: 'üóëÔ∏è',
            cls: 'lp-control-btn lp-control-btn-delete'
        });
        deleteBtn.title = 'Î¨∏Ï†ú ÏÇ≠Ï†ú';
        deleteBtn.onclick = async () => {
            if (confirm(`"${question.question}" Î¨∏Ï†úÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                if (this.timer) this.timer.stop();
                
                const quiz = this.plugin.settings.quizzes[question.quizId];
                if (quiz) {
                    quiz.questions.splice(question.questionIndex, 1);
                    await this.plugin.saveSettings();
                    
                    this.questions.splice(this.currentIndex, 1);
                    
                    if (this.questions.length === 0) {
                        new Notice('Î™®Îì† Î¨∏Ï†úÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                        this.close();
                        return;
                    }
                    
                    if (this.currentIndex >= this.questions.length) {
                        this.currentIndex = this.questions.length - 1;
                    }
                    
                    this.revealed = false;
                    this.renderQuestion();
                    new Notice('Î¨∏Ï†úÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                }
            }
        };

        // Îã§Ïùå Î≤ÑÌäº
        const nextBtn = controlBar.createEl('button', {
            text: '‚û°Ô∏è',
            cls: 'lp-control-btn'
        });
        nextBtn.title = 'Îã§Ïùå Î¨∏Ï†ú';
        nextBtn.disabled = this.currentIndex >= this.questions.length - 1;
        nextBtn.onclick = () => {
            if (this.currentIndex < this.questions.length - 1) {
                if (this.timer) this.timer.stop();
                this.currentIndex++;
                this.revealed = false;
                this.renderQuestion();
            }
        };

        // Ïï°ÏÖò Î≤ÑÌäº
        const actions = contentEl.createDiv({ cls: 'lp-quiz-actions' });

        this.revealBtn = actions.createEl('button', {
            text: 'üëÅÔ∏è Ï†ïÎãµ Î≥¥Í∏∞',
            cls: 'lp-quiz-btn lp-quiz-btn-reveal'
        });
        this.revealBtn.onclick = () => this.revealAnswer();

        this.checkBtn = actions.createEl('button', {
            text: '‚úì ÌôïÏù∏',
            cls: 'lp-quiz-btn lp-quiz-btn-check'
        });
        this.checkBtn.onclick = () => this.checkAnswer();

        const completeBtn = actions.createEl('button', {
            text: this.currentIndex < this.questions.length - 1 ? 'Îã§Ïùå Î¨∏Ï†ú' : 'ÌÄ¥Ï¶à ÏôÑÎ£å',
            cls: 'lp-quiz-btn lp-quiz-btn-next'
        });
        completeBtn.onclick = () => this.nextQuestion();
        
        // Î™®Î∞îÏùº Ïä§ÏôÄÏù¥ÌîÑ ÏßÄÏõê
        this.addSwipeSupport(contentEl);
    }
    
    addSwipeSupport(element) {
        // ÌÑ∞Ïπò ÏãúÏûë
        element.addEventListener('touchstart', (e) => {
            this.touchStartX = e.changedTouches[0].screenX;
            this.touchStartY = e.changedTouches[0].screenY;
        }, { passive: true });
        
        // ÌÑ∞Ïπò Ï¢ÖÎ£å
        element.addEventListener('touchend', (e) => {
            this.touchEndX = e.changedTouches[0].screenX;
            this.touchEndY = e.changedTouches[0].screenY;
            this.handleSwipe();
        }, { passive: true });
    }
    
    handleSwipe() {
        const deltaX = this.touchEndX - this.touchStartX;
        const deltaY = this.touchEndY - this.touchStartY;
        const minSwipeDistance = 50; // ÏµúÏÜå Ïä§ÏôÄÏù¥ÌîÑ Í±∞Î¶¨
        
        // ÏàòÌèâ Ïä§ÏôÄÏù¥ÌîÑÍ∞Ä ÏàòÏßÅÎ≥¥Îã§ ÌÅ¥ ÎïåÎßå Ï≤òÎ¶¨
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > minSwipeDistance) {
            if (deltaX > 0) {
                // Ïò§Î•∏Ï™Ω Ïä§ÏôÄÏù¥ÌîÑ = Ïù¥Ï†Ñ Î¨∏Ï†ú
                if (this.currentIndex > 0) {
                    if (this.timer) this.timer.stop();
                    this.currentIndex--;
                    this.revealed = false;
                    this.renderQuestion();
                    new Notice('‚¨ÖÔ∏è Ïù¥Ï†Ñ Î¨∏Ï†ú');
                }
            } else {
                // ÏôºÏ™Ω Ïä§ÏôÄÏù¥ÌîÑ = Îã§Ïùå Î¨∏Ï†ú
                if (this.currentIndex < this.questions.length - 1) {
                    if (this.timer) this.timer.stop();
                    this.currentIndex++;
                    this.revealed = false;
                    this.renderQuestion();
                    new Notice('‚û°Ô∏è Îã§Ïùå Î¨∏Ï†ú');
                } else {
                    new Notice('ÎßàÏßÄÎßâ Î¨∏Ï†úÏûÖÎãàÎã§');
                }
            }
        }
    }

    renderImage(container, imageUrl) {
        const imageDiv = container.createDiv({ cls: 'lp-quiz-image-container' });

        let finalUrl = imageUrl;

        // ÏúÑÌÇ§ÎßÅÌÅ¨ Ï≤òÎ¶¨
        if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
            const match = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
            if (match && match[1]) {
                let imagePath = match[1];
                
                // Í≤ΩÎ°ú Ï≤òÎ¶¨
                if (!imagePath.includes('/')) {
                    imagePath = `${this.plugin.settings.learningFolder}/${this.plugin.settings.attachmentFolderName}/${imagePath}`;
                }

                const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                if (imageFile) {
                    finalUrl = this.app.vault.adapter.getResourcePath(imagePath);
                } else {
                    finalUrl = this.app.vault.adapter.getResourcePath(imagePath);
                }
            }
        }

        const img = imageDiv.createEl('img', {
            attr: { src: finalUrl, alt: 'Î¨∏Ï†ú Ïù¥ÎØ∏ÏßÄ' },
            cls: 'lp-quiz-image'
        });

        img.onerror = () => {
            imageDiv.innerHTML = '<div class="lp-quiz-image-error">‚ö†Ô∏è Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</div>';
        };
    }

    revealAnswer() {
        if (this.revealed) return;
        this.revealed = true;

        const question = this.questions[this.currentIndex];
        
        this.correctAnswerDiv.innerHTML = `
            <div class="lp-quiz-correct-label">‚úÖ Ï†ïÎãµ</div>
            <div class="lp-quiz-correct-text">${question.answer}</div>
        `;
        this.correctAnswerDiv.style.display = 'block';

        this.revealBtn.disabled = true;
        this.revealBtn.style.opacity = '0.5';

        if (this.timer) this.timer.stop();
    }

    checkAnswer() {
        const userAnswer = this.answerInput.value.trim();
        if (!userAnswer) {
            new Notice('ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
            return;
        }

        this.revealAnswer();

        const question = this.questions[this.currentIndex];
        const isCorrect = userAnswer.toLowerCase() === question.answer.toLowerCase();

        // ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
        const timeSpent = this.timer ? 
            (this.plugin.settings.defaultTimerDuration - this.timer.remaining) : 
            Math.floor((Date.now() - this.startTime) / 1000);

        this.plugin.updateStats(
            question.quizId,
            isCorrect,
            timeSpent,
            question.folder || 'Í∏∞Î≥∏',
            question.difficulty || this.plugin.settings.defaultDifficulty
        );

        this.userAnswers.push({
            question: question.question,
            userAnswer,
            correctAnswer: question.answer,
            isCorrect,
            timeSpent
        });

        // ÌîºÎìúÎ∞± ÌëúÏãú
        this.showFeedback(isCorrect, question);
    }

    showFeedback(isCorrect, question) {
        const feedbackOverlay = this.contentEl.createDiv({ cls: 'lp-feedback-overlay' });
        
        const feedbackBox = feedbackOverlay.createDiv({ cls: 'lp-feedback-box' });
        feedbackBox.addClass(isCorrect ? 'lp-feedback-correct' : 'lp-feedback-wrong');

        const icon = feedbackBox.createEl('div', {
            text: isCorrect ? '‚úÖ' : '‚ùå',
            cls: 'lp-feedback-icon'
        });

        const message = feedbackBox.createEl('h2', {
            text: isCorrect ? 'Ï†ïÎãµÏûÖÎãàÎã§!' : 'ÌãÄÎ†∏ÏäµÎãàÎã§!',
            cls: 'lp-feedback-message'
        });

        // Ïò§ÎãµÏùº Îïå ÌûåÌä∏ ÌëúÏãú
        if (!isCorrect && question.hint && this.plugin.settings.showHintAfterWrong) {
            const hintDiv = feedbackBox.createDiv({ cls: 'lp-feedback-hint' });
            hintDiv.innerHTML = `üí° ÌûåÌä∏: <span>${question.hint}</span>`;
        }

        // ÏûêÎèôÏúºÎ°ú ÏÇ¨ÎùºÏßÄÍ∏∞
        setTimeout(() => {
            feedbackOverlay.remove();
        }, 1500);

        if (isCorrect) {
            new Notice('‚úÖ Ï†ïÎãµÏûÖÎãàÎã§!');
        } else {
            new Notice('‚ùå ÌãÄÎ†∏ÏäµÎãàÎã§');
        }
    }

    async nextQuestion() {
        if (this.currentIndex < this.questions.length - 1) {
            this.currentIndex++;
            this.revealed = false;
            if (this.timer) this.timer.destroy();
            this.renderQuestion();
        } else {
            // ÌÄ¥Ï¶à ÏôÑÎ£å
            await this.plugin.saveSettings();
            this.showResults();
        }
    }

    showResults() {
        const { contentEl } = this;
        contentEl.empty();

        const resultsDiv = contentEl.createDiv({ cls: 'lp-quiz-results' });

        resultsDiv.createEl('h2', { text: 'üéâ ÌÄ¥Ï¶à ÏôÑÎ£å!' });

        const correct = this.userAnswers.filter(a => a.isCorrect).length;
        const total = this.userAnswers.length;
        const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;

        const summary = resultsDiv.createDiv({ cls: 'lp-quiz-results-summary' });
        summary.innerHTML = `
            <div class="lp-quiz-result-stat">
                <div class="lp-quiz-result-label">Ï†ïÎãµ</div>
                <div class="lp-quiz-result-value">${correct} / ${total}</div>
            </div>
            <div class="lp-quiz-result-stat">
                <div class="lp-quiz-result-label">Ï†ïÎãµÎ•†</div>
                <div class="lp-quiz-result-value">${accuracy}%</div>
            </div>
        `;

        const closeBtn = resultsDiv.createEl('button', {
            text: 'Îã´Í∏∞',
            cls: 'lp-quiz-btn lp-quiz-btn-close'
        });
        closeBtn.onclick = () => this.close();
    }

    shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    addQuizStyles() {
        if (document.getElementById('lp-quiz-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-quiz-styles';
        styleEl.textContent = `
            .lp-quiz-modal {
                padding: 20px;
                max-width: 800px;
            }

            .lp-quiz-control-bar {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-bottom: 20px;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 10px;
            }

            .lp-control-btn {
                padding: 10px 15px;
                background: var(--background-primary);
                border: 2px solid var(--background-modifier-border);
                border-radius: 6px;
                cursor: pointer;
                font-size: 1.2em;
                transition: all 0.2s;
            }

            .lp-control-btn:hover:not(:disabled) {
                background: var(--background-modifier-hover);
                border-color: var(--interactive-accent);
                transform: translateY(-2px);
            }

            .lp-control-btn:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }

            .lp-control-btn-delete {
                border-color: #f44336;
                color: #f44336;
            }

            .lp-control-btn-delete:hover:not(:disabled) {
                background: #f44336;
                color: white;
            }

            .lp-feedback-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 2000;
                animation: fadeIn 0.2s;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            .lp-feedback-box {
                padding: 40px;
                border-radius: 15px;
                text-align: center;
                max-width: 500px;
                animation: scaleIn 0.3s;
            }

            @keyframes scaleIn {
                from { transform: scale(0.8); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
            }

            .lp-feedback-correct {
                background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            }

            .lp-feedback-wrong {
                background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
            }

            .lp-feedback-icon {
                font-size: 60px;
                margin-bottom: 15px;
                animation: bounce 0.5s;
            }

            @keyframes bounce {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-20px); }
            }

            .lp-feedback-message {
                color: white;
                font-size: 28px;
                margin: 0 0 15px 0;
            }

            .lp-feedback-hint {
                background: rgba(0, 0, 0, 0.3);
                padding: 15px;
                border-radius: 8px;
                color: white;
                font-size: 16px;
                margin-top: 15px;
            }

            .lp-quiz-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid var(--background-modifier-border);
            }

            .lp-quiz-progress {
                flex: 1;
            }

            .lp-quiz-progress-text {
                font-weight: 600;
                color: var(--text-muted);
                margin-bottom: 8px;
                display: block;
            }

            .lp-quiz-progress-bar {
                height: 8px;
                background: var(--background-secondary);
                border-radius: 4px;
                overflow: hidden;
            }

            .lp-quiz-progress-fill {
                height: 100%;
                background: linear-gradient(90deg, var(--interactive-accent) 0%, #45a049 100%);
                transition: width 0.3s ease;
            }

            .lp-quiz-bookmark-btn {
                padding: 8px 15px;
                background: transparent;
                border: 2px solid var(--background-modifier-border);
                border-radius: 6px;
                cursor: pointer;
                font-size: 1.2em;
                margin-left: 15px;
            }

            .lp-quiz-bookmark-btn:hover {
                border-color: #FFD700;
                background: rgba(255, 215, 0, 0.1);
            }

            .lp-quiz-timer-container {
                margin-left: 15px;
            }

            .lp-timer {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px 15px;
                background: var(--background-secondary);
                border-radius: 6px;
                border: 2px solid var(--background-modifier-border);
            }

            .lp-timer-icon {
                font-size: 1.2em;
            }

            .lp-timer-value {
                font-weight: 600;
                font-size: 1.1em;
                font-family: monospace;
                color: var(--text-normal);
            }

            .lp-timer-warning {
                border-color: #f44336;
                animation: pulse 1s infinite;
            }

            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }

            .lp-quiz-question-area {
                margin-bottom: 25px;
            }

            .lp-quiz-tags {
                display: flex;
                gap: 8px;
                margin-bottom: 15px;
            }

            .lp-quiz-tag {
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 500;
            }

            .lp-quiz-tag-folder {
                background: var(--background-secondary);
                color: var(--text-muted);
            }

            .lp-quiz-tag-difficulty[data-difficulty="Ïâ¨ÏõÄ"] {
                background: #4CAF50;
                color: white;
            }

            .lp-quiz-tag-difficulty[data-difficulty="Î≥¥ÌÜµ"] {
                background: #2196F3;
                color: white;
            }

            .lp-quiz-tag-difficulty[data-difficulty="Ïñ¥Î†§ÏõÄ"] {
                background: #FF9800;
                color: white;
            }

            .lp-quiz-tag-difficulty[data-difficulty="Îß§Ïö∞ Ïñ¥Î†§ÏõÄ"] {
                background: #F44336;
                color: white;
            }

            .lp-quiz-question-text {
                font-size: 1.3em;
                font-weight: 500;
                line-height: 1.6;
                color: var(--text-normal);
                margin-bottom: 15px;
            }

            .lp-quiz-image-container {
                margin: 15px 0;
                text-align: center;
            }

            .lp-quiz-image {
                max-width: 100%;
                max-height: 400px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .lp-quiz-image-error {
                padding: 20px;
                color: var(--text-muted);
                background: var(--background-secondary);
                border-radius: 8px;
            }

            .lp-quiz-answer-area {
                margin-bottom: 20px;
            }

            .lp-quiz-answer-input {
                width: 100%;
                padding: 12px;
                border: 2px solid var(--background-modifier-border);
                border-radius: 8px;
                background: var(--background-primary);
                color: var(--text-normal);
                font-family: inherit;
                font-size: 1em;
                resize: vertical;
                margin-bottom: 15px;
            }

            .lp-quiz-answer-input:focus {
                outline: none;
                border-color: var(--interactive-accent);
            }

            .lp-quiz-correct-answer {
                padding: 15px;
                background: #e8f5e9;
                border-left: 4px solid #4CAF50;
                border-radius: 6px;
                margin-bottom: 15px;
            }

            .lp-quiz-correct-label {
                font-weight: 600;
                color: #2e7d32;
                margin-bottom: 8px;
            }

            .lp-quiz-correct-text {
                font-size: 1.1em;
                color: #1b5e20;
            }

            .lp-quiz-hint {
                padding: 12px;
                background: var(--background-secondary);
                border-left: 4px solid #2196F3;
                border-radius: 6px;
                color: var(--text-muted);
                font-size: 0.95em;
            }

            .lp-quiz-actions {
                display: flex;
                gap: 10px;
            }

            .lp-quiz-btn {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                font-size: 1em;
                transition: all 0.2s;
            }

            .lp-quiz-btn-reveal {
                background: var(--background-secondary);
                color: var(--text-normal);
                border: 2px solid var(--background-modifier-border);
            }

            .lp-quiz-btn-reveal:hover:not(:disabled) {
                background: var(--background-modifier-hover);
            }

            .lp-quiz-btn-check {
                background: #2196F3;
                color: white;
            }

            .lp-quiz-btn-check:hover {
                background: #1976D2;
            }

            .lp-quiz-btn-next {
                background: #4CAF50;
                color: white;
            }

            .lp-quiz-btn-next:hover {
                background: #45a049;
            }

            .lp-quiz-results {
                text-align: center;
                padding: 40px 20px;
            }

            .lp-quiz-results h2 {
                margin-bottom: 30px;
                font-size: 2em;
                color: var(--text-normal);
            }

            .lp-quiz-results-summary {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                margin-bottom: 30px;
            }

            .lp-quiz-result-stat {
                padding: 20px;
                background: var(--background-secondary);
                border-radius: 10px;
            }

            .lp-quiz-result-label {
                color: var(--text-muted);
                margin-bottom: 10px;
            }

            .lp-quiz-result-value {
                font-size: 2em;
                font-weight: bold;
                color: var(--interactive-accent);
            }

            .lp-quiz-btn-close {
                padding: 12px 40px;
                background: var(--interactive-accent);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                font-size: 1em;
            }

            .lp-quiz-btn-close:hover {
                background: var(--interactive-accent-hover);
            }

            .lp-quiz-empty {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-muted);
                font-size: 1.2em;
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        if (this.timer) this.timer.destroy();
        this.contentEl.empty();
    }
}

// ==================== QuizListEditModal ÌÅ¥ÎûòÏä§ ====================
class QuizListEditModal extends Modal {
    constructor(app, plugin, quizId) {
        super(app);
        this.plugin = plugin;
        this.quizId = quizId;
        this.quiz = this.plugin.settings.quizzes[quizId];
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-quiz-list-edit');

        contentEl.createEl('h2', { text: `‚úèÔ∏è "${this.quiz.subject}" Ìé∏Ïßë` });

        // ÌÄ¥Ï¶à Ï†ïÎ≥¥
        const infoSection = contentEl.createDiv({ cls: 'lp-qle-info' });

        const titleGroup = infoSection.createDiv({ cls: 'lp-qle-group' });
        titleGroup.createEl('label', { text: 'ÌÄ¥Ï¶à Ï†úÎ™©' });
        this.titleInput = titleGroup.createEl('input', {
            type: 'text',
            cls: 'lp-qle-input'
        });
        this.titleInput.value = this.quiz.subject || '';

        const folderGroup = infoSection.createDiv({ cls: 'lp-qle-group' });
        folderGroup.createEl('label', { text: 'Ìè¥Îçî' });
        this.folderSelect = folderGroup.createEl('select', { cls: 'lp-qle-select' });
        this.plugin.settings.questionFolders.forEach(folder => {
            const option = this.folderSelect.createEl('option', { 
                text: folder, 
                value: folder 
            });
            if (folder === this.quiz.folder) option.selected = true;
        });

        const diffGroup = infoSection.createDiv({ cls: 'lp-qle-group' });
        diffGroup.createEl('label', { text: 'ÎÇúÏù¥ÎèÑ' });
        this.diffSelect = diffGroup.createEl('select', { cls: 'lp-qle-select' });
        this.plugin.settings.difficulties.forEach(diff => {
            const option = this.diffSelect.createEl('option', { 
                text: diff, 
                value: diff 
            });
            if (diff === this.quiz.difficulty) option.selected = true;
        });

        // Î¨∏Ï†ú Î™©Î°ù
        contentEl.createEl('h3', { text: 'Î¨∏Ï†ú Î™©Î°ù' });
        const questionList = contentEl.createDiv({ cls: 'lp-qle-questions' });

        this.quiz.questions.forEach((q, index) => {
            const item = questionList.createDiv({ cls: 'lp-qle-question-item' });

            const info = item.createDiv({ cls: 'lp-qle-question-info' });
            info.createEl('div', { 
                text: `${index + 1}. ${q.question}`,
                cls: 'lp-qle-question-text'
            });
            info.createEl('div', { 
                text: `Ï†ïÎãµ: ${q.answer}`,
                cls: 'lp-qle-answer-text'
            });

            const actions = item.createDiv({ cls: 'lp-qle-question-actions' });

            const editBtn = actions.createEl('button', {
                text: '‚úèÔ∏è',
                cls: 'lp-qle-btn-edit'
            });
            editBtn.onclick = () => {
                this.close();
                new QuizEditModal(this.app, this.plugin, this.quizId, index).open();
            };

            const deleteBtn = actions.createEl('button', {
                text: 'üóëÔ∏è',
                cls: 'lp-qle-btn-delete'
            });
            deleteBtn.onclick = async () => {
                if (confirm(`Î¨∏Ï†ú ${index + 1}ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    this.quiz.questions.splice(index, 1);
                    await this.plugin.saveSettings();
                    this.onOpen();
                    new Notice('Î¨∏Ï†úÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                }
            };
        });

        // Î≤ÑÌäº
        const actions = contentEl.createDiv({ cls: 'lp-qle-actions' });

        const saveBtn = actions.createEl('button', {
            text: 'üíæ Ï†ÄÏû•',
            cls: 'lp-qle-btn-save'
        });
        saveBtn.onclick = () => this.save();

        const cancelBtn = actions.createEl('button', {
            text: 'Ï∑®ÏÜå',
            cls: 'lp-qle-btn-cancel'
        });
        cancelBtn.onclick = () => this.close();

        this.addQuizListEditStyles();
    }

    async save() {
        const title = this.titleInput.value.trim();
        if (!title) {
            new Notice('ÌÄ¥Ï¶à Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
            return;
        }

        this.quiz.subject = title;
        this.quiz.folder = this.folderSelect.value;
        this.quiz.difficulty = this.diffSelect.value;

        await this.plugin.saveSettings();
        new Notice('‚úÖ ÌÄ¥Ï¶àÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
        this.close();

        // Î∑∞ ÏÉàÎ°úÍ≥†Ïπ®
        const leaves = this.app.workspace.getLeavesOfType(VIEW_TYPE);
        if (leaves.length > 0 && leaves[0].view instanceof LearningPlannerView) {
            leaves[0].view.onOpen();
        }
    }

    addQuizListEditStyles() {
        if (document.getElementById('lp-qle-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-qle-styles';
        styleEl.textContent = `
            .lp-quiz-list-edit {
                padding: 20px;
                max-width: 700px;
            }

            .lp-quiz-list-edit h2 {
                margin-bottom: 20px;
            }

            .lp-quiz-list-edit h3 {
                margin: 25px 0 15px 0;
            }

            .lp-qle-info {
                display: grid;
                gap: 15px;
                margin-bottom: 20px;
                grid-template-columns: 1fr 1fr;
            }

            .lp-qle-info .lp-qle-group:first-child {
                grid-column: 1 / -1;
            }

            .lp-qle-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .lp-qle-group label {
                font-weight: 600;
                color: var(--text-normal);
            }

            .lp-qle-input,
            .lp-qle-select {
                padding: 10px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 6px;
                background: var(--background-primary);
                color: var(--text-normal);
                font-family: inherit;
            }

            .lp-qle-questions {
                max-height: 400px;
                overflow-y: auto;
                margin-bottom: 20px;
            }

            .lp-qle-question-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
                margin-bottom: 10px;
            }

            .lp-qle-question-info {
                flex: 1;
            }

            .lp-qle-question-text {
                font-weight: 500;
                margin-bottom: 5px;
                color: var(--text-normal);
            }

            .lp-qle-answer-text {
                color: var(--text-muted);
                font-size: 0.9em;
            }

            .lp-qle-question-actions {
                display: flex;
                gap: 8px;
            }

            .lp-qle-btn-edit,
            .lp-qle-btn-delete {
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 1em;
            }

            .lp-qle-btn-edit {
                background: #2196F3;
                color: white;
            }

            .lp-qle-btn-edit:hover {
                background: #1976D2;
            }

            .lp-qle-btn-delete {
                background: #f44336;
                color: white;
            }

            .lp-qle-btn-delete:hover {
                background: #da190b;
            }

            .lp-qle-actions {
                display: flex;
                gap: 10px;
            }

            .lp-qle-btn-save,
            .lp-qle-btn-cancel {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                font-size: 1em;
            }

            .lp-qle-btn-save {
                background: #4CAF50;
                color: white;
            }

            .lp-qle-btn-save:hover {
                background: #45a049;
            }

            .lp-qle-btn-cancel {
                background: var(--background-secondary);
                color: var(--text-normal);
                border: 1px solid var(--background-modifier-border);
            }

            .lp-qle-btn-cancel:hover {
                background: var(--background-modifier-hover);
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== QuizEditModal ÌÅ¥ÎûòÏä§ ====================
class QuizEditModal extends Modal {
    constructor(app, plugin, quizId, questionIndex) {
        super(app);
        this.plugin = plugin;
        this.quizId = quizId;
        this.questionIndex = questionIndex;
        this.quiz = this.plugin.settings.quizzes[quizId];
        this.question = this.quiz.questions[questionIndex];
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-quiz-edit');

        contentEl.createEl('h2', { text: '‚úèÔ∏è Î¨∏Ï†ú Ìé∏Ïßë' });

        // ÏßàÎ¨∏
        const questionGroup = contentEl.createDiv({ cls: 'lp-edit-group' });
        questionGroup.createEl('label', { text: 'ÏßàÎ¨∏' });
        this.questionInput = questionGroup.createEl('textarea', {
            cls: 'lp-edit-textarea'
        });
        this.questionInput.value = this.question.question || '';
        this.questionInput.rows = 3;

        // Ïù¥ÎØ∏ÏßÄ
        const imageGroup = contentEl.createDiv({ cls: 'lp-edit-group' });
        imageGroup.createEl('label', { text: 'Ïù¥ÎØ∏ÏßÄ (ÏÑ†ÌÉù)' });
        this.imageInput = imageGroup.createEl('input', {
            type: 'text',
            placeholder: '![[Ïù¥ÎØ∏ÏßÄ.png]] ÎòêÎäî URL',
            cls: 'lp-edit-input'
        });
        this.imageInput.value = this.question.image || '';

        // ÎãµÎ≥Ä
        const answerGroup = contentEl.createDiv({ cls: 'lp-edit-group' });
        answerGroup.createEl('label', { text: 'Ï†ïÎãµ' });
        this.answerInput = answerGroup.createEl('textarea', {
            cls: 'lp-edit-textarea'
        });
        this.answerInput.value = this.question.answer || '';
        this.answerInput.rows = 2;

        // ÌûåÌä∏
        const hintGroup = contentEl.createDiv({ cls: 'lp-edit-group' });
        hintGroup.createEl('label', { text: 'ÌûåÌä∏ (ÏÑ†ÌÉù)' });
        this.hintInput = hintGroup.createEl('input', {
            type: 'text',
            placeholder: 'ÌûåÌä∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
            cls: 'lp-edit-input'
        });
        this.hintInput.value = this.question.hint || '';

        // Î≤ÑÌäº
        const actions = contentEl.createDiv({ cls: 'lp-edit-actions' });

        const saveBtn = actions.createEl('button', {
            text: 'üíæ Ï†ÄÏû•',
            cls: 'lp-edit-btn-save'
        });
        saveBtn.onclick = () => this.save();

        const cancelBtn = actions.createEl('button', {
            text: 'Ï∑®ÏÜå',
            cls: 'lp-edit-btn-cancel'
        });
        cancelBtn.onclick = () => this.close();

        this.addEditStyles();
    }

    async save() {
        const question = this.questionInput.value.trim();
        const answer = this.answerInput.value.trim();

        if (!question || !answer) {
            new Notice('ÏßàÎ¨∏Í≥º ÎãµÎ≥ÄÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
            return;
        }

        this.question.question = question;
        this.question.image = this.imageInput.value.trim();
        this.question.answer = answer;
        this.question.hint = this.hintInput.value.trim();

        await this.plugin.saveSettings();
        new Notice('‚úÖ Î¨∏Ï†úÍ∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
        this.close();
    }

    addEditStyles() {
        if (document.getElementById('lp-edit-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-edit-styles';
        styleEl.textContent = `
            .lp-quiz-edit {
                padding: 20px;
                max-width: 600px;
            }

            .lp-quiz-edit h2 {
                margin-bottom: 20px;
            }

            .lp-edit-group {
                margin-bottom: 20px;
            }

            .lp-edit-group label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                color: var(--text-normal);
            }

            .lp-edit-input,
            .lp-edit-textarea {
                width: 100%;
                padding: 10px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 6px;
                background: var(--background-primary);
                color: var(--text-normal);
                font-family: inherit;
                font-size: 1em;
            }

            .lp-edit-textarea {
                resize: vertical;
            }

            .lp-edit-input:focus,
            .lp-edit-textarea:focus {
                outline: none;
                border-color: var(--interactive-accent);
            }

            .lp-edit-actions {
                display: flex;
                gap: 10px;
            }

            .lp-edit-btn-save,
            .lp-edit-btn-cancel {
                flex: 1;
                padding: 12px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 500;
                font-size: 1em;
            }

            .lp-edit-btn-save {
                background: #4CAF50;
                color: white;
            }

            .lp-edit-btn-save:hover {
                background: #45a049;
            }

            .lp-edit-btn-cancel {
                background: var(--background-secondary);
                color: var(--text-normal);
                border: 1px solid var(--background-modifier-border);
            }

            .lp-edit-btn-cancel:hover {
                background: var(--background-modifier-hover);
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== QuizListModal ÌÅ¥ÎûòÏä§ ====================
class QuizListModal extends Modal {
    constructor(app, plugin, folder) {
        super(app);
        this.plugin = plugin;
        this.folder = folder;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-quiz-list');

        contentEl.createEl('h2', { text: `üìã ${this.folder} Ìè¥Îçî ÌÄ¥Ï¶à Î™©Î°ù` });

        const quizzes = Object.values(this.plugin.settings.quizzes || {}).filter(q => (q.folder || 'Í∏∞Î≥∏') === this.folder);

        if (quizzes.length === 0) {
            contentEl.createEl('p', { 
                text: 'Ïù¥ Ìè¥ÎçîÏóê ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§.',
                cls: 'lp-empty-message'
            });
            return;
        }

        const listContainer = contentEl.createDiv({ cls: 'lp-quiz-list-container' });
        listContainer.style.cssText = 'max-height: 500px; overflow-y: auto; padding: 10px;';

        quizzes.forEach(quiz => {
            const item = listContainer.createDiv({ cls: 'lp-quiz-item' });
            item.style.cssText = 'padding: 12px; margin-bottom: 8px; background: var(--background-secondary); border-radius: 6px; cursor: pointer; transition: all 0.2s;';
            
            item.addEventListener('mouseenter', () => {
                item.style.background = 'var(--background-modifier-hover)';
                item.style.transform = 'translateX(4px)';
            });
            item.addEventListener('mouseleave', () => {
                item.style.background = 'var(--background-secondary)';
                item.style.transform = 'translateX(0)';
            });

            const titleEl = item.createEl('div', { text: quiz.subject });
            titleEl.style.cssText = 'font-weight: 600; margin-bottom: 4px;';

            const infoEl = item.createEl('div', { text: `Î¨∏Ï†ú: ${quiz.questions?.length || 0}Í∞ú | ÎÇúÏù¥ÎèÑ: ${quiz.difficulty || 'Î≥¥ÌÜµ'}` });
            infoEl.style.cssText = 'font-size: 0.85em; color: var(--text-muted);';

            item.addEventListener('click', () => {
                new QuizModal(this.app, this.plugin, quiz.id).open();
                this.close();
            });
        });

        const btnContainer = contentEl.createDiv();
        btnContainer.style.cssText = 'margin-top: 16px; display: flex; gap: 8px;';

        const newBtn = btnContainer.createEl('button', { text: '‚ûï ÏÉà ÌÄ¥Ï¶à' });
        newBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer;';
        newBtn.addEventListener('click', () => {
            new QuizCreatorModal(this.app, this.plugin).open();
            this.close();
        });

        const closeBtn = btnContainer.createEl('button', { text: 'Îã´Í∏∞' });
        closeBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--background-modifier-border); border: none; border-radius: 6px; cursor: pointer;';
        closeBtn.addEventListener('click', () => this.close());
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== FolderManagementModal ÌÅ¥ÎûòÏä§ ====================
class FolderManagementModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-folder-management');

        contentEl.createEl('h2', { text: 'üìÅ Ìè¥Îçî Í¥ÄÎ¶¨' });

        const folders = this.plugin.settings.questionFolders || ['Í∏∞Î≥∏'];

        const listContainer = contentEl.createDiv({ cls: 'lp-folder-list' });
        listContainer.style.cssText = 'margin: 20px 0; max-height: 400px; overflow-y: auto;';

        folders.forEach(folder => {
            const item = listContainer.createDiv({ cls: 'lp-folder-item' });
            item.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 8px; background: var(--background-secondary); border-radius: 6px;';

            const nameEl = item.createEl('span', { text: `üìÅ ${folder}` });
            nameEl.style.cssText = 'font-weight: 500;';

            if (folder !== 'Í∏∞Î≥∏') {
                const deleteBtn = item.createEl('button', { text: 'üóëÔ∏è' });
                deleteBtn.style.cssText = 'padding: 4px 8px; background: var(--color-red); color: white; border: none; border-radius: 4px; cursor: pointer;';
                deleteBtn.title = 'Ìè¥Îçî ÏÇ≠Ï†ú';
                deleteBtn.addEventListener('click', () => {
                    if (confirm(`"${folder}" Ìè¥ÎçîÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                        this.plugin.settings.questionFolders = this.plugin.settings.questionFolders.filter(f => f !== folder);
                        this.plugin.saveSettings();
                        this.onOpen();
                    }
                });
            }
        });

        const addSection = contentEl.createDiv({ cls: 'lp-add-folder' });
        addSection.style.cssText = 'margin-top: 20px;';

        const inputGroup = addSection.createDiv();
        inputGroup.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';

        const input = inputGroup.createEl('input', {
            type: 'text',
            placeholder: 'ÏÉà Ìè¥Îçî Ïù¥Î¶Ñ'
        });
        input.style.cssText = 'flex: 1; padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;';

        const addBtn = inputGroup.createEl('button', { text: '‚ûï Ï∂îÍ∞Ä' });
        addBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer;';
        addBtn.addEventListener('click', () => {
            const folderName = input.value.trim();
            if (folderName && !folders.includes(folderName)) {
                if (!this.plugin.settings.questionFolders) {
                    this.plugin.settings.questionFolders = ['Í∏∞Î≥∏'];
                }
                this.plugin.settings.questionFolders.push(folderName);
                this.plugin.saveSettings();
                input.value = '';
                this.onOpen();
            } else if (folders.includes(folderName)) {
                new Notice('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ìè¥Îçî Ïù¥Î¶ÑÏûÖÎãàÎã§.');
            }
        });

        const closeBtn = contentEl.createEl('button', { text: 'Îã´Í∏∞' });
        closeBtn.style.cssText = 'width: 100%; padding: 10px; background: var(--background-modifier-border); border: none; border-radius: 6px; cursor: pointer;';
        closeBtn.addEventListener('click', () => this.close());
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== BookmarkListModal ÌÅ¥ÎûòÏä§ ====================
class BookmarkListModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-bookmark-list');

        contentEl.createEl('h2', { text: '‚≠ê Î∂ÅÎßàÌÅ¨ Î™©Î°ù' });

        const bookmarks = this.plugin.settings.bookmarks || [];

        if (bookmarks.length === 0) {
            contentEl.createDiv({ 
                cls: 'lp-empty-message',
                text: 'Î∂ÅÎßàÌÅ¨Îêú Î¨∏Ï†úÍ∞Ä ÏóÜÏäµÎãàÎã§'
            });
            return;
        }

        const list = contentEl.createDiv({ cls: 'lp-bookmark-items' });

        bookmarks.forEach((bookmark, index) => {
            const quiz = this.plugin.settings.quizzes[bookmark.quizId];
            if (!quiz) return;

            const question = quiz.questions[bookmark.questionIndex];
            if (!question) return;

            const item = list.createDiv({ cls: 'lp-bookmark-item' });

            const info = item.createDiv({ cls: 'lp-bookmark-info' });
            
            const title = info.createDiv({ cls: 'lp-bookmark-title' });
            title.createEl('span', { text: quiz.subject || 'Ï†úÎ™© ÏóÜÏùå' });
            
            info.createDiv({ 
                cls: 'lp-bookmark-question',
                text: question.question 
            });

            const actions = item.createDiv({ cls: 'lp-bookmark-actions' });

            const removeBtn = actions.createEl('button', {
                text: 'üóëÔ∏è Ï†úÍ±∞',
                cls: 'lp-btn-delete'
            });
            removeBtn.onclick = async () => {
                this.plugin.settings.bookmarks.splice(index, 1);
                await this.plugin.saveSettings();
                this.onOpen();
                new Notice('Î∂ÅÎßàÌÅ¨Í∞Ä Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§');
            };
        });

        const startBtn = contentEl.createEl('button', {
            text: '‚≠ê Î∂ÅÎßàÌÅ¨ ÌÄ¥Ï¶à ÏãúÏûë',
            cls: 'lp-btn-start-quiz'
        });
        startBtn.onclick = () => {
            this.close();
            new QuizModal(this.app, this.plugin, null, '‚≠ê Î∂ÅÎßàÌÅ¨').open();
        };

        this.addBookmarkStyles();
    }

    addBookmarkStyles() {
        if (document.getElementById('lp-bookmark-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-bookmark-styles';
        styleEl.textContent = `
            .lp-bookmark-list {
                padding: 20px;
                max-width: 600px;
            }

            .lp-bookmark-list h2 {
                margin-bottom: 20px;
            }

            .lp-bookmark-items {
                max-height: 400px;
                overflow-y: auto;
                margin-bottom: 20px;
            }

            .lp-bookmark-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
                border-left: 4px solid #FFD700;
                margin-bottom: 10px;
            }

            .lp-bookmark-info {
                flex: 1;
            }

            .lp-bookmark-title {
                font-weight: 600;
                margin-bottom: 8px;
                color: var(--text-normal);
            }

            .lp-bookmark-question {
                color: var(--text-muted);
                font-size: 0.95em;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .lp-bookmark-actions {
                margin-left: 15px;
            }

            .lp-btn-start-quiz {
                width: 100%;
                padding: 12px;
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                color: #000;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-weight: 600;
                font-size: 1em;
            }

            .lp-btn-start-quiz:hover {
                background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== DetailedRecordsModal ÌÅ¥ÎûòÏä§ ====================
class DetailedRecordsModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-records');

        contentEl.createEl('h2', { text: 'üìã ÏÉÅÏÑ∏ ÌïôÏäµ Í∏∞Î°ù' });

        const stats = this.plugin.settings.stats;
        const history = stats.studyHistory || [];

        if (history.length === 0) {
            contentEl.createDiv({
                cls: 'lp-empty-message',
                text: 'ÌïôÏäµ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§'
            });
            return;
        }

        // ÌïÑÌÑ∞ ÏÑπÏÖò
        const filterSection = contentEl.createDiv({ cls: 'lp-records-filter' });

        const folderFilter = filterSection.createDiv({ cls: 'lp-filter-group' });
        folderFilter.createEl('label', { text: 'Ìè¥Îçî:' });
        const folderSelect = folderFilter.createEl('select', { cls: 'lp-filter-select' });
        folderSelect.createEl('option', { text: 'Ï†ÑÏ≤¥', value: '' });
        Object.keys(stats.folderStats || {}).forEach(folder => {
            folderSelect.createEl('option', { text: folder, value: folder });
        });

        const resultFilter = filterSection.createDiv({ cls: 'lp-filter-group' });
        resultFilter.createEl('label', { text: 'Í≤∞Í≥º:' });
        const resultSelect = resultFilter.createEl('select', { cls: 'lp-filter-select' });
        resultSelect.createEl('option', { text: 'Ï†ÑÏ≤¥', value: '' });
        resultSelect.createEl('option', { text: 'Ï†ïÎãµÎßå', value: 'correct' });
        resultSelect.createEl('option', { text: 'Ïò§ÎãµÎßå', value: 'wrong' });

        // Í∏∞Î°ù Î™©Î°ù
        const recordsList = contentEl.createDiv({ cls: 'lp-records-list' });

        const renderRecords = () => {
            recordsList.empty();

            const folderValue = folderSelect.value;
            const resultValue = resultSelect.value;

            let filteredHistory = [...history];

            if (folderValue) {
                filteredHistory = filteredHistory.filter(h => h.folder === folderValue);
            }

            if (resultValue === 'correct') {
                filteredHistory = filteredHistory.filter(h => h.correct);
            } else if (resultValue === 'wrong') {
                filteredHistory = filteredHistory.filter(h => !h.correct);
            }

            // ÏµúÏã†Ïàú Ï†ïÎ†¨
            filteredHistory.reverse();

            if (filteredHistory.length === 0) {
                recordsList.createDiv({
                    cls: 'lp-empty-message',
                    text: 'Ï°∞Í±¥Ïóê ÎßûÎäî Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§'
                });
                return;
            }

            // ÏµúÎåÄ 100Í∞úÎßå ÌëúÏãú
            filteredHistory.slice(0, 100).forEach((record, index) => {
                const item = recordsList.createDiv({ cls: 'lp-record-item' });
                item.addClass(record.correct ? 'lp-record-correct' : 'lp-record-wrong');

                const icon = item.createDiv({ cls: 'lp-record-icon' });
                icon.textContent = record.correct ? '‚úÖ' : '‚ùå';

                const info = item.createDiv({ cls: 'lp-record-info' });

                const quiz = this.plugin.settings.quizzes[record.quizId];
                const title = info.createDiv({ cls: 'lp-record-title' });
                title.textContent = quiz?.subject || 'Ïïå Ïàò ÏóÜÏùå';

                const meta = info.createDiv({ cls: 'lp-record-meta' });
                
                const folderTag = meta.createEl('span', {
                    text: record.folder || 'Í∏∞Î≥∏',
                    cls: 'lp-record-tag'
                });

                if (record.difficulty) {
                    const diffTag = meta.createEl('span', {
                        text: record.difficulty,
                        cls: 'lp-record-tag lp-record-difficulty'
                    });
                    diffTag.setAttribute('data-difficulty', record.difficulty);
                }

                meta.createEl('span', {
                    text: `${record.time}Ï¥à`,
                    cls: 'lp-record-time'
                });

                const date = new Date(record.timestamp);
                meta.createEl('span', {
                    text: date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }),
                    cls: 'lp-record-date'
                });
            });

            if (filteredHistory.length > 100) {
                recordsList.createDiv({
                    cls: 'lp-records-notice',
                    text: `ÏµúÍ∑º 100Í∞úÎßå ÌëúÏãúÎê©ÎãàÎã§ (Ï†ÑÏ≤¥ ${filteredHistory.length}Í∞ú)`
                });
            }
        };

        folderSelect.addEventListener('change', renderRecords);
        resultSelect.addEventListener('change', renderRecords);

        renderRecords();

        this.addRecordsStyles();
    }

    addRecordsStyles() {
        if (document.getElementById('lp-records-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-records-styles';
        styleEl.textContent = `
            .lp-records {
                padding: 20px;
                max-width: 800px;
            }

            .lp-records h2 {
                margin-bottom: 20px;
            }

            .lp-records-filter {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
            }

            .lp-filter-group {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .lp-filter-group label {
                font-weight: 600;
                color: var(--text-normal);
            }

            .lp-filter-select {
                padding: 6px 12px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 6px;
                background: var(--background-primary);
                color: var(--text-normal);
            }

            .lp-records-list {
                max-height: 500px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .lp-record-item {
                display: flex;
                gap: 15px;
                padding: 15px;
                border-radius: 8px;
                border-left: 4px solid;
            }

            .lp-record-correct {
                background: rgba(76, 175, 80, 0.1);
                border-color: #4CAF50;
            }

            .lp-record-wrong {
                background: rgba(244, 67, 54, 0.1);
                border-color: #f44336;
            }

            .lp-record-icon {
                font-size: 1.5em;
            }

            .lp-record-info {
                flex: 1;
            }

            .lp-record-title {
                font-weight: 600;
                margin-bottom: 8px;
                color: var(--text-normal);
            }

            .lp-record-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                font-size: 0.9em;
            }

            .lp-record-tag {
                padding: 3px 10px;
                background: var(--background-secondary);
                border-radius: 12px;
                color: var(--text-muted);
            }

            .lp-record-difficulty[data-difficulty="Ïâ¨ÏõÄ"] {
                background: #4CAF50;
                color: white;
            }

            .lp-record-difficulty[data-difficulty="Î≥¥ÌÜµ"] {
                background: #2196F3;
                color: white;
            }

            .lp-record-difficulty[data-difficulty="Ïñ¥Î†§ÏõÄ"] {
                background: #FF9800;
                color: white;
            }

            .lp-record-difficulty[data-difficulty="Îß§Ïö∞ Ïñ¥Î†§ÏõÄ"] {
                background: #F44336;
                color: white;
            }

            .lp-record-time {
                color: var(--text-accent);
                font-weight: 500;
            }

            .lp-record-date {
                color: var(--text-muted);
            }

            .lp-records-notice {
                text-align: center;
                padding: 15px;
                color: var(--text-muted);
                font-size: 0.9em;
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== StatisticsModal ÌÅ¥ÎûòÏä§ ====================
class StatisticsModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-statistics');

        contentEl.createEl('h2', { text: 'üìà ÌïôÏäµ ÌÜµÍ≥Ñ' });

        const stats = this.plugin.settings.stats;

        // Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ
        const overallSection = contentEl.createDiv({ cls: 'lp-stat-section' });
        overallSection.createEl('h3', { text: 'Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ' });

        const overallGrid = overallSection.createDiv({ cls: 'lp-stat-grid' });
        
        this.createStatBox(overallGrid, 'Ï¥ù Î¨∏Ï†ú Ïàò', stats.totalQuestions);
        this.createStatBox(overallGrid, 'Ï†ïÎãµ', stats.totalCorrect, '#4CAF50');
        this.createStatBox(overallGrid, 'Ïò§Îãµ', stats.totalWrong, '#f44336');
        
        const accuracy = stats.totalQuestions > 0 
            ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100)
            : 0;
        this.createStatBox(overallGrid, 'Ï†ïÎãµÎ•†', `${accuracy}%`, '#2196F3');

        // Ìè¥ÎçîÎ≥Ñ ÌÜµÍ≥Ñ
        if (Object.keys(stats.folderStats || {}).length > 0) {
            const folderSection = contentEl.createDiv({ cls: 'lp-stat-section' });
            folderSection.createEl('h3', { text: 'Ìè¥ÎçîÎ≥Ñ ÌÜµÍ≥Ñ' });

            const folderList = folderSection.createDiv({ cls: 'lp-stat-list' });

            Object.entries(stats.folderStats).forEach(([folder, data]) => {
                const item = folderList.createDiv({ cls: 'lp-stat-list-item' });
                
                const name = item.createDiv({ cls: 'lp-stat-list-name' });
                name.textContent = `üìÇ ${folder}`;

                const details = item.createDiv({ cls: 'lp-stat-list-details' });
                const folderAccuracy = data.total > 0 
                    ? Math.round((data.correct / data.total) * 100)
                    : 0;
                details.innerHTML = `
                    <span>${data.correct}/${data.total}</span>
                    <span class="lp-stat-accuracy" style="color: ${folderAccuracy >= 80 ? '#4CAF50' : folderAccuracy >= 60 ? '#FF9800' : '#f44336'}">
                        ${folderAccuracy}%
                    </span>
                `;
            });
        }

        // ÎÇúÏù¥ÎèÑÎ≥Ñ ÌÜµÍ≥Ñ
        if (Object.keys(stats.difficultyStats || {}).length > 0) {
            const diffSection = contentEl.createDiv({ cls: 'lp-stat-section' });
            diffSection.createEl('h3', { text: 'ÎÇúÏù¥ÎèÑÎ≥Ñ ÌÜµÍ≥Ñ' });

            const diffList = diffSection.createDiv({ cls: 'lp-stat-list' });

            Object.entries(stats.difficultyStats).forEach(([difficulty, data]) => {
                const item = diffList.createDiv({ cls: 'lp-stat-list-item' });
                
                const name = item.createDiv({ cls: 'lp-stat-list-name' });
                name.textContent = `üéØ ${difficulty}`;

                const details = item.createDiv({ cls: 'lp-stat-list-details' });
                const diffAccuracy = data.total > 0 
                    ? Math.round((data.correct / data.total) * 100)
                    : 0;
                details.innerHTML = `
                    <span>${data.correct}/${data.total}</span>
                    <span class="lp-stat-accuracy" style="color: ${diffAccuracy >= 80 ? '#4CAF50' : diffAccuracy >= 60 ? '#FF9800' : '#f44336'}">
                        ${diffAccuracy}%
                    </span>
                `;
            });
        }

        this.addStatisticsStyles();
    }

    createStatBox(container, label, value, color = 'var(--interactive-accent)') {
        const box = container.createDiv({ cls: 'lp-stat-box' });
        box.innerHTML = `
            <div class="lp-stat-box-value" style="color: ${color}">${value}</div>
            <div class="lp-stat-box-label">${label}</div>
        `;
    }

    addStatisticsStyles() {
        if (document.getElementById('lp-stat-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-stat-styles';
        styleEl.textContent = `
            .lp-statistics {
                padding: 20px;
                max-width: 700px;
            }

            .lp-statistics h2 {
                margin-bottom: 25px;
            }

            .lp-stat-section {
                margin-bottom: 30px;
            }

            .lp-stat-section h3 {
                margin-bottom: 15px;
                color: var(--text-normal);
            }

            .lp-stat-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .lp-stat-box {
                padding: 20px;
                background: var(--background-secondary);
                border-radius: 10px;
                text-align: center;
            }

            .lp-stat-box-value {
                font-size: 2em;
                font-weight: bold;
                margin-bottom: 8px;
            }

            .lp-stat-box-label {
                color: var(--text-muted);
                font-size: 0.9em;
            }

            .lp-stat-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .lp-stat-list-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
            }

            .lp-stat-list-name {
                font-weight: 500;
                color: var(--text-normal);
            }

            .lp-stat-list-details {
                display: flex;
                gap: 15px;
                align-items: center;
            }

            .lp-stat-accuracy {
                font-weight: 600;
                font-size: 1.1em;
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== FolderQuizSelectModal ÌÅ¥ÎûòÏä§ ====================
class FolderQuizSelectModal extends Modal {
    constructor(app, plugin, folder) {
        super(app);
        this.plugin = plugin;
        this.folder = folder;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-folder-select');

        contentEl.createEl('h2', { text: `üìÇ ${this.folder}` });

        let quizzes;
        if (this.folder === '‚≠ê Î∂ÅÎßàÌÅ¨') {
            // Î∂ÅÎßàÌÅ¨Îêú Î¨∏Ï†úÎì§ÏùÑ ÌÄ¥Ï¶àÎ°ú Í∑∏Î£πÌôî
            quizzes = [{
                id: 'bookmarks',
                subject: 'Î∂ÅÎßàÌÅ¨ ÌÄ¥Ï¶à',
                questions: this.plugin.settings.bookmarks.map(b => {
                    const quiz = this.plugin.settings.quizzes[b.quizId];
                    return quiz ? quiz.questions[b.questionIndex] : null;
                }).filter(q => q !== null),
                folder: '‚≠ê Î∂ÅÎßàÌÅ¨'
            }];
        } else {
            quizzes = Object.values(this.plugin.settings.quizzes || {})
                .filter(q => q.folder === this.folder);
        }

        if (quizzes.length === 0) {
            contentEl.createDiv({ 
                cls: 'lp-empty-message',
                text: 'Ïù¥ Ìè¥ÎçîÏóê ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§'
            });
            return;
        }

        // Ï†ÑÏ≤¥ ÌÄ¥Ï¶à Î≤ÑÌäº
        const allBtn = contentEl.createEl('button', {
            text: `‚≠ê Ï†ÑÏ≤¥ Î¨∏Ï†ú (${quizzes.reduce((sum, q) => sum + (q.questions?.length || 0), 0)}Í∞ú)`,
            cls: 'lp-btn-all-quiz'
        });
        allBtn.onclick = () => {
            this.close();
            new QuizModal(this.app, this.plugin, null, this.folder).open();
        };

        contentEl.createEl('h3', { text: 'ÎòêÎäî Í∞úÎ≥Ñ ÌÄ¥Ï¶à ÏÑ†ÌÉù', cls: 'lp-select-subtitle' });

        const list = contentEl.createDiv({ cls: 'lp-folder-quiz-list' });

        quizzes.forEach(quiz => {
            const item = list.createDiv({ cls: 'lp-folder-quiz-item' });

            const info = item.createDiv({ cls: 'lp-folder-quiz-info' });
            
            const titleRow = info.createDiv({ cls: 'lp-quiz-title-row' });
            titleRow.createEl('h4', { text: quiz.subject || 'Ï†úÎ™© ÏóÜÏùå' });
            
            if (quiz.difficulty) {
                const tag = titleRow.createEl('span', {
                    text: quiz.difficulty,
                    cls: 'lp-difficulty-tag'
                });
                tag.setAttribute('data-difficulty', quiz.difficulty);
            }
            
            info.createEl('p', { text: `${quiz.questions?.length || 0}Í∞ú Î¨∏Ï†ú` });

            const startBtn = item.createEl('button', {
                text: '‚ñ∂ ÏãúÏûë',
                cls: 'lp-btn-start'
            });
            startBtn.onclick = () => {
                this.close();
                new QuizModal(this.app, this.plugin, quiz.id).open();
            };
        });

        this.addFolderSelectStyles();
    }

    addFolderSelectStyles() {
        if (document.getElementById('lp-folder-select-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-folder-select-styles';
        styleEl.textContent = `
            .lp-folder-select {
                padding: 20px;
                max-width: 600px;
            }

            .lp-folder-select h2 {
                margin-bottom: 20px;
            }

            .lp-btn-all-quiz {
                width: 100%;
                padding: 15px;
                background: linear-gradient(135deg, var(--interactive-accent) 0%, #45a049 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 1.1em;
                margin-bottom: 25px;
                transition: transform 0.2s;
            }

            .lp-btn-all-quiz:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .lp-select-subtitle {
                text-align: center;
                color: var(--text-muted);
                font-size: 0.9em;
                margin-bottom: 15px;
            }

            .lp-folder-quiz-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
                max-height: 400px;
                overflow-y: auto;
            }

            .lp-folder-quiz-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
                transition: transform 0.2s;
            }

            .lp-folder-quiz-item:hover {
                transform: translateX(5px);
            }

            .lp-folder-quiz-info {
                flex: 1;
            }

            .lp-quiz-title-row {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-bottom: 5px;
            }

            .lp-folder-quiz-info h4 {
                margin: 0;
                color: var(--text-normal);
            }

            .lp-difficulty-tag {
                padding: 3px 10px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 500;
            }

            .lp-difficulty-tag[data-difficulty="Ïâ¨ÏõÄ"] {
                background: #4CAF50;
                color: white;
            }

            .lp-difficulty-tag[data-difficulty="Î≥¥ÌÜµ"] {
                background: #2196F3;
                color: white;
            }

            .lp-difficulty-tag[data-difficulty="Ïñ¥Î†§ÏõÄ"] {
                background: #FF9800;
                color: white;
            }

            .lp-difficulty-tag[data-difficulty="Îß§Ïö∞ Ïñ¥Î†§ÏõÄ"] {
                background: #F44336;
                color: white;
            }

            .lp-folder-quiz-info p {
                margin: 0;
                color: var(--text-muted);
                font-size: 0.9em;
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== FolderQuizModal ÌÅ¥ÎûòÏä§ ====================
class FolderQuizModal extends Modal {
    constructor(app, plugin, folder) {
        super(app);
        this.plugin = plugin;
        this.folder = folder;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-folder-quiz');

        contentEl.createEl('h2', { text: `üìÇ ${this.folder}` });

        // Ìè¥Îçî ÌÜµÍ≥Ñ ÌëúÏãú
        const folderStats = this.plugin.getFolderStats(this.folder);
        const accuracy = folderStats.attempts > 0 ? Math.round((folderStats.correct / folderStats.attempts) * 100) : 0;

        const statsDiv = contentEl.createDiv();
        statsDiv.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; padding: 16px; background: var(--background-secondary); border-radius: 8px;';

        const statItem = (label, value, color) => {
            const item = statsDiv.createDiv();
            item.style.cssText = 'text-align: center;';
            item.createEl('div', { text: value }).style.cssText = `font-size: 1.5em; font-weight: bold; color: ${color || 'var(--interactive-accent)'};`;
            item.createEl('div', { text: label }).style.cssText = 'font-size: 0.85em; color: var(--text-muted); margin-top: 4px;';
        };

        statItem('ÏãúÎèÑ ÌöüÏàò', `${folderStats.attempts}Ìöå`, '#3b82f6');
        statItem('Ï†ïÎãµÎ•†', `${accuracy}%`, folderStats.attempts > 0 ? (accuracy >= 80 ? '#10b981' : accuracy >= 60 ? '#f59e0b' : '#ef4444') : '#6b7280');
        statItem('ÌïôÏäµ ÏãúÍ∞Ñ', `${Math.round(folderStats.time / 60)}Î∂Ñ`, '#8b5cf6');

        const quizzes = Object.values(this.plugin.settings.quizzes || {})
            .filter(q => (q.folder || 'Í∏∞Î≥∏') === this.folder);

        if (quizzes.length === 0) {
            contentEl.createDiv({ 
                cls: 'lp-empty-message',
                text: 'Ïù¥ Ìè¥ÎçîÏóê ÌÄ¥Ï¶àÍ∞Ä ÏóÜÏäµÎãàÎã§'
            });
            return;
        }

        const list = contentEl.createDiv({ cls: 'lp-folder-quiz-list' });

        quizzes.forEach(quiz => {
            const item = list.createDiv({ cls: 'lp-folder-quiz-item' });

            const info = item.createDiv({ cls: 'lp-folder-quiz-info' });
            info.createEl('h4', { text: quiz.subject || 'Ï†úÎ™© ÏóÜÏùå' });
            info.createEl('p', { text: `${quiz.questions?.length || 0}Í∞ú Î¨∏Ï†ú` });

            const startBtn = item.createEl('button', {
                text: '‚ñ∂ ÏãúÏûë',
                cls: 'lp-btn-start'
            });
            startBtn.onclick = () => {
                this.close();
                new QuizModal(this.app, this.plugin, quiz.id).open();
            };
        });

        this.addFolderQuizStyles();
    }

    addFolderQuizStyles() {
        if (document.getElementById('lp-folder-quiz-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-folder-quiz-styles';
        styleEl.textContent = `
            .lp-folder-quiz {
                padding: 20px;
                max-width: 600px;
            }

            .lp-folder-quiz h2 {
                margin-bottom: 20px;
            }

            .lp-folder-quiz-list {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .lp-folder-quiz-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
            }

            .lp-folder-quiz-info h4 {
                margin: 0 0 5px 0;
                color: var(--text-normal);
            }

            .lp-folder-quiz-info p {
                margin: 0;
                color: var(--text-muted);
                font-size: 0.9em;
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        this.contentEl.empty();
    }
}

// ==================== LearningStrategySettingTab ÌÅ¥ÎûòÏä§ ====================
class LearningStrategySettingTab extends PluginSettingTab {
    constructor(app, plugin) {
        super(app, plugin);
        this.plugin = plugin;
    }

    display() {
        const { containerEl } = this;
        containerEl.empty();

        containerEl.createEl('h2', { text: 'ÌïôÏäµ Ï†ÑÎûµ ÌîåÎûòÎÑà ÏÑ§Ï†ï' });

        // Ìè¥Îçî ÏÑ§Ï†ï
        new Setting(containerEl)
            .setName('ÌïôÏäµ ÌîåÎûú Ìè¥Îçî')
            .setDesc('ÌÄ¥Ï¶àÍ∞Ä Ï†ÄÏû•Îê† Í∏∞Î≥∏ Ìè¥Îçî')
            .addText(text => text
                .setPlaceholder('Learning Plans')
                .setValue(this.plugin.settings.learningFolder)
                .onChange(async (value) => {
                    this.plugin.settings.learningFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Î∂ÅÎßàÌÅ¨ Ìè¥Îçî')
            .setDesc('Î∂ÅÎßàÌÅ¨ Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ìè¥Îçî')
            .addText(text => text
                .setPlaceholder('‚≠ê Î∂ÅÎßàÌÅ¨')
                .setValue(this.plugin.settings.bookmarksFolder)
                .onChange(async (value) => {
                    this.plugin.settings.bookmarksFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Ï≤®Î∂ÄÌååÏùº Ìè¥ÎçîÎ™Ö')
            .setDesc('Ïù¥ÎØ∏ÏßÄÍ∞Ä Ï†ÄÏû•ÎêòÎäî Ìè¥ÎçîÎ™Ö')
            .addText(text => text
                .setPlaceholder('Ï≤®Î∂ÄÌååÏùº')
                .setValue(this.plugin.settings.attachmentFolderName)
                .onChange(async (value) => {
                    this.plugin.settings.attachmentFolderName = value;
                    await this.plugin.saveSettings();
                }));

        // ÌÄ¥Ï¶à Ìè¥Îçî Í¥ÄÎ¶¨
        containerEl.createEl('h3', { text: 'ÌÄ¥Ï¶à Ìè¥Îçî' });

        const folderContainer = containerEl.createDiv({ cls: 'lp-setting-folder-list' });
        this.renderFolderList(folderContainer);

        const folderInput = containerEl.createDiv({ cls: 'lp-setting-folder-input' });
        const input = folderInput.createEl('input', {
            type: 'text',
            placeholder: 'ÏÉà Ìè¥Îçî Ïù¥Î¶Ñ',
            cls: 'lp-setting-input'
        });

        const addBtn = folderInput.createEl('button', {
            text: '‚ûï Ï∂îÍ∞Ä',
            cls: 'lp-setting-btn-add'
        });
        addBtn.onclick = async () => {
            const folderName = input.value.trim();
            if (folderName && !this.plugin.settings.questionFolders.includes(folderName)) {
                this.plugin.settings.questionFolders.push(folderName);
                await this.plugin.saveSettings();
                input.value = '';
                this.renderFolderList(folderContainer);
            }
        };

        // ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï
        containerEl.createEl('h3', { text: 'ÎÇúÏù¥ÎèÑ ÏÑ§Ï†ï' });

        new Setting(containerEl)
            .setName('Í∏∞Î≥∏ ÎÇúÏù¥ÎèÑ')
            .setDesc('ÏÉà ÌÄ¥Ï¶àÏùò Í∏∞Î≥∏ ÎÇúÏù¥ÎèÑ')
            .addDropdown(dropdown => {
                this.plugin.settings.difficulties.forEach(diff => {
                    dropdown.addOption(diff, diff);
                });
                dropdown
                    .setValue(this.plugin.settings.defaultDifficulty)
                    .onChange(async (value) => {
                        this.plugin.settings.defaultDifficulty = value;
                        await this.plugin.saveSettings();
                    });
            });

        // ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï
        containerEl.createEl('h3', { text: 'ÌÉÄÏù¥Î®∏ ÏÑ§Ï†ï' });

        new Setting(containerEl)
            .setName('ÌÉÄÏù¥Î®∏ ÏÇ¨Ïö©')
            .setDesc('ÌÄ¥Ï¶àÏóêÏÑú ÌÉÄÏù¥Î®∏ ÌëúÏãú')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableTimer)
                .onChange(async (value) => {
                    this.plugin.settings.enableTimer = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Í∏∞Î≥∏ ÏãúÍ∞Ñ (Ï¥à)')
            .setDesc('Í∞Å Î¨∏Ï†úÎãπ Ï†úÌïú ÏãúÍ∞Ñ')
            .addText(text => text
                .setPlaceholder('30')
                .setValue(this.plugin.settings.defaultTimerDuration.toString())
                .onChange(async (value) => {
                    const num = parseInt(value);
                    if (!isNaN(num) && num > 0) {
                        this.plugin.settings.defaultTimerDuration = num;
                        await this.plugin.saveSettings();
                    }
                }));

        new Setting(containerEl)
            .setName('ÏûêÎèô ÏãúÏûë')
            .setDesc('Î¨∏Ï†ú ÌëúÏãú Ïãú ÌÉÄÏù¥Î®∏ ÏûêÎèô ÏãúÏûë')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.autoStartTimer)
                .onChange(async (value) => {
                    this.plugin.settings.autoStartTimer = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Í≤ΩÍ≥† ÏûÑÍ≥ÑÍ∞í (Ï¥à)')
            .setDesc('Ïù¥ ÏãúÍ∞Ñ Ïù¥ÌïòÏùº Îïå Í≤ΩÍ≥† ÌëúÏãú')
            .addText(text => text
                .setPlaceholder('5')
                .setValue(this.plugin.settings.timerWarningThreshold.toString())
                .onChange(async (value) => {
                    const num = parseInt(value);
                    if (!isNaN(num) && num > 0) {
                        this.plugin.settings.timerWarningThreshold = num;
                        await this.plugin.saveSettings();
                    }
                }));

        // UI ÏÑ§Ï†ï
        containerEl.createEl('h3', { text: 'UI ÏÑ§Ï†ï' });

        new Setting(containerEl)
            .setName('Î¨∏Ï†ú ÏÑûÍ∏∞')
            .setDesc('ÌÄ¥Ï¶à ÏãúÏûë Ïãú Î¨∏Ï†ú ÏàúÏÑú Î¨¥ÏûëÏúÑ')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.shuffleQuestions)
                .onChange(async (value) => {
                    this.plugin.settings.shuffleQuestions = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Ïï†ÎãàÎ©îÏù¥ÏÖò Ï§ÑÏù¥Í∏∞')
            .setDesc('ÏÑ±Îä• Ìñ•ÏÉÅÏùÑ ÏúÑÌï¥ Ïï†ÎãàÎ©îÏù¥ÏÖò ÏµúÏÜåÌôî')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.reducedAnimations)
                .onChange(async (value) => {
                    this.plugin.settings.reducedAnimations = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('Ïò§Îãµ Ïãú ÌûåÌä∏ ÌëúÏãú')
            .setDesc('ÌãÄÎ¶∞ ÎãµÎ≥Ä ÌõÑ ÌûåÌä∏ ÏûêÎèô ÌëúÏãú')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showHintAfterWrong)
                .onChange(async (value) => {
                    this.plugin.settings.showHintAfterWrong = value;
                    await this.plugin.saveSettings();
                }));

        // Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï
        containerEl.createEl('h3', { text: 'Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï' });

        new Setting(containerEl)
            .setName('Ïù¥ÎØ∏ÏßÄ ÌëúÏãú')
            .setDesc('ÌÄ¥Ï¶àÏóêÏÑú Ïù¥ÎØ∏ÏßÄ ÌëúÏãú ÌôúÏÑ±Ìôî')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableImages)
                .onChange(async (value) => {
                    this.plugin.settings.enableImages = value;
                    await this.plugin.saveSettings();
                }));
        
        // Î£®Ìã¥ ÌîåÎûòÎÑà ÏÑ§Ï†ï
        containerEl.createEl('h3', { text: 'Î£®Ìã¥ ÌîåÎûòÎÑà' });
        
        new Setting(containerEl)
            .setName('Î£®Ìã¥ ÌîåÎûòÎÑà ÌôúÏÑ±Ìôî')
            .setDesc('Î£®Ìã¥ ÌîåÎûòÎÑà Í∏∞Îä• ÏÇ¨Ïö©')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.routineEnabled)
                .onChange(async (value) => {
                    this.plugin.settings.routineEnabled = value;
                    await this.plugin.saveSettings();
                }));
        
        new Setting(containerEl)
            .setName('Î£®Ìã¥ Ìè¥Îçî')
            .setDesc('Î£®Ìã¥ ÌååÏùºÏù¥ Ï†ÄÏû•Îê† Ìè¥Îçî Í≤ΩÎ°ú')
            .addText(text => text
                .setPlaceholder('Routine')
                .setValue(this.plugin.settings.routineFolder)
                .onChange(async (value) => {
                    this.plugin.settings.routineFolder = value;
                    await this.plugin.saveSettings();
                }));
        
        new Setting(containerEl)
            .setName('Ìè¥Îçî Íµ¨Ï°∞')
            .setDesc('Î£®Ìã¥ ÌååÏùºÏùò Ìè¥Îçî Íµ¨Ï°∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî')
            .addDropdown(dropdown => dropdown
                .addOption('monthly', 'ÏõîÎ≥Ñ (Ïòà: Routine/2025/11/2025-11-27.md)')
                .addOption('weekly', 'Ï£ºÎ≥Ñ (Ïòà: Routine/2025/Week-48/2025-11-27.md)')
                .addOption('daily', 'ÏùºÎ≥Ñ (Ïòà: Routine/2025-11-27.md)')
                .setValue(this.plugin.settings.folderStructure)
                .onChange(async (value) => {
                    this.plugin.settings.folderStructure = value;
                    await this.plugin.saveSettings();
                }));
        
        new Setting(containerEl)
            .setName('ÏûêÎèô Ìè¥Îçî ÏÉùÏÑ±')
            .setDesc('ÎÇ†Ïßú ÏÑ†ÌÉù Ïãú ÏûêÎèôÏúºÎ°ú Ìè¥ÎçîÎ•º ÏÉùÏÑ±Ìï©ÎãàÎã§')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.autoCreateFolder)
                .onChange(async (value) => {
                    this.plugin.settings.autoCreateFolder = value;
                    await this.plugin.saveSettings();
                }));
        
        new Setting(containerEl)
            .setName('ÌååÏùº ÎèôÍ∏∞Ìôî')
            .setDesc('UI Î≥ÄÍ≤ΩÏÇ¨Ìï≠ÏùÑ Ï¶âÏãú ÌååÏùºÏóê Î∞òÏòÅÌï©ÎãàÎã§')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.syncWithFiles)
                .onChange(async (value) => {
                    this.plugin.settings.syncWithFiles = value;
                    await this.plugin.saveSettings();
                }));

        // Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨
        containerEl.createEl('h3', { text: 'Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨' });

        new Setting(containerEl)
            .setName('ÌÜµÍ≥Ñ Ï¥àÍ∏∞Ìôî')
            .setDesc('Î™®Îì† ÌïôÏäµ ÌÜµÍ≥ÑÎ•º Ï¥àÍ∏∞ÌôîÌï©ÎãàÎã§')
            .addButton(button => button
                .setButtonText('Ï¥àÍ∏∞Ìôî')
                .setWarning()
                .onClick(async () => {
                    if (confirm('Ï†ïÎßê Î™®Îì† ÌÜµÍ≥ÑÎ•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                        this.plugin.settings.stats = DEFAULT_SETTINGS.stats;
                        await this.plugin.saveSettings();
                        new Notice('ÌÜµÍ≥ÑÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
                    }
                }));

        this.addSettingStyles();
    }

    renderFolderList(container) {
        container.empty();

        this.plugin.settings.questionFolders.forEach((folder, index) => {
            const item = container.createDiv({ cls: 'lp-setting-folder-item' });
            
            item.createEl('span', { text: folder });

            const deleteBtn = item.createEl('button', {
                text: 'üóëÔ∏è',
                cls: 'lp-setting-btn-delete'
            });
            deleteBtn.onclick = async () => {
                this.plugin.settings.questionFolders.splice(index, 1);
                await this.plugin.saveSettings();
                this.renderFolderList(container);
            };
        });
    }

    addSettingStyles() {
        if (document.getElementById('lp-setting-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-setting-styles';
        styleEl.textContent = `
            .lp-setting-folder-list {
                display: flex;
                flex-direction: column;
                gap: 8px;
                margin-bottom: 15px;
            }

            .lp-setting-folder-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 12px;
                background: var(--background-secondary);
                border-radius: 6px;
            }

            .lp-setting-folder-input {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
            }

            .lp-setting-input {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 6px;
                background: var(--background-primary);
                color: var(--text-normal);
            }

            .lp-setting-btn-add {
                padding: 8px 16px;
                background: var(--interactive-accent);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
            }

            .lp-setting-btn-delete {
                padding: 4px 10px;
                background: #f44336;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }
        `;
        document.head.appendChild(styleEl);
    }
}

// ==================== Î£®Ìã¥ ÌîåÎûòÎÑà Î™®Îã¨ ÌÅ¥ÎûòÏä§ ====================
// Î£®Ìã¥ Ï∂îÍ∞Ä Î™®Îã¨
class RoutineAddModal extends Modal {
    constructor(app, onAdd) {
        super(app);
        this.onAdd = onAdd;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        contentEl.createEl('h2', { text: 'ÏÉà Routine Ï∂îÍ∞Ä' });
        
        const form = contentEl.createDiv();
        
        form.createEl('label', { text: 'Î£®Ìã¥ ÎÇ¥Ïö©' });
        const textInput = form.createEl('input', { type: 'text' });
        textInput.style.width = '100%';
        textInput.style.marginBottom = '15px';
        textInput.style.padding = '8px';
        
        const btnContainer = form.createDiv();
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'flex-end';
        
        const addBtn = btnContainer.createEl('button', { text: 'Ï∂îÍ∞Ä' });
        addBtn.style.backgroundColor = 'var(--interactive-accent)';
        addBtn.style.color = 'var(--text-on-accent)';
        addBtn.style.padding = '8px 16px';
        addBtn.style.border = 'none';
        addBtn.style.borderRadius = '6px';
        addBtn.style.cursor = 'pointer';
        addBtn.style.fontWeight = 'bold';
        addBtn.onclick = () => {
            const text = textInput.value.trim();
            if (text) {
                this.onAdd(text);
                this.close();
                new Notice('RoutineÏù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
            }
        };
        
        const cancelBtn = btnContainer.createEl('button', { text: 'Ï∑®ÏÜå' });
        cancelBtn.style.padding = '8px 16px';
        cancelBtn.style.border = 'none';
        cancelBtn.style.borderRadius = '6px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.backgroundColor = 'var(--background-secondary)';
        cancelBtn.style.color = 'var(--text-normal)';
        cancelBtn.onclick = () => this.close();
        
        textInput.focus();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ÌÉúÏä§ÌÅ¨ Ï∂îÍ∞Ä Î™®Îã¨
class TaskAddModal extends Modal {
    constructor(app, onAdd, defaultHour = null) {
        super(app);
        this.onAdd = onAdd;
        this.defaultHour = defaultHour;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        contentEl.createEl('h2', { text: 'ÏÉà Task Ï∂îÍ∞Ä' });
        
        const form = contentEl.createDiv();
        
        form.createEl('label', { text: 'ÏãúÍ∞Ñ' });
        const hourInput = form.createEl('input', { type: 'number' });
        hourInput.setAttribute('min', '0');
        hourInput.setAttribute('max', '23');
        if (this.defaultHour !== null) {
            hourInput.value = this.defaultHour.toString();
        }
        hourInput.style.width = '100%';
        hourInput.style.marginBottom = '15px';
        hourInput.style.padding = '8px';
        
        form.createEl('label', { text: 'ÎÇ¥Ïö©' });
        const textInput = form.createEl('input', { type: 'text' });
        textInput.style.width = '100%';
        textInput.style.marginBottom = '15px';
        textInput.style.padding = '8px';
        
        const addBtn = form.createEl('button', { text: 'Ï∂îÍ∞Ä' });
        addBtn.style.backgroundColor = 'var(--interactive-accent)';
        addBtn.style.color = 'var(--text-on-accent)';
        addBtn.style.width = '100%';
        addBtn.style.padding = '8px';
        addBtn.style.border = 'none';
        addBtn.style.borderRadius = '6px';
        addBtn.style.cursor = 'pointer';
        addBtn.style.fontWeight = 'bold';
        addBtn.onclick = () => {
            const hour = parseInt(hourInput.value);
            const text = textInput.value;
            
            if (!isNaN(hour) && hour >= 0 && hour <= 23 && text) {
                this.onAdd(hour, text);
                this.close();
                new Notice('TaskÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
            }
        };
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ÎÖ∏Ìä∏ Ï∂îÍ∞Ä Î™®Îã¨
class NoteAddModal extends Modal {
    constructor(app, onAdd) {
        super(app);
        this.onAdd = onAdd;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        contentEl.createEl('h2', { text: 'ÏÉà Note Ï∂îÍ∞Ä' });
        
        const form = contentEl.createDiv();
        
        form.createEl('label', { text: 'ÎÇ¥Ïö©' });
        const textArea = form.createEl('textarea');
        textArea.style.width = '100%';
        textArea.style.minHeight = '100px';
        textArea.style.marginBottom = '15px';
        textArea.style.padding = '10px';
        
        const btnContainer = form.createDiv();
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'flex-end';
        
        const addBtn = btnContainer.createEl('button', { text: 'Ï∂îÍ∞Ä' });
        addBtn.style.backgroundColor = 'var(--interactive-accent)';
        addBtn.style.color = 'var(--text-on-accent)';
        addBtn.style.padding = '8px 16px';
        addBtn.style.border = 'none';
        addBtn.style.borderRadius = '6px';
        addBtn.style.cursor = 'pointer';
        addBtn.style.fontWeight = 'bold';
        addBtn.onclick = () => {
            const text = textArea.value.trim();
            if (text) {
                this.onAdd(text);
                this.close();
                new Notice('NoteÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
            }
        };
        
        const cancelBtn = btnContainer.createEl('button', { text: 'Ï∑®ÏÜå' });
        cancelBtn.style.padding = '8px 16px';
        cancelBtn.style.border = 'none';
        cancelBtn.style.borderRadius = '6px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.backgroundColor = 'var(--background-secondary)';
        cancelBtn.onclick = () => this.close();
        
        textArea.focus();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ÎÖ∏Ìä∏ ÏàòÏ†ï Î™®Îã¨ (enhanced-cloze Ïä§ÌÉÄÏùº)
class NoteEditModal extends Modal {
    constructor(app, currentText, onSave, onDelete) {
        super(app);
        this.currentText = currentText;
        this.onSave = onSave;
        this.onDelete = onDelete;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.createEl('h2', { text: 'Î©îÎ™® ÏàòÏ†ï' });

        const form = contentEl.createDiv();
        form.createEl('label', { text: 'ÎÇ¥Ïö©' });
        const textArea = form.createEl('textarea');
        textArea.value = this.currentText;
        textArea.style.width = '100%';
        textArea.style.minHeight = '100px';
        textArea.style.marginBottom = '15px';
        textArea.style.padding = '10px';

        const btnContainer = form.createDiv();
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'space-between';

        const deleteBtn = btnContainer.createEl('button', { text: 'ÏÇ≠Ï†ú' });
        deleteBtn.style.backgroundColor = '#dc2626';
        deleteBtn.style.color = 'white';
        deleteBtn.style.padding = '8px 16px';
        deleteBtn.style.border = 'none';
        deleteBtn.style.borderRadius = '6px';
        deleteBtn.style.cursor = 'pointer';
        deleteBtn.onclick = () => {
            if (confirm('Ïù¥ Î©îÎ™®Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                this.onDelete();
                this.close();
                new Notice('Î©îÎ™®Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!');
            }
        };

        const rightBtnGroup = btnContainer.createDiv();
        rightBtnGroup.style.display = 'flex';
        rightBtnGroup.style.gap = '10px';

        const saveBtn = rightBtnGroup.createEl('button', { text: 'Ï†ÄÏû•' });
        saveBtn.style.backgroundColor = 'var(--interactive-accent)';
        saveBtn.style.color = 'var(--text-on-accent)';
        saveBtn.style.padding = '8px 16px';
        saveBtn.style.border = 'none';
        saveBtn.style.borderRadius = '6px';
        saveBtn.style.cursor = 'pointer';
        saveBtn.onclick = () => {
            const text = textArea.value.trim();
            if (text) {
                this.onSave(text);
                this.close();
                new Notice('Î©îÎ™®Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!');
            }
        };

        const cancelBtn = rightBtnGroup.createEl('button', { text: 'Ï∑®ÏÜå' });
        cancelBtn.style.padding = '8px 16px';
        cancelBtn.style.border = 'none';
        cancelBtn.style.borderRadius = '6px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.backgroundColor = 'var(--background-secondary)';
        cancelBtn.onclick = () => this.close();

        textArea.focus();
        textArea.setSelectionRange(textArea.value.length, textArea.value.length);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// Î™©Ìëú Ìï≠Î™© Ï∂îÍ∞Ä Î™®Îã¨ (enhanced-cloze Ïä§ÌÉÄÏùº)
class GoalItemAddModal extends Modal {
    constructor(app, onAdd) {
        super(app);
        this.onAdd = onAdd;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.createEl('h2', { text: 'ÏÉà Î™©Ìëú Ìï≠Î™© Ï∂îÍ∞Ä' });

        const form = contentEl.createDiv();
        form.createEl('label', { text: 'Î™©Ìëú ÎÇ¥Ïö©' });
        const textInput = form.createEl('input', { type: 'text' });
        textInput.style.width = '100%';
        textInput.style.marginBottom = '15px';
        textInput.style.padding = '8px';

        const btnContainer = form.createDiv();
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'flex-end';

        const addBtn = btnContainer.createEl('button', { text: 'Ï∂îÍ∞Ä' });
        addBtn.style.backgroundColor = 'var(--interactive-accent)';
        addBtn.style.color = 'var(--text-on-accent)';
        addBtn.style.padding = '8px 16px';
        addBtn.style.border = 'none';
        addBtn.style.borderRadius = '6px';
        addBtn.style.cursor = 'pointer';
        addBtn.onclick = () => {
            const text = textInput.value.trim();
            if (text) {
                this.onAdd(text);
                this.close();
                new Notice('Î™©ÌëúÍ∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!');
            }
        };

        const cancelBtn = btnContainer.createEl('button', { text: 'Ï∑®ÏÜå' });
        cancelBtn.style.padding = '8px 16px';
        cancelBtn.style.border = 'none';
        cancelBtn.style.borderRadius = '6px';
        cancelBtn.style.cursor = 'pointer';
        cancelBtn.style.backgroundColor = 'var(--background-secondary)';
        cancelBtn.onclick = () => this.close();

        textInput.focus();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ==================== ÌïôÏäµ Í∏∞Î°ù Î™®Îã¨ (enhanced-cloze Ïä§ÌÉÄÏùº) ====================
class StudyHistoryModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-study-history-modal');

        contentEl.createEl('h2', { text: 'üìã ÌïôÏäµ ÏÑ∏ÏÖò Í∏∞Î°ù' });
        
        const stats = this.plugin.settings.stats;
        const history = stats.studyHistory || [];

        if (history.length === 0) {
            contentEl.createDiv({ 
                cls: 'lp-empty-message',
                text: 'ÏïÑÏßÅ ÌïôÏäµ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§. ÌÄ¥Ï¶àÎ•º ÏôÑÎ£åÌïòÎ©¥ Í∏∞Î°ùÏù¥ ÏåìÏûÖÎãàÎã§.'
            });
            return;
        }

        // Ìó§Îçî Î≤ÑÌäº
        const headerButtons = contentEl.createDiv();
        headerButtons.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const resetBtn = headerButtons.createEl('button', { text: 'üóëÔ∏è Í∏∞Î°ù Ï¥àÍ∏∞Ìôî' });
        resetBtn.style.cssText = 'flex: 1; padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer;';
        resetBtn.onclick = async () => {
            if (confirm('Î™®Îì† ÌïôÏäµ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                this.plugin.settings.stats = {
                    ...this.plugin.settings.stats,
                    studyHistory: [],
                    folderStats: {},
                    fileStats: {}
                };
                await this.plugin.saveSettings();
                new Notice('ÌïôÏäµ Í∏∞Î°ùÏù¥ Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§');
                this.onOpen();
            }
        };

        const exportBtn = headerButtons.createEl('button', { text: 'üì§ CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞' });
        exportBtn.style.cssText = 'flex: 1; padding: 8px 16px; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer;';
        exportBtn.onclick = () => this.exportToCSV(history);

        // ÌïôÏäµ ÏÑ∏ÏÖò Î™©Î°ù
        contentEl.createEl('h3', { text: `üìÑ Ï†ÑÏ≤¥ ÌïôÏäµ ÏÑ∏ÏÖò (${history.length}Í∞ú)` });
        
        const sessionList = contentEl.createDiv({ cls: 'lp-session-list' });
        sessionList.style.cssText = 'max-height: 60vh; overflow-y: auto; border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 8px;';

        // ÏµúÍ∑º ÏàúÏúºÎ°ú Ï†ïÎ†¨
        const sortedHistory = [...history].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        for (const record of sortedHistory) {
            const sessionDiv = sessionList.createDiv({ cls: 'lp-session-item' });
            sessionDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-primary-alt);';

            const topRow = sessionDiv.createDiv();
            topRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
            
            const date = new Date(record.timestamp || Date.now());
            const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            topRow.createEl('div', { text: dateStr }).style.cssText = 'font-weight: 500;';
            
            const statusBadge = topRow.createEl('span', { 
                text: record.correct ? '‚úÖ Ï†ïÎãµ' : '‚ùå Ïò§Îãµ'
            });
            statusBadge.style.cssText = `padding: 2px 8px; border-radius: 12px; font-size: 0.85em; background: ${record.correct ? '#10b981' : '#ef4444'}; color: white;`;

            const infoRow = sessionDiv.createDiv();
            infoRow.style.cssText = 'font-size: 0.9em; color: var(--text-muted);';
            infoRow.textContent = `üìÅ ${record.folder || 'Ïïå Ïàò ÏóÜÏùå'} / üìÑ ${record.quizId || 'Ïïå Ïàò ÏóÜÏùå'}`;

            if (record.duration) {
                const timeInfo = sessionDiv.createDiv();
                timeInfo.style.cssText = 'font-size: 0.85em; color: var(--text-muted); margin-top: 4px;';
                timeInfo.textContent = `‚è±Ô∏è ${Math.round(record.duration)}Ï¥à`;
            }
        }

        this.addHistoryStyles();
    }

    exportToCSV(history) {
        const headers = ['ÎÇ†Ïßú', 'ÏãúÍ∞Ñ', 'Ìè¥Îçî', 'ÌÄ¥Ï¶àID', 'Í≤∞Í≥º', 'ÏÜåÏöîÏãúÍ∞Ñ(Ï¥à)'];
        const rows = history.map(record => {
            const date = new Date(record.timestamp || Date.now());
            return [
                date.toLocaleDateString('ko-KR'),
                date.toLocaleTimeString('ko-KR'),
                record.folder || '',
                record.quizId || '',
                record.correct ? 'Ï†ïÎãµ' : 'Ïò§Îãµ',
                Math.round(record.duration || 0)
            ];
        });

        const csvContent = [headers, ...rows]
            .map(row => row.join(','))
            .join('\n');

        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `ÌïôÏäµÍ∏∞Î°ù_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        URL.revokeObjectURL(url);

        new Notice('CSV ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§');
    }

    addHistoryStyles() {
        if (document.getElementById('lp-history-styles')) return;

        const styleEl = document.createElement('style');
        styleEl.id = 'lp-history-styles';
        styleEl.textContent = `
            .lp-study-history-modal .modal {
                max-width: 700px;
            }
            .lp-session-item:hover {
                background: var(--background-secondary) !important;
            }
        `;
        document.head.appendChild(styleEl);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ==================== Ìè¥ÎçîÎ≥Ñ ÏÉÅÏÑ∏ Í∏∞Î°ù Î™®Îã¨ (enhanced-cloze Ïä§ÌÉÄÏùº) ====================
class FolderDetailModal extends Modal {
    constructor(app, plugin, folderName) {
        super(app);
        this.plugin = plugin;
        this.folderName = folderName;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-folder-detail-modal');

        // Ìó§Îçî
        const header = contentEl.createDiv();
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
        
        header.createEl('h2', { text: `üìä ${this.folderName} ÏÉÅÏÑ∏ Í∏∞Î°ù` }).style.margin = '0';
        
        const btnGroup = header.createDiv();
        btnGroup.style.cssText = 'display: flex; gap: 8px;';
        
        // ÏÉàÎ°úÍ≥†Ïπ® Î≤ÑÌäº
        const refreshBtn = btnGroup.createEl('button', { text: 'üîÑ' });
        refreshBtn.title = 'ÏÉàÎ°úÍ≥†Ïπ®';
        refreshBtn.style.cssText = 'padding: 8px 12px; border-radius: 6px;';
        refreshBtn.onclick = () => this.onOpen();

        // Í∏∞Î°ù ÏÇ≠Ï†ú Î≤ÑÌäº
        const clearBtn = btnGroup.createEl('button', { text: 'üóëÔ∏è Í∏∞Î°ù ÏÇ≠Ï†ú' });
        clearBtn.style.cssText = 'padding: 8px 12px; background: #dc2626; color: white; border: none; border-radius: 6px;';
        clearBtn.onclick = async () => {
            if (confirm(`"${this.folderName}" Ìè¥ÎçîÏùò Î™®Îì† ÌïôÏäµ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                await this.clearFolderStats();
                new Notice('‚úÖ Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                this.onOpen();
            }
        };

        const stats = this.plugin.settings.stats;
        const folderStats = stats.folderStats?.[this.folderName] || { attempts: 0, correct: 0, time: 0 };
        const history = (stats.studyHistory || []).filter(h => h.folder === this.folderName);
        
        // Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ Ïπ¥Îìú
        const statsCard = contentEl.createDiv();
        statsCard.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; padding: 16px; background: var(--background-primary-alt); border-radius: 8px;';

        const createStatBox = (label, value, color) => {
            const box = statsCard.createDiv();
            box.style.textAlign = 'center';
            box.createEl('div', { text: value }).style.cssText = `font-size: 24px; font-weight: bold; color: ${color};`;
            box.createEl('div', { text: label }).style.cssText = 'font-size: 0.9em; color: var(--text-muted); margin-top: 4px;';
        };

        const accuracy = folderStats.attempts > 0 ? Math.round((folderStats.correct / folderStats.attempts) * 100) : 0;
        createStatBox('Ï†ïÎãµÎ•†', `${accuracy}%`, accuracy >= 70 ? '#10b981' : '#ef4444');
        createStatBox('Ï¥ù ÏãúÎèÑ', `${folderStats.attempts}Ìöå`, 'var(--interactive-accent)');
        createStatBox('ÌïôÏäµ ÏãúÍ∞Ñ', `${Math.round(folderStats.time / 60)}Î∂Ñ`, 'var(--text-muted)');
        
        if (history.length === 0) {
            contentEl.createDiv({ 
                cls: 'lp-empty-message',
                text: 'ÏïÑÏßÅ ÌïôÏäµ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.'
            });
            return;
        }

        // ÌïôÏäµ ÏÑ∏ÏÖò Î™©Î°ù
        contentEl.createEl('h3', { text: `üìã ÌïôÏäµ ÏÑ∏ÏÖò Í∏∞Î°ù (${history.length}Í∞ú)` });
        
        const sessionList = contentEl.createDiv({ cls: 'lp-session-list' });
        sessionList.style.cssText = 'max-height: 50vh; overflow-y: auto; border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 8px;';

        // ÏµúÍ∑º ÏàúÏúºÎ°ú Ï†ïÎ†¨
        const sortedHistory = [...history].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

        for (const record of sortedHistory) {
            const sessionDiv = sessionList.createDiv({ cls: 'lp-session-item' });
            sessionDiv.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary);';

            const topRow = sessionDiv.createDiv();
            topRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
            
            const date = new Date(record.timestamp || Date.now());
            const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            const infoDiv = topRow.createDiv();
            infoDiv.createEl('div', { text: dateStr }).style.cssText = 'font-weight: 500; margin-bottom: 4px;';
            infoDiv.createEl('div', { 
                text: `üìÑ ${record.quizId || 'Ïïå Ïàò ÏóÜÏùå'}`,
            }).style.cssText = 'font-size: 0.9em; color: var(--text-muted);';

            const statsDiv = topRow.createDiv();
            statsDiv.style.cssText = 'text-align: right;';
            
            const statusBadge = statsDiv.createEl('span', { 
                text: record.correct ? '‚úÖ Ï†ïÎãµ' : '‚ùå Ïò§Îãµ'
            });
            statusBadge.style.cssText = `padding: 2px 8px; border-radius: 12px; font-size: 0.85em; background: ${record.correct ? '#10b981' : '#ef4444'}; color: white; display: inline-block; margin-bottom: 4px;`;
            
            if (record.duration) {
                statsDiv.createEl('div', { 
                    text: `${Math.round(record.duration)}Ï¥à`
                }).style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
            }
        }
    }

    async clearFolderStats() {
        // Ìè¥Îçî ÌÜµÍ≥Ñ Ï¥àÍ∏∞Ìôî
        if (this.plugin.settings.stats.folderStats?.[this.folderName]) {
            delete this.plugin.settings.stats.folderStats[this.folderName];
        }

        // ÌûàÏä§ÌÜ†Î¶¨ÏóêÏÑú Ìï¥Îãπ Ìè¥Îçî Í∏∞Î°ù Ï†úÍ±∞
        if (this.plugin.settings.stats.studyHistory) {
            this.plugin.settings.stats.studyHistory = this.plugin.settings.stats.studyHistory.filter(
                h => h.folder !== this.folderName
            );
        }

        await this.plugin.saveSettings();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ==================== ÏµúÍ∑º ÌååÏùº Î™©Î°ù Î™®Îã¨ (enhanced-cloze Ïä§ÌÉÄÏùº) ====================
class RecentFilesModal extends Modal {
    constructor(app, plugin, files) {
        super(app);
        this.plugin = plugin;
        this.files = files;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('lp-recent-files-modal');

        contentEl.createEl('h2', { text: 'üìã ÌååÏùº Î™©Î°ù' });

        if (this.files.length === 0) {
            contentEl.createDiv({
                cls: 'lp-empty-message',
                text: 'ÌååÏùºÏù¥ ÏóÜÏäµÎãàÎã§.'
            });
            return;
        }

        // ÌååÏùº Ï†ïÎ†¨ ÏòµÏÖò
        const sortContainer = contentEl.createDiv();
        sortContainer.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const sortByNameBtn = sortContainer.createEl('button', { text: 'üìù Ïù¥Î¶ÑÏàú' });
        sortByNameBtn.style.cssText = 'flex: 1; padding: 8px; border-radius: 6px;';
        sortByNameBtn.onclick = () => {
            this.files.sort((a, b) => a.basename.localeCompare(b.basename));
            this.renderFileList(contentEl);
        };

        const sortByDateBtn = sortContainer.createEl('button', { text: 'üìÖ ÏµúÏã†Ïàú' });
        sortByDateBtn.style.cssText = 'flex: 1; padding: 8px; border-radius: 6px;';
        sortByDateBtn.onclick = () => {
            this.files.sort((a, b) => b.stat.mtime - a.stat.mtime);
            this.renderFileList(contentEl);
        };

        this.renderFileList(contentEl);
    }

    renderFileList(container) {
        // Í∏∞Ï°¥ ÌååÏùº Î¶¨Ïä§Ìä∏ Ï†úÍ±∞
        const existingList = container.querySelector('.lp-file-list');
        if (existingList) existingList.remove();

        const fileList = container.createDiv({ cls: 'lp-file-list' });
        fileList.style.cssText = 'max-height: 60vh; overflow-y: auto; border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 8px;';

        this.files.forEach(file => {
            const fileItem = fileList.createDiv({ cls: 'lp-file-item' });
            fileItem.style.cssText = 'padding: 12px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-primary-alt); cursor: pointer; transition: all 0.2s;';

            const topRow = fileItem.createDiv();
            topRow.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';

            const nameDiv = topRow.createDiv();
            nameDiv.createEl('div', { text: file.basename }).style.cssText = 'font-weight: 500; margin-bottom: 4px;';
            
            const dateStr = new Date(file.stat.mtime).toLocaleDateString('ko-KR');
            nameDiv.createEl('div', { text: `üìÖ ${dateStr}` }).style.cssText = 'font-size: 0.85em; color: var(--text-muted);';

            // ÌÄ¥Ï¶à Í∞ùÏ≤¥Í∞Ä ÏûàÏúºÎ©¥ ÌÄ¥Ï¶à ÏãúÏûë, ÌååÏùº Í∞ùÏ≤¥Î©¥ ÌååÏùº Ïó¥Í∏∞
            const actionBtn = topRow.createEl('button', { 
                text: file.quiz ? '‚ñ∂Ô∏è ÏãúÏûë' : 'üìñ Ïó¥Í∏∞'
            });
            actionBtn.style.cssText = 'padding: 6px 12px; background: var(--interactive-accent); color: white; border: none; border-radius: 4px;';
            actionBtn.onclick = async (e) => {
                e.stopPropagation();
                if (file.quiz) {
                    // ÌÄ¥Ï¶à Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞
                    new QuizModal(this.app, this.plugin, file.path).open();
                    this.close();
                } else {
                    // ÏùºÎ∞ò ÌååÏùºÏù∏ Í≤ΩÏö∞
                    await this.app.workspace.openLinkText(file.path, '', false);
                    this.close();
                }
            };

            fileItem.onclick = async () => {
                if (file.quiz) {
                    new QuizModal(this.app, this.plugin, file.path).open();
                    this.close();
                } else {
                    await this.app.workspace.openLinkText(file.path, '', false);
                    this.close();
                }
            };

            fileItem.addEventListener('mouseenter', () => {
                fileItem.style.background = 'var(--background-secondary)';
                fileItem.style.borderColor = 'var(--interactive-accent)';
            });

            fileItem.addEventListener('mouseleave', () => {
                fileItem.style.background = 'var(--background-primary-alt)';
                fileItem.style.borderColor = 'var(--background-modifier-border)';
            });
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

module.exports = LearningStrategyPlugin;