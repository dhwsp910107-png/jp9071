const { Plugin, Notice, Setting, PluginSettingTab, Modal, Menu, TFile, ItemView } = require('obsidian');
// ì»¤ìŠ¤í…€ ì…ë ¥ ëª¨ë‹¬ í•¨ìˆ˜ (ë©”ëª¨ ì…ë ¥ìš©)
function showNoteInputModal(onSubmit) {
    class NoteInputModal extends Modal {
        constructor(app, onSubmit) {
            super(app);
            this.onSubmit = onSubmit;
        }
        onOpen() {
            const { contentEl } = this;
            contentEl.empty();
            contentEl.createEl('h3', { text: 'ë©”ëª¨ ì…ë ¥' });
            const textarea = contentEl.createEl('textarea');
            textarea.style.width = '100%';
            textarea.style.height = '80px';
            textarea.placeholder = 'ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”';
            const saveBtn = contentEl.createEl('button', { text: 'ì €ì¥' });
            saveBtn.style.marginTop = '16px';
            saveBtn.onclick = () => {
                const value = textarea.value;
                this.close();
                if (this.onSubmit) this.onSubmit(value);
            };
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    saveBtn.click();
                }
            });
        }
        onClose() {
            this.contentEl.empty();
        }
    }
    const modal = new NoteInputModal(app, onSubmit);
    modal.open();
}
// Force cache refresh - v4.4.0

// ëŒ€ì‹œë³´ë“œ ë·° íƒ€ì… ìƒìˆ˜
const QUIZ_DASHBOARD_VIEW_TYPE = 'quiz-sp2-dashboard-view';

const DEFAULT_SETTINGS = {
    quizFolder: 'HanziQuiz',
    questionsFolder: 'HanziQuiz/Questions',
    resultsFolder: 'HanziQuiz/Results',
    wrongAnswersFolder: 'HanziQuiz/WrongAnswers',
    archiveFolder: 'HanziQuiz/Archive',  // ì•„ì¹´ì´ë¸Œ í´ë”
    bookmarkFolder: 'â­ ë¶ë§ˆí¬',  // ë¶ë§ˆí¬ í´ë”
    attachmentFolderName: 'ì²¨ë¶€íŒŒì¼',  // ì²¨ë¶€íŒŒì¼ í´ë”ëª… (ê° ë¬¸ì œ í´ë” í•˜ìœ„)
    questionFolders: ['ê¸°ë³¸', 'í•œì', 'ì–´íœ˜', 'ë¬¸ë²•'],
    timerPerQuestion: 30,
    enableTimer: true,
    shuffleQuestions: true,
    shuffleOptions: true,
    showHintAfterWrong: true,
    reducedAnimations: false,  // ë ‰ ë°©ì§€ ì˜µì…˜
    dashboardQuickMemo: '',  // ëŒ€ì‹œë³´ë“œ ìƒë‹¨ í•œì¤„ ë©”ëª¨
    dailyChecklists: {},  // ì¼ë³„ ì²´í¬ë¦¬ìŠ¤íŠ¸ { "YYYY-MM-DD": { items: [], notes: [], quickMemo: "" } }
    weeklyChecklists: {},  // ì£¼ê°„ ì²´í¬ë¦¬ìŠ¤íŠ¸ { "YYYY-Wnn": { items: [], notes: [], quickMemo: "" } }
    monthlyChecklists: {},  // ì›”ê°„ ì²´í¬ë¦¬ìŠ¤íŠ¸ { "YYYY-MM": { items: [], notes: [], quickMemo: "" } }
    weeklyTemplates: [],  // ì£¼ê°„ í…œí”Œë¦¿ { name: "", items: [], timestamp: 0 }
    monthlyTemplates: [],  // ì›”ê°„ í…œí”Œë¦¿ { name: "", items: [], timestamp: 0 }
    checklistTemplates: [],  // ì²´í¬ë¦¬ìŠ¤íŠ¸ í…œí”Œë¦¿ (ì¼ë³„/ì£¼ê°„/ì›”ë³„ í†µí•©) { name: "", items: [], type: "daily|weekly|monthly" }
    ribbonMenuItems: [  // ë¦¬ë³¸ ë©”ë‰´ í•­ëª© ì„¤ì •
        {
            id: 'dashboard',
            title: 'â† ëŒ€ì‹œë³´ë“œ',
            icon: 'home',
            action: 'dashboard',
            enabled: true
        },
        {
            id: 'record-management',
            title: 'ğŸ“Š ê¸°ë¡ ê´€ë¦¬',
            icon: 'chart-line',
            action: 'record-management',
            enabled: true
        },
        {
            id: 'difficulty',
            title: 'ğŸ¯ ë‚œì´ë„ ì„¤ì •',
            icon: 'target',
            action: 'difficulty',
            enabled: true
        },
        {
            id: 'timer',
            title: 'âš™ï¸ ì„¤ì •',
            icon: 'settings',
            action: 'timer',
            enabled: true
        },
        {
            id: 'bookmark',
            title: 'â­ ë¶ë§ˆí¬',
            icon: 'star',
            action: 'bookmark',
            enabled: true
        },
        {
            id: 'audio-list',
            title: 'ğŸµ ìŒì„±íŒŒì¼ ëª©ë¡',
            icon: 'audio-file',
            action: 'audio-list',
            enabled: true
        },
        {
            id: 'edit',
            title: 'âœï¸ í¸ì§‘',
            icon: 'pencil',
            action: 'edit',
            enabled: true
        },
        {
            id: 'delete',
            title: 'ğŸ—‘ï¸ ì‚­ì œ',
            icon: 'trash',
            action: 'delete',
            enabled: true
        }
    ]
};

class HanziQuizPlugin extends Plugin {
    async onload() {
        await this.loadSettings();
        
        if (!this.settings.stats) {
            this.settings.stats = {
                totalAttempts: 0,
                totalCorrect: 0,
                totalWrong: 0,
                totalQuestions: 0,
                bookmarkedCount: 0,
                lastStudyDate: null,
                studyHistory: []
            };
        }

        // í€´ì¦ˆ ë¡œê·¸ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” (í”ŒëŸ¬ê·¸ì¸ ë ˆë²¨ì—ì„œ ëˆ„ì  ê´€ë¦¬)
        if (!this.quizLogHistory) {
            this.quizLogHistory = [];
        }

        // ì„±ëŠ¥ ìµœì í™” CSS ì£¼ì…
        this.injectPerformanceCSS();

        // ëŒ€ì‹œë³´ë“œ ë·° ë“±ë¡ - ìš°ì¸¡ ì‚¬ì´ë“œë°”ìš©
        this.registerView(
            QUIZ_DASHBOARD_VIEW_TYPE,
            (leaf) => new QuizDashboardView(leaf, this)
        );

        this.addRibbonIcon('lightbulb', 'í•œì í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ', () => {
            this.openDashboard();
        });

        // ìš°ì¸¡ ì‚¬ì´ë“œë°” ì•„ì´ì½˜ ì¶”ê°€ - ë·°ë¡œ ë³€ê²½
        this.addRibbonIcon('brain-circuit', 'í•œì í€´ì¦ˆ í†µí•© ëŒ€ì‹œë³´ë“œ (ìš°ì¸¡ ê³ ì •)', () => {
            this.openQuizDashboardView();
        });

        // ëŒ€ì‹œë³´ë“œ ë·° ëª…ë ¹ì–´ ì¶”ê°€
        this.addCommand({
            id: 'open-quiz-dashboard-view',
            name: 'ğŸ“Š í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ ì—´ê¸° (ìš°ì¸¡ ì‚¬ì´ë“œë°”)',
            callback: () => {
                this.openQuizDashboardView();
            }
        });

        this.addCommand({
            id: 'open-dashboard',
            name: 'ğŸ“Š ëŒ€ì‹œë³´ë“œ ì—´ê¸°',
            callback: () => this.openDashboard()
        });

        this.addCommand({
            id: 'create-hanzi-question',
            name: 'ğŸ“ ë¬¸ì œ ë§Œë“¤ê¸°',
            callback: () => new HanziQuestionModal(this.app, this).open()
        });

        this.addCommand({
            id: 'start-quiz',
            name: 'ğŸ¯ í€´ì¦ˆ ì‹œì‘í•˜ê¸°',
            callback: () => this.startQuiz()
        });

        this.addCommand({
            id: 'start-wrong-quiz',
            name: 'âŒ ì˜¤ë‹µ ë³µìŠµí•˜ê¸°',
            callback: () => this.startWrongAnswerQuiz()
        });

        this.addCommand({
            id: 'view-quiz-list',
            name: 'ğŸ“‹ ë¬¸ì œ ëª©ë¡ ë³´ê¸°',
            callback: () => this.viewQuestionList()
        });

        this.addCommand({
            id: 'generate-dashboard',
            name: 'ğŸ“Š ë¬¸ì œ ëª©ë¡ ëŒ€ì‹œë³´ë“œ ìƒì„±',
            callback: () => this.generateQuestionDashboard()
        });

        this.addCommand({
            id: 'question-dashboard-modal',
            name: 'ğŸ“‹ ë¬¸ì œ ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬',
            callback: () => new QuestionDashboardModal(this.app, this).open()
        });

        this.addCommand({
            id: 'view-statistics',
            name: 'ğŸ“ˆ í•™ìŠµ í†µê³„ ë³´ê¸°',
            callback: () => this.viewStatistics()
        });

        this.addCommand({
            id: 'create-subjective-qa',
            name: 'ğŸ“‹ ì£¼ê´€ì‹ ë¬¸ì œ ë§Œë“¤ê¸°',
            callback: () => new SubjectiveQAModal(this.app, this).open()
        });

        this.addSettingTab(new HanziQuizSettingTab(this.app, this));
        await this.ensureFolders();

        // ë¶ë§ˆí¬ êµ¬ì¡° ë§ˆì´ê·¸ë ˆì´ì…˜ (bookmarked â†’ bookmarkFolder)
        await this.migrateBookmarkStructure();

        console.log('ğŸš€ Hanzi Quiz í”ŒëŸ¬ê·¸ì¸ ë¡œë“œë¨');
    }
        formatTime(seconds) {
            if (typeof seconds !== "number" || isNaN(seconds) || seconds < 0) return "0ì´ˆ";
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            if (h > 0) return `${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
            if (m > 0) return `${m}ë¶„ ${s}ì´ˆ`;
            return `${s}ì´ˆ`;
        }

    // ğŸŒ í…ìŠ¤íŠ¸ ì–¸ì–´ ìë™ ê°ì§€ (í•œêµ­ì–´, ì˜ì–´, ì¼ë³¸ì–´, ì¤‘êµ­ì–´)
    detectLanguage(text) {
        if (!text || text.trim().length === 0) {
            return 'ko-KR'; // ê¸°ë³¸ê°’
        }

        const trimmed = text.trim();
        const totalChars = trimmed.length;
        
        let koreanChars = 0;
        let japaneseChars = 0;
        let chineseChars = 0;
        let englishChars = 0;
        
        for (let i = 0; i < trimmed.length; i++) {
            const char = trimmed[i];
            const code = char.charCodeAt(0);
            
            // í•œê¸€ (ê°€-í£, ã„±-ã…, ã…-ã…£)
            if ((code >= 0xAC00 && code <= 0xD7A3) || // ê°€-í£
                (code >= 0x1100 && code <= 0x11FF) || // í•œê¸€ ìëª¨
                (code >= 0x3131 && code <= 0x318E)) {  // í•œê¸€ í˜¸í™˜ ìëª¨
                koreanChars++;
            }
            // íˆë¼ê°€ë‚˜ (ã-ã‚“)
            else if (code >= 0x3040 && code <= 0x309F) {
                japaneseChars++;
            }
            // ê°€íƒ€ì¹´ë‚˜ (ã‚¡-ãƒ¶)
            else if (code >= 0x30A0 && code <= 0x30FF) {
                japaneseChars++;
            }
            // ì¤‘êµ­ì–´ ê°„ì²´/ë²ˆì²´ (CJK Unified Ideographs)
            else if ((code >= 0x4E00 && code <= 0x9FFF) ||  // ê¸°ë³¸ í•œì
                     (code >= 0x3400 && code <= 0x4DBF)) {  // í™•ì¥ A
                chineseChars++;
            }
            // ì˜ì–´ (A-Z, a-z)
            else if ((code >= 65 && code <= 90) || (code >= 97 && code <= 122)) {
                englishChars++;
            }
        }
        
        // ë¹„ìœ¨ ê³„ì‚°
        const koreanRatio = koreanChars / totalChars;
        const japaneseRatio = japaneseChars / totalChars;
        const chineseRatio = chineseChars / totalChars;
        const englishRatio = englishChars / totalChars;
        
        console.log('ğŸ” ì–¸ì–´ ê°ì§€:', {
            text: trimmed.substring(0, 30) + '...',
            totalChars,
            korean: `${koreanChars}ì (${(koreanRatio * 100).toFixed(1)}%)`,
            japanese: `${japaneseChars}ì (${(japaneseRatio * 100).toFixed(1)}%)`,
            chinese: `${chineseChars}ì (${(chineseRatio * 100).toFixed(1)}%)`,
            english: `${englishChars}ì (${(englishRatio * 100).toFixed(1)}%)`
        });
        
        // ìš°ì„ ìˆœìœ„: í•œêµ­ì–´ > ì¼ë³¸ì–´ > ì¤‘êµ­ì–´ > ì˜ì–´
        if (koreanRatio >= 0.1) {
            console.log('âœ… ê°ì§€ëœ ì–¸ì–´: í•œêµ­ì–´ (ko-KR)');
            return 'ko-KR';
        }
        if (japaneseRatio >= 0.1) {
            console.log('âœ… ê°ì§€ëœ ì–¸ì–´: ì¼ë³¸ì–´ (ja-JP)');
            return 'ja-JP';
        }
        if (chineseRatio >= 0.1) {
            console.log('âœ… ê°ì§€ëœ ì–¸ì–´: ì¤‘êµ­ì–´ (zh-CN)');
            return 'zh-CN';
        }
        if (englishRatio >= 0.3) {
            console.log('âœ… ê°ì§€ëœ ì–¸ì–´: ì˜ì–´ (en-US)');
            return 'en-US';
        }
        
        // ê¸°ë³¸ê°’
        console.log('âš ï¸ ì–¸ì–´ ê°ì§€ ì‹¤íŒ¨. ê¸°ë³¸ê°’: ko-KR');
        return 'ko-KR';
    }

    // ğŸ¤ ì˜¤í”„ë¼ì¸ TTS (Web Speech API)
    async speakText(text, options = {}) {
        if (!text || text.trim().length === 0) {
            new Notice('ì½ì„ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // Web Speech API ì§€ì› í™•ì¸
        if (!window.speechSynthesis) {
            new Notice('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì½ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            // ì§„í–‰ ì¤‘ì¸ ìŒì„± ì¤‘ì§€
            window.speechSynthesis.cancel();

            // ğŸŒ ìë™ ì–¸ì–´ ê°ì§€
            const detectedLang = this.detectLanguage(text);
            console.log(`ğŸŒ ê°ì§€ëœ ì–¸ì–´: ${detectedLang}`);

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = detectedLang;
            utterance.rate = options.rate || 1.0;
            utterance.pitch = options.pitch || 1.0;
            utterance.volume = options.volume || 1.0;

            // ì–¸ì–´ì— ë§ëŠ” ìŒì„± ì„ íƒ
            const voices = window.speechSynthesis.getVoices();
            const langPrefix = detectedLang.split('-')[0]; // 'ko', 'en', 'ja', 'zh'
            
            // ì‚¼ì„± TTS ìš°ì„  ì„ íƒ
            let selectedVoice = voices.find(v => 
                v.lang.startsWith(langPrefix) && 
                (v.name.toLowerCase().includes('samsung') || 
                 v.name.includes('ì‚¼ì„±') ||
                 v.voiceURI.toLowerCase().includes('samsung'))
            );

            // ì‚¼ì„± TTS ì—†ìœ¼ë©´ í•´ë‹¹ ì–¸ì–´ì˜ ì•„ë¬´ ìŒì„±
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.startsWith(langPrefix));
            }

            if (selectedVoice) {
                utterance.voice = selectedVoice;
                console.log(`ğŸ¤ ì„ íƒëœ ìŒì„±: ${selectedVoice.name} (${selectedVoice.lang})`);
                
                // ì‚¼ì„± TTSëŠ” rate/pitch ë²”ìœ„ ì œí•œ
                if (selectedVoice.name.toLowerCase().includes('samsung') || 
                    selectedVoice.name.includes('ì‚¼ì„±')) {
                    utterance.rate = Math.max(0.5, Math.min(2.0, utterance.rate));
                    utterance.pitch = Math.max(0.5, Math.min(2.0, utterance.pitch));
                    console.log('ğŸ“± ì‚¼ì„± TTS: rate/pitch ë²”ìœ„ ì œí•œ (0.5~2.0)');
                }
            } else {
                console.log('âš ï¸ í•´ë‹¹ ì–¸ì–´ ìŒì„± ì—†ìŒ. ê¸°ë³¸ ìŒì„± ì‚¬ìš©');
            }

            utterance.onstart = () => {
                console.log('â–¶ï¸ TTS ì¬ìƒ ì‹œì‘');
                new Notice('ğŸ”Š ìŒì„± ì¬ìƒ ì¤‘...');
            };

            utterance.onend = () => {
                console.log('â¹ï¸ TTS ì¬ìƒ ì™„ë£Œ');
            };

            utterance.onerror = (event) => {
                console.error('âŒ TTS ì˜¤ë¥˜:', event);
                new Notice('âŒ ìŒì„± ì¬ìƒ ì‹¤íŒ¨');
            };

            window.speechSynthesis.speak(utterance);
            
        } catch (error) {
            console.error('TTS Error:', error);
            new Notice('âŒ ìŒì„± ì½ê¸° ì‹¤íŒ¨: ' + error.message);
        }
    }

    async ensureFolders() {
        const folders = [
            this.settings.quizFolder,
            this.settings.questionsFolder,
            this.settings.resultsFolder,
            this.settings.wrongAnswersFolder,
            this.settings.archiveFolder
        ];

        // ê¸°ë³¸ í´ë” ìƒì„±
        for (const folder of folders) {
            const exists = this.app.vault.getAbstractFileByPath(folder);
            if (!exists) {
                try {
                    await this.app.vault.createFolder(folder);
                    console.log('ğŸ“ í´ë” ìƒì„±ë¨:', folder);
                } catch (e) {
                    console.log('Folder might already exist:', folder);
                }
            }
        }

        // questionFolders ë‚´ í•˜ìœ„ í´ë”ë“¤ë„ ìƒì„±
        if (this.settings.questionFolders && this.settings.questionFolders.length > 0) {
            const attachmentFolderName = this.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
            
            for (const subfolder of this.settings.questionFolders) {
                const folderPath = `${this.settings.questionsFolder}/${subfolder}`;
                const attachmentPath = `${folderPath}/${attachmentFolderName}`;
                const archivePath = `${folderPath}/ì•„ì¹´ì´ë¸Œ/${attachmentFolderName}`;
                
                // ë¬¸ì œ í´ë” ìƒì„±
                const exists = this.app.vault.getAbstractFileByPath(folderPath);
                if (!exists) {
                    try {
                        await this.app.vault.createFolder(folderPath);
                        console.log('ğŸ“ í•˜ìœ„ í´ë” ìƒì„±ë¨:', folderPath);
                    } catch (e) {
                        console.log('Subfolder might already exist:', folderPath);
                    }
                }
                
                // ì²¨ë¶€íŒŒì¼ í´ë” ìƒì„±
                const attachmentExists = this.app.vault.getAbstractFileByPath(attachmentPath);
                if (!attachmentExists) {
                    try {
                        await this.app.vault.createFolder(attachmentPath);
                        console.log('ğŸ“ ì²¨ë¶€íŒŒì¼ í´ë” ìƒì„±ë¨:', attachmentPath);
                    } catch (e) {
                        console.log('Attachment folder might already exist:', attachmentPath);
                    }
                }
                
                // ì•„ì¹´ì´ë¸Œ/ì²¨ë¶€íŒŒì¼ í´ë” ìƒì„±
                const archiveExists = this.app.vault.getAbstractFileByPath(archivePath);
                if (!archiveExists) {
                    try {
                        await this.app.vault.createFolder(archivePath);
                        console.log('ğŸ—„ï¸ ì•„ì¹´ì´ë¸Œ ì²¨ë¶€íŒŒì¼ í´ë” ìƒì„±ë¨:', archivePath);
                    } catch (e) {
                        console.log('Archive attachment folder might already exist:', archivePath);
                    }
                }
            }
        }
    }

    async loadSettings() {
        this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
    }

    async saveSettings() {
        await this.saveData(this.settings);
        // CSS ì¬ì ìš© (ë””ë°”ìš´ìŠ¤)
        if (this.cssUpdateTimeout) {
            clearTimeout(this.cssUpdateTimeout);
        }
        this.cssUpdateTimeout = setTimeout(() => {
            this.injectPerformanceCSS();
        }, 300);
    }

    // ë¬¸ì œ ì‚­ì œ í•¨ìˆ˜
    async deleteQuestion(question) {
        try {
            if (!question.filePath) {
                throw new Error('íŒŒì¼ ê²½ë¡œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
            }

            // íŒŒì¼ ì°¾ê¸°
            let file = this.app.vault.getAbstractFileByPath(question.filePath);
            
            // íŒŒì¼ì´ ì—†ìœ¼ë©´ ë‹¤ë¥¸ ê²½ë¡œ ì‹œë„
            if (!file) {
                const files = this.app.vault.getMarkdownFiles();
                file = files.find(f => f.path === question.filePath || f.path.endsWith(question.filePath));
            }

            if (!file) {
                throw new Error(`íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${question.filePath}`);
            }

            // íŒŒì¼ ì‚­ì œ
            await this.app.vault.delete(file);
            
            return true;
        } catch (error) {
            console.error('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨:', error);
            throw error;
        }
    }

    // ì„±ëŠ¥ ìµœì í™” CSS ì£¼ì… (ë ‰ ë°©ì§€)
    injectPerformanceCSS() {
        const existingStyle = document.getElementById('hanzi-quiz-performance-css');
        
        if (this.settings.reducedAnimations) {
            if (existingStyle) return;
            
            const style = document.createElement('style');
            style.id = 'hanzi-quiz-performance-css';
            style.textContent = `
/* Hanzi Quiz - Performance Optimization (ë ‰ ë°©ì§€) */

/* ì• ë‹ˆë©”ì´ì…˜ ìµœì†Œí™” */
.quiz-modal *,
.modal * {
    animation-duration: 0.1s !important;
    transition-duration: 0.1s !important;
}

/* GPU ê°€ì† í™œì„±í™” */
.quiz-modal,
.modal,
.quiz-option-button,
.option-button,
.image-zoom-modal {
    will-change: auto;
    transform: translateZ(0);
    -webkit-transform: translateZ(0);
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
}

/* ì´ë¯¸ì§€ ë Œë”ë§ ìµœì í™” */
img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
}

/* ìŠ¤í¬ë¡¤ ì„±ëŠ¥ ê°œì„  */
* {
    -webkit-overflow-scrolling: touch;
    scroll-behavior: auto !important;
}

/* ê·¸ë¦¼ì íš¨ê³¼ ì œê±° (ì„±ëŠ¥ í–¥ìƒ) */
.quiz-option-button,
.option-button,
button,
.modal {
    box-shadow: none !important;
}

/* í˜¸ë²„ íš¨ê³¼ ìµœì†Œí™” */
button:hover,
.quiz-option-button:hover {
    transform: none !important;
}

/* ë¶ë§ˆí¬ ì»¨í…Œì´ë„ˆ ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 600px) {
    .bookmark-container {
        padding: 10px 12px !important;
        gap: 8px !important;
    }
    
    .bookmark-container input[type="checkbox"] {
        width: 20px !important;
        height: 20px !important;
    }
    
    .bookmark-container label {
        font-size: 14px !important;
    }
    
    .bookmark-container span {
        font-size: 12px !important;
        padding: 3px 10px !important;
    }
}

/* í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ ìŠ¤íƒ€ì¼ */
.quiz-dashboard-container {
    height: 100%;
    overflow-y: auto;
    background: var(--background-primary);
}

.quiz-dashboard-header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--background-secondary);
    border-bottom: 1px solid var(--background-modifier-border);
}

.quiz-dashboard-btn {
    padding: 6px 12px;
    background: var(--interactive-accent);
    color: var(--text-on-accent);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s;
}

.quiz-dashboard-btn:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}

.quiz-stats-summary {
    padding: 16px;
    margin-bottom: 16px;
}

.quiz-folder-card {
    padding: 16px;
    background: var(--background-primary-alt);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    transition: all 0.2s;
    cursor: pointer;
}

.quiz-folder-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* ëª¨ë°”ì¼ ìµœì í™” */
@media (max-width: 768px), (pointer: coarse) {
    .quiz-dashboard-container {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y pinch-zoom;
    }
    
    .quiz-dashboard-btn, .quiz-tab-btn {
        min-height: 44px;
        min-width: 44px;
        padding: 8px 12px;
        font-size: 1em;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    .quiz-folder-card {
        min-height: 48px;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
    
    /* ëª¨ë°”ì¼ ì…ë ¥ í•„ë“œ ìµœì í™” */
    .quiz-daily-section input,
    .quiz-weekly-section input,
    .quiz-monthly-section input {
        font-size: 16px !important;
        min-height: 44px !important;
    }
    
    /* ëª¨ë°”ì¼ ì²´í¬ë°•ìŠ¤ í™•ëŒ€ */
    .quiz-daily-section input[type="checkbox"],
    .quiz-weekly-section input[type="checkbox"],
    .quiz-monthly-section input[type="checkbox"] {
        width: 24px !important;
        height: 24px !important;
    }
    
    /* ëª¨ë°”ì¼ ë²„íŠ¼ í„°ì¹˜ ì˜ì—­ í™•ëŒ€ */
    .quiz-daily-section button,
    .quiz-weekly-section button,
    .quiz-monthly-section button {
        min-height: 44px !important;
        min-width: 44px !important;
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }
}
            `;
            document.head.appendChild(style);
        } else {
            if (existingStyle) {
                existingStyle.remove();
            }
        }
    }
    
    // ë¶ë§ˆí¬ êµ¬ì¡° ë§ˆì´ê·¸ë ˆì´ì…˜ (bookmarked â†’ bookmarkFolder)
    async migrateBookmarkStructure() {
        console.log('ğŸ”„ ë¶ë§ˆí¬ êµ¬ì¡° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');
        const allQuestions = await this.loadAllQuestions();
        let migratedCount = 0;
        
        for (const question of allQuestions) {
            // ê¸°ì¡´ bookmarked ì†ì„±ì´ ìˆê³ , bookmarkFolderê°€ ì—†ìœ¼ë©´ ë§ˆì´ê·¸ë ˆì´ì…˜
            if (question.bookmarked === true && (!question.bookmarkFolder || question.bookmarkFolder.length === 0)) {
                question.bookmarkFolder = question.folder || 'ê¸°ë³¸';
                await this.saveQuestion(question, false);
                migratedCount++;
                console.log(`âœ… ë§ˆì´ê·¸ë ˆì´ì…˜: [${question.folder || 'ê¸°ë³¸'}] ${question.hanzi}`);
            }
        }
        
        if (migratedCount > 0) {
            console.log(`âœ¨ ë¶ë§ˆí¬ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ: ${migratedCount}ê°œ ë¬¸ì œ ë³€í™˜ë¨`);
            new Notice(`âœ¨ ë¶ë§ˆí¬ ${migratedCount}ê°œ ìë™ ë³€í™˜ ì™„ë£Œ!`);
            // ë¶ë§ˆí¬ ëª©ë¡ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
            await this.updateBookmarkListTemplate();
        } else {
            console.log('ğŸ“‹ ë§ˆì´ê·¸ë ˆì´ì…˜í•  ë¶ë§ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    onunload() {
        const existingStyle = document.getElementById('hanzi-quiz-performance-css');
        if (existingStyle) {
            existingStyle.remove();
        }
    }

    async openDashboard() {
        new DashboardModal(this.app, this).open();
    }

    async openQuizDashboardView() {
        const leaves = this.app.workspace.getLeavesOfType(QUIZ_DASHBOARD_VIEW_TYPE);
        
        if (leaves.length > 0) {
            // ì´ë¯¸ ë·°ê°€ ì—´ë ¤ìˆìœ¼ë©´ í™œì„±í™”
            this.app.workspace.revealLeaf(leaves[0]);
        } else {
            // ìš°ì¸¡ ì‚¬ì´ë“œë°”ì— ìƒˆ ë·° ìƒì„±
            const leaf = this.app.workspace.getRightLeaf(false);
            await leaf.setViewState({
                type: QUIZ_DASHBOARD_VIEW_TYPE,
                active: true
            });
            this.app.workspace.revealLeaf(leaf);
        }
    }

    async startQuiz(difficulty = null, wrongAnswersOnly = false, folder = null, sortOrder = null) {
        console.log('ğŸ¯ í€´ì¦ˆ ì‹œì‘:', { difficulty, wrongAnswersOnly, folder, sortOrder });
        
        let questions = await this.loadAllQuestions();
        console.log(`ğŸ“ ì „ì²´ ë¬¸ì œ ìˆ˜: ${questions.length}ê°œ`);
        // ì •ìƒ ë¬¸ì œë§Œ í•„í„°ë§ (question, options, hanzi, number, folder í•„ìˆ˜)
        questions = questions.filter(q => q && q.question && q.options && q.options.length > 0 && q.hanzi && q.number && q.folder);
        if (questions.length === 0) {
            new Notice('âš ï¸ ì €ì¥ëœ ë¬¸ì œê°€ ì—†ê±°ë‚˜, ë¬¸ì œ íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ë¬¸ì œë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”!');
            console.error('âŒ ë¬¸ì œ ì—†ìŒ ë˜ëŠ” í˜•ì‹ ì˜¤ë¥˜. Questions í´ë” í™•ì¸ í•„ìš”:', this.settings.questionsFolder);
            return;
        }

        // í´ë” í•„í„°ë§
        if (folder) {
            const beforeFilter = questions.length;
            const bookmarkFolderName = this.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬';
            
            // ë¶ë§ˆí¬ í´ë” ì „ìš© í•„í„° (ì˜ˆ: "bookmark-í•œì", "bookmark-ì¤‘ìš”í•œ ë¬¸ì œ")
            if (folder.startsWith('bookmark-')) {
                const bmFolderName = folder.replace('bookmark-', '');
                console.log(`â­ ë¶ë§ˆí¬ í´ë” í•„í„°: ${bmFolderName}`);
                questions = questions.filter(q => {
                    // ë¬¸ì œ ë¶ë§ˆí¬ê°€ ì¼ì¹˜í•˜ê±°ë‚˜ ì„ íƒì§€ ë¶ë§ˆí¬ ì¤‘ í•˜ë‚˜ë¼ë„ ì¼ì¹˜í•˜ë©´ í¬í•¨
                    if (q.bookmarkFolder === bmFolderName) return true;
                    if (q.optionBookmarkFolders && q.optionBookmarkFolders.includes(bmFolderName)) return true;
                    return false;
                });
                console.log(`â­ í•„í„° ê²°ê³¼: ${beforeFilter}ê°œ â†’ ${questions.length}ê°œ`);
            }
            // í´ë”-ë¶ë§ˆí¬ ì¡°í•© ì²˜ë¦¬ (ì˜ˆ: "ê¸°ë³¸-with-bookmark-í•œì")
            else if (folder.includes('-with-bookmark-')) {
                const [regularFolder, bookmarkFolder] = folder.split('-with-bookmark-');
                console.log(`ğŸ“ í´ë” í•„í„°: ${regularFolder} + ë¶ë§ˆí¬: ${bookmarkFolder}`);
                // ë¨¼ì € ì¼ë°˜ í´ë”ë¡œ í•„í„°ë§
                questions = questions.filter(q => (q.folder || 'ê¸°ë³¸') === regularFolder);
                // ê·¸ ë‹¤ìŒ í•´ë‹¹ ë¶ë§ˆí¬ í´ë”ë¡œ í•„í„°ë§
                questions = questions.filter(q => q.bookmarkFolder === bookmarkFolder);
                console.log(`ğŸ“ í•„í„° ê²°ê³¼: ${beforeFilter}ê°œ â†’ ${questions.length}ê°œ`);
            }
            // ë¶ë§ˆí¬ í´ë” ë˜ëŠ” ë¶ë§ˆí¬ ì„œë¸Œí´ë”ì¸ ê²½ìš°
            else if (folder === bookmarkFolderName || folder.startsWith(bookmarkFolderName + '/')) {
                // ë¶ë§ˆí¬ ë©”ì¸ í´ë”ë©´ ëª¨ë“  ë¶ë§ˆí¬ ë¬¸ì œ í•„í„°ë§
                if (folder === bookmarkFolderName) {
                    questions = questions.filter(q => {
                        // ë¬¸ì œ ë¶ë§ˆí¬ê°€ ìˆê±°ë‚˜ ì„ íƒì§€ ë¶ë§ˆí¬ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í¬í•¨
                        if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
                        if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
                        return false;
                    });
                    console.log(`ğŸ“ í´ë” í•„í„°: ${folder} (ëª¨ë“  ë¶ë§ˆí¬) (${beforeFilter}ê°œ â†’ ${questions.length}ê°œ)`);
                } else {
                    // ë¶ë§ˆí¬ ì„œë¸Œí´ë”ë©´ í•´ë‹¹ í´ë”ë³„ ë¶ë§ˆí¬ë§Œ í•„í„°ë§
                    const subFolderName = folder.replace(bookmarkFolderName + '/', '');
                    questions = questions.filter(q => {
                        // ë¬¸ì œ ë¶ë§ˆí¬ê°€ ì¼ì¹˜í•˜ê±°ë‚˜ ì„ íƒì§€ ë¶ë§ˆí¬ ì¤‘ í•˜ë‚˜ë¼ë„ ì¼ì¹˜í•˜ë©´ í¬í•¨
                        if (q.bookmarkFolder === subFolderName) return true;
                        if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f === subFolderName)) return true;
                        return false;
                    });
                    console.log(`ğŸ“ í´ë” í•„í„°: ${folder} (ë¶ë§ˆí¬/${subFolderName}) (${beforeFilter}ê°œ â†’ ${questions.length}ê°œ)`);
                }
            } else {
                // ì¼ë°˜ í´ë”ëŠ” folder ì†ì„±ìœ¼ë¡œ í•„í„°ë§
                questions = questions.filter(q => (q.folder || 'ê¸°ë³¸') === folder);
                console.log(`ğŸ“ í´ë” í•„í„°: ${folder} (${beforeFilter}ê°œ â†’ ${questions.length}ê°œ)`);
            }
            
            if (questions.length === 0) {
                new Notice(`"${folder}" í´ë”ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
        }

        // ë‚œì´ë„ í•„í„°ë§
        if (difficulty) {
            const beforeFilter = questions.length;
            questions = questions.filter(q => q.difficulty === difficulty);
            console.log(`â­ ë‚œì´ë„ í•„í„°: ${difficulty} (${beforeFilter}ê°œ â†’ ${questions.length}ê°œ)`);
            if (questions.length === 0) {
                new Notice(`${difficulty} ë‚œì´ë„ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.`);
                return;
            }
        }

        // ì˜¤ë‹µ í•„í„°ë§
        if (wrongAnswersOnly) {
            const beforeFilter = questions.length;
            questions = questions.filter(q => q.wrongCount > 0);
            console.log(`âŒ ì˜¤ë‹µ í•„í„°: (${beforeFilter}ê°œ â†’ ${questions.length}ê°œ)`);
            if (questions.length === 0) {
                new Notice('ì˜¤ë‹µ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
        }

        console.log(`âœ… ìµœì¢… í€´ì¦ˆ ë¬¸ì œ ìˆ˜: ${questions.length}ê°œ`);
        
        // ì •ë ¬ ì˜µì…˜ì´ ì—†ìœ¼ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
        if (!sortOrder) {
            new QuizSortModal(this.app, questions.length, (selectedSort, selectedCount) => {
                this.startQuizWithSort(questions, wrongAnswersOnly, difficulty, selectedSort, selectedCount);
            }).open();
        } else {
            this.startQuizWithSort(questions, wrongAnswersOnly, difficulty, sortOrder, questions.length);
        }
    }
    
    startQuizWithSort(questions, wrongAnswersOnly, difficulty, sortOrder, questionCount) {
        // ì •ë ¬ ì ìš©
        let sortedQuestions = [...questions];
        
        switch(sortOrder) {
            case 'random':
                // ëœë¤ ì„ê¸°
                for (let i = sortedQuestions.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [sortedQuestions[i], sortedQuestions[j]] = [sortedQuestions[j], sortedQuestions[i]];
                }
                console.log('ğŸ² ëœë¤ ìˆœì„œë¡œ ì •ë ¬ë¨');
                break;
            case 'number-asc':
                // ë²ˆí˜¸ ì˜¤ë¦„ì°¨ìˆœ
                sortedQuestions.sort((a, b) => (a.number || 0) - (b.number || 0));
                console.log('ğŸ”¢ ë²ˆí˜¸ ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ë¨');
                break;
            case 'number-desc':
                // ë²ˆí˜¸ ë‚´ë¦¼ì°¨ìˆœ
                sortedQuestions.sort((a, b) => (b.number || 0) - (a.number || 0));
                console.log('ğŸ”½ ë²ˆí˜¸ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬ë¨');
                break;
            case 'wrong-desc':
                // ì˜¤ë‹µ ë§ì€ ìˆœ
                sortedQuestions.sort((a, b) => (b.wrongCount || 0) - (a.wrongCount || 0));
                console.log('âŒ ì˜¤ë‹µ ë§ì€ ìˆœìœ¼ë¡œ ì •ë ¬ë¨');
                break;
            case 'accuracy-asc':
                // ì •ë‹µë¥  ë‚®ì€ ìˆœ
                sortedQuestions.sort((a, b) => {
                    const accA = (a.correctCount || 0) + (a.wrongCount || 0) > 0 
                        ? (a.correctCount || 0) / ((a.correctCount || 0) + (a.wrongCount || 0)) 
                        : 1;
                    const accB = (b.correctCount || 0) + (b.wrongCount || 0) > 0 
                        ? (b.correctCount || 0) / ((b.correctCount || 0) + (b.wrongCount || 0)) 
                        : 1;
                    return accA - accB;
                });
                console.log('ğŸ“‰ ì •ë‹µë¥  ë‚®ì€ ìˆœìœ¼ë¡œ ì •ë ¬ë¨');
                break;
            default:
                console.log('âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ì •ë ¬ ì˜µì…˜, ê¸°ë³¸ ìˆœì„œ ìœ ì§€');
        }
        
        // ë¬¸ì œ ê°œìˆ˜ë§Œí¼ ìë¥´ê¸°
        if (questionCount && questionCount < sortedQuestions.length) {
            sortedQuestions = sortedQuestions.slice(0, questionCount);
            console.log(`ğŸ“ ë¬¸ì œ ê°œìˆ˜ ì œí•œ: ${sortedQuestions.length}ê°œ`);
        }
        
        new QuizPlayModal(this.app, this, sortedQuestions, wrongAnswersOnly, difficulty, false).open();
    }

    async startWrongAnswerQuiz() {
        await this.startQuiz(null, true);
    }
    
    async startQuizWithQuestions(questions, folderName = null) {
        if (!questions || questions.length === 0) {
            new Notice('ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        console.log(`âœ… ì»¤ìŠ¤í…€ ë¬¸ì œ í€´ì¦ˆ ì‹œì‘: ${questions.length}ê°œ (í´ë”: ${folderName || 'ì „ì²´'})`);
        
        // ì •ë ¬ ì˜µì…˜ ì„ íƒ
        new QuizSortModal(this.app, questions.length, (sortOrder, questionCount) => {
            let sortedQuestions = [...questions];
            
            switch(sortOrder) {
                case 'random':
                    for (let i = sortedQuestions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [sortedQuestions[i], sortedQuestions[j]] = [sortedQuestions[j], sortedQuestions[i]];
                    }
                    break;
                case 'number-asc':
                    sortedQuestions.sort((a, b) => (a.number || 0) - (b.number || 0));
                    break;
                case 'number-desc':
                    sortedQuestions.sort((a, b) => (b.number || 0) - (a.number || 0));
                    break;
                case 'wrong-desc':
                    sortedQuestions.sort((a, b) => (b.wrongCount || 0) - (a.wrongCount || 0));
                    break;
                case 'accuracy-asc':
                    sortedQuestions.sort((a, b) => {
                        const accA = (a.correctCount || 0) + (a.wrongCount || 0) > 0 
                            ? (a.correctCount || 0) / ((a.correctCount || 0) + (a.wrongCount || 0)) 
                            : 1;
                        const accB = (b.correctCount || 0) + (b.wrongCount || 0) > 0 
                            ? (b.correctCount || 0) / ((b.correctCount || 0) + (b.wrongCount || 0)) 
                            : 1;
                        return accA - accB;
                    });
                    break;
            }
            
            // ë¬¸ì œ ê°œìˆ˜ ì œí•œ
            if (questionCount && questionCount < sortedQuestions.length) {
                sortedQuestions = sortedQuestions.slice(0, questionCount);
            }
            
            new QuizPlayModal(this.app, this, sortedQuestions, false, null, false).open();
        }).open();
    }
    
    async getQuestionsByFolder(folder) {
        const allQuestions = await this.loadAllQuestions();
        console.log(`ğŸ“‚ ì „ì²´ ë¬¸ì œ ìˆ˜:`, allQuestions.length);
        console.log(`ğŸ“‚ í•„í„°í•  í´ë”:`, folder);
        
        const bookmarkFolderName = this.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬';
        
        let filtered;
        // ë¶ë§ˆí¬ í´ë” ë˜ëŠ” ë¶ë§ˆí¬ ì„œë¸Œí´ë”ì¸ ê²½ìš°
        if (folder === bookmarkFolderName || folder.startsWith(bookmarkFolderName + '/')) {
            if (folder === bookmarkFolderName) {
                // ë¶ë§ˆí¬ ë©”ì¸: ëª¨ë“  ë¶ë§ˆí¬ ë¬¸ì œ
                filtered = allQuestions.filter(q => {
                    // ë¬¸ì œ ë¶ë§ˆí¬ê°€ ìˆê±°ë‚˜ ì„ íƒì§€ ë¶ë§ˆí¬ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í¬í•¨
                    if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
                    if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
                    return false;
                });
                console.log(`ğŸ“‚ ë¶ë§ˆí¬ í•„í„° ì ìš© (ì „ì²´):`, filtered.length, 'ê°œ');
            } else {
                // ë¶ë§ˆí¬ ì„œë¸Œí´ë”: í•´ë‹¹ í´ë”ë³„ ë¶ë§ˆí¬
                const subFolderName = folder.replace(bookmarkFolderName + '/', '');
                filtered = allQuestions.filter(q => {
                    // ë¬¸ì œ ë¶ë§ˆí¬ê°€ ì¼ì¹˜í•˜ê±°ë‚˜ ì„ íƒì§€ ë¶ë§ˆí¬ ì¤‘ í•˜ë‚˜ë¼ë„ ì¼ì¹˜í•˜ë©´ í¬í•¨
                    if (q.bookmarkFolder === subFolderName) return true;
                    if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f === subFolderName)) return true;
                    return false;
                });
                console.log(`ğŸ“‚ ë¶ë§ˆí¬ í•„í„° ì ìš© (${subFolderName}):`, filtered.length, 'ê°œ');
            }
        } else {
            // ì¼ë°˜ í´ë”ëŠ” folder ì†ì„±ìœ¼ë¡œ í•„í„°ë§
            filtered = allQuestions.filter(q => {
                const questionFolder = q.folder || 'ê¸°ë³¸';
                console.log(`  - ë¬¸ì œ í´ë”: "${questionFolder}" vs ê²€ìƒ‰: "${folder}"`, questionFolder === folder);
                return questionFolder === folder;
            });
        }
        
        console.log(`ğŸ“‚ í•„í„°ëœ ë¬¸ì œ ìˆ˜:`, filtered.length);
        return filtered;
    }

    async startBookmarkQuiz() {
        const questions = await this.loadAllQuestions();
        // ë¬¸ì œ ë¶ë§ˆí¬ê°€ ìˆê±°ë‚˜ ì„ íƒì§€ ë¶ë§ˆí¬ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í¬í•¨
        const bookmarkedQuestions = questions.filter(q => {
            if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
            if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
            return false;
        });

        if (bookmarkedQuestions.length === 0) {
            new Notice('â­ ë¶ë§ˆí¬í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!');
            return;
        }

        // ì •ë ¬ ì˜µì…˜ ì„ íƒ
        new QuizSortModal(this.app, bookmarkedQuestions.length, (sortOrder, questionCount) => {
            let sortedQuestions = [...bookmarkedQuestions];
            
            switch(sortOrder) {
                case 'random':
                    for (let i = sortedQuestions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [sortedQuestions[i], sortedQuestions[j]] = [sortedQuestions[j], sortedQuestions[i]];
                    }
                    break;
                case 'number-asc':
                    sortedQuestions.sort((a, b) => (a.number || 0) - (b.number || 0));
                    break;
                case 'number-desc':
                    sortedQuestions.sort((a, b) => (b.number || 0) - (a.number || 0));
                    break;
                case 'wrong-desc':
                    sortedQuestions.sort((a, b) => (b.wrongCount || 0) - (a.wrongCount || 0));
                    break;
                case 'accuracy-asc':
                    sortedQuestions.sort((a, b) => {
                        const accA = (a.correctCount || 0) + (a.wrongCount || 0) > 0 
                            ? (a.correctCount || 0) / ((a.correctCount || 0) + (a.wrongCount || 0)) 
                            : 1;
                        const accB = (b.correctCount || 0) + (b.wrongCount || 0) > 0 
                            ? (b.correctCount || 0) / ((b.correctCount || 0) + (b.wrongCount || 0)) 
                            : 1;
                        return accA - accB;
                    });
                    break;
            }
            
            // ë¬¸ì œ ê°œìˆ˜ ì œí•œ
            if (questionCount && questionCount < sortedQuestions.length) {
                sortedQuestions = sortedQuestions.slice(0, questionCount);
            }
            
            new QuizPlayModal(this.app, this, sortedQuestions, false, null, false).open();
        }).open();
    }

    async startOptionBookmarkQuiz() {
        const allQuestions = await this.loadAllQuestions();
        
        // ì„ íƒì§€ ë¶ë§ˆí¬ ìˆ˜ì§‘
        const bookmarkedOptions = [];
        for (const question of allQuestions) {
            if (question.optionBookmarkFolders && question.optionBookmarkFolders.length > 0) {
                question.optionBookmarkFolders.forEach((folder, optionIndex) => {
                    if (folder && folder.length > 0) {
                        bookmarkedOptions.push({
                            question: question,
                            optionIndex: optionIndex,
                            optionText: question.options[optionIndex],
                            isCorrect: optionIndex === question.answer,
                            folder: folder
                        });
                    }
                });
            }
        }
        
        if (bookmarkedOptions.length === 0) {
            new Notice('â­ ë¶ë§ˆí¬í•œ ì„ íƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤!');
            return;
        }
        
        if (bookmarkedOptions.length < 4) {
            new Notice(`âš ï¸ ì„ íƒì§€ ë¶ë§ˆí¬ê°€ ${bookmarkedOptions.length}ê°œë¿ì…ë‹ˆë‹¤. ìµœì†Œ 4ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!`);
            return;
        }
        
        // ì‚¬ìš©ì ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
        new OptionBookmarkQuizBuilderModal(this.app, this, bookmarkedOptions).open();
    }
    
    // ì„ íƒëœ ì„ íƒì§€ë¡œ í€´ì¦ˆ ìƒì„± (ëª¨ë‹¬ì—ì„œ í˜¸ì¶œ)
    startOptionBookmarkQuizWithSelected(selectedOptions) {
        if (!selectedOptions || selectedOptions.length < 4) {
            new Notice('âš ï¸ ìµœì†Œ 4ê°œ ì´ìƒì˜ ì„ íƒì§€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤!');
            return;
        }
        
        // ì„ íƒì§€ë¥¼ 4ê°œì”© ë¬¶ì–´ì„œ ìƒˆë¡œìš´ ë¬¸ì œ ìƒì„±
        const newQuestions = [];
        const shuffledOptions = [...selectedOptions]; // ì´ë¯¸ ì‚¬ìš©ìê°€ ì •ë ¬í•œ ìˆœì„œ ìœ ì§€
        
        // 4ê°œì”© ë¬¶ì–´ì„œ ë¬¸ì œ ìƒì„±
        for (let i = 0; i < shuffledOptions.length; i += 4) {
            const fourOptions = shuffledOptions.slice(i, i + 4);
            if (fourOptions.length < 4) break; // 4ê°œ ë¯¸ë§Œì´ë©´ ì¤‘ë‹¨
            
            // ì •ë‹µ ì„ íƒ (ì •ë‹µì¸ ì„ íƒì§€ê°€ ìˆìœ¼ë©´ ê·¸ê²ƒì„, ì—†ìœ¼ë©´ ëœë¤)
            let correctIndex = fourOptions.findIndex(opt => opt.isCorrect);
            if (correctIndex === -1) {
                correctIndex = Math.floor(Math.random() * 4);
            }
            
            // ìƒˆë¡œìš´ ë¬¸ì œ ê°ì²´ ìƒì„±
            const syntheticQuestion = {
                hanzi: 'ğŸ¯',
                number: newQuestions.length + 1,
                question: `ë‹¤ìŒ ì¤‘ ì˜¬ë°”ë¥¸ ê²ƒì„ ì„ íƒí•˜ì„¸ìš” (ë¶ë§ˆí¬ ì„ íƒì§€ ì¡°í•©)`,
                options: fourOptions.map(opt => opt.optionText),
                answer: correctIndex,
                hint: fourOptions.map((opt, idx) => 
                    `${idx + 1}ë²ˆ: ${opt.question.hanzi} - ${opt.question.question?.substring(0, 30)}...`
                ).join('\n'),
                hintImage: '',
                note: `ì´ ë¬¸ì œëŠ” ë¶ë§ˆí¬ëœ ì„ íƒì§€ë“¤ì„ ì¡°í•©í•˜ì—¬ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                difficulty: 'ë³´í†µ',
                image: '',
                bookmarked: false,
                bookmarkFolder: '',
                wrongCount: 0,
                correctCount: 0,
                filePath: 'synthetic-question', // í•©ì„± ë¬¸ì œ í‘œì‹œ
                optionBookmarkFolders: [],
                optionImages: [],
                _synthetic: true, // í•©ì„± ë¬¸ì œ í”Œë˜ê·¸
                _sourceOptions: fourOptions // ì›ë³¸ ì •ë³´ ì €ì¥
            };
            
            newQuestions.push(syntheticQuestion);
        }
        
        if (newQuestions.length === 0) {
            new Notice('âš ï¸ ì„ íƒì§€ ë¶ë§ˆí¬ë¡œ ë¬¸ì œë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
            return;
        }
        
        new Notice(`âœ¨ ì„ íƒì§€ ë¶ë§ˆí¬ë¡œ ${newQuestions.length}ê°œ ë¬¸ì œ ìƒì„±ë¨!`);
        new QuizPlayModal(this.app, this, newQuestions, false, null, false).open();
    }

    async viewBookmarkList() {
        await this.updateBookmarkListTemplate();
        const bookmarkPath = `${this.settings.quizFolder}/â­ ë¶ë§ˆí¬ ëª©ë¡.md`;
        const file = this.app.vault.getAbstractFileByPath(bookmarkPath);
        
        if (file) {
            const leaf = this.app.workspace.getLeaf(false);
            await leaf.openFile(file);
        } else {
            new Notice('âŒ ë¶ë§ˆí¬ ëª©ë¡ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    async viewWrongAnswerList() {
        await this.updateWrongAnswerListTemplate();
        const wrongPath = `${this.settings.quizFolder}/âŒ ì˜¤ë‹µ ëª©ë¡.md`;
        const file = this.app.vault.getAbstractFileByPath(wrongPath);
        
        if (file) {
            const leaf = this.app.workspace.getLeaf(false);
            await leaf.openFile(file);
        } else {
            new Notice('âŒ ì˜¤ë‹µ ëª©ë¡ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    }

    async viewFolderQuestionList(folder) {
        // íŒŒì¼ë§Œ ì—´ê¸° (ë§¤ë²ˆ ì¬ìƒì„±í•˜ì§€ ì•ŠìŒ)
        const folderPath = `${this.settings.questionsFolder}/${folder}`;
        const templatePath = `${folderPath}/ë¬¸ì œëª©ë¡.md`;
        const file = this.app.vault.getAbstractFileByPath(templatePath);
        
        if (file) {
            const leaf = this.app.workspace.getLeaf(false);
            await leaf.openFile(file);
        } else {
            // íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
            await this.updateQuestionListTemplate(folder);
            const newFile = this.app.vault.getAbstractFileByPath(templatePath);
            if (newFile) {
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(newFile);
            } else {
                new Notice(`âŒ ${folder} í´ë”ì˜ ë¬¸ì œëª©ë¡ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            }
        }
    }

    async viewKeywordList() {
        const questions = await this.loadAllQuestions();
        
        if (questions.length === 0) {
            new Notice('ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // í‚¤ì›Œë“œë³„ë¡œ ê·¸ë£¹í™”
        const keywordGroups = {};
        questions.forEach(q => {
            const keyword = q.hanzi || 'ë¯¸ë¶„ë¥˜';
            if (!keywordGroups[keyword]) {
                keywordGroups[keyword] = [];
            }
            keywordGroups[keyword].push(q);
        });

        // í‚¤ì›Œë“œë³„ ì •ë ¬ (ë¬¸ì œ ê°œìˆ˜ ë§ì€ ìˆœ)
        const sortedKeywords = Object.entries(keywordGroups)
            .sort((a, b) => b[1].length - a[1].length);

        // í‚¤ì›Œë“œë³„ ì„¹ì…˜ ìƒì„±
        const keywordSections = sortedKeywords.map(([keyword, qs]) => {
            const difficultyIcon = this.getDifficultyIcon(qs[0].difficulty || 'C');
            return `### ğŸ”‘ ${keyword} (${qs.length}ê°œ)
${qs.map(q => `- ${q.number}ë²ˆ. ${q.question} ${this.getDifficultyIcon(q.difficulty)} ${q.bookmarked ? 'â­' : ''} (${q.folder || 'ê¸°ë³¸'})`).join('\n')}`;
        }).join('\n\n');

        const listContent = `# ğŸ”‘ í‚¤ì›Œë“œë³„ ë¬¸ì œ ëª©ë¡

ì „ì²´ í‚¤ì›Œë“œ ìˆ˜: **${sortedKeywords.length}**ê°œ
ì „ì²´ ë¬¸ì œ ìˆ˜: **${questions.length}**ê°œ

## ğŸ“Š í‚¤ì›Œë“œë³„ í†µê³„
${sortedKeywords.map(([keyword, qs]) => `- **${keyword}**: ${qs.length}ê°œ`).join('\n')}

## ğŸ” í‚¤ì›Œë“œë³„ ë¬¸ì œ
${keywordSections}

---
ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
`;

        const listPath = `${this.settings.quizFolder}/ğŸ”‘ í‚¤ì›Œë“œëª©ë¡.md`;
        const file = this.app.vault.getAbstractFileByPath(listPath);
        
        if (file) {
            await this.app.vault.modify(file, listContent);
        } else {
            await this.app.vault.create(listPath, listContent);
        }

        const leaf = this.app.workspace.getLeaf(false);
        await leaf.openFile(this.app.vault.getAbstractFileByPath(listPath));
    }

        async createIntegratedDashboard() {
        const dashboardPath = this.settings.quizFolder + '/ğŸ¯ í†µí•©í•œìëŒ€ì‹œë³´ë“œ.md';
        
        const questionsFolder = this.settings.questionsFolder;
        const foldersJson = JSON.stringify(this.settings.questionFolders);
        const updateTime = new Date().toLocaleString('ko-KR');
        
        const template = '---\n' +
'cssclass: hanzi-dashboard\n' +
'---\n\n' +
'# ğŸ¯ í•œì í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ\n\n' +
'## ğŸ“‚ í´ë”ë³„ ë¬¸ì œ\n\n' +
'```dataviewjs\n' +
'const questionsPath = "' + questionsFolder + '";\n' +
'const folders = ' + foldersJson + ';\n\n' +
'let html = "<div class=\\"folder-grid\\">";\n\n' +
'for (const folder of folders) {\n' +
'    const folderPath = questionsPath + "/" + folder;\n' +
'    const folderQuestions = dv.pages("\\"" + folderPath + "\\"").where(p => p.file.name.includes("_") && !p.file.name.includes("ë¬¸ì œëª©ë¡"));\n' +
'    const count = folderQuestions.length;\n' +
'    const listPath = folderPath + "/ë¬¸ì œëª©ë¡.md";\n' +
'    html += "<div class=\\"folder-card\\"><div class=\\"folder-icon\\">ğŸ“</div><div class=\\"folder-name\\">" + folder + "</div><div class=\\"folder-count\\">" + count + "ê°œ ë¬¸ì œ</div><a href=\\"obsidian://open?vault=" + encodeURIComponent(dv.app.vault.getName()) + "&file=" + encodeURIComponent(listPath) + "\\" class=\\"folder-link\\">ğŸ“‹ ë¬¸ì œ ëª©ë¡ ë³´ê¸°</a></div>";\n' +
'}\n\n' +
'html += "</div>";\n' +
'dv.paragraph(html);\n' +
'```\n\n' +
'## â­ ë¶ë§ˆí¬í•œ ë¬¸ì œ\n\n' +
'```dataviewjs\n' +
'const questionsPath = "' + questionsFolder + '";\n' +
'const bookmarked = dv.pages("\\"" + questionsPath + "\\"").where(p => p.file.name.includes("_") && !p.file.name.includes("ë¬¸ì œëª©ë¡") && p.bookmarked === true).sort(p => p.file.mtime, "desc").limit(10);\n\n' +
'if (bookmarked.length > 0) {\n' +
'    let html = "<div class=\\"question-list\\">";\n' +
'    for (const q of bookmarked) {\n' +
'        const difficultyVal = q.difficulty || "C";\n' +
'        const diffIcon = difficultyVal === "A+" ? "ğŸ†" : difficultyVal === "A" || difficultyVal === "A-" ? "â­" : difficultyVal === "B" || difficultyVal === "B-" ? "ğŸ˜Š" : difficultyVal === "C" ? "ğŸ˜" : difficultyVal === "D" ? "ğŸ˜°" : difficultyVal === "E" ? "ï¿½" : "ğŸ’€";\n' +
'        html += "<a href=\\"" + q.file.path + "\\" class=\\"question-item\\"><div class=\\"q-hanzi\\">" + (q.hanzi || "-") + "</div><div class=\\"q-info\\"><div class=\\"q-text\\">" + (q.question || "") + "</div><div class=\\"q-meta\\"><span class=\\"badge\\">" + diffIcon + " " + difficultyVal + "</span><span class=\\"badge\\">ğŸ“ " + (q.folder || "ê¸°ë³¸") + "</span></div></div></a>";\n' +
'    }\n' +
'    html += "</div>";\n' +
'    dv.paragraph(html);\n' +
'} else {\n' +
'    dv.paragraph("<p class=\\"empty\\">â­ ë¶ë§ˆí¬í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>");\n' +
'}\n' +
'```\n\n' +
'## ğŸ•’ ìµœê·¼ ìˆ˜ì •í•œ ë¬¸ì œ\n\n' +
'```dataviewjs\n' +
'const questionsPath = "' + questionsFolder + '";\n' +
'const recent = dv.pages("\\"" + questionsPath + "\\"").where(p => p.file.name.includes("_") && !p.file.name.includes("ë¬¸ì œëª©ë¡")).sort(p => p.file.mtime, "desc").limit(15);\n\n' +
'if (recent.length > 0) {\n' +
'    let html = "<div class=\\"question-list\\">";\n' +
'    for (const q of recent) {\n' +
'        const difficultyVal = q.difficulty || "C";\n' +
'        const diffIcon = difficultyVal === "A+" ? "ğŸ†" : difficultyVal === "A" || difficultyVal === "A-" ? "â­" : difficultyVal === "B" || difficultyVal === "B-" ? "ğŸ˜Š" : difficultyVal === "C" ? "ğŸ˜" : difficultyVal === "D" ? "ğŸ˜°" : difficultyVal === "E" ? "ï¿½" : "ğŸ’€";\n' +
'        const wrongBadge = (q.wrongCount > 0) ? "<span class=\\"badge badge-wrong\\">âŒ " + q.wrongCount + "</span>" : "";\n' +
'        const bookmarkIcon = q.bookmarked ? "â­ " : "";\n' +
'        html += "<a href=\\"" + q.file.path + "\\" class=\\"question-item\\"><div class=\\"q-hanzi\\">" + (q.hanzi || "-") + "</div><div class=\\"q-info\\"><div class=\\"q-text\\">" + bookmarkIcon + (q.question || "") + "</div><div class=\\"q-meta\\"><span class=\\"badge\\">" + diffIcon + " " + difficultyVal + "</span><span class=\\"badge\\">ğŸ“ " + (q.folder || "ê¸°ë³¸") + "</span>" + wrongBadge + "</div></div></a>";\n' +
'    }\n' +
'    html += "</div>";\n' +
'    dv.paragraph(html);\n' +
'} else {\n' +
'    dv.paragraph("<p class=\\"empty\\">ğŸ“ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>");\n' +
'}\n' +
'```\n\n' +
'---\n\n' +
'<style>\n' +
'.hanzi-dashboard { padding: 20px; max-width: 1200px; margin: 0 auto; }\n' +
'.folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin: 20px 0 40px 0; }\n' +
'@media (max-width: 768px) { .folder-grid { grid-template-columns: repeat(2, 1fr); gap: 15px; } }\n' +
'@media (max-width: 480px) { .folder-grid { grid-template-columns: 1fr; } }\n' +
'.folder-card { background: var(--background-secondary); border: 2px solid var(--background-modifier-border); border-radius: 12px; padding: 25px 20px; text-align: center; transition: all 0.3s ease; }\n' +
'.folder-card:hover { border-color: var(--interactive-accent); transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.15); }\n' +
'.folder-icon { font-size: 48px; margin-bottom: 12px; }\n' +
'.folder-name { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: var(--text-normal); }\n' +
'.folder-count { font-size: 14px; color: var(--text-muted); margin-bottom: 15px; }\n' +
'.folder-link { display: inline-block; padding: 8px 16px; background: var(--interactive-accent); color: white; text-decoration: none; border-radius: 20px; font-size: 13px; font-weight: 600; transition: all 0.2s; }\n' +
'.folder-link:hover { background: var(--interactive-accent-hover); transform: scale(1.05); }\n' +
'.question-list { display: flex; flex-direction: column; gap: 12px; margin: 20px 0; }\n' +
'.question-item { display: flex; align-items: center; gap: 20px; padding: 18px; background: var(--background-secondary); border: 2px solid var(--background-modifier-border); border-radius: 10px; text-decoration: none; transition: all 0.2s; }\n' +
'.question-item:hover { border-color: var(--interactive-accent); background: var(--background-modifier-hover); transform: translateX(5px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }\n' +
'@media (max-width: 480px) { .question-item { flex-direction: column; align-items: flex-start; gap: 12px; padding: 15px; } }\n' +
'.q-hanzi { font-size: 42px; font-weight: bold; min-width: 70px; text-align: center; color: var(--text-accent); }\n' +
'@media (max-width: 480px) { .q-hanzi { font-size: 32px; min-width: auto; } }\n' +
'.q-info { flex: 1; }\n' +
'.q-text { font-size: 16px; font-weight: 500; margin-bottom: 10px; color: var(--text-normal); line-height: 1.5; }\n' +
'@media (max-width: 480px) { .q-text { font-size: 14px; } }\n' +
'.q-meta { display: flex; gap: 8px; flex-wrap: wrap; }\n' +
'.badge { display: inline-block; padding: 5px 12px; background: var(--background-primary); border-radius: 12px; font-size: 12px; font-weight: 600; color: var(--text-muted); }\n' +
'.badge-wrong { background: rgba(244, 67, 54, 0.15); color: #f44336; }\n' +
'@media (max-width: 480px) { .badge { font-size: 11px; padding: 4px 10px; } }\n' +
'.empty { text-align: center; padding: 50px 20px; color: var(--text-muted); font-size: 16px; background: var(--background-secondary); border-radius: 10px; }\n' +
'</style>\n\n' +
'---\n' +
'ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + updateTime + '\n';

        try {
            const file = this.app.vault.getAbstractFileByPath(dashboardPath);
            
            if (file) {
                await this.app.vault.modify(file, template);
            } else {
                await this.app.vault.create(dashboardPath, template);
            }
            
            new Notice('âœ… í†µí•© ëŒ€ì‹œë³´ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            
            // íŒŒì¼ ì—´ê¸°
            const createdFile = this.app.vault.getAbstractFileByPath(dashboardPath);
            if (createdFile) {
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(createdFile);
            }
        } catch (error) {
            console.error('í†µí•© ëŒ€ì‹œë³´ë“œ ìƒì„± ì˜¤ë¥˜:', error);
            new Notice('âŒ í†µí•© ëŒ€ì‹œë³´ë“œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    async loadAllQuestions() {
        const allFiles = this.app.vault.getMarkdownFiles();
        
        // ê²½ë¡œ ì •ê·œí™” í•¨ìˆ˜ (Windows/Unix/Mobile í˜¸í™˜)
        const normalizePath = (path) => {
            if (!path) return '';
            // ëª¨ë“  ë°±ìŠ¬ë˜ì‹œë¥¼ ìŠ¬ë˜ì‹œë¡œ ë³€í™˜
            let normalized = path.replace(/\\/g, '/');
            // ì—°ì†ëœ ìŠ¬ë˜ì‹œ ì œê±°
            normalized = normalized.replace(/\/+/g, '/');
            // ì‹œì‘/ë ìŠ¬ë˜ì‹œ ì •ë¦¬
            normalized = normalized.replace(/^\/+/, '').replace(/\/+$/, '');
            return normalized;
        };
        
        const normalizedQuestionsFolder = normalizePath(this.settings.questionsFolder);
        
        const files = allFiles.filter(file => {
            const normalizedPath = normalizePath(file.path);
            
            // Questions í´ë” ë‚´ì˜ íŒŒì¼ì¸ì§€ í™•ì¸ (í•˜ìœ„ í´ë” í¬í•¨)
            const inQuestionsFolder = normalizedPath.startsWith(normalizedQuestionsFolder + '/') || 
                                      normalizedPath.startsWith(normalizedQuestionsFolder);
            
            // ì œì™¸í•  íŒŒì¼ íŒ¨í„´
            const excludePatterns = [
                'ë¬¸ì œëª©ë¡',
                'ë¬¸ì œ ëŒ€ì‹œë³´ë“œ',
                'ğŸ“Š ë¬¸ì œ ëŒ€ì‹œë³´ë“œ',
                'í†µí•©í•œìëŒ€ì‹œë³´ë“œ',
                'í†µí•©ëŒ€ì‹œë³´ë“œ'
            ];
            
            const shouldExclude = excludePatterns.some(pattern => 
                file.path.includes(pattern) || file.name.includes(pattern)
            );
            
            return inQuestionsFolder && !shouldExclude;
        });

        if (files.length === 0) {
            console.warn(`âš ï¸ "${this.settings.questionsFolder}" í´ë”ì—ì„œ ë¬¸ì œ íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.`);
        }

        const questions = [];
        let successCount = 0;
        let failCount = 0;

        for (const file of files) {
            try {
                const content = await this.app.vault.read(file);
                const question = this.parseQuestionFile(content, file.path);
                if (question) {
                    // íŒŒì¼ ìˆ˜ì • ì‹œê°„ ì¶”ê°€
                    question.mtime = file.stat.mtime;
                    questions.push(question);
                    successCount++;
                } else {
                    failCount++;
                    console.warn(`âŒ íŒŒì‹± ì‹¤íŒ¨: ${file.path}`);
                }
            } catch (err) {
                failCount++;
                console.error(`âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ${file.path}`, err);
            }
        }

        console.log(`âœ… ë¡œë“œ ì„±ê³µ: ${successCount}ê°œ, âŒ ì‹¤íŒ¨: ${failCount}ê°œ`);
        console.log(`ğŸ“Š ì´ ë¬¸ì œ ìˆ˜: ${questions.length}ê°œ`);

        return questions;
    }

    parseQuestionFile(content, filePath) {
        try {
            const lines = content.split('\n');
            let question = {
                filePath: filePath,
                wrongCount: 0,
                correctCount: 0,
                bookmarkFolder: '',
                lastAttempt: null
            };
            let section = '';
            let currentOptionImageIndex = -1; // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì„ íƒì§€ ì´ë¯¸ì§€ ì¸ë±ìŠ¤
            question.options = [];
            question.optionImages = [];
            question.optionImageHints = [];
            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('## í•œì')) section = 'hanzi';
                else if (line.startsWith('## ë²ˆí˜¸')) section = 'number';
                else if (line.startsWith('## í´ë”')) section = 'folder';
                else if (line.startsWith('## ë¬¸ì œ')) section = 'question';
                else if (line.startsWith('## ì„ íƒì§€ ì´ë¯¸ì§€ íŒíŠ¸')) section = 'optionImageHints';
                else if (line.startsWith('## ì„ íƒì§€ ì´ë¯¸ì§€')) section = 'optionImages';
                else if (line.startsWith('## ì„ íƒì§€')) section = 'options';
                else if (line.startsWith('## ì •ë‹µ')) section = 'answer';
                else if (line.startsWith('## ë…¸íŠ¸')) section = 'note';
                else if (line.startsWith('## í•´ì„¤')) section = 'note';
                else if (line.startsWith('## íŒíŠ¸ ì´ë¯¸ì§€')) section = 'hintImage';
                else if (line.startsWith('## íŒíŠ¸')) section = 'hint';
                else if (line.startsWith('## ë‚œì´ë„')) section = 'difficulty';
                else if (line.startsWith('## ë…¸íŠ¸ ì´ë¯¸ì§€')) section = 'noteImage';
                else if (line.startsWith('## ì´ë¯¸ì§€')) section = 'image';
                else if (line.startsWith('## ìŒì„±')) section = 'audio';
                else if (line.startsWith('## í†µê³„')) section = 'stats';
                else if (line && !line.startsWith('#') && !line.startsWith('---')) {
                    if (section === 'hanzi') question.hanzi = line;
                    else if (section === 'number') question.number = line.trim();
                    else if (section === 'folder') question.folder = line.trim();
                    else if (section === 'question') question.question = question.question ? question.question + '\n' + line : line;
                    else if (section === 'options' && line.startsWith('-')) {
                        const option = line.substring(1).trim();
                        question.options.push(option);
                    } else if (section === 'optionImages') {
                        if (line.trim()) {
                            // ì„ íƒì§€ ë²ˆí˜¸ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ì˜ˆ: "1.", "2.")
                            const optionNumMatch = line.match(/^(\d+)\.\s*(.*)$/);
                            if (optionNumMatch) {
                                const optionIndex = parseInt(optionNumMatch[1]) - 1;
                                const imageContent = optionNumMatch[2].trim();
                                
                                // ë°°ì—´ í¬ê¸° í™•ì¥ (ë²ˆí˜¸ë¥¼ ë§Œë‚˜ë©´ ë¬´ì¡°ê±´ ë°°ì—´ í™•ì¥)
                                while (question.optionImages.length <= optionIndex) {
                                    question.optionImages.push('');
                                }
                                
                                // í˜„ì¬ ì½ê³  ìˆëŠ” ì„ íƒì§€ ì¸ë±ìŠ¤ ê¸°ì–µ
                                currentOptionImageIndex = optionIndex;
                                
                                // ì´ë¯¸ì§€ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì„¤ì •
                                if (imageContent) {
                                    const imageMatches = imageContent.match(/!\[\[.+?\]\]/g);
                                    if (imageMatches) {
                                        question.optionImages[optionIndex] = imageMatches.join('\n');
                                    } else if (imageContent.includes('![[')) {
                                        question.optionImages[optionIndex] = imageContent;
                                    }
                                }
                            } else {
                                // ë²ˆí˜¸ ì—†ì´ ì´ë¯¸ì§€ë§Œ ìˆëŠ” ê²½ìš° - í˜„ì¬ ì„ íƒì§€ì— ì¶”ê°€
                                const imageMatches = line.match(/!\[\[.+?\]\]/g);
                                if (imageMatches && currentOptionImageIndex >= 0) {
                                    // ë°°ì—´ì´ ì•„ì§ ì—†ìœ¼ë©´ í™•ì¥
                                    while (question.optionImages.length <= currentOptionImageIndex) {
                                        question.optionImages.push('');
                                    }
                                    const existing = question.optionImages[currentOptionImageIndex] || '';
                                    question.optionImages[currentOptionImageIndex] = existing 
                                        ? existing + '\n' + imageMatches.join('\n')
                                        : imageMatches.join('\n');
                                } else if (line.includes('![[') && currentOptionImageIndex >= 0) {
                                    // ë°°ì—´ì´ ì•„ì§ ì—†ìœ¼ë©´ í™•ì¥
                                    while (question.optionImages.length <= currentOptionImageIndex) {
                                        question.optionImages.push('');
                                    }
                                    const existing = question.optionImages[currentOptionImageIndex] || '';
                                    question.optionImages[currentOptionImageIndex] = existing 
                                        ? existing + '\n' + line.trim()
                                        : line.trim();
                                }
                            }
                        }
                    } else if (section === 'answer') question.answer = parseInt(line) || 0;
                    else if (section === 'optionImageHints') {
                        if (line.trim()) {
                            // ì„ íƒì§€ ë²ˆí˜¸ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ì˜ˆ: "1. íŒíŠ¸ ë‚´ìš©", "2.")
                            const hintNumMatch = line.match(/^(\d+)\.\s*(.*)$/);
                            if (hintNumMatch) {
                                const optionIndex = parseInt(hintNumMatch[1]) - 1;
                                const hintContent = hintNumMatch[2].trim();
                                
                                // ë°°ì—´ í¬ê¸° í™•ì¥
                                while (question.optionImageHints.length <= optionIndex) {
                                    question.optionImageHints.push('');
                                }
                                
                                // íŒíŠ¸ ë‚´ìš© ì„¤ì •
                                question.optionImageHints[optionIndex] = hintContent;
                            }
                        }
                    } else if (section === 'hint') question.hint = question.hint ? question.hint + '\n' + line : line;
                    else if (section === 'note') question.note = question.note ? question.note + '\n' + line : line;
                    else if (section === 'difficulty') question.difficulty = line;
                    else if (section === 'image') {
                        if (line) question.image = question.image ? question.image + '\n' + line : line;
                    } else if (section === 'hintImage') {
                        if (line) {
                            // í•œ ì¤„ì— ì—¬ëŸ¬ ì´ë¯¸ì§€ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª¨ë“  ![[...]] íŒ¨í„´ ì¶”ì¶œ
                            const imageMatches = line.match(/!\[\[.+?\]\]/g);
                            if (imageMatches) {
                                for (const match of imageMatches) {
                                    question.hintImage = question.hintImage ? question.hintImage + '\n' + match : match;
                                }
                            } else {
                                question.hintImage = question.hintImage ? question.hintImage + '\n' + line : line;
                            }
                        }
                    } else if (section === 'audio') {
                        if (line) question.audio = question.audio ? question.audio + '\n' + line : line;
                    } else if (section === 'noteImage') {
                        if (line) {
                            // í•œ ì¤„ì— ì—¬ëŸ¬ ì´ë¯¸ì§€ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª¨ë“  ![[...]] íŒ¨í„´ ì¶”ì¶œ
                            const imageMatches = line.match(/!\[\[.+?\]\]/g);
                            if (imageMatches) {
                                for (const match of imageMatches) {
                                    question.noteImage = question.noteImage ? question.noteImage + '\n' + match : match;
                                }
                            } else {
                                question.noteImage = question.noteImage ? question.noteImage + '\n' + line : line;
                            }
                        }
                    } else if (section === 'stats') {
                        if (line.includes('ì˜¤ë‹µ:')) {
                            const match = line.match(/\d+/);
                            question.wrongCount = match ? parseInt(match[0]) : 0;
                        } else if (line.includes('ì •ë‹µ:')) {
                            const match = line.match(/\d+/);
                            question.correctCount = match ? parseInt(match[0]) : 0;
                        } else if (line.includes('ë¶ë§ˆí¬ í´ë”:')) {
                            const parts = line.split(':');
                            question.bookmarkFolder = parts.length > 1 ? parts[1].trim() : '';
                        } else if (line.includes('ë§ˆì§€ë§‰ ì‹œë„:')) {
                            const parts = line.split(':');
                            question.lastAttempt = parts.length > 1 ? parts.slice(1).join(':').trim() : null;
                        } else if (line.includes('ì„ íƒì§€ ë¶ë§ˆí¬:')) {
                            // ì˜ˆ: "ì„ íƒì§€ ë¶ë§ˆí¬: ['í´ë”1', '', 'í´ë”2', '']"
                            const match = line.match(/\[(.+?)\]/);
                            if (match) {
                                const bookmarkStr = match[1];
                                // ë”°ì˜´í‘œë¡œ ê°ì‹¸ì§„ ë¬¸ìì—´ íŒŒì‹±
                                question.optionBookmarkFolders = bookmarkStr.split(',').map(s => {
                                    const trimmed = s.trim();
                                    // ë”°ì˜´í‘œ ì œê±°
                                    if (trimmed.startsWith("'") && trimmed.endsWith("'")) {
                                        return trimmed.slice(1, -1);
                                    }
                                    return trimmed;
                                });
                            }
                        }
                    }
                }
            }
            // ë¬¸ì œë¡œ ì¸ì •í•˜ëŠ” ì¡°ê±´: question í…ìŠ¤íŠ¸ì™€ optionsê°€ ìˆìœ¼ë©´ ë¨
            // hanziëŠ” ì„ íƒì‚¬í•­ìœ¼ë¡œ ë³€ê²½
            if (question.question && question.options && question.options.length > 0) {
                if (!question.optionImages) question.optionImages = [];
                while (question.optionImages.length < question.options.length) {
                    question.optionImages.push('');
                }
                
                // ì„ íƒì§€ ì´ë¯¸ì§€ íŒíŠ¸ ë°°ì—´ ì´ˆê¸°í™”
                if (!question.optionImageHints) question.optionImageHints = [];
                while (question.optionImageHints.length < question.options.length) {
                    question.optionImageHints.push('');
                }
                
                // ì„ íƒì§€ ë¶ë§ˆí¬ í´ë” ë°°ì—´ ì´ˆê¸°í™”
                if (!question.optionBookmarkFolders) {
                    question.optionBookmarkFolders = Array(question.options.length).fill('');
                } else {
                    // ê¸¸ì´ê°€ ë§ì§€ ì•Šìœ¼ë©´ ì¡°ì •
                    while (question.optionBookmarkFolders.length < question.options.length) {
                        question.optionBookmarkFolders.push('');
                    }
                }
                
                if (question.answer === undefined || question.answer === null) {
                    console.warn(`âš ï¸ ì •ë‹µ ì—†ìŒ: ${filePath}, ê¸°ë³¸ê°’ 0 ì„¤ì •`);
                    question.answer = 0;
                } else if (question.answer < 0 || question.answer >= question.options.length) {
                    console.warn(`âš ï¸ ì •ë‹µ ì¸ë±ìŠ¤ ë²”ìœ„ ì´ˆê³¼: ${filePath}, answer=${question.answer}, options.length=${question.options.length}`);
                    question.answer = 0;
                }
                
                // íŒíŠ¸ í•„ë“œì—ì„œ ì´ë¯¸ì§€ ë§í¬ ë¶„ë¦¬ (ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜)
                // ë‹¨, ì´ë¯¸ hintImage ì„¹ì…˜ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
                if (question.hint && question.hint.includes('![[') && !question.hintImage) {
                    const hintLines = question.hint.split('\n');
                    const textLines = [];
                    const imageLines = [];
                    
                    for (const line of hintLines) {
                        const trimmed = line.trim();
                        if (trimmed.includes('![[') && trimmed.includes(']]')) {
                            // í•œ ì¤„ì— ì—¬ëŸ¬ ì´ë¯¸ì§€ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª¨ë‘ ì¶”ì¶œ
                            const matches = trimmed.match(/!\[\[.+?\]\]/g);
                            if (matches) {
                                imageLines.push(...matches);
                            }
                        } else if (trimmed) {
                            textLines.push(trimmed);
                        }
                    }
                    
                    // ë¶„ë¦¬ëœ ë‚´ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    question.hint = textLines.join('\n');
                    if (imageLines.length > 0) {
                        question.hintImage = imageLines.join('\n');
                        console.log(`ğŸ”„ íŒíŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜: ${imageLines.length}ê°œ ì´ë¯¸ì§€ ì¶”ì¶œë¨`);
                    }
                }
                
                // ë…¸íŠ¸ í•„ë“œì—ì„œ ì´ë¯¸ì§€ ë§í¬ ë¶„ë¦¬ (ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜)
                // ë‹¨, ì´ë¯¸ noteImage ì„¹ì…˜ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ë°©ì§€
                if (question.note && question.note.includes('![[') && !question.noteImage) {
                    const noteLines = question.note.split('\n');
                    const textLines = [];
                    const imageLines = [];
                    
                    for (const line of noteLines) {
                        const trimmed = line.trim();
                        if (trimmed.includes('![[') && trimmed.includes(']]')) {
                            // í•œ ì¤„ì— ì—¬ëŸ¬ ì´ë¯¸ì§€ê°€ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ëª¨ë‘ ì¶”ì¶œ
                            const matches = trimmed.match(/!\[\[.+?\]\]/g);
                            if (matches) {
                                imageLines.push(...matches);
                            }
                        } else if (trimmed) {
                            textLines.push(trimmed);
                        }
                    }
                    
                    // ë¶„ë¦¬ëœ ë‚´ìš©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                    question.note = textLines.join('\n');
                    if (imageLines.length > 0) {
                        question.noteImage = imageLines.join('\n');
                        console.log(`ğŸ”„ ë…¸íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜: ${imageLines.length}ê°œ ì´ë¯¸ì§€ ì¶”ì¶œë¨`);
                    }
                }
                
                // hintImage ë””ë²„ê¹… ë¡œê·¸ (í•„ìš” ì‹œë§Œ)
                // if (question.hintImage) {
                //     const imageCount = question.hintImage.split('\n').filter(l => l.trim()).length;
                //     console.log(`ğŸ–¼ï¸ íŒíŠ¸ ì´ë¯¸ì§€ ì´ ê°œìˆ˜: ${imageCount}ê°œ`);
                // }
                
                // í´ë” ì •ë³´ê°€ ì—†ìœ¼ë©´ íŒŒì¼ ê²½ë¡œì—ì„œ ìë™ ì¶”ì¶œ
                if (!question.folder) {
                    // filePath ì˜ˆ: "HanziQuiz/Questions/ì „ê¸°ê¸°ëŠ¥/ë¬¸ì œ1.md"
                    const pathParts = filePath.split('/');
                    if (pathParts.length >= 3 && pathParts[1] === 'Questions') {
                        question.folder = pathParts[2]; // "ì „ê¸°ê¸°ëŠ¥"
                    } else {
                        question.folder = 'ê¸°ë³¸';
                    }
                }
                
                return question;
            } else {
                console.warn(`âš ï¸ ë¬¸ì œ í˜•ì‹ ë¶ˆì™„ì „: ${filePath}`);
                console.warn(`   - ë¬¸ì œ: ${question.question ? 'âœ…' : 'âŒ'} "${question.question || 'ì—†ìŒ'}"`);
                console.warn(`   - ì„ íƒì§€: ${question.options?.length > 0 ? 'âœ…' : 'âŒ'} ${question.options?.length || 0}ê°œ`);
                console.warn(`   - í•œì: ${question.hanzi ? 'âœ…' : 'âš ï¸'} "${question.hanzi || 'ì—†ìŒ'}"`);
                console.warn(`   - ë²ˆí˜¸: ${question.number ? 'âœ…' : 'âš ï¸'} "${question.number || 'ì—†ìŒ'}"`);
                console.warn(`   - í´ë”: ${question.folder ? 'âœ…' : 'âš ï¸'} "${question.folder || 'ì—†ìŒ'}"`);
                return null;
            }
        } catch (e) {
            console.error(`âŒ ë¬¸ì œ íŒŒì‹± ì˜¤ë¥˜: ${filePath}`, e);
            console.error('   ìŠ¤íƒ:', e.stack);
            return null;
        }
    }

    // ë‚œì´ë„ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
    getDifficultyIcon(difficulty) {
        const icons = {
            'A+': 'ğŸ†',
            'A': 'â­',
            'A-': 'â­',
            'B': 'ğŸ˜Š',
            'B-': 'ğŸ˜Š',
            'C': 'ğŸ˜',
            'D': 'ğŸ˜°',
            'E': 'ğŸ˜±',
            'F': 'ğŸ’€'
        };
        return icons[difficulty] || 'ğŸ˜';
    }

    // ë‚œì´ë„ CSS í´ë˜ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    getDifficultyClass(difficulty) {
        if (difficulty === 'A+' || difficulty === 'A' || difficulty === 'A-') return 'easy';
        if (difficulty === 'B' || difficulty === 'B-') return 'normal';
        if (difficulty === 'C') return 'normal';
        return 'hard'; // D, E, F
    }

    async getNextAvailableNumber(folder) {
        // í•´ë‹¹ í´ë”ì˜ ëª¨ë“  ë¬¸ì œ ë¡œë“œ
        const allQuestions = await this.loadAllQuestions();
        const folderQuestions = allQuestions.filter(q => (q.folder || 'ê¸°ë³¸') === folder);
        
        console.log(`ğŸ“ [${folder}] í´ë”ì˜ ë¬¸ì œ ê°œìˆ˜: ${folderQuestions.length}`);
        
        if (folderQuestions.length === 0) {
            console.log(`âœ¨ [${folder}] í´ë”ì˜ ì²« ë²ˆì§¸ ë¬¸ì œ - ë²ˆí˜¸ 1 í• ë‹¹`);
            return '1';
        }
        
        // ì‚¬ìš© ì¤‘ì¸ ë²ˆí˜¸ë“¤ ì¶”ì¶œ
        const usedNumbers = folderQuestions
            .map(q => parseInt(q.number))
            .filter(n => !isNaN(n))
            .sort((a, b) => a - b);
        
        console.log(`ğŸ“Š [${folder}] í´ë”ì˜ ì‚¬ìš© ì¤‘ì¸ ë²ˆí˜¸: ${usedNumbers.join(', ')}`);
        
        // ë¹ˆ ë²ˆí˜¸ ì°¾ê¸° (1ë¶€í„° ì‹œì‘)
        for (let i = 1; i <= usedNumbers.length + 1; i++) {
            if (!usedNumbers.includes(i)) {
                console.log(`âœ… [${folder}] í´ë”ì— ë²ˆí˜¸ ${i} ìë™ í• ë‹¹`);
                return i.toString();
            }
        }
        
        const nextNumber = (usedNumbers.length + 1).toString();
        console.log(`âœ… [${folder}] í´ë”ì— ë²ˆí˜¸ ${nextNumber} ìë™ í• ë‹¹`);
        return nextNumber;
    }

    async checkNumberDuplicate(number, folder, excludeFilePath = null) {
        // ê°™ì€ í´ë”ì—ì„œ ê°™ì€ ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¬¸ì œê°€ ìˆëŠ”ì§€ í™•ì¸
        const allQuestions = await this.loadAllQuestions();
        
        // í•´ë‹¹ í´ë”ì˜ ë¬¸ì œë“¤ë§Œ í•„í„°ë§
        const folderQuestions = allQuestions.filter(q => 
            (q.folder || 'ê¸°ë³¸') === folder
        );
        
        console.log(`ğŸ“ [${folder}] í´ë” ë¬¸ì œ ê°œìˆ˜: ${folderQuestions.length}`);
        console.log(`ğŸ” ë²ˆí˜¸ ${number} (íƒ€ì…: ${typeof number}) ì¤‘ë³µ ì²´í¬ ì¤‘... (ì œì™¸: ${excludeFilePath || 'ì—†ìŒ'})`);
        
        // ë¬¸ìì—´ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ (íƒ€ì… ë¶ˆì¼ì¹˜ ë°©ì§€)
        const numberStr = String(number).trim();
        
        const duplicate = folderQuestions.find(q => {
            const qNumberStr = String(q.number).trim();
            const isDup = qNumberStr === numberStr && q.filePath !== excludeFilePath;
            
            if (isDup) {
                console.log(`  ğŸ”´ ì¤‘ë³µ í™•ì¸: q.number="${q.number}" (${typeof q.number}) === number="${number}" (${typeof number})`);
                console.log(`  ğŸ“„ íŒŒì¼: ${q.filePath}`);
            }
            
            return isDup;
        });
        
        if (duplicate) {
            console.log(`âš ï¸ ì¤‘ë³µ ë°œê²¬: ${duplicate.filePath}`);
            console.log(`   ì¤‘ë³µ ë²ˆí˜¸: "${duplicate.number}" (${typeof duplicate.number})`);
        } else {
            console.log(`âœ… ë²ˆí˜¸ ${number}ì€(ëŠ”) [${folder}] í´ë”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥`);
        }
        
        return duplicate !== undefined;
    }
    
    async findDuplicateQuestion(number, folder, excludeFilePath = null) {
        // checkNumberDuplicateì™€ ë™ì¼í•˜ì§€ë§Œ ì¤‘ë³µ íŒŒì¼ ê°ì²´ë¥¼ ë°˜í™˜
        const allQuestions = await this.loadAllQuestions();
        const folderQuestions = allQuestions.filter(q => 
            (q.folder || 'ê¸°ë³¸') === folder
        );
        
        const numberStr = String(number).trim();
        const duplicate = folderQuestions.find(q => {
            const qNumberStr = String(q.number).trim();
            return qNumberStr === numberStr && q.filePath !== excludeFilePath;
        });
        
        return duplicate; // undefined ë˜ëŠ” ì¤‘ë³µ ë¬¸ì œ ê°ì²´
    }

    async saveQuestion(question, isNew = true) {
        const folder = question.folder || 'ê¸°ë³¸';
        const folderPath = `${this.settings.questionsFolder}/${folder}`;
        
        // ë²ˆí˜¸ trim (ê³µë°± ì œê±°)
        if (question.number) {
            question.number = question.number.toString().trim();
        }
        
        // ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ìë™ ìƒì„±
        if (!question.number || question.number === '') {
            question.number = await this.getNextAvailableNumber(folder);
            new Notice(`ğŸ“‹ ìë™ìœ¼ë¡œ ë²ˆí˜¸ ${question.number}ì´(ê°€) í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }
        
        // ì¤‘ë³µ ì²´í¬ ì œê±° - ì¤‘ë³µ í—ˆìš©
        // ë‹¨, ìƒˆ í´ë” ìƒì„± ì‹œì—ëŠ” 1ë²ˆë¶€í„° ì‹œì‘í•˜ë„ë¡ getNextAvailableNumberì—ì„œ ì²˜ë¦¬
        
        // í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„± (ëª¨ë°”ì¼ í˜¸í™˜)
        const folderExists = this.app.vault.getAbstractFileByPath(folderPath);
        if (!folderExists) {
            try {
                await this.app.vault.createFolder(folderPath);
            } catch (e) {
                console.log('í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•˜ê±°ë‚˜ ìƒì„± ì¤‘:', folderPath);
            }
        }
        
        const newFileName = `${folderPath}/${question.number}_${question.hanzi}.md`;
        const content = this.generateQuestionContent(question);
        
        // ê¸°ì¡´ íŒŒì¼ì´ ìˆê³  íŒŒì¼ëª…ì´ ë³€ê²½ëœ ê²½ìš°
        if (question.filePath && question.filePath !== newFileName) {
            const oldFile = this.app.vault.getAbstractFileByPath(question.filePath);
            if (oldFile) {
                // ê¸°ì¡´ íŒŒì¼ ì‚­ì œí•˜ê³  ìƒˆ íŒŒì¼ ìƒì„±
                await this.app.vault.delete(oldFile);
                await this.app.vault.create(newFileName, content);
                question.filePath = newFileName;
            } else {
                // ê¸°ì¡´ íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                await this.app.vault.create(newFileName, content);
                question.filePath = newFileName;
            }
        } else {
            // íŒŒì¼ëª…ì´ ë™ì¼í•˜ê±°ë‚˜ ìƒˆ íŒŒì¼ì¸ ê²½ìš°
            const file = this.app.vault.getAbstractFileByPath(newFileName);
            if (file) {
                await this.app.vault.modify(file, content);
            } else {
                await this.app.vault.create(newFileName, content);
                question.filePath = newFileName;
            }
        }
        
        // í´ë”ë³„ ë¬¸ì œëª©ë¡ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
        await this.updateQuestionListTemplate(folder);
        
        if (isNew) {
            new Notice(`âœ… ë¬¸ì œ "${question.hanzi}" ì €ì¥ë¨ ([${folder}] í´ë”, ë²ˆí˜¸: ${question.number})`);
        }
        
        // Git ìë™ ì»¤ë°‹ ë° í‘¸ì‹œ (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
        this.autoGitCommitAndPush(newFileName, question, isNew);
    }
    generateQuestionContent(question) {
        return `# ${question.title || question.hanzi + ' ë¬¸ì œ'}

## í•œì
${question.hanzi}

## ë²ˆí˜¸
${question.number}

## í´ë”
${question.folder || 'ê¸°ë³¸'}

## ë¬¸ì œ
${question.question}

## ì„ íƒì§€
${question.options.map((opt) => `- ${opt}`).join('\n')}

## ì„ íƒì§€ ì´ë¯¸ì§€
${question.optionImages && question.optionImages.length > 0 ? 
    question.optionImages.map((imgStr, idx) => {
        if (!imgStr || !imgStr.trim()) return `${idx + 1}.`;
        return `${idx + 1}.\n${imgStr}`;
    }).join('\n\n') : ''}

## ì„ íƒì§€ ì´ë¯¸ì§€ íŒíŠ¸
${question.optionImageHints && question.optionImageHints.length > 0 ? 
    question.optionImageHints.map((hintStr, idx) => {
        if (!hintStr || !hintStr.trim()) return `${idx + 1}.`;
        return `${idx + 1}. ${hintStr}`;
    }).join('\n') : ''}

## ì •ë‹µ
${question.answer}

## íŒíŠ¸
${question.hint || ''}

## ë…¸íŠ¸
${question.note || ''}

## ë‚œì´ë„
${question.difficulty || 'C'}

## ì´ë¯¸ì§€
${question.image || ''}

## íŒíŠ¸ ì´ë¯¸ì§€
${question.hintImage || ''}

## ë…¸íŠ¸ ì´ë¯¸ì§€
${question.noteImage || ''}

## ìŒì„±
${question.audio || ''}

## í†µê³„
- ì˜¤ë‹µ: ${question.wrongCount || 0}íšŒ
- ì •ë‹µ: ${question.correctCount || 0}íšŒ
- ë¶ë§ˆí¬ í´ë”: ${question.bookmarkFolder || ''}
- ë§ˆì§€ë§‰ ì‹œë„: ${question.lastAttempt || 'ì—†ìŒ'}
- ì„ íƒì§€ ë¶ë§ˆí¬: ${question.optionBookmarkFolders ? '[' + question.optionBookmarkFolders.map(f => "'" + f + "'").join(', ') + ']' : '[]'}

---
ìƒì„±ì¼: ${question.created || new Date().toLocaleDateString('ko-KR')}
ìˆ˜ì •ì¼: ${new Date().toLocaleDateString('ko-KR')}
`;
    }

    async autoGitCommitAndPush(filePath, question, isNew) {
        try {
            // ë¹„ë™ê¸°ë¡œ ì‹¤í–‰í•˜ì—¬ UI ë¸”ë¡œí‚¹ ë°©ì§€
            const action = isNew ? 'ìƒì„±' : 'ìˆ˜ì •';
            const message = `âœ¨ ë¬¸ì œ ${action}: ${question.hanzi} (ë²ˆí˜¸: ${question.number}, í´ë”: ${question.folder || 'ê¸°ë³¸'})`;
            
            console.log(`ğŸ”„ Git ìë™ ì»¤ë°‹ ì‹œì‘: ${message}`);
            
            // Windows í™˜ê²½ì—ì„œ PowerShell ëª…ë ¹ ì‹¤í–‰
            const { exec } = require('child_process');
            const util = require('util');
            const execPromise = util.promisify(exec);
            
            // Vault ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
            const vaultPath = this.app.vault.adapter.basePath;
            
            // Git add
            await execPromise(`git add "${filePath}"`, { cwd: vaultPath });
            console.log(`âœ… Git add ì™„ë£Œ: ${filePath}`);
            
            // Git commit
            await execPromise(`git commit -m "${message}"`, { cwd: vaultPath });
            console.log(`âœ… Git commit ì™„ë£Œ`);
            
            // Git push (ë°±ê·¸ë¼ìš´ë“œ)
            execPromise(`git push`, { cwd: vaultPath })
                .then(() => {
                    console.log(`âœ… Git push ì™„ë£Œ`);
                    new Notice(`ğŸ“¤ Git ì—…ë¡œë“œ ì™„ë£Œ: ${question.hanzi}`);
                })
                .catch((pushError) => {
                    console.warn(`âš ï¸ Git push ì‹¤íŒ¨:`, pushError.message);
                    // push ì‹¤íŒ¨ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ì›ê²© ì €ì¥ì†Œ ë¯¸ì„¤ì • ë“±)
                    if (!pushError.message.includes('No configured push destination')) {
                        new Notice(`âš ï¸ Git push ì‹¤íŒ¨: ${pushError.message}`, 5000);
                    }
                });
            
        } catch (error) {
            console.error('Git ìë™ ì»¤ë°‹ ì˜¤ë¥˜:', error);
            // Git ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ì‚¬ìš©ì ê²½í—˜ ë°©í•´í•˜ì§€ ì•ŠìŒ)
        }
    }

    async updateQuestionStats(question, isCorrect) {
        const file = this.app.vault.getAbstractFileByPath(question.filePath);
        if (!file) return;

        const content = await this.app.vault.read(file);
        const updatedQuestion = this.parseQuestionFile(content, question.filePath);
        
        if (updatedQuestion) {
            if (isCorrect) {
                updatedQuestion.correctCount = (updatedQuestion.correctCount || 0) + 1;
            } else {
                updatedQuestion.wrongCount = (updatedQuestion.wrongCount || 0) + 1;
            }
            updatedQuestion.lastAttempt = new Date().toLocaleString('ko-KR');
            
            await this.saveQuestion(updatedQuestion, false);
        }

        if (isCorrect) {
            this.settings.stats.totalCorrect++;
        } else {
            this.settings.stats.totalWrong++;
            // ì˜¤ë‹µ ëª©ë¡ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
            await this.updateWrongAnswerListTemplate();
        }
        this.settings.stats.totalAttempts++;
        this.settings.stats.lastStudyDate = new Date().toISOString();
        
        const today = new Date().toLocaleDateString('ko-KR');
        const todayRecord = this.settings.stats.studyHistory.find(h => h.date === today);
        if (todayRecord) {
            if (isCorrect) todayRecord.correct++;
            else todayRecord.wrong++;
            todayRecord.timestamp = Date.now();
        } else {
            this.settings.stats.studyHistory.push({
                date: today,
                correct: isCorrect ? 1 : 0,
                wrong: isCorrect ? 0 : 1,
                timestamp: Date.now()
            });
        }

        await this.saveSettings();
    }

    async toggleBookmark(question, bookmarkFolderName = null) {
        const file = this.app.vault.getAbstractFileByPath(question.filePath);
        if (!file) {
            new Notice('âŒ ë¬¸ì œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return false;
        }

        const content = await this.app.vault.read(file);
        const updatedQuestion = this.parseQuestionFile(content, question.filePath);
        
        if (updatedQuestion) {
            // í´ë”ëª…ì´ ì „ë‹¬ë˜ì§€ ì•Šìœ¼ë©´ í˜„ì¬ í´ë” ì‚¬ìš© (ì§ˆë¬¸ì˜ í´ë”)
            if (!bookmarkFolderName) {
                bookmarkFolderName = updatedQuestion.folder || 'ê¸°ë³¸';
            }
            
            console.log(`ğŸ”– ë¶ë§ˆí¬ ì²˜ë¦¬: filePath="${question.filePath}", íŒŒì¼ì—ì„œì¶”ì¶œëœí´ë”="${updatedQuestion.folder}", ì „ë‹¬ë°›ì€í´ë”="${bookmarkFolderName}"`);

            
            // ì´ë¯¸ ê°™ì€ í´ë”ì—ì„œ ë¶ë§ˆí¬ë˜ì–´ ìˆìœ¼ë©´ ì œê±°, ì•„ë‹ˆë©´ ì¶”ê°€
            if (updatedQuestion.bookmarkFolder === bookmarkFolderName) {
                updatedQuestion.bookmarkFolder = '';  // ë¶ë§ˆí¬ ì œê±°
            } else {
                updatedQuestion.bookmarkFolder = bookmarkFolderName;  // ë¶ë§ˆí¬ ì¶”ê°€/ë³€ê²½
            }
            
            await this.saveQuestion(updatedQuestion, false);
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            if (updatedQuestion.bookmarkFolder) {
                this.settings.stats.bookmarkedCount = (this.settings.stats.bookmarkedCount || 0) + 1;
                new Notice(`â­ [${bookmarkFolderName}] í´ë” ë¶ë§ˆí¬ ì¶”ê°€ë¨`);
            } else {
                this.settings.stats.bookmarkedCount = Math.max(0, (this.settings.stats.bookmarkedCount || 0) - 1);
                new Notice('ë¶ë§ˆí¬ ì œê±°ë¨');
            }
            
            await this.saveSettings();
            
            // ë¶ë§ˆí¬ ëª©ë¡ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸
            await this.updateBookmarkListTemplate();
            
            return updatedQuestion.bookmarkFolder ? bookmarkFolderName : null;
        }
        
        return false;
    }

    async updateQuestionDifficulty(question, newDifficulty) {
        const file = this.app.vault.getAbstractFileByPath(question.filePath);
        if (!file) return;

        const content = await this.app.vault.read(file);
        const updatedQuestion = this.parseQuestionFile(content, question.filePath);
        
        if (updatedQuestion) {
            updatedQuestion.difficulty = newDifficulty;
            await this.saveQuestion(updatedQuestion, false);
        }
    }

    async updateQuestionListTemplate(folder) {
        const folderPath = this.settings.questionsFolder + '/' + folder;
        const templatePath = folderPath + '/ë¬¸ì œëª©ë¡.md';
        const updateTime = new Date().toLocaleString('ko-KR');
        
        const template = '---\n' +
'cssclass: question-list\n' +
'---\n\n' +
'# ğŸ“‹ ' + folder + ' ë¬¸ì œëª©ë¡\n\n' +
'> ğŸ”„ ìë™ ìƒì„± ë¬¸ì„œ | ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ' + updateTime + '\n\n' +
'## ğŸ“Š í´ë” í†µê³„\n\n' +
'```dataviewjs\n' +
'const folder = "' + folderPath + '";\n' +
'const questions = dv.pages("\\"" + folder + "\\"").where(p => p.file.name.includes("_") && !p.file.name.includes("ë¬¸ì œëª©ë¡"));\n' +
'const total = questions.length;\n' +
'const bookmarked = questions.where(p => p.bookmarked === true).length;\n' +
'const withWrong = questions.where(p => p.wrongCount > 0).length;\n' +
'const aPlus = questions.where(p => p.difficulty === "A+").length;\n' +
'const a = questions.where(p => p.difficulty === "A").length;\n' +
'const aMinus = questions.where(p => p.difficulty === "A-").length;\n' +
'const b = questions.where(p => p.difficulty === "B").length;\n' +
'const bMinus = questions.where(p => p.difficulty === "B-").length;\n' +
'const c = questions.where(p => p.difficulty === "C").length;\n' +
'const d = questions.where(p => p.difficulty === "D").length;\n' +
'const e = questions.where(p => p.difficulty === "E").length;\n' +
'const f = questions.where(p => p.difficulty === "F").length;\n' +
'const container = dv.el("div", "", {cls: "stats-grid"});\n' +
'dv.el("div", `<div class="stat-label">ğŸ“š ì´ ë¬¸ì œ</div><div class="stat-value">${total}ê°œ</div>`, {container, cls: "stat-card"});\n' +
'dv.el("div", `<div class="stat-label">â­ ë¶ë§ˆí¬</div><div class="stat-value">${bookmarked}ê°œ</div>`, {container, cls: "stat-card"});\n' +
'dv.el("div", `<div class="stat-label">âŒ ì˜¤ë‹µ ìˆìŒ</div><div class="stat-value">${withWrong}ê°œ</div>`, {container, cls: "stat-card"});\n' +
'if (aPlus > 0) dv.el("div", `<div class="stat-label">ğŸ† A+</div><div class="stat-value">${aPlus}ê°œ</div>`, {container, cls: "stat-card easy"});\n' +
'if (a > 0) dv.el("div", `<div class="stat-label">â­ A</div><div class="stat-value">${a}ê°œ</div>`, {container, cls: "stat-card easy"});\n' +
'if (aMinus > 0) dv.el("div", `<div class="stat-label">â­ A-</div><div class="stat-value">${aMinus}ê°œ</div>`, {container, cls: "stat-card easy"});\n' +
'if (b > 0) dv.el("div", `<div class="stat-label">ğŸ˜Š B</div><div class="stat-value">${b}ê°œ</div>`, {container, cls: "stat-card normal"});\n' +
'if (bMinus > 0) dv.el("div", `<div class="stat-label">ğŸ˜Š B-</div><div class="stat-value">${bMinus}ê°œ</div>`, {container, cls: "stat-card normal"});\n' +
'if (c > 0) dv.el("div", `<div class="stat-label">ğŸ˜ C</div><div class="stat-value">${c}ê°œ</div>`, {container, cls: "stat-card normal"});\n' +
'if (d > 0) dv.el("div", `<div class="stat-label">ğŸ˜° D</div><div class="stat-value">${d}ê°œ</div>`, {container, cls: "stat-card hard"});\n' +
'if (e > 0) dv.el("div", `<div class="stat-label">ğŸ˜± E</div><div class="stat-value">${e}ê°œ</div>`, {container, cls: "stat-card hard"});\n' +
'if (f > 0) dv.el("div", `<div class="stat-label">ğŸ’€ F</div><div class="stat-value">${f}ê°œ</div>`, {container, cls: "stat-card hard"});\n' +
'```\n\n' +
'## ğŸ“š ì „ì²´ ë¬¸ì œ ëª©ë¡\n\n' +
'```dataviewjs\n' +
'const folder = "' + folderPath + '";\n' +
'const questions = dv.pages("\\"" + folder + "\\"").where(p => p.file.name.includes("_") && !p.file.name.includes("ë¬¸ì œëª©ë¡")).sort(p => p.file.name, "asc");\n' +
'if (questions.length > 0) {\n' +
'    const tableContainer = dv.el("div", "", {cls: "question-table"});\n' +
'    const header = dv.el("div", "", {container: tableContainer, cls: "table-header"});\n' +
'    dv.el("div", "ë²ˆí˜¸", {container: header});\n' +
'    dv.el("div", "í•œì", {container: header});\n' +
'    dv.el("div", "ë¬¸ì œ", {container: header});\n' +
'    dv.el("div", "ë‚œì´ë„", {container: header});\n' +
'    dv.el("div", "í†µê³„", {container: header});\n' +
'    dv.el("div", "ìƒíƒœ", {container: header});\n' +
'    for (const question of questions.array()) {\n' +
'        const difficultyVal = question.difficulty || "C";\n' +
'        const diffClass = (difficultyVal === "A+" || difficultyVal === "A" || difficultyVal === "A-") ? "easy" : (difficultyVal === "B" || difficultyVal === "B-" || difficultyVal === "C") ? "normal" : "hard";\n' +
'        const diffIcon = difficultyVal === "A+" ? "ğŸ†" : difficultyVal === "A" || difficultyVal === "A-" ? "â­" : difficultyVal === "B" || difficultyVal === "B-" ? "ğŸ˜Š" : difficultyVal === "C" ? "ğŸ˜" : difficultyVal === "D" ? "ğŸ˜°" : difficultyVal === "E" ? "ğŸ˜±" : "ğŸ’€";\n' +
'        const bookmark = question.bookmarked ? "â­ " : "";\n' +
'        const wrongBadge = question.wrongCount > 0 ? `<span class="badge wrong">${question.wrongCount}íšŒ ì˜¤ë‹µ</span>` : "";\n' +
'        const correctBadge = question.correctCount > 0 ? `<span class="badge correct">${question.correctCount}íšŒ ì •ë‹µ</span>` : "";\n' +
'        const row = dv.el("a", "", {container: tableContainer, cls: "table-row", attr: {href: question.file.path}});\n' +
'        dv.el("div", question.number || "-", {container: row, cls: "cell-number"});\n' +
'        dv.el("div", question.hanzi || "-", {container: row, cls: "cell-hanzi"});\n' +
'        dv.el("div", bookmark + (question.question || ""), {container: row, cls: "cell-question"});\n' +
'        dv.el("div", diffIcon + " " + difficultyVal, {container: row, cls: "cell-difficulty " + diffClass});\n' +
'        dv.el("div", correctBadge + " " + wrongBadge, {container: row, cls: "cell-stats"});\n' +
'        dv.el("div", "ğŸ‘ï¸", {container: row, cls: "cell-actions"});\n' +
'    }\n' +
'} else {\n' +
'    dv.el("p", "ğŸ“ ì•„ì§ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤", {cls: "empty"});\n' +
'}\n' +
'```\n\n' +
'## â­ ë¶ë§ˆí¬ ë¬¸ì œë§Œ ë³´ê¸°\n\n' +
'```dataviewjs\n' +
'const folder = "' + folderPath + '";\n' +
'const bookmarked = dv.pages("\\"" + folder + "\\"").where(p => p.file.name.includes("_") && !p.file.name.includes("ë¬¸ì œëª©ë¡") && p.bookmarked === true).sort(p => p.file.name, "asc");\n' +
'if (bookmarked.length > 0) {\n' +
'    const listContainer = dv.el("div", "", {cls: "compact-list"});\n' +
'    for (const question of bookmarked.array()) {\n' +
'        const diffIcon = question.difficulty === "A+" || question.difficulty === "A" || question.difficulty === "A-" ? "â­" : question.difficulty === "D" || question.difficulty === "E" || question.difficulty === "F" ? "ğŸ˜°" : "ğŸ˜";\n' +
'        const item = dv.el("a", "", {container: listContainer, cls: "compact-item", attr: {href: question.file.path}});\n' +
'        dv.el("span", question.hanzi, {container: item, cls: "item-hanzi"});\n' +
'        dv.el("span", question.question, {container: item, cls: "item-text"});\n' +
'        dv.el("span", diffIcon, {container: item, cls: "item-badge"});\n' +
'    }\n' +
'} else {\n' +
'    dv.el("p", "â­ ë¶ë§ˆí¬í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤", {cls: "empty"});\n' +
'}\n' +
'```\n\n' +
'## âŒ ì˜¤ë‹µ ë§ì€ ë¬¸ì œ TOP 10\n\n' +
'```dataviewjs\n' +
'const folder = "' + folderPath + '";\n' +
'const wrong = dv.pages("\\"" + folder + "\\"").where(p => p.file.name.includes("_") && !p.file.name.includes("ë¬¸ì œëª©ë¡") && p.wrongCount > 0).sort(p => p.wrongCount, "desc").limit(10);\n' +
'if (wrong.length > 0) {\n' +
'    const listContainer = dv.el("div", "", {cls: "wrong-list"});\n' +
'    for (const question of wrong.array()) {\n' +
'        const item = dv.el("a", "", {container: listContainer, cls: "wrong-item", attr: {href: question.file.path}});\n' +
'        dv.el("span", "âŒ " + question.wrongCount + "íšŒ", {container: item, cls: "wrong-rank"});\n' +
'        dv.el("span", question.hanzi, {container: item, cls: "wrong-hanzi"});\n' +
'        dv.el("span", question.question, {container: item, cls: "wrong-question"});\n' +
'    }\n' +
'} else {\n' +
'    dv.el("p", "âœ… ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!", {cls: "empty"});\n' +
'}\n' +
'```\n\n' +
'<style>\n' +
'.question-list { padding: 20px; max-width: 1400px; margin: 0 auto; }\n' +
'.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 25px 0; }\n' +
'.stat-card { padding: 20px; background: var(--background-secondary); border-radius: 10px; text-align: center; border: 2px solid var(--background-modifier-border); transition: all 0.2s; }\n' +
'.stat-card:hover { border-color: var(--interactive-accent); transform: translateY(-3px); }\n' +
'.stat-card.easy { border-color: rgba(76, 175, 80, 0.5); }\n' +
'.stat-card.normal { border-color: rgba(255, 152, 0, 0.5); }\n' +
'.stat-card.hard { border-color: rgba(244, 67, 54, 0.5); }\n' +
'.stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; }\n' +
'.stat-value { font-size: 28px; font-weight: bold; color: var(--text-normal); }\n' +
'.question-table { margin: 20px 0; }\n' +
'.table-header { display: grid; grid-template-columns: 60px 80px 1fr 100px 180px 60px; gap: 15px; padding: 15px; background: var(--background-secondary); border-radius: 8px; font-weight: bold; margin-bottom: 10px; font-size: 14px; }\n' +
'.table-row { display: grid; grid-template-columns: 60px 80px 1fr 100px 180px 60px; gap: 15px; padding: 15px; background: var(--background-secondary); border: 2px solid var(--background-modifier-border); border-radius: 8px; margin-bottom: 8px; text-decoration: none; transition: all 0.2s; align-items: center; }\n' +
'.table-row:hover { border-color: var(--interactive-accent); background: var(--background-modifier-hover); transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }\n' +
'.cell-number { font-weight: bold; color: var(--text-muted); }\n' +
'.cell-hanzi { font-size: 32px; font-weight: bold; color: var(--text-accent); }\n' +
'.cell-question { color: var(--text-normal); line-height: 1.4; }\n' +
'.cell-difficulty { font-size: 14px; padding: 5px 10px; border-radius: 15px; text-align: center; }\n' +
'.cell-difficulty.easy { background: rgba(76, 175, 80, 0.15); color: #4caf50; }\n' +
'.cell-difficulty.normal { background: rgba(255, 152, 0, 0.15); color: #ff9800; }\n' +
'.cell-difficulty.hard { background: rgba(244, 67, 54, 0.15); color: #f44336; }\n' +
'.cell-stats { display: flex; gap: 5px; flex-wrap: wrap; }\n' +
'.badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; }\n' +
'.badge.correct { background: rgba(76, 175, 80, 0.15); color: #4caf50; }\n' +
'.badge.wrong { background: rgba(244, 67, 54, 0.15); color: #f44336; }\n' +
'.compact-list, .wrong-list { display: flex; flex-direction: column; gap: 10px; margin: 20px 0; }\n' +
'.compact-item, .wrong-item { display: flex; align-items: center; gap: 15px; padding: 12px 15px; background: var(--background-secondary); border: 2px solid var(--background-modifier-border); border-radius: 8px; text-decoration: none; transition: all 0.2s; }\n' +
'.compact-item:hover, .wrong-item:hover { border-color: var(--interactive-accent); background: var(--background-modifier-hover); transform: translateX(5px); }\n' +
'.item-hanzi, .wrong-hanzi { font-size: 28px; font-weight: bold; min-width: 60px; text-align: center; color: var(--text-accent); }\n' +
'.item-text, .wrong-question { flex: 1; color: var(--text-normal); }\n' +
'.item-badge { padding: 5px 12px; border-radius: 12px; background: var(--background-primary); font-size: 16px; }\n' +
'.wrong-rank { padding: 5px 12px; background: rgba(244, 67, 54, 0.15); color: #f44336; border-radius: 12px; font-weight: bold; font-size: 12px; min-width: 80px; text-align: center; }\n' +
'.empty { text-align: center; padding: 40px 20px; color: var(--text-muted); background: var(--background-secondary); border-radius: 10px; font-size: 16px; margin: 20px 0; }\n' +
'@media (max-width: 768px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .table-header, .table-row { grid-template-columns: 50px 60px 1fr; gap: 10px; } .cell-difficulty, .cell-stats, .cell-actions { display: none; } .cell-hanzi { font-size: 24px; } }\n' +
'</style>\n\n' +
'---\n' +
'*ì´ ë¬¸ì œëª©ë¡ì€ DataviewJSë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤*\n';

        try {
            // í´ë” ì¡´ì¬ í™•ì¸ ë° ìƒì„± (ì¬ê·€ì ìœ¼ë¡œ, ëª¨ë°”ì¼ í˜¸í™˜)
            const folderExists = this.app.vault.getAbstractFileByPath(folderPath);
            if (!folderExists) {
                console.log('ğŸ“ í´ë” ìƒì„±:', folderPath);
                // ë¶€ëª¨ í´ë”ë“¤ë„ í•¨ê»˜ ìƒì„±
                const pathParts = folderPath.split('/');
                let currentPath = '';
                for (const part of pathParts) {
                    if (!part) continue;
                    currentPath = currentPath ? `${currentPath}/${part}` : part;
                    const exists = this.app.vault.getAbstractFileByPath(currentPath);
                    if (!exists) {
                        try {
                            await this.app.vault.createFolder(currentPath);
                        } catch (e) {
                            // í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ
                        }
                    }
                }
            }
            
            const file = this.app.vault.getAbstractFileByPath(templatePath);
            if (file) {
                await this.app.vault.modify(file, template);
                console.log('âœ… ë¬¸ì œëª©ë¡ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ë¨:', templatePath);
            } else {
                await this.app.vault.create(templatePath, template);
                console.log('âœ… ë¬¸ì œëª©ë¡ í…œí”Œë¦¿ ìƒì„±ë¨:', templatePath);
            }
        } catch (error) {
            console.error('âŒ ë¬¸ì œëª©ë¡ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            // íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° modify ì‹œë„
            if (error.message && error.message.includes('already exists')) {
                try {
                    const file = this.app.vault.getAbstractFileByPath(templatePath);
                    if (file) {
                        await this.app.vault.modify(file, template);
                        console.log('âœ… ê¸°ì¡´ íŒŒì¼ ì—…ë°ì´íŠ¸ë¨:', templatePath);
                    }
                } catch (retryError) {
                    console.error('âŒ ì¬ì‹œë„ ì‹¤íŒ¨:', retryError);
                }
            }
        }
    }

        async updateBookmarkListTemplate() {
        const allQuestions = await this.loadAllQuestions();
        const bookmarkFolderName = this.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬';
        const bookmarkParentPath = this.settings.quizFolder + '/' + bookmarkFolderName;
        
        // ë¶ë§ˆí¬ ë©”ì¸ í´ë” ìƒì„±
        try {
            const bookmarkFolderExists = this.app.vault.getAbstractFileByPath(bookmarkParentPath);
            if (!bookmarkFolderExists) {
                await this.app.vault.createFolder(bookmarkParentPath);
            }
        } catch (e) {
            console.log('ë¶ë§ˆí¬ í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ:', bookmarkParentPath);
        }
        
        // ì§ˆë¬¸ í´ë”ë³„ë¡œ ë¶ë§ˆí¬ ë¶„ë¥˜
        const bookmarksByFolder = {};
        for (const question of allQuestions) {
            if (question.bookmarkFolder && question.bookmarkFolder.length > 0) {
                if (!bookmarksByFolder[question.bookmarkFolder]) {
                    bookmarksByFolder[question.bookmarkFolder] = [];
                }
                bookmarksByFolder[question.bookmarkFolder].push(question);
            }
        }
        
        // ê° í´ë”ë³„ ë¶ë§ˆí¬ ì„œë¸Œí´ë” ìƒì„± ë° ëª©ë¡ íŒŒì¼ ìƒì„±
        for (const [folderName, questions] of Object.entries(bookmarksByFolder)) {
            const subFolderPath = bookmarkParentPath + '/' + folderName;
            
            // ì„œë¸Œí´ë” ìƒì„±
            try {
                const subFolderExists = this.app.vault.getAbstractFileByPath(subFolderPath);
                if (!subFolderExists) {
                    await this.app.vault.createFolder(subFolderPath);
                }
            } catch (e) {
                console.log('ë¶ë§ˆí¬ ì„œë¸Œí´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ:', subFolderPath);
            }
            
            // í´ë”ë³„ ë¶ë§ˆí¬ ëª©ë¡ íŒŒì¼ ìƒì„±
            const listFileName = subFolderPath + '/ë¬¸ì œëª©ë¡.md';
            const easyCount = questions.filter(q => q.difficulty === 'ì‰¬ì›€').length;
            const normalCount = questions.filter(q => q.difficulty === 'ë³´í†µ').length;
            const hardCount = questions.filter(q => q.difficulty === 'ì–´ë ¤ì›€').length;
            
            const template = `# â­ [${folderName}] ë¶ë§ˆí¬ ë¬¸ì œëª©ë¡

> ğŸ“ í´ë”: ${folderName}
> ğŸ“Š ë¶ë§ˆí¬: ${questions.length}ê°œ (ì‰¬ì›€: ${easyCount}ê°œ, ë³´í†µ: ${normalCount}ê°œ, ì–´ë ¤ì›€: ${hardCount}ê°œ)

## ğŸ“‹ ë¶ë§ˆí¬ ë¬¸ì œë“¤

| # | í•œì | ë¬¸ì œ | ë‚œì´ë„ | ì˜¤ë‹µ |
|---|------|------|--------|------|
${questions.map((q, idx) => `| ${idx + 1} | ${q.hanzi || '-'} | ${q.question?.substring(0, 50) || '-'} | ${q.difficulty || '-'} | ${q.wrongCount || 0} |`).join('\n')}

---
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}
`;
            
            try {
                const file = this.app.vault.getAbstractFileByPath(listFileName);
                if (file) {
                    await this.app.vault.modify(file, template);
                } else {
                    await this.app.vault.create(listFileName, template);
                }
            } catch (error) {
                console.error(`âŒ ë¶ë§ˆí¬ ëª©ë¡ íŒŒì¼ ìƒì„± ì‹¤íŒ¨ [${folderName}]:`, error);
            }
        }
        
        // ì„ íƒì§€ ë¶ë§ˆí¬ í´ë”ë³„ë¡œ ë¶„ë¥˜
        const optionBookmarksByFolder = {};
        for (const question of allQuestions) {
            if (question.optionBookmarkFolders && question.optionBookmarkFolders.length > 0) {
                question.optionBookmarkFolders.forEach((folder, optionIndex) => {
                    if (folder && folder.length > 0) {
                        if (!optionBookmarksByFolder[folder]) {
                            optionBookmarksByFolder[folder] = [];
                        }
                        optionBookmarksByFolder[folder].push({
                            question: question,
                            optionIndex: optionIndex,
                            optionText: question.options[optionIndex],
                            isCorrect: optionIndex === question.answer
                        });
                    }
                });
            }
        }
        
        // ì„ íƒì§€ ë¶ë§ˆí¬ í´ë”ë³„ ëª©ë¡ íŒŒì¼ ìƒì„±
        for (const [folderName, optionBookmarks] of Object.entries(optionBookmarksByFolder)) {
            const subFolderPath = bookmarkParentPath + '/' + folderName;
            
            // ì„œë¸Œí´ë” ìƒì„± (ì´ë¯¸ ë¬¸ì œ ë¶ë§ˆí¬ì—ì„œ ìƒì„±ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
            try {
                const subFolderExists = this.app.vault.getAbstractFileByPath(subFolderPath);
                if (!subFolderExists) {
                    await this.app.vault.createFolder(subFolderPath);
                }
            } catch (e) {
                console.log('ì„ íƒì§€ ë¶ë§ˆí¬ ì„œë¸Œí´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ:', subFolderPath);
            }
            
            // ì„ íƒì§€ ë¶ë§ˆí¬ ëª©ë¡ íŒŒì¼ ìƒì„±
            const optionListFileName = subFolderPath + '/ì„ íƒì§€ëª©ë¡.md';
            const correctCount = optionBookmarks.filter(ob => ob.isCorrect).length;
            const incorrectCount = optionBookmarks.length - correctCount;
            
            const optionTemplate = `# â­ [${folderName}] ë¶ë§ˆí¬ ì„ íƒì§€ ëª©ë¡

> ğŸ“ í´ë”: ${folderName}
> ğŸ“Š ë¶ë§ˆí¬ëœ ì„ íƒì§€: ${optionBookmarks.length}ê°œ (ì •ë‹µ: ${correctCount}ê°œ, ì˜¤ë‹µ: ${incorrectCount}ê°œ)

## ğŸ“‹ ë¶ë§ˆí¬ëœ ì„ íƒì§€ë“¤

| # | í•œì | ë¬¸ì œ | ì„ íƒì§€ | ì •/ì˜¤ | ë‚œì´ë„ |
|---|------|------|--------|-------|--------|
${optionBookmarks.map((ob, idx) => `| ${idx + 1} | ${ob.question.hanzi || '-'} | ${ob.question.question?.substring(0, 30) || '-'} | ${ob.optionText?.substring(0, 40) || '-'} | ${ob.isCorrect ? 'âœ…' : 'âŒ'} | ${ob.question.difficulty || '-'} |`).join('\n')}

---
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}
`;
            
            try {
                const file = this.app.vault.getAbstractFileByPath(optionListFileName);
                if (file) {
                    await this.app.vault.modify(file, optionTemplate);
                } else {
                    await this.app.vault.create(optionListFileName, optionTemplate);
                }
            } catch (error) {
                console.error(`âŒ ì„ íƒì§€ ë¶ë§ˆí¬ ëª©ë¡ íŒŒì¼ ìƒì„± ì‹¤íŒ¨ [${folderName}]:`, error);
            }
        }
        
        // ì „ì²´ ë¶ë§ˆí¬ í†µê³„ íŒŒì¼ ìƒì„±
        const templatePath = `${this.settings.quizFolder}/${bookmarkFolderName}/ğŸ“Š ë¶ë§ˆí¬ í†µê³„.md`;
        const totalBookmarkedCount = Object.values(bookmarksByFolder).reduce((sum, arr) => sum + arr.length, 0);
        const totalOptionBookmarkedCount = Object.values(optionBookmarksByFolder).reduce((sum, arr) => sum + arr.length, 0);
        
        const statsTemplate = `# â­ ë¶ë§ˆí¬ í†µê³„

## ğŸ“Š ì „ì²´ í†µê³„
- ì´ ë¬¸ì œ ë¶ë§ˆí¬: ${totalBookmarkedCount}ê°œ
- ì´ ì„ íƒì§€ ë¶ë§ˆí¬: ${totalOptionBookmarkedCount}ê°œ
- í´ë”ë³„ ë¶„ë¥˜: ${Object.keys(bookmarksByFolder).length}ê°œ

## ğŸ“ í´ë”ë³„ ë¬¸ì œ ë¶ë§ˆí¬ í˜„í™©

| í´ë”ëª… | ë¬¸ì œ | ì„ íƒì§€ | ì‰¬ì›€ | ë³´í†µ | ì–´ë ¤ì›€ |
|--------|------|--------|------|------|--------|
${Object.keys(bookmarksByFolder).concat(Object.keys(optionBookmarksByFolder)).filter((v, i, a) => a.indexOf(v) === i).map(folder => {
    const questions = bookmarksByFolder[folder] || [];
    const options = optionBookmarksByFolder[folder] || [];
    const easy = questions.filter(q => q.difficulty === 'ì‰¬ì›€').length;
    const normal = questions.filter(q => q.difficulty === 'ë³´í†µ').length;
    const hard = questions.filter(q => q.difficulty === 'ì–´ë ¤ì›€').length;
    return `| ${folder} | [${questions.length}ê°œ](${bookmarkFolderName}/${folder}/ë¬¸ì œëª©ë¡.md) | [${options.length}ê°œ](${bookmarkFolderName}/${folder}/ì„ íƒì§€ëª©ë¡.md) | ${easy} | ${normal} | ${hard} |`;
}).join('\n')}

---
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}
`;
        
        try {
            const file = this.app.vault.getAbstractFileByPath(templatePath);
            if (file) {
                await this.app.vault.modify(file, statsTemplate);
            } else {
                await this.app.vault.create(templatePath, statsTemplate);
            }
        } catch (error) {
            console.error('âŒ ë¶ë§ˆí¬ í†µê³„ íŒŒì¼ ìƒì„± ì‹¤íŒ¨:', error);
        }
    }

    async updateWrongAnswerListTemplate() {
        const templatePath = `${this.settings.quizFolder}/âŒ ì˜¤ë‹µ ëª©ë¡.md`;
        
        const template = `# âŒ ì˜¤ë‹µ ëª©ë¡

> í‹€ë¦° ë¬¸ì œë“¤ì„ ëª¨ì•„ì„œ ë³µìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ğŸ“Š ì˜¤ë‹µ í†µê³„

\`\`\`dataview
TABLE WITHOUT ID
  length(rows) as "ì˜¤ë‹µ ê¸°ë¡ ìˆ˜",
  length(rows.file.folder) as "ë¬¸ì œ ì¢…ë¥˜"
FROM "${this.settings.wrongAnswersFolder}"
\`\`\`

## ğŸ“… ìµœê·¼ ì˜¤ë‹µ (ìµœê·¼ 10ê°œ)

\`\`\`dataview
TABLE
  file.name as "íŒŒì¼ëª…",
  file.mtime as "ë‚ ì§œ"
FROM "${this.settings.wrongAnswersFolder}"
SORT file.mtime DESC
LIMIT 10
\`\`\`

## ğŸ”¥ ìì£¼ í‹€ë¦¬ëŠ” ë¬¸ì œ

\`\`\`dataview
TABLE
  hanzi as "í•œì",
  question as "ë¬¸ì œ",
  wrongCount as "ì˜¤ë‹µ íšŸìˆ˜",
  difficulty as "ë‚œì´ë„",
  folder as "í´ë”"
FROM "${this.settings.questionsFolder}"
WHERE wrongCount > 0
SORT wrongCount DESC
LIMIT 20
\`\`\`

## ğŸ“‚ í´ë”ë³„ ì˜¤ë‹µë¥ 

\`\`\`dataview
TABLE
  folder as "í´ë”",
  hanzi as "í•œì",
  wrongCount as "ì˜¤ë‹µ",
  correctCount as "ì •ë‹µ",
  round((wrongCount / (wrongCount + correctCount)) * 100, 1) + "%" as "ì˜¤ë‹µë¥ "
FROM "${this.settings.questionsFolder}"
WHERE wrongCount > 0
SORT wrongCount DESC
\`\`\`

---
ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleString('ko-KR')}
`;

        try {
            // í´ë” ì¡´ì¬ í™•ì¸ ë° ìƒì„± (ëª¨ë°”ì¼ í˜¸í™˜)
            const quizFolderExists = this.app.vault.getAbstractFileByPath(this.settings.quizFolder);
            if (!quizFolderExists) {
                console.log('í€´ì¦ˆ í´ë” ìƒì„±:', this.settings.quizFolder);
                try {
                    await this.app.vault.createFolder(this.settings.quizFolder);
                } catch (e) {
                    console.log('í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ');
                }
            }
            
            const file = this.app.vault.getAbstractFileByPath(templatePath);
            if (file) {
                await this.app.vault.modify(file, template);
            } else {
                await this.app.vault.create(templatePath, template);
            }
        } catch (error) {
            console.error('ì˜¤ë‹µ ëª©ë¡ í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        }
    }

    async viewQuestionList() {
        const questions = await this.loadAllQuestions();
        
        if (questions.length === 0) {
            new Notice('ì €ì¥ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // ë‚œì´ë„ë³„ ë¶„ë¥˜ (9ë‹¨ê³„)
        const difficultyGroups = {
            'A+': questions.filter(q => q.difficulty === 'A+'),
            'A': questions.filter(q => q.difficulty === 'A'),
            'A-': questions.filter(q => q.difficulty === 'A-'),
            'B': questions.filter(q => q.difficulty === 'B'),
            'B-': questions.filter(q => q.difficulty === 'B-'),
            'C': questions.filter(q => q.difficulty === 'C'),
            'D': questions.filter(q => q.difficulty === 'D'),
            'E': questions.filter(q => q.difficulty === 'E'),
            'F': questions.filter(q => q.difficulty === 'F')
        };

        const bookmarkedQuestions = questions.filter(q => q.bookmarked);
        const wrongQuestions = questions.filter(q => (q.wrongCount || 0) > 0).sort((a, b) => b.wrongCount - a.wrongCount);

        // í´ë”ë³„ ë¶„ë¥˜
        const folders = this.settings.questionFolders || ['ê¸°ë³¸'];
        const folderSections = folders.map(folder => {
            const folderQuestions = questions.filter(q => (q.folder || 'ê¸°ë³¸') === folder);
            if (folderQuestions.length === 0) return '';
            
            return `### ğŸ“ ${folder} (${folderQuestions.length}ê°œ)
${folderQuestions.map(q => `- ${q.number}. ${q.hanzi} - ${q.question} ${this.getDifficultyIcon(q.difficulty)} ${q.bookmarked ? 'â­' : ''}`).join('\n')}`;
        }).filter(s => s).join('\n\n');

        // ë‚œì´ë„ë³„ ì„¹ì…˜ ìƒì„±
        const difficultyIcons = {
            'A+': 'ğŸ†', 'A': 'â­', 'A-': 'â­',
            'B': 'ğŸ˜Š', 'B-': 'ğŸ˜Š', 'C': 'ğŸ˜',
            'D': 'ğŸ˜°', 'E': 'ğŸ˜±', 'F': 'ğŸ’€'
        };

        const difficultySections = Object.entries(difficultyGroups)
            .filter(([_, qs]) => qs.length > 0)
            .map(([diff, qs]) => {
                return `### ${difficultyIcons[diff]} ${diff} (${qs.length}ê°œ)
${qs.map(q => `- ${q.number}. ${q.hanzi} - ${q.question} ${q.bookmarked ? 'â­' : ''} (${q.folder || 'ê¸°ë³¸'})`).join('\n')}`;
            }).join('\n\n');

        const listContent = `# ğŸ“š í•œì ë¬¸ì œ ëª©ë¡

ì „ì²´ ë¬¸ì œ ìˆ˜: **${questions.length}**ê°œ

## ğŸ“Š ë‚œì´ë„ë³„ ë¶„í¬
${Object.entries(difficultyGroups).map(([diff, qs]) => `- ${difficultyIcons[diff]} ${diff}: ${qs.length}ê°œ`).join('\n')}
- â­ ë¶ë§ˆí¬: ${bookmarkedQuestions.length}ê°œ

## ğŸ“‚ í´ë”ë³„ ë¬¸ì œ
${folderSections}

## ğŸ¯ ë‚œì´ë„ë³„ ë¬¸ì œ
${difficultySections}

## â­ ë¶ë§ˆí¬ëœ ë¬¸ì œ
${bookmarkedQuestions.length > 0 ? bookmarkedQuestions.map(q => `- ${q.number}. ${q.hanzi} - ${q.question} (${q.folder || 'ê¸°ë³¸'}) ${this.getDifficultyIcon(q.difficulty)}`).join('\n') : 'ì—†ìŒ'}

## âŒ ì˜¤ë‹µì´ ë§ì€ ë¬¸ì œ TOP 10
${wrongQuestions.length > 0 ? wrongQuestions.slice(0, 10).map(q => `- ${q.number}. ${q.hanzi} (ì˜¤ë‹µ ${q.wrongCount}íšŒ, ${q.folder || 'ê¸°ë³¸'}) ${this.getDifficultyIcon(q.difficulty)}`).join('\n') : 'ì—†ìŒ'}

---
ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
`;

        const listPath = `${this.settings.quizFolder}/ë¬¸ì œëª©ë¡.md`;
        const file = this.app.vault.getAbstractFileByPath(listPath);
        
        if (file) {
            await this.app.vault.modify(file, listContent);
        } else {
            await this.app.vault.create(listPath, listContent);
        }

        const leaf = this.app.workspace.getLeaf(false);
        await leaf.openFile(this.app.vault.getAbstractFileByPath(listPath));
    }

    async viewStatistics() {
        const stats = this.settings.stats;
        const questions = await this.loadAllQuestions();
        
        const totalAttempts = stats.totalAttempts || 0;
        const totalCorrect = stats.totalCorrect || 0;
        const totalWrong = stats.totalWrong || 0;
        const accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;

        const recentHistory = stats.studyHistory.slice(-7);

        const statsContent = `# ğŸ“ˆ í•™ìŠµ í†µê³„

## ì „ì²´ í†µê³„
- ğŸ“š ì´ ë¬¸ì œ ìˆ˜: **${questions.length}**ê°œ
- ğŸ¯ ì´ ì‹œë„ íšŸìˆ˜: **${totalAttempts}**íšŒ
- âœ… ì •ë‹µ: **${totalCorrect}**íšŒ
- âŒ ì˜¤ë‹µ: **${totalWrong}**íšŒ
- ğŸ“Š ì •ë‹µë¥ : **${accuracy}%**
- â­ ë¶ë§ˆí¬: **${stats.bookmarkedCount || 0}**ê°œ
- ğŸ“… ë§ˆì§€ë§‰ í•™ìŠµ: ${stats.lastStudyDate ? new Date(stats.lastStudyDate).toLocaleString('ko-KR') : 'ì—†ìŒ'}

## ğŸ“… ìµœê·¼ 7ì¼ í•™ìŠµ ê¸°ë¡
${recentHistory.length > 0 ? recentHistory.map(h => `- ${h.date}: ì •ë‹µ ${h.correct}ê°œ, ì˜¤ë‹µ ${h.wrong}ê°œ`).join('\n') : 'í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'}

---
ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
`;

        const statsPath = `${this.settings.quizFolder}/í•™ìŠµí†µê³„.md`;
        const file = this.app.vault.getAbstractFileByPath(statsPath);
        
        if (file) {
            await this.app.vault.modify(file, statsContent);
        } else {
            await this.app.vault.create(statsPath, statsContent);
        }

        const leaf = this.app.workspace.getLeaf(false);
        await leaf.openFile(this.app.vault.getAbstractFileByPath(statsPath));
    }

    async saveQuizResult(result) {
        // í´ë”ë³„ ì†Œìš”ì‹œê°„ ì§‘ê³„
        const folderTimes = {};
        result.details.forEach(d => {
            const folder = d.folder || 'ê¸°ë³¸';
            if (!folderTimes[folder]) folderTimes[folder] = 0;
            folderTimes[folder] += d.time || 0;
        });

        // í´ë”ë³„ í†µê³„ ì§‘ê³„
        const folderStats = {};
        result.details.forEach(d => {
            const folder = d.folder || 'ê¸°ë³¸';
            if (!folderStats[folder]) {
                folderStats[folder] = { total: 0, correct: 0, wrong: 0 };
            }
            folderStats[folder].total++;
            if (d.isCorrect) {
                folderStats[folder].correct++;
            } else {
                folderStats[folder].wrong++;
            }
        });

        // studyHistory ì´ˆê¸°í™”
        if (!this.settings.stats) {
            this.settings.stats = { studyHistory: [] };
        }
        if (!this.settings.stats.studyHistory) {
            this.settings.stats.studyHistory = [];
        }

        // ê° í´ë”ë³„ë¡œ ê°œë³„ ê¸°ë¡ ì €ì¥
        const now = Date.now();
        const today = new Date().toLocaleDateString('ko-KR');
        
        Object.entries(folderStats).forEach(([folderName, stats]) => {
            this.settings.stats.studyHistory.push({
                timestamp: now,
                date: today,
                folderName: folderName,
                total: stats.total,
                correct: stats.correct,
                wrong: stats.wrong,
                time: folderTimes[folderName] || 0
            });
        });

        await this.saveSettings();

        // ëŒ€í‘œ í´ë”ëª… ê²°ì • (ê°€ì¥ ë§ì´ í‘¼ í´ë”)
        let mainFolder = 'ê¸°ë³¸';
        if (result.details && result.details.length > 0) {
            const folderCount = {};
            result.details.forEach(d => {
                const f = d.folder || 'ê¸°ë³¸';
                folderCount[f] = (folderCount[f] || 0) + 1;
            });
            mainFolder = Object.entries(folderCount).sort((a, b) => b[1] - a[1])[0][0];
        }

        // íŒŒì¼ëª… ìƒì„±: í€´ì¦ˆê²°ê³¼_[í´ë”ëª…]_[ë‚ ì§œì‹œê°„]
        const nowDate = new Date();
        const dateStr = nowDate.toLocaleDateString('ko-KR', { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit' 
        }).replace(/\. /g, '-').replace('.', '');
        const timeStr = nowDate.toLocaleTimeString('ko-KR', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit',
            hour12: false 
        }).replace(/:/g, '');
        const fileName = `${this.settings.resultsFolder}/í€´ì¦ˆê²°ê³¼_${mainFolder}_${dateStr}_${timeStr}.md`;

        // ë‚ ì§œë³„ ì†Œìš”ì‹œê°„(times ë°°ì—´) frontmatterì—ì„œ ì½ê¸° ë° ì¶”ê°€/ì‚­ì œ í•¨ìˆ˜
        let timesArr = [];
        try {
            const activeFile = this.app.workspace.getActiveFile();
            if (activeFile) {
                const cache = this.app.metadataCache.getFileCache(activeFile);
                const times = cache?.frontmatter?.times;
                if (Array.isArray(times)) timesArr = times;
                else if (typeof times === 'number') timesArr = [times];
            }
        } catch (e) {
            console.warn('ìŠ¤í†±ì›Œì¹˜ ì‹œê°„ ì½ê¸° ì‹¤íŒ¨:', e);
        }

        // ë‚ ì§œë³„ ì†Œìš”ì‹œê°„ ì¶”ê°€/ì‚­ì œ í•¨ìˆ˜
        function addTimeRecord(date, time) {
            timesArr.push({ date, time });
        }
        function removeTimeRecord(date) {
            timesArr = timesArr.filter(t => t.date !== date);
        }

        // ì˜¤ëŠ˜ ë‚ ì§œë³„ ì†Œìš”ì‹œê°„ ì¶”ê°€
        const todayIso = new Date().toISOString().slice(0, 10);
        addTimeRecord(todayIso, result.time);

        // í€´ì¦ˆ ê²°ê³¼ ê¸°ë¡
        let folderTimeStr = Object.entries(folderTimes)
            .map(([folder, time]) => `- ${folder}: ${this.formatTime(time)}`)
            .join('\n');

        let timesStr = timesArr.map(t => `- ${t.date}: ${this.formatTime(t.time)} (ì†Œìš”ì‹œê°„(ì´ˆ): ${t.time})`).join('\n');

        const content = `---\ní€´ì¦ˆê²°ê³¼: true\nì†Œìš”ì‹œê°„(ì´ˆ): ${result.time}\në¬¸ì œí´ë”ëª…: ${mainFolder}\n---\n\n# ğŸ¯ í€´ì¦ˆ ê²°ê³¼

## ğŸ“Š ì ìˆ˜
- **ì •ë‹µ**: ${result.correct}ê°œ
- **ì˜¤ë‹µ**: ${result.incorrect}ê°œ
- **ì´ ë¬¸ì œ**: ${result.total}ê°œ
- **ì •ë‹µë¥ **: ${result.percentage}%
- ì†Œìš”ì‹œê°„(ì´ˆ): ${result.time}

## â±ï¸ í´ë”ë³„ ì†Œìš”ì‹œê°„
${folderTimeStr}

## ğŸ“… ë‚ ì§œë³„ ì†Œìš”ì‹œê°„
${timesStr}

## ğŸ“ ìƒì„¸ ê²°ê³¼
${result.details.map((d, idx) => `${idx + 1}. [${d.folder || 'ê¸°ë³¸'}] ${d.hanzi} - ${d.isCorrect ? 'âœ…' : 'âŒ'} ${d.question} (${this.formatTime(d.time || 0)})`).join('\n')}

## ğŸ“Œ ë³µìŠµì´ í•„ìš”í•œ í•œì
${result.details.filter(d => !d.isCorrect).map(d => `- ${d.hanzi}`).join('\n') || 'ì—†ìŒ'}

---
ë‚ ì§œ: ${new Date().toLocaleString('ko-KR')}
`;

        await this.app.vault.create(fileName, content);
        const leaf = this.app.workspace.getLeaf(false);
        await leaf.openFile(this.app.vault.getAbstractFileByPath(fileName));
        new Notice('âœ… í€´ì¦ˆ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    async generateQuestionDashboard() {
        const folders = this.settings.questionFolders || ['ê¸°ë³¸'];
        
        // í´ë” ì„ íƒ ëª¨ë‹¬
        const folderModal = new FolderSelectionModal(this.app, folders, async (selectedFolder) => {
            const folderPath = `${this.settings.questionsFolder}/${selectedFolder}`;
            const dashboardPath = `${folderPath}/ğŸ“Š ë¬¸ì œ ëŒ€ì‹œë³´ë“œ.md`;
            
            const dashboardContent = this.getDashboardTemplate(selectedFolder);
            
            try {
                // ê¸°ì¡´ íŒŒì¼ì´ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°, ì—†ìœ¼ë©´ ìƒì„±
                const existingFile = this.app.vault.getAbstractFileByPath(dashboardPath);
                if (existingFile) {
                    await this.app.vault.modify(existingFile, dashboardContent);
                } else {
                    await this.app.vault.create(dashboardPath, dashboardContent);
                }
                
                // ìƒì„±ëœ íŒŒì¼ ì—´ê¸°
                const file = this.app.vault.getAbstractFileByPath(dashboardPath);
                if (file) {
                    await this.app.workspace.getLeaf().openFile(file);
                }
                
                new Notice(`âœ… ${selectedFolder} í´ë”ì˜ ë¬¸ì œ ëŒ€ì‹œë³´ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } catch (error) {
                new Notice(`âŒ ëŒ€ì‹œë³´ë“œ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
                console.error(error);
            }
        });
        
        folderModal.open();
    }

    getDashboardTemplate(folderName) {
        const folder = `HanziQuiz/Questions/${folderName}`;
        const now = new Date();
        const timeString = now.toTimeString().split(' ')[0];
        const dateString = now.toLocaleString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
        
        return `---
cssclasses:
  - dashboard
times: ["${timeString}"]
created-datetime: "${dateString}"
---

# ï¿½ ${folderName}

> **ë¬¸ì œ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ** | ğŸ“… ${dateString}

---

\`\`\`dataviewjs
const thisFile = dv.current();
dv.paragraph(\`ğŸ“… **ìƒì„±ì¼ì‹œ**: \${thisFile["created-datetime"] || "${dateString}"}\`);
dv.paragraph(\`â° **íŒŒì¼ ìˆ˜ì •**: \${thisFile.file.mtime.toFormat("yyyy-MM-dd HH:mm:ss")}\`);
\`\`\`

## âš¡ ë¹ ë¥¸ ì•¡ì…˜ ì„¼í„°

\`\`\`dataviewjs
const actionContainer = dv.container;

const actionStyles = \`
<style>
.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin: 20px 0;
}
.action-card {
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    font-family: inherit;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}
.action-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
}
.action-card-1 { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
.action-card-2 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
.action-card-3 { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
.action-card-4 { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); }
.action-title { font-weight: bold; font-size: 1rem; margin-bottom: 8px; color: #000; }
.action-desc { font-size: 0.8rem; opacity: 0.8; color: #000; }
</style>
\`;

const actionHtml = actionStyles + \`
<div class="action-grid">
    <button class="action-card action-card-1" data-action="new-question">
        <div class="action-title">â• ìƒˆ ë¬¸ì œ</div>
        <div class="action-desc">ë¬¸ì œ ì¶”ê°€</div>
    </button>
    <button class="action-card action-card-2" data-action="quiz">
        <div class="action-title">ğŸ¯ í€´ì¦ˆ</div>
        <div class="action-desc">í•™ìŠµ ì‹œì‘</div>
    </button>
    <button class="action-card action-card-3" data-action="refresh">
        <div class="action-title">ï¿½ ìƒˆë¡œê³ ì¹¨</div>
        <div class="action-desc">ì—…ë°ì´íŠ¸</div>
    </button>
    <button class="action-card action-card-4" data-action="statistics">
        <div class="action-title">ï¿½ğŸ“ˆ í†µê³„</div>
        <div class="action-desc">ë¶„ì„</div>
    </button>
</div>
\`;

actionContainer.innerHTML = actionHtml;

setTimeout(() => {
    const buttons = actionContainer.querySelectorAll('.action-card');
    buttons.forEach(button => {
        button.addEventListener('click', (e) => {
            const action = button.dataset.action;
            if (action === 'refresh' && app && app.commands) {
                app.commands.executeCommandById('dataview:dataview-force-refresh-views');
                if (window.Notice) new Notice('ğŸ”„ ìƒˆë¡œê³ ì¹¨!');
            } else if (action === 'new-question' && window.Notice) {
                new Notice('â• Ctrl+P â†’ ìƒˆ ë¬¸ì œ ë§Œë“¤ê¸°');
            } else if (action === 'quiz' && window.Notice) {
                new Notice('ğŸ¯ Ctrl+P â†’ í€´ì¦ˆ ì‹œì‘');
            } else if (action === 'statistics' && window.Notice) {
                new Notice('ğŸ“ˆ Ctrl+P â†’ í†µê³„ ë³´ê¸°');
            }
        });
    });
}, 100);
\`\`\`

---

## ğŸ“Š ${folderName} ì§„í–‰ë¥ 

\`\`\`dataviewjs
const folderPath = "${folder}";
const questions = dv.pages(\`"\${folderPath}"\`).where(p => 
    !p.file.name.includes("ë¬¸ì œëª©ë¡") && 
    !p.file.name.includes("ë¬¸ì œ ëŒ€ì‹œë³´ë“œ") && 
    !p.file.name.includes("ğŸ“Š")
);

const total = questions.length;
const bookmarked = questions.where(p => p.bookmarked === true).length;
const wrongAnswers = questions.where(p => p["wrong-count"] && p["wrong-count"] > 0).length;

// ë‚œì´ë„ë³„ í†µê³„
const difficultyStats = {
    "A+": questions.where(p => p.difficulty === "A+").length,
    "A": questions.where(p => p.difficulty === "A").length,
    "A-": questions.where(p => p.difficulty === "A-").length,
    "B": questions.where(p => p.difficulty === "B").length,
    "B-": questions.where(p => p.difficulty === "B-").length,
    "C": questions.where(p => p.difficulty === "C").length,
    "D": questions.where(p => p.difficulty === "D").length,
    "E": questions.where(p => p.difficulty === "E").length,
    "F": questions.where(p => p.difficulty === "F").length
};

// í‚¤ì›Œë“œë³„ í†µê³„
const keywordMap = new Map();
for (const q of questions) {
    const keywords = q.keywords || q.keyword || "";
    if (keywords) {
        const keywordList = keywords.toString().split(/[,ï¼Œã€]/).map(k => k.trim()).filter(k => k);
        for (const kw of keywordList) {
            keywordMap.set(kw, (keywordMap.get(kw) || 0) + 1);
        }
    }
}
const topKeywords = Array.from(keywordMap.entries())
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10);

if (total === 0) {
    dv.paragraph("### ğŸ“ ì•„ì§ ìƒì„±ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤");
    dv.paragraph("ğŸš€ ìƒˆ ë¬¸ì œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”!");
} else {
    let gradeEmoji = "";
    let gradeName = "";
    const completionRate = total > 0 ? Math.round(((total - wrongAnswers) / total) * 100) : 0;
    
    if (completionRate >= 95) { gradeEmoji = "ğŸ†"; gradeName = "ì „ì„¤"; }
    else if (completionRate >= 90) { gradeEmoji = "ğŸ¥‡"; gradeName = "S+"; }
    else if (completionRate >= 80) { gradeEmoji = "ğŸ¥ˆ"; gradeName = "S"; }
    else if (completionRate >= 70) { gradeEmoji = "ğŸ¥‰"; gradeName = "A"; }
    else if (completionRate >= 60) { gradeEmoji = "ğŸ“—"; gradeName = "B"; }
    else if (completionRate >= 50) { gradeEmoji = "ğŸ“˜"; gradeName = "C"; }
    else { gradeEmoji = "ğŸ“•"; gradeName = "D"; }
    
    dv.paragraph(\`### ğŸ¯ ì „ì²´ ì§„í–‰ë¥ \`);
    dv.paragraph(\`\${gradeEmoji} **í˜„ì¬ ë“±ê¸‰**: \${gradeName} | **ì •ë‹µë¥ **: \${completionRate}%\`);
    dv.paragraph(\`ğŸ“Š **ë¬¸ì œ í˜„í™©**: ì´ \${total}ê°œ | â­ ë¶ë§ˆí¬ \${bookmarked}ê°œ | âŒ ì˜¤ë‹µ \${wrongAnswers}ê°œ\`);
    
    const progressBar = "ğŸŸ©".repeat(Math.floor(completionRate/10)) + "â¬œ".repeat(10-Math.floor(completionRate/10));
    dv.paragraph(\`**ì§„í–‰ë°”**: \${progressBar} \${completionRate}%\`);
    
    dv.paragraph(\`<div style="width: 100%; background: #1e212b; border-radius: 10px; overflow: hidden; margin: 10px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">\`);
    dv.paragraph(\`<div style="width: \${completionRate}%; background: linear-gradient(90deg, #10b981, #34d399); height: 30px; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; transition: width 0.3s ease;">\${completionRate}%</div>\`);
    dv.paragraph(\`</div>\`);
    
    // ë‚œì´ë„ë³„ ë¶„í¬
    dv.paragraph(\`\`);
    dv.paragraph(\`### ğŸ“Š ë‚œì´ë„ë³„ ë¶„í¬\`);
    let diffHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin: 20px 0;">';
    if (difficultyStats["A+"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">ğŸ†</div><div style="font-size: 12px; color: #000; font-weight: bold;">A+</div><div style="font-size: 20px; color: #000; font-weight: bold;">\${difficultyStats["A+"]}</div></div>\`;
    if (difficultyStats["A"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">â­</div><div style="font-size: 12px; color: #000; font-weight: bold;">A</div><div style="font-size: 20px; color: #000; font-weight: bold;">\${difficultyStats["A"]}</div></div>\`;
    if (difficultyStats["A-"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">â­</div><div style="font-size: 12px; color: #000; font-weight: bold;">A-</div><div style="font-size: 20px; color: #000; font-weight: bold;">\${difficultyStats["A-"]}</div></div>\`;
    if (difficultyStats["B"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">ğŸ˜Š</div><div style="font-size: 12px; color: #fff; font-weight: bold;">B</div><div style="font-size: 20px; color: #fff; font-weight: bold;">\${difficultyStats["B"]}</div></div>\`;
    if (difficultyStats["B-"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">ğŸ˜Š</div><div style="font-size: 12px; color: #fff; font-weight: bold;">B-</div><div style="font-size: 20px; color: #fff; font-weight: bold;">\${difficultyStats["B-"]}</div></div>\`;
    if (difficultyStats["C"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #8b5cf6, #6d28d9); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">ğŸ˜</div><div style="font-size: 12px; color: #fff; font-weight: bold;">C</div><div style="font-size: 20px; color: #fff; font-weight: bold;">\${difficultyStats["C"]}</div></div>\`;
    if (difficultyStats["D"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">ğŸ˜°</div><div style="font-size: 12px; color: #000; font-weight: bold;">D</div><div style="font-size: 20px; color: #000; font-weight: bold;">\${difficultyStats["D"]}</div></div>\`;
    if (difficultyStats["E"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">ğŸ˜±</div><div style="font-size: 12px; color: #fff; font-weight: bold;">E</div><div style="font-size: 20px; color: #fff; font-weight: bold;">\${difficultyStats["E"]}</div></div>\`;
    if (difficultyStats["F"] > 0) diffHtml += \`<div style="padding: 15px; background: linear-gradient(135deg, #991b1b, #7f1d1d); border-radius: 10px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);"><div style="font-size: 24px;">ğŸ’€</div><div style="font-size: 12px; color: #fff; font-weight: bold;">F</div><div style="font-size: 20px; color: #fff; font-weight: bold;">\${difficultyStats["F"]}</div></div>\`;
    diffHtml += '</div>';
    dv.paragraph(diffHtml);
    
    // í‚¤ì›Œë“œë³„ ë¶„í¬
    if (topKeywords.length > 0) {
        dv.paragraph(\`\`);
        dv.paragraph(\`### ğŸ”‘ TOP 10 í‚¤ì›Œë“œ\`);
        let keywordHtml = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0;">';
        for (const [keyword, count] of topKeywords) {
            keywordHtml += \`<div style="padding: 12px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.2);"><div style="font-size: 14px; color: #fff; font-weight: bold; margin-bottom: 4px;">\${keyword}</div><div style="font-size: 18px; color: #fbbf24; font-weight: bold;">\${count}ê°œ</div></div>\`;
        }
        keywordHtml += '</div>';
        dv.paragraph(keywordHtml);
    }
}
\`\`\`

---

## ğŸ”¥ ìµœê·¼ ìˆ˜ì •ëœ ë¬¸ì œ (TOP 15)

\`\`\`dataviewjs
const folder = "${folder}";
const recent = dv.pages("\\"" + folder + "\\"")
    .where(p => !p.file.name.includes("ë¬¸ì œëª©ë¡") && 
                !p.file.name.includes("ë¬¸ì œ ëŒ€ì‹œë³´ë“œ") && 
                !p.file.name.includes("ğŸ“Š"))
    .sort(p => p.file.mtime, "desc")
    .limit(15);

if (recent.length > 0) {
    let html = '<div style="display: grid; gap: 10px; margin: 20px 0;">';
    
    for (const q of recent) {
        const diffIcon = q.difficulty === "A+" ? "ğŸ†" : 
                        q.difficulty === "A" || q.difficulty === "A-" ? "â­" : 
                        q.difficulty === "B" || q.difficulty === "B-" ? "ğŸ˜Š" : 
                        q.difficulty === "C" ? "ğŸ˜" : 
                        q.difficulty === "D" ? "ğŸ˜°" : 
                        q.difficulty === "E" ? "ğŸ˜±" : "ğŸ’€";
        
        const bookmark = q.bookmarked ? "â­" : "";
        const timeAgo = Math.floor((Date.now() - q.file.mtime.ts) / 60000);
        const timeStr = timeAgo < 1 ? "ë°©ê¸ˆ" : 
                       timeAgo < 60 ? timeAgo + "ë¶„ ì „" : 
                       timeAgo < 1440 ? Math.floor(timeAgo/60) + "ì‹œê°„ ì „" : 
                       Math.floor(timeAgo/1440) + "ì¼ ì „";
        
        const keywords = (q.keywords || q.keyword || "-").toString().substring(0, 20);
        const wrongCount = q["wrong-count"] || q.wrongCount || 0;
        const correctCount = q["correct-count"] || q.correctCount || 0;
        const statusBadge = wrongCount > 0 
            ? \`<span style="background: rgba(244,67,54,0.2); color: #f44336; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold;">âŒ \${wrongCount}</span>\`
            : correctCount > 0 
            ? \`<span style="background: rgba(76,175,80,0.2); color: #4caf50; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold;">âœ“ \${correctCount}</span>\`
            : \`<span style="color: var(--text-muted); font-size: 12px;">-</span>\`;
        
        const question = (q.question || "ì œëª© ì—†ìŒ").toString().substring(0, 60) + 
                        (q.question && q.question.length > 60 ? "..." : "");
        
        html += \`
        <a href="\${q.file.path}" style="display: block; padding: 16px; background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-primary-alt) 100%); border: 2px solid var(--background-modifier-border); border-left: 4px solid var(--interactive-accent); border-radius: 12px; text-decoration: none; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 24px;">\${diffIcon}</span>
                    <span style="font-size: 13px; color: var(--text-muted); font-weight: 600;">#\${q.number || "-"}</span>
                    <span style="font-size: 11px; color: var(--text-muted); padding: 4px 8px; background: var(--background-primary); border-radius: 6px;">ğŸ•’ \${timeStr}</span>
                </div>
                <div>\${statusBadge}</div>
            </div>
            <div style="font-size: 15px; font-weight: 500; color: var(--text-normal); margin-bottom: 8px; line-height: 1.4;">
                \${bookmark} \${question}
            </div>
            <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                <span style="font-size: 12px; padding: 4px 10px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; border-radius: 6px; font-weight: 500;">ğŸ”‘ \${keywords}</span>
                <span style="font-size: 12px; padding: 4px 10px; background: var(--background-primary); color: var(--text-muted); border-radius: 6px;">ğŸ“Š \${q.difficulty || "-"}</span>
            </div>
        </a>
        \`;
    }
    
    html += '</div>';
    dv.paragraph(html);
} else {
    dv.paragraph("<p style='text-align: center; padding: 60px 20px; color: var(--text-muted); background: var(--background-secondary); border-radius: 16px; font-size: 16px; margin: 25px 0; border: 2px dashed var(--background-modifier-border);'>ğŸ“ ì•„ì§ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>");
}
\`\`\`

---

## â­ ë¶ë§ˆí¬ ë¬¸ì œ

\`\`\`dataviewjs
const folder = "${folder}";
const bookmarked = dv.pages("\\"" + folder + "\\"")
    .where(p => !p.file.name.includes("ë¬¸ì œëª©ë¡") && 
                !p.file.name.includes("ë¬¸ì œ ëŒ€ì‹œë³´ë“œ") && 
                !p.file.name.includes("ğŸ“Š") && 
                p.bookmarked === true)
    .sort(p => p.file.mtime, "desc");

if (bookmarked.length > 0) {
    let html = '<div style="display: grid; gap: 10px; margin: 20px 0;">';
    
    for (const q of bookmarked) {
        const diffIcon = q.difficulty === "A+" ? "ğŸ†" : 
                        q.difficulty === "A" || q.difficulty === "A-" ? "â­" : 
                        q.difficulty === "B" || q.difficulty === "B-" ? "ğŸ˜Š" : 
                        q.difficulty === "C" ? "ğŸ˜" : 
                        q.difficulty === "D" ? "ğŸ˜°" : 
                        q.difficulty === "E" ? "ğŸ˜±" : "ğŸ’€";
        
        const keywords = (q.keywords || q.keyword || "-").toString().substring(0, 25);
        const wrongCount = q["wrong-count"] || q.wrongCount || 0;
        const question = (q.question || "ì œëª© ì—†ìŒ").toString().substring(0, 50) + 
                        (q.question && q.question.length > 50 ? "..." : "");
        
        const statusBadge = wrongCount > 0 
            ? \`<span style="background: rgba(244,67,54,0.2); color: #f44336; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold;">âŒ \${wrongCount}</span>\`
            : \`<span style="background: rgba(76,175,80,0.2); color: #4caf50; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold;">âœ…</span>\`;
        
        html += \`
        <a href="\${q.file.path}" style="display: flex; align-items: center; gap: 12px; padding: 14px; background: var(--background-secondary); border: 2px solid rgba(255, 215, 0, 0.3); border-left: 4px solid #ffd700; border-radius: 10px; text-decoration: none; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <div style="font-size: 28px; min-width: 35px; text-align: center;">\${diffIcon}</div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-size: 14px; font-weight: 500; color: var(--text-normal); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    â­ \${question}
                </div>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; align-items: center;">
                    <span style="font-size: 11px; padding: 3px 8px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; border-radius: 5px; font-weight: 500;">ğŸ”‘ \${keywords}</span>
                    <span style="font-size: 11px; padding: 3px 8px; background: var(--background-primary); color: var(--text-muted); border-radius: 5px;">#\${q.number || "-"}</span>
                </div>
            </div>
            <div style="min-width: 60px; text-align: right;">
                \${statusBadge}
            </div>
        </a>
        \`;
    }
    
    html += '</div>';
    dv.paragraph(html);
} else {
    dv.paragraph("<p style='text-align: center; padding: 60px 20px; color: var(--text-muted); background: var(--background-secondary); border-radius: 16px; font-size: 16px; margin: 25px 0; border: 2px dashed var(--background-modifier-border);'>â­ ë¶ë§ˆí¬í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>");
}
\`\`\`

---

## âŒ ì˜¤ë‹µ ë§ì€ ë¬¸ì œ TOP 10

\`\`\`dataviewjs
const folder = "${folder}";
const wrong = dv.pages("\\"" + folder + "\\"")
    .where(p => {
        const wrongCount = p["wrong-count"] || p.wrongCount || 0;
        return !p.file.name.includes("ë¬¸ì œëª©ë¡") && 
               !p.file.name.includes("ë¬¸ì œ ëŒ€ì‹œë³´ë“œ") && 
               !p.file.name.includes("ğŸ“Š") && 
               wrongCount > 0;
    })
    .sort(p => (p["wrong-count"] || p.wrongCount || 0), "desc")
    .limit(10);

if (wrong.length > 0) {
    const wrongData = [];
    
    for (const q of wrong) {
        const diffIcon = q.difficulty === "A+" ? "ğŸ†" : 
                        q.difficulty === "A" || q.difficulty === "A-" ? "â­" : 
                        q.difficulty === "B" || q.difficulty === "B-" ? "ï¿½" : 
                        q.difficulty === "C" ? "ğŸ˜" : 
                        q.difficulty === "D" ? "ğŸ˜°" : 
                        q.difficulty === "E" ? "ğŸ˜±" : "ğŸ’€";
        
        const keywords = q.keywords || q.keyword || "-";
        const wrongCount = q["wrong-count"] || q.wrongCount || 0;
        const correctCount = q["correct-count"] || q.correctCount || 0;
        const totalAttempts = wrongCount + correctCount;
        const accuracy = totalAttempts > 0 ? Math.round((correctCount / totalAttempts) * 100) : 0;
        
        wrongData.push([
            \`\${diffIcon} #\${q.number || "-"}\`,
            \`[[\${q.file.path}|\${q.question || "ì œëª© ì—†ìŒ"}\]]\`,
            keywords,
            q.difficulty || "-",
            \`âŒ \${wrongCount}íšŒ\`,
            \`âœ“ \${correctCount}íšŒ\`,
            \`\${accuracy}%\`
        ]);
    }
    
    dv.table(
        ["ìˆœì„œ", "ë¬¸ì œ", "í‚¤ì›Œë“œ", "ë‚œì´ë„", "ì˜¤ë‹µ", "ì •ë‹µ", "ì •ë‹µë¥ "],
        wrongData
    );
} else {
    dv.paragraph("<p style='text-align: center; padding: 60px 20px; color: var(--text-muted); background: var(--background-secondary); border-radius: 16px; font-size: 16px; margin: 25px 0; border: 2px dashed var(--background-modifier-border);'>âœ… ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!</p>");
}
\`\`\`

---

## ğŸ“ ì „ì²´ ë¬¸ì œ ëª©ë¡

\`\`\`dataviewjs
const folder = "${folder}";
const allQuestions = dv.pages("\\"" + folder + "\\"")
    .where(p => !p.file.name.includes("ë¬¸ì œëª©ë¡") && 
                !p.file.name.includes("ë¬¸ì œ ëŒ€ì‹œë³´ë“œ") && 
                !p.file.name.includes("ğŸ“Š"))
    .sort(p => p.number || 0, "asc");

if (allQuestions.length > 0) {
    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px; margin: 20px 0;">';
    
    for (const q of allQuestions) {
        const diffIcon = q.difficulty === "A+" ? "ğŸ†" : 
                        q.difficulty === "A" || q.difficulty === "A-" ? "â­" : 
                        q.difficulty === "B" || q.difficulty === "B-" ? "ğŸ˜Š" : 
                        q.difficulty === "C" ? "ğŸ˜" : 
                        q.difficulty === "D" ? "ğŸ˜°" : 
                        q.difficulty === "E" ? "ğŸ˜±" : "ğŸ’€";
        
        const bookmark = q.bookmarked ? "â­" : "";
        const keywords = (q.keywords || q.keyword || "-").toString().substring(0, 20);
        const wrongCount = q["wrong-count"] || q.wrongCount || 0;
        const question = (q.question || "ì œëª© ì—†ìŒ").toString().substring(0, 45) + 
                        (q.question && q.question.length > 45 ? "..." : "");
        
        const borderColor = wrongCount > 0 
            ? 'rgba(244, 67, 54, 0.5)' 
            : q.bookmarked 
            ? 'rgba(255, 215, 0, 0.5)' 
            : 'var(--background-modifier-border)';
        
        const statusIcon = wrongCount > 0 
            ? \`<span style="font-size: 11px; padding: 3px 6px; background: rgba(244,67,54,0.2); color: #f44336; border-radius: 4px; font-weight: bold;">âŒ\${wrongCount}</span>\`
            : \`<span style="font-size: 11px; padding: 3px 6px; background: rgba(76,175,80,0.2); color: #4caf50; border-radius: 4px; font-weight: bold;">âœ“</span>\`;
        
        html += \`
        <a href="\${q.file.path}" style="display: block; padding: 12px; background: var(--background-secondary); border: 2px solid \${borderColor}; border-radius: 10px; text-decoration: none; transition: all 0.2s; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 20px;">\${diffIcon}</span>
                    <span style="font-size: 12px; color: var(--text-muted); font-weight: 600;">#\${q.number || "-"}</span>
                </div>
                \${statusIcon}
            </div>
            <div style="font-size: 13px; font-weight: 500; color: var(--text-normal); margin-bottom: 8px; min-height: 36px; line-height: 1.3;">
                \${bookmark} \${question}
            </div>
            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                <span style="font-size: 10px; padding: 3px 6px; background: linear-gradient(135deg, #6366f1, #4f46e5); color: #fff; border-radius: 4px; font-weight: 500;">ğŸ”‘ \${keywords}</span>
                <span style="font-size: 10px; padding: 3px 6px; background: var(--background-primary); color: var(--text-muted); border-radius: 4px;">ğŸ“Š \${q.difficulty || "-"}</span>
            </div>
        </a>
        \`;
    }
    
    html += '</div>';
    dv.paragraph(html);
} else {
    dv.paragraph("<p style='text-align: center; padding: 60px 20px; color: var(--text-muted); background: var(--background-secondary); border-radius: 16px; font-size: 16px; margin: 25px 0; border: 2px dashed var(--background-modifier-border);'>ğŸ“ ì•„ì§ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>");
}
\`\`\`

---

*ğŸ“… ìƒì„±ì¼: ${dateString} | ğŸ”„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ | ğŸ“± ëª¨ë°”ì¼ ìµœì í™”*
`;
    }

    onunload() {
        console.log('Hanzi Quiz í”ŒëŸ¬ê·¸ì¸ ì–¸ë¡œë“œë¨');
    }
}
// í…ìŠ¤íŠ¸ ì…ë ¥ ëª¨ë‹¬
class TextInputModal extends Modal {
    constructor(app, title, placeholder, defaultValue, onSubmit) {
        super(app);
        this.title = title;
        this.placeholder = placeholder;
        this.defaultValue = defaultValue || '';
        this.onSubmit = onSubmit;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        contentEl.createEl('h2', { text: this.title });
        
        const inputDiv = contentEl.createDiv();
        inputDiv.style.cssText = 'margin: 20px 0;';
        
        const input = inputDiv.createEl('input', { 
            type: 'text', 
            placeholder: this.placeholder,
            value: this.defaultValue
        });
        input.style.cssText = 'width: 100%; padding: 10px; font-size: 1em; border: 1px solid var(--background-modifier-border); border-radius: 4px;';
        
        // Enter í‚¤ë¡œ ì œì¶œ
        input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const value = input.value.trim();
                if (value) {
                    this.onSubmit(value);
                    this.close();
                }
            }
        });
        
        const btnContainer = contentEl.createDiv();
        btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
        
        const submitBtn = btnContainer.createEl('button', { text: 'í™•ì¸' });
        submitBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer;';
        submitBtn.onclick = () => {
            const value = input.value.trim();
            if (value) {
                this.onSubmit(value);
                this.close();
            } else {
                new Notice('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”');
            }
        };
        
        const cancelBtn = btnContainer.createEl('button', { text: 'ì·¨ì†Œ' });
        cancelBtn.style.cssText = 'padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer;';
        cancelBtn.onclick = () => this.close();
        
        // ìë™ í¬ì»¤ìŠ¤
        setTimeout(() => input.focus(), 10);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// í™•ì¸ ëª¨ë‹¬ (Electron í™˜ê²½ì—ì„œ confirm() ëŒ€ì²´)
class ConfirmModal extends Modal {
    constructor(app, message, onConfirm) {
        super(app);
        this.message = message;
        this.onConfirm = onConfirm;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        contentEl.createEl('h2', { text: 'í™•ì¸' });
        
        const messageDiv = contentEl.createDiv();
        messageDiv.style.cssText = 'margin: 20px 0; white-space: pre-wrap;';
        messageDiv.textContent = this.message;
        
        const btnContainer = contentEl.createDiv();
        btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
        
        const confirmBtn = btnContainer.createEl('button', { text: 'í™•ì¸' });
        confirmBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer;';
        confirmBtn.onclick = () => {
            this.onConfirm(true);
            this.close();
        };
        
        const cancelBtn = btnContainer.createEl('button', { text: 'ì·¨ì†Œ' });
        cancelBtn.style.cssText = 'padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer;';
        cancelBtn.onclick = () => {
            this.onConfirm(false);
            this.close();
        };
        
        // ìë™ í¬ì»¤ìŠ¤ (í™•ì¸ ë²„íŠ¼)
        setTimeout(() => confirmBtn.focus(), 10);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// í€´ì¦ˆ ì •ë ¬ ì˜µì…˜ ëª¨ë‹¬
class QuizSortModal extends Modal {
    constructor(app, totalQuestions, onSelect) {
        super(app);
        this.totalQuestions = totalQuestions;
        this.onSelect = onSelect;
        this.selectedSort = 'random';
        this.selectedCount = totalQuestions;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        // ëª¨ë°”ì¼ ê°ì§€
        const isMobile = this.app.isMobile || window.innerWidth <= 768;
        
        const title = contentEl.createEl('h2', { text: 'âš™ï¸ í€´ì¦ˆ ì„¤ì •' });
        title.style.fontSize = isMobile ? '1.3em' : '1.5em';
        
        // ë¬¸ì œ ê°œìˆ˜ ì„ íƒ
        const countSection = contentEl.createDiv();
        countSection.style.cssText = `margin-bottom: ${isMobile ? '15px' : '20px'}; padding: ${isMobile ? '12px' : '15px'}; background: var(--background-secondary); border-radius: 8px;`;
        
        const countLabel = countSection.createEl('div', { text: 'ğŸ“ ë¬¸ì œ ê°œìˆ˜' });
        countLabel.style.cssText = `font-weight: bold; margin-bottom: 10px; font-size: ${isMobile ? '1em' : '1.1em'};`;
        
        const countDesc = countSection.createEl('div', { text: `ì „ì²´ ${this.totalQuestions}ê°œ ì¤‘ì—ì„œ í’€ ë¬¸ì œ ê°œìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”` });
        countDesc.style.cssText = `color: var(--text-muted); font-size: ${isMobile ? '0.85em' : '0.9em'}; margin-bottom: 10px;`;
        
        const countInputContainer = countSection.createDiv();
        countInputContainer.style.cssText = 'display: flex; gap: 10px; align-items: center;';
        
        const countInput = countInputContainer.createEl('input', { 
            type: 'number',
            value: this.totalQuestions.toString()
        });
        countInput.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '8px 12px'}; font-size: ${isMobile ? '16px' : '1em'}; border: 1px solid var(--background-modifier-border); border-radius: 6px; min-height: ${isMobile ? '44px' : 'auto'};`;
        countInput.min = '1';
        countInput.max = this.totalQuestions.toString();
        
        const allBtn = countInputContainer.createEl('button', { text: 'ì „ì²´' });
        allBtn.style.cssText = `padding: ${isMobile ? '12px 16px' : '8px 12px'}; background: var(--background-modifier-border); border: none; border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '44px' : 'auto'}; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
        allBtn.onclick = () => {
            countInput.value = this.totalQuestions.toString();
        };
        allBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            countInput.value = this.totalQuestions.toString();
        });
        
        // ì •ë ¬ ë°©ë²• ì„ íƒ
        const sortSection = contentEl.createDiv();
        sortSection.style.cssText = `margin-bottom: ${isMobile ? '15px' : '20px'};`;
        
        const sortLabel = sortSection.createEl('div', { text: 'ğŸ”¢ ë¬¸ì œ ìˆœì„œ' });
        sortLabel.style.cssText = `font-weight: bold; margin-bottom: 10px; font-size: ${isMobile ? '1em' : '1.1em'};`;
        
        const sortDesc = sortSection.createEl('div', { text: 'ë¬¸ì œë¥¼ ì–´ë–¤ ìˆœì„œë¡œ í’€ê¹Œìš”?' });
        sortDesc.style.cssText = `color: var(--text-muted); font-size: ${isMobile ? '0.85em' : '0.9em'}; margin-bottom: 10px;`;
        
        const optionsContainer = sortSection.createDiv();
        optionsContainer.style.cssText = `display: flex; flex-direction: column; gap: ${isMobile ? '10px' : '8px'};`;
        
        const sortOptions = [
            { id: 'random', icon: 'ğŸ²', text: 'ëœë¤ ìˆœì„œ' },
            { id: 'number-asc', icon: 'ğŸ”¢', text: 'ë²ˆí˜¸ ìˆœì„œ (ì˜¤ë¦„ì°¨ìˆœ)' },
            { id: 'number-desc', icon: 'ğŸ”½', text: 'ë²ˆí˜¸ ìˆœì„œ (ë‚´ë¦¼ì°¨ìˆœ)' },
            { id: 'wrong-desc', icon: 'âŒ', text: 'ì˜¤ë‹µ ë§ì€ ìˆœ' },
            { id: 'accuracy-asc', icon: 'ğŸ“‰', text: 'ì •ë‹µë¥  ë‚®ì€ ìˆœ' }
        ];
        
        sortOptions.forEach(option => {
            const btn = optionsContainer.createEl('button', { text: `${option.icon} ${option.text}` });
            btn.style.cssText = `padding: ${isMobile ? '14px 16px' : '10px 16px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; text-align: left; font-size: ${isMobile ? '1em' : '0.95em'}; min-height: ${isMobile ? '44px' : 'auto'}; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
            
            const selectOption = () => {
                this.selectedSort = option.id;
                // ëª¨ë“  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                optionsContainer.querySelectorAll('button').forEach(b => {
                    b.style.background = 'var(--background-secondary)';
                    b.style.borderColor = 'var(--background-modifier-border)';
                    b.style.color = '';
                });
                // ì„ íƒëœ ë²„íŠ¼ ê°•ì¡°
                btn.style.background = 'var(--interactive-accent)';
                btn.style.color = 'white';
                btn.style.borderColor = 'var(--interactive-accent)';
            };
            
            btn.onclick = selectOption;
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                selectOption();
            });
            
            // ì²« ë²ˆì§¸ ì˜µì…˜ ê¸°ë³¸ ì„ íƒ
            if (option.id === 'random') {
                btn.style.background = 'var(--interactive-accent)';
                btn.style.color = 'white';
                btn.style.borderColor = 'var(--interactive-accent)';
            }
        });
        
        // ì‹œì‘ ë²„íŠ¼
        const startBtn = contentEl.createEl('button', { text: 'ğŸš€ í€´ì¦ˆ ì‹œì‘' });
        startBtn.style.cssText = `width: 100%; padding: ${isMobile ? '14px 16px' : '12px 16px'}; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: ${isMobile ? '1.2em' : '1.1em'}; font-weight: bold; margin-bottom: 10px; min-height: ${isMobile ? '48px' : 'auto'}; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
        
        const startQuiz = () => {
            const count = parseInt(countInput.value);
            if (count < 1 || count > this.totalQuestions) {
                new Notice(`âš ï¸ 1ì—ì„œ ${this.totalQuestions} ì‚¬ì´ì˜ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”`);
                return;
            }
            this.selectedCount = count;
            this.onSelect(this.selectedSort, this.selectedCount);
            this.close();
        };
        
        startBtn.onclick = startQuiz;
        startBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            startQuiz();
        });
        
        const cancelBtn = contentEl.createEl('button', { text: 'ì·¨ì†Œ' });
        cancelBtn.style.cssText = `width: 100%; padding: ${isMobile ? '12px 16px' : '8px 16px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '44px' : 'auto'}; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
        cancelBtn.onclick = () => this.close();
        cancelBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.close();
        });
        
        // ëª¨ë°”ì¼ì—ì„œëŠ” í¬ì»¤ìŠ¤ ìë™ ì„¤ì •í•˜ì§€ ì•ŠìŒ (í‚¤ë³´ë“œê°€ ìë™ìœ¼ë¡œ ì˜¬ë¼ì˜¤ëŠ” ê²ƒ ë°©ì§€)
        if (!isMobile) {
            setTimeout(() => countInput.focus(), 10);
        }
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// QuizDashboardView í´ë˜ìŠ¤
class QuizDashboardView extends ItemView {
    constructor(leaf, plugin) {
        super(leaf);
        this.plugin = plugin;
        this.currentTab = 'quiz'; // 'quiz', 'daily', 'weekly', 'monthly'
        this.currentDate = new Date(); // í˜„ì¬ í‘œì‹œ ì¤‘ì¸ ë‚ ì§œ
        this.touchStartX = 0;
        this.touchStartY = 0;
    }

    getViewType() {
        return QUIZ_DASHBOARD_VIEW_TYPE;
    }

    getDisplayText() {
        return 'ğŸ“Š í•œì í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ';
    }

    getIcon() {
        return 'layout-dashboard';
    }

    // .md íŒŒì¼ê³¼ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë™ê¸°í™”
    async syncMd() {
        if (this.currentTab === 'quiz') return;
        
        const learningPlansFolder = 'Learning Plans';
        let fileName = '';
        let dateKey = '';
        
        try {
            if (this.currentTab === 'daily') {
                dateKey = this.getDateKey(this.currentDate);
                fileName = `${learningPlansFolder}/ì¼ë³„ëª©í‘œ_${dateKey}.md`;
                await this.syncDailyChecklist(fileName, dateKey);
            } else if (this.currentTab === 'weekly') {
                dateKey = this.getWeekKey(this.currentDate);
                fileName = `${learningPlansFolder}/ì£¼ê°„ëª©í‘œ_${dateKey}.md`;
                await this.syncWeeklyChecklist(fileName, dateKey);
            } else if (this.currentTab === 'monthly') {
                dateKey = this.getMonthKey(this.currentDate);
                fileName = `${learningPlansFolder}/ì›”ê°„ëª©í‘œ_${dateKey}.md`;
                await this.syncMonthlyChecklist(fileName, dateKey);
            }
        } catch (error) {
            console.error('ì²´í¬ë¦¬ìŠ¤íŠ¸ ë™ê¸°í™” ì˜¤ë¥˜:', error);
        }
    }

    async syncDailyChecklist(fileName, dateKey) {
        const file = this.app.vault.getAbstractFileByPath(fileName);
        if (!file) return;
        
        const content = await this.app.vault.read(file);
        const checklistData = this.plugin.settings.dailyChecklists?.[dateKey] || { items: [], notes: [] };
        
        // ë§ˆí¬ë‹¤ìš´ì—ì„œ ì²´í¬ë¦¬ìŠ¤íŠ¸ íŒŒì‹±
        const lines = content.split('\n');
        let inChecklistSection = false;
        let inNotesSection = false;
        const parsedItems = [];
        const parsedNotes = [];
        
        for (const line of lines) {
            if (line.includes('## âœ… ì˜¤ëŠ˜ì˜ ëª©í‘œ')) {
                inChecklistSection = true;
                inNotesSection = false;
                continue;
            } else if (line.includes('## ğŸ“ í•™ìŠµ ë…¸íŠ¸') || line.includes('## ğŸ“ ë©”ëª¨')) {
                inChecklistSection = false;
                inNotesSection = true;
                continue;
            } else if (line.startsWith('##')) {
                inChecklistSection = false;
                inNotesSection = false;
                continue;
            }
            
            if (inChecklistSection && line.trim().startsWith('- [')) {
                const completed = line.includes('[x]') || line.includes('[X]');
                const text = line.replace(/^- \[[xX ]\]\s*/, '').trim();
                if (text) {
                    parsedItems.push({ text, completed, timestamp: Date.now() });
                }
            } else if (inNotesSection && line.trim() && !line.startsWith('#')) {
                parsedNotes.push(line.trim());
            }
        }
        
        // íŒŒì¼ì˜ ë‚´ìš©ì„ ì„¤ì •ì— ë°˜ì˜
        if (parsedItems.length > 0 || parsedNotes.length > 0) {
            if (!this.plugin.settings.dailyChecklists) {
                this.plugin.settings.dailyChecklists = {};
            }
            this.plugin.settings.dailyChecklists[dateKey] = {
                items: parsedItems.length > 0 ? parsedItems : checklistData.items,
                notes: parsedNotes.length > 0 ? parsedNotes : checklistData.notes
            };
            await this.plugin.saveSettings();
        }
    }

    async syncWeeklyChecklist(fileName, weekKey) {
        const file = this.app.vault.getAbstractFileByPath(fileName);
        if (!file) return;
        
        const content = await this.app.vault.read(file);
        const checklistData = this.plugin.settings.weeklyChecklists?.[weekKey] || { items: [], notes: [] };
        
        const lines = content.split('\n');
        let inChecklistSection = false;
        let inNotesSection = false;
        const parsedItems = [];
        const parsedNotes = [];
        
        for (const line of lines) {
            if (line.includes('## âœ… ì´ë²ˆ ì£¼ ëª©í‘œ')) {
                inChecklistSection = true;
                inNotesSection = false;
                continue;
            } else if (line.includes('## ğŸ“') || line.includes('## ğŸ“Š ì§„í–‰ ìƒí™©')) {
                inChecklistSection = false;
                inNotesSection = true;
                continue;
            } else if (line.startsWith('##')) {
                inChecklistSection = false;
                inNotesSection = false;
                continue;
            }
            
            if (inChecklistSection && line.trim().startsWith('- [')) {
                const completed = line.includes('[x]') || line.includes('[X]');
                const text = line.replace(/^- \[[xX ]\]\s*/, '').trim();
                if (text) {
                    parsedItems.push({ text, completed, timestamp: Date.now() });
                }
            } else if (inNotesSection && line.trim() && !line.startsWith('#')) {
                parsedNotes.push(line.trim());
            }
        }
        
        if (parsedItems.length > 0 || parsedNotes.length > 0) {
            if (!this.plugin.settings.weeklyChecklists) {
                this.plugin.settings.weeklyChecklists = {};
            }
            this.plugin.settings.weeklyChecklists[weekKey] = {
                items: parsedItems.length > 0 ? parsedItems : checklistData.items,
                notes: parsedNotes.length > 0 ? parsedNotes : checklistData.notes
            };
            await this.plugin.saveSettings();
        }
    }

    async syncMonthlyChecklist(fileName, monthKey) {
        const file = this.app.vault.getAbstractFileByPath(fileName);
        if (!file) return;
        
        const content = await this.app.vault.read(file);
        const checklistData = this.plugin.settings.monthlyChecklists?.[monthKey] || { items: [], notes: [] };
        
        const lines = content.split('\n');
        let inChecklistSection = false;
        let inNotesSection = false;
        const parsedItems = [];
        const parsedNotes = [];
        
        for (const line of lines) {
            if (line.includes('## âœ… ì´ë²ˆ ë‹¬ ëª©í‘œ')) {
                inChecklistSection = true;
                inNotesSection = false;
                continue;
            } else if (line.includes('## ğŸ“') || line.includes('## ğŸ“ˆ ì„±ê³¼ ë¶„ì„')) {
                inChecklistSection = false;
                inNotesSection = true;
                continue;
            } else if (line.startsWith('##')) {
                inChecklistSection = false;
                inNotesSection = false;
                continue;
            }
            
            if (inChecklistSection && line.trim().startsWith('- [')) {
                const completed = line.includes('[x]') || line.includes('[X]');
                const text = line.replace(/^- \[[xX ]\]\s*/, '').trim();
                if (text) {
                    parsedItems.push({ text, completed, timestamp: Date.now() });
                }
            } else if (inNotesSection && line.trim() && !line.startsWith('#')) {
                parsedNotes.push(line.trim());
            }
        }
        
        if (parsedItems.length > 0 || parsedNotes.length > 0) {
            if (!this.plugin.settings.monthlyChecklists) {
                this.plugin.settings.monthlyChecklists = {};
            }
            this.plugin.settings.monthlyChecklists[monthKey] = {
                items: parsedItems.length > 0 ? parsedItems : checklistData.items,
                notes: parsedNotes.length > 0 ? parsedNotes : checklistData.notes
            };
            await this.plugin.saveSettings();
        }
    }

    async saveChecklistToFile(type, dateKey) {
        const learningPlansFolder = 'Learning Plans';
        let fileName = '';
        let checklistData = null;
        
        if (type === 'daily') {
            fileName = `${learningPlansFolder}/ì¼ë³„ëª©í‘œ_${dateKey}.md`;
            checklistData = this.plugin.settings.dailyChecklists?.[dateKey];
        } else if (type === 'weekly') {
            fileName = `${learningPlansFolder}/ì£¼ê°„ëª©í‘œ_${dateKey}.md`;
            checklistData = this.plugin.settings.weeklyChecklists?.[dateKey];
        } else if (type === 'monthly') {
            fileName = `${learningPlansFolder}/ì›”ê°„ëª©í‘œ_${dateKey}.md`;
            checklistData = this.plugin.settings.monthlyChecklists?.[dateKey];
        }
        
        if (!checklistData) return;
        
        const file = this.app.vault.getAbstractFileByPath(fileName);
        if (!file) return;
        
        let content = await this.app.vault.read(file);
        const lines = content.split('\n');
        const newLines = [];
        let inChecklistSection = false;
        let skipUntilNextSection = false;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            
            // ì„¹ì…˜ í—¤ë” ê°ì§€
            if (line.startsWith('##')) {
                inChecklistSection = false;
                skipUntilNextSection = false;
                
                // ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ ì‹œì‘
                if ((type === 'daily' && line.includes('## âœ… ì˜¤ëŠ˜ì˜ ëª©í‘œ')) ||
                    (type === 'weekly' && line.includes('## âœ… ì´ë²ˆ ì£¼ ëª©í‘œ')) ||
                    (type === 'monthly' && line.includes('## âœ… ì´ë²ˆ ë‹¬ ëª©í‘œ'))) {
                    newLines.push(line);
                    newLines.push('');
                    
                    // ì²´í¬ë¦¬ìŠ¤íŠ¸ í•­ëª© ì‚½ì…
                    if (checklistData.items && checklistData.items.length > 0) {
                        checklistData.items.forEach(item => {
                            newLines.push(`- [${item.completed ? 'x' : ' '}] ${item.text}`);
                        });
                    }
                    
                    newLines.push('');
                    inChecklistSection = true;
                    skipUntilNextSection = true;
                    continue;
                }
                // ë©”ëª¨/ë…¸íŠ¸ ì„¹ì…˜ ì‹œì‘
                else if (line.includes('## ğŸ“') || line.includes('í•™ìŠµ ë…¸íŠ¸') || line.includes('ë©”ëª¨')) {
                    newLines.push(line);
                    newLines.push('');
                    
                    // ë©”ëª¨ ë‚´ìš© ì‚½ì…
                    if (checklistData.notes && checklistData.notes.length > 0) {
                        checklistData.notes.forEach(note => {
                            newLines.push(note);
                        });
                    }
                    
                    newLines.push('');
                    skipUntilNextSection = true;
                    continue;
                }
                // ë‹¤ë¥¸ ì„¹ì…˜ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
                else {
                    newLines.push(line);
                    continue;
                }
            }
            
            // ì²´í¬ë¦¬ìŠ¤íŠ¸ë‚˜ ë©”ëª¨ ì„¹ì…˜ ë‚´ìš©ì€ ê±´ë„ˆë›°ê¸° (ì´ë¯¸ ìœ„ì—ì„œ ì‚½ì…í•¨)
            if (skipUntilNextSection) {
                continue;
            }
            
            // ë‚˜ë¨¸ì§€ ì¤„ì€ ê·¸ëŒ€ë¡œ ë³´ì¡´
            newLines.push(line);
        }
        
        await this.app.vault.modify(file, newLines.join('\n'));
    }

    async onOpen() {
        const container = this.containerEl.children[1];
        container.empty();
        container.addClass('quiz-dashboard-container');
        
        // .md íŒŒì¼ê³¼ ë™ê¸°í™”
        if (typeof this.syncMd === 'function') {
            await this.syncMd();
        }

        await this.renderDashboard(container);
    }

    async renderDashboard(container) {
        // í—¤ë”
        const header = container.createDiv({ cls: 'quiz-dashboard-header' });
        header.style.cssText = 'padding: 16px; background: var(--background-secondary); border-bottom: 1px solid var(--background-modifier-border);';
        
        header.createEl('h2', { text: 'ğŸ“Š í•œì í€´ì¦ˆ í•™ìŠµ í”Œë˜ë„ˆ' }).style.cssText = 'margin: 0 0 12px 0;';
        
        // ìƒë‹¨ í•œì¤„ ë©”ëª¨
        const quickMemoDiv = header.createDiv();
        quickMemoDiv.style.cssText = 'margin-bottom: 12px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; gap: 8px;';
        
        const memoIcon = quickMemoDiv.createEl('span', { text: 'ğŸ“' });
        memoIcon.style.cssText = 'font-size: 1.2em;';
        
        if (!this.plugin.settings.dashboardQuickMemo) {
            this.plugin.settings.dashboardQuickMemo = '';
        }
        
        const quickMemoInput = quickMemoDiv.createEl('input', { 
            type: 'text', 
            placeholder: 'ì˜¤ëŠ˜ì˜ í•œì¤„ ë©”ëª¨...',
            value: this.plugin.settings.dashboardQuickMemo || ''
        });
        quickMemoInput.style.cssText = 'flex: 1; padding: 8px 12px; border: none; border-radius: 4px; background: rgba(255,255,255,0.9); font-size: 14px; color: #333;';
        quickMemoInput.onchange = () => {
            this.plugin.settings.dashboardQuickMemo = quickMemoInput.value;
            this.plugin.saveSettings();
        };
        
        // íƒ­ ë„¤ë¹„ê²Œì´ì…˜
        const tabNav = header.createDiv({ cls: 'quiz-tab-nav' });
        tabNav.style.cssText = 'display: flex; gap: 8px; flex-wrap: nowrap; overflow-x: auto; position: fixed; top: 0; left: 0; width: 100vw; z-index: 100; background: var(--background-secondary); border-bottom: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 8px 0 8px 0;';
        if (header && header.parentElement) header.parentElement.style.paddingTop = '60px';
        
        const createTab = (text, tabId) => {
            const tab = tabNav.createEl('button', { text, cls: 'quiz-tab-btn' });
            if (this.currentTab === tabId) tab.addClass('active');
            tab.style.cssText = `
                padding: 8px 16px;
                background: ${this.currentTab === tabId ? 'var(--interactive-accent)' : 'var(--background-primary)'};
                color: ${this.currentTab === tabId ? 'var(--text-on-accent)' : 'var(--text-normal)'};
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
                transition: all 0.2s;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                min-height: 44px;
            `;
            const handler = () => {
                this.currentTab = tabId;
                this.onOpen();
            };
            tab.onclick = handler;
            tab.addEventListener('touchend', (e) => {
                e.preventDefault();
                handler();
            });
        };
        
        createTab('ğŸ“ í€´ì¦ˆ í’€ê¸°', 'quiz');
        createTab('ğŸ“… ì¼ë³„ ëª©í‘œ', 'daily');
        createTab('ğŸ“† ì£¼ê°„ ëª©í‘œ', 'weekly');
        createTab('ğŸ“Š ì›”ê°„ ëª©í‘œ', 'monthly');
        
        const headerButtons = header.createDiv({ cls: 'quiz-dashboard-header-buttons' });
        headerButtons.style.cssText = 'display: flex; gap: 8px; flex-wrap: wrap;';
        
        const recentBtn = headerButtons.createEl('button', { 
            text: 'ğŸ“‹ í•™ìŠµí”Œëœ',
            cls: 'quiz-dashboard-btn'
        });
        recentBtn.style.cssText = 'padding: 6px 12px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const recentHandler = async () => {
            const learningPlansFolder = 'Learning Plans';
            const allFiles = this.app.vault.getMarkdownFiles();
            const files = allFiles.filter(f => f.path.startsWith(learningPlansFolder));
            
            if (files.length === 0) {
                new Notice('í•™ìŠµí”Œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. "ëª©í‘œ íŒŒì¼" ë²„íŠ¼ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.');
                return;
            }
            
            const modal = new Modal(this.app);
            modal.titleEl.setText('ğŸ“‹ í•™ìŠµí”Œëœ ëª©ë¡');
            
            const { contentEl } = modal;
            contentEl.style.cssText = 'padding: 20px; max-height: 500px; overflow-y: auto;';
            
            files.sort((a, b) => b.stat.mtime - a.stat.mtime).forEach(file => {
                const fileBtn = contentEl.createEl('button', { text: `${file.basename}` });
                fileBtn.style.cssText = 'display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: var(--interactive-normal); border: 1px solid var(--background-modifier-border); border-radius: 8px; cursor: pointer; text-align: left; transition: background 0.2s;';
                fileBtn.addEventListener('mouseenter', () => {
                    fileBtn.style.background = 'var(--interactive-hover)';
                });
                fileBtn.addEventListener('mouseleave', () => {
                    fileBtn.style.background = 'var(--interactive-normal)';
                });
                fileBtn.addEventListener('click', async () => {
                    const leaf = this.app.workspace.getLeaf(false);
                    await leaf.openFile(file);
                    modal.close();
                });
            });
            
            modal.open();
        };
        recentBtn.addEventListener('click', recentHandler);
        recentBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            recentHandler();
        });
        
        const openFileBtn = headerButtons.createEl('button', { 
            text: 'ğŸ“„ ëª©í‘œ íŒŒì¼',
            cls: 'quiz-dashboard-btn'
        });
        openFileBtn.style.cssText = 'padding: 6px 12px; background: #764ba2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const openFileHandler = async () => {
            if (this.currentTab === 'quiz') {
                new Notice('í€´ì¦ˆ íƒ­ì—ì„œëŠ” ëª©í‘œ íŒŒì¼ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const learningPlansFolder = 'Learning Plans';
            
            try {
                // Learning Plans í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
                const folder = this.app.vault.getAbstractFileByPath(learningPlansFolder);
                if (!folder) {
                    await this.app.vault.createFolder(learningPlansFolder);
                }
                
                // currentDateê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                if (!this.currentDate) {
                    this.currentDate = new Date();
                }
                
                let fileName = '';
                let fileContent = '';
                
                if (this.currentTab === 'daily') {
                    const dateKey = this.getDateKey(this.currentDate);
                    fileName = `${learningPlansFolder}/ì¼ë³„ëª©í‘œ_${dateKey}.md`;
                    fileContent = `---\ndate: ${dateKey}\ntype: daily\n---\n\n# ğŸ“… ì¼ë³„ ëª©í‘œ (${dateKey})\n\n## âœ… ì˜¤ëŠ˜ì˜ ëª©í‘œ\n\n- [ ] \n\n## ğŸ“ í•™ìŠµ ë…¸íŠ¸\n\n\n## ğŸ¯ ì™„ë£Œ ì‚¬í•­\n\n`;
                } else if (this.currentTab === 'weekly') {
                    const weekKey = this.getWeekKey(this.currentDate);
                    fileName = `${learningPlansFolder}/ì£¼ê°„ëª©í‘œ_${weekKey}.md`;
                    fileContent = `---\nweek: ${weekKey}\ntype: weekly\n---\n\n# ğŸ“† ì£¼ê°„ ëª©í‘œ (${weekKey})\n\n## âœ… ì´ë²ˆ ì£¼ ëª©í‘œ\n\n- [ ] \n\n## ğŸ“Š ì§„í–‰ ìƒí™©\n\n\n## ğŸ¯ ì™„ë£Œ ì‚¬í•­\n\n`;
                } else if (this.currentTab === 'monthly') {
                    const monthKey = this.getMonthKey(this.currentDate);
                    fileName = `${learningPlansFolder}/ì›”ê°„ëª©í‘œ_${monthKey}.md`;
                    fileContent = `---\nmonth: ${monthKey}\ntype: monthly\n---\n\n# ğŸ“Š ì›”ê°„ ëª©í‘œ (${monthKey})\n\n## âœ… ì´ë²ˆ ë‹¬ ëª©í‘œ\n\n- [ ] \n\n## ğŸ“ˆ ì„±ê³¼ ë¶„ì„\n\n\n## ğŸ¯ ì™„ë£Œ ì‚¬í•­\n\n`;
                }
                
                // íŒŒì¼ ì°¾ê¸° ë˜ëŠ” ìƒì„±
                let file = this.app.vault.getAbstractFileByPath(fileName);
                
                if (!file) {
                    // íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
                    file = await this.app.vault.create(fileName, fileContent);
                    new Notice(`ëª©í‘œ íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`);
                } else {
                    new Notice(`ê¸°ì¡´ ëª©í‘œ íŒŒì¼ì„ ì—½ë‹ˆë‹¤: ${fileName}`);
                }
                
                // íŒŒì¼ ì—´ê¸°
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(file);
                
            } catch (error) {
                console.error('ëª©í‘œ íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜:', error);
                new Notice(`íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜: ${error.message}`);
            }
        };
        openFileBtn.addEventListener('click', openFileHandler);
        openFileBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            openFileHandler();
        });
        
        const refreshBtn = headerButtons.createEl('button', { 
            text: 'ğŸ”„ ìƒˆë¡œê³ ì¹¨',
            cls: 'quiz-dashboard-btn'
        });
        refreshBtn.style.cssText = 'padding: 6px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;';
        refreshBtn.addEventListener('click', () => this.onOpen());

        // Git ì„¤ì • ë²„íŠ¼
        const gitBtn = headerButtons.createEl('button', { 
            text: 'ğŸ”§ Git',
            cls: 'quiz-dashboard-btn'
        });
        gitBtn.style.cssText = 'padding: 6px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 8px; font-weight: 600; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);';
        gitBtn.addEventListener('click', () => {
            new GitSettingsModal(this.app, this.plugin).open();
        });
        gitBtn.addEventListener('mouseenter', () => {
            gitBtn.style.transform = 'translateY(-2px)';
            gitBtn.style.boxShadow = '0 4px 8px rgba(102, 126, 234, 0.4)';
        });
        gitBtn.addEventListener('mouseleave', () => {
            gitBtn.style.transform = 'translateY(0)';
            gitBtn.style.boxShadow = '0 2px 4px rgba(102, 126, 234, 0.3)';
        });

        // ëª©í‘œ ìš”ì•½ ì„¹ì…˜ (ëª¨ë“  íƒ­ì—ì„œ í‘œì‹œ)
        await this.renderGoalsSummary(container);

        // íƒ­ë³„ ì½˜í…ì¸  ë Œë”ë§
        if (this.currentTab === 'quiz') {
            await this.renderQuizTab(container);
        } else if (this.currentTab === 'daily') {
            await this.renderDailyTab(container);
        } else if (this.currentTab === 'weekly') {
            await this.renderWeeklyTab(container);
        } else if (this.currentTab === 'monthly') {
            await this.renderMonthlyTab(container);
        }
    }

    async renderGoalsSummary(container) {
        const summarySection = container.createDiv({ cls: 'quiz-goals-summary' });
        summarySection.style.cssText = 'background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-primary) 100%); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--background-modifier-border);';
        
        const summaryGrid = summarySection.createDiv();
        summaryGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;';
        
        // ì£¼ê°„ ëª©í‘œ ë°•ìŠ¤
        const weekKey = this.getWeekKey(new Date());
        const weeklyData = this.plugin.settings.weeklyChecklists?.[weekKey];
        
        const weeklyBox = summaryGrid.createDiv();
        weeklyBox.style.cssText = 'background: var(--background-primary); padding: 12px; border-radius: 8px; border: 2px solid #3b82f6; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;';
        weeklyBox.addEventListener('mouseenter', () => {
            weeklyBox.style.transform = 'translateY(-2px)';
            weeklyBox.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)';
        });
        weeklyBox.addEventListener('mouseleave', () => {
            weeklyBox.style.transform = 'translateY(0)';
            weeklyBox.style.boxShadow = 'none';
        });
        weeklyBox.onclick = () => {
            this.currentTab = 'weekly';
            this.onOpen();
        };
        
        const weeklyTitle = weeklyBox.createEl('div', { text: 'ğŸ¯ ì£¼ê°„ ëª©í‘œ' });
        weeklyTitle.style.cssText = 'font-weight: bold; margin-bottom: 8px; color: #3b82f6; font-size: 1.05em;';
        
        // ë©”ëª¨ í‘œì‹œ
        if (weeklyData && weeklyData.notes && weeklyData.notes.length > 0) {
            const notesDiv = weeklyBox.createDiv();
            notesDiv.style.cssText = 'margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--background-modifier-border);';
            weeklyData.notes.slice(0, 2).forEach(note => {
                const noteItem = notesDiv.createDiv();
                noteItem.style.cssText = 'font-size: 0.85em; color: #1e40af; font-style: italic; margin-bottom: 4px;';
                noteItem.textContent = `ğŸ“ ${note.substring(0, 30)}${note.length > 30 ? '...' : ''}`;
            });
        }
        
        if (weeklyData && weeklyData.items && weeklyData.items.length > 0) {
            const completed = weeklyData.items.filter(item => item.completed).length;
            const total = weeklyData.items.length;
            const percent = Math.round((completed / total) * 100);
            
            const progress = weeklyBox.createEl('div', { text: `${completed}/${total} ì™„ë£Œ (${percent}%)` });
            progress.style.cssText = 'font-size: 0.95em; color: #3b82f6; font-weight: 500; margin-bottom: 6px;';
            
            const progressBar = weeklyBox.createDiv();
            progressBar.style.cssText = 'background: var(--background-modifier-border); height: 6px; border-radius: 3px; overflow: hidden;';
            const progressFill = progressBar.createDiv();
            progressFill.style.cssText = `background: #3b82f6; width: ${percent}%; height: 100%; transition: width 0.3s;`;
        } else {
            const emptyText = weeklyBox.createEl('div', { text: 'í´ë¦­í•˜ì—¬ ëª©í‘œ ì¶”ê°€' });
            emptyText.style.cssText = 'color: var(--text-muted); font-size: 0.9em;';
        }
        
        // ì›”ê°„ ëª©í‘œ ë°•ìŠ¤
        const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
        const monthlyData = this.plugin.settings.monthlyChecklists?.[monthKey];
        
        const monthlyBox = summaryGrid.createDiv();
        monthlyBox.style.cssText = 'background: var(--background-primary); padding: 12px; border-radius: 8px; border: 2px solid #10b981; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;';
        monthlyBox.addEventListener('mouseenter', () => {
            monthlyBox.style.transform = 'translateY(-2px)';
            monthlyBox.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
        });
        monthlyBox.addEventListener('mouseleave', () => {
            monthlyBox.style.transform = 'translateY(0)';
            monthlyBox.style.boxShadow = 'none';
        });
        monthlyBox.onclick = () => {
            this.currentTab = 'monthly';
            this.onOpen();
        };
        
        const monthlyTitle = monthlyBox.createEl('div', { text: 'ğŸ“‹ ì›”ê°„ ëª©í‘œ' });
        monthlyTitle.style.cssText = 'font-weight: bold; margin-bottom: 8px; color: #10b981; font-size: 1.05em;';
        
        // ë©”ëª¨ í‘œì‹œ
        if (monthlyData && monthlyData.notes && monthlyData.notes.length > 0) {
            const notesDiv = monthlyBox.createDiv();
            notesDiv.style.cssText = 'margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--background-modifier-border);';
            monthlyData.notes.slice(0, 2).forEach(note => {
                const noteItem = notesDiv.createDiv();
                noteItem.style.cssText = 'font-size: 0.85em; color: #047857; font-style: italic; margin-bottom: 4px;';
                noteItem.textContent = `ğŸ“ ${note.substring(0, 30)}${note.length > 30 ? '...' : ''}`;
            });
        }
        
        if (monthlyData && monthlyData.items && monthlyData.items.length > 0) {
            const completed = monthlyData.items.filter(item => item.completed).length;
            const total = monthlyData.items.length;
            const percent = Math.round((completed / total) * 100);
            
            const progress = monthlyBox.createEl('div', { text: `${completed}/${total} ì™„ë£Œ (${percent}%)` });
            progress.style.cssText = 'font-size: 0.95em; color: #10b981; font-weight: 500; margin-bottom: 6px;';
            
            const progressBar = monthlyBox.createDiv();
            progressBar.style.cssText = 'background: var(--background-modifier-border); height: 6px; border-radius: 3px; overflow: hidden;';
            const progressFill = progressBar.createDiv();
            progressFill.style.cssText = `background: #10b981; width: ${percent}%; height: 100%; transition: width 0.3s;`;
        } else {
            const emptyText = monthlyBox.createEl('div', { text: 'í´ë¦­í•˜ì—¬ ëª©í‘œ ì¶”ê°€' });
            emptyText.style.cssText = 'color: var(--text-muted); font-size: 0.9em;';
        }
    }

    async renderQuizTab(container) {
        // ìˆ˜ì • ìƒì„¸ê¸°ë¡ ë²„íŠ¼ ì„¹ì…˜
        await this.renderEditHistoryButton(container);

        // í´ë”ë³„ í€´ì¦ˆ ì„¹ì…˜
        await this.renderFolderQuizzes(container);
    }

    async renderEditHistoryButton(container) {
        const section = container.createDiv({ cls: 'quiz-edit-history-section' });
        section.style.cssText = 'padding: 16px; margin-bottom: 16px; display: flex; justify-content: center; gap: 12px;';
        
        const historyBtn = section.createEl('button', { text: 'ğŸ“ í€´ì¦ˆ ìˆ˜ì • ìƒì„¸ê¸°ë¡' });
        historyBtn.style.cssText = 'padding: 14px 28px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        
        historyBtn.addEventListener('mouseenter', () => {
            historyBtn.style.transform = 'translateY(-2px)';
            historyBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        });
        historyBtn.addEventListener('mouseleave', () => {
            historyBtn.style.transform = 'translateY(0)';
            historyBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        });
        
        historyBtn.addEventListener('click', () => {
            new EditHistoryModal(this.app, this.plugin).open();
        });
        
        const reorderBtn = section.createEl('button', { text: 'ğŸ”€ í´ë” ìˆœì„œ' });
        reorderBtn.style.cssText = 'padding: 14px 28px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: 600; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        
        reorderBtn.addEventListener('mouseenter', () => {
            reorderBtn.style.transform = 'translateY(-2px)';
            reorderBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.4)';
        });
        reorderBtn.addEventListener('mouseleave', () => {
            reorderBtn.style.transform = 'translateY(0)';
            reorderBtn.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        });
        
        reorderBtn.addEventListener('click', () => {
            new FolderReorderModal(this.app, this.plugin).open();
        });
    }

    async renderFolderQuizzes(container) {
        const section = container.createDiv({ cls: 'quiz-folder-section' });
        section.style.cssText = 'padding: 16px;';
        
        const headerDiv = section.createDiv();
        headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
        
        headerDiv.createEl('h3', { text: 'ğŸ“ í´ë”ë³„ í€´ì¦ˆ' }).style.cssText = 'margin: 0;';
        
        const allQuestions = await this.plugin.loadAllQuestions();
        const folderMap = new Map();
        
        // í´ë”ë³„ë¡œ ë¬¸ì œ ê·¸ë£¹í™”
        allQuestions.forEach(q => {
            const folder = q.folder || 'ê¸°ë³¸';
            if (!folderMap.has(folder)) {
                folderMap.set(folder, []);
            }
            folderMap.get(folder).push(q);
        });
        
        // ë¶ë§ˆí¬ í´ë”ë³„ë¡œ ê·¸ë£¹í™” (ìƒˆë¡œìš´ bookmarkFolder ë°©ì‹)
        const bookmarkFolderName = this.plugin.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬';
        const bookmarksByFolder = new Map();
        allQuestions.forEach(q => {
            if (q.bookmarkFolder && q.bookmarkFolder.length > 0) {
                const key = `${bookmarkFolderName}/${q.bookmarkFolder}`;
                if (!bookmarksByFolder.has(key)) {
                    bookmarksByFolder.set(key, []);
                }
                bookmarksByFolder.get(key).push(q);
            }
        });
        
        // ë¶ë§ˆí¬ í´ë”ë“¤ì„ folderMapì— ì¶”ê°€
        bookmarksByFolder.forEach((questions, folderKey) => {
            folderMap.set(folderKey, questions);
        });
        
        const folderGrid = section.createDiv();
        folderGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;';
        
        // í´ë” ìˆœì„œ ì €ì¥
        if (!this.plugin.settings.folderOrder) {
            this.plugin.settings.folderOrder = Array.from(folderMap.keys());
        }
        
        // ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ ì •ë ¬
        const orderedFolders = this.plugin.settings.folderOrder.filter(f => folderMap.has(f));
        const newFolders = Array.from(folderMap.keys()).filter(f => !orderedFolders.includes(f));
        const sortedFolders = [...orderedFolders, ...newFolders];
        
        // í´ë” ì¹´ë“œ ë Œë”ë§
        sortedFolders.forEach((folderName, folderIdx) => {
            const questions = folderMap.get(folderName);
            const card = folderGrid.createDiv({ cls: 'quiz-folder-card' });
            card.style.cssText = 'padding: 16px; background: var(--background-primary-alt); border: 1px solid var(--background-modifier-border); border-radius: 8px; transition: all 0.2s; position: relative; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
            
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'translateY(-4px)';
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'translateY(0)';
                card.style.boxShadow = 'none';
            });
            
            const cardHeader = card.createDiv();
            cardHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
            
            const titleDiv = cardHeader.createDiv();
            titleDiv.style.cssText = 'display: flex; align-items: center; gap: 8px;';
            titleDiv.createEl('h4', { text: folderName }).style.cssText = 'margin: 0; font-size: 1.1em;';
            
            const rightDiv = cardHeader.createDiv();
            rightDiv.style.cssText = 'display: flex; align-items: center; gap: 8px;';
            
            // ë¶ë§ˆí¬ í´ë”ì¸ì§€ ì¼ë°˜ í´ë”ì¸ì§€ í™•ì¸
            const isBookmarkFolder = folderName.startsWith(bookmarkFolderName + '/');
            
            // ë©”ë‰´ ë²„íŠ¼ (ì¼ë°˜ í´ë”ë§Œ)
            if (!isBookmarkFolder && !folderName.startsWith('â­')) {
                const menuBtn = rightDiv.createEl('button', { text: 'â‹®' });
                menuBtn.style.cssText = 'background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 4px 8px; color: var(--text-muted); min-width: 32px; min-height: 32px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const menu = new Menu(this.app);
                    
                    // ì´ë¦„ ë°”ê¾¸ê¸°
                    menu.addItem((item) => {
                        item.setTitle('ğŸ“ ì´ë¦„ ë°”ê¾¸ê¸°')
                            .setIcon('pencil')
                            .onClick(async () => {
                                // Modalì„ ì‚¬ìš©í•˜ì—¬ ìƒˆ í´ë”ëª… ì…ë ¥ë°›ê¸°
                                const inputModal = new Modal(this.app);
                                inputModal.titleEl.setText('í´ë”ëª… ë³€ê²½');
                                inputModal.contentEl.style.cssText = 'padding: 20px;';
                                
                                const label = inputModal.contentEl.createEl('label');
                                label.style.cssText = 'display: block; margin-bottom: 10px; font-weight: 500;';
                                label.textContent = `ìƒˆ í´ë”ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:`;
                                
                                const input = inputModal.contentEl.createEl('input');
                                input.style.cssText = 'width: 100%; padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; font-size: 1em; margin-bottom: 16px;';
                                input.type = 'text';
                                input.value = folderName;
                                input.placeholder = 'ìƒˆ í´ë”ëª…';
                                
                                const buttonDiv = inputModal.contentEl.createDiv();
                                buttonDiv.style.cssText = 'display: flex; gap: 10px;';
                                
                                const cancelBtn = buttonDiv.createEl('button', { text: 'ì·¨ì†Œ' });
                                cancelBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; min-height: 44px;';
                                cancelBtn.onclick = () => inputModal.close();
                                
                                const confirmBtn = buttonDiv.createEl('button', { text: 'ë³€ê²½' });
                                confirmBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: 500; min-height: 44px;';
                                confirmBtn.onclick = async () => {
                                    const newName = input.value.trim();
                                    if (newName && newName !== folderName) {
                                        // í´ë” ì´ë¦„ ë³€ê²½
                                        const oldFolderPath = `${this.plugin.settings.questionsFolder}/${folderName}`;
                                        const newFolderPath = `${this.plugin.settings.questionsFolder}/${newName}`;
                                        
                                        try {
                                            const oldFolder = this.app.vault.getAbstractFileByPath(oldFolderPath);
                                            if (oldFolder) {
                                                await this.app.vault.rename(oldFolder, newFolderPath);
                                                
                                                // ëª¨ë“  ë¬¸ì œì˜ folder í•„ë“œ ì—…ë°ì´íŠ¸
                                                const allQuestions = await this.plugin.loadAllQuestions();
                                                for (const q of allQuestions) {
                                                    if ((q.folder || 'ê¸°ë³¸') === folderName) {
                                                        q.folder = newName;
                                                        await this.plugin.saveQuestion(q, false);
                                                    }
                                                }
                                                
                                                new Notice(`âœ… í´ë”ëª… ë³€ê²½ë¨: ${folderName} â†’ ${newName}`);
                                                this.onOpen();
                                            }
                                        } catch (e) {
                                            new Notice(`âŒ í´ë”ëª… ë³€ê²½ ì‹¤íŒ¨: ${e.message}`);
                                        }
                                        inputModal.close();
                                    } else if (newName === folderName) {
                                        new Notice('âš ï¸ ë™ì¼í•œ í´ë”ëª…ì…ë‹ˆë‹¤');
                                    } else {
                                        new Notice('âš ï¸ í´ë”ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
                                    }
                                };
                                
                                // Enter í‚¤ë¡œë„ í™•ì¸ ê°€ëŠ¥
                                input.addEventListener('keydown', (e) => {
                                    if (e.key === 'Enter') {
                                        confirmBtn.click();
                                    } else if (e.key === 'Escape') {
                                        inputModal.close();
                                    }
                                });
                                
                                inputModal.open();
                                input.focus();
                                input.select();
                            });
                    });
                    
                    // í´ë” ì‚­ì œ
                    menu.addItem((item) => {
                        item.setTitle('ğŸ—‘ï¸ í´ë” ì‚­ì œ')
                            .setIcon('trash')
                            .onClick(async () => {
                                // Modalì„ ì‚¬ìš©í•˜ì—¬ ì‚­ì œ í™•ì¸
                                const confirmModal = new Modal(this.app);
                                confirmModal.titleEl.setText('âš ï¸ í´ë” ì‚­ì œ');
                                confirmModal.contentEl.style.cssText = 'padding: 20px;';
                                
                                confirmModal.contentEl.createEl('p').innerHTML = `ì •ë§ <strong>"${folderName}"</strong> í´ë”ë¥¼ ì‚­ì œí• ê¹Œìš”?<br><span style="color: var(--text-muted); font-size: 0.9em;">í´ë” ë‚´ì˜ ëª¨ë“  ë¬¸ì œë„ ì‚­ì œë©ë‹ˆë‹¤</span>`;
                                
                                const buttonDiv = confirmModal.contentEl.createDiv();
                                buttonDiv.style.cssText = 'display: flex; gap: 10px; margin-top: 20px;';
                                
                                const cancelBtn = buttonDiv.createEl('button', { text: 'ì·¨ì†Œ' });
                                cancelBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; min-height: 44px;';
                                cancelBtn.onclick = () => confirmModal.close();
                                
                                const deleteBtn = buttonDiv.createEl('button', { text: 'ì‚­ì œ' });
                                deleteBtn.style.cssText = 'flex: 1; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; min-height: 44px;';
                                deleteBtn.onclick = async () => {
                                    const folderPath = `${this.plugin.settings.questionsFolder}/${folderName}`;
                                    try {
                                        const folderToDelete = this.app.vault.getAbstractFileByPath(folderPath);
                                        if (folderToDelete) {
                                            await this.app.vault.delete(folderToDelete, true);
                                            new Notice(`âœ… í´ë” ì‚­ì œë¨: ${folderName}`);
                                            this.onOpen();
                                        }
                                    } catch (e) {
                                        new Notice(`âŒ í´ë” ì‚­ì œ ì‹¤íŒ¨: ${e.message}`);
                                    }
                                    confirmModal.close();
                                };
                                
                                confirmModal.open();
                            });
                    });
                    
                    menu.showAtMouseEvent(e);
                });
            }
            
            // ìˆœì„œ ì¡°ì • ë²„íŠ¼
            const orderBtns = rightDiv.createDiv();
            orderBtns.style.cssText = 'display: flex; gap: 4px;';
            
            if (folderIdx > 0) {
                const upBtn = orderBtns.createEl('button', { text: 'â–²' });
                upBtn.style.cssText = 'background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; padding: 4px 8px; font-size: 0.9em; min-height: 32px; min-width: 32px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
                upBtn.onclick = (e) => {
                    e.stopPropagation();
                    const temp = sortedFolders[folderIdx];
                    sortedFolders[folderIdx] = sortedFolders[folderIdx - 1];
                    sortedFolders[folderIdx - 1] = temp;
                    this.plugin.settings.folderOrder = sortedFolders;
                    this.plugin.saveSettings();
                    this.onOpen();
                };
            }
            
            if (folderIdx < sortedFolders.length - 1) {
                const downBtn = orderBtns.createEl('button', { text: 'â–¼' });
                downBtn.style.cssText = 'background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; padding: 4px 8px; font-size: 0.9em; min-height: 32px; min-width: 32px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
                downBtn.onclick = (e) => {
                    e.stopPropagation();
                    const temp = sortedFolders[folderIdx];
                    sortedFolders[folderIdx] = sortedFolders[folderIdx + 1];
                    sortedFolders[folderIdx + 1] = temp;
                    this.plugin.settings.folderOrder = sortedFolders;
                    this.plugin.saveSettings();
                    this.onOpen();
                };
            }
            
            rightDiv.createEl('span', { text: `${questions.length}ë¬¸ì œ` }).style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
            
            // í´ë” í†µê³„
            const folderStats = this.plugin.settings.stats.studyHistory?.filter(h => h.folderName === folderName || h.folder === folderName) || [];
            const folderAttempts = folderStats.reduce((sum, s) => sum + (s.total || 0), 0);
            const folderCorrect = folderStats.reduce((sum, s) => sum + (s.correct || 0), 0);
            const folderAccuracy = folderAttempts > 0 ? Math.round((folderCorrect / folderAttempts) * 100) : 0;
            
            if (folderAttempts > 0) {
                const statsDiv = card.createDiv();
                statsDiv.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; padding: 10px; background: var(--background-secondary); border-radius: 6px;';
                
                const statItem = (label, value) => {
                    const item = statsDiv.createDiv();
                    item.style.cssText = 'text-align: center;';
                    item.createEl('div', { text: value }).style.cssText = 'font-size: 1.1em; font-weight: bold; color: var(--interactive-accent);';
                    item.createEl('div', { text: label }).style.cssText = 'font-size: 0.75em; color: var(--text-muted); margin-top: 2px;';
                };
                
                statItem('ì‹œë„', `${folderAttempts}íšŒ`);
                statItem('ì •ë‹µ', `${folderCorrect}ê°œ`);
                statItem('ì •ë‹µë¥ ', `${folderAccuracy}%`);
            }
            
            const btnGroup = card.createDiv();
            btnGroup.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;';
            
            // 1. ìƒˆë¬¸ì œ - ë¬¸ì œ ë§Œë“¤ê¸°
            const newQuestionsBtn = btnGroup.createEl('button', { text: 'âœ¨ ìƒˆë¬¸ì œ' });
            newQuestionsBtn.style.cssText = 'padding: 10px; background: #10b981; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
            newQuestionsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const modal = new HanziQuestionModal(this.app, this.plugin);
                modal.question.folder = folderName;
                modal.open();
            });
            newQuestionsBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const modal = new HanziQuestionModal(this.app, this.plugin);
                modal.question.folder = folderName;
                modal.open();
            });
            
            // 2. í€´ì¦ˆ - í€´ì¦ˆ í’€ê¸°
            const quizBtn = btnGroup.createEl('button', { text: 'ğŸ¯ í€´ì¦ˆ' });
            quizBtn.style.cssText = 'padding: 10px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; font-weight: 500; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
            
            quizBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (isBookmarkFolder) {
                    // ë¶ë§ˆí¬ í´ë”: ì§ì ‘ ì‹œì‘
                    await this.plugin.startQuiz(null, false, folderName);
                } else {
                    // ì¼ë°˜ í´ë”: ë¶ë§ˆí¬ ì„ íƒ ì˜µì…˜
                    const folderQuestionsOnly = questions.filter(q => (q.folder || 'ê¸°ë³¸') === folderName);
                    
                    // ë¶ë§ˆí¬ í´ë”ë³„ ì„ íƒ ëª¨ë‹¬
                    const bookmarksByFolder = {};
                    for (const q of folderQuestionsOnly) {
                        if (q.bookmarkFolder) {
                            if (!bookmarksByFolder[q.bookmarkFolder]) {
                                bookmarksByFolder[q.bookmarkFolder] = [];
                            }
                            bookmarksByFolder[q.bookmarkFolder].push(q);
                        }
                    }

                    // ë¶ë§ˆí¬ê°€ ìˆìœ¼ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                    if (Object.keys(bookmarksByFolder).length > 0) {
                        const modal = new Modal(this.app);
                        modal.titleEl.setText(`ğŸ“ ${folderName} - í€´ì¦ˆ ì˜µì…˜`);
                        modal.contentEl.style.cssText = 'padding: 20px;';
                        
                        // ì „ì²´ ë¬¸ì œ ë²„íŠ¼
                        const allBtn = modal.contentEl.createEl('button', { text: `ğŸ“ ${folderName} ì „ì²´ ë¬¸ì œë¡œ ì‹œì‘` });
                        allBtn.style.cssText = `display: block; width: 100%; padding: 14px 16px; margin-bottom: 12px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: 2px solid #1e40af; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);`;
                        allBtn.addEventListener('mouseenter', () => { allBtn.style.transform = 'translateY(-3px)'; allBtn.style.boxShadow = '0 8px 20px rgba(59, 130, 246, 0.5)'; });
                        allBtn.addEventListener('mouseleave', () => { allBtn.style.transform = 'translateY(0)'; allBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)'; });
                        allBtn.addEventListener('click', async () => {
                            modal.close();
                            await this.plugin.startQuiz(null, false, folderName);
                        });

                        const divider = modal.contentEl.createEl('div');
                        divider.style.cssText = 'margin: 16px 0; border-top: 2px solid var(--background-modifier-border);';
                        
                        const subTitle = modal.contentEl.createEl('div', { text: 'â­ ë¶ë§ˆí¬ í´ë” ì„ íƒ' });
                        subTitle.style.cssText = 'font-size: 1.1em; font-weight: 600; margin: 12px 0 12px 0; color: var(--text-accent);';

                        const bookmarkGrid = modal.contentEl.createDiv();
                        bookmarkGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';
                        
                        for (const [bmFolder, bmQuestions] of Object.entries(bookmarksByFolder)) {
                            const bmBtn = bookmarkGrid.createEl('button', { text: `â­ ${bmFolder}\n(${bmQuestions.length}ë¬¸ì œ)` });
                            bmBtn.style.cssText = `padding: 14px 12px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; border: 2px solid #FF8C00; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3); text-align: center; line-height: 1.3;`;
                            bmBtn.addEventListener('mouseenter', () => { bmBtn.style.transform = 'translateY(-4px)'; bmBtn.style.boxShadow = '0 8px 20px rgba(255, 165, 0, 0.5)'; });
                            bmBtn.addEventListener('mouseleave', () => { bmBtn.style.transform = 'translateY(0)'; bmBtn.style.boxShadow = '0 4px 12px rgba(255, 165, 0, 0.3)'; });
                            bmBtn.addEventListener('click', async () => {
                                modal.close();
                                await this.plugin.startQuiz(null, false, `${folderName}-with-bookmark-${bmFolder}`);
                            });
                        }

                        modal.open();
                    } else {
                        // ë¶ë§ˆí¬ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹œì‘
                        await this.plugin.startQuiz(null, false, folderName);
                    }
                }
            });
            quizBtn.addEventListener('touchend', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (isBookmarkFolder) {
                    // ë¶ë§ˆí¬ í´ë”: ì§ì ‘ ì‹œì‘
                    await this.plugin.startQuiz(null, false, folderName);
                } else {
                    // ì¼ë°˜ í´ë”: ë¶ë§ˆí¬ ì„ íƒ ì˜µì…˜
                    const folderQuestionsOnly = questions.filter(q => (q.folder || 'ê¸°ë³¸') === folderName);
                    
                    // ë¶ë§ˆí¬ í´ë”ë³„ ì„ íƒ ëª¨ë‹¬
                    const bookmarksByFolder = {};
                    for (const q of folderQuestionsOnly) {
                        if (q.bookmarkFolder) {
                            if (!bookmarksByFolder[q.bookmarkFolder]) {
                                bookmarksByFolder[q.bookmarkFolder] = [];
                            }
                            bookmarksByFolder[q.bookmarkFolder].push(q);
                        }
                    }

                    // ë¶ë§ˆí¬ê°€ ìˆìœ¼ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                    if (Object.keys(bookmarksByFolder).length > 0) {
                        const modal = new Modal(this.app);
                        modal.titleEl.setText(`ğŸ“ ${folderName} - í€´ì¦ˆ ì˜µì…˜`);
                        modal.contentEl.style.cssText = 'padding: 20px;';
                        
                        // ì „ì²´ ë¬¸ì œ ë²„íŠ¼
                        const allBtn = modal.contentEl.createEl('button', { text: `ğŸ“ ${folderName} ì „ì²´ ë¬¸ì œë¡œ ì‹œì‘` });
                        allBtn.style.cssText = `display: block; width: 100%; padding: 14px 16px; margin-bottom: 12px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; border: 2px solid #1e40af; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1em; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);`;
                        allBtn.addEventListener('mouseenter', () => { allBtn.style.transform = 'translateY(-3px)'; allBtn.style.boxShadow = '0 8px 20px rgba(59, 130, 246, 0.5)'; });
                        allBtn.addEventListener('mouseleave', () => { allBtn.style.transform = 'translateY(0)'; allBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.3)'; });
                        allBtn.addEventListener('click', async () => {
                            modal.close();
                            await this.plugin.startQuiz(null, false, folderName);
                        });

                        const divider = modal.contentEl.createEl('div');
                        divider.style.cssText = 'margin: 16px 0; border-top: 2px solid var(--background-modifier-border);';
                        
                        const subTitle = modal.contentEl.createEl('div', { text: 'â­ ë¶ë§ˆí¬ í´ë” ì„ íƒ' });
                        subTitle.style.cssText = 'font-size: 1.1em; font-weight: 600; margin: 12px 0 12px 0; color: var(--text-accent);';

                        const bookmarkGrid = modal.contentEl.createDiv();
                        bookmarkGrid.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 10px;';
                        
                        for (const [bmFolder, bmQuestions] of Object.entries(bookmarksByFolder)) {
                            const bmBtn = bookmarkGrid.createEl('button', { text: `â­ ${bmFolder}\n(${bmQuestions.length}ë¬¸ì œ)` });
                            bmBtn.style.cssText = `padding: 14px 12px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; border: 2px solid #FF8C00; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9em; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3); text-align: center; line-height: 1.3;`;
                            bmBtn.addEventListener('mouseenter', () => { bmBtn.style.transform = 'translateY(-4px)'; bmBtn.style.boxShadow = '0 8px 20px rgba(255, 165, 0, 0.5)'; });
                            bmBtn.addEventListener('mouseleave', () => { bmBtn.style.transform = 'translateY(0)'; bmBtn.style.boxShadow = '0 4px 12px rgba(255, 165, 0, 0.3)'; });
                            bmBtn.addEventListener('click', async () => {
                                modal.close();
                                await this.plugin.startQuiz(null, false, `${folderName}-with-bookmark-${bmFolder}`);
                            });
                        }

                        modal.open();
                    } else {
                        // ë¶ë§ˆí¬ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹œì‘
                        await this.plugin.startQuiz(null, false, folderName);
                    }
                }
            });
            
            // ë‘ ë²ˆì§¸ ë²„íŠ¼ ê·¸ë£¹
            const btnGroup2 = card.createDiv();
            btnGroup2.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';
            
            // 3. í¸ì§‘ - ë¬¸ì œ í¸ì§‘ (í´ë”ì˜ ë¬¸ì œ ëª©ë¡ í‘œì‹œ)
            const editBtn = btnGroup2.createEl('button', { text: 'âœï¸ í¸ì§‘' });
            editBtn.style.cssText = 'padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                new QuestionListModal(this.app, this.plugin, folderName).open();
            });
            editBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                new QuestionListModal(this.app, this.plugin, folderName).open();
            });
            
            // 4. ìƒì„¸ê¸°ë¡ - í•´ë‹¹ í´ë”ì˜ ìµœê·¼ í•™ìŠµ ê¸°ë¡
            const detailHistoryBtn = btnGroup2.createEl('button', { text: 'ğŸ“Š ìƒì„¸ê¸°ë¡' });
            detailHistoryBtn.style.cssText = 'padding: 10px; background: #8b5cf6; color: white; border: none; border-radius: 4px; font-weight: 500; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
            detailHistoryBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                console.log('ğŸ“Š ìƒì„¸ê¸°ë¡ ë²„íŠ¼ í´ë¦­:', folderName);
                new FolderHistoryModal(this.app, this.plugin, folderName).open();
            });
            detailHistoryBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                e.stopPropagation();
                console.log('ğŸ“Š ìƒì„¸ê¸°ë¡ ë²„íŠ¼ í„°ì¹˜:', folderName);
                new FolderHistoryModal(this.app, this.plugin, folderName).open();
            });
            
            // 3ë²ˆì§¸ ë²„íŠ¼ ê·¸ë£¹ - ë¶ë§ˆí¬ í´ë” ê´€ë¦¬
            if (!isBookmarkFolder && !folderName.startsWith('â­')) {
                const btnGroup3 = card.createDiv();
                btnGroup3.style.cssText = 'display: grid; grid-template-columns: 1fr; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--background-modifier-border);';
                
                // ë¶ë§ˆí¬ í´ë” ì„¤ì •/ê´€ë¦¬ ë²„íŠ¼
                const bookmarkManageBtn = btnGroup3.createEl('button', { text: 'â­ ë¶ë§ˆí¬ í´ë” ì„¤ì •' });
                bookmarkManageBtn.style.cssText = 'padding: 10px; background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; border: 2px solid #FF8C00; border-radius: 6px; font-weight: 600; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px; transition: all 0.3s ease;';
                bookmarkManageBtn.addEventListener('mouseenter', () => {
                    bookmarkManageBtn.style.transform = 'translateY(-2px)';
                    bookmarkManageBtn.style.boxShadow = '0 6px 16px rgba(255, 165, 0, 0.4)';
                });
                bookmarkManageBtn.addEventListener('mouseleave', () => {
                    bookmarkManageBtn.style.transform = 'translateY(0)';
                    bookmarkManageBtn.style.boxShadow = 'none';
                });
                
                bookmarkManageBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    
                    // ë¶ë§ˆí¬ í´ë” ì„¤ì • ëª¨ë‹¬
                    const bmModal = new Modal(this.app);
                    bmModal.titleEl.setText(`â­ ${folderName} - ë¶ë§ˆí¬ í´ë” ì„¤ì •`);
                    bmModal.contentEl.style.cssText = 'padding: 20px; max-width: 600px;';
                    
                    // ì„¤ëª…
                    const desc = bmModal.contentEl.createEl('p');
                    desc.innerHTML = `<strong>${folderName}</strong> í´ë”ì˜ ë¶ë§ˆí¬ ì„¤ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”`;
                    desc.style.cssText = 'margin-bottom: 20px; font-size: 0.95em; color: var(--text-normal); font-weight: 500;';
                    
                    // í˜„ì¬ ì„¤ì • í‘œì‹œ
                    const folderBookmarkSettings = this.plugin.settings.folderBookmarkSettings || {};
                    const currentSetting = folderBookmarkSettings[folderName] || '';
                    
                    if (currentSetting) {
                        const currentInfo = bmModal.contentEl.createEl('div');
                        currentInfo.style.cssText = 'padding: 10px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%); border-left: 4px solid #10b981; border-radius: 4px; margin-bottom: 16px;';
                        currentInfo.innerHTML = `<strong>í˜„ì¬ ì„¤ì •:</strong> "${currentSetting}"`;
                    }
                    
                    // ì„¹ì…˜: ë¶ë§ˆí¬ í´ë” ì„¤ì •
                    const settingSection = bmModal.contentEl.createEl('div');
                    settingSection.style.cssText = 'margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--background-modifier-border);';
                    
                    const settingTitle = settingSection.createEl('h4', { text: 'ğŸ“ ë¶ë§ˆí¬ í´ë” ë³€ê²½' });
                    settingTitle.style.cssText = 'margin: 0 0 10px 0; font-size: 0.95em; color: var(--text-accent);';
                    
                    // ë“œë¡­ë‹¤ìš´ + ì…ë ¥ í•„ë“œ
                    const inputGroup = settingSection.createDiv();
                    inputGroup.style.cssText = 'display: flex; gap: 8px; margin-bottom: 10px;';
                    
                    // ê¸°ì¡´ í´ë” ì„ íƒ ë“œë¡­ë‹¤ìš´
                    const select = inputGroup.createEl('select');
                    select.style.cssText = 'flex: 1; padding: 8px; border: 2px solid var(--background-modifier-border); border-radius: 6px; font-size: 0.95em; background: var(--background-secondary); color: var(--text-normal);';
                    
                    const emptyOption = select.createEl('option');
                    emptyOption.value = '';
                    emptyOption.textContent = 'í´ë” ì„ íƒ ë˜ëŠ” ì§ì ‘ ì…ë ¥';
                    
                    // ê¸°ì¡´ í´ë”ë“¤ í‘œì‹œ
                    const allQuestions = await this.plugin.loadAllQuestions();
                    const folders = new Set();
                    allQuestions.forEach(q => {
                        if (q.folder) folders.add(q.folder);
                        else folders.add('ê¸°ë³¸');
                    });
                    
                    Array.from(folders).sort().forEach(folder => {
                        const option = select.createEl('option');
                        option.value = folder;
                        option.textContent = `ğŸ“ ${folder}`;
                    });
                    
                    // ì…ë ¥ í•„ë“œ
                    const input = inputGroup.createEl('input');
                    input.type = 'text';
                    input.placeholder = 'ìƒˆ ì´ë¦„ ë˜ëŠ” ì„ íƒ';
                    input.value = currentSetting || folderName;
                    input.style.cssText = 'flex: 1.5; padding: 8px; border: 2px solid var(--background-modifier-border); border-radius: 6px; font-size: 0.95em;';
                    
                    // ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ ì…ë ¥ í•„ë“œì— ì ìš©
                    select.addEventListener('change', () => {
                        if (select.value) {
                            input.value = select.value;
                        }
                    });
                    
                    // ì„¹ì…˜: ë¶ë§ˆí¬ ê´€ë¦¬
                    const manageSection = bmModal.contentEl.createEl('div');
                    manageSection.style.cssText = 'margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--background-modifier-border);';
                    
                    const manageTitle = manageSection.createEl('h4', { text: 'ğŸ”§ ë¶ë§ˆí¬ ê´€ë¦¬' });
                    manageTitle.style.cssText = 'margin: 0 0 10px 0; font-size: 0.95em; color: var(--text-accent);';
                    
                    const manageBtnDiv = manageSection.createDiv();
                    manageBtnDiv.style.cssText = 'display: flex; gap: 8px;';
                    
                    // ì´ˆê¸°í™” ë²„íŠ¼
                    const resetBtn = manageBtnDiv.createEl('button', { text: 'ğŸ”„ ì´ˆê¸°í™”' });
                    resetBtn.style.cssText = 'flex: 1; padding: 10px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-height: 44px; transition: all 0.3s;';
                    resetBtn.addEventListener('mouseenter', () => { resetBtn.style.transform = 'translateY(-2px)'; resetBtn.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.3)'; });
                    resetBtn.addEventListener('mouseleave', () => { resetBtn.style.transform = 'translateY(0)'; resetBtn.style.boxShadow = 'none'; });
                    
                    resetBtn.addEventListener('click', async () => {
                        const confirmReset = confirm(`"${folderName}" í´ë”ì˜ ëª¨ë“  ë¶ë§ˆí¬ë¥¼ ì œê±°í• ê¹Œìš”?`);
                        if (confirmReset) {
                            let resetCount = 0;
                            for (const q of allQuestions) {
                                if ((q.folder || 'ê¸°ë³¸') === folderName && q.bookmarkFolder) {
                                    q.bookmarkFolder = '';
                                    await this.plugin.saveQuestion(q, false);
                                    resetCount++;
                                }
                            }
                            await this.plugin.updateBookmarkListTemplate();
                            new Notice(`âœ… ${resetCount}ê°œ ë¶ë§ˆí¬ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`);
                            bmModal.close();
                            this.onOpen();
                        }
                    });
                    
                    // ì‚­ì œ ë²„íŠ¼
                    const deleteBtn = manageBtnDiv.createEl('button', { text: 'âŒ ì„¤ì • ì‚­ì œ' });
                    deleteBtn.style.cssText = 'flex: 1; padding: 10px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-height: 44px; transition: all 0.3s;';
                    deleteBtn.addEventListener('mouseenter', () => { deleteBtn.style.transform = 'translateY(-2px)'; deleteBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.3)'; });
                    deleteBtn.addEventListener('mouseleave', () => { deleteBtn.style.transform = 'translateY(0)'; deleteBtn.style.boxShadow = 'none'; });
                    
                    deleteBtn.addEventListener('click', async () => {
                        const confirmDelete = confirm(`"${folderName}" í´ë”ì˜ ë¶ë§ˆí¬ ì„¤ì •ì„ ì‚­ì œí• ê¹Œìš”?`);
                        if (confirmDelete) {
                            if (this.plugin.settings.folderBookmarkSettings) {
                                delete this.plugin.settings.folderBookmarkSettings[folderName];
                                await this.plugin.saveSettings();
                                new Notice(`âœ… ë¶ë§ˆí¬ ì„¤ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
                                bmModal.close();
                                this.onOpen();
                            }
                        }
                    });
                    
                    // ë²„íŠ¼ ê·¸ë£¹
                    const btnDiv = bmModal.contentEl.createDiv();
                    btnDiv.style.cssText = 'display: flex; gap: 10px; margin-top: 20px;';
                    
                    const cancelBtn = btnDiv.createEl('button', { text: 'ì·¨ì†Œ' });
                    cancelBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-weight: 500; min-height: 44px; transition: all 0.2s;';
                    cancelBtn.addEventListener('click', () => bmModal.close());
                    cancelBtn.addEventListener('mouseenter', () => cancelBtn.style.opacity = '0.8');
                    cancelBtn.addEventListener('mouseleave', () => cancelBtn.style.opacity = '1');
                    
                    const confirmBtn = btnDiv.createEl('button', { text: 'âœ… ì ìš©' });
                    confirmBtn.style.cssText = 'flex: 1; padding: 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; min-height: 44px; transition: all 0.3s;';
                    confirmBtn.addEventListener('mouseenter', () => { confirmBtn.style.transform = 'translateY(-2px)'; confirmBtn.style.boxShadow = '0 6px 16px rgba(16, 185, 129, 0.4)'; });
                    confirmBtn.addEventListener('mouseleave', () => { confirmBtn.style.transform = 'translateY(0)'; confirmBtn.style.boxShadow = 'none'; });
                    
                    confirmBtn.addEventListener('click', async () => {
                        const bookmarkFolderName = input.value.trim();
                        if (!bookmarkFolderName) {
                            new Notice('âš ï¸ ë¶ë§ˆí¬ í´ë”ëª…ì„ ì…ë ¥í•˜ì„¸ìš”');
                            return;
                        }
                        
                        // í´ë” ì„¤ì • ì €ì¥
                        if (!this.plugin.settings.folderBookmarkSettings) {
                            this.plugin.settings.folderBookmarkSettings = {};
                        }
                        this.plugin.settings.folderBookmarkSettings[folderName] = bookmarkFolderName;
                        
                        // í˜„ì¬ í´ë”ì˜ ëª¨ë“  ë¬¸ì œì—ì„œ bookmarkFolder ì œê±° (ê¸°ì¡´ì— ìë™ ì„¤ì •ëœ ê²½ìš° ì´ˆê¸°í™”)
                        let clearedCount = 0;
                        
                        for (const q of allQuestions) {
                            if ((q.folder || 'ê¸°ë³¸') === folderName && q.bookmarkFolder === folderName) {
                                q.bookmarkFolder = '';
                                await this.plugin.saveQuestion(q, false);
                                clearedCount++;
                            }
                        }
                        
                        await this.plugin.saveSettings();
                        
                        if (clearedCount > 0) {
                            new Notice(`âœ… ì„¤ì • ì €ì¥ë¨: "${bookmarkFolderName}"\n(ê¸°ì¡´ ìë™ ë¶ë§ˆí¬ ${clearedCount}ê°œ ì œê±°ë¨)`);
                        } else {
                            new Notice(`âœ… ì„¤ì • ì €ì¥ë¨: "${bookmarkFolderName}"`);
                        }
                        bmModal.close();
                        this.onOpen();
                    });
                    
                    // Enter í‚¤ë¡œë„ í™•ì¸
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') confirmBtn.click();
                        else if (e.key === 'Escape') bmModal.close();
                    });
                    
                    bmModal.open();
                    input.focus();
                    input.select();
                });
                
                bookmarkManageBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    bookmarkManageBtn.click();
                });
            }
        });
    }

    async renderDailyTab(container) {
        const section = container.createDiv({ cls: 'quiz-daily-section' });
        section.style.cssText = 'padding: 16px;';
        
        // ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜
        const dateNavDiv = section.createDiv();
        dateNavDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: var(--background-primary-alt); border-radius: 8px;';
        
        const prevBtn = dateNavDiv.createEl('button', { text: 'â—€ ì´ì „' });
        prevBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const prevHandler = () => {
            this.currentDate.setDate(this.currentDate.getDate() - 1);
            this.onOpen();
        };
        prevBtn.onclick = prevHandler;
        prevBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            prevHandler();
        });
        
        const dateDisplay = dateNavDiv.createEl('div');
        dateDisplay.style.cssText = 'font-size: 1.1em; font-weight: bold; text-align: center; flex: 1;';
        const isToday = this.currentDate.toDateString() === new Date().toDateString();
        dateDisplay.innerHTML = `
            <div style="color: var(--text-accent);">${this.currentDate.getFullYear()}ë…„ ${this.currentDate.getMonth() + 1}ì›” ${this.currentDate.getDate()}ì¼</div>
            <div style="font-size: 0.85em; color: var(--text-muted); margin-top: 4px;">${['ì¼ìš”ì¼', 'ì›”ìš”ì¼', 'í™”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ëª©ìš”ì¼', 'ê¸ˆìš”ì¼', 'í† ìš”ì¼'][this.currentDate.getDay()]}${isToday ? ' (ì˜¤ëŠ˜)' : ''}</div>
        `;
        
        const nextBtn = dateNavDiv.createEl('button', { text: 'ë‹¤ìŒ â–¶' });
        nextBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const nextHandler = () => {
            this.currentDate.setDate(this.currentDate.getDate() + 1);
            this.onOpen();
        };
        nextBtn.onclick = nextHandler;
        nextBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            nextHandler();
        });
        
        // ì˜¤ëŠ˜ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
        if (!isToday) {
            const todayBtn = dateNavDiv.createEl('button', { text: 'ğŸ“… ì˜¤ëŠ˜' });
            todayBtn.style.cssText = 'padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; min-height: 44px; margin-left: 8px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
            const todayHandler = () => {
                this.currentDate = new Date();
                this.onOpen();
            };
            todayBtn.onclick = todayHandler;
            todayBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                todayHandler();
            });
        }
        
        const todayKey = this.currentDate.toISOString().split('T')[0];
        
        if (!this.plugin.settings.dailyChecklists) {
            this.plugin.settings.dailyChecklists = {};
        }
        if (!this.plugin.settings.dailyChecklists[todayKey]) {
            this.plugin.settings.dailyChecklists[todayKey] = { items: [], notes: [], quickMemo: '' };
        }
        
        const todayData = this.plugin.settings.dailyChecklists[todayKey];
        
        // ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì¶”ê°€
        section.addEventListener('touchstart', (e) => {
            this.touchStartX = e.touches[0].clientX;
            this.touchStartY = e.touches[0].clientY;
        });
        
        section.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const diffX = this.touchStartX - touchEndX;
            const diffY = Math.abs(this.touchStartY - touchEndY);
            
            // ìˆ˜í‰ ìŠ¤ì™€ì´í”„ë§Œ ê°ì§€ (ì„¸ë¡œ ìŠ¤í¬ë¡¤ ë°©ì§€)
            if (Math.abs(diffX) > 50 && diffY < 50) {
                if (diffX > 0) {
                    // ì™¼ìª½ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ ë‚ 
                    this.currentDate.setDate(this.currentDate.getDate() + 1);
                    this.onOpen();
                } else {
                    // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ -> ì´ì „ ë‚ 
                    this.currentDate.setDate(this.currentDate.getDate() - 1);
                    this.onOpen();
                }
            }
        });
        
        // ëª©í‘œ ì…ë ¥
        const inputDiv = section.createDiv();
        inputDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const input = inputDiv.createEl('input', { type: 'text', placeholder: 'ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”...' });
        input.style.cssText = 'flex: 1; padding: 10px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); font-size: 16px; min-height: 44px;';
        
        const addBtn = inputDiv.createEl('button', { text: 'ì¶”ê°€' });
        addBtn.style.cssText = 'padding: 10px 20px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px; min-width: 60px;';
        const addHandler = async () => {
            if (input.value.trim()) {
                todayData.items.push({ text: input.value.trim(), completed: false, timestamp: Date.now() });
                await this.plugin.saveSettings();
                const dateKey = this.getDateKey(this.currentDate);
                await this.saveChecklistToFile('daily', dateKey);
                input.value = '';
                this.onOpen();
            }
        };
        addBtn.onclick = addHandler;
        addBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            addHandler();
        });
        
        // í…œí”Œë¦¿ ë²„íŠ¼ ê·¸ë£¹ ì¶”ê°€
        const templateBtnGroup = section.createDiv();
        templateBtnGroup.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const saveDailyTemplateBtn = templateBtnGroup.createEl('button', { text: 'ğŸ’¾ í…œí”Œë¦¿ ì €ì¥' });
        saveDailyTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const saveDailyTemplateHandler = () => {
            if (todayData.items.length === 0) {
                new Notice('ì €ì¥í•  ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const newTemplate = {
                id: Date.now().toString(),
                name: '',
                items: todayData.items.map(item => item.text)
            };
            new TemplateEditModal(this.app, this.plugin, newTemplate, 'daily', () => {}).open();
        };
        saveDailyTemplateBtn.onclick = saveDailyTemplateHandler;
        saveDailyTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            saveDailyTemplateHandler();
        });
        
        const loadDailyTemplateBtn = templateBtnGroup.createEl('button', { text: 'ğŸ“‹ í…œí”Œë¦¿ ê´€ë¦¬' });
        loadDailyTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const loadDailyTemplateHandler = () => {
            const currentItems = todayData.items.map(item => item.text);
            new ChecklistTemplateModal(this.app, this.plugin, async (items) => {
                items.forEach(text => {
                    todayData.items.push({ text, completed: false, timestamp: Date.now() });
                });
                await this.plugin.saveSettings();
                const dateKey = this.getDateKey(this.currentDate);
                await this.saveChecklistToFile('daily', dateKey);
                this.onOpen();
            }, currentItems).open();
        };
        loadDailyTemplateBtn.onclick = loadDailyTemplateHandler;
        loadDailyTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            loadDailyTemplateHandler();
        });
        
        const openDailyFileBtn = templateBtnGroup.createEl('button', { text: 'ğŸ“„ íŒŒì¼ ì—´ê¸°' });
        openDailyFileBtn.style.cssText = 'padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const openDailyFileHandler = async () => {
            const learningPlansFolder = 'Learning Plans';
            try {
                const folder = this.app.vault.getAbstractFileByPath(learningPlansFolder);
                if (!folder) {
                    await this.app.vault.createFolder(learningPlansFolder);
                }
                
                const dateKey = this.getDateKey(this.currentDate);
                const fileName = `${learningPlansFolder}/ì¼ë³„ëª©í‘œ_${dateKey}.md`;
                let file = this.app.vault.getAbstractFileByPath(fileName);
                
                if (!file) {
                    const fileContent = `---\ndate: ${dateKey}\ntype: daily\n---\n\n# ğŸ“… ì¼ë³„ ëª©í‘œ (${dateKey})\n\n## âœ… ì˜¤ëŠ˜ì˜ ëª©í‘œ\n\n${todayData.items.map(item => `- [${item.completed ? 'x' : ' '}] ${item.text}`).join('\n')}\n\n## ğŸ“ ë©”ëª¨\n\n${todayData.notes ? todayData.notes.join('\n') : ''}\n\n## ğŸ¯ ì™„ë£Œ ì‚¬í•­\n\n`;
                    file = await this.app.vault.create(fileName, fileContent);
                    new Notice(`ì¼ë³„ ëª©í‘œ íŒŒì¼ ìƒì„±: ${fileName}`);
                } else {
                    await this.saveChecklistToFile('daily', dateKey);
                    new Notice(`ì¼ë³„ ëª©í‘œ íŒŒì¼ ì—´ê¸°: ${fileName}`);
                }
                
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(file);
            } catch (error) {
                console.error('íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜:', error);
                new Notice(`íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜: ${error.message}`);
            }
        };
        openDailyFileBtn.onclick = openDailyFileHandler;
        openDailyFileBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            openDailyFileHandler();
        });
        
        // ëª©í‘œ ëª©ë¡
        const listDiv = section.createDiv();
        listDiv.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        
        if (todayData.items.length === 0) {
            const empty = listDiv.createDiv();
            empty.style.cssText = 'text-align: center; padding: 40px; color: var(--text-muted);';
            empty.textContent = 'ì˜¤ëŠ˜ì˜ í•™ìŠµ ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!';
        } else {
            todayData.items.forEach((item, idx) => {
                const itemDiv = listDiv.createDiv();
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--background-primary-alt); border-radius: 6px; border: 1px solid var(--background-modifier-border);';
                
                const checkbox = itemDiv.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed;
                checkbox.style.cssText = 'width: 24px; height: 24px; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
                const checkboxHandler = async () => {
                    item.completed = !item.completed;
                    await this.plugin.saveSettings();
                    const dateKey = this.getDateKey(this.currentDate);
                    await this.saveChecklistToFile('daily', dateKey);
                    this.onOpen();
                };
                checkbox.onchange = checkboxHandler;
                checkbox.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    checkboxHandler();
                });
                
                const text = itemDiv.createEl('div', { text: item.text });
                text.style.cssText = `flex: 1; ${item.completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}`;
                
                const deleteBtn = itemDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                deleteBtn.style.cssText = 'background: transparent; border: none; cursor: pointer; font-size: 1.2em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-width: 44px; min-height: 44px; padding: 8px;';
                const deleteHandler = async () => {
                    todayData.items.splice(idx, 1);
                    await this.plugin.saveSettings();
                    const dateKey = this.getDateKey(this.currentDate);
                    await this.saveChecklistToFile('daily', dateKey);
                    this.onOpen();
                };
                deleteBtn.onclick = deleteHandler;
                deleteBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    deleteHandler();
                });
            });
        }
        
        // ë©”ëª¨ ì„¹ì…˜
        const memoSection = section.createDiv();
        memoSection.style.cssText = 'margin-top: 24px; padding: 16px; background: var(--background-secondary); border-radius: 8px;';
        
        const memoHeader = memoSection.createDiv();
        memoHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        memoHeader.createEl('h4', { text: 'ğŸ“ ë©”ëª¨' }).style.cssText = 'margin: 0; color: var(--text-normal);';
        
        const addNoteBtn = memoHeader.createEl('button', { text: '+ ë©”ëª¨ ì¶”ê°€' });
        addNoteBtn.style.cssText = 'padding: 4px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; min-height: 32px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const addNoteHandler = () => {
            showNoteInputModal((note) => {
                if (note && note.trim()) {
                    if (!todayData.notes) todayData.notes = [];
                    todayData.notes.push(note.trim());
                    this.plugin.saveSettings();
                    this.onOpen();
                }
            });
        };
        addNoteBtn.onclick = addNoteHandler;
        addNoteBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            addNoteHandler();
        });
        
        const noteList = memoSection.createDiv();
        noteList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        
        if (!todayData.notes || todayData.notes.length === 0) {
            const emptyNote = noteList.createDiv();
            emptyNote.style.cssText = 'text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;';
            emptyNote.textContent = 'ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.';
        } else {
            todayData.notes.forEach((note, idx) => {
                const noteDiv = noteList.createDiv();
                noteDiv.style.cssText = 'background: var(--background-primary); padding: 12px; border-radius: 6px; position: relative; border-left: 3px solid var(--interactive-accent); display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;';
                
                const noteText = noteDiv.createEl('div', { text: note });
                noteText.style.cssText = 'flex: 1; white-space: pre-wrap; word-wrap: break-word; color: var(--text-normal);';
                
                const noteDeleteBtn = noteDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                noteDeleteBtn.style.cssText = 'padding: 4px 8px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-height: 28px; min-width: 28px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
                const noteDeleteHandler = () => {
                    todayData.notes.splice(idx, 1);
                    this.plugin.saveSettings();
                    this.onOpen();
                };
                noteDeleteBtn.onclick = noteDeleteHandler;
                noteDeleteBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    noteDeleteHandler();
                });
            });
        }
    }

    async renderWeeklyTab(container) {
        const section = container.createDiv({ cls: 'quiz-weekly-section' });
        section.style.cssText = 'padding: 16px;';
        
        // ì£¼ì°¨ ë„¤ë¹„ê²Œì´ì…˜
        const weekNavDiv = section.createDiv();
        weekNavDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: var(--background-primary-alt); border-radius: 8px;';
        
        const prevWeekBtn = weekNavDiv.createEl('button', { text: 'â—€ ì´ì „ ì£¼' });
        prevWeekBtn.style.cssText = 'padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const prevWeekHandler = () => {
            this.currentDate.setDate(this.currentDate.getDate() - 7);
            this.onOpen();
        };
        prevWeekBtn.onclick = prevWeekHandler;
        prevWeekBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            prevWeekHandler();
        });
        
        const weekKey = this.getWeekKey(this.currentDate);
        
        // ì£¼ì°¨ ì„ íƒ ë“œë¡­ë‹¤ìš´
        const weekSelectDiv = weekNavDiv.createDiv();
        weekSelectDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; flex: 1;';
        
        const weekDisplay = weekSelectDiv.createEl('div');
        weekDisplay.style.cssText = 'font-size: 1.1em; font-weight: bold; color: #3b82f6; margin-bottom: 4px;';
        weekDisplay.textContent = `ğŸ“… ${weekKey}`;
        
        // 4ì£¼ì°¨ ë¹ ë¥¸ ì„ íƒ ë²„íŠ¼
        const weekQuickBtns = weekSelectDiv.createDiv();
        weekQuickBtns.style.cssText = 'display: flex; gap: 4px;';
        for (let i = 1; i <= 4; i++) {
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + (i - 1) * 7);
            const targetWeekKey = this.getWeekKey(targetDate);
            const isCurrentWeek = targetWeekKey === weekKey;
            
            const weekBtn = weekQuickBtns.createEl('button', { text: `${i}ì£¼` });
            weekBtn.style.cssText = `padding: 4px 8px; background: ${isCurrentWeek ? '#3b82f6' : 'var(--background-secondary)'}; color: ${isCurrentWeek ? 'white' : 'var(--text-normal)'}; border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; font-size: 0.85em; min-height: 28px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
            const weekBtnHandler = () => {
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + (i - 1) * 7);
                this.currentDate = newDate;
                this.onOpen();
            };
            weekBtn.onclick = weekBtnHandler;
            weekBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                weekBtnHandler();
            });
        }
        
        const nextWeekBtn = weekNavDiv.createEl('button', { text: 'ë‹¤ìŒ ì£¼ â–¶' });
        nextWeekBtn.style.cssText = 'padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const nextWeekHandler = () => {
            this.currentDate.setDate(this.currentDate.getDate() + 7);
            this.onOpen();
        };
        nextWeekBtn.onclick = nextWeekHandler;
        nextWeekBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            nextWeekHandler();
        });
        
        // ì´ë²ˆ ì£¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
        const thisWeekKey = this.getWeekKey(new Date());
        if (weekKey !== thisWeekKey) {
            const thisWeekBtn = weekNavDiv.createEl('button', { text: 'ğŸ“… ì´ë²ˆ ì£¼' });
            thisWeekBtn.style.cssText = 'padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; min-height: 44px; margin-left: 8px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
            const thisWeekHandler = () => {
                this.currentDate = new Date();
                this.onOpen();
            };
            thisWeekBtn.onclick = thisWeekHandler;
            thisWeekBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                thisWeekHandler();
            });
        }
        
        if (!this.plugin.settings.weeklyChecklists) {
            this.plugin.settings.weeklyChecklists = {};
        }
        if (!this.plugin.settings.weeklyChecklists[weekKey]) {
            this.plugin.settings.weeklyChecklists[weekKey] = { items: [], notes: [], quickMemo: '' };
        }
        
        const weekData = this.plugin.settings.weeklyChecklists[weekKey];
        
        // ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì¶”ê°€
        section.addEventListener('touchstart', (e) => {
            this.touchStartX = e.touches[0].clientX;
            this.touchStartY = e.touches[0].clientY;
        });
        
        section.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const diffX = this.touchStartX - touchEndX;
            const diffY = Math.abs(this.touchStartY - touchEndY);
            
            // ìˆ˜í‰ ìŠ¤ì™€ì´í”„ë§Œ ê°ì§€
            if (Math.abs(diffX) > 50 && diffY < 50) {
                if (diffX > 0) {
                    // ì™¼ìª½ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ ì£¼
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                    this.onOpen();
                } else {
                    // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ -> ì´ì „ ì£¼
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                    this.onOpen();
                }
            }
        });
        
        // ì£¼ì°¨ë³„ ë‹¬ë ¥
        const calendarDiv = section.createDiv();
        calendarDiv.style.cssText = 'margin-bottom: 16px; padding: 12px; background: var(--background-secondary); border-radius: 8px;';
        
        const currentYear = this.currentDate.getFullYear();
        const currentMonth = this.currentDate.getMonth();
        const firstDay = new Date(currentYear, currentMonth, 1);
        const lastDay = new Date(currentYear, currentMonth + 1, 0);
        
        // ë‹¬ë ¥ í—¤ë”
        const calendarHeader = calendarDiv.createDiv();
        calendarHeader.style.cssText = 'text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 1.05em;';
        calendarHeader.textContent = `${currentYear}ë…„ ${currentMonth + 1}ì›”`;
        
        // ìš”ì¼ í—¤ë”
        const weekDaysDiv = calendarDiv.createDiv();
        weekDaysDiv.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px;';
        ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
            const dayCell = weekDaysDiv.createDiv({ text: day });
            dayCell.style.cssText = 'text-align: center; font-size: 0.8em; color: var(--text-muted); padding: 4px;';
        });
        
        // ë‚ ì§œ ê·¸ë¦¬ë“œ
        const daysGrid = calendarDiv.createDiv();
        daysGrid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;';
        
        // ì²« ì£¼ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
        const firstDayOfWeek = firstDay.getDay();
        for (let i = 0; i < firstDayOfWeek; i++) {
            daysGrid.createDiv().style.cssText = 'padding: 8px;';
        }
        
        // ë‚ ì§œ ì±„ìš°ê¸°
        const today = new Date();
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dateWeekKey = this.getWeekKey(date);
            const isCurrentWeek = dateWeekKey === weekKey;
            const isToday = day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();
            
            const dayCell = daysGrid.createDiv({ text: String(day) });
            let cellStyle = 'text-align: center; padding: 8px; border-radius: 4px; font-size: 0.9em; cursor: pointer; transition: all 0.2s;';
            
            if (isToday) {
                cellStyle += ' background: var(--interactive-accent); color: var(--text-on-accent); font-weight: bold;';
            } else if (isCurrentWeek) {
                cellStyle += ' background: rgba(59, 130, 246, 0.2); color: #3b82f6; font-weight: 500;';
            } else {
                cellStyle += ' color: var(--text-muted);';
            }
            
            dayCell.style.cssText = cellStyle;
            
            // ë‚ ì§œ í´ë¦­ ì‹œ ì¼ë³„ ëª©í‘œë¡œ ì´ë™
            const dayClickHandler = () => {
                this.currentDate = new Date(currentYear, currentMonth, day);
                this.currentTab = 'daily';
                this.onOpen();
            };
            dayCell.addEventListener('click', dayClickHandler);
            dayCell.addEventListener('touchend', (e) => {
                e.preventDefault();
                dayClickHandler();
            });
            
            dayCell.addEventListener('mouseenter', () => {
                if (!isToday) {
                    dayCell.style.background = 'rgba(59, 130, 246, 0.3)';
                }
            });
            
            dayCell.addEventListener('mouseleave', () => {
                if (!isToday && !isCurrentWeek) {
                    dayCell.style.background = 'transparent';
                } else if (!isToday && isCurrentWeek) {
                    dayCell.style.background = 'rgba(59, 130, 246, 0.2)';
                }
            });
        }
        
        // í…œí”Œë¦¿ ë²„íŠ¼
        const weekTemplateBtnGroup2 = section.createDiv();
        weekTemplateBtnGroup2.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const saveTemplateBtn = weekTemplateBtnGroup2.createEl('button', { text: 'ğŸ’¾ í…œí”Œë¦¿ ì €ì¥' });
        saveTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const saveTemplateHandler = () => {
            if (weekData.items.length === 0) {
                new Notice('ì €ì¥í•  ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const newTemplate = {
                id: Date.now().toString(),
                name: '',
                items: weekData.items.map(item => item.text)
            };
            new TemplateEditModal(this.app, this.plugin, newTemplate, 'weekly', () => {}).open();
        };
        saveTemplateBtn.onclick = saveTemplateHandler;
        saveTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            saveTemplateHandler();
        });
        
        const loadTemplateBtn = weekTemplateBtnGroup2.createEl('button', { text: 'ğŸ“‚ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°' });
        loadTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const loadTemplateHandler = () => {
            new WeeklyTemplateModal(this.app, this.plugin, weekData, () => this.onOpen()).open();
        };
        loadTemplateBtn.onclick = loadTemplateHandler;
        loadTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            loadTemplateHandler();
        });
        
        const openWeeklyFileBtn = weekTemplateBtnGroup2.createEl('button', { text: 'ğŸ“„ íŒŒì¼ ì—´ê¸°' });
        openWeeklyFileBtn.style.cssText = 'padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const openWeeklyFileHandler = async () => {
            const learningPlansFolder = 'Learning Plans';
            try {
                const folder = this.app.vault.getAbstractFileByPath(learningPlansFolder);
                if (!folder) {
                    await this.app.vault.createFolder(learningPlansFolder);
                }
                
                const weekKey = this.getWeekKey(this.currentDate);
                const fileName = `${learningPlansFolder}/ì£¼ê°„ëª©í‘œ_${weekKey}.md`;
                let file = this.app.vault.getAbstractFileByPath(fileName);
                
                if (!file) {
                    const fileContent = `---\nweek: ${weekKey}\ntype: weekly\n---\n\n# ğŸ“† ì£¼ê°„ ëª©í‘œ (${weekKey})\n\n## âœ… ì´ë²ˆ ì£¼ ëª©í‘œ\n\n${weekData.items.map(item => `- [${item.completed ? 'x' : ' '}] ${item.text}`).join('\n')}\n\n## ğŸ“ ë©”ëª¨\n\n${weekData.notes ? weekData.notes.join('\n') : ''}\n\n## ğŸ¯ ì™„ë£Œ ì‚¬í•­\n\n`;
                    file = await this.app.vault.create(fileName, fileContent);
                    new Notice(`ì£¼ê°„ ëª©í‘œ íŒŒì¼ ìƒì„±: ${fileName}`);
                } else {
                    await this.saveChecklistToFile('weekly', weekKey);
                    new Notice(`ì£¼ê°„ ëª©í‘œ íŒŒì¼ ì—´ê¸°: ${fileName}`);
                }
                
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(file);
            } catch (error) {
                console.error('íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜:', error);
                new Notice(`íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜: ${error.message}`);
            }
        };
        openWeeklyFileBtn.onclick = openWeeklyFileHandler;
        openWeeklyFileBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            openWeeklyFileHandler();
        });
        
        // ì£¼ì°¨ë³„ í•™ìŠµ ê¸°ë¡
        const historySection = section.createDiv();
        historySection.style.cssText = 'margin-bottom: 16px; padding: 12px; background: var(--background-secondary); border-radius: 6px;';
        historySection.createEl('h4', { text: 'ğŸ“Š ì£¼ì°¨ë³„ í•™ìŠµ ê¸°ë¡' }).style.cssText = 'margin: 0 0 8px 0; font-size: 1em;';
        
        const weekHistory = this.plugin.settings.stats.studyHistory?.filter(h => {
            const sessionDate = new Date(h.timestamp || h.date);
            return this.getWeekKey(sessionDate) === weekKey;
        }) || [];
        
        if (weekHistory.length === 0) {
            historySection.createEl('div', { text: 'ì´ë²ˆ ì£¼ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = 'color: var(--text-muted); font-style: italic; font-size: 0.9em;';
        } else {
            const totalAttempts = weekHistory.reduce((sum, h) => sum + (h.total || 0), 0);
            const totalCorrect = weekHistory.reduce((sum, h) => sum + (h.correct || 0), 0);
            const accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            
            const summaryDiv = historySection.createDiv();
            summaryDiv.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px;';
            
            const statBox = (label, value, color) => {
                const box = summaryDiv.createDiv();
                box.style.cssText = `text-align: center; padding: 8px; background: var(--background-primary); border-radius: 4px; border-left: 3px solid ${color};`;
                box.createEl('div', { text: value }).style.cssText = `font-size: 1.2em; font-weight: bold; color: ${color};`;
                box.createEl('div', { text: label }).style.cssText = 'font-size: 0.75em; color: var(--text-muted);';
            };
            
            statBox('ì´ ë¬¸ì œ', `${totalAttempts}ê°œ`, '#3b82f6');
            statBox('ì •ë‹µ', `${totalCorrect}ê°œ`, '#10b981');
            statBox('ì •ë‹µë¥ ', `${accuracy}%`, '#f59e0b');
        }
        
        // ëª©í‘œ ì…ë ¥
        const inputDiv = section.createDiv();
        inputDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const input = inputDiv.createEl('input', { type: 'text', placeholder: 'ì´ë²ˆ ì£¼ í•™ìŠµ ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”...' });
        input.style.cssText = 'flex: 1; padding: 10px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); font-size: 16px; min-height: 44px;';
        
        const addBtn = inputDiv.createEl('button', { text: 'ì¶”ê°€' });
        addBtn.style.cssText = 'padding: 10px 20px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px; min-width: 60px;';
        addBtn.onclick = async () => {
            if (input.value.trim()) {
                weekData.items.push({ text: input.value.trim(), completed: false, timestamp: Date.now() });
                await this.plugin.saveSettings();
                const weekKey = this.getWeekKey(this.currentDate);
                await this.saveChecklistToFile('weekly', weekKey);
                input.value = '';
                this.onOpen();
            }
        };
        
        // í…œí”Œë¦¿ ë²„íŠ¼ ê·¸ë£¹ ì¶”ê°€
        const weekTemplateBtnGroup = section.createDiv();
        weekTemplateBtnGroup.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const weekTemplateBtn = weekTemplateBtnGroup.createEl('button', { text: 'ğŸ“‹ í…œí”Œë¦¿ ê´€ë¦¬' });
        weekTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const weekTemplateHandler = () => {
            const currentItems = weekData.items.map(item => item.text);
            new ChecklistTemplateModal(this.app, this.plugin, async (items) => {
                items.forEach(text => {
                    weekData.items.push({ text, completed: false, timestamp: Date.now() });
                });
                await this.plugin.saveSettings();
                const weekKey = this.getWeekKey(this.currentDate);
                await this.saveChecklistToFile('weekly', weekKey);
                this.onOpen();
            }, currentItems).open();
        };
        weekTemplateBtn.onclick = weekTemplateHandler;
        weekTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            weekTemplateHandler();
        });
        
        // ëª©í‘œ ëª©ë¡
        const listDiv = section.createDiv();
        listDiv.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        
        if (weekData.items.length === 0) {
            const empty = listDiv.createDiv();
            empty.style.cssText = 'text-align: center; padding: 40px; color: var(--text-muted);';
            empty.textContent = 'ì´ë²ˆ ì£¼ í•™ìŠµ ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!';
        } else {
            weekData.items.forEach((item, idx) => {
                const itemDiv = listDiv.createDiv();
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--background-primary-alt); border-radius: 6px; border: 1px solid var(--background-modifier-border);';
                
                const checkbox = itemDiv.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed;
                checkbox.style.cssText = 'width: 24px; height: 24px; cursor: pointer; touch-action: manipulation;';
                checkbox.onchange = async () => {
                    item.completed = checkbox.checked;
                    await this.plugin.saveSettings();
                    const weekKey = this.getWeekKey(this.currentDate);
                    await this.saveChecklistToFile('weekly', weekKey);
                    this.onOpen();
                };
                
                const text = itemDiv.createEl('div', { text: item.text });
                text.style.cssText = `flex: 1; ${item.completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}`;
                
                const deleteBtn = itemDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                deleteBtn.style.cssText = 'background: transparent; border: none; cursor: pointer; font-size: 1.2em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-width: 44px; min-height: 44px; padding: 8px;';
                deleteBtn.onclick = async () => {
                    weekData.items.splice(idx, 1);
                    await this.plugin.saveSettings();
                    const weekKey = this.getWeekKey(this.currentDate);
                    await this.saveChecklistToFile('weekly', weekKey);
                    this.onOpen();
                };
            });
        }
        
        // ë©”ëª¨ ì„¹ì…˜
        const memoSection = section.createDiv();
        memoSection.style.cssText = 'margin-top: 24px; padding: 16px; background: var(--background-secondary); border-radius: 8px;';
        
        const memoHeader = memoSection.createDiv();
        memoHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        memoHeader.createEl('h4', { text: 'ğŸ“ ë©”ëª¨' }).style.cssText = 'margin: 0; color: var(--text-normal);';
        
        const addNoteBtn = memoHeader.createEl('button', { text: '+ ë©”ëª¨ ì¶”ê°€' });
        addNoteBtn.style.cssText = 'padding: 4px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; min-height: 32px;';
        addNoteBtn.onclick = () => {
            showNoteInputModal((note) => {
                if (note && note.trim()) {
                    if (!weekData.notes) weekData.notes = [];
                    weekData.notes.push(note.trim());
                    this.plugin.saveSettings();
                    this.onOpen();
                }
            });
        };
        
        const noteList = memoSection.createDiv();
        noteList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        
        if (!weekData.notes || weekData.notes.length === 0) {
            const emptyNote = noteList.createDiv();
            emptyNote.style.cssText = 'text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;';
            emptyNote.textContent = 'ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.';
        } else {
            weekData.notes.forEach((note, idx) => {
                const noteDiv = noteList.createDiv();
                noteDiv.style.cssText = 'background: var(--background-primary); padding: 12px; border-radius: 6px; position: relative; border-left: 3px solid var(--interactive-accent); display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;';
                
                const noteText = noteDiv.createEl('div', { text: note });
                noteText.style.cssText = 'flex: 1; white-space: pre-wrap; word-wrap: break-word; color: var(--text-normal);';
                
                const noteDeleteBtn = noteDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                noteDeleteBtn.style.cssText = 'padding: 4px 8px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-height: 28px; min-width: 28px;';
                noteDeleteBtn.onclick = () => {
                    weekData.notes.splice(idx, 1);
                    this.plugin.saveSettings();
                    this.onOpen();
                };
            });
        }
    }

    async renderMonthlyTab(container) {
        const section = container.createDiv({ cls: 'quiz-monthly-section' });
        section.style.cssText = 'padding: 16px;';
        
        // ì›” ë„¤ë¹„ê²Œì´ì…˜
        const monthNavDiv = section.createDiv();
        monthNavDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding: 12px; background: var(--background-primary-alt); border-radius: 8px;';
        
        const prevMonthBtn = monthNavDiv.createEl('button', { text: 'â—€ ì´ì „ ë‹¬' });
        prevMonthBtn.style.cssText = 'padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const prevMonthHandler = () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.onOpen();
        };
        prevMonthBtn.onclick = prevMonthHandler;
        prevMonthBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            prevMonthHandler();
        });
        
        const monthKey = `${this.currentDate.getFullYear()}-${String(this.currentDate.getMonth() + 1).padStart(2, '0')}`;
        const monthDisplay = monthNavDiv.createEl('div');
        monthDisplay.style.cssText = 'font-size: 1.1em; font-weight: bold; text-align: center; flex: 1; color: #10b981;';
        monthDisplay.textContent = `ğŸ“… ${this.currentDate.getFullYear()}ë…„ ${this.currentDate.getMonth() + 1}ì›”`;
        
        const nextMonthBtn = monthNavDiv.createEl('button', { text: 'ë‹¤ìŒ ë‹¬ â–¶' });
        nextMonthBtn.style.cssText = 'padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const nextMonthHandler = () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.onOpen();
        };
        nextMonthBtn.onclick = nextMonthHandler;
        nextMonthBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            nextMonthHandler();
        });
        
        // ì´ë²ˆ ë‹¬ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼
        const thisMonthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
        if (monthKey !== thisMonthKey) {
            const thisMonthBtn = monthNavDiv.createEl('button', { text: 'ğŸ“… ì´ë²ˆ ë‹¬' });
            thisMonthBtn.style.cssText = 'padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; min-height: 44px; margin-left: 8px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
            const thisMonthHandler = () => {
                this.currentDate = new Date();
                this.onOpen();
            };
            thisMonthBtn.onclick = thisMonthHandler;
            thisMonthBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                thisMonthHandler();
            });
        }
        
        if (!this.plugin.settings.monthlyChecklists) {
            this.plugin.settings.monthlyChecklists = {};
        }
        if (!this.plugin.settings.monthlyChecklists[monthKey]) {
            this.plugin.settings.monthlyChecklists[monthKey] = { items: [], notes: [], quickMemo: '' };
        }
        
        const monthData = this.plugin.settings.monthlyChecklists[monthKey];
        
        // ìŠ¤ì™€ì´í”„ ê¸°ëŠ¥ ì¶”ê°€
        section.addEventListener('touchstart', (e) => {
            this.touchStartX = e.touches[0].clientX;
            this.touchStartY = e.touches[0].clientY;
        });
        
        section.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const diffX = this.touchStartX - touchEndX;
            const diffY = Math.abs(this.touchStartY - touchEndY);
            
            // ìˆ˜í‰ ìŠ¤ì™€ì´í”„ë§Œ ê°ì§€
            if (Math.abs(diffX) > 50 && diffY < 50) {
                if (diffX > 0) {
                    // ì™¼ìª½ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ ë‹¬
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                    this.onOpen();
                } else {
                    // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ -> ì´ì „ ë‹¬
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                    this.onOpen();
                }
            }
        });
        
        // ì›”ë³„ ë‹¬ë ¥
        const calendarDiv = section.createDiv();
        calendarDiv.style.cssText = 'margin-bottom: 16px; padding: 12px; background: var(--background-secondary); border-radius: 8px;';
        
        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const today = new Date();
        
        // ë‹¬ë ¥ í—¤ë”
        const calendarHeader = calendarDiv.createDiv();
        calendarHeader.style.cssText = 'text-align: center; font-weight: bold; margin-bottom: 8px; font-size: 1.05em;';
        calendarHeader.textContent = `${year}ë…„ ${month + 1}ì›”`;
        
        // ìš”ì¼ í—¤ë”
        const weekDaysDiv = calendarDiv.createDiv();
        weekDaysDiv.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px;';
        ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].forEach(day => {
            const dayCell = weekDaysDiv.createDiv({ text: day });
            dayCell.style.cssText = 'text-align: center; font-size: 0.8em; color: var(--text-muted); padding: 4px;';
        });
        
        // ë‚ ì§œ ê·¸ë¦¬ë“œ
        const daysGrid = calendarDiv.createDiv();
        daysGrid.style.cssText = 'display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;';
        
        // ì²« ì£¼ ë¹ˆ ì¹¸ ì±„ìš°ê¸°
        const firstDayOfWeek = firstDay.getDay();
        for (let i = 0; i < firstDayOfWeek; i++) {
            daysGrid.createDiv().style.cssText = 'padding: 8px;';
        }
        
        // ë‚ ì§œ ì±„ìš°ê¸°
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            
            const dayCell = daysGrid.createDiv({ text: String(day) });
            let cellStyle = 'text-align: center; padding: 8px; border-radius: 4px; font-size: 0.9em; cursor: pointer; transition: all 0.2s;';
            
            if (isToday) {
                cellStyle += ' background: var(--interactive-accent); color: var(--text-on-accent); font-weight: bold;';
            } else {
                cellStyle += ' color: var(--text-normal);';
            }
            
            dayCell.style.cssText = cellStyle;
            
            // ë‚ ì§œ í´ë¦­ ì‹œ ì¼ë³„ ëª©í‘œë¡œ ì´ë™
            const dayClickHandler = () => {
                this.currentDate = new Date(year, month, day);
                this.currentTab = 'daily';
                this.onOpen();
            };
            dayCell.addEventListener('click', dayClickHandler);
            dayCell.addEventListener('touchend', (e) => {
                e.preventDefault();
                dayClickHandler();
            });
            
            dayCell.addEventListener('mouseenter', () => {
                if (!isToday) {
                    dayCell.style.background = 'rgba(16, 185, 129, 0.2)';
                }
            });
            
            dayCell.addEventListener('mouseleave', () => {
                if (!isToday) {
                    dayCell.style.background = 'transparent';
                }
            });
        }
        
        // í…œí”Œë¦¿ ë²„íŠ¼
        const monthTemplateBtnGroup2 = section.createDiv();
        monthTemplateBtnGroup2.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const saveTemplateBtn = monthTemplateBtnGroup2.createEl('button', { text: 'ğŸ’¾ í…œí”Œë¦¿ ì €ì¥' });
        saveTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const saveTemplateHandler = () => {
            if (monthData.items.length === 0) {
                new Notice('ì €ì¥í•  ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const newTemplate = {
                id: Date.now().toString(),
                name: '',
                items: monthData.items.map(item => item.text)
            };
            new TemplateEditModal(this.app, this.plugin, newTemplate, 'monthly', () => {}).open();
        };
        saveTemplateBtn.onclick = saveTemplateHandler;
        saveTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            saveTemplateHandler();
        });
        
        const loadTemplateBtn = monthTemplateBtnGroup2.createEl('button', { text: 'ğŸ“‚ í…œí”Œë¦¿ ë¶ˆëŸ¬ì˜¤ê¸°' });
        loadTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const loadTemplateHandler = () => {
            new MonthlyTemplateModal(this.app, this.plugin, monthData, () => this.onOpen()).open();
        };
        loadTemplateBtn.onclick = loadTemplateHandler;
        loadTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            loadTemplateHandler();
        });
        
        const openMonthlyFileBtn = monthTemplateBtnGroup2.createEl('button', { text: 'ğŸ“„ íŒŒì¼ ì—´ê¸°' });
        openMonthlyFileBtn.style.cssText = 'padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const openMonthlyFileHandler = async () => {
            const learningPlansFolder = 'Learning Plans';
            try {
                const folder = this.app.vault.getAbstractFileByPath(learningPlansFolder);
                if (!folder) {
                    await this.app.vault.createFolder(learningPlansFolder);
                }
                
                const monthKey = this.getMonthKey(this.currentDate);
                const fileName = `${learningPlansFolder}/ì›”ê°„ëª©í‘œ_${monthKey}.md`;
                let file = this.app.vault.getAbstractFileByPath(fileName);
                
                if (!file) {
                    const fileContent = `---\nmonth: ${monthKey}\ntype: monthly\n---\n\n# ğŸ“Š ì›”ê°„ ëª©í‘œ (${monthKey})\n\n## âœ… ì´ë²ˆ ë‹¬ ëª©í‘œ\n\n${monthData.items.map(item => `- [${item.completed ? 'x' : ' '}] ${item.text}`).join('\n')}\n\n## ğŸ“ ë©”ëª¨\n\n${monthData.notes ? monthData.notes.join('\n') : ''}\n\n## ğŸ¯ ì™„ë£Œ ì‚¬í•­\n\n`;
                    file = await this.app.vault.create(fileName, fileContent);
                    new Notice(`ì›”ê°„ ëª©í‘œ íŒŒì¼ ìƒì„±: ${fileName}`);
                } else {
                    await this.saveChecklistToFile('monthly', monthKey);
                    new Notice(`ì›”ê°„ ëª©í‘œ íŒŒì¼ ì—´ê¸°: ${fileName}`);
                }
                
                const leaf = this.app.workspace.getLeaf(false);
                await leaf.openFile(file);
            } catch (error) {
                console.error('íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜:', error);
                new Notice(`íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜: ${error.message}`);
            }
        };
        openMonthlyFileBtn.onclick = openMonthlyFileHandler;
        openMonthlyFileBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            openMonthlyFileHandler();
        });
        
        // ì›”ë³„ í•™ìŠµ ê¸°ë¡
        const historySection = section.createDiv();
        historySection.style.cssText = 'margin-bottom: 16px; padding: 12px; background: var(--background-secondary); border-radius: 6px;';
        historySection.createEl('h4', { text: 'ğŸ“Š ì›”ë³„ í•™ìŠµ ê¸°ë¡' }).style.cssText = 'margin: 0 0 8px 0; font-size: 1em;';
        
        const monthHistory = this.plugin.settings.stats.studyHistory?.filter(h => {
            const sessionDate = new Date(h.timestamp || h.date);
            const sessionMonthKey = `${sessionDate.getFullYear()}-${String(sessionDate.getMonth() + 1).padStart(2, '0')}`;
            return sessionMonthKey === monthKey;
        }) || [];
        
        if (monthHistory.length === 0) {
            historySection.createEl('div', { text: 'ì´ë²ˆ ë‹¬ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = 'color: var(--text-muted); font-style: italic; font-size: 0.9em;';
        } else {
            const totalAttempts = monthHistory.reduce((sum, h) => sum + (h.total || 0), 0);
            const totalCorrect = monthHistory.reduce((sum, h) => sum + (h.correct || 0), 0);
            const accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
            
            const summaryDiv = historySection.createDiv();
            summaryDiv.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px;';
            
            const statBox = (label, value, color) => {
                const box = summaryDiv.createDiv();
                box.style.cssText = `text-align: center; padding: 8px; background: var(--background-primary); border-radius: 4px; border-left: 3px solid ${color};`;
                box.createEl('div', { text: value }).style.cssText = `font-size: 1.2em; font-weight: bold; color: ${color};`;
                box.createEl('div', { text: label }).style.cssText = 'font-size: 0.75em; color: var(--text-muted);';
            };
            
            statBox('ì´ ë¬¸ì œ', `${totalAttempts}ê°œ`, '#3b82f6');
            statBox('ì •ë‹µ', `${totalCorrect}ê°œ`, '#10b981');
            statBox('ì •ë‹µë¥ ', `${accuracy}%`, '#f59e0b');
        }
        
        // ëª©í‘œ ì…ë ¥
        const inputDiv = section.createDiv();
        inputDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const input = inputDiv.createEl('input', { type: 'text', placeholder: 'ì´ë²ˆ ë‹¬ í•™ìŠµ ëª©í‘œë¥¼ ì…ë ¥í•˜ì„¸ìš”...' });
        input.style.cssText = 'flex: 1; padding: 10px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); font-size: 16px; min-height: 44px;';
        
        const addBtn = inputDiv.createEl('button', { text: 'ì¶”ê°€' });
        addBtn.style.cssText = 'padding: 10px 20px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px; min-width: 60px;';
        addBtn.onclick = async () => {
            if (input.value.trim()) {
                monthData.items.push({ text: input.value.trim(), completed: false, timestamp: Date.now() });
                await this.plugin.saveSettings();
                const monthKey = this.getMonthKey(this.currentDate);
                await this.saveChecklistToFile('monthly', monthKey);
                input.value = '';
                this.onOpen();
            }
        };
        
        // í…œí”Œë¦¿ ë²„íŠ¼ ê·¸ë£¹ ì¶”ê°€
        const monthTemplateBtnGroup = section.createDiv();
        monthTemplateBtnGroup.style.cssText = 'display: flex; gap: 8px; margin-bottom: 16px;';
        
        const monthTemplateBtn = monthTemplateBtnGroup.createEl('button', { text: 'ğŸ“‹ í…œí”Œë¦¿ ê´€ë¦¬' });
        monthTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; font-size: 0.9em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        const monthTemplateHandler = () => {
            const currentItems = monthData.items.map(item => item.text);
            new ChecklistTemplateModal(this.app, this.plugin, async (items) => {
                items.forEach(text => {
                    monthData.items.push({ text, completed: false, timestamp: Date.now() });
                });
                await this.plugin.saveSettings();
                const monthKey = this.getMonthKey(this.currentDate);
                await this.saveChecklistToFile('monthly', monthKey);
                this.onOpen();
            }, currentItems).open();
        };
        monthTemplateBtn.onclick = monthTemplateHandler;
        monthTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            monthTemplateHandler();
        });
        
        // ëª©í‘œ ëª©ë¡
        const listDiv = section.createDiv();
        listDiv.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        
        if (monthData.items.length === 0) {
            const empty = listDiv.createDiv();
            empty.style.cssText = 'text-align: center; padding: 40px; color: var(--text-muted);';
            empty.textContent = 'ì´ë²ˆ ë‹¬ í•™ìŠµ ëª©í‘œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”!';
        } else {
            monthData.items.forEach((item, idx) => {
                const itemDiv = listDiv.createDiv();
                itemDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--background-primary-alt); border-radius: 6px; border: 1px solid var(--background-modifier-border);';
                
                const checkbox = itemDiv.createEl('input', { type: 'checkbox' });
                checkbox.checked = item.completed;
                checkbox.style.cssText = 'width: 24px; height: 24px; cursor: pointer; touch-action: manipulation;';
                checkbox.onchange = async () => {
                    item.completed = checkbox.checked;
                    await this.plugin.saveSettings();
                    const monthKey = this.getMonthKey(this.currentDate);
                    await this.saveChecklistToFile('monthly', monthKey);
                    this.onOpen();
                };
                
                const text = itemDiv.createEl('div', { text: item.text });
                text.style.cssText = `flex: 1; ${item.completed ? 'text-decoration: line-through; color: var(--text-muted);' : ''}`;
                
                const deleteBtn = itemDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                deleteBtn.style.cssText = 'background: transparent; border: none; cursor: pointer; font-size: 1.2em; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-width: 44px; min-height: 44px; padding: 8px;';
                deleteBtn.onclick = async () => {
                    monthData.items.splice(idx, 1);
                    await this.plugin.saveSettings();
                    const monthKey = this.getMonthKey(this.currentDate);
                    await this.saveChecklistToFile('monthly', monthKey);
                    this.onOpen();
                };
            });
        }
        
        // ë©”ëª¨ ì„¹ì…˜
        const memoSection = section.createDiv();
        memoSection.style.cssText = 'margin-top: 24px; padding: 16px; background: var(--background-secondary); border-radius: 8px;';
        
        const memoHeader = memoSection.createDiv();
        memoHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        memoHeader.createEl('h4', { text: 'ğŸ“ ë©”ëª¨' }).style.cssText = 'margin: 0; color: var(--text-normal);';
        
        const addNoteBtn = memoHeader.createEl('button', { text: '+ ë©”ëª¨ ì¶”ê°€' });
        addNoteBtn.style.cssText = 'padding: 4px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; min-height: 32px;';
        addNoteBtn.onclick = () => {
            new TextInputModal(this.app, 'ğŸ“ ë©”ëª¨ ì¶”ê°€', 'ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”...', '', async (note) => {
                if (!monthData.notes) monthData.notes = [];
                monthData.notes.push(note);
                await this.plugin.saveSettings();
                const monthKey = this.getMonthKey(this.currentDate);
                await this.saveChecklistToFile('monthly', monthKey);
                this.onOpen();
            }).open();
        };
        
        const noteList = memoSection.createDiv();
        noteList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';
        
        if (!monthData.notes || monthData.notes.length === 0) {
            const emptyNote = noteList.createDiv();
            emptyNote.style.cssText = 'text-align: center; padding: 20px; color: var(--text-muted); font-style: italic;';
            emptyNote.textContent = 'ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ìœ„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì¶”ê°€í•˜ì„¸ìš”.';
        } else {
            monthData.notes.forEach((note, idx) => {
                const noteDiv = noteList.createDiv();
                noteDiv.style.cssText = 'background: var(--background-primary); padding: 12px; border-radius: 6px; position: relative; border-left: 3px solid var(--interactive-accent); display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;';
                
                const noteText = noteDiv.createEl('div', { text: note });
                noteText.style.cssText = 'flex: 1; white-space: pre-wrap; word-wrap: break-word; color: var(--text-normal);';
                
                const noteDeleteBtn = noteDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                noteDeleteBtn.style.cssText = 'padding: 4px 8px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-height: 28px; min-width: 28px;';
                noteDeleteBtn.onclick = () => {
                    monthData.notes.splice(idx, 1);
                    this.plugin.saveSettings();
                    this.onOpen();
                };
            });
        }
    }

    getDateKey(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    getWeekKey(date) {
        const year = date.getFullYear();
        const oneJan = new Date(year, 0, 1);
        const numberOfDays = Math.floor((date - oneJan) / (24 * 60 * 60 * 1000));
        const weekNumber = Math.ceil((numberOfDays + oneJan.getDay() + 1) / 7);
        return `${year}-W${String(weekNumber).padStart(2, '0')}`;
    }

    getMonthKey(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        return `${year}-${month}`;
    }
}

// Part 2: Modal Classes

// í…œí”Œë¦¿ í¸ì§‘ ëª¨ë‹¬ (ë£¨í‹´ í”ŒëŸ¬ê·¸ì¸ ìŠ¤íƒ€ì¼)
class TemplateEditModal extends Modal {
    constructor(app, plugin, template, type, onSave) {
        super(app);
        this.plugin = plugin;
        this.template = template || { id: Date.now().toString(), name: '', items: [] };
        this.type = type; // 'daily', 'weekly', 'monthly'
        this.isNew = !template;
        this.onSave = onSave;
    }

    onOpen() {
        const { contentEl, modalEl } = this;
        contentEl.empty();
        
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            modalEl.style.width = '95vw';
            modalEl.style.maxWidth = '95vw';
        }
        
        const typeText = this.type === 'daily' ? 'ì¼ë³„' : this.type === 'weekly' ? 'ì£¼ê°„' : 'ì›”ê°„';
        contentEl.createEl('h2', { text: this.isNew ? `ìƒˆ ${typeText} í…œí”Œë¦¿` : `${typeText} í…œí”Œë¦¿ í¸ì§‘` }).style.fontSize = isMobile ? '1.3rem' : '1.5rem';
        
        const form = contentEl.createDiv({ cls: 'template-form' });
        
        form.createEl('label', { text: 'í…œí”Œë¦¿ ì´ë¦„' });
        const nameInput = form.createEl('input', { type: 'text', value: this.template.name });
        nameInput.style.cssText = `width: 100%; margin-bottom: 15px; padding: ${isMobile ? '12px' : '8px'}; font-size: ${isMobile ? '1rem' : '0.95rem'}; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary);`;
        
        form.createEl('label', { text: 'í•­ëª© (í•œ ì¤„ì— í•˜ë‚˜ì”©)' });
        const itemsTextarea = form.createEl('textarea');
        itemsTextarea.value = this.template.items.join('\n');
        itemsTextarea.style.cssText = `width: 100%; min-height: ${isMobile ? '120px' : '150px'}; margin-bottom: 15px; padding: ${isMobile ? '12px' : '10px'}; font-size: ${isMobile ? '1rem' : '0.95rem'}; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); resize: vertical;`;
        
        const btnContainer = form.createDiv({ cls: 'modal-btn-container' });
        btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;';
        
        const saveBtn = btnContainer.createEl('button', { text: 'ğŸ’¾ ì €ì¥' });
        saveBtn.style.cssText = `padding: ${isMobile ? '12px 20px' : '8px 16px'}; font-size: ${isMobile ? '1rem' : '0.95rem'}; min-height: ${isMobile ? '48px' : '36px'}; flex: 1; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; background: var(--interactive-accent); color: var(--text-on-accent); touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
        saveBtn.onclick = async () => {
            const newName = nameInput.value.trim();
            const newItems = itemsTextarea.value.split('\n').filter(item => item.trim());
            
            if (!newName) {
                new Notice('âš ï¸ í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            if (newItems.length === 0) {
                new Notice('âš ï¸ ìµœì†Œ 1ê°œ ì´ìƒì˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            this.template.name = newName;
            this.template.items = newItems;
            
            const templateKey = this.type === 'daily' ? 'dailyTemplates' : this.type === 'weekly' ? 'weeklyTemplates' : 'monthlyTemplates';
            
            if (this.isNew) {
                if (!this.plugin.settings[templateKey]) this.plugin.settings[templateKey] = [];
                this.plugin.settings[templateKey].push(this.template);
            }
            
            await this.plugin.saveSettings();
            this.onSave();
            this.close();
            new Notice(`âœ… í…œí”Œë¦¿ "${newName}" ì €ì¥ë¨`);
        };
        saveBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            saveBtn.click();
        });
        
        if (!this.isNew) {
            const deleteBtn = btnContainer.createEl('button', { text: 'ğŸ—‘ï¸ ì‚­ì œ' });
            deleteBtn.style.cssText = `padding: ${isMobile ? '12px 20px' : '8px 16px'}; font-size: ${isMobile ? '1rem' : '0.95rem'}; min-height: ${isMobile ? '48px' : '36px'}; flex: 1; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; background: #ef4444; color: #fff; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
            deleteBtn.onclick = async () => {
                const templateKey = this.type === 'daily' ? 'dailyTemplates' : this.type === 'weekly' ? 'weeklyTemplates' : 'monthlyTemplates';
                const index = this.plugin.settings[templateKey].findIndex(t => t.id === this.template.id);
                if (index > -1) {
                    this.plugin.settings[templateKey].splice(index, 1);
                    await this.plugin.saveSettings();
                    this.onSave();
                    this.close();
                    new Notice('âœ… í…œí”Œë¦¿ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
            };
            deleteBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                deleteBtn.click();
            });
        }
        
        const cancelBtn = btnContainer.createEl('button', { text: 'ì·¨ì†Œ' });
        cancelBtn.style.cssText = `padding: ${isMobile ? '12px 20px' : '8px 16px'}; font-size: ${isMobile ? '1rem' : '0.95rem'}; min-height: ${isMobile ? '48px' : '36px'}; flex: 1; border: none; border-radius: 6px; cursor: pointer; background: #6b7280; color: #fff; font-weight: bold; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
        cancelBtn.onclick = () => this.close();
        cancelBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.close();
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ì¼ë³„ í…œí”Œë¦¿ ëª¨ë‹¬
class DailyTemplateModal extends Modal {
    constructor(app, plugin, dailyData, refreshCallback) {
        super(app);
        this.plugin = plugin;
        this.dailyData = dailyData;
        this.refreshCallback = refreshCallback;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        const header = contentEl.createDiv();
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
        header.createEl('h2', { text: 'ğŸ“‚ ì¼ë³„ í…œí”Œë¦¿' }).style.cssText = 'margin: 0;';
        
        const newTemplateBtn = header.createEl('button', { text: 'â• ìƒˆ í…œí”Œë¦¿' });
        newTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: bold; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        newTemplateBtn.onclick = () => {
            new TemplateEditModal(this.app, this.plugin, null, 'daily', () => this.onOpen()).open();
        };
        newTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            newTemplateBtn.click();
        });
        
        const templates = this.plugin.settings.dailyTemplates || [];
        
        if (templates.length === 0) {
            contentEl.createEl('div', { text: 'ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = 'color: var(--text-muted); font-style: italic; padding: 20px; text-align: center;';
        } else {
            templates.forEach((template, idx) => {
                const templateDiv = contentEl.createDiv();
                templateDiv.style.cssText = 'padding: 12px; background: var(--background-secondary); border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;';
                
                const templateInfo = templateDiv.createDiv();
                templateInfo.createEl('div', { text: template.name }).style.cssText = 'font-weight: bold; margin-bottom: 4px;';
                templateInfo.createEl('div', { text: `${template.items.length}ê°œ ëª©í‘œ` }).style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
                
                const btnGroup = templateDiv.createDiv();
                btnGroup.style.cssText = 'display: flex; gap: 4px;';
                
                const loadBtn = btnGroup.createEl('button', { text: 'ë¶ˆëŸ¬ì˜¤ê¸°' });
                loadBtn.style.cssText = 'padding: 6px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer;';
                loadBtn.onclick = () => {
                    this.dailyData.items = template.items.map(text => ({ 
                        text, 
                        completed: false, 
                        timestamp: Date.now() 
                    }));
                    this.plugin.saveSettings();
                    new Notice(`âœ… í…œí”Œë¦¿ "${template.name}" ë¶ˆëŸ¬ì˜´`);
                    this.refreshCallback();
                    this.close();
                };
                
                const editBtn = btnGroup.createEl('button', { text: 'âœï¸ ìˆ˜ì •' });
                editBtn.style.cssText = 'padding: 6px 12px; background: var(--background-modifier-border); border: none; border-radius: 4px; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
                editBtn.onclick = () => {
                    new TemplateEditModal(this.app, this.plugin, template, 'daily', () => this.onOpen()).open();
                };
                editBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    editBtn.click();
                });
                
                const deleteBtn = btnGroup.createEl('button', { text: 'ğŸ—‘ï¸ ì‚­ì œ' });
                deleteBtn.style.cssText = 'padding: 6px 12px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer;';
                deleteBtn.onclick = () => {
                    new ConfirmModal(this.app, `"${template.name}" í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, (confirmed) => {
                        if (confirmed) {
                            this.plugin.settings.dailyTemplates.splice(idx, 1);
                            this.plugin.saveSettings();
                            this.onOpen();
                        }
                    }).open();
                };
            });
        }
    }
}

// ì£¼ê°„ í…œí”Œë¦¿ ëª¨ë‹¬
class WeeklyTemplateModal extends Modal {
    constructor(app, plugin, weekData, refreshCallback) {
        super(app);
        this.plugin = plugin;
        this.weekData = weekData;
        this.refreshCallback = refreshCallback;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        const header = contentEl.createDiv();
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
        header.createEl('h2', { text: 'ğŸ“‚ ì£¼ê°„ í…œí”Œë¦¿' }).style.cssText = 'margin: 0;';
        
        const newTemplateBtn = header.createEl('button', { text: 'â• ìƒˆ í…œí”Œë¦¿' });
        newTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: bold; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        newTemplateBtn.onclick = () => {
            new TemplateEditModal(this.app, this.plugin, null, 'weekly', () => this.onOpen()).open();
        };
        newTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            newTemplateBtn.click();
        });
        
        const templates = this.plugin.settings.weeklyTemplates || [];
        
        if (templates.length === 0) {
            contentEl.createEl('div', { text: 'ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = 'color: var(--text-muted); font-style: italic; padding: 20px; text-align: center;';
        } else {
            templates.forEach((template, idx) => {
                const templateDiv = contentEl.createDiv();
                templateDiv.style.cssText = 'padding: 12px; background: var(--background-secondary); border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;';
                
                const templateInfo = templateDiv.createDiv();
                templateInfo.createEl('div', { text: template.name }).style.cssText = 'font-weight: bold; margin-bottom: 4px;';
                templateInfo.createEl('div', { text: `${template.items.length}ê°œ ëª©í‘œ` }).style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
                
                const btnGroup = templateDiv.createDiv();
                btnGroup.style.cssText = 'display: flex; gap: 4px;';
                
                const loadBtn = btnGroup.createEl('button', { text: 'ë¶ˆëŸ¬ì˜¤ê¸°' });
                loadBtn.style.cssText = 'padding: 6px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer;';
                loadBtn.onclick = () => {
                    this.weekData.items = template.items.map(text => ({ 
                        text, 
                        completed: false, 
                        timestamp: Date.now() 
                    }));
                    this.plugin.saveSettings();
                    new Notice(`âœ… í…œí”Œë¦¿ "${template.name}" ë¶ˆëŸ¬ì˜´`);
                    this.refreshCallback();
                    this.close();
                };
                
                const editBtn = btnGroup.createEl('button', { text: 'âœï¸ ìˆ˜ì •' });
                editBtn.style.cssText = 'padding: 6px 12px; background: var(--background-modifier-border); border: none; border-radius: 4px; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
                editBtn.onclick = () => {
                    new TemplateEditModal(this.app, this.plugin, template, 'weekly', () => this.onOpen()).open();
                };
                editBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    editBtn.click();
                });
                
                const deleteBtn = btnGroup.createEl('button', { text: 'ğŸ—‘ï¸ ì‚­ì œ' });
                deleteBtn.style.cssText = 'padding: 6px 12px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer;';
                deleteBtn.onclick = () => {
                    new ConfirmModal(this.app, `"${template.name}" í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, (confirmed) => {
                        if (confirmed) {
                            this.plugin.settings.weeklyTemplates.splice(idx, 1);
                            this.plugin.saveSettings();
                            this.onOpen();
                        }
                    }).open();
                };
            });
        }
    }
}

// ì›”ê°„ í…œí”Œë¦¿ ëª¨ë‹¬
class MonthlyTemplateModal extends Modal {
    constructor(app, plugin, monthData, refreshCallback) {
        super(app);
        this.plugin = plugin;
        this.monthData = monthData;
        this.refreshCallback = refreshCallback;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        const header = contentEl.createDiv();
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;';
        header.createEl('h2', { text: 'ğŸ“‚ ì›”ê°„ í…œí”Œë¦¿' }).style.cssText = 'margin: 0;';
        
        const newTemplateBtn = header.createEl('button', { text: 'â• ìƒˆ í…œí”Œë¦¿' });
        newTemplateBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: bold; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
        newTemplateBtn.onclick = () => {
            new TemplateEditModal(this.app, this.plugin, null, 'monthly', () => this.onOpen()).open();
        };
        newTemplateBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            newTemplateBtn.click();
        });
        
        const templates = this.plugin.settings.monthlyTemplates || [];
        
        if (templates.length === 0) {
            contentEl.createEl('div', { text: 'ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = 'color: var(--text-muted); font-style: italic; padding: 20px; text-align: center;';
        } else {
            templates.forEach((template, idx) => {
                const templateDiv = contentEl.createDiv();
                templateDiv.style.cssText = 'padding: 12px; background: var(--background-secondary); border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;';
                
                const templateInfo = templateDiv.createDiv();
                templateInfo.createEl('div', { text: template.name }).style.cssText = 'font-weight: bold; margin-bottom: 4px;';
                templateInfo.createEl('div', { text: `${template.items.length}ê°œ ëª©í‘œ` }).style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
                
                const btnGroup = templateDiv.createDiv();
                btnGroup.style.cssText = 'display: flex; gap: 4px;';
                
                const loadBtn = btnGroup.createEl('button', { text: 'ë¶ˆëŸ¬ì˜¤ê¸°' });
                loadBtn.style.cssText = 'padding: 6px 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer;';
                loadBtn.onclick = () => {
                    this.monthData.items = template.items.map(text => ({ 
                        text, 
                        completed: false, 
                        timestamp: Date.now() 
                    }));
                    this.plugin.saveSettings();
                    new Notice(`âœ… í…œí”Œë¦¿ "${template.name}" ë¶ˆëŸ¬ì˜´`);
                    this.refreshCallback();
                    this.close();
                };
                
                const editBtn = btnGroup.createEl('button', { text: 'âœï¸ ìˆ˜ì •' });
                editBtn.style.cssText = 'padding: 6px 12px; background: var(--background-modifier-border); border: none; border-radius: 4px; cursor: pointer; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
                editBtn.onclick = () => {
                    new TemplateEditModal(this.app, this.plugin, template, 'monthly', () => this.onOpen()).open();
                };
                editBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    editBtn.click();
                });
                
                const deleteBtn = btnGroup.createEl('button', { text: 'ğŸ—‘ï¸ ì‚­ì œ' });
                deleteBtn.style.cssText = 'padding: 6px 12px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; cursor: pointer;';
                deleteBtn.onclick = () => {
                    new ConfirmModal(this.app, `"${template.name}" í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, (confirmed) => {
                        if (confirmed) {
                            this.plugin.settings.monthlyTemplates.splice(idx, 1);
                            this.plugin.saveSettings();
                            this.onOpen();
                        }
                    }).open();
                };
            });
        }
    }
}

// í´ë” ìˆœì„œ ë³€ê²½ ëª¨ë‹¬
class FolderReorderModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('folder-reorder-modal');
        contentEl.style.cssText = 'padding: 0;';

        // í—¤ë”
        const header = contentEl.createDiv({ cls: 'quiz-modal-header' });
        header.style.cssText = `
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 0 -20px;
        `;
        
        const headerContent = header.createDiv();
        headerContent.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
        
        const headerLeft = headerContent.createDiv();
        headerLeft.createEl('h2', { text: 'ğŸ”€ í´ë” ìˆœì„œ ë³€ê²½' }).style.cssText = 'margin: 0 0 4px 0; font-size: 24px;';
        headerLeft.createEl('p', { text: 'ë²„íŠ¼ìœ¼ë¡œ í´ë” ìˆœì„œë¥¼ ë³€ê²½í•˜ì„¸ìš”' }).style.cssText = 'margin: 0; opacity: 0.9; font-size: 14px;';

        // ë³¸ë¬¸ ì»¨í…Œì´ë„ˆ
        const body = contentEl.createDiv({ cls: 'quiz-modal-body' });
        body.style.cssText = 'padding: 20px;';

        // í˜„ì¬ í´ë” ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        if (!this.plugin.settings.folderOrder) {
            const allQuestions = await this.plugin.loadAllQuestions();
            const folderMap = new Map();
            allQuestions.forEach(q => {
                const folder = q.folder || 'ê¸°ë³¸';
                if (!folderMap.has(folder)) {
                    folderMap.set(folder, []);
                }
            });
            this.plugin.settings.folderOrder = Array.from(folderMap.keys());
            await this.plugin.saveSettings();
        }
        
        this.folderOrder = [...this.plugin.settings.folderOrder];

        // í´ë” ë¦¬ìŠ¤íŠ¸
        const folderList = body.createDiv({ cls: 'folder-reorder-list' });
        folderList.style.cssText = 'display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px;';

        this.renderFolderList(folderList);

        // í•˜ë‹¨ ë²„íŠ¼
        const footer = body.createDiv();
        footer.style.cssText = 'display: flex; gap: 12px; padding-top: 16px; border-top: 1px solid var(--background-modifier-border);';

        const saveBtn = footer.createEl('button', { text: 'âœ… ì €ì¥', cls: 'mod-cta' });
        saveBtn.style.cssText = 'flex: 1; padding: 12px 24px; font-size: 15px; font-weight: 600;';
        saveBtn.onclick = async () => {
            this.plugin.settings.folderOrder = this.folderOrder;
            await this.plugin.saveSettings();
            new Notice('âœ… í´ë” ìˆœì„œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            this.close();
            
            const leaves = this.app.workspace.getLeavesOfType(QUIZ_DASHBOARD_VIEW_TYPE);
            leaves.forEach(leaf => {
                if (leaf.view instanceof QuizDashboardView) {
                    leaf.view.onOpen();
                }
            });
        };

        const cancelBtn = footer.createEl('button', { text: 'ì·¨ì†Œ' });
        cancelBtn.style.cssText = 'flex: 1; padding: 12px 24px; font-size: 15px;';
        cancelBtn.onclick = () => this.close();
    }

    renderFolderList(container) {
        container.empty();

        this.folderOrder.forEach((folderName, index) => {
            const item = container.createDiv({ cls: 'folder-reorder-item' });
            item.style.cssText = `
                padding: 16px;
                background: var(--background-primary-alt);
                border: 2px solid var(--background-modifier-border);
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 12px;
                transition: all 0.2s;
            `;

            item.onmouseenter = () => {
                item.style.borderColor = 'var(--interactive-accent)';
                item.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            };
            item.onmouseleave = () => {
                item.style.borderColor = 'var(--background-modifier-border)';
                item.style.boxShadow = 'none';
            };

            const dragHandle = item.createEl('div', { text: 'â‹®â‹®' });
            dragHandle.style.cssText = `
                font-size: 20px;
                color: var(--text-muted);
                cursor: grab;
                user-select: none;
            `;
            
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
            item.draggable = true;
            item.ondragstart = (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index.toString());
                item.style.opacity = '0.5';
                dragHandle.style.cursor = 'grabbing';
            };
            item.ondragend = (e) => {
                item.style.opacity = '1';
                dragHandle.style.cursor = 'grab';
            };
            item.ondragover = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                item.style.borderColor = 'var(--interactive-accent)';
                item.style.borderWidth = '3px';
            };
            item.ondragleave = (e) => {
                item.style.borderColor = 'var(--background-modifier-border)';
                item.style.borderWidth = '2px';
            };
            item.ondrop = (e) => {
                e.preventDefault();
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const toIndex = index;
                
                if (fromIndex !== toIndex) {
                    const movedItem = this.folderOrder[fromIndex];
                    this.folderOrder.splice(fromIndex, 1);
                    this.folderOrder.splice(toIndex, 0, movedItem);
                    this.renderFolderList(container);
                }
                
                item.style.borderColor = 'var(--background-modifier-border)';
                item.style.borderWidth = '2px';
            };

            const nameDiv = item.createDiv();
            nameDiv.style.cssText = 'flex: 1; font-size: 16px; font-weight: 600;';
            nameDiv.createEl('span', { text: `ğŸ“ ${folderName}` });

            const orderBadge = item.createEl('span', { text: `${index + 1}` });
            orderBadge.style.cssText = `
                padding: 4px 12px;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                border-radius: 12px;
                font-size: 13px;
                font-weight: 600;
            `;

            const btnGroup = item.createDiv();
            btnGroup.style.cssText = 'display: flex; gap: 4px;';

            // âœï¸ ì´ë¦„ ë³€ê²½ ë²„íŠ¼
            const renameBtn = btnGroup.createEl('button', { text: 'âœï¸' });
            renameBtn.style.cssText = `
                padding: 6px 12px;
                background: var(--background-secondary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
                min-height: 32px;
                min-width: 32px;
            `;
            renameBtn.title = 'í´ë” ì´ë¦„ ë³€ê²½';
            renameBtn.onmouseenter = () => {
                renameBtn.style.background = 'var(--interactive-accent)';
                renameBtn.style.transform = 'scale(1.1)';
            };
            renameBtn.onmouseleave = () => {
                renameBtn.style.background = 'var(--background-secondary)';
                renameBtn.style.transform = 'scale(1)';
            };
            renameBtn.onclick = async () => {
                const newName = await this.promptForNewName(folderName);
                if (newName && newName !== folderName) {
                    // ì¤‘ë³µ ì²´í¬
                    if (this.folderOrder.includes(newName)) {
                        new Notice('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í´ë” ì´ë¦„ì…ë‹ˆë‹¤!');
                        return;
                    }
                    
                    // í´ë” ì´ë¦„ ë³€ê²½
                    const oldPath = `${this.plugin.settings.questionsFolder}/${folderName}`;
                    const newPath = `${this.plugin.settings.questionsFolder}/${newName}`;
                    
                    try {
                        // í´ë” ì´ë¦„ ë³€ê²½
                        await this.app.vault.adapter.rename(oldPath, newPath);
                        
                        // folderOrder ì—…ë°ì´íŠ¸
                        this.folderOrder[index] = newName;
                        
                        new Notice(`âœ… í´ë” ì´ë¦„ì´ "${folderName}" â†’ "${newName}"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        this.renderFolderList(container);
                    } catch (error) {
                        console.error('í´ë” ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨:', error);
                        new Notice('âŒ í´ë” ì´ë¦„ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!');
                    }
                }
            };

            // ğŸ—‘ï¸ ì‚­ì œ ë²„íŠ¼
            const deleteBtn = btnGroup.createEl('button', { text: 'ğŸ—‘ï¸' });
            deleteBtn.style.cssText = `
                padding: 6px 12px;
                background: var(--background-secondary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.2s;
                min-height: 32px;
                min-width: 32px;
            `;
            deleteBtn.title = 'í´ë” ì‚­ì œ (ë¬¸ì œë„ í•¨ê»˜ ì‚­ì œë¨)';
            deleteBtn.onmouseenter = () => {
                deleteBtn.style.background = '#dc3545';
                deleteBtn.style.borderColor = '#dc3545';
                deleteBtn.style.transform = 'scale(1.1)';
            };
            deleteBtn.onmouseleave = () => {
                deleteBtn.style.background = 'var(--background-secondary)';
                deleteBtn.style.borderColor = 'var(--background-modifier-border)';
                deleteBtn.style.transform = 'scale(1)';
            };
            deleteBtn.onclick = async () => {
                const confirmDelete = await this.confirmDeleteFolder(folderName);
                if (confirmDelete) {
                    const folderPath = `${this.plugin.settings.questionsFolder}/${folderName}`;
                    
                    try {
                        // í´ë”ì™€ ë‚´ìš© ì‚­ì œ
                        await this.app.vault.adapter.rmdir(folderPath, true);
                        
                        // folderOrderì—ì„œ ì œê±°
                        this.folderOrder.splice(index, 1);
                        
                        new Notice(`âœ… "${folderName}" í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                        this.renderFolderList(container);
                    } catch (error) {
                        console.error('í´ë” ì‚­ì œ ì‹¤íŒ¨:', error);
                        new Notice('âŒ í´ë” ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!');
                    }
                }
            };

            if (index > 0) {
                const upBtn = btnGroup.createEl('button', { text: 'â–²' });
                upBtn.style.cssText = `
                    padding: 6px 12px;
                    background: var(--background-secondary);
                    border: 1px solid var(--background-modifier-border);
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.2s;
                    min-height: 32px;
                    min-width: 32px;
                `;
                upBtn.title = 'ìœ„ë¡œ ì´ë™';
                upBtn.onmouseenter = () => upBtn.style.background = 'var(--interactive-accent)';
                upBtn.onmouseleave = () => upBtn.style.background = 'var(--background-secondary)';
                upBtn.onclick = () => {
                    const temp = this.folderOrder[index];
                    this.folderOrder[index] = this.folderOrder[index - 1];
                    this.folderOrder[index - 1] = temp;
                    this.renderFolderList(container);
                };
            }

            if (index < this.folderOrder.length - 1) {
                const downBtn = btnGroup.createEl('button', { text: 'â–¼' });
                downBtn.style.cssText = `
                    padding: 6px 12px;
                    background: var(--background-secondary);
                    border: 1px solid var(--background-modifier-border);
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 12px;
                    transition: all 0.2s;
                    min-height: 32px;
                    min-width: 32px;
                `;
                downBtn.title = 'ì•„ë˜ë¡œ ì´ë™';
                downBtn.onmouseenter = () => downBtn.style.background = 'var(--interactive-accent)';
                downBtn.onmouseleave = () => downBtn.style.background = 'var(--background-secondary)';
                downBtn.onclick = () => {
                    const temp = this.folderOrder[index];
                    this.folderOrder[index] = this.folderOrder[index + 1];
                    this.folderOrder[index + 1] = temp;
                    this.renderFolderList(container);
                };
            }
        });
    }

    async promptForNewName(oldName) {
        return new Promise((resolve) => {
            const modal = new Modal(this.app);
            modal.titleEl.setText('ğŸ“ í´ë” ì´ë¦„ ë³€ê²½');
            
            const content = modal.contentEl;
            content.style.cssText = 'padding: 20px;';
            
            content.createEl('p', { 
                text: `í˜„ì¬ í´ë” ì´ë¦„: ${oldName}` 
            }).style.cssText = 'margin-bottom: 12px; color: var(--text-muted);';
            
            const input = content.createEl('input', {
                type: 'text',
                value: oldName
            });
            input.style.cssText = `
                width: 100%;
                padding: 10px;
                font-size: 14px;
                border: 2px solid var(--background-modifier-border);
                border-radius: 4px;
                margin-bottom: 16px;
                background: var(--background-primary);
                color: var(--text-normal);
            `;
            input.focus();
            input.select();
            
            const btnGroup = content.createDiv();
            btnGroup.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end;';
            
            const cancelBtn = btnGroup.createEl('button', { text: 'âŒ ì·¨ì†Œ' });
            cancelBtn.style.cssText = `
                padding: 8px 16px;
                background: var(--background-secondary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                cursor: pointer;
            `;
            cancelBtn.onclick = () => {
                modal.close();
                resolve(null);
            };
            
            const okBtn = btnGroup.createEl('button', { text: 'âœ… ë³€ê²½' });
            okBtn.style.cssText = `
                padding: 8px 16px;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
            `;
            okBtn.onclick = () => {
                const newName = input.value.trim();
                modal.close();
                resolve(newName);
            };
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const newName = input.value.trim();
                    modal.close();
                    resolve(newName);
                } else if (e.key === 'Escape') {
                    modal.close();
                    resolve(null);
                }
            });
            
            modal.open();
        });
    }

    async confirmDeleteFolder(folderName) {
        return new Promise((resolve) => {
            new ConfirmModal(
                this.app,
                `ì •ë§ë¡œ "${folderName}" í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ í´ë”ì˜ ëª¨ë“  ë¬¸ì œê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤!\nâš ï¸ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`,
                (confirmed) => {
                    resolve(confirmed);
                }
            ).open();
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ë¬¸ì œ ëª©ë¡ ëª¨ë‹¬ (í¸ì§‘ìš©)
class QuestionListModal extends Modal {
    constructor(app, plugin, folderName) {
        super(app);
        this.plugin = plugin;
        this.folderName = folderName;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.style.cssText = 'padding: 0; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        
        // í—¤ë”
        const header = contentEl.createDiv();
        header.style.cssText = 'padding: 20px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 8px 8px 0 0; margin-bottom: 16px; position: relative;';
        header.createEl('h2', { text: `âœï¸ ${this.folderName} - ë¬¸ì œ í¸ì§‘` }).style.cssText = 'margin: 0;';
        
        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = header.createEl('button', { text: 'âœ•' });
        closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 1.2em; min-height: 44px; min-width: 44px; touch-action: manipulation;';
        closeBtn.onclick = () => this.close();
        
        // ë¬¸ì œ ëª©ë¡
        const listDiv = contentEl.createDiv();
        listDiv.style.cssText = 'padding: 0 20px 20px; max-height: 500px; overflow-y: auto; -webkit-overflow-scrolling: touch;';
        
        const questions = await this.plugin.getQuestionsByFolder(this.folderName);
        
        if (!questions || questions.length === 0) {
            const empty = listDiv.createDiv();
            empty.style.cssText = 'text-align: center; padding: 60px 20px; color: var(--text-muted);';
            empty.textContent = 'ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.';
        } else {
            questions.forEach((q, idx) => {
                const qDiv = listDiv.createDiv();
                qDiv.style.cssText = 'padding: 16px; margin-bottom: 8px; background: var(--background-primary-alt); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; transition: all 0.2s; touch-action: manipulation; -webkit-tap-highlight-color: transparent; min-height: 44px;';
                qDiv.addEventListener('mouseenter', () => {
                    qDiv.style.background = 'var(--background-modifier-hover)';
                });
                qDiv.addEventListener('mouseleave', () => {
                    qDiv.style.background = 'var(--background-primary-alt)';
                });
                
                const questionText = qDiv.createDiv();
                questionText.style.cssText = 'font-weight: 500; margin-bottom: 4px;';
                questionText.textContent = `${idx + 1}. ${q.question || q.id}`;
                
                if (q.answer) {
                    const answerText = qDiv.createDiv();
                    answerText.style.cssText = 'color: var(--text-muted); font-size: 0.9em;';
                    answerText.textContent = `ë‹µ: ${q.answer}`;
                }
                
                qDiv.addEventListener('click', () => {
                    this.close();
                    const modal = new HanziQuestionModal(this.app, this.plugin);
                    modal.editMode = true;
                    modal.question = { ...q };
                    modal.open();
                });
            });
        }
    }
    
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// í´ë”ë³„ í•™ìŠµ ê¸°ë¡ ëª¨ë‹¬
class FolderHistoryModal extends Modal {
    constructor(app, plugin, folderName) {
        super(app);
        this.plugin = plugin;
        this.folderName = folderName;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.style.cssText = 'padding: 0; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        
        // í—¤ë”
        const header = contentEl.createDiv();
        header.style.cssText = 'padding: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 8px 8px 0 0; margin-bottom: 16px;';
        
        const headerTop = header.createDiv();
        headerTop.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        headerTop.createEl('h2', { text: `ğŸ“Š ${this.folderName} - í•™ìŠµ ê¸°ë¡` }).style.cssText = 'margin: 0;';
        
        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = headerTop.createEl('button', { text: 'âœ•' });
        closeBtn.style.cssText = 'background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 1.2em; min-height: 44px; min-width: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const closeBtnHandler = () => this.close();
        closeBtn.onclick = closeBtnHandler;
        closeBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            closeBtnHandler();
        });
        
        // ì´ˆê¸°í™” ë²„íŠ¼
        const clearBtn = header.createEl('button', { text: 'ğŸ—‘ï¸ ì´ í´ë” ê¸°ë¡ ì „ì²´ ì‚­ì œ' });
        clearBtn.style.cssText = 'width: 100%; padding: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const clearBtnHandler = async () => {
            if (confirm(`ì •ë§ë¡œ "${this.folderName}" í´ë”ì˜ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                this.plugin.settings.stats.studyHistory = this.plugin.settings.stats.studyHistory.filter(h => {
                    const recordFolder = h.folderName || h.folder || '';
                    return recordFolder !== this.folderName;
                });
                await this.plugin.saveSettings();
                new Notice('âœ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                this.onOpen();
            }
        };
        clearBtn.onclick = clearBtnHandler;
        clearBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            clearBtnHandler();
        });
        
        // í•™ìŠµ ê¸°ë¡ ëª©ë¡
        const historyDiv = contentEl.createDiv();
        historyDiv.style.cssText = 'padding: 0 20px 20px; max-height: 500px; overflow-y: auto; -webkit-overflow-scrolling: touch;';
        
        // statsê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
        if (!this.plugin.settings.stats) {
            this.plugin.settings.stats = { studyHistory: [] };
        }
        
        console.log('ğŸ“Š ì „ì²´ í•™ìŠµ ê¸°ë¡:', this.plugin.settings.stats.studyHistory);
        console.log('ğŸ“ ì°¾ëŠ” í´ë”ëª…:', this.folderName);
        
        const folderHistory = this.plugin.settings.stats.studyHistory?.filter(h => {
            const recordFolder = h.folderName || h.folder || '';
            console.log('  - ê¸°ë¡ì˜ í´ë”:', recordFolder, 'ë¹„êµ:', this.folderName);
            // ì •í™•í•œ í´ë”ëª… ì¼ì¹˜ë§Œ í—ˆìš©
            return recordFolder === this.folderName;
        }) || [];
        
        console.log('ğŸ“Š í´ë”ë³„ ê¸°ë¡:', this.folderName, folderHistory);
        
        if (folderHistory.length === 0) {
            const empty = historyDiv.createDiv();
            empty.style.cssText = 'text-align: center; padding: 60px 20px; color: var(--text-muted);';
            empty.textContent = 'í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
        } else {
            // ìµœì‹ ìˆœ ì •ë ¬
            const sortedHistory = [...folderHistory].reverse();
            
            sortedHistory.forEach((record, idx) => {
                const recordDiv = historyDiv.createDiv();
                recordDiv.style.cssText = 'padding: 16px; margin-bottom: 12px; background: var(--background-primary-alt); border: 1px solid var(--background-modifier-border); border-radius: 8px; touch-action: manipulation; position: relative;';
                
                // ì‚­ì œ ë²„íŠ¼ (ìš°ìƒë‹¨)
                const deleteBtn = recordDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                deleteBtn.style.cssText = 'position: absolute; top: 12px; right: 12px; background: var(--background-modifier-error); color: white; border: none; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 0.9em; min-height: 36px; min-width: 36px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
                const deleteBtnHandler = async () => {
                    if (confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        const originalIndex = this.plugin.settings.stats.studyHistory.length - 1 - idx;
                        this.plugin.settings.stats.studyHistory.splice(originalIndex, 1);
                        await this.plugin.saveSettings();
                        new Notice('âœ… ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                        this.onOpen();
                    }
                };
                deleteBtn.onclick = deleteBtnHandler;
                deleteBtn.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    deleteBtnHandler();
                });
                
                const headerDiv = recordDiv.createDiv();
                headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; padding-right: 40px;';
                
                const date = new Date(record.timestamp || record.date);
                const timeStr = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                headerDiv.createEl('strong', { text: timeStr }).style.cssText = 'color: var(--interactive-accent); font-size: 0.9em; font-family: monospace;';
                
                // í†µê³„
                const statsDiv = recordDiv.createDiv();
                statsDiv.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px;';
                
                const statBox = (label, value, color) => {
                    const box = statsDiv.createDiv();
                    box.style.cssText = `text-align: center; padding: 12px 8px; background: var(--background-secondary); border-radius: 4px; border-left: 3px solid ${color}; min-height: 44px;`;
                    box.createEl('div', { text: value }).style.cssText = `font-size: 1.2em; font-weight: bold; color: ${color};`;
                    box.createEl('div', { text: label }).style.cssText = 'font-size: 0.75em; color: var(--text-muted); margin-top: 4px;';
                };
                
                const total = record.total || 0;
                const correct = record.correct || 0;
                const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
                
                statBox('ì´ ë¬¸ì œ', `${total}ê°œ`, '#3b82f6');
                statBox('ì •ë‹µ', `${correct}ê°œ`, '#10b981');
                statBox('ì •ë‹µë¥ ', `${accuracy}%`, '#f59e0b');
                
                // ì˜¤ë‹µ ì •ë³´
                if (record.wrong && record.wrong.length > 0) {
                    const wrongDiv = recordDiv.createDiv();
                    wrongDiv.style.cssText = 'margin-top: 8px; padding: 12px; background: var(--background-secondary); border-radius: 4px;';
                    wrongDiv.createEl('div', { text: `âŒ ì˜¤ë‹µ ${record.wrong.length}ê°œ` }).style.cssText = 'font-size: 0.85em; color: var(--text-error); margin-bottom: 8px; font-weight: 500;';
                    
                    const wrongList = wrongDiv.createDiv();
                    wrongList.style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
                    record.wrong.slice(0, 3).forEach(w => {
                        const wrongItem = wrongList.createDiv();
                        wrongItem.style.cssText = 'padding: 4px 0;';
                        wrongItem.textContent = `â€¢ ${w.question || w.id}`;
                    });
                    if (record.wrong.length > 3) {
                        wrongList.createDiv({ text: `... ì™¸ ${record.wrong.length - 3}ê°œ` }).style.cssText = 'padding: 4px 0; font-style: italic;';
                    }
                }
            });
        }
    }
    
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class EditHistoryModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.style.cssText = 'padding: 0; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        
        // í—¤ë”
        const header = contentEl.createDiv();
        header.style.cssText = 'padding: 20px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 8px 8px 0 0; margin-bottom: 16px;';
        
        const headerTop = header.createDiv();
        headerTop.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        headerTop.createEl('h2', { text: 'ğŸ“Š ì „ì²´ í•™ìŠµ ìƒì„¸ê¸°ë¡' }).style.cssText = 'margin: 0;';
        
        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = headerTop.createEl('button', { text: 'âœ•' });
        closeBtn.style.cssText = 'background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 1.2em; min-height: 44px; min-width: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const closeBtnHandler = () => this.close();
        closeBtn.onclick = closeBtnHandler;
        closeBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            closeBtnHandler();
        });
        
        // ì „ì²´ ì´ˆê¸°í™” ë²„íŠ¼
        const clearAllBtn = header.createEl('button', { text: 'ğŸ—‘ï¸ ì „ì²´ í•™ìŠµ ê¸°ë¡ ì‚­ì œ' });
        clearAllBtn.style.cssText = 'width: 100%; padding: 10px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; min-height: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent;';
        const clearAllBtnHandler = async () => {
            if (confirm('âš ï¸ ì •ë§ë¡œ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                this.plugin.settings.stats.studyHistory = [];
                await this.plugin.saveSettings();
                new Notice('âœ… ëª¨ë“  í•™ìŠµ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                this.onOpen();
            }
        };
        clearAllBtn.onclick = clearAllBtnHandler;
        clearAllBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            clearAllBtnHandler();
        });
        
        // í•™ìŠµ ê¸°ë¡ ëª©ë¡
        const historyDiv = contentEl.createDiv({ cls: 'edit-history-list' });
        historyDiv.style.cssText = 'padding: 0 20px 20px; max-height: 500px; overflow-y: auto; -webkit-overflow-scrolling: touch;';
        
        if (!this.plugin.settings.stats) {
            this.plugin.settings.stats = { studyHistory: [] };
        }
        
        const studyHistory = this.plugin.settings.stats.studyHistory || [];
        
        console.log('ğŸ“Š ì „ì²´ í•™ìŠµ ê¸°ë¡ ìˆ˜:', studyHistory.length);
        
        if (studyHistory.length === 0) {
            const empty = historyDiv.createDiv();
            empty.style.cssText = 'text-align: center; padding: 60px 20px; color: var(--text-muted);';
            empty.textContent = 'ì•„ì§ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.';
        } else {
            // í´ë”ë³„ë¡œ ê·¸ë£¹í™”
            const folderGroups = {};
            studyHistory.forEach(record => {
                const folder = record.folderName || record.folder || 'ì „ì²´';
                if (!folderGroups[folder]) {
                    folderGroups[folder] = [];
                }
                folderGroups[folder].push(record);
            });
            
            console.log('ğŸ“ í´ë”ë³„ ê·¸ë£¹:', Object.keys(folderGroups));
            
            // í´ë”ë³„ ì„¹ì…˜ ìƒì„±
            Object.keys(folderGroups).forEach(folderName => {
                const folderSection = historyDiv.createDiv();
                folderSection.style.cssText = 'margin-bottom: 24px;';
                
                // í´ë” í—¤ë”
                const folderHeader = folderSection.createDiv();
                folderHeader.style.cssText = 'padding: 12px; background: var(--background-secondary); border-radius: 6px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;';
                folderHeader.createEl('h3', { text: `ğŸ“ ${folderName}` }).style.cssText = 'margin: 0; font-size: 1.1em;';
                folderHeader.createEl('span', { text: `${folderGroups[folderName].length}ê°œ ê¸°ë¡` }).style.cssText = 'font-size: 0.9em; color: var(--text-muted);';
                
                // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                const sortedRecords = [...folderGroups[folderName]].reverse();
                
                sortedRecords.slice(0, 5).forEach((record, idx) => {
                    const recordDiv = folderSection.createDiv();
                    recordDiv.style.cssText = 'padding: 16px; margin-bottom: 12px; background: var(--background-primary-alt); border: 1px solid var(--background-modifier-border); border-radius: 8px; touch-action: manipulation; position: relative;';
                    
                    // ì‚­ì œ ë²„íŠ¼
                    const deleteBtn = recordDiv.createEl('button', { text: 'ğŸ—‘ï¸' });
                    deleteBtn.style.cssText = 'position: absolute; top: 12px; right: 12px; background: rgba(239, 68, 68, 0.9); color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-height: 44px; min-width: 44px; touch-action: manipulation; -webkit-tap-highlight-color: transparent; z-index: 10;';
                    const deleteBtnHandler = async () => {
                        if (confirm('ì´ í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            const recordIndex = this.plugin.settings.stats.studyHistory.indexOf(record);
                            if (recordIndex !== -1) {
                                this.plugin.settings.stats.studyHistory.splice(recordIndex, 1);
                                await this.plugin.saveSettings();
                                new Notice('âœ… í•™ìŠµ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                this.onOpen();
                            }
                        }
                    };
                    deleteBtn.onclick = deleteBtnHandler;
                    deleteBtn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteBtnHandler();
                    });
                    
                    const headerDiv = recordDiv.createDiv();
                    headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px; padding-right: 50px;';
                    
                    const date = new Date(record.timestamp || record.date);
                    const timeStr = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                    headerDiv.createEl('strong', { text: timeStr }).style.cssText = 'color: var(--interactive-accent); font-size: 0.9em; font-family: monospace;';
                    
                    // í†µê³„
                    const statsDiv = recordDiv.createDiv();
                    statsDiv.style.cssText = 'display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px;';
                    
                    const statBox = (label, value, color) => {
                        const box = statsDiv.createDiv();
                        box.style.cssText = `text-align: center; padding: 12px 8px; background: var(--background-secondary); border-radius: 4px; border-left: 3px solid ${color}; min-height: 44px;`;
                        box.createEl('div', { text: value }).style.cssText = `font-size: 1.2em; font-weight: bold; color: ${color};`;
                        box.createEl('div', { text: label }).style.cssText = 'font-size: 0.75em; color: var(--text-muted); margin-top: 4px;';
                    };
                    
                    const total = record.total || 0;
                    const correct = record.correct || 0;
                    const accuracy = total > 0 ? Math.round((correct / total) * 100) : 0;
                    
                    statBox('ì´ ë¬¸ì œ', `${total}ê°œ`, '#3b82f6');
                    statBox('ì •ë‹µ', `${correct}ê°œ`, '#10b981');
                    statBox('ì •ë‹µë¥ ', `${accuracy}%`, '#f59e0b');
                    
                    // ì˜¤ë‹µ ì •ë³´
                    if (record.wrong && record.wrong.length > 0) {
                        const wrongDiv = recordDiv.createDiv();
                        wrongDiv.style.cssText = 'margin-top: 8px; padding: 12px; background: var(--background-secondary); border-radius: 4px;';
                        wrongDiv.createEl('div', { text: `âŒ ì˜¤ë‹µ ${record.wrong.length}ê°œ` }).style.cssText = 'font-size: 0.85em; color: var(--text-error); margin-bottom: 8px; font-weight: 500;';
                        
                        const wrongList = wrongDiv.createDiv();
                        wrongList.style.cssText = 'font-size: 0.85em; color: var(--text-muted);';
                        record.wrong.slice(0, 3).forEach(w => {
                            const wrongItem = wrongList.createDiv();
                            wrongItem.style.cssText = 'padding: 4px 0;';
                            wrongItem.textContent = `â€¢ ${w.question || w.id}`;
                        });
                        if (record.wrong.length > 3) {
                            wrongList.createDiv({ text: `... ì™¸ ${record.wrong.length - 3}ê°œ` }).style.cssText = 'padding: 4px 0; font-style: italic;';
                        }
                    }
                });
                
                // ë”ë³´ê¸° ë²„íŠ¼ (5ê°œ ì´ìƒì¼ ê²½ìš°)
                if (folderGroups[folderName].length > 5) {
                    const moreBtn = folderSection.createEl('button', { 
                        text: `ğŸ“‹ ${folderGroups[folderName].length - 5}ê°œ ë”ë³´ê¸°` 
                    });
                    moreBtn.style.cssText = 'width: 100%; padding: 10px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; touch-action: manipulation; min-height: 44px; -webkit-tap-highlight-color: transparent;';
                    const moreBtnHandler = () => {
                        this.close();
                        new FolderHistoryModal(this.app, this.plugin, folderName).open();
                    };
                    moreBtn.onclick = moreBtnHandler;
                    moreBtn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        moreBtnHandler();
                    });
                }
            });
        }
    }
    
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class DashboardModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
        this.logHistory = [];
    }
    // ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ëŠ” ë©”ì„œë“œ
    appendLog(message) {
        if (!this.logHistory) this.logHistory = [];
        this.logHistory.push({
            timestamp: new Date().toLocaleString(),
            message
        });
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('hanzi-quiz-dashboard');

        const isMobile = this.app.isMobile || window.innerWidth <= 768;
        
        const header = contentEl.createDiv({ cls: 'dashboard-header' });
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
        
        header.createEl('h1', { text: 'ğŸ† í•œì í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ' });
        
        const headerButtons = header.createDiv({ cls: 'header-buttons' });
        headerButtons.style.cssText = 'display: flex; gap: 10px; align-items: center;';
        
        const gitBtn = headerButtons.createEl('button', { text: 'ğŸ”§ Git' });
        gitBtn.style.cssText = `padding: ${isMobile ? '10px 14px' : '8px 16px'}; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; min-height: ${isMobile ? '40px' : 'auto'}; touch-action: manipulation; -webkit-tap-highlight-color: transparent; font-weight: 600; box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);`;
        gitBtn.onclick = () => {
            new GitSettingsModal(this.app, this.plugin).open();
        };
        gitBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            new GitSettingsModal(this.app, this.plugin).open();
        });
        gitBtn.addEventListener('mouseenter', () => {
            gitBtn.style.transform = 'translateY(-2px)';
            gitBtn.style.boxShadow = '0 4px 8px rgba(102, 126, 234, 0.4)';
        });
        gitBtn.addEventListener('mouseleave', () => {
            gitBtn.style.transform = 'translateY(0)';
            gitBtn.style.boxShadow = '0 2px 4px rgba(102, 126, 234, 0.3)';
        });
        
        const settingsBtn = headerButtons.createEl('button', { text: 'âš™ï¸ ì„¤ì •' });
        settingsBtn.style.cssText = `padding: ${isMobile ? '10px 14px' : '8px 16px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-size: 0.9em; min-height: ${isMobile ? '40px' : 'auto'}; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
        settingsBtn.onclick = () => {
            this.app.setting.open();
            this.app.setting.openTabById('quiz-sp2');
        };
        settingsBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.app.setting.open();
            this.app.setting.openTabById('quiz-sp2');
        });

        const stats = this.plugin.settings.stats;
        const questions = await this.plugin.loadAllQuestions();

        // í†µê³„ ì¹´ë“œ (ìƒë‹¨)
        const statsSection = contentEl.createDiv({ cls: 'stats-section' });
        statsSection.style.marginBottom = '30px';
        
        const statsGrid = statsSection.createDiv({ cls: 'stats-grid' });
        statsGrid.style.cssText = `
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        `;
        
        // í†µê³„ ë°ì´í„° ê³„ì‚°
        const totalQuestions = questions.length;
        const bookmarkedQuestions = questions.filter(q => {
            if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
            if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
            return false;
        }).length;
        const wrongQuestions = questions.filter(q => q.wrongCount > 0).length;
        const totalCorrect = questions.reduce((sum, q) => sum + (q.correctCount || 0), 0);
        const totalWrong = questions.reduce((sum, q) => sum + (q.wrongCount || 0), 0);
        const totalAttempts = totalCorrect + totalWrong;
        const accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;
        
        const statsData = [
            { icon: 'ğŸ“š', value: totalQuestions, label: 'ì´ ë¬¸ì œìˆ˜', color: '#667eea' },
            { icon: 'â­', value: bookmarkedQuestions, label: 'ë¶ë§ˆí¬', color: '#ffa500' },
            { icon: 'âŒ', value: wrongQuestions, label: 'ì˜¤ë‹µ ë¬¸ì œ', color: '#f56565' },
            { icon: 'ğŸ¯', value: `${accuracy}%`, label: 'ì •ë‹µë¥ ', color: '#48bb78' },
            { icon: 'ğŸ”¥', value: stats.studyHistory?.length || 0, label: 'í•™ìŠµ ì¼ìˆ˜', color: '#ed8936' },
            { icon: 'â±ï¸', value: totalAttempts, label: 'ì´ ì‹œë„', color: '#4299e1' }
        ];
        
        statsData.forEach(stat => {
            const card = statsGrid.createDiv({ cls: 'stat-card' });
            card.style.cssText = `
                background: linear-gradient(135deg, ${stat.color}15 0%, ${stat.color}30 100%);
                padding: ${isMobile ? '16px' : '20px'};
                border-radius: 12px;
                text-align: center;
                border: 2px solid ${stat.color}40;
                transition: all 0.3s;
                cursor: pointer;
                min-height: ${isMobile ? '100px' : '120px'};
                -webkit-tap-highlight-color: rgba(0,0,0,0.05);
                touch-action: manipulation;
                user-select: none;
            `;
            
            card.onmouseenter = () => {
                card.style.transform = 'translateY(-5px)';
                card.style.boxShadow = `0 8px 20px ${stat.color}30`;
            };
            card.onmouseleave = () => {
                card.style.transform = 'translateY(0)';
                card.style.boxShadow = 'none';
            };
            
            // í„°ì¹˜ í”¼ë“œë°±
            card.addEventListener('touchstart', () => {
                card.style.opacity = '0.8';
            });
            card.addEventListener('touchend', () => {
                card.style.opacity = '1';
            });
            
            const icon = card.createEl('div', { text: stat.icon });
            icon.style.cssText = `font-size: ${isMobile ? '32px' : '36px'}; margin-bottom: ${isMobile ? '8px' : '10px'};`;
            
            const value = card.createEl('div', { text: String(stat.value) });
            value.style.cssText = `font-size: ${isMobile ? '24px' : '28px'}; font-weight: bold; color: ${stat.color}; margin-bottom: 5px;`;
            
            const label = card.createEl('div', { text: stat.label });
            label.style.cssText = `font-size: ${isMobile ? '12px' : '13px'}; color: var(--text-muted); font-weight: 600;`;
        });

        // ğŸ“‚ í´ë”ë³„ í€´ì¦ˆ (ìµœìƒë‹¨)
        const foldersSection = contentEl.createDiv({ cls: 'folders-section' });
        const foldersHeader = foldersSection.createDiv();
        foldersHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        
        const foldersTitle = foldersHeader.createEl('h2', { text: 'ğŸ“‚ í´ë”ë³„ í€´ì¦ˆ' });
        foldersTitle.style.cssText = 'margin: 0; font-size: 18px; font-weight: bold;';
        
        // ì •ë ¬ ë²„íŠ¼
        const sortFolders = foldersHeader.createEl('button', { text: 'â‡… ì •ë ¬' });
        sortFolders.style.cssText = `padding: ${isMobile ? '8px 12px' : '6px 12px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-size: 13px; min-height: ${isMobile ? '40px' : 'auto'}; touch-action: manipulation;`;
        sortFolders.onclick = () => {
            const menu = new Menu();
            
            menu.addItem((item) => {
                item.setTitle('ê¸°ë³¸ ìˆœì„œ')
                    .setIcon('list')
                    .onClick(() => {
                        this.plugin.settings.folderSortOrder = 'default';
                        this.plugin.saveSettings();
                        this.onOpen();
                    });
            });
            
            menu.addItem((item) => {
                item.setTitle('ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)')
                    .setIcon('sort-asc')
                    .onClick(() => {
                        this.plugin.settings.folderSortOrder = 'name';
                        this.plugin.saveSettings();
                        this.onOpen();
                    });
            });
            
            menu.addItem((item) => {
                item.setTitle('ë¬¸ì œìˆ˜ ë§ì€ìˆœ')
                    .setIcon('sort-desc')
                    .onClick(() => {
                        this.plugin.settings.folderSortOrder = 'count-desc';
                        this.plugin.saveSettings();
                        this.onOpen();
                    });
            });
            
            menu.addItem((item) => {
                item.setTitle('ë¬¸ì œìˆ˜ ì ì€ìˆœ')
                    .setIcon('sort-asc')
                    .onClick(() => {
                        this.plugin.settings.folderSortOrder = 'count-asc';
                        this.plugin.saveSettings();
                        this.onOpen();
                    });
            });
            
            menu.showAtMouseEvent(event);
        };

        const foldersGrid = foldersSection.createDiv({ cls: 'folders-grid' });
        foldersGrid.style.cssText = `
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        `;
        
        // ë¶ë§ˆí¬ í´ë”ë¥¼ ë§¨ ì•ì— ì¶”ê°€
        const bookmarkFolderName = this.plugin.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬';
        // ìƒˆë¡œìš´ bookmarkFolder ë°©ì‹ìœ¼ë¡œ ê³„ì‚° (ë¬¸ì œ ë¶ë§ˆí¬ + ì„ íƒì§€ ë¶ë§ˆí¬)
        const allBookmarkedQuestions = questions.filter(q => {
            // ë¬¸ì œ ë¶ë§ˆí¬ê°€ ìˆê±°ë‚˜ ì„ íƒì§€ ë¶ë§ˆí¬ê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ í¬í•¨
            if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
            if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
            return false;
        });
        
        if (allBookmarkedQuestions.length > 0) {
            const folderCard = foldersGrid.createDiv({ cls: 'folder-quiz-card bookmark-folder-card' });
            folderCard.style.cssText = `
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                padding: 15px;
                border-radius: 10px;
                color: #000;
                transition: all 0.3s;
                box-shadow: 0 3px 10px rgba(255, 165, 0, 0.4);
                position: relative;
                overflow: hidden;
                border: 2px solid #FF8C00;
            `;
            
            folderCard.onmouseenter = () => {
                folderCard.style.transform = 'translateY(-3px)';
                folderCard.style.boxShadow = '0 6px 20px rgba(255, 140, 0, 0.5)';
            };
            folderCard.onmouseleave = () => {
                folderCard.style.transform = 'translateY(0)';
                folderCard.style.boxShadow = '0 3px 10px rgba(255, 165, 0, 0.4)';
            };
            
            const mainArea = folderCard.createDiv();
            mainArea.style.cssText = 'cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 48px;';
            mainArea.innerHTML = `
                <div style="font-size: 28px; margin-bottom: 6px;">â­</div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 6px;">${bookmarkFolderName}</div>
                <div style="font-size: 22px; font-weight: bold; margin-bottom: 8px;">${allBookmarkedQuestions.length}ë¬¸ì œ</div>
                <div style="display: flex; gap: 8px; justify-content: center; font-size: 11px; opacity: 0.9; margin-bottom: 10px;">
                    <span>ë¶ë§ˆí¬ ì „ìš©</span>
                </div>
            `;
            
            const bookmarkClickHandler = (e) => {
                e.stopPropagation();
                this.close();
                this.plugin.startQuiz(null, false, bookmarkFolderName);
            };
            mainArea.addEventListener('click', bookmarkClickHandler);
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ ê°œì„  (ìŠ¤í¬ë¡¤ê³¼ íƒ­ êµ¬ë¶„)
            let touchStartY = 0;
            let touchStartX = 0;
            mainArea.addEventListener('touchstart', (e) => {
                touchStartY = e.touches[0].clientY;
                touchStartX = e.touches[0].clientX;
            });
            mainArea.addEventListener('touchend', (e) => {
                const touchEndY = e.changedTouches[0].clientY;
                const touchEndX = e.changedTouches[0].clientX;
                const deltaY = Math.abs(touchEndY - touchStartY);
                const deltaX = Math.abs(touchEndX - touchStartX);
                
                // ì´ë™ ê±°ë¦¬ê°€ 10px ë¯¸ë§Œì´ë©´ íƒ­ìœ¼ë¡œ ì¸ì‹
                if (deltaY < 10 && deltaX < 10) {
                    e.preventDefault();
                    bookmarkClickHandler(e);
                }
            });
            
            // ë¯¸ë‹ˆ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ë¶ë§ˆí¬ìš©)
            const miniButtons = folderCard.createDiv();
            miniButtons.style.cssText = `
                display: flex;
                gap: 5px;
                justify-content: center;
            `;
            
            // ë¶ë§ˆí¬ í†µê³„ ë²„íŠ¼
            const statsBtn = miniButtons.createEl('button');
            statsBtn.innerHTML = 'ğŸ“Š';
            statsBtn.style.cssText = `
                background: rgba(0,0,0,0.1);
                border: 1px solid rgba(0,0,0,0.2);
                color: #000;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
                font-weight: 600;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                min-height: 44px;
                min-width: 44px;
            `;
            statsBtn.onmouseenter = () => {
                statsBtn.style.background = 'rgba(0,0,0,0.15)';
            };
            statsBtn.onmouseleave = () => {
                statsBtn.style.background = 'rgba(0,0,0,0.1)';
            };
            statsBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // ë¶ë§ˆí¬ í†µê³„ ë³´ê¸°
                alert(`â­ ${bookmarkFolderName} í†µê³„\n\nì´ ë¬¸ì œ: ${allBookmarkedQuestions.length}ê°œ\n\nê° í´ë”ë³„ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`);
            });
        }
        
        // í´ë”ë³„ ë¶ë§ˆí¬ ì„œë¸Œí´ë” í‘œì‹œ
        const folders = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        for (const folder of folders) {
            const bookmarkQuestions = questions.filter(q => q.bookmarkFolder === folder);
            
            if (bookmarkQuestions.length > 0) {
                const bookmarkCard = foldersGrid.createDiv({ cls: 'folder-quiz-card bookmark-subfolder-card' });
                bookmarkCard.style.cssText = `
                    background: linear-gradient(135deg, #FFE680 0%, #FFD700 100%);
                    padding: 15px;
                    border-radius: 10px;
                    color: #000;
                    transition: all 0.3s;
                    box-shadow: 0 3px 10px rgba(255, 165, 0, 0.3);
                    position: relative;
                    overflow: hidden;
                    border: 2px solid #FFA500;
                `;
                
                bookmarkCard.onmouseenter = () => {
                    bookmarkCard.style.transform = 'translateY(-3px)';
                    bookmarkCard.style.boxShadow = '0 6px 20px rgba(255, 165, 0, 0.4)';
                };
                bookmarkCard.onmouseleave = () => {
                    bookmarkCard.style.transform = 'translateY(0)';
                    bookmarkCard.style.boxShadow = '0 3px 10px rgba(255, 165, 0, 0.3)';
                };
                
                const mainArea = bookmarkCard.createDiv();
                mainArea.style.cssText = 'cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 48px;';
                mainArea.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 4px;">â­ğŸ“</div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 4px;">${folder}</div>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">${bookmarkQuestions.length}</div>
                `;
                
                const bookmarkSubClickHandler = (e) => {
                    e.stopPropagation();
                    this.close();
                    this.plugin.startQuiz(null, false, `${bookmarkFolderName}/${folder}`);
                };
                mainArea.addEventListener('click', bookmarkSubClickHandler);
                
                let bTouchStartY = 0;
                let bTouchStartX = 0;
                mainArea.addEventListener('touchstart', (e) => {
                    bTouchStartY = e.touches[0].clientY;
                    bTouchStartX = e.touches[0].clientX;
                });
                mainArea.addEventListener('touchend', (e) => {
                    const touchEndY = e.changedTouches[0].clientY;
                    const touchEndX = e.changedTouches[0].clientX;
                    const deltaY = Math.abs(touchEndY - bTouchStartY);
                    const deltaX = Math.abs(touchEndX - bTouchStartX);
                    
                    if (deltaY < 10 && deltaX < 10) {
                        e.preventDefault();
                        bookmarkSubClickHandler(e);
                    }
                });
                
                // ë¯¸ë‹ˆ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ë¶ë§ˆí¬ ì„œë¸Œí´ë”ìš©)
                const miniButtons = bookmarkCard.createDiv();
                miniButtons.style.cssText = `
                    display: flex;
                    gap: 5px;
                    justify-content: center;
                `;
                
                // ë³´ê¸° ë²„íŠ¼
                const viewBtn = miniButtons.createEl('button');
                viewBtn.innerHTML = 'ğŸ‘ï¸';
                viewBtn.style.cssText = `
                    background: rgba(0,0,0,0.1);
                    border: 1px solid rgba(0,0,0,0.2);
                    color: #000;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 13px;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-weight: 600;
                    -webkit-tap-highlight-color: transparent;
                    touch-action: manipulation;
                    min-height: 44px;
                    min-width: 44px;
                `;
                viewBtn.onmouseenter = () => {
                    viewBtn.style.background = 'rgba(0,0,0,0.15)';
                };
                viewBtn.onmouseleave = () => {
                    viewBtn.style.background = 'rgba(0,0,0,0.1)';
                };
                viewBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.close();
                    new QuestionListModal(this.app, this.plugin, `${bookmarkFolderName}/${folder}`).open();
                });
            }
        }
        
        // ì¼ë°˜ í´ë”ë“¤ (ì •ë ¬ ì ìš©)
        let foldersForQuiz = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        let folderData = foldersForQuiz.map(folder => {
            const folderQuestions = questions.filter(q => (q.folder || 'ê¸°ë³¸') === folder);
            const folderCount = folderQuestions.length;
            const folderBookmarked = folderQuestions.filter(q => {
                if (q.bookmarkFolder === folder) return true;
                if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f === folder)) return true;
                return false;
            }).length;
            const folderWrong = folderQuestions.filter(q => q.wrongCount > 0).length;
            
            return { folder, folderCount, folderBookmarked, folderWrong, folderQuestions };
        });
        
        // ì •ë ¬ ì ìš©
        const folderSortOrder = this.plugin.settings.folderSortOrder || 'default';
        if (folderSortOrder === 'name') {
            folderData.sort((a, b) => a.folder.localeCompare(b.folder));
        } else if (folderSortOrder === 'count-desc') {
            folderData.sort((a, b) => b.folderCount - a.folderCount);
        } else if (folderSortOrder === 'count-asc') {
            folderData.sort((a, b) => a.folderCount - b.folderCount);
        }
        
        for (const { folder, folderCount, folderBookmarked, folderWrong, folderQuestions } of folderData) {
            
            const folderCard = foldersGrid.createDiv({ cls: 'folder-quiz-card' });
            folderCard.style.cssText = `
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                padding: 15px;
                border-radius: 10px;
                color: #fff;
                transition: all 0.3s;
                box-shadow: 0 3px 10px rgba(59, 130, 246, 0.3);
                position: relative;
                overflow: hidden;
            `;
            
            folderCard.onmouseenter = () => {
                folderCard.style.transform = 'translateY(-3px)';
                folderCard.style.boxShadow = '0 6px 20px rgba(59, 130, 246, 0.4)';
            };
            folderCard.onmouseleave = () => {
                folderCard.style.transform = 'translateY(0)';
                folderCard.style.boxShadow = '0 3px 10px rgba(59, 130, 246, 0.3)';
            };
            
            // ì¹´ë“œ ë©”ì¸ ì˜ì—­
            const mainArea = folderCard.createDiv();
            mainArea.style.cssText = 'cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 48px;';
            mainArea.innerHTML = `
                <div style="font-size: 28px; margin-bottom: 6px;">ğŸ“</div>
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 6px;">${folder}</div>
                <div style="font-size: 22px; font-weight: bold; margin-bottom: 8px;">${folderCount}ë¬¸ì œ</div>
                <div style="display: flex; gap: 8px; justify-content: center; font-size: 11px; opacity: 0.9; margin-bottom: 10px;">
                    <span>â­${folderBookmarked}</span>
                    <span>âŒ${folderWrong}</span>
                </div>
            `;
            
            // í€´ì¦ˆ ì‹œì‘
            const folderClickHandler = (e) => {
                e.stopPropagation();
                // ì´ í´ë”ì˜ ë¶ë§ˆí¬ ë¬¸ì œë“¤ì„ ê·¸ë£¹í™”
                const bookmarksByFolder = {};
                for (const q of folderQuestions) {
                    if (q.bookmarkFolder) {
                        if (!bookmarksByFolder[q.bookmarkFolder]) {
                            bookmarksByFolder[q.bookmarkFolder] = [];
                        }
                        bookmarksByFolder[q.bookmarkFolder].push(q);
                    }
                }

                // ë¶ë§ˆí¬ê°€ ìˆìœ¼ë©´ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
                if (Object.keys(bookmarksByFolder).length > 0) {
                    const optionModal = new Modal(this.app);
                    optionModal.titleEl.setText(`ğŸ“ ${folder} - í€´ì¦ˆ ì˜µì…˜`);
                    optionModal.contentEl.style.cssText = 'padding: 20px;';
                    
                    // ì „ì²´ ë¬¸ì œ ë²„íŠ¼
                    const allBtn = optionModal.contentEl.createEl('button', { text: `ğŸ“ ${folder} ì „ì²´ ë¬¸ì œë¡œ ì‹œì‘` });
                    allBtn.style.cssText = 'display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 1em;';
                    allBtn.addEventListener('click', async () => {
                        optionModal.close();
                        this.close();
                        await this.plugin.startQuiz(null, false, folder);
                    });

                    optionModal.contentEl.createEl('div', { text: 'ë˜ëŠ” ë¶ë§ˆí¬ í´ë” ì„ íƒ:' }).style.cssText = 'margin: 16px 0 8px 0; font-weight: 500;';

                    // ë¶ë§ˆí¬ í´ë”ë³„ ë²„íŠ¼ (ê°™ì€ í´ë”ì˜ ë¶ë§ˆí¬ë§Œ)
                    for (const [bmFolder, bmQuestions] of Object.entries(bookmarksByFolder)) {
                        const bmBtn = optionModal.contentEl.createEl('button', { text: `â­ ${bmFolder} (${bmQuestions.length}ë¬¸ì œ)` });
                        bmBtn.style.cssText = 'display: block; width: 100%; padding: 12px; margin-bottom: 8px; background: #fbbf24; color: #000; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 0.95em;';
                        bmBtn.addEventListener('click', async () => {
                            optionModal.close();
                            this.close();
                            await this.plugin.startQuiz(null, false, `${folder}-with-bookmark-${bmFolder}`);
                        });
                    }

                    optionModal.open();
                } else {
                    // ë¶ë§ˆí¬ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ì‹œì‘
                    this.close();
                    this.plugin.startQuiz(null, false, folder);
                }
            };
            mainArea.addEventListener('click', folderClickHandler);
            
            // í„°ì¹˜ ì´ë²¤íŠ¸ (ìŠ¤í¬ë¡¤ê³¼ íƒ­ êµ¬ë¶„)
            let fTouchStartY = 0;
            let fTouchStartX = 0;
            mainArea.addEventListener('touchstart', (e) => {
                fTouchStartY = e.touches[0].clientY;
                fTouchStartX = e.touches[0].clientX;
            });
            mainArea.addEventListener('touchend', (e) => {
                const touchEndY = e.changedTouches[0].clientY;
                const touchEndX = e.changedTouches[0].clientX;
                const deltaY = Math.abs(touchEndY - fTouchStartY);
                const deltaX = Math.abs(touchEndX - fTouchStartX);
                
                if (deltaY < 10 && deltaX < 10) {
                    e.preventDefault();
                    folderClickHandler(e);
                }
            });
            
            // ë¯¸ë‹ˆ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
            const miniButtons = folderCard.createDiv();
            miniButtons.style.cssText = `
                display: flex;
                gap: 5px;
                justify-content: center;
            `;
            
            // ë¬¸ì œ ìƒì„± ë²„íŠ¼
            const createBtn = miniButtons.createEl('button');
            createBtn.innerHTML = 'â•';
            createBtn.style.cssText = `
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: #fff;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
                font-weight: 600;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                min-height: 44px;
                min-width: 44px;
            `;
            createBtn.onmouseenter = () => {
                createBtn.style.background = 'rgba(255,255,255,0.3)';
            };
            createBtn.onmouseleave = () => {
                createBtn.style.background = 'rgba(255,255,255,0.2)';
            };
            createBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.close();
                const modal = new HanziQuestionModal(this.app, this.plugin);
                modal.question.folder = folder;
                modal.open();
            });
            
            // í¸ì§‘ ë²„íŠ¼ (í´ë” ê´€ë¦¬)
            const editBtn = miniButtons.createEl('button');
            editBtn.innerHTML = 'âœï¸';
            editBtn.style.cssText = `
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: #fff;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
                font-weight: 600;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                min-height: 44px;
                min-width: 44px;
            `;
            editBtn.onmouseenter = () => {
                editBtn.style.background = 'rgba(255,255,255,0.3)';
            };
            editBtn.onmouseleave = () => {
                editBtn.style.background = 'rgba(255,255,255,0.2)';
            };
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.close();
                new FolderManagementModal(this.app, this.plugin).open();
            });
            
            // í€´ì¦ˆ ê¸°ë¡ ë³´ê¸° ë²„íŠ¼
            const recordBtn = miniButtons.createEl('button');
            recordBtn.innerHTML = 'ï¿½';
            recordBtn.style.cssText = `
                background: rgba(255,255,255,0.2);
                border: 1px solid rgba(255,255,255,0.3);
                color: #fff;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
                font-weight: 600;
                -webkit-tap-highlight-color: transparent;
                touch-action: manipulation;
                min-height: 44px;
                min-width: 44px;
            `;
            recordBtn.onmouseenter = () => {
                recordBtn.style.background = 'rgba(255,255,255,0.3)';
            };
            recordBtn.onmouseleave = () => {
                recordBtn.style.background = 'rgba(255,255,255,0.2)';
            };
            recordBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                this.close();
                // í´ë”ë³„ í€´ì¦ˆ ê¸°ë¡ ë³´ê¸°
                const modal = new QuizDetailRecordModal(this.app, this.plugin, { correct: 0, incorrect: 0, total: 0, percentage: 0, time: 0, details: [] });
                modal.open();
                // ëª¨ë‹¬ì´ ì—´ë¦° í›„ í´ë” íƒ­ìœ¼ë¡œ ìë™ ì „í™˜
                setTimeout(() => {
                    const folderTab = document.querySelector('.tab-btn:nth-child(2)');
                    if (folderTab) folderTab.click();
                }, 100);
            });
        }

        // â­ ë¶ë§ˆí¬ í´ë”ë³„ í€´ì¦ˆ (í´ë”ë³„ í€´ì¦ˆ ë‹¤ìŒ)
        const bookmarkFoldersSection = contentEl.createDiv({ cls: 'bookmark-folders-section' });
        const bookmarkFoldersHeader = bookmarkFoldersSection.createDiv();
        bookmarkFoldersHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        
        const bookmarkFoldersTitle = bookmarkFoldersHeader.createEl('h2', { text: 'â­ ë¶ë§ˆí¬ í´ë”ë³„ í€´ì¦ˆ' });
        bookmarkFoldersTitle.style.cssText = 'margin: 0; font-size: 18px; font-weight: bold;';
        
        // ë¶ë§ˆí¬ í´ë” ê´€ë¦¬ ë²„íŠ¼
        const manageBmBtn = bookmarkFoldersHeader.createEl('button', { text: 'âš™ï¸ ë¶ë§ˆí¬ í´ë” ê´€ë¦¬' });
        manageBmBtn.style.cssText = `padding: ${isMobile ? '8px 12px' : '6px 12px'}; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; font-size: 13px; min-height: ${isMobile ? '40px' : 'auto'}; touch-action: manipulation;`;
        manageBmBtn.onclick = () => {
            this.close();
            new BookmarkFolderManagementModal(this.app, this.plugin).open();
        };

        const bookmarkFoldersGrid = bookmarkFoldersSection.createDiv({ cls: 'bookmark-folders-grid' });
        bookmarkFoldersGrid.style.cssText = `
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 25px;
        `;
        
        // ëª¨ë“  ë¶ë§ˆí¬ í´ë” ìˆ˜ì§‘ (ë¬¸ì œ ë¶ë§ˆí¬ + ì„ íƒì§€ ë¶ë§ˆí¬)
        const allBookmarkFolders = new Set();
        for (const q of questions) {
            if (q.bookmarkFolder && q.bookmarkFolder.length > 0) {
                allBookmarkFolders.add(q.bookmarkFolder);
            }
            if (q.optionBookmarkFolders) {
                q.optionBookmarkFolders.forEach(f => {
                    if (f && f.length > 0) allBookmarkFolders.add(f);
                });
            }
        }
        
        // ë¶ë§ˆí¬ í´ë” ì •ë ¬ (ì„¤ì •ì— ì €ì¥ëœ ìˆœì„œëŒ€ë¡œ)
        const sortedBookmarkFolders = Array.from(allBookmarkFolders).sort((a, b) => {
            const orderA = (this.plugin.settings.bookmarkFolderOrder || []).indexOf(a);
            const orderB = (this.plugin.settings.bookmarkFolderOrder || []).indexOf(b);
            if (orderA === -1 && orderB === -1) return a.localeCompare(b);
            if (orderA === -1) return 1;
            if (orderB === -1) return -1;
            return orderA - orderB;
        });
        
        if (sortedBookmarkFolders.length === 0) {
            bookmarkFoldersGrid.createEl('p', { 
                text: 'ë¶ë§ˆí¬ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. í€´ì¦ˆ í™”ë©´ì—ì„œ ë¬¸ì œë‚˜ ì„ íƒì§€ë¥¼ ë¶ë§ˆí¬í•˜ì„¸ìš”.',
                cls: 'empty-bookmark-message'
            }).style.cssText = 'color: var(--text-muted); padding: 20px; text-align: center; grid-column: 1 / -1;';
        } else {
            for (const bmFolder of sortedBookmarkFolders) {
                // ì´ í´ë”ì— ì†í•œ ë¬¸ì œ ìˆ˜ ê³„ì‚°
                const folderQuestions = questions.filter(q => {
                    if (q.bookmarkFolder === bmFolder) return true;
                    if (q.optionBookmarkFolders && q.optionBookmarkFolders.includes(bmFolder)) return true;
                    return false;
                });
                
                // ë¬¸ì œ ë¶ë§ˆí¬ vs ì„ íƒì§€ ë¶ë§ˆí¬ êµ¬ë¶„
                const questionBookmarks = questions.filter(q => q.bookmarkFolder === bmFolder).length;
                const optionBookmarks = questions.reduce((sum, q) => {
                    if (!q.optionBookmarkFolders) return sum;
                    return sum + q.optionBookmarkFolders.filter(f => f === bmFolder).length;
                }, 0);
                
                const bmFolderCard = bookmarkFoldersGrid.createDiv({ cls: 'bookmark-folder-card' });
                bmFolderCard.style.cssText = `
                    background: linear-gradient(135deg, #FFE680 0%, #FFB347 100%);
                    padding: 15px;
                    border-radius: 10px;
                    color: #000;
                    transition: all 0.3s;
                    box-shadow: 0 3px 10px rgba(255, 179, 71, 0.3);
                    position: relative;
                    overflow: hidden;
                    border: 2px solid #FF8C00;
                `;
                
                bmFolderCard.onmouseenter = () => {
                    bmFolderCard.style.transform = 'translateY(-3px)';
                    bmFolderCard.style.boxShadow = '0 6px 20px rgba(255, 140, 0, 0.4)';
                };
                bmFolderCard.onmouseleave = () => {
                    bmFolderCard.style.transform = 'translateY(0)';
                    bmFolderCard.style.boxShadow = '0 3px 10px rgba(255, 179, 71, 0.3)';
                };
                
                const mainArea = bmFolderCard.createDiv();
                mainArea.style.cssText = 'cursor: pointer; -webkit-tap-highlight-color: transparent; touch-action: manipulation; min-height: 48px;';
                mainArea.innerHTML = `
                    <div style="font-size: 24px; margin-bottom: 6px;">â­</div>
                    <div style="font-size: 14px; font-weight: bold; margin-bottom: 6px;">${bmFolder}</div>
                    <div style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">${folderQuestions.length}ë¬¸ì œ</div>
                    <div style="display: flex; gap: 8px; justify-content: center; font-size: 11px; opacity: 0.9; margin-bottom: 10px;">
                        <span>ğŸ“${questionBookmarks}</span>
                        <span>ğŸ”¹${optionBookmarks}</span>
                    </div>
                `;
                
                const bmClickHandler = (e) => {
                    e.stopPropagation();
                    this.close();
                    this.plugin.startQuiz(null, false, `bookmark-${bmFolder}`);
                };
                mainArea.addEventListener('click', bmClickHandler);
                
                let bmTouchStartY = 0;
                let bmTouchStartX = 0;
                mainArea.addEventListener('touchstart', (e) => {
                    bmTouchStartY = e.touches[0].clientY;
                    bmTouchStartX = e.touches[0].clientX;
                });
                mainArea.addEventListener('touchend', (e) => {
                    const touchEndY = e.changedTouches[0].clientY;
                    const touchEndX = e.changedTouches[0].clientX;
                    const deltaY = Math.abs(touchEndY - bmTouchStartY);
                    const deltaX = Math.abs(touchEndX - bmTouchStartX);
                    
                    if (deltaY < 10 && deltaX < 10) {
                        e.preventDefault();
                        bmClickHandler(e);
                    }
                });
                
                // ë¯¸ë‹ˆ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
                const miniButtons = bmFolderCard.createDiv();
                miniButtons.style.cssText = `
                    display: flex;
                    gap: 5px;
                    justify-content: center;
                `;
                
                // ë¬¸ì œ ëª©ë¡ ë²„íŠ¼
                const listBtn = miniButtons.createEl('button');
                listBtn.innerHTML = 'ğŸ“‹';
                listBtn.style.cssText = `
                    background: rgba(0,0,0,0.1);
                    border: 1px solid rgba(0,0,0,0.2);
                    color: #000;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 13px;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-weight: 600;
                    -webkit-tap-highlight-color: transparent;
                    touch-action: manipulation;
                    min-height: 44px;
                    min-width: 44px;
                `;
                listBtn.onmouseenter = () => {
                    listBtn.style.background = 'rgba(0,0,0,0.15)';
                };
                listBtn.onmouseleave = () => {
                    listBtn.style.background = 'rgba(0,0,0,0.1)';
                };
                listBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.close();
                    new QuestionListModal(this.app, this.plugin, `bookmark-${bmFolder}`).open();
                });
                
                // í†µê³„ ë²„íŠ¼
                const statsBtn = miniButtons.createEl('button');
                statsBtn.innerHTML = 'ğŸ“Š';
                statsBtn.style.cssText = `
                    background: rgba(0,0,0,0.1);
                    border: 1px solid rgba(0,0,0,0.2);
                    color: #000;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-size: 13px;
                    cursor: pointer;
                    transition: all 0.2s;
                    font-weight: 600;
                    -webkit-tap-highlight-color: transparent;
                    touch-action: manipulation;
                    min-height: 44px;
                    min-width: 44px;
                `;
                statsBtn.onmouseenter = () => {
                    statsBtn.style.background = 'rgba(0,0,0,0.15)';
                };
                statsBtn.onmouseleave = () => {
                    statsBtn.style.background = 'rgba(0,0,0,0.1)';
                };
                statsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // ê°„ë‹¨í•œ í†µê³„ ì•Œë¦¼
                    new Notice(`â­ ${bmFolder}\n\nì´ ë¬¸ì œ: ${folderQuestions.length}ê°œ\në¬¸ì œ ë¶ë§ˆí¬: ${questionBookmarks}ê°œ\nì„ íƒì§€ ë¶ë§ˆí¬: ${optionBookmarks}ê°œ`);
                });
            }
        }

        // ğŸš€ ë¹ ë¥¸ ì‘ì—… (ì„¹ì…˜ í—¤ë”ì™€ ì •ë ¬ ë²„íŠ¼)
        const actionsSection = contentEl.createDiv({ cls: 'actions-section' });
        const actionsHeader = actionsSection.createDiv();
        actionsHeader.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;';
        
        const actionsTitle = actionsHeader.createEl('h2', { text: 'ğŸš€ ë¹ ë¥¸ ì‘ì—…' });
        actionsTitle.style.cssText = 'margin: 0; font-size: 18px; font-weight: bold;';
        
        // ì •ë ¬ ë²„íŠ¼ ì¶”ê°€
        const sortActions = actionsHeader.createEl('button', { text: 'â‡… ì •ë ¬' });
        sortActions.style.cssText = `padding: ${isMobile ? '8px 12px' : '6px 12px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-size: 13px; min-height: ${isMobile ? '40px' : 'auto'}; touch-action: manipulation;`;
        sortActions.onclick = () => {
            const menu = new Menu();
            
            menu.addItem((item) => {
                item.setTitle('ê¸°ë³¸ ìˆœì„œ')
                    .setIcon('list')
                    .onClick(() => {
                        this.plugin.settings.actionSortOrder = 'default';
                        this.plugin.saveSettings();
                        this.onOpen(); // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                    });
            });
            
            menu.addItem((item) => {
                item.setTitle('ì´ë¦„ìˆœ (ê°€ë‚˜ë‹¤)')
                    .setIcon('sort-asc')
                    .onClick(() => {
                        this.plugin.settings.actionSortOrder = 'name';
                        this.plugin.saveSettings();
                        this.onOpen();
                    });
            });
            
            menu.addItem((item) => {
                item.setTitle('ë¬¸ì œìˆ˜ ë§ì€ìˆœ')
                    .setIcon('sort-desc')
                    .onClick(() => {
                        this.plugin.settings.actionSortOrder = 'count-desc';
                        this.plugin.saveSettings();
                        this.onOpen();
                    });
            });
            
            menu.addItem((item) => {
                item.setTitle('ë¬¸ì œìˆ˜ ì ì€ìˆœ')
                    .setIcon('sort-asc')
                    .onClick(() => {
                        this.plugin.settings.actionSortOrder = 'count-asc';
                        this.plugin.saveSettings();
                        this.onOpen();
                    });
            });
            
            menu.showAtMouseEvent(event);
        };

        const actionsGrid = actionsSection.createDiv({ cls: 'actions-grid' });

        let actions = [
            // ì£¼ìš” ê¸°ëŠ¥ (ìƒë‹¨)
            { 
                icon: 'ğŸ¯', 
                text: 'ì „ì²´ í€´ì¦ˆ', 
                count: questions.length, 
                color: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                callback: () => { this.close(); this.plugin.startQuiz(); },
                order: 1
            },
            { 
                icon: 'âŒ', 
                text: 'ì˜¤ë‹µ ë³µìŠµ', 
                count: questions.filter(q => q.wrongCount > 0).length, 
                color: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                callback: () => { this.close(); this.plugin.startWrongAnswerQuiz(); },
                order: 2
            },
            { 
                icon: 'â­', 
                text: 'ë¶ë§ˆí¬ í€´ì¦ˆ', 
                count: questions.filter(q => {
                    if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
                    if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
                    return false;
                }).length, 
                color: 'linear-gradient(135deg, #ffd89b 0%, #ff6b6b 100%)',
                callback: () => { this.close(); this.plugin.startBookmarkQuiz(); },
                order: 3
            },
            { 
                icon: 'ğŸ¯', 
                text: 'ì„ íƒì§€ í€´ì¦ˆ', 
                count: questions.reduce((sum, q) => {
                    return sum + (q.optionBookmarkFolders ? q.optionBookmarkFolders.filter(f => f && f.length > 0).length : 0);
                }, 0),
                color: 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)',
                callback: () => { this.close(); this.plugin.startOptionBookmarkQuiz(); },
                order: 4
            },
            { 
                icon: 'ğŸ“', 
                text: 'ë¬¸ì œ ë§Œë“¤ê¸°', 
                color: 'linear-gradient(135deg, #a8edea 0%, #5cc7c7 100%)',
                callback: () => { this.close(); new HanziQuestionModal(this.app, this.plugin).open(); },
                order: 5
            },
            
            // ë‚œì´ë„ë³„
            { 
                icon: 'ğŸ†', 
                text: 'Aê¸‰ í€´ì¦ˆ', 
                count: questions.filter(q => q.difficulty?.startsWith('A')).length, 
                color: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                callback: () => { this.close(); this.plugin.startQuiz('A'); },
                order: 6
            },
            { 
                icon: 'ğŸ˜Š', 
                text: 'Bê¸‰ í€´ì¦ˆ', 
                count: questions.filter(q => q.difficulty?.startsWith('B')).length, 
                color: 'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                callback: () => { this.close(); this.plugin.startQuiz('B'); },
                order: 7
            },
            { 
                icon: 'ğŸ˜', 
                text: 'Cê¸‰ ì´í•˜', 
                count: questions.filter(q => ['C', 'D', 'E', 'F'].includes(q.difficulty)).length, 
                color: 'linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%)',
                callback: () => { this.close(); this.plugin.startQuiz('C'); },
                order: 8
            },
            
            // ê´€ë¦¬
            { 
                icon: 'ğŸ“Š', 
                text: 'ê¸°ë¡ ê´€ë¦¬', 
                color: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                callback: () => { 
                    this.close(); 
                    new QuizDetailRecordModal(this.app, this.plugin, { 
                        correct: 0, incorrect: 0, total: 0, percentage: 0, time: 0, details: [] 
                    }).open(); 
                },
                order: 9
            },
            { 
                icon: 'ğŸ“ˆ', 
                text: 'í•™ìŠµ í†µê³„', 
                color: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                callback: () => { this.close(); this.plugin.viewStatistics(); },
                order: 10
            },
            { 
                icon: 'ğŸ“‚', 
                text: 'í´ë” ê´€ë¦¬', 
                color: 'linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)',
                callback: () => { this.close(); new FolderManagementModal(this.app, this.plugin).open(); },
                order: 11
            },
            { 
                icon: 'âš™ï¸', 
                text: 'ë¶ë§ˆí¬í´ë”ê´€ë¦¬', 
                color: 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)',
                callback: () => { this.close(); new BookmarkFolderManagementModal(this.app, this.plugin).open(); },
                order: 12
            },
            
            // ëª©ë¡
            { 
                icon: 'ğŸ“‹', 
                text: 'ë¬¸ì œ ëª©ë¡', 
                color: 'linear-gradient(135deg, #fdcbf1 0%, #e6dee9 100%)',
                callback: () => { this.close(); this.plugin.viewQuestionList(); },
                order: 13
            },
            { 
                icon: 'ğŸ”‘', 
                text: 'í‚¤ì›Œë“œ ëª©ë¡', 
                color: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)',
                callback: () => { this.close(); this.plugin.viewKeywordList(); },
                order: 14
            },
            { 
                icon: 'âš™ï¸', 
                text: 'ì„¤ì •', 
                color: 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                callback: () => { 
                    this.close(); 
                    this.app.setting.open(); 
                    this.app.setting.openTabById('quiz-sp'); 
                },
                order: 15
            }
        ];
        
        // ì •ë ¬ ì ìš©
        const sortOrder = this.plugin.settings.actionSortOrder || 'default';
        if (sortOrder === 'name') {
            actions.sort((a, b) => a.text.localeCompare(b.text));
        } else if (sortOrder === 'count-desc') {
            actions.sort((a, b) => (b.count || 0) - (a.count || 0));
        } else if (sortOrder === 'count-asc') {
            actions.sort((a, b) => (a.count || 0) - (b.count || 0));
        } else {
            // ê¸°ë³¸ ìˆœì„œ (order í•„ë“œ ê¸°ì¤€)
            actions.sort((a, b) => a.order - b.order);
        }

        actions.forEach(action => {
            const btn = actionsGrid.createEl('button', { cls: 'action-button' });
            btn.style.cssText = `
                background: ${action.color};
                border: none;
                padding: ${isMobile ? '14px 16px' : '16px 20px'};
                border-radius: 12px;
                color: #fff;
                font-weight: 600;
                font-size: ${isMobile ? '14px' : '15px'};
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
                text-align: center;
                min-height: ${isMobile ? '90px' : '70px'};
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: ${isMobile ? '4px' : '6px'};
                -webkit-tap-highlight-color: rgba(255,255,255,0.1);
                touch-action: manipulation;
                user-select: none;
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            `;
            
            const iconSpan = btn.createEl('span');
            iconSpan.textContent = action.icon;
            iconSpan.style.cssText = `font-size: ${isMobile ? '24px' : '28px'};`;
            
            const textSpan = btn.createEl('span');
            textSpan.textContent = action.text;
            textSpan.style.cssText = `font-size: ${isMobile ? '13px' : '14px'};`;
            
            if (action.count !== undefined) {
                const countSpan = btn.createEl('span');
                countSpan.textContent = `${action.count}ê°œ`;
                countSpan.style.cssText = `font-size: ${isMobile ? '11px' : '12px'}; opacity: 0.9; font-weight: 500;`;
            }
            
            // í„°ì¹˜ í”¼ë“œë°±
            btn.addEventListener('touchstart', () => {
                btn.style.transform = 'translateY(-2px) translateZ(0)';
                btn.style.boxShadow = '0 6px 20px rgba(0, 0, 0, 0.2)';
            });
            btn.addEventListener('touchend', () => {
                btn.style.transform = 'translateY(0) translateZ(0)';
                btn.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.15)';
            });
            
            btn.onmouseenter = () => {
                btn.style.transform = 'translateY(-3px)';
                btn.style.boxShadow = '0 6px 25px rgba(0, 0, 0, 0.25)';
            };
            btn.onmouseleave = () => {
                btn.style.transform = 'translateY(0)';
                btn.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.15)';
            };
            
            btn.addEventListener('click', action.callback);
        });

        // ìµœê·¼ í•™ìŠµ ê¸°ë¡
        if (stats.studyHistory && stats.studyHistory.length > 0) {
            const historySection = contentEl.createDiv({ cls: 'history-section' });
            historySection.createEl('h2', { text: 'ğŸ“… ìµœê·¼ í•™ìŠµ ê¸°ë¡' });

            const recentHistory = stats.studyHistory.slice(-5).reverse();
            const historyList = historySection.createEl('ul', { cls: 'history-list' });

            recentHistory.forEach(h => {
                const item = historyList.createEl('li');
                item.innerHTML = `<strong>${h.date}</strong> - ì •ë‹µ ${h.correct}ê°œ, ì˜¤ë‹µ ${h.wrong}ê°œ`;
            });
        }

        // ì˜¤ë‹µ ë§ì€ ë¬¸ì œ
        const topWrongQuestions = questions.filter(q => q.wrongCount > 0)
            .sort((a, b) => b.wrongCount - a.wrongCount)
            .slice(0, 5);

        if (topWrongQuestions.length > 0) {
            const wrongSection = contentEl.createDiv({ cls: 'wrong-section' });
            wrongSection.createEl('h2', { text: 'âš ï¸ ì˜¤ë‹µì´ ë§ì€ ë¬¸ì œ TOP 5' });

            const wrongList = wrongSection.createEl('ul', { cls: 'wrong-list' });
            topWrongQuestions.forEach(q => {
                const item = wrongList.createEl('li');
                item.innerHTML = `<strong>${q.hanzi}</strong> - ì˜¤ë‹µ ${q.wrongCount}íšŒ`;
            });
        }


        // ìµœê·¼ ìˆ˜ì •í•œ íŒŒì¼
        const recentSection = contentEl.createDiv({ cls: 'recent-section' });
        recentSection.createEl('h2', { text: 'ğŸ•’ ìµœê·¼ ìˆ˜ì •í•œ ë¬¸ì œ' });

        const recentFiles = this.getRecentQuestionFiles(questions);
        if (recentFiles.length > 0) {
            const recentList = recentSection.createEl('ul', { cls: 'recent-list' });
            recentFiles.slice(0, 5).forEach(q => {
                const item = recentList.createEl('li');
                const timeAgo = this.getTimeAgo(q.mtime);
                item.innerHTML = `<strong>${q.hanzi}</strong> - ${q.question.substring(0, 30)}... <span style="color: var(--text-muted); font-size: 12px;">(${timeAgo})</span>`;
                item.style.cursor = 'pointer';
                item.addEventListener('click', async () => {
                    this.close();
                    const file = this.app.vault.getAbstractFileByPath(q.filePath);
                    if (file) {
                        const leaf = this.app.workspace.getLeaf(false);
                        await leaf.openFile(file);
                    }
                });
            });
        } else {
            recentSection.createEl('p', { text: 'ìµœê·¼ ìˆ˜ì •í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.' });
        }

        this.addStyles();
    }

    getRecentQuestionFiles(questions) {
        return questions
            .filter(q => q.mtime)
            .sort((a, b) => b.mtime - a.mtime);
    }

    getTimeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 60) return `${minutes}ë¶„ ì „`;
        if (hours < 24) return `${hours}ì‹œê°„ ì „`;
        return `${days}ì¼ ì „`;
    }

    addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .hanzi-quiz-dashboard {
                padding: 20px;
                max-width: 1200px;
                margin: 0 auto;
                width: 100%;
                box-sizing: border-box;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                -webkit-transform: translateZ(0);
                transform: translateZ(0);
            }
            .dashboard-header h1 {
                text-align: center;
                margin-bottom: 30px;
                word-wrap: break-word;
            }
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
                width: 100%;
            }
            .stat-card {
                padding: 20px;
                background: var(--background-secondary);
                border-radius: 8px;
                text-align: center;
                box-sizing: border-box;
                overflow: hidden;
            }
            .stat-icon {
                font-size: 32px;
                margin-bottom: 10px;
            }
            .stat-value {
                font-size: 24px;
                font-weight: bold;
                margin-bottom: 5px;
                word-break: break-all;
            }
            .stat-label {
                font-size: 14px;
                color: var(--text-muted);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .actions-section, .history-section, .wrong-section, .folders-quiz-section {
                margin-bottom: 30px;
                width: 100%;
                box-sizing: border-box;
            }
            .actions-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
                width: 100%;
            }
            .action-button {
                padding: 15px;
                font-size: 14px;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                box-sizing: border-box;
                width: 100%;
            }
            .action-button:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .history-list, .wrong-list {
                list-style: none;
                padding: 0;
                width: 100%;
                box-sizing: border-box;
            }
            .history-list li, .wrong-list li {
                padding: 10px;
                margin-bottom: 5px;
                background: var(--background-secondary);
                border-radius: 5px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .folders-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                width: 100%;
            }
            .folder-card {
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
                border: 2px solid var(--background-modifier-border);
                transition: all 0.2s;
                box-sizing: border-box;
                overflow: hidden;
                width: 100%;
            }
            .folder-card:hover {
                border-color: var(--interactive-accent);
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
            .folder-header h3 {
                margin: 0 0 10px 0;
                font-size: 18px;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .folder-stats {
                margin-bottom: 10px;
                color: var(--text-muted);
                font-size: 14px;
            }
            .folder-action-btn {
                flex: 1;
                padding: 8px;
                font-size: 13px;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                min-width: 0;
            }
            .folder-action-btn:hover {
                transform: scale(1.05);
            }
            .recent-section {
                margin-bottom: 30px;
                width: 100%;
                box-sizing: border-box;
            }
            .recent-list {
                list-style: none;
                padding: 0;
                width: 100%;
            }
            .recent-list li {
                padding: 12px;
                margin-bottom: 5px;
                background: var(--background-secondary);
                border-radius: 5px;
                transition: all 0.2s;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .recent-list li:hover {
                background: var(--background-modifier-hover);
                transform: translateX(5px);
            }
            
            /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
            @media (max-width: 768px) {
                .hanzi-quiz-dashboard {
                    padding: 12px;
                    -webkit-overflow-scrolling: touch;
                }
                .dashboard-header {
                    flex-direction: column;
                    gap: 10px;
                }
                .dashboard-header h1 {
                    font-size: 20px;
                }
                .stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                }
                .stat-card {
                    padding: 14px;
                    min-height: 90px;
                }
                .stat-icon {
                    font-size: 28px;
                }
                .stat-value {
                    font-size: 22px;
                }
                .folders-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                }
                .bookmark-folders-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                }
                .actions-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                }
                .action-button {
                    min-height: 85px;
                    padding: 12px;
                }
                h2 {
                    font-size: 16px !important;
                }
                input, textarea, button {
                    font-size: 16px !important;
                }
                button {
                    min-height: 44px;
                    -webkit-tap-highlight-color: rgba(0,0,0,0.05);
                    touch-action: manipulation;
                }
            }
                    padding: 12px;
                    font-size: 13px;
                    touch-action: manipulation;
                    -webkit-tap-highlight-color: rgba(0,0,0,0.05);
                }
                .folders-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 8px;
                }
                .folder-card {
                    padding: 12px;
                }
                .folder-action-btn {
                    min-height: 44px;
                }
                /* ì…ë ¥ í•„ë“œ ì¤Œ ë°©ì§€ */
                input, textarea, select {
                    font-size: 16px !important;
                }
                /* í„°ì¹˜ ìµœì í™” */
                button {
                    min-height: 44px;
                    min-width: 44px;
                    -webkit-tap-highlight-color: rgba(0,0,0,0.05);
                    touch-action: manipulation;
                }
            }
                    padding: 12px 15px;
                    font-size: 14px;
                    touch-action: manipulation;
                    -webkit-tap-highlight-color: transparent;
                }
            }
            
            @media (max-width: 480px) {
                .stats-grid {
                    grid-template-columns: 1fr;
                }
                .folder-header h3 {
                    font-size: 16px;
                }
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ğŸ“‹ ë¬¸ì œ ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬
class QuestionDashboardModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('question-dashboard-modal');

        // í—¤ë”
        const isMobile = this.app.isMobile || window.innerWidth <= 768;
        
        const header = contentEl.createDiv({ cls: 'qd-header' });
        header.style.cssText = 'display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;';
        
        const titleSection = header.createDiv();
        titleSection.createEl('h1', { text: 'ğŸ“‹ ë¬¸ì œ ëŒ€ì‹œë³´ë“œ', cls: 'qd-title' });
        titleSection.createEl('p', { text: 'ì „ì²´ ë¬¸ì œë¥¼ í•œëˆˆì— í™•ì¸í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”', cls: 'qd-subtitle' });
        
        const settingsBtn = header.createEl('button', { text: 'âš™ï¸ ì„¤ì •' });
        settingsBtn.style.cssText = `padding: ${isMobile ? '10px 14px' : '8px 16px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-size: 0.9em; min-height: ${isMobile ? '40px' : 'auto'}; touch-action: manipulation; -webkit-tap-highlight-color: transparent;`;
        settingsBtn.onclick = () => {
            this.close();
            this.app.setting.open();
            this.app.setting.openTabById('quiz-sp2');
        };
        settingsBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.close();
            this.app.setting.open();
            this.app.setting.openTabById('quiz-sp2');
        });

        // ë¬¸ì œ ë¡œë”©
        console.log('ğŸ” ë¬¸ì œ ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬: ë¬¸ì œ ë¡œë”© ì‹œì‘');
        const questions = await this.plugin.loadAllQuestions();
        console.log(`ğŸ“Š ë¡œë”©ëœ ë¬¸ì œ ìˆ˜: ${questions.length}ê°œ`);
        if (questions.length > 0) {
            console.log('ğŸ“ ì²« ë²ˆì§¸ ë¬¸ì œ:', questions[0]);
        }
        
        // í†µê³„ ì„¹ì…˜
        const statsContainer = contentEl.createDiv({ cls: 'qd-stats-container' });
        this.renderStats(statsContainer, questions);

        // í•„í„° & ê²€ìƒ‰ ì„¹ì…˜
        const filterContainer = contentEl.createDiv({ cls: 'qd-filter-container' });
        this.renderFilters(filterContainer, questions);

        // ë¬¸ì œ ëª©ë¡ ì„¹ì…˜
        const questionsContainer = contentEl.createDiv({ cls: 'qd-questions-container' });
        this.renderQuestions(questionsContainer, questions);

        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        this.addStyles();
    }

    renderStats(container, questions) {
        const stats = container.createDiv({ cls: 'qd-stats-grid' });

        // ì´ ë¬¸ì œ ìˆ˜
        const totalCard = stats.createDiv({ cls: 'qd-stat-card qd-stat-total' });
        totalCard.createEl('div', { text: 'ğŸ“š', cls: 'qd-stat-icon' });
        totalCard.createEl('div', { text: questions.length.toString(), cls: 'qd-stat-value' });
        totalCard.createEl('div', { text: 'ì´ ë¬¸ì œ', cls: 'qd-stat-label' });

        // ë‚œì´ë„ë³„ ì§‘ê³„
        const difficultyCount = {};
        questions.forEach(q => {
            const diff = q.difficulty || 'C';
            difficultyCount[diff] = (difficultyCount[diff] || 0) + 1;
        });

        // ë‚œì´ë„ A+ ~ F
        const difficultyCards = [
            { diff: 'A+', icon: 'ğŸ†', color: '#ff6b6b', label: 'A+ê¸‰' },
            { diff: 'A', icon: 'â­', color: '#ffa500', label: 'Aê¸‰' },
            { diff: 'B', icon: 'ğŸ˜Š', color: '#4caf50', label: 'Bê¸‰' },
            { diff: 'C', icon: 'ğŸ˜', color: '#2196f3', label: 'Cê¸‰' },
            { diff: 'D', icon: 'ğŸ˜°', color: '#9c27b0', label: 'Dê¸‰' },
            { diff: 'F', icon: 'ğŸ’€', color: '#000', label: 'Fê¸‰' }
        ];

        difficultyCards.forEach(({ diff, icon, color, label }) => {
            const count = difficultyCount[diff] || 0;
            if (count > 0) {
                const card = stats.createDiv({ cls: 'qd-stat-card' });
                card.style.borderLeft = `4px solid ${color}`;
                card.createEl('div', { text: icon, cls: 'qd-stat-icon' });
                card.createEl('div', { text: count.toString(), cls: 'qd-stat-value' });
                card.createEl('div', { text: label, cls: 'qd-stat-label' });
            }
        });

        // ë¶ë§ˆí¬
        const bookmarkedCount = questions.filter(q => q.bookmarked).length;
        if (bookmarkedCount > 0) {
            const bookmarkCard = stats.createDiv({ cls: 'qd-stat-card' });
            bookmarkCard.style.borderLeft = '4px solid gold';
            bookmarkCard.createEl('div', { text: 'â­', cls: 'qd-stat-icon' });
            bookmarkCard.createEl('div', { text: bookmarkedCount.toString(), cls: 'qd-stat-value' });
            bookmarkCard.createEl('div', { text: 'ë¶ë§ˆí¬', cls: 'qd-stat-label' });
        }

        // ì˜¤ë‹µ
        const wrongCount = questions.filter(q => q.wrongCount > 0).length;
        if (wrongCount > 0) {
            const wrongCard = stats.createDiv({ cls: 'qd-stat-card' });
            wrongCard.style.borderLeft = '4px solid #f44336';
            wrongCard.createEl('div', { text: 'âŒ', cls: 'qd-stat-icon' });
            wrongCard.createEl('div', { text: wrongCount.toString(), cls: 'qd-stat-value' });
            wrongCard.createEl('div', { text: 'ì˜¤ë‹µ', cls: 'qd-stat-label' });
        }
    }

    renderFilters(container, questions) {
        const filterHeader = container.createDiv({ cls: 'qd-filter-header' });
        filterHeader.createEl('h2', { text: 'ğŸ” í•„í„° & ì •ë ¬', cls: 'qd-filter-title' });

        const filterControls = container.createDiv({ cls: 'qd-filter-controls' });

        // ê²€ìƒ‰ì°½
        const searchContainer = filterControls.createDiv({ cls: 'qd-search-container' });
        const searchInput = searchContainer.createEl('input', {
            type: 'text',
            placeholder: 'ğŸ” ë¬¸ì œ ê²€ìƒ‰ (í•œì, í‚¤ì›Œë“œ, ì„¤ëª…...)',
            cls: 'qd-search-input'
        });

        // í´ë” í•„í„°
        const folderFilter = filterControls.createDiv({ cls: 'qd-folder-filter' });
        folderFilter.createEl('label', { text: 'ğŸ“‚ í´ë”: ', cls: 'qd-filter-label' });
        const folderSelect = folderFilter.createEl('select', { cls: 'qd-select' });
        folderSelect.createEl('option', { text: 'ì „ì²´', value: 'all' });
        
        const folders = [...new Set(questions.map(q => q.folder || 'ê¸°ë³¸'))];
        folders.forEach(folder => {
            folderSelect.createEl('option', { text: folder, value: folder });
        });

        // ë‚œì´ë„ í•„í„°
        const difficultyFilter = filterControls.createDiv({ cls: 'qd-difficulty-filter' });
        difficultyFilter.createEl('label', { text: 'â­ ë‚œì´ë„: ', cls: 'qd-filter-label' });
        const difficultySelect = difficultyFilter.createEl('select', { cls: 'qd-select' });
        difficultySelect.createEl('option', { text: 'ì „ì²´', value: 'all' });
        ['A+', 'A', 'A-', 'B', 'B-', 'C', 'D', 'E', 'F'].forEach(diff => {
            difficultySelect.createEl('option', { text: diff, value: diff });
        });

        // ì •ë ¬
        const sortFilter = filterControls.createDiv({ cls: 'qd-sort-filter' });
        sortFilter.createEl('label', { text: 'ğŸ”„ ì •ë ¬: ', cls: 'qd-filter-label' });
        const sortSelect = sortFilter.createEl('select', { cls: 'qd-select' });
        sortSelect.createEl('option', { text: 'ìµœê·¼ ìˆ˜ì •', value: 'recent' });
        sortSelect.createEl('option', { text: 'ë¬¸ì œ ë²ˆí˜¸', value: 'number' });
        sortSelect.createEl('option', { text: 'ë‚œì´ë„', value: 'difficulty' });
        sortSelect.createEl('option', { text: 'ì˜¤ë‹µ ë§ì€ ìˆœ', value: 'wrong' });

        // í•„í„° ì´ë²¤íŠ¸
        const applyFilters = () => {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedFolder = folderSelect.value;
            const selectedDifficulty = difficultySelect.value;
            const sortBy = sortSelect.value;

            let filtered = questions.filter(q => {
                const matchSearch = !searchTerm || 
                    q.hanzi?.toLowerCase().includes(searchTerm) ||
                    q.question?.toLowerCase().includes(searchTerm) ||
                    q.keywords?.some(k => k.toLowerCase().includes(searchTerm));
                const matchFolder = selectedFolder === 'all' || (q.folder || 'ê¸°ë³¸') === selectedFolder;
                const matchDifficulty = selectedDifficulty === 'all' || q.difficulty === selectedDifficulty;
                return matchSearch && matchFolder && matchDifficulty;
            });

            // ì •ë ¬
            switch (sortBy) {
                case 'recent':
                    filtered.sort((a, b) => (b.mtime || 0) - (a.mtime || 0));
                    break;
                case 'number':
                    filtered.sort((a, b) => parseInt(a.number || '0') - parseInt(b.number || '0'));
                    break;
                case 'difficulty':
                    const diffOrder = ['F', 'E', 'D', 'C', 'B-', 'B', 'A-', 'A', 'A+'];
                    filtered.sort((a, b) => diffOrder.indexOf(b.difficulty || 'C') - diffOrder.indexOf(a.difficulty || 'C'));
                    break;
                case 'wrong':
                    filtered.sort((a, b) => (b.wrongCount || 0) - (a.wrongCount || 0));
                    break;
            }

            const questionsContainer = this.contentEl.querySelector('.qd-questions-container');
            questionsContainer.empty();
            this.renderQuestions(questionsContainer, filtered);
        };

        searchInput.addEventListener('input', applyFilters);
        folderSelect.addEventListener('change', applyFilters);
        difficultySelect.addEventListener('change', applyFilters);
        sortSelect.addEventListener('change', applyFilters);
    }

    renderQuestions(container, questions) {
        container.empty();
        
        console.log(`ğŸ¨ renderQuestions í˜¸ì¶œ: ${questions.length}ê°œ ë¬¸ì œ`);

        if (questions.length === 0) {
            container.createEl('p', { text: 'ğŸ˜¢ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', cls: 'qd-no-questions' });
            return;
        }

        const grid = container.createDiv({ cls: 'qd-questions-grid' });
        
        console.log('ğŸ“¦ ê·¸ë¦¬ë“œ ìƒì„± ì™„ë£Œ, ì¹´ë“œ ë Œë”ë§ ì‹œì‘');

        questions.forEach((q, index) => {
            if (index < 3) {
                console.log(`ì¹´ë“œ ${index + 1}:`, {
                    hanzi: q.hanzi,
                    title: q.title,
                    question: q.question?.substring(0, 30),
                    number: q.number,
                    folder: q.folder,
                    difficulty: q.difficulty
                });
            }
            
            const card = grid.createDiv({ cls: 'qd-question-card' });

            // ì¹´ë“œ í´ë¦­ â†’ íŒŒì¼ ì—´ê¸° (ëª¨ë°”ì¼ ìµœì í™”)
            card.addEventListener('click', async (e) => {
                if (e.target.tagName === 'BUTTON') return; // ë²„íŠ¼ í´ë¦­ ì œì™¸
                
                try {
                    const file = this.app.vault.getAbstractFileByPath(q.filePath);
                    if (file) {
                        this.close();
                        
                        // ëª¨ë°”ì¼ ê°ì§€
                        const isMobile = this.app.isMobile || window.innerWidth <= 768;
                        
                        if (isMobile) {
                            // ëª¨ë°”ì¼: í˜„ì¬ ë¦¬í”„ì—ì„œ ì—´ê¸°
                            const leaf = this.app.workspace.getLeaf();
                            await leaf.openFile(file);
                        } else {
                            // ë°ìŠ¤í¬í†±: ìƒˆ íƒ­ ë˜ëŠ” í˜„ì¬ íƒ­
                            const leaf = this.app.workspace.getLeaf(false);
                            await leaf.openFile(file);
                        }
                    } else {
                        new Notice('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                    }
                } catch (error) {
                    console.error('íŒŒì¼ ì—´ê¸° ì˜¤ë¥˜:', error);
                    new Notice('âŒ íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨: ' + error.message);
                }
            });

            // í—¤ë” (í•œì + ë²ˆí˜¸)
            const cardHeader = card.createDiv({ cls: 'qd-card-header' });
            
            const headerLeft = cardHeader.createDiv({ cls: 'qd-header-left' });
            headerLeft.createEl('div', { text: q.hanzi || q.title || '-', cls: 'qd-card-hanzi' });
            
            const headerRight = cardHeader.createDiv({ cls: 'qd-header-right' });
            headerRight.createEl('div', { text: `#${q.number || '?'}`, cls: 'qd-card-number' });

            // ë¬¸ì œ
            const cardQuestion = card.createDiv({ cls: 'qd-card-question' });
            const questionText = q.question || 'ë¬¸ì œ ì—†ìŒ';
            cardQuestion.textContent = questionText.substring(0, 50) + (questionText.length > 50 ? '...' : '');

            // ë©”íƒ€ ì •ë³´
            const cardMeta = card.createDiv({ cls: 'qd-card-meta' });

            // ë‚œì´ë„
            const diffIcon = this.getDifficultyIcon(q.difficulty);
            const diffBadge = cardMeta.createEl('span', { cls: 'qd-badge qd-badge-diff' });
            diffBadge.textContent = `${diffIcon} ${q.difficulty || 'C'}`;
            diffBadge.style.background = this.getDifficultyColor(q.difficulty);

            // í´ë”
            const folderBadge = cardMeta.createEl('span', { cls: 'qd-badge qd-badge-folder' });
            folderBadge.textContent = `ğŸ“ ${q.folder || 'ê¸°ë³¸'}`;

            // ë¶ë§ˆí¬
            if (q.bookmarked) {
                const bookmarkBadge = cardMeta.createEl('span', { cls: 'qd-badge qd-badge-bookmark' });
                bookmarkBadge.textContent = 'â­ ë¶ë§ˆí¬';
                bookmarkBadge.style.background = 'gold';
                bookmarkBadge.style.color = '#000';
            }

            // ì˜¤ë‹µ
            if (q.wrongCount > 0) {
                const wrongBadge = cardMeta.createEl('span', { cls: 'qd-badge qd-badge-wrong' });
                wrongBadge.textContent = `âŒ ${q.wrongCount}íšŒ`;
                wrongBadge.style.background = '#f44336';
            }

            // ì •ë‹µ
            if (q.correctCount > 0) {
                const correctBadge = cardMeta.createEl('span', { cls: 'qd-badge qd-badge-correct' });
                correctBadge.textContent = `âœ… ${q.correctCount}íšŒ`;
                correctBadge.style.background = '#4caf50';
            }

            // ìˆ˜ì • ì‹œê°„
            if (q.mtime) {
                const timeAgo = this.getTimeAgo(q.mtime);
                const timeBadge = cardMeta.createEl('span', { cls: 'qd-badge qd-badge-time' });
                timeBadge.textContent = `ğŸ•’ ${timeAgo}`;
                timeBadge.style.background = 'var(--background-secondary)';
                timeBadge.style.color = 'var(--text-muted)';
            }

            // í‚¤ì›Œë“œ
            if (q.keywords && q.keywords.length > 0) {
                const keywordContainer = card.createDiv({ cls: 'qd-card-keywords' });
                q.keywords.slice(0, 3).forEach(kw => {
                    const kwBadge = keywordContainer.createEl('span', { cls: 'qd-keyword-badge' });
                    kwBadge.textContent = `ğŸ”‘ ${kw}`;
                });
            }

            // ì•¡ì…˜ ë²„íŠ¼
            const cardActions = card.createDiv({ cls: 'qd-card-actions' });

            const editBtn = cardActions.createEl('button', { text: 'âœï¸ ìˆ˜ì •', cls: 'qd-action-btn qd-btn-edit' });
            editBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                try {
                    const file = this.app.vault.getAbstractFileByPath(q.filePath);
                    if (file) {
                        this.close();
                        
                        const isMobile = this.app.isMobile || window.innerWidth <= 768;
                        const leaf = isMobile ? this.app.workspace.getLeaf() : this.app.workspace.getLeaf(false);
                        await leaf.openFile(file);
                    }
                } catch (error) {
                    console.error('ìˆ˜ì • ë²„íŠ¼ ì˜¤ë¥˜:', error);
                    new Notice('âŒ íŒŒì¼ ì—´ê¸° ì‹¤íŒ¨');
                }
            });

            const quizBtn = cardActions.createEl('button', { text: 'ğŸ¯ í€´ì¦ˆ', cls: 'qd-action-btn qd-btn-quiz' });
            quizBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.close();
                this.plugin.startQuiz(q.difficulty, false, q.folder);
            });

            const bookmarkBtn = cardActions.createEl('button', { 
                text: q.bookmarked ? 'â­ í•´ì œ' : 'â­ ë¶ë§ˆí¬', 
                cls: 'qd-action-btn qd-btn-bookmark' 
            });
            bookmarkBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                await this.toggleBookmark(q);
                // ì¬ë Œë”ë§
                const allQuestions = await this.plugin.loadAllQuestions();
                this.renderQuestions(container, allQuestions);
            });
        });
    }

    getDifficultyIcon(difficulty) {
        const icons = {
            'A+': 'ğŸ†',
            'A': 'â­',
            'A-': 'â­',
            'B': 'ğŸ˜Š',
            'B-': 'ğŸ˜Š',
            'C': 'ğŸ˜',
            'D': 'ğŸ˜°',
            'E': 'ğŸ˜±',
            'F': 'ğŸ’€'
        };
        return icons[difficulty] || 'ğŸ˜';
    }

    getDifficultyColor(difficulty) {
        const colors = {
            'A+': '#ff6b6b',
            'A': '#ffa500',
            'A-': '#ffc107',
            'B': '#4caf50',
            'B-': '#8bc34a',
            'C': '#2196f3',
            'D': '#9c27b0',
            'E': '#e91e63',
            'F': '#000'
        };
        return colors[difficulty] || '#2196f3';
    }

    getTimeAgo(timestamp) {
        const now = Date.now();
        const diff = now - timestamp;
        const minutes = Math.floor(diff / 60000);
        const hours = Math.floor(diff / 3600000);
        const days = Math.floor(diff / 86400000);

        if (minutes < 1) return 'ë°©ê¸ˆ ì „';
        if (minutes < 60) return `${minutes}ë¶„ ì „`;
        if (hours < 24) return `${hours}ì‹œê°„ ì „`;
        if (days < 7) return `${days}ì¼ ì „`;
        if (days < 30) return `${Math.floor(days / 7)}ì£¼ ì „`;
        if (days < 365) return `${Math.floor(days / 30)}ê°œì›” ì „`;
        return `${Math.floor(days / 365)}ë…„ ì „`;
    }

    async toggleBookmark(question) {
        const file = this.app.vault.getAbstractFileByPath(question.filePath);
        if (!file) return;

        const content = await this.app.vault.read(file);
        const newBookmarked = !question.bookmarked;
        
        // frontmatter ì—…ë°ì´íŠ¸
        const newContent = content.replace(
            /^(---\n[\s\S]*?bookmarked:\s*)(true|false)([\s\S]*?---)/,
            `$1${newBookmarked}$3`
        );

        await this.app.vault.modify(file, newContent);
        new Notice(newBookmarked ? 'â­ ë¶ë§ˆí¬ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ë¶ë§ˆí¬ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤');
    }

    addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .question-dashboard-modal {
                padding: 0;
                max-width: 95vw;
                width: 1400px;
                max-height: 90vh;
                overflow-y: auto;
            }
            .qd-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
                border-radius: 10px 10px 0 0;
                margin-bottom: 20px;
            }
            .qd-title {
                font-size: 2rem;
                margin: 0 0 10px 0;
            }
            .qd-subtitle {
                margin: 0;
                opacity: 0.9;
            }
            .qd-stats-container {
                padding: 20px;
                background: var(--background-secondary);
                margin: 0 20px 20px 20px;
                border-radius: 10px;
            }
            .qd-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }
            .qd-stat-card {
                background: var(--background-primary);
                padding: 20px;
                border-radius: 10px;
                text-align: center;
                border-left: 4px solid #2196f3;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .qd-stat-icon {
                font-size: 2rem;
                margin-bottom: 10px;
            }
            .qd-stat-value {
                font-size: 1.8rem;
                font-weight: bold;
                color: var(--text-accent);
            }
            .qd-stat-label {
                font-size: 0.9rem;
                color: var(--text-muted);
                margin-top: 5px;
            }
            .qd-filter-container {
                padding: 20px;
                background: var(--background-secondary);
                margin: 0 20px 20px 20px;
                border-radius: 10px;
            }
            .qd-filter-title {
                margin: 0 0 15px 0;
            }
            .qd-filter-controls {
                display: grid;
                grid-template-columns: 2fr 1fr 1fr 1fr;
                gap: 15px;
                align-items: center;
            }
            @media (max-width: 768px) {
                .qd-filter-controls {
                    grid-template-columns: 1fr;
                }
            }
            .qd-search-container {
                width: 100%;
            }
            .qd-search-input {
                width: 100%;
                padding: 10px 15px;
                border: 2px solid var(--background-modifier-border);
                border-radius: 8px;
                font-size: 1rem;
                background: var(--background-primary);
                color: var(--text-normal);
            }
            .qd-search-input:focus {
                outline: none;
                border-color: #667eea;
            }
            .qd-filter-label {
                font-weight: bold;
                margin-right: 10px;
            }
            .qd-select {
                padding: 8px 12px;
                border: 2px solid var(--background-modifier-border);
                border-radius: 8px;
                background: var(--background-primary);
                color: var(--text-normal);
                cursor: pointer;
            }
            .qd-questions-container {
                padding: 0 20px 20px 20px;
            }
            .qd-questions-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 20px;
            }
            @media (max-width: 768px) {
                .qd-questions-grid {
                    grid-template-columns: 1fr;
                }
            }
            .qd-question-card {
                background: var(--background-primary);
                border: 2px solid var(--background-modifier-border);
                border-radius: 10px;
                padding: 20px;
                cursor: pointer;
                transition: all 0.3s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .qd-question-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 8px 20px rgba(0,0,0,0.2);
                border-color: #667eea;
            }
            .qd-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid var(--background-modifier-border);
            }
            .qd-card-hanzi {
                font-size: 2rem;
                font-weight: bold;
                color: var(--text-accent);
            }
            .qd-card-number {
                font-size: 1rem;
                color: var(--text-muted);
                background: var(--background-secondary);
                padding: 5px 10px;
                border-radius: 5px;
            }
            .qd-card-question {
                margin-bottom: 15px;
                font-size: 1rem;
                line-height: 1.5;
                color: var(--text-normal);
            }
            .qd-card-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-bottom: 15px;
            }
            .qd-badge {
                display: inline-block;
                padding: 5px 10px;
                border-radius: 5px;
                font-size: 0.85rem;
                font-weight: bold;
                color: white;
            }
            .qd-badge-diff {
                background: #2196f3;
            }
            .qd-badge-folder {
                background: #4caf50;
            }
            .qd-card-keywords {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                margin-bottom: 15px;
            }
            .qd-keyword-badge {
                background: var(--background-secondary);
                color: var(--text-normal);
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.8rem;
            }
            .qd-card-actions {
                display: flex;
                gap: 8px;
                margin-top: 15px;
                padding-top: 15px;
                border-top: 2px solid var(--background-modifier-border);
            }
            .qd-action-btn {
                flex: 1;
                padding: 8px 12px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: bold;
                transition: all 0.2s ease;
                min-height: 44px; /* ëª¨ë°”ì¼ í„°ì¹˜ ì˜ì—­ */
                -webkit-tap-highlight-color: transparent;
            }
            @media (max-width: 768px) {
                .qd-action-btn {
                    padding: 12px 8px;
                    font-size: 0.85rem;
                }
                .qd-question-card {
                    padding: 15px;
                }
                .qd-card-hanzi {
                    font-size: 1.5rem;
                }
                .qd-question-card:hover {
                    transform: none; /* ëª¨ë°”ì¼ì—ì„œ hover íš¨ê³¼ ì œê±° */
                }
                .qd-question-card:active {
                    opacity: 0.8; /* í„°ì¹˜ í”¼ë“œë°± */
                }
            }
            .qd-btn-edit {
                background: #2196f3;
                color: white;
            }
            .qd-btn-edit:hover {
                background: #1976d2;
            }
            .qd-btn-quiz {
                background: #4caf50;
                color: white;
            }
            .qd-btn-quiz:hover {
                background: #388e3c;
            }
            .qd-btn-bookmark {
                background: #ffc107;
                color: #000;
            }
            .qd-btn-bookmark:hover {
                background: #ffa000;
            }
            .qd-no-questions {
                text-align: center;
                padding: 40px;
                font-size: 1.2rem;
                color: var(--text-muted);
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ğŸ”§ Git ì„¤ì • ëª¨ë‹¬
class GitSettingsModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('git-settings-modal');
        
        const isMobile = this.app.isMobile || window.innerWidth <= 768;

        // ëª¨ë‹¬ ìŠ¤íƒ€ì¼
        contentEl.style.cssText = `
            padding: ${isMobile ? '16px' : '24px'};
            max-width: ${isMobile ? '100%' : '600px'};
            margin: 0 auto;
        `;

        // í—¤ë”
        const header = contentEl.createDiv({ cls: 'git-settings-header' });
        header.style.cssText = 'margin-bottom: 24px;';
        
        const title = header.createEl('h2', { text: 'ğŸ”§ Git ì„¤ì •' });
        title.style.cssText = 'margin: 0 0 8px 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 24px; font-weight: 700;';
        
        const subtitle = header.createEl('p', { text: 'Git ì €ì¥ì†Œ ìë™ ì»¤ë°‹ ë° ë™ê¸°í™” ì„¤ì •' });
        subtitle.style.cssText = 'margin: 0; color: var(--text-muted); font-size: 14px;';

        // í˜„ì¬ ì„¤ì • ìƒíƒœ í‘œì‹œ
        const statusSection = contentEl.createDiv({ cls: 'git-status-section' });
        statusSection.style.cssText = 'background: var(--background-secondary); padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--background-modifier-border);';
        
        const statusTitle = statusSection.createEl('h3', { text: 'ğŸ“Š í˜„ì¬ ìƒíƒœ' });
        statusTitle.style.cssText = 'margin: 0 0 12px 0; font-size: 16px; font-weight: 600;';
        
        const autoCommit = this.plugin.settings.autoGitCommit !== false;
        const statusText = statusSection.createEl('div');
        statusText.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px;">${autoCommit ? 'âœ…' : 'â­•'}</span>
                <span style="font-weight: 500;">ìë™ ì»¤ë°‹: ${autoCommit ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}</span>
            </div>
            <div style="color: var(--text-muted); font-size: 13px; margin-left: 28px;">
                ${autoCommit ? 'ë¬¸ì œ ìƒì„±/ìˆ˜ì • ì‹œ ìë™ìœ¼ë¡œ Gitì— ì»¤ë°‹ë©ë‹ˆë‹¤' : 'ìˆ˜ë™ìœ¼ë¡œ Git ì»¤ë°‹ì„ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤'}
            </div>
        `;

        // ë¹ ë¥¸ ì•¡ì…˜ ì„¹ì…˜
        const actionsSection = contentEl.createDiv({ cls: 'git-actions-section' });
        actionsSection.style.cssText = 'margin-bottom: 24px;';
        
        const actionsTitle = actionsSection.createEl('h3', { text: 'âš¡ ë¹ ë¥¸ ì•¡ì…˜' });
        actionsTitle.style.cssText = 'margin: 0 0 12px 0; font-size: 16px; font-weight: 600;';
        
        const actionsGrid = actionsSection.createDiv();
        actionsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;';

        // ì•¡ì…˜ ë²„íŠ¼ë“¤
        const actions = [
            {
                icon: 'ğŸš€',
                label: 'ë°”ë¡œ ì»¤ë°‹',
                desc: 'ì¦‰ì‹œ Git ì»¤ë°‹ & í‘¸ì‹œ',
                color: '#48bb78',
                action: async () => {
                    try {
                        new Notice('ğŸš€ Git ì»¤ë°‹ ì‹œì‘...');
                        await this.plugin.autoGitCommitAndPush('âœ¨ ìˆ˜ë™ ì»¤ë°‹ (ëŒ€ì‹œë³´ë“œ)');
                        new Notice('âœ… Git ì»¤ë°‹ ì™„ë£Œ!');
                    } catch (error) {
                        console.error('Git ì»¤ë°‹ ì˜¤ë¥˜:', error);
                        new Notice(`âŒ Git ì»¤ë°‹ ì‹¤íŒ¨: ${error.message}`);
                    }
                }
            },
            {
                icon: 'ğŸ“Š',
                label: 'Git ìƒíƒœ',
                desc: 'ë³€ê²½ëœ íŒŒì¼ í™•ì¸',
                color: '#4299e1',
                action: async () => {
                    try {
                        const { exec } = require('child_process');
                        const { promisify } = require('util');
                        const execAsync = promisify(exec);
                        
                        const { stdout, stderr } = await execAsync('git status --short', {
                            cwd: this.app.vault.adapter.basePath
                        });
                        
                        if (stderr) {
                            new Notice(`âŒ ì˜¤ë¥˜: ${stderr}`);
                            return;
                        }
                        
                        if (!stdout || stdout.trim() === '') {
                            new Notice('âœ¨ ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤');
                        } else {
                            const lines = stdout.trim().split('\n');
                            const statusModal = new Modal(this.app);
                            statusModal.titleEl.setText('ğŸ“Š Git ìƒíƒœ');
                            
                            const content = statusModal.contentEl.createDiv();
                            content.style.cssText = 'padding: 16px; font-family: monospace; white-space: pre-wrap;';
                            
                            const count = content.createEl('p', { 
                                text: `ë³€ê²½ëœ íŒŒì¼: ${lines.length}ê°œ`
                            });
                            count.style.cssText = 'margin-bottom: 12px; font-weight: 600;';
                            
                            const fileList = content.createEl('pre', { text: stdout });
                            fileList.style.cssText = 'background: var(--background-secondary); padding: 12px; border-radius: 6px; font-size: 12px; overflow-x: auto;';
                            
                            statusModal.open();
                        }
                    } catch (error) {
                        console.error('Git ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                        new Notice(`âŒ Git ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: ${error.message}`);
                    }
                }
            },
            {
                icon: autoCommit ? 'â¸ï¸' : 'â–¶ï¸',
                label: autoCommit ? 'ìë™ OFF' : 'ìë™ ON',
                desc: autoCommit ? 'ìë™ ì»¤ë°‹ ë„ê¸°' : 'ìë™ ì»¤ë°‹ ì¼œê¸°',
                color: autoCommit ? '#f56565' : '#667eea',
                action: async () => {
                    this.plugin.settings.autoGitCommit = !autoCommit;
                    await this.plugin.saveSettings();
                    new Notice(autoCommit ? 'â¸ï¸ ìë™ ì»¤ë°‹ ë¹„í™œì„±í™”' : 'â–¶ï¸ ìë™ ì»¤ë°‹ í™œì„±í™”');
                    this.onOpen(); // ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
                }
            }
        ];

        for (const action of actions) {
            const btn = actionsGrid.createEl('button');
            btn.style.cssText = `
                background: linear-gradient(135deg, ${action.color}20 0%, ${action.color}40 100%);
                border: 2px solid ${action.color}60;
                border-radius: 10px;
                padding: ${isMobile ? '14px' : '16px'};
                cursor: pointer;
                transition: all 0.3s;
                text-align: center;
                min-height: ${isMobile ? '100px' : '110px'};
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 6px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            `;
            
            const icon = btn.createEl('div', { text: action.icon });
            icon.style.cssText = 'font-size: 28px;';
            
            const label = btn.createEl('div', { text: action.label });
            label.style.cssText = `font-weight: 700; color: ${action.color}; font-size: 14px;`;
            
            const desc = btn.createEl('div', { text: action.desc });
            desc.style.cssText = 'color: var(--text-muted); font-size: 11px;';
            
            btn.onclick = action.action;
            btn.addEventListener('mouseenter', () => {
                btn.style.transform = 'translateY(-4px)';
                btn.style.boxShadow = `0 6px 16px ${action.color}40`;
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.transform = 'translateY(0)';
                btn.style.boxShadow = 'none';
            });
            btn.addEventListener('touchstart', () => {
                btn.style.opacity = '0.8';
            });
            btn.addEventListener('touchend', () => {
                btn.style.opacity = '1';
            });
        }

        // ê³ ê¸‰ ì„¤ì • ì„¹ì…˜
        const advancedSection = contentEl.createDiv({ cls: 'git-advanced-section' });
        advancedSection.style.cssText = 'margin-bottom: 24px;';
        
        const advancedTitle = advancedSection.createEl('h3', { text: 'ğŸ”§ ê³ ê¸‰ ì„¤ì •' });
        advancedTitle.style.cssText = 'margin: 0 0 12px 0; font-size: 16px; font-weight: 600;';
        
        const settingsList = advancedSection.createDiv();
        settingsList.style.cssText = 'background: var(--background-secondary); padding: 16px; border-radius: 10px; display: flex; flex-direction: column; gap: 14px;';
        
        // ìë™ ì»¤ë°‹ í† ê¸€
        const autoCommitSetting = settingsList.createDiv();
        autoCommitSetting.style.cssText = 'display: flex; justify-content: space-between; align-items: center;';
        
        const autoCommitLabel = autoCommitSetting.createDiv();
        autoCommitLabel.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 4px;">âœ… ìë™ Git ì»¤ë°‹</div>
            <div style="font-size: 12px; color: var(--text-muted);">ë¬¸ì œ ìƒì„±/ìˆ˜ì • ì‹œ ìë™ìœ¼ë¡œ Gitì— ì»¤ë°‹</div>
        `;
        
        const autoCommitToggle = autoCommitSetting.createEl('button', { 
            text: autoCommit ? 'ON' : 'OFF'
        });
        autoCommitToggle.style.cssText = `
            padding: 8px 20px;
            background: ${autoCommit ? '#48bb78' : '#718096'};
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            min-width: 70px;
            transition: all 0.3s;
        `;
        autoCommitToggle.onclick = async () => {
            this.plugin.settings.autoGitCommit = !autoCommit;
            await this.plugin.saveSettings();
            new Notice(autoCommit ? 'â¸ï¸ ìë™ ì»¤ë°‹ ë¹„í™œì„±í™”' : 'â–¶ï¸ ìë™ ì»¤ë°‹ í™œì„±í™”');
            this.onOpen();
        };

        // ë„ì›€ë§ ì„¹ì…˜
        const helpSection = contentEl.createDiv({ cls: 'git-help-section' });
        helpSection.style.cssText = 'background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 16px; border-radius: 10px; border: 2px solid rgba(102, 126, 234, 0.3);';
        
        const helpTitle = helpSection.createEl('h3', { text: 'ğŸ’¡ ë„ì›€ë§' });
        helpTitle.style.cssText = 'margin: 0 0 10px 0; font-size: 15px; font-weight: 600;';
        
        const helpContent = helpSection.createEl('div');
        helpContent.innerHTML = `
            <ul style="margin: 0; padding-left: 20px; color: var(--text-muted); font-size: 13px; line-height: 1.8;">
                <li><strong>ìë™ ì»¤ë°‹ ON</strong>: ë¬¸ì œë¥¼ ë§Œë“¤ê±°ë‚˜ ìˆ˜ì •í•˜ë©´ ìë™ìœ¼ë¡œ Gitì— ì €ì¥ë©ë‹ˆë‹¤</li>
                <li><strong>ìë™ ì»¤ë°‹ OFF</strong>: ìˆ˜ë™ìœ¼ë¡œ "ë°”ë¡œ ì»¤ë°‹" ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ í•©ë‹ˆë‹¤</li>
                <li><strong>ë°”ë¡œ ì»¤ë°‹</strong>: í˜„ì¬ ë³€ê²½ì‚¬í•­ì„ ì¦‰ì‹œ Gitì— ì €ì¥í•˜ê³  í‘¸ì‹œí•©ë‹ˆë‹¤</li>
                <li><strong>Git ìƒíƒœ</strong>: ì–´ë–¤ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            </ul>
        `;

        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = contentEl.createEl('button', { text: 'âœ• ë‹«ê¸°' });
        closeBtn.style.cssText = `
            width: 100%;
            padding: ${isMobile ? '14px' : '12px'};
            background: var(--interactive-normal);
            color: var(--text-normal);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s;
        `;
        closeBtn.onclick = () => this.close();
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'var(--interactive-hover)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'var(--interactive-normal)';
        });
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ë¶ë§ˆí¬ í´ë” ê´€ë¦¬ ëª¨ë‹¬
class BookmarkFolderManagementModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('bookmark-folder-management-modal');
        
        const isMobile = this.app.isMobile || window.innerWidth <= 768;
        
        contentEl.style.cssText = `
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: ${isMobile ? '85vh' : '90vh'};
            overflow: hidden;
            padding: ${isMobile ? '12px' : '20px'};
        `;

        // í—¤ë”
        const header = contentEl.createDiv({ cls: 'modal-header-fixed' });
        header.style.cssText = `
            flex: 0 0 auto;
            padding-bottom: ${isMobile ? '8px' : '10px'};
            border-bottom: 1px solid var(--background-modifier-border);
            margin-bottom: ${isMobile ? '8px' : '10px'};
        `;
        header.createEl('h2', { text: 'â­ ë¶ë§ˆí¬ í´ë” ê´€ë¦¬', attr: { style: isMobile ? 'font-size: 20px; margin: 0 0 8px 0;' : 'margin: 0 0 10px 0;' } });

        const desc = header.createDiv({ cls: 'bookmark-desc' });
        desc.innerHTML = 'ë¶ë§ˆí¬ í´ë”ë¥¼ ì¶”ê°€, ìˆ˜ì •, ì‚­ì œí•˜ê³  ì •ë ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
        desc.style.cssText = `font-size: ${isMobile ? '13px' : '14px'}; color: var(--text-muted); padding: ${isMobile ? '8px' : '10px'}; background: var(--background-secondary); border-radius: 6px; margin-bottom: ${isMobile ? '8px' : '10px'};`;

        // íƒ­ ë²„íŠ¼
        const tabContainer = header.createDiv({ cls: 'tab-container' });
        tabContainer.style.cssText = `display: flex; gap: 8px; margin-bottom: ${isMobile ? '8px' : '10px'};`;
        
        const questionTabBtn = tabContainer.createEl('button', { text: 'ğŸ“ ë¬¸ì œ ë¶ë§ˆí¬ í´ë”', cls: 'tab-btn active' });
        questionTabBtn.style.cssText = `flex: 1; padding: ${isMobile ? '10px' : '8px 12px'}; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; background: var(--interactive-accent); color: var(--text-on-accent); min-height: ${isMobile ? '44px' : 'auto'};`;
        
        const optionTabBtn = tabContainer.createEl('button', { text: 'ğŸ”¹ ì„ íƒì§€ ë¶ë§ˆí¬ í´ë”', cls: 'tab-btn' });
        optionTabBtn.style.cssText = `flex: 1; padding: ${isMobile ? '10px' : '8px 12px'}; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; background: var(--background-secondary); color: var(--text-normal); min-height: ${isMobile ? '44px' : 'auto'};`;

        // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­
        const scrollContainer = contentEl.createDiv({ cls: 'bookmark-scroll-container' });
        scrollContainer.style.cssText = `
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: ${isMobile ? '5px 2px' : '10px 5px'};
            margin: ${isMobile ? '5px 0' : '10px 0'};
            -webkit-overflow-scrolling: touch;
        `;

        // ì»¨í…ì¸  ì˜ì—­ (íƒ­ë³„ë¡œ ì „í™˜)
        const questionContent = scrollContainer.createDiv({ cls: 'question-bookmark-content' });
        const optionContent = scrollContainer.createDiv({ cls: 'option-bookmark-content' });
        optionContent.style.display = 'none';

        // íƒ­ ì „í™˜ í•¸ë“¤ëŸ¬
        const switchTab = (activeBtn, inactiveBtn, showContent, hideContent) => {
            activeBtn.style.background = 'var(--interactive-accent)';
            activeBtn.style.color = 'var(--text-on-accent)';
            inactiveBtn.style.background = 'var(--background-secondary)';
            inactiveBtn.style.color = 'var(--text-normal)';
            showContent.style.display = 'block';
            hideContent.style.display = 'none';
        };

        questionTabBtn.onclick = () => switchTab(questionTabBtn, optionTabBtn, questionContent, optionContent);
        optionTabBtn.onclick = () => switchTab(optionTabBtn, questionTabBtn, optionContent, questionContent);

        // ëª¨ë“  ë¶ë§ˆí¬ í´ë” ìˆ˜ì§‘
        const questions = await this.plugin.loadAllQuestions();
        const questionBookmarkFolders = new Set();
        const optionBookmarkFolders = new Set();
        
        for (const q of questions) {
            if (q.bookmarkFolder && q.bookmarkFolder.length > 0) {
                questionBookmarkFolders.add(q.bookmarkFolder);
            }
            if (q.optionBookmarkFolders) {
                q.optionBookmarkFolders.forEach(f => {
                    if (f && f.length > 0) optionBookmarkFolders.add(f);
                });
            }
        }

        // ì •ë ¬ ìˆœì„œ ê°€ì ¸ì˜¤ê¸°
        if (!this.plugin.settings.bookmarkFolderOrder) {
            this.plugin.settings.bookmarkFolderOrder = [];
        }

        // ë¬¸ì œ ë¶ë§ˆí¬ í´ë” ë Œë”ë§
        this.renderBookmarkFolders(questionContent, Array.from(questionBookmarkFolders), questions, 'question', isMobile);
        
        // ì„ íƒì§€ ë¶ë§ˆí¬ í´ë” ë Œë”ë§
        this.renderBookmarkFolders(optionContent, Array.from(optionBookmarkFolders), questions, 'option', isMobile);

        // í•˜ë‹¨ ë²„íŠ¼
        const footer = contentEl.createDiv({ cls: 'modal-footer-fixed' });
        footer.style.cssText = `
            flex: 0 0 auto;
            padding-top: ${isMobile ? '8px' : '10px'};
            border-top: 1px solid var(--background-modifier-border);
            margin-top: ${isMobile ? '8px' : '10px'};
            display: flex;
            gap: ${isMobile ? '6px' : '8px'};
        `;

        const addBtn = footer.createEl('button', { text: 'â• ìƒˆ í´ë” ì¶”ê°€' });
        addBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; min-height: ${isMobile ? '48px' : 'auto'};`;
        addBtn.onclick = () => {
            const currentTab = questionTabBtn.style.background.includes('accent') ? 'question' : 'option';
            this.showAddFolderModal(currentTab, isMobile);
        };

        const closeBtn = footer.createEl('button', { text: 'âœ• ë‹«ê¸°' });
        closeBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '48px' : 'auto'};`;
        closeBtn.onclick = () => this.close();
    }

    renderBookmarkFolders(container, folders, questions, type, isMobile) {
        container.empty();

        // ì •ë ¬ ìˆœì„œëŒ€ë¡œ ì •ë ¬
        const sortedFolders = folders.sort((a, b) => {
            const orderA = (this.plugin.settings.bookmarkFolderOrder || []).indexOf(a);
            const orderB = (this.plugin.settings.bookmarkFolderOrder || []).indexOf(b);
            if (orderA === -1 && orderB === -1) return a.localeCompare(b);
            if (orderA === -1) return 1;
            if (orderB === -1) return -1;
            return orderA - orderB;
        });

        if (sortedFolders.length === 0) {
            const emptyMsg = container.createEl('p', { 
                text: type === 'question' ? 'ë¬¸ì œ ë¶ë§ˆí¬ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.' : 'ì„ íƒì§€ ë¶ë§ˆí¬ í´ë”ê°€ ì—†ìŠµë‹ˆë‹¤.',
                cls: 'empty-message'
            });
            emptyMsg.style.cssText = 'text-align: center; color: var(--text-muted); padding: 40px 20px; font-size: 14px;';
            return;
        }

        const folderList = container.createDiv({ cls: 'folder-list' });
        folderList.style.cssText = 'display: flex; flex-direction: column; gap: 8px;';

        sortedFolders.forEach((folder, index) => {
            // í´ë”ë³„ ë¬¸ì œ ìˆ˜ ê³„ì‚°
            let count = 0;
            if (type === 'question') {
                count = questions.filter(q => q.bookmarkFolder === folder).length;
            } else {
                count = questions.reduce((sum, q) => {
                    if (!q.optionBookmarkFolders) return sum;
                    return sum + q.optionBookmarkFolders.filter(f => f === folder).length;
                }, 0);
            }

            const folderCard = folderList.createDiv({ cls: 'bookmark-folder-item' });
            folderCard.style.cssText = `
                display: flex;
                align-items: center;
                gap: ${isMobile ? '8px' : '10px'};
                padding: ${isMobile ? '12px' : '12px 15px'};
                background: var(--background-secondary);
                border-radius: 8px;
                border: 2px solid var(--background-modifier-border);
                transition: all 0.2s;
            `;

            // ë“œë˜ê·¸ í•¸ë“¤
            const dragHandle = folderCard.createEl('div', { text: 'â˜°' });
            dragHandle.style.cssText = `cursor: grab; color: var(--text-muted); font-size: 18px; padding: ${isMobile ? '4px 8px' : '0 5px'}; min-width: ${isMobile ? '36px' : '24px'}; text-align: center;`;
            dragHandle.draggable = true;
            
            dragHandle.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index.toString());
                folderCard.style.opacity = '0.5';
            });

            dragHandle.addEventListener('dragend', () => {
                folderCard.style.opacity = '1';
            });

            folderCard.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                folderCard.style.borderColor = 'var(--interactive-accent)';
            });

            folderCard.addEventListener('dragleave', () => {
                folderCard.style.borderColor = 'var(--background-modifier-border)';
            });

            folderCard.addEventListener('drop', async (e) => {
                e.preventDefault();
                folderCard.style.borderColor = 'var(--background-modifier-border)';
                
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const toIndex = index;
                
                if (fromIndex !== toIndex) {
                    // ìˆœì„œ ë³€ê²½
                    const newOrder = [...sortedFolders];
                    const [moved] = newOrder.splice(fromIndex, 1);
                    newOrder.splice(toIndex, 0, moved);
                    
                    // ì„¤ì •ì— ì €ì¥
                    this.plugin.settings.bookmarkFolderOrder = newOrder;
                    await this.plugin.saveSettings();
                    
                    // ë¦¬ë Œë”ë§
                    this.renderBookmarkFolders(container, folders, questions, type, isMobile);
                    new Notice('âœ… í´ë” ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });

            // í´ë” ì•„ì´ì½˜
            const icon = folderCard.createEl('div', { text: 'â­' });
            icon.style.cssText = `font-size: ${isMobile ? '24px' : '20px'};`;

            // í´ë” ì •ë³´
            const folderInfo = folderCard.createDiv();
            folderInfo.style.cssText = 'flex: 1; min-width: 0;';
            
            const folderName = folderInfo.createEl('div', { text: folder });
            folderName.style.cssText = `font-weight: 600; font-size: ${isMobile ? '15px' : '14px'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;`;
            
            const folderCount = folderInfo.createEl('div', { text: `${count}ê°œ` });
            folderCount.style.cssText = `font-size: ${isMobile ? '13px' : '12px'}; color: var(--text-muted);`;

            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
            const buttonContainer = folderCard.createDiv();
            buttonContainer.style.cssText = `display: flex; gap: ${isMobile ? '6px' : '5px'};`;

            // ìˆ˜ì • ë²„íŠ¼
            const editBtn = buttonContainer.createEl('button', { text: 'âœï¸' });
            editBtn.style.cssText = `padding: ${isMobile ? '8px 12px' : '6px 10px'}; background: var(--interactive-normal); border: none; border-radius: 5px; cursor: pointer; font-size: ${isMobile ? '16px' : '14px'}; min-height: ${isMobile ? '40px' : 'auto'}; min-width: ${isMobile ? '40px' : 'auto'};`;
            editBtn.onclick = () => this.showEditFolderModal(folder, type, isMobile);

            // ì‚­ì œ ë²„íŠ¼
            const deleteBtn = buttonContainer.createEl('button', { text: 'ğŸ—‘ï¸' });
            deleteBtn.style.cssText = `padding: ${isMobile ? '8px 12px' : '6px 10px'}; background: var(--background-modifier-error); color: var(--text-on-accent); border: none; border-radius: 5px; cursor: pointer; font-size: ${isMobile ? '16px' : '14px'}; min-height: ${isMobile ? '40px' : 'auto'}; min-width: ${isMobile ? '40px' : 'auto'};`;
            deleteBtn.onclick = () => this.showDeleteFolderModal(folder, type, count, isMobile);
        });
    }

    showAddFolderModal(type, isMobile) {
        const addModal = new Modal(this.app);
        addModal.titleEl.setText(type === 'question' ? 'ğŸ“ ìƒˆ ë¬¸ì œ ë¶ë§ˆí¬ í´ë” ì¶”ê°€' : 'ğŸ”¹ ìƒˆ ì„ íƒì§€ ë¶ë§ˆí¬ í´ë” ì¶”ê°€');
        addModal.contentEl.style.cssText = `padding: 20px; min-width: ${isMobile ? '90vw' : '400px'};`;

        const inputContainer = addModal.contentEl.createDiv();
        inputContainer.createEl('label', { text: 'í´ë” ì´ë¦„' }).style.cssText = 'display: block; margin-bottom: 8px; font-weight: 600;';
        
        const input = inputContainer.createEl('input', { type: 'text', placeholder: 'ì˜ˆ: ì¤‘ìš”í•œ ë¬¸ì œ' });
        input.style.cssText = `width: 100%; padding: ${isMobile ? '12px' : '10px'}; border: 1px solid var(--background-modifier-border); border-radius: 6px; font-size: ${isMobile ? '16px' : '14px'}; margin-bottom: 16px;`;

        const btnContainer = addModal.contentEl.createDiv();
        btnContainer.style.cssText = 'display: flex; gap: 8px;';

        const saveBtn = btnContainer.createEl('button', { text: 'âœ… ì¶”ê°€' });
        saveBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '48px' : 'auto'};`;
        saveBtn.onclick = async () => {
            const folderName = input.value.trim();
            if (!folderName) {
                new Notice('âš ï¸ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            // ì¤‘ë³µ í™•ì¸
            const questions = await this.plugin.loadAllQuestions();
            const allFolders = new Set();
            for (const q of questions) {
                if (q.bookmarkFolder) allFolders.add(q.bookmarkFolder);
                if (q.optionBookmarkFolders) {
                    q.optionBookmarkFolders.forEach(f => { if (f) allFolders.add(f); });
                }
            }

            if (allFolders.has(folderName)) {
                new Notice('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í´ë” ì´ë¦„ì…ë‹ˆë‹¤');
                return;
            }

            // ì •ë ¬ ìˆœì„œì— ì¶”ê°€ (ë§¨ ë’¤)
            if (!this.plugin.settings.bookmarkFolderOrder) {
                this.plugin.settings.bookmarkFolderOrder = [];
            }
            this.plugin.settings.bookmarkFolderOrder.push(folderName);
            await this.plugin.saveSettings();

            new Notice(`âœ… "${folderName}" í´ë”ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤`);
            addModal.close();
            
            // ë¦¬í”„ë ˆì‹œ
            this.onOpen();
        };

        const cancelBtn = btnContainer.createEl('button', { text: 'âŒ ì·¨ì†Œ' });
        cancelBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '48px' : 'auto'};`;
        cancelBtn.onclick = () => addModal.close();

        addModal.open();
        input.focus();
    }

    showEditFolderModal(oldName, type, isMobile) {
        const editModal = new Modal(this.app);
        editModal.titleEl.setText(`âœï¸ "${oldName}" í´ë” ì´ë¦„ ìˆ˜ì •`);
        editModal.contentEl.style.cssText = `padding: 20px; min-width: ${isMobile ? '90vw' : '400px'};`;

        const inputContainer = editModal.contentEl.createDiv();
        inputContainer.createEl('label', { text: 'ìƒˆ í´ë” ì´ë¦„' }).style.cssText = 'display: block; margin-bottom: 8px; font-weight: 600;';
        
        const input = inputContainer.createEl('input', { type: 'text', value: oldName });
        input.style.cssText = `width: 100%; padding: ${isMobile ? '12px' : '10px'}; border: 1px solid var(--background-modifier-border); border-radius: 6px; font-size: ${isMobile ? '16px' : '14px'}; margin-bottom: 16px;`;

        const btnContainer = editModal.contentEl.createDiv();
        btnContainer.style.cssText = 'display: flex; gap: 8px;';

        const saveBtn = btnContainer.createEl('button', { text: 'ğŸ’¾ ì €ì¥' });
        saveBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '48px' : 'auto'};`;
        saveBtn.onclick = async () => {
            const newName = input.value.trim();
            if (!newName) {
                new Notice('âš ï¸ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }

            if (newName === oldName) {
                editModal.close();
                return;
            }

            // ëª¨ë“  ë¬¸ì œ ì—…ë°ì´íŠ¸
            const questions = await this.plugin.loadAllQuestions();
            let updatedCount = 0;

            for (const q of questions) {
                let needUpdate = false;

                if (type === 'question' && q.bookmarkFolder === oldName) {
                    q.bookmarkFolder = newName;
                    needUpdate = true;
                }

                if (type === 'option' && q.optionBookmarkFolders) {
                    for (let i = 0; i < q.optionBookmarkFolders.length; i++) {
                        if (q.optionBookmarkFolders[i] === oldName) {
                            q.optionBookmarkFolders[i] = newName;
                            needUpdate = true;
                        }
                    }
                }

                if (needUpdate) {
                    // íŒŒì¼ ì—…ë°ì´íŠ¸
                    const file = this.app.vault.getAbstractFileByPath(q.filePath);
                    if (file) {
                        const content = this.plugin.generateQuestionContent(q);
                        await this.app.vault.modify(file, content);
                        updatedCount++;
                    }
                }
            }

            // ì •ë ¬ ìˆœì„œ ì—…ë°ì´íŠ¸
            if (this.plugin.settings.bookmarkFolderOrder) {
                const index = this.plugin.settings.bookmarkFolderOrder.indexOf(oldName);
                if (index !== -1) {
                    this.plugin.settings.bookmarkFolderOrder[index] = newName;
                }
            }
            await this.plugin.saveSettings();

            new Notice(`âœ… "${oldName}" â†’ "${newName}" (${updatedCount}ê°œ ë¬¸ì œ ì—…ë°ì´íŠ¸)`);
            editModal.close();
            
            // ë¦¬í”„ë ˆì‹œ
            this.onOpen();
        };

        const cancelBtn = btnContainer.createEl('button', { text: 'âŒ ì·¨ì†Œ' });
        cancelBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '48px' : 'auto'};`;
        cancelBtn.onclick = () => editModal.close();

        editModal.open();
        input.focus();
        input.select();
    }

    showDeleteFolderModal(folderName, type, count, isMobile) {
        const deleteModal = new Modal(this.app);
        deleteModal.titleEl.setText(`ğŸ—‘ï¸ "${folderName}" í´ë” ì‚­ì œ`);
        deleteModal.contentEl.style.cssText = `padding: 20px; min-width: ${isMobile ? '90vw' : '400px'};`;

        const warning = deleteModal.contentEl.createDiv();
        warning.innerHTML = `
            <p style="margin-bottom: 12px; color: var(--text-normal);">ì´ í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <p style="margin-bottom: 12px; color: var(--text-muted); font-size: 13px;">ì˜í–¥ë°›ëŠ” ${type === 'question' ? 'ë¬¸ì œ' : 'ì„ íƒì§€'}: <strong>${count}ê°œ</strong></p>
            <p style="color: var(--text-error); font-size: 13px; background: var(--background-modifier-error); padding: 10px; border-radius: 6px;">âš ï¸ ë¶ë§ˆí¬ í‘œì‹œê°€ ì œê±°ë˜ì§€ë§Œ, ë¬¸ì œ ìì²´ëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
        `;

        const btnContainer = deleteModal.contentEl.createDiv();
        btnContainer.style.cssText = 'display: flex; gap: 8px; margin-top: 16px;';

        const confirmBtn = btnContainer.createEl('button', { text: 'ğŸ—‘ï¸ ì‚­ì œ' });
        confirmBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--background-modifier-error); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '48px' : 'auto'};`;
        confirmBtn.onclick = async () => {
            // ëª¨ë“  ë¬¸ì œì—ì„œ ì´ í´ë” ì œê±°
            const questions = await this.plugin.loadAllQuestions();
            let updatedCount = 0;

            for (const q of questions) {
                let needUpdate = false;

                if (type === 'question' && q.bookmarkFolder === folderName) {
                    q.bookmarkFolder = '';
                    needUpdate = true;
                }

                if (type === 'option' && q.optionBookmarkFolders) {
                    for (let i = 0; i < q.optionBookmarkFolders.length; i++) {
                        if (q.optionBookmarkFolders[i] === folderName) {
                            q.optionBookmarkFolders[i] = '';
                            needUpdate = true;
                        }
                    }
                }

                if (needUpdate) {
                    const file = this.app.vault.getAbstractFileByPath(q.filePath);
                    if (file) {
                        const content = this.plugin.generateQuestionContent(q);
                        await this.app.vault.modify(file, content);
                        updatedCount++;
                    }
                }
            }

            // ì •ë ¬ ìˆœì„œì—ì„œ ì œê±°
            if (this.plugin.settings.bookmarkFolderOrder) {
                const index = this.plugin.settings.bookmarkFolderOrder.indexOf(folderName);
                if (index !== -1) {
                    this.plugin.settings.bookmarkFolderOrder.splice(index, 1);
                }
            }
            await this.plugin.saveSettings();

            new Notice(`âœ… "${folderName}" í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ (${updatedCount}ê°œ ë¶ë§ˆí¬ ì œê±°)`);
            deleteModal.close();
            
            // ë¦¬í”„ë ˆì‹œ
            this.onOpen();
        };

        const cancelBtn = btnContainer.createEl('button', { text: 'âŒ ì·¨ì†Œ' });
        cancelBtn.style.cssText = `flex: 1; padding: ${isMobile ? '12px' : '10px'}; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; min-height: ${isMobile ? '48px' : 'auto'};`;
        cancelBtn.onclick = () => deleteModal.close();

        deleteModal.open();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class HanziQuestionModal extends Modal {
    constructor(app, plugin, existingQuestion = null) {
        super(app);
        this.plugin = plugin;
        this.existingQuestion = existingQuestion;
        this.question = existingQuestion || {
            hanzi: '',
            number: '',
            question: '',
            options: ['', '', '', ''],
            optionImages: ['', '', '', ''],
            optionImageHints: ['', '', '', ''],
            answer: 0,
            hint: '',
            hintImage: '',
            note: '',
            noteImage: '',
            difficulty: 'C',
            image: '',
            wrongCount: 0,
            correctCount: 0,
            bookmarked: false
        };
        // ê¸°ì¡´ ë¬¸ì œì— ì—†ëŠ” í•„ë“œ ì´ˆê¸°í™”
        if (!this.question.optionImages) this.question.optionImages = [];
        if (!this.question.optionImageHints) this.question.optionImageHints = [];
        if (!this.question.hintImage) this.question.hintImage = '';
        if (!this.question.noteImage) this.question.noteImage = '';
        
        // ë””ë²„ê¹…: í¸ì§‘ ëª¨ë‹¬ ì—´ë¦´ ë•Œ optionImages í™•ì¸
        console.log('ğŸ¨ [í¸ì§‘ ëª¨ë‹¬ ì—´ë¦¼] optionImages:', this.question.optionImages);
        console.log('ğŸ¨ [í¸ì§‘ ëª¨ë‹¬ ì—´ë¦¼] options:', this.question.options);
        
        // ë¬¸ì œ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        this.updateListener = (event) => {
            const { questionPath, questionData } = event.detail;
            if (this.existingQuestion && this.existingQuestion.filePath === questionPath) {
                console.log('ğŸ“¥ [ë¬¸ì œ í¸ì§‘ ëª¨ë‹¬] quiz-question-updated ì´ë²¤íŠ¸ ìˆ˜ì‹ ');
                console.log('ğŸ”„ [ë¬¸ì œ í¸ì§‘ ëª¨ë‹¬] ë…¸íŠ¸ í•„ë“œ ì—…ë°ì´íŠ¸:', questionData.note);
                
                // ë…¸íŠ¸ í•„ë“œ ì—…ë°ì´íŠ¸
                this.question.note = questionData.note;
                this.question.noteImage = questionData.noteImage;
                
                // ë…¸íŠ¸ ì…ë ¥ í•„ë“œê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                if (this.noteTextarea) {
                    this.noteTextarea.value = questionData.note || '';
                    console.log('âœ… [ë¬¸ì œ í¸ì§‘ ëª¨ë‹¬] ë…¸íŠ¸ í…ìŠ¤íŠ¸ ì˜ì—­ ì—…ë°ì´íŠ¸ë¨');
                }
            }
        };
        window.addEventListener('quiz-question-updated', this.updateListener);
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ë“±ë¡ (Escape ì œì™¸í•œ ëª¨ë“  í‚¤ í—ˆìš©)
        this.scope.register([], 'Escape', () => {
            this.close();
            return false;
        });
    }

    // ê³µí†µ ì´ë¯¸ì§€ ì—…ë¡œë“œ UI ìƒì„± í•¨ìˆ˜ (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì›)
    createImageUploader(container, getValue, setValue, label = 'ì´ë¯¸ì§€') {
        const imageContainer = container.createDiv({ cls: 'image-upload-container' });
        imageContainer.style.marginTop = '10px';

        // ì´ë¯¸ì§€ í¬ê¸° ì„¤ì • ì˜ì—­
        const sizeControlDiv = imageContainer.createDiv({ cls: 'image-size-control' });
        sizeControlDiv.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 8px;';
        
        sizeControlDiv.createEl('span', { text: 'ì´ë¯¸ì§€ í¬ê¸°:' });
        
        const widthInput = sizeControlDiv.createEl('input', {
            type: 'number',
            placeholder: 'ë„ˆë¹„',
            value: '400'
        });
        widthInput.style.cssText = 'width: 80px; padding: 4px;';
        
        sizeControlDiv.createEl('span', { text: 'px' });
        
        const autoSizeCheckbox = sizeControlDiv.createEl('input', { type: 'checkbox' });
        autoSizeCheckbox.id = 'auto-size-' + Math.random();
        const autoSizeLabel = sizeControlDiv.createEl('label', { 
            text: 'í¬ê¸° ì§€ì • ì•ˆí•¨',
            attr: { for: autoSizeCheckbox.id }
        });
        autoSizeLabel.style.cssText = 'cursor: pointer; margin-left: 4px;';
        
        // ìë™ í¬ê¸° ì²´í¬ë°•ìŠ¤ ì´ë²¤íŠ¸
        autoSizeCheckbox.addEventListener('change', () => {
            widthInput.disabled = autoSizeCheckbox.checked;
        });

        // ì´ë¯¸ì§€ URL ì…ë ¥ í•„ë“œ
        const imageInput = imageContainer.createEl('textarea', {
            placeholder: 'ì´ë¯¸ì§€ URL ë˜ëŠ” [[íŒŒì¼ëª…]] (ì—¬ëŸ¬ ê°œëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)',
            value: getValue() || ''
        });
        imageInput.style.width = '100%';
        imageInput.style.padding = '8px';
        imageInput.style.minHeight = '60px';
        imageInput.style.resize = 'vertical';
        imageInput.addEventListener('input', (e) => {
            console.log(`âŒ¨ï¸ [ì…ë ¥ ì´ë²¤íŠ¸] ${label} ê°’ ë³€ê²½:`, e.target.value ? e.target.value.substring(0, 50) + '...' : '(ë¹„ì–´ìˆìŒ)');
            setValue(e.target.value);
            updateImagePreview();
        });

        // textareaì— ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì§€ì›
        imageInput.addEventListener('paste', async (e) => {
            const items = e.clipboardData?.items;
            if (!items) return;

            let imageFound = false;
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    imageFound = true;

                    const blob = item.getAsFile();
                    if (!blob) continue;

                    try {
                        // í´ë”ë³„ ì²¨ë¶€íŒŒì¼ ê²½ë¡œ
                        const folderName = this.question.folder || 'default';
                        const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                        const attachmentFolder = `${this.plugin.settings.quizFolder}/${folderName}/${attachmentFolderName}`;
                        const folderExists = await this.app.vault.adapter.exists(attachmentFolder);
                        if (!folderExists) {
                            await this.app.vault.createFolder(attachmentFolder);
                        }

                        // íŒŒì¼ëª… ìƒì„± (ë°€ë¦¬ì´ˆ í¬í•¨)
                        const now = new Date();
                        const year = now.getFullYear();
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const day = String(now.getDate()).padStart(2, '0');
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        const seconds = String(now.getSeconds()).padStart(2, '0');
                        const millis = String(now.getMilliseconds()).padStart(3, '0');

                        const extension = item.type.split('/')[1] || 'png';
                        const fileName = `Pasted image ${year}${month}${day}${hours}${minutes}${seconds}${millis}.${extension}`;
                        const filePath = `${attachmentFolder}/${fileName}`;

                        const arrayBuffer = await blob.arrayBuffer();
                        await this.app.vault.adapter.writeBinary(filePath, new Uint8Array(arrayBuffer));

                        // ì´ë¯¸ì§€ í¬ê¸° ì˜µì…˜ ì ìš©
                        let newImageLink = `![[${folderName}/${attachmentFolderName}/${fileName}`;
                        if (!autoSizeCheckbox.checked && widthInput.value) {
                            newImageLink += `|${widthInput.value}`;
                        }
                        newImageLink += ']]';

                        // ê¸°ì¡´ ê°’ì— ì¶”ê°€
                        const existingValue = getValue() || '';
                        const newValue = existingValue 
                            ? existingValue + '\n' + newImageLink
                            : newImageLink;

                        console.log(`ğŸ“‹ [ë¶™ì—¬ë„£ê¸°] ${label} ì´ë¯¸ì§€ ì¶”ê°€:`, newImageLink);
                        setValue(newValue);
                        imageInput.value = newValue;
                        updateImagePreview();

                        new Notice(`âœ… ${label} ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì™„ë£Œ`);
                    } catch (error) {
                        console.error('ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨:', error);
                        new Notice(`âŒ ${label} ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨`);
                    }
                    break;
                }
            }
        });

        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (2ì¤„ë¡œ ë°°ì¹˜)
        const buttonRow1 = imageContainer.createDiv({ cls: 'image-button-row' });
        buttonRow1.style.display = 'flex';
        buttonRow1.style.gap = '8px';
        buttonRow1.style.marginTop = '8px';

        const buttonRow2 = imageContainer.createDiv({ cls: 'image-button-row' });
        buttonRow2.style.display = 'flex';
        buttonRow2.style.gap = '8px';
        buttonRow2.style.marginTop = '8px';

        // ì²« ë²ˆì§¸ ì¤„: ì „ì²´ êµì²´ ë²„íŠ¼ë“¤
        const uploadBtn = buttonRow1.createEl('button', {
            text: 'ğŸ“ ì„ íƒ',
            cls: 'image-upload-btn'
        });
        uploadBtn.style.flex = '1';
        uploadBtn.style.padding = '8px 12px';
        uploadBtn.style.fontSize = '12px';
        uploadBtn.type = 'button';
        uploadBtn.style.touchAction = 'manipulation';
        uploadBtn.style.userSelect = 'none';
        uploadBtn.style.webkitTapHighlightColor = 'transparent';

        const clipboardBtn = buttonRow1.createEl('button', {
            text: 'ğŸ“‹ ë¶™ì—¬ë„£ê¸°',
            cls: 'image-clipboard-btn'
        });
        clipboardBtn.style.flex = '1';
        clipboardBtn.style.padding = '8px 12px';
        clipboardBtn.style.fontSize = '12px';
        clipboardBtn.type = 'button';
        clipboardBtn.style.touchAction = 'manipulation';
        clipboardBtn.style.userSelect = 'none';
        clipboardBtn.style.webkitTapHighlightColor = 'transparent';
        
        // ëª¨ë°”ì¼ì—ì„œëŠ” ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½ (ì‘ë™ ì•ˆ í•¨ í‘œì‹œ)
        if (this.app.isMobile) {
            clipboardBtn.style.opacity = '0.5';
            clipboardBtn.title = 'ëª¨ë°”ì¼ì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íŒŒì¼ ì„ íƒì„ ì‚¬ìš©í•˜ì„¸ìš”.';
        }

        // ë‘ ë²ˆì§¸ ì¤„: ì¶”ê°€ ì—…ë¡œë“œ ë²„íŠ¼ë“¤
        const addUploadBtn = buttonRow2.createEl('button', {
            text: 'â• ì¶”ê°€',
            cls: 'image-add-upload-btn'
        });
        addUploadBtn.style.flex = '1';
        addUploadBtn.style.padding = '8px 12px';
        addUploadBtn.style.fontSize = '12px';
        addUploadBtn.type = 'button';
        addUploadBtn.style.background = 'var(--interactive-accent)';
        addUploadBtn.style.color = 'var(--text-on-accent)';
        addUploadBtn.style.touchAction = 'manipulation';
        addUploadBtn.style.userSelect = 'none';
        addUploadBtn.style.webkitTapHighlightColor = 'transparent';

        const clearBtn = buttonRow2.createEl('button', {
            text: 'ğŸ—‘ï¸ ì‚­ì œ',
            cls: 'image-clear-btn'
        });
        clearBtn.style.flex = '1';
        clearBtn.style.padding = '8px 12px';
        clearBtn.style.fontSize = '12px';
        clearBtn.type = 'button';
        clearBtn.style.touchAction = 'manipulation';
        clearBtn.style.userSelect = 'none';
        clearBtn.style.webkitTapHighlightColor = 'transparent';

        // í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€
        [uploadBtn, clipboardBtn, addUploadBtn, clearBtn].forEach(btn => {
            btn.addEventListener('touchstart', () => {
                btn.style.opacity = '0.7';
            });
            btn.addEventListener('touchend', () => {
                btn.style.opacity = '1';
            });
            btn.addEventListener('touchcancel', () => {
                btn.style.opacity = '1';
            });
        });

        // ìˆ¨ê²¨ì§„ íŒŒì¼ ì…ë ¥ë“¤
        const fileInput = imageContainer.createEl('input', {
            type: 'file',
            attr: { 
                accept: 'image/*',
                multiple: true
            }
        });
        fileInput.style.display = 'none';

        const addFileInput = imageContainer.createEl('input', {
            type: 'file',
            attr: { 
                accept: 'image/*',
                multiple: true
            }
        });
        addFileInput.style.display = 'none';

        uploadBtn.onclick = () => fileInput.click();
        addUploadBtn.onclick = () => addFileInput.click();

        // í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° (ê¸°ì¡´ ì´ë¯¸ì§€ì— ì¶”ê°€)
        clipboardBtn.onclick = async () => {
            try {
                // ëª¨ë°”ì¼ ê°ì§€
                const isMobile = this.app.isMobile;
                
                if (isMobile) {
                    // ëª¨ë°”ì¼: íŒŒì¼ ì„ íƒ ëŒ€í™”ìƒì ì‚¬ìš©
                    new Notice('ğŸ“± ëª¨ë°”ì¼ì—ì„œëŠ” "ğŸ“ ì„ íƒ" ë˜ëŠ” "â• ì¶”ê°€" ë²„íŠ¼ì„ ì‚¬ìš©í•˜ì„¸ìš”');
                    return;
                }
                
                // PC: í´ë¦½ë³´ë“œ API ì‚¬ìš©
                if (!navigator.clipboard || !navigator.clipboard.read) {
                    new Notice('âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë¦½ë³´ë“œ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. íŒŒì¼ ì„ íƒì„ ì‚¬ìš©í•˜ì„¸ìš”.');
                    return;
                }
                
                const clipboardItems = await navigator.clipboard.read();
                let imageFound = false;

                for (const item of clipboardItems) {
                    const imageType = item.types.find(type => type.startsWith('image/'));
                    
                    if (imageType) {
                        const blob = await item.getType(imageType);
                        const folderName = this.question.folder || 'default';
                        const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                        const attachmentFolder = `${this.plugin.settings.quizFolder}/${folderName}/${attachmentFolderName}`;
                        
                        const folderExists = await this.app.vault.adapter.exists(attachmentFolder);
                        if (!folderExists) {
                            await this.app.vault.createFolder(attachmentFolder);
                        }

                        // Obsidian ê¸°ë³¸ í˜•ì‹ìœ¼ë¡œ íŒŒì¼ëª… ìƒì„± (ë°€ë¦¬ì´ˆ ì¶”ê°€ë¡œ ì¤‘ë³µ ë°©ì§€)
                        const now = new Date();
                        const year = now.getFullYear();
                        const month = String(now.getMonth() + 1).padStart(2, '0');
                        const day = String(now.getDate()).padStart(2, '0');
                        const hours = String(now.getHours()).padStart(2, '0');
                        const minutes = String(now.getMinutes()).padStart(2, '0');
                        const seconds = String(now.getSeconds()).padStart(2, '0');
                        const millis = String(now.getMilliseconds()).padStart(3, '0');
                        
                        const extension = imageType.split('/')[1] || 'png';
                        const fileName = `Pasted image ${year}${month}${day}${hours}${minutes}${seconds}${millis}.${extension}`;
                        const filePath = `${attachmentFolder}/${fileName}`;

                        const arrayBuffer = await blob.arrayBuffer();
                        await this.app.vault.adapter.writeBinary(filePath, new Uint8Array(arrayBuffer));

                        // ì´ë¯¸ì§€ í¬ê¸° ì˜µì…˜ ì ìš©
                        let newImageLink = `![[${folderName}/${attachmentFolderName}/${fileName}`;
                        if (!autoSizeCheckbox.checked && widthInput.value) {
                            newImageLink += `|${widthInput.value}`;
                        }
                        newImageLink += ']]';

                        // ê¸°ì¡´ ì´ë¯¸ì§€ì— ì¶”ê°€
                        const existingValue = getValue() || '';
                        const newValue = existingValue 
                            ? existingValue + '\n' + newImageLink
                            : newImageLink;
                        
                        setValue(newValue);
                        imageInput.value = newValue;
                        
                        new Notice(`âœ… ${label} í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì¶”ê°€ ì™„ë£Œ`);
                        updateImagePreview();
                        imageFound = true;
                        break;
                    }
                }

                if (!imageFound) {
                    new Notice('âš ï¸ í´ë¦½ë³´ë“œì— ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° ì‹¤íŒ¨:', error);
                new Notice('âŒ í´ë¦½ë³´ë“œ ì½ê¸° ì‹¤íŒ¨: ' + error.message);
            }
        };

        fileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            try {
                const folderName = this.question.folder || 'default';
                const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                const attachmentFolder = `${this.plugin.settings.quizFolder}/${folderName}/${attachmentFolderName}`;
                const folderExists = await this.app.vault.adapter.exists(attachmentFolder);
                if (!folderExists) {
                    await this.app.vault.createFolder(attachmentFolder);
                }

                const uploadedImages = [];
                const existingValue = getValue() || '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const timestamp = Date.now() + i; // ê° íŒŒì¼ë§ˆë‹¤ ê³ ìœ í•œ íƒ€ì„ìŠ¤íƒ¬í”„
                    const fileName = `${timestamp}_${file.name}`;
                    const filePath = `${attachmentFolder}/${fileName}`;
                    const arrayBuffer = await file.arrayBuffer();
                    await this.app.vault.adapter.writeBinary(filePath, new Uint8Array(arrayBuffer));

                    // ì´ë¯¸ì§€ í¬ê¸° ì˜µì…˜ ì ìš©
                    let imageLink = `![[${folderName}/${attachmentFolderName}/${fileName}`;
                    if (!autoSizeCheckbox.checked && widthInput.value) {
                        imageLink += `|${widthInput.value}`;
                    }
                    imageLink += ']]';
                    
                    uploadedImages.push(imageLink);
                }

                // ê¸°ì¡´ ì´ë¯¸ì§€ì— ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€ (ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)
                const newValue = existingValue 
                    ? existingValue + '\n' + uploadedImages.join('\n')
                    : uploadedImages.join('\n');
                
                setValue(newValue);
                imageInput.value = newValue;
                
                new Notice(`âœ… ${label} ${files.length}ê°œ ì—…ë¡œë“œ ì™„ë£Œ`);
                updateImagePreview();
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                new Notice(`âŒ ${label} ì—…ë¡œë“œ ì‹¤íŒ¨`);
            } finally {
                // íŒŒì¼ input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
                fileInput.value = '';
            }
        });

        // ì¶”ê°€ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ (ê¸°ì¡´ ì´ë¯¸ì§€ì— ì¶”ê°€)
        addFileInput.addEventListener('change', async (e) => {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            try {
                const folderName = this.question.folder || 'default';
                const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                const attachmentFolder = `${this.plugin.settings.quizFolder}/${folderName}/${attachmentFolderName}`;
                const folderExists = await this.app.vault.adapter.exists(attachmentFolder);
                if (!folderExists) {
                    await this.app.vault.createFolder(attachmentFolder);
                }

                const uploadedImages = [];
                const existingValue = getValue() || '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const timestamp = Date.now() + i;
                    const fileName = `${timestamp}_${file.name}`;
                    const filePath = `${attachmentFolder}/${fileName}`;
                    const arrayBuffer = await file.arrayBuffer();
                    await this.app.vault.adapter.writeBinary(filePath, new Uint8Array(arrayBuffer));

                    // ì´ë¯¸ì§€ í¬ê¸° ì˜µì…˜ ì ìš©
                    let imageLink = `![[${folderName}/${attachmentFolderName}/${fileName}`;
                    if (!autoSizeCheckbox.checked && widthInput.value) {
                        imageLink += `|${widthInput.value}`;
                    }
                    imageLink += ']]';
                    
                    uploadedImages.push(imageLink);
                }

                // ê¸°ì¡´ ì´ë¯¸ì§€ì— ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€
                const newValue = existingValue 
                    ? existingValue + '\n' + uploadedImages.join('\n')
                    : uploadedImages.join('\n');
                
                setValue(newValue);
                imageInput.value = newValue;
                
                new Notice(`âœ… ${label} ${files.length}ê°œ ì¶”ê°€ ì™„ë£Œ`);
                updateImagePreview();
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì¶”ê°€ ì‹¤íŒ¨:', error);
                new Notice(`âŒ ${label} ì¶”ê°€ ì‹¤íŒ¨`);
            } finally {
                // íŒŒì¼ input ì´ˆê¸°í™” (ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡)
                addFileInput.value = '';
            }
        });

        // ì „ì²´ ì‚­ì œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
        clearBtn.onclick = () => {
            if (getValue() && getValue().trim()) {
                setValue('');
                imageInput.value = '';
                updateImagePreview();
                new Notice(`âœ… ${label} ì „ì²´ ì‚­ì œ ì™„ë£Œ`);
            }
        };

        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì› + í˜ì´ì§€ ë„˜ê¹€)
        const previewContainer = imageContainer.createDiv({ cls: 'image-preview-container' });
        previewContainer.style.marginTop = '10px';
        previewContainer.style.border = '1px solid var(--background-modifier-border)';
        previewContainer.style.borderRadius = '6px';
        previewContainer.style.display = 'none';
        previewContainer.style.padding = '10px';
        previewContainer.style.position = 'relative';

        let currentImageIndex = 0;
        let totalImages = 0;

        const updateImagePreview = async () => {
            const imageValue = getValue();
            if (!imageValue || !imageValue.trim()) {
                previewContainer.style.display = 'none';
                return;
            }

            // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ ì´ë¯¸ì§€ë“¤ ì²˜ë¦¬
            const imageLines = imageValue.split('\n').filter(line => line.trim());
            totalImages = imageLines.length;
            
            if (totalImages === 0) {
                previewContainer.style.display = 'none';
                return;
            }

            previewContainer.empty();
            previewContainer.style.display = 'block';

            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ì´ë¯¸ì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ) - ìƒë‹¨ì— ê³ ì •
            let navControls = null;
            let prevBtn = null;
            let nextBtn = null;
            let pageInfo = null;

            if (totalImages > 1) {
                navControls = previewContainer.createDiv();
                navControls.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 12px; padding: 12px; background: var(--interactive-accent); border-radius: 8px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';

                prevBtn = navControls.createEl('button', { text: 'â—€ ì´ì „' });
                prevBtn.style.cssText = 'min-width: 80px; min-height: 48px; padding: 10px 20px; cursor: pointer; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; font-size: 16px; font-weight: bold; border: 2px solid white; border-radius: 8px; background: rgba(255,255,255,0.9); color: var(--text-normal); transition: all 0.2s;';
                prevBtn.type = 'button';

                pageInfo = navControls.createEl('span', { text: `${currentImageIndex + 1} / ${totalImages}` });
                pageInfo.style.cssText = 'min-width: 70px; text-align: center; color: white; font-weight: bold; font-size: 16px; background: rgba(0,0,0,0.3); padding: 8px 16px; border-radius: 20px;';

                nextBtn = navControls.createEl('button', { text: 'ë‹¤ìŒ â–¶' });
                nextBtn.style.cssText = 'min-width: 80px; min-height: 48px; padding: 10px 20px; cursor: pointer; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent; font-size: 16px; font-weight: bold; border: 2px solid white; border-radius: 8px; background: rgba(255,255,255,0.9); color: var(--text-normal); transition: all 0.2s;';
                nextBtn.type = 'button';

                // í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€
                [prevBtn, nextBtn].forEach(btn => {
                    btn.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        btn.style.transform = 'scale(0.95)';
                        btn.style.background = 'rgba(255,255,255,1)';
                    });
                    btn.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        btn.style.transform = 'scale(1)';
                        btn.style.background = btn.disabled ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.9)';
                    });
                    btn.addEventListener('touchcancel', (e) => {
                        btn.style.transform = 'scale(1)';
                        btn.style.background = btn.disabled ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.9)';
                    });
                });
            }

            // ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­
            const imageDisplayArea = previewContainer.createDiv();
            imageDisplayArea.style.cssText = 'min-height: 150px; display: flex; align-items: center; justify-content: center; position: relative; touch-action: pan-y;';

            // ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ì¶”ê°€ (ëª¨ë°”ì¼ìš©)
            let touchStartX = 0;
            let touchEndX = 0;
            
            imageDisplayArea.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            }, { passive: true });
            
            imageDisplayArea.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, { passive: true });
            
            const handleSwipe = () => {
                const swipeThreshold = 50; // ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0 && currentImageIndex < totalImages - 1) {
                        // ì™¼ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ ì´ë¯¸ì§€
                        showImage(currentImageIndex + 1);
                    } else if (diff < 0 && currentImageIndex > 0) {
                        // ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìŠ¤ì™€ì´í”„ -> ì´ì „ ì´ë¯¸ì§€
                        showImage(currentImageIndex - 1);
                    }
                }
            };

            const showImage = async (index) => {
                if (index < 0 || index >= totalImages) return;
                
                currentImageIndex = index;
                imageDisplayArea.empty();

                const imageLine = imageLines[index].trim();
                let imageUrl = imageLine;

                // í¬ê¸° ì •ë³´ ì¶”ì¶œ (ì˜ˆ: ![[image.png|400]])
                let imageWidth = null;
                const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                if (sizeMatch) {
                    imageWidth = sizeMatch[1] + 'px';
                }

                // Wiki ë§í¬ í˜•ì‹ ì²˜ë¦¬
                if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                    const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                    if (wikiMatch && wikiMatch[1]) {
                        let imagePath = wikiMatch[1];
                        
                        // ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°ì™€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
                        const folderName = this.question.folder || 'default';
                        const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                        const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                        
                        // ì´ë¯¸ì§€ ê²½ë¡œê°€ í´ë”ëª…ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ìƒëŒ€ ê²½ë¡œ)
                        if (imagePath.startsWith(folderName + '/')) {
                            imagePath = `${quizFolder}/${imagePath}`;
                        }
                        // ì´ë¯¸ì§€ ê²½ë¡œê°€ í€´ì¦ˆ í´ë”ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                        else if (!imagePath.startsWith(quizFolder)) {
                            // íŒŒì¼ëª…ë§Œ ìˆëŠ” ê²½ìš°
                            if (!imagePath.includes('/')) {
                                imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                            }
                        }
                        
                        console.log(`ğŸ–¼ï¸ [ì´ë¯¸ì§€ ê²½ë¡œ ë³€í™˜] ${wikiMatch[1]} â†’ ${imagePath}`);
                        
                        // Vaultì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ì°¾ê¸°
                        const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                        
                        if (imageFile) {
                            // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                            imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                            console.log(`âœ… [ì´ë¯¸ì§€ ë°œê²¬] ${imagePath} â†’ ${imageUrl}`);
                        } else {
                            console.warn(`âŒ [ì´ë¯¸ì§€ ì—†ìŒ] ${imagePath}`);
                        }
                    }
                } else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                    // Markdown í˜•ì‹ ì²˜ë¦¬
                    const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                    if (imgMatch && imgMatch[1]) {
                        imageUrl = imgMatch[1];
                    }
                }

                // ì´ë¯¸ì§€ ë˜í¼ (ì‚­ì œ ë²„íŠ¼ í¬í•¨)
                const imgWrapper = imageDisplayArea.createDiv();
                imgWrapper.style.position = 'relative';
                imgWrapper.style.display = 'inline-block';

                // ì´ë¯¸ì§€ í‘œì‹œ
                const img = imgWrapper.createEl('img', {
                    attr: {
                        src: imageUrl,
                        alt: 'ë¯¸ë¦¬ë³´ê¸°'
                    }
                });
                img.style.cssText = `
                    max-width: 100%;
                    max-height: 200px;
                    width: ${imageWidth || 'auto'};
                    height: auto;
                    display: block;
                    border-radius: 4px;
                    object-fit: contain;
                `;
                img.onerror = () => {
                    imageDisplayArea.empty();
                    imageDisplayArea.createEl('div', {
                        text: 'âš ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                        attr: { 
                            style: 'padding: 40px; text-align: center; color: var(--text-muted);'
                        }
                    });
                };

                // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
                const deleteBtn = imgWrapper.createEl('button', { text: 'âœ•' });
                deleteBtn.style.cssText = `
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    width: 28px;
                    height: 28px;
                    padding: 0;
                    background: rgba(0, 0, 0, 0.7);
                    color: white;
                    border: none;
                    border-radius: 50%;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s;
                    z-index: 10;
                `;
                deleteBtn.type = 'button';
                deleteBtn.title = 'ì´ ì´ë¯¸ì§€ ì‚­ì œ';
                
                deleteBtn.addEventListener('mouseenter', () => {
                    deleteBtn.style.background = 'rgba(255, 0, 0, 0.8)';
                    deleteBtn.style.transform = 'scale(1.1)';
                });
                
                deleteBtn.addEventListener('mouseleave', () => {
                    deleteBtn.style.background = 'rgba(0, 0, 0, 0.7)';
                    deleteBtn.style.transform = 'scale(1)';
                });
                
                // í´ë¦­ ë° í„°ì¹˜ ì´ë²¤íŠ¸ (ëª¨ë°”ì¼ í˜¸í™˜)
                const deleteHandler = (e) => {
                    e.preventDefault();
                    // í•´ë‹¹ ì´ë¯¸ì§€ ì‚­ì œ
                    imageLines.splice(index, 1);
                    const newValue = imageLines.join('\n');
                    setValue(newValue);
                    imageInput.value = newValue;
                    
                    // ì¸ë±ìŠ¤ ì¡°ì •
                    if (imageLines.length === 0) {
                        currentImageIndex = 0;
                    } else if (currentImageIndex >= imageLines.length) {
                        currentImageIndex = imageLines.length - 1;
                    }
                    
                    new Notice('âœ… ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    updateImagePreview();
                };
                
                deleteBtn.addEventListener('click', deleteHandler);
                deleteBtn.addEventListener('touchend', deleteHandler);

                // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
                if (pageInfo) {
                    pageInfo.textContent = `${currentImageIndex + 1} / ${totalImages}`;
                }
                if (prevBtn) {
                    prevBtn.disabled = currentImageIndex === 0;
                    prevBtn.style.opacity = currentImageIndex === 0 ? '0.5' : '1';
                    prevBtn.style.cursor = currentImageIndex === 0 ? 'not-allowed' : 'pointer';
                    prevBtn.style.background = currentImageIndex === 0 ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.9)';
                }
                if (nextBtn) {
                    nextBtn.disabled = currentImageIndex === totalImages - 1;
                    nextBtn.style.opacity = currentImageIndex === totalImages - 1 ? '0.5' : '1';
                    nextBtn.style.cursor = currentImageIndex === totalImages - 1 ? 'not-allowed' : 'pointer';
                    nextBtn.style.background = currentImageIndex === totalImages - 1 ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.9)';
                }
            };

            // ë²„íŠ¼ ì´ë²¤íŠ¸ (í´ë¦­ + í„°ì¹˜ ì§€ì›)
            if (prevBtn) {
                const prevHandler = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (currentImageIndex > 0) {
                        showImage(currentImageIndex - 1);
                    }
                };
                prevBtn.onclick = prevHandler;
                prevBtn.addEventListener('touchend', prevHandler);
            }
            if (nextBtn) {
                const nextHandler = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (currentImageIndex < totalImages - 1) {
                        showImage(currentImageIndex + 1);
                    }
                };
                nextBtn.onclick = nextHandler;
                nextBtn.addEventListener('touchend', nextHandler);
            }

            // ì´ˆê¸° ì´ë¯¸ì§€ í‘œì‹œ
            showImage(currentImageIndex);
        };

        updateImagePreview();
        return imageContainer;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('hanzi-question-modal');
        
        // ëª¨ë‹¬ ì „ì²´ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í—ˆìš©
        contentEl.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && ['v', 'c', 'x', 'a', 'z'].includes(e.key.toLowerCase())) {
                e.stopPropagation();
            }
        }, true);
        
        contentEl.addEventListener('paste', (e) => {
            e.stopPropagation();
        }, true);
        
        // ëª¨ë‹¬ ì „ì²´ë¥¼ Flexboxë¡œ ì„¤ì •
        contentEl.style.cssText = `
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 90vh;
            overflow: hidden;
        `;

        // í—¤ë” (ê³ ì •)
        const header = contentEl.createDiv({ cls: 'modal-header' });
        header.style.cssText = `
            flex: 0 0 auto;
            padding: 20px;
            background: var(--background-primary);
            border-bottom: 2px solid var(--interactive-accent);
            margin-bottom: 0;
        `;
        
        const headerTitle = header.createDiv();
        headerTitle.style.cssText = `
            display: flex;
            align-items: center;
            gap: 12px;
        `;
        
        const icon = headerTitle.createSpan({ 
            text: this.existingQuestion ? 'âœï¸' : 'ğŸ“',
            cls: 'header-icon'
        });
        icon.style.cssText = `
            font-size: 28px;
        `;
        
        const title = headerTitle.createEl('h2', { 
            text: this.existingQuestion ? 'ë¬¸ì œ ìˆ˜ì •' : 'ìƒˆ ë¬¸ì œ ë§Œë“¤ê¸°',
            cls: 'header-title'
        });
        title.style.cssText = `
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--text-normal);
        `;

        // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ í¼ ì˜ì—­
        const scrollContainer = contentEl.createDiv({ cls: 'modal-scroll-container' });
        scrollContainer.style.cssText = `
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 20px;
            background: var(--background-primary);
        `;

        const form = scrollContainer.createDiv({ cls: 'question-form' });
        form.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 20px;
        `;

        // í•µì‹¬ í‚¤ì›Œë“œ (ë“œë¡­ë‹¤ìš´ + ì…ë ¥) - ì»´íŒ©íŠ¸
        const hanziSetting = new Setting(form)
            .setName('ğŸ”‘ í•µì‹¬ í‚¤ì›Œë“œ')
            .setDesc('');
        
        hanziSetting.settingEl.style.cssText = `
            background: var(--background-primary-alt);
            border-radius: 6px;
            padding: 10px 12px;
            border: 1px solid var(--background-modifier-border);
        `;
        
        hanziSetting.nameEl.style.fontSize = '13px';
        hanziSetting.nameEl.style.fontWeight = '500';
        
        // ê¸°ì¡´ í‚¤ì›Œë“œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        const getExistingKeywords = async () => {
            const keywords = new Set();
            const questionsFolder = this.plugin.settings.quizFolder + '/Questions';
            
            const allFolders = this.app.vault.getAbstractFileByPath(questionsFolder);
            if (allFolders && allFolders.children) {
                for (const folder of allFolders.children) {
                    if (folder.children) {
                        for (const file of folder.children) {
                            if (file.extension === 'md') {
                                try {
                                    const content = await this.app.vault.read(file);
                                    const lines = content.split('\n');
                                    
                                    // "## í•œì" ì„¹ì…˜ ì°¾ê¸°
                                    let inHanziSection = false;
                                    for (let i = 0; i < lines.length; i++) {
                                        const line = lines[i].trim();
                                        
                                        if (line === '## í•œì' || line === '## í‚¤ì›Œë“œ') {
                                            inHanziSection = true;
                                            continue;
                                        }
                                        
                                        // ë‹¤ìŒ ì„¹ì…˜ ì‹œì‘ë˜ë©´ ì¢…ë£Œ
                                        if (inHanziSection && line.startsWith('##')) {
                                            inHanziSection = false;
                                            continue;
                                        }
                                        
                                        // í•œì/í‚¤ì›Œë“œ ì„¹ì…˜ ë‚´ìš© ì¶”ì¶œ
                                        if (inHanziSection && line && !line.startsWith('#')) {
                                            keywords.add(line);
                                        }
                                    }
                                } catch (err) {
                                    // íŒŒì¼ ì½ê¸° ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                                }
                            }
                        }
                    }
                }
            }
            return Array.from(keywords).sort();
        };
        
        const hanziContainer = hanziSetting.controlEl.createDiv({ cls: 'hanzi-input-container' });
        hanziContainer.style.display = 'flex';
        hanziContainer.style.flexDirection = 'column';
        hanziContainer.style.gap = '8px';
        hanziContainer.style.width = '100%';
        
        // ë“œë¡­ë‹¤ìš´
        const dropdownRow = hanziContainer.createDiv();
        dropdownRow.style.cssText = `
            display: flex;
            align-items: center;
            gap: 6px;
        `;
        
        dropdownRow.createSpan({ 
            text: 'ğŸ“š', 
            cls: 'setting-item-description' 
        }).style.cssText = `
            font-size: 14px;
        `;
        
        const hanziDropdown = dropdownRow.createEl('select');
        hanziDropdown.style.cssText = `
            flex: 1;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--background-modifier-border);
            background: var(--background-primary);
            color: var(--text-normal);
            cursor: pointer;
            font-size: 13px;
        `;
        
        // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë¡œë“œ
        (async () => {
            const keywords = await getExistingKeywords();
            hanziDropdown.createEl('option', { text: '-- ì„ íƒí•˜ì„¸ìš” --', value: '' });
            for (const keyword of keywords) {
                hanziDropdown.createEl('option', { text: keyword, value: keyword });
            }
        })();
        
        // ì…ë ¥ í•„ë“œ (Setting API ì‚¬ìš©)
        let hanziInputComponent;
        hanziSetting.addText(text => {
            hanziInputComponent = text;
            text.setPlaceholder('ì˜ˆ: æ„›, ì‚¬ë‘, ç¶“æ¿Ÿ ë“±')
                .setValue(this.question.hanzi || '')
                .onChange((value) => {
                    this.question.hanzi = value;
                });
            text.inputEl.style.width = '100%';
        });
        
        // ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ ì…ë ¥ í•„ë“œì— ë°˜ì˜
        hanziDropdown.addEventListener('change', (e) => {
            if (e.target.value) {
                hanziInputComponent.setValue(e.target.value);
                this.question.hanzi = e.target.value;
            }
        });

        // ë²ˆí˜¸ (ìë™ í• ë‹¹ ë²„íŠ¼ í¬í•¨) - ì»´íŒ©íŠ¸
        const numberSetting = new Setting(form)
            .setName('ğŸ”¢ ë²ˆí˜¸')
            .setDesc('');
        
        numberSetting.settingEl.style.cssText = `
            background: var(--background-primary-alt);
            border-radius: 6px;
            padding: 10px 12px;
            border: 1px solid var(--background-modifier-border);
        `;
        
        numberSetting.nameEl.style.fontSize = '13px';
        numberSetting.nameEl.style.fontWeight = '500';
        
        let numberInput;
        let numberStatusEl;
        
        numberSetting.addText(text => {
            numberInput = text;
            text.setPlaceholder('ì˜ˆ: 1')
                .setValue(this.question.number)
                .onChange(async (value) => {
                    this.question.number = value;
                    
                    // ì¤‘ë³µ ì²´í¬ ì œê±° - ì¤‘ë³µ í—ˆìš©
                    if (value.trim() !== '') {
                        numberStatusEl.setText('ğŸ“ ë²ˆí˜¸ ì…ë ¥ë¨');
                        numberStatusEl.style.color = '#4caf50';
                    } else {
                        numberStatusEl.setText('');
                    }
                });
        });
        
        // ìë™ í• ë‹¹ ë²„íŠ¼
        numberSetting.addButton(btn => btn
            .setButtonText('ğŸ”¢ ìë™ í• ë‹¹')
            .setTooltip('ë‹¤ìŒ ì‚¬ìš© ê°€ëŠ¥í•œ ë²ˆí˜¸ ìë™ í• ë‹¹')
            .onClick(async () => {
                const folder = this.question.folder || 'ê¸°ë³¸';
                const nextNumber = await this.plugin.getNextAvailableNumber(folder);
                this.question.number = nextNumber;
                numberInput.setValue(nextNumber);
                numberStatusEl.setText('âœ… ì‚¬ìš© ê°€ëŠ¥');
                numberStatusEl.style.color = '#4caf50';
                new Notice(`ğŸ“‹ ë²ˆí˜¸ ${nextNumber}ì´(ê°€) í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }));
        
        // ìƒíƒœ í‘œì‹œ ì˜ì—­
        numberStatusEl = numberSetting.descEl.createDiv({ cls: 'number-status' });
        numberStatusEl.style.marginTop = '4px';
        numberStatusEl.style.fontWeight = 'bold';

        // ë¬¸ì œ - í° ë…ë¦½ ì„¹ì…˜
        const questionSection = form.createDiv({ cls: 'question-section' });
        questionSection.style.cssText = `
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-radius: 12px;
            padding: 24px;
            border: 2px solid var(--interactive-accent);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            margin-top: 20px;
        `;
        
        const questionHeader = questionSection.createEl('h3', { text: 'â“ ë¬¸ì œ' });
        questionHeader.style.cssText = `
            font-size: 18px;
            font-weight: 700;
            color: var(--interactive-accent);
            margin: 0 0 8px 0;
        `;
        
        const questionDesc = questionSection.createEl('p', { text: 'ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”' });
        questionDesc.style.cssText = `
            font-size: 13px;
            color: var(--text-muted);
            margin: 0 0 16px 0;
        `;
        
        const questionContainer = questionSection.createDiv({ cls: 'question-container' });
        questionContainer.style.display = 'flex';
        questionContainer.style.flexDirection = 'column';
        questionContainer.style.gap = '8px';
        questionContainer.style.width = '100%';
        
        // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ë²„íŠ¼
        const pasteBtnRow = questionContainer.createDiv({ cls: 'paste-btn-row' });
        pasteBtnRow.style.display = 'flex';
        pasteBtnRow.style.gap = '8px';
        pasteBtnRow.style.marginBottom = '4px';
        
        const pasteBtn = pasteBtnRow.createEl('button', {
            text: 'ğŸ“‹ ë¶™ì—¬ë„£ê¸°',
            cls: 'paste-btn'
        });
        pasteBtn.type = 'button';
        pasteBtn.style.padding = '4px 10px';
        pasteBtn.style.fontSize = '12px';
        pasteBtn.style.cursor = 'pointer';
        
        // ë¬¸ì œ ì…ë ¥ ì˜ì—­ - ëŒ€í˜• ì…ë ¥ì°½
        const questionInput = questionContainer.createEl('textarea', {
            placeholder: 'ì˜ˆ: ë‹¤ìŒ í•œìì˜ ëœ»ì€?'
        });
        questionInput.value = this.question.question || '';
        questionInput.rows = 8;
        questionInput.style.cssText = `
            width: 100%;
            padding: 20px;
            resize: vertical;
            font-size: 18px;
            line-height: 1.8;
            border: 2px solid var(--interactive-accent);
            border-radius: 12px;
            background: var(--background-primary);
            min-height: 200px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        `;
        
        questionInput.addEventListener('focus', () => {
            questionInput.style.borderColor = 'var(--interactive-accent)';
            questionInput.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.1)';
        });
        
        questionInput.addEventListener('blur', () => {
            questionInput.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.05)';
        });
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í—ˆìš© (Ctrl+V, Ctrl+C, Ctrl+X, Ctrl+A, Ctrl+Z)
        questionInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && ['v', 'c', 'x', 'a', 'z'].includes(e.key.toLowerCase())) {
                e.stopPropagation();
            }
        }, true);
        
        // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ í—ˆìš©
        questionInput.addEventListener('paste', (e) => {
            e.stopPropagation();
        }, true);
        
        questionInput.addEventListener('input', (e) => {
            this.question.question = e.target.value;
        });
        
        // í´ë¦½ë³´ë“œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        pasteBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    questionInput.value = text;
                    this.question.question = text;
                    questionInput.focus();
                    new Notice('ğŸ“‹ í´ë¦½ë³´ë“œ ë‚´ìš©ì´ ë¶™ì—¬ë„£ì–´ì¡ŒìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                new Notice('âš ï¸ í´ë¦½ë³´ë“œ ì½ê¸° ì‹¤íŒ¨: ' + err.message);
            }
        });

        // í´ë” ì„ íƒ - ì»´íŒ©íŠ¸
        const folderSetting = new Setting(form)
            .setName('ğŸ“ í´ë”')
            .setDesc('');

        folderSetting.settingEl.style.cssText = `
            background: var(--background-primary-alt);
            border-radius: 6px;
            padding: 10px 12px;
            border: 1px solid var(--background-modifier-border);
        `;
        
        folderSetting.nameEl.style.fontSize = '13px';
        folderSetting.nameEl.style.fontWeight = '500';

        const folderContainer = folderSetting.controlEl.createDiv({ cls: 'folder-selection-container' });
        folderContainer.style.cssText = `
            display: flex;
            gap: 8px;
            width: 100%;
            align-items: center;
        `;

        // ë“œë¡­ë‹¤ìš´
        const folderDropdown = folderContainer.createEl('select');
        folderDropdown.style.cssText = `
            flex: 1;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid var(--background-modifier-border);
            background: var(--background-primary);
            font-size: 13px;
        `;
        
        const folders = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        
        // "ìƒˆ í´ë”..." ì˜µì…˜ ì¶”ê°€
        const newFolderOption = folderDropdown.createEl('option', { 
            value: '__NEW__', 
            text: 'â• ìƒˆ í´ë” ë§Œë“¤ê¸°...' 
        });
        
        // ê¸°ì¡´ í´ë”ë“¤ ì¶”ê°€
        folders.forEach(folder => {
            const option = folderDropdown.createEl('option', { value: folder, text: folder });
        });
        
        folderDropdown.value = this.question.folder || 'ê¸°ë³¸';

        // ìƒˆ í´ë” ì…ë ¥ í•„ë“œ (ì²˜ìŒì—” ìˆ¨ê¹€)
        const newFolderInput = folderContainer.createEl('input', { 
            type: 'text',
            placeholder: 'ìƒˆ í´ë” ì´ë¦„ ì…ë ¥'
        });
        newFolderInput.style.flex = '1';
        newFolderInput.style.padding = '8px';
        newFolderInput.style.display = 'none';

        // ë“œë¡­ë‹¤ìš´ ë³€ê²½ ì´ë²¤íŠ¸
        folderDropdown.addEventListener('change', async () => {
            if (folderDropdown.value === '__NEW__') {
                // ìƒˆ í´ë” ë§Œë“¤ê¸° ì„ íƒ ì‹œ
                folderDropdown.style.display = 'none';
                newFolderInput.style.display = 'block';
                newFolderInput.focus();
            } else {
                const oldFolder = this.question.folder;
                this.question.folder = folderDropdown.value;
                
                // í´ë”ê°€ ë³€ê²½ë˜ë©´ ë²ˆí˜¸ ì¬í• ë‹¹ ì œì•ˆ
                if (oldFolder && oldFolder !== folderDropdown.value) {
                    const nextNum = await this.plugin.getNextAvailableNumber(folderDropdown.value);
                    if (confirm(`í´ë”ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. [${folderDropdown.value}] í´ë”ì˜ ë‹¤ìŒ ë²ˆí˜¸ ${nextNum}(ìœ¼)ë¡œ ìë™ í• ë‹¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        this.question.number = nextNum;
                        if (numberInput) {
                            numberInput.setValue(nextNum);
                        }
                        if (numberStatusEl) {
                            numberStatusEl.setText('âœ… ì‚¬ìš© ê°€ëŠ¥');
                            numberStatusEl.style.color = '#4caf50';
                        }
                    }
                }
            }
        });

        // ìƒˆ í´ë” ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸
        newFolderInput.addEventListener('blur', async () => {
            const newFolderName = newFolderInput.value.trim();
            if (newFolderName) {
                const oldFolder = this.question.folder;
                
                // ìƒˆ í´ë” ì´ë¦„ì´ ì…ë ¥ëœ ê²½ìš°
                this.question.folder = newFolderName;
                
                // í´ë” ëª©ë¡ì— ì—†ìœ¼ë©´ ì¶”ê°€
                if (!folders.includes(newFolderName)) {
                    this.plugin.settings.questionFolders.push(newFolderName);
                    await this.plugin.saveSettings();
                }
                
                // ë“œë¡­ë‹¤ìš´ì— ìƒˆ ì˜µì…˜ ì¶”ê°€
                const newOption = folderDropdown.createEl('option', { 
                    value: newFolderName, 
                    text: newFolderName 
                });
                folderDropdown.value = newFolderName;
                
                // ë²ˆí˜¸ ì¬í• ë‹¹ ì œì•ˆ
                const nextNum = await this.plugin.getNextAvailableNumber(newFolderName);
                if (confirm(`ìƒˆ í´ë” [${newFolderName}]ì´(ê°€) ìƒì„±ë©ë‹ˆë‹¤. ë²ˆí˜¸ ${nextNum}(ìœ¼)ë¡œ ìë™ í• ë‹¹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    this.question.number = nextNum;
                    if (numberInput) {
                        numberInput.setValue(nextNum);
                    }
                    if (numberStatusEl) {
                        numberStatusEl.setText('âœ… ì‚¬ìš© ê°€ëŠ¥');
                        numberStatusEl.style.color = '#4caf50';
                    }
                }
            }
            
            // UI ì›ë˜ëŒ€ë¡œ
            newFolderInput.style.display = 'none';
            newFolderInput.value = '';
            folderDropdown.style.display = 'block';
        });

        newFolderInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                newFolderInput.blur();
            }
        });

        // ì´ë¯¸ì§€
        const imageSetting = new Setting(form)
            .setName('ì´ë¯¸ì§€ (ì„ íƒ)')
            .setDesc('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì—¬ëŸ¬ ê°œëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)');

        this.createImageUploader(
            imageSetting.settingEl,
            () => this.question.image || '',
            (value) => { this.question.image = value; },
            'ë¬¸ì œ ì´ë¯¸ì§€'
        );

        // ì„ íƒì§€ - í° ë…ë¦½ ì„¹ì…˜
        const optionsSection = form.createDiv({ cls: 'options-section' });
        optionsSection.style.cssText = `
            background: linear-gradient(135deg, #e8f5e915 0%, #c8e6c915 100%);
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #4caf50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
            margin-top: 20px;
        `;
        
        const optionsHeader = optionsSection.createEl('h3', { text: 'âœ… ì„ íƒì§€' });
        optionsHeader.style.cssText = `
            font-size: 18px;
            font-weight: 700;
            color: #4caf50;
            margin: 0 0 8px 0;
        `;
        
        const optionsDesc = optionsSection.createEl('p', { text: 'ìµœì†Œ 1ê°œ ì´ìƒì˜ ì„ íƒì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”' });
        optionsDesc.style.cssText = `
            font-size: 13px;
            color: var(--text-muted);
            margin: 0 0 16px 0;
        `;
        
        const optionsContainer = optionsSection.createDiv({ cls: 'options-container' });
        optionsContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 16px;
        `;
        
        // ì´ˆê¸° ì„ íƒì§€ ê°œìˆ˜ ì„¤ì • (ê¸°ì¡´ ë¬¸ì œë©´ ê·¸ ê°œìˆ˜, ì‹ ê·œë©´ 4ê°œ)
        if (!this.question.options || this.question.options.length === 0) {
            this.question.options = ['', '', '', ''];
        }
        
        let renderOptions;
        let updateAnswerDropdown;
        
        renderOptions = () => {
            console.log('ğŸ”„ [renderOptions] ì‹œì‘');
            console.log('  options ê¸¸ì´:', this.question.options.length);
            console.log('  optionImages (ë Œë” ì „):', this.question.optionImages);
            
            optionsContainer.empty();
            
            // optionImages ë°°ì—´ í¬ê¸° ë§ì¶”ê¸° (ì´ˆê¸°í™” ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´ë¡œ)
            if (!this.question.optionImages) {
                this.question.optionImages = [];
                console.log('  optionImages ë°°ì—´ ìƒì„±');
            }
            while (this.question.optionImages.length < this.question.options.length) {
                this.question.optionImages.push('');
                console.log('  ë¹ˆ ì´ë¯¸ì§€ ì¶”ê°€, í˜„ì¬ ê¸¸ì´:', this.question.optionImages.length);
            }
            // ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
            if (this.question.optionImages.length > this.question.options.length) {
                this.question.optionImages = this.question.optionImages.slice(0, this.question.options.length);
                console.log('  ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì œê±°, í˜„ì¬ ê¸¸ì´:', this.question.optionImages.length);
            }
            
            console.log('  optionImages (ë Œë” í›„):', this.question.optionImages);
            
            // ì‹¤ì œë¡œ ê°’ì´ ìˆëŠ” ì„ íƒì§€ë§Œ í‘œì‹œ
            const validOptionsCount = Math.max(1, this.question.options.filter(opt => opt && opt.trim()).length);
            const displayCount = Math.max(validOptionsCount, this.question.options.length);
            
            for (let i = 0; i < displayCount; i++) {
                const optionWrapper = optionsContainer.createDiv({ cls: 'option-wrapper' });
                optionWrapper.style.cssText = `
                    background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-primary-alt) 100%);
                    padding: 18px;
                    border: 2px solid var(--background-modifier-border);
                    border-radius: 10px;
                    transition: all 0.2s;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                `;
                
                // í˜¸ë²„ íš¨ê³¼ - ë” ê°•ì¡°
                optionWrapper.addEventListener('mouseenter', () => {
                    optionWrapper.style.borderColor = 'var(--interactive-accent)';
                    optionWrapper.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    optionWrapper.style.transform = 'translateY(-2px)';
                });
                optionWrapper.addEventListener('mouseleave', () => {
                    optionWrapper.style.borderColor = 'var(--background-modifier-border)';
                    optionWrapper.style.boxShadow = '0 1px 3px rgba(0,0,0,0.08)';
                    optionWrapper.style.transform = 'translateY(0)';
                });
                
                const optionDiv = optionWrapper.createDiv({ cls: 'option-row' });
                optionDiv.style.cssText = `
                    display: flex;
                    gap: 12px;
                    align-items: center;
                `;
                
                new Setting(optionDiv)
                    .setName(`ì„ íƒì§€ ${i + 1}`)
                    .addText(text => {
                        text.setPlaceholder(`ì„ íƒì§€ ${i + 1} í…ìŠ¤íŠ¸`)
                            .setValue(this.question.options[i] || '')
                            .onChange(value => {
                                this.question.options[i] = value;
                            });
                        
                        // ì…ë ¥ í•„ë“œ ëŒ€í˜•í™”
                        text.inputEl.style.cssText = `
                            font-size: 17px;
                            padding: 14px 16px;
                            min-height: 54px;
                            border-radius: 8px;
                        `;
                    });
                
                // ì‚­ì œ ë²„íŠ¼ (ì„ íƒì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ) - ì‘ê²Œ
                if (this.question.options.filter(opt => opt && opt.trim()).length > 1) {
                    const deleteBtn = optionDiv.createEl('button', { 
                        text: 'ğŸ—‘ï¸',
                        cls: 'delete-option-btn'
                    });
                    deleteBtn.style.cssText = `
                        padding: 4px 8px;
                        font-size: 11px;
                    `;
                    deleteBtn.type = 'button';
                    deleteBtn.addEventListener('click', () => {
                        this.question.options.splice(i, 1);
                        this.question.optionImages.splice(i, 1);
                        renderOptions();
                        updateAnswerDropdown();
                    });
                }
                
                // ì„ íƒì§€ ì´ë¯¸ì§€ ì—…ë¡œë“œ
                this.createImageUploader(
                    optionWrapper,
                    () => this.question.optionImages[i] || '',
                    (value) => { 
                        console.log(`ğŸ“ [ì´ë¯¸ì§€ ì—…ë¡œë“œ] ì„ íƒì§€ ${i + 1} ì´ë¯¸ì§€ ì„¤ì •:`, value ? value.substring(0, 50) + '...' : '(ë¹„ì–´ìˆìŒ)');
                        this.question.optionImages[i] = value;
                        console.log(`ğŸ“ [ì´ë¯¸ì§€ ì—…ë¡œë“œ í›„] optionImages ì „ì²´:`, this.question.optionImages);
                    },
                    `ì„ íƒì§€ ${i + 1} ì´ë¯¸ì§€`
                );
                
                // ì„ íƒì§€ ì´ë¯¸ì§€ íŒíŠ¸ ì…ë ¥ í•„ë“œ
                if (!this.question.optionImageHints) {
                    this.question.optionImageHints = [];
                }
                while (this.question.optionImageHints.length < this.question.options.length) {
                    this.question.optionImageHints.push('');
                }
                
                const hintLabel = optionWrapper.createEl('label', { 
                    text: 'ğŸ’¡ ì´ë¯¸ì§€ íŒíŠ¸ (ì„ íƒì‚¬í•­)',
                    cls: 'option-image-hint-label'
                });
                hintLabel.style.cssText = `
                    font-size: 13px;
                    font-weight: 600;
                    color: var(--text-muted);
                    margin-top: 12px;
                    display: block;
                `;
                
                const hintInput = optionWrapper.createEl('textarea', {
                    placeholder: 'ì´ ì„ íƒì§€ ì´ë¯¸ì§€ì— ëŒ€í•œ íŒíŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...',
                    cls: 'option-image-hint-input'
                });
                hintInput.value = this.question.optionImageHints[i] || '';
                hintInput.style.cssText = `
                    width: 100%;
                    min-height: 60px;
                    padding: 10px;
                    margin-top: 6px;
                    border-radius: 6px;
                    border: 1px solid var(--background-modifier-border);
                    background: var(--background-primary);
                    color: var(--text-normal);
                    font-size: 14px;
                    resize: vertical;
                    font-family: var(--font-text);
                `;
                
                hintInput.addEventListener('input', (e) => {
                    this.question.optionImageHints[i] = e.target.value;
                });
            }
            
            // ì„ íƒì§€ ì¶”ê°€ ë²„íŠ¼ - ì‘ê²Œ
            const addBtn = optionsContainer.createEl('button', { 
                text: 'â• ì¶”ê°€',
                cls: 'add-option-btn'
            });
            addBtn.style.cssText = `
                margin-top: 10px;
                padding: 4px 10px;
                font-size: 12px;
            `;
            addBtn.type = 'button';
            addBtn.addEventListener('click', () => {
                console.log('â• [ì„ íƒì§€ ì¶”ê°€] í´ë¦­');
                console.log('  ì¶”ê°€ ì „ options:', this.question.options);
                console.log('  ì¶”ê°€ ì „ optionImages:', this.question.optionImages);
                
                this.question.options.push('');
                this.question.optionImages.push('');
                
                console.log('  ì¶”ê°€ í›„ options:', this.question.options);
                console.log('  ì¶”ê°€ í›„ optionImages:', this.question.optionImages);
                
                renderOptions();
                updateAnswerDropdown();
            });
        };
        
        // ì •ë‹µ ë“œë¡­ë‹¤ìš´ ë¨¼ì € ìƒì„±
        const answerSetting = new Setting(form)
            .setName('ì •ë‹µ')
            .setDesc('ì •ë‹µ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
        
        updateAnswerDropdown = () => {
            answerSetting.clear();
            answerSetting.setName('ì •ë‹µ').setDesc('ì •ë‹µ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”');
            answerSetting.addDropdown(dropdown => {
                const validOptions = this.question.options.filter(opt => opt && opt.trim());
                if (validOptions.length === 0) {
                    dropdown.addOption('0', 'ì„ íƒì§€ë¥¼ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”');
                    dropdown.setValue('0');
                    dropdown.setDisabled(true);
                } else {
                    validOptions.forEach((opt, index) => {
                        dropdown.addOption(String(index), `ì„ íƒì§€ ${index + 1}: ${opt.substring(0, 20)}${opt.length > 20 ? '...' : ''}`);
                    });
                    
                    // ì •ë‹µ ì¸ë±ìŠ¤ê°€ ìœ íš¨í•œì§€ í™•ì¸
                    const currentAnswer = this.question.answer || 0;
                    const finalAnswer = currentAnswer >= validOptions.length ? 0 : currentAnswer;
                    this.question.answer = finalAnswer;
                    
                    dropdown.setValue(String(finalAnswer))
                        .onChange(value => {
                            this.question.answer = parseInt(value);
                        });
                }
            });
        };
        
        // ì •ë‹µ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
        updateAnswerDropdown();
        
        // ì„ íƒì§€ ë Œë”ë§
        renderOptions();

        // ë‚œì´ë„ - ì»´íŒ©íŠ¸
        const difficultySetting = new Setting(form)
            .setName('â­ ë‚œì´ë„')
            .addDropdown(dropdown => dropdown
                .addOption('A+', 'ğŸ† A+')
                .addOption('A', 'â­ A')
                .addOption('A-', 'â­ A-')
                .addOption('B', 'ğŸ˜Š B')
                .addOption('B-', 'ğŸ˜Š B-')
                .addOption('C', 'ğŸ˜ C')
                .addOption('D', 'ğŸ˜° D')
                .addOption('E', 'ğŸ˜± E')
                .addOption('F', 'ğŸ’€ F')
                .setValue(this.question.difficulty || 'C')
                .onChange(value => this.question.difficulty = value));
        
        difficultySetting.settingEl.style.cssText = `
            background: var(--background-primary-alt);
            border-radius: 6px;
            padding: 10px 12px;
            border: 1px solid var(--background-modifier-border);
        `;
        
        difficultySetting.nameEl.style.fontSize = '13px';
        difficultySetting.nameEl.style.fontWeight = '500';

        // íŒíŠ¸ - í° ë…ë¦½ ì„¹ì…˜
        const hintSection = form.createDiv({ cls: 'hint-section' });
        hintSection.style.cssText = `
            background: linear-gradient(135deg, #ffeaa715 0%, #ffcd0715 100%);
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #ffb300;
            box-shadow: 0 4px 12px rgba(255, 179, 0, 0.15);
            margin-top: 20px;
        `;
        
        const hintHeader = hintSection.createEl('h3', { text: 'ğŸ’¡ íŒíŠ¸' });
        hintHeader.style.cssText = `
            font-size: 18px;
            font-weight: 700;
            color: #ff9800;
            margin: 0 0 8px 0;
        `;
        
        const hintDesc = hintSection.createEl('p', { text: 'í‹€ë ¸ì„ ë•Œ ë³´ì—¬ì¤„ íŒíŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)' });
        hintDesc.style.cssText = `
            font-size: 13px;
            color: var(--text-muted);
            margin: 0 0 16px 0;
        `;
        
        const hintContainer = hintSection.createDiv({ cls: 'hint-container' });
        hintContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        `;
        
        // íŒíŠ¸ ì…ë ¥ ì˜ì—­ - ë‹¨ìˆœí™”
        const hintInput = hintContainer.createEl('textarea', {
            placeholder: 'í‹€ë ¸ì„ ë•Œ ë³´ì—¬ì¤„ íŒíŠ¸ (ì„ íƒì‚¬í•­)'
        });
        hintInput.value = this.question.hint || '';
        hintInput.style.cssText = `
            width: 100%;
            padding: 18px;
            resize: vertical;
            font-size: 17px;
            line-height: 1.7;
            border: 2px solid #ffb300;
            border-radius: 10px;
            background: var(--background-primary);
            min-height: 160px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        `;
        hintInput.rows = 7;
        
        hintInput.addEventListener('focus', () => {
            hintInput.style.borderColor = '#ff9800';
            hintInput.style.boxShadow = '0 0 0 3px rgba(255, 152, 0, 0.1)';
        });
        
        hintInput.addEventListener('blur', () => {
            hintInput.style.borderColor = '#ffb300';
            hintInput.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.05)';
        });
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í—ˆìš©
        hintInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && ['v', 'c', 'x', 'a', 'z'].includes(e.key.toLowerCase())) {
                e.stopPropagation();
            }
        }, true);
        
        hintInput.addEventListener('paste', (e) => {
            e.stopPropagation();
        }, true);
        
        hintInput.addEventListener('input', (e) => {
            this.question.hint = e.target.value;
        });
        
        // íŒíŠ¸ ì´ë¯¸ì§€ ì„¹ì…˜ êµ¬ë¶„ì„ 
        const hintImageDivider = hintSection.createEl('div');
        hintImageDivider.style.cssText = `
            height: 1px;
            background: linear-gradient(to right, transparent, #ffb300, transparent);
            margin: 20px 0;
        `;
        
        // íŒíŠ¸ ì´ë¯¸ì§€ í—¤ë”
        const hintImageHeader = hintSection.createEl('h4', { text: 'ğŸ–¼ï¸ íŒíŠ¸ ì´ë¯¸ì§€' });
        hintImageHeader.style.cssText = `
            font-size: 15px;
            font-weight: 600;
            color: #ff9800;
            margin: 0 0 12px 0;
        `;
        
        // íŒíŠ¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ
        this.createImageUploader(
            hintSection,
            () => this.question.hintImage || '',
            (value) => { this.question.hintImage = value; },
            'íŒíŠ¸ ì´ë¯¸ì§€'
        );

        // ë…¸íŠ¸ - í° ë…ë¦½ ì„¹ì…˜
        const noteSection = form.createDiv({ cls: 'note-section' });
        noteSection.style.cssText = `
            background: linear-gradient(135deg, #e3f2fd15 0%, #90caf915 100%);
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #42a5f5;
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.15);
            margin-top: 20px;
        `;
        
        const noteHeader = noteSection.createEl('h3', { text: 'ğŸ“ ë…¸íŠ¸' });
        noteHeader.style.cssText = `
            font-size: 18px;
            font-weight: 700;
            color: #1976d2;
            margin: 0 0 8px 0;
        `;
        
        const noteDesc = noteSection.createEl('p', { text: 'ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ê¸°ì–µí•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)' });
        noteDesc.style.cssText = `
            font-size: 13px;
            color: var(--text-muted);
            margin: 0 0 16px 0;
        `;
        
        const noteContainer = noteSection.createDiv({ cls: 'note-container' });
        noteContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        `;
        
        // ë…¸íŠ¸ ì…ë ¥ ì˜ì—­ - ë‹¨ìˆœí™”
        const noteInput = noteContainer.createEl('textarea', {
            placeholder: 'ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ê¸°ì–µí•  ë‚´ìš© (ì„ íƒì‚¬í•­)'
        });
        noteInput.value = this.question.note || '';
        noteInput.style.cssText = `
            width: 100%;
            padding: 18px;
            resize: vertical;
            font-size: 17px;
            line-height: 1.7;
            border: 2px solid #42a5f5;
            border-radius: 10px;
            background: var(--background-primary);
            min-height: 160px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        `;
        noteInput.rows = 7;
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆì—ì„œ ì ‘ê·¼í•˜ê¸° ìœ„í•´ ì €ì¥
        this.noteTextarea = noteInput;
        
        noteInput.addEventListener('focus', () => {
            noteInput.style.borderColor = '#1976d2';
            noteInput.style.boxShadow = '0 0 0 3px rgba(25, 118, 210, 0.1)';
        });
        
        noteInput.addEventListener('blur', () => {
            noteInput.style.borderColor = '#42a5f5';
            noteInput.style.boxShadow = 'inset 0 2px 4px rgba(0,0,0,0.05)';
        });
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í—ˆìš©
        noteInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && ['v', 'c', 'x', 'a', 'z'].includes(e.key.toLowerCase())) {
                e.stopPropagation();
            }
        }, true);
        
        noteInput.addEventListener('paste', (e) => {
            e.stopPropagation();
        }, true);
        
        noteInput.addEventListener('input', (e) => {
            this.question.note = e.target.value;
        });
        
        // ë…¸íŠ¸ ì´ë¯¸ì§€ ì„¹ì…˜ êµ¬ë¶„ì„ 
        const noteImageDivider = noteSection.createEl('div');
        noteImageDivider.style.cssText = `
            height: 1px;
            background: linear-gradient(to right, transparent, #42a5f5, transparent);
            margin: 20px 0;
        `;
        
        // ë…¸íŠ¸ ì´ë¯¸ì§€ í—¤ë”
        const noteImageHeader = noteSection.createEl('h4', { text: 'ğŸ–¼ï¸ ë…¸íŠ¸ ì´ë¯¸ì§€' });
        noteImageHeader.style.cssText = `
            font-size: 15px;
            font-weight: 600;
            color: #1976d2;
            margin: 0 0 12px 0;
        `;
        
        // ë…¸íŠ¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ
        this.createImageUploader(
            noteSection,
            () => this.question.noteImage || '',
            (value) => { this.question.noteImage = value; },
            'ë…¸íŠ¸ ì´ë¯¸ì§€'
        );

        // ë²„íŠ¼ (í•˜ë‹¨ ê³ ì •)
        const buttonContainer = contentEl.createDiv({ cls: 'button-container' });
        buttonContainer.style.cssText = `
            flex: 0 0 auto;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 15px 0 0 0;
            border-top: 1px solid var(--background-modifier-border);
            background: var(--background-primary);
        `;

        const saveBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ’¾ ì €ì¥',
            cls: 'mod-cta'
        });
        saveBtn.style.cssText = `
            padding: 12px 24px;
            font-size: 15px;
            min-height: 44px;
            font-weight: 600;
        `;
        saveBtn.addEventListener('click', async () => {
            console.log('ğŸ’¾ [ì €ì¥ ë²„íŠ¼ í´ë¦­]');
            console.log('  í˜„ì¬ options:', this.question.options);
            console.log('  í˜„ì¬ optionImages:', this.question.optionImages);
            
            if (this.validateQuestion()) {
                try {
                    await this.plugin.saveQuestion(this.question, !this.existingQuestion);
                    this.close();
                } catch (error) {
                    // ì¤‘ë³µ ì—ëŸ¬ ë“± ë°œìƒ ì‹œ ëª¨ë‹¬ì€ ë‹«ì§€ ì•ŠìŒ
                    console.error('ë¬¸ì œ ì €ì¥ ì‹¤íŒ¨:', error);
                }
            } else {
                console.log('âŒ [ì €ì¥ ë²„íŠ¼] validateQuestion ì‹¤íŒ¨');
            }
        });

        this.addStyles();
    }

    validateQuestion() {
        if (!this.question.hanzi) {
            new Notice('âŒ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return false;
        }
        if (!this.question.number) {
            new Notice('âŒ ë¬¸ì œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return false;
        }
        if (!this.question.question) {
            new Notice('âŒ ë¬¸ì œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return false;
        }
        
        // ìœ íš¨í•œ ì„ íƒì§€ í•„í„°ë§ (ê°’ì´ ìˆëŠ” ê²ƒë§Œ)
        const validOptions = this.question.options.filter(opt => opt && opt.trim());
        
        if (validOptions.length === 0) {
            new Notice('âŒ ìµœì†Œ 1ê°œì˜ ì„ íƒì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return false;
        }
        
        // ë¹ˆ ì„ íƒì§€ ì œê±° ì‹œ optionImagesë„ í•¨ê»˜ ì •ë¦¬
        const validOptionImages = [];
        for (let i = 0; i < this.question.options.length; i++) {
            if (this.question.options[i] && this.question.options[i].trim()) {
                validOptionImages.push(this.question.optionImages[i] || '');
            }
        }
        
        this.question.options = validOptions;
        this.question.optionImages = validOptionImages;
        
        console.log('âœ… [validateQuestion] ê²€ì¦ í›„ options:', this.question.options);
        console.log('âœ… [validateQuestion] ê²€ì¦ í›„ optionImages:', this.question.optionImages);
        
        // ì •ë‹µ ì¸ë±ìŠ¤ ìœ íš¨ì„± ê²€ì‚¬
        if (this.question.answer >= validOptions.length) {
            new Notice('âŒ ì •ë‹µì´ ìœ íš¨í•œ ì„ íƒì§€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤!');
            return false;
        }
        
        return true;
    }

    addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .hanzi-question-modal {
                padding: 20px;
                max-width: 600px;
            }
            .question-form .setting-item {
                border: none;
                padding: 10px 0;
            }
            
            /* ëª¨ë°”ì¼ ìµœì í™” */
            @media (max-width: 768px) {
                .hanzi-question-modal {
                    padding: 12px;
                    max-width: 100vw;
                    width: 100%;
                }
                
                .hanzi-question-modal .modal-scroll-container {
                    padding: 8px 4px;
                }
                
                .hanzi-question-modal input[type="text"],
                .hanzi-question-modal textarea,
                .hanzi-question-modal select {
                    font-size: 16px !important; /* iOS ìë™ ì¤Œ ë°©ì§€ */
                    padding: 10px !important;
                    min-height: 44px;
                    touch-action: manipulation;
                }
                
                .hanzi-question-modal button {
                    min-height: 44px !important;
                    padding: 10px 16px !important;
                    font-size: 14px !important;
                    touch-action: manipulation;
                    -webkit-tap-highlight-color: transparent;
                }
                
                .hanzi-question-modal .paste-btn,
                .hanzi-question-modal .image-upload-btn,
                .hanzi-question-modal .image-clipboard-btn,
                .hanzi-question-modal .image-clear-btn {
                    padding: 12px 16px !important;
                    font-size: 15px !important;
                }
                
                .hanzi-question-modal .image-button-row {
                    flex-wrap: wrap;
                }
                
                .hanzi-question-modal .option-wrapper {
                    margin-bottom: 20px !important;
                }
                
                .hanzi-question-modal .delete-option-btn,
                .hanzi-question-modal .add-option-btn {
                    min-width: 44px;
                }
            }
            
            @media (max-width: 480px) {
                .hanzi-question-modal {
                    padding: 10px;
                }
                
                .hanzi-question-modal .modal-scroll-container {
                    padding: 6px 2px;
                }
                
                .hanzi-question-modal .setting-item {
                    padding: 8px 0;
                }
                
                .hanzi-question-modal .image-button-row {
                    flex-direction: column;
                }
                
                .hanzi-question-modal .image-button-row button {
                    width: 100%;
                }
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
        if (this.updateListener) {
            window.removeEventListener('quiz-question-updated', this.updateListener);
            console.log('ğŸ—‘ï¸ [ë¬¸ì œ í¸ì§‘ ëª¨ë‹¬] ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¨');
        }
        
        const { contentEl } = this;
        contentEl.empty();
    }
}

// í´ë” ì„ íƒ ëª¨ë‹¬
class FolderSelectionModal extends Modal {
    constructor(app, folders, onSelect, plugin) {
        super(app);
        this.folders = folders;
        this.onSelect = onSelect;
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('folder-selection-modal');

        contentEl.createEl('h2', { text: 'ğŸ“‚ í´ë” ì„ íƒ' });
        contentEl.createEl('p', { text: 'ëŒ€ì‹œë³´ë“œë¥¼ ìƒì„±í•  í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”' });

        const folderList = contentEl.createDiv({ cls: 'folder-list' });

        // ë¶ë§ˆí¬ í´ë”ë¥¼ ë§¨ ì•ì— ì¶”ê°€
        const bookmarkFolderName = this.plugin ? this.plugin.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬' : 'â­ ë¶ë§ˆí¬';
        
        // ë¶ë§ˆí¬ ë©”ì¸ í´ë” ë²„íŠ¼
        const bookmarkBtn = folderList.createEl('button', {
            text: `â­ ${bookmarkFolderName} (ì „ì²´)`,
            cls: 'folder-selection-btn bookmark-folder-btn'
        });
        bookmarkBtn.addEventListener('click', () => {
            this.close();
            this.onSelect(bookmarkFolderName);
        });
        
        // ë¶ë§ˆí¬ ì„œë¸Œí´ë”ë“¤ (ì§ˆë¬¸ í´ë”ë³„)
        if (this.plugin && this.folders && this.folders.length > 0) {
            // êµ¬ë¶„ì„  ì¶”ê°€
            folderList.createEl('hr', { cls: 'folder-separator' });
            
            // ë¶ë§ˆí¬ ì„œë¸Œí´ë” ì œëª©
            const bookmarkSubTitle = folderList.createEl('div', { 
                text: 'ğŸ“‚ í´ë”ë³„ ë¶ë§ˆí¬', 
                cls: 'bookmark-subfolder-title' 
            });
            
            // ê° ì§ˆë¬¸ í´ë”ë³„ ë¶ë§ˆí¬
            this.folders.forEach(folder => {
                const subFolderBtn = folderList.createEl('button', {
                    text: `  â­ ${folder} ë¶ë§ˆí¬`,
                    cls: 'folder-selection-btn bookmark-subfolder-btn'
                });
                
                subFolderBtn.addEventListener('click', () => {
                    this.close();
                    this.onSelect(`${bookmarkFolderName}/${folder}`);
                });
            });
            
            // êµ¬ë¶„ì„  ì¶”ê°€
            folderList.createEl('hr', { cls: 'folder-separator' });
        }

        // ì¼ë°˜ í´ë”ë“¤
        this.folders.forEach(folder => {
            const folderBtn = folderList.createEl('button', {
                text: `ğŸ“ ${folder}`,
                cls: 'folder-selection-btn'
            });
            
            folderBtn.addEventListener('click', () => {
                this.close();
                this.onSelect(folder);
            });
        });

        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            .folder-selection-modal {
                padding: 20px;
            }
            .folder-selection-modal h2 {
                margin-bottom: 10px;
            }
            .folder-selection-modal p {
                color: var(--text-muted);
                margin-bottom: 20px;
            }
            .folder-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .folder-separator {
                border: none;
                border-top: 2px solid var(--background-modifier-border);
                margin: 10px 0;
            }
            .bookmark-subfolder-title {
                padding: 10px 15px;
                font-size: 0.9rem;
                font-weight: bold;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            .folder-selection-btn {
                padding: 15px;
                background: var(--background-secondary);
                border: 2px solid var(--background-modifier-border);
                border-radius: 8px;
                cursor: pointer;
                font-size: 1rem;
                font-weight: bold;
                transition: all 0.2s ease;
                color: var(--text-normal);
                text-align: left;
            }
            .folder-selection-btn:hover {
                background: var(--interactive-accent);
                color: white;
                border-color: var(--interactive-accent);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }
            .bookmark-folder-btn {
                background: linear-gradient(135deg, #FFD700, #FFA500);
                border-color: #FF8C00;
                color: #000000;
                font-weight: bold;
            }
            .bookmark-folder-btn:hover {
                background: linear-gradient(135deg, #FFA500, #FF8C00);
                border-color: #FF6B00;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 140, 0, 0.4);
            }
            .bookmark-subfolder-btn {
                background: linear-gradient(135deg, #FFE680, #FFD700);
                border-color: #FFA500;
                color: #000000;
                padding-left: 30px;
                font-size: 0.95rem;
            }
            .bookmark-subfolder-btn:hover {
                background: linear-gradient(135deg, #FFD700, #FFA500);
                border-color: #FF8C00;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ë¶ë§ˆí¬ í´ë” ì„ íƒ ëª¨ë‹¬
class BookmarkFolderSelectionModal extends Modal {
    constructor(app, plugin, question, onSelect, isOptionBookmark = false, optionIndex = null) {
        super(app);
        this.plugin = plugin;
        this.question = question;
        this.onSelect = onSelect;
        this.isOptionBookmark = isOptionBookmark;
        this.optionIndex = optionIndex;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('bookmark-folder-selection-modal');

        contentEl.createEl('h2', { text: 'â­ ë¶ë§ˆí¬ í´ë” ì„ íƒ' });
        
        if (this.isOptionBookmark && this.optionIndex !== null) {
            contentEl.createEl('p', { 
                text: `ì„ íƒì§€ ${this.optionIndex + 1}: "${this.question.options[this.optionIndex]}"ë¥¼ ì–´ëŠ í´ë”ì— ë¶ë§ˆí¬í• ê¹Œìš”?` 
            });
        } else {
            contentEl.createEl('p', { text: `"${this.question.hanzi}" ë¬¸ì œë¥¼ ì–´ëŠ í´ë”ì— ë¶ë§ˆí¬í• ê¹Œìš”?` });
        }

        const folderList = contentEl.createDiv({ cls: 'bookmark-folder-list' });

        // ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  í´ë” í‘œì‹œ
        const folders = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        
        folders.forEach(folder => {
            const folderBtn = folderList.createEl('button', {
                text: `ğŸ“ ${folder}`,
                cls: 'bookmark-folder-btn'
            });
            
            folderBtn.addEventListener('click', () => {
                this.close();
                this.onSelect(folder);
            });
        });

        // ìƒˆ í´ë” ë§Œë“¤ê¸° ë²„íŠ¼ ì¶”ê°€
        const newFolderContainer = contentEl.createDiv();
        newFolderContainer.style.cssText = 'margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--background-modifier-border);';
        
        const newFolderBtn = newFolderContainer.createEl('button', {
            text: 'â• ìƒˆ í´ë” ë§Œë“¤ê¸°',
            cls: 'new-folder-btn'
        });
        newFolderBtn.style.cssText = `
            width: 100%;
            padding: 12px;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            min-height: 44px;
        `;
        
        newFolderBtn.addEventListener('click', () => {
            this.close();
            const inputModal = new TextInputModal(this.app, 'ìƒˆ í´ë” ì´ë¦„', '', async (folderName) => {
                if (folderName && folderName.trim()) {
                    const trimmedName = folderName.trim();
                    
                    // í´ë” ëª©ë¡ì— ì¶”ê°€
                    if (!this.plugin.settings.questionFolders.includes(trimmedName)) {
                        this.plugin.settings.questionFolders.push(trimmedName);
                        await this.plugin.saveSettings();
                        
                        // í´ë” ìƒì„±
                        const folderPath = `${this.plugin.settings.questionsFolder}/${trimmedName}`;
                        try {
                            const exists = this.app.vault.getAbstractFileByPath(folderPath);
                            if (!exists) {
                                await this.app.vault.createFolder(folderPath);
                            }
                        } catch (e) {
                            console.log('í´ë” ìƒì„± ì¤‘ ì˜¤ë¥˜:', e);
                        }
                        
                        new Notice(`âœ… í´ë” "${trimmedName}" ìƒì„±ë¨`);
                    }
                    
                    // ìƒˆ í´ë”ë¡œ ë¶ë§ˆí¬
                    this.onSelect(trimmedName);
                }
            });
            inputModal.open();
        });

        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            .bookmark-folder-selection-modal {
                padding: 24px;
                max-width: 550px;
            }
            .bookmark-folder-selection-modal h2 {
                margin-bottom: 8px;
                color: var(--text-accent);
                font-size: 1.5em;
                font-weight: 700;
            }
            .bookmark-folder-selection-modal p {
                color: var(--text-muted);
                margin-bottom: 20px;
                font-size: 0.95rem;
                line-height: 1.5;
            }
            .bookmark-folder-list {
                display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .bookmark-folder-btn {
                padding: 16px 18px;
                background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                border: 2px solid #FF8C00;
                border-radius: 10px;
                cursor: pointer;
                font-size: 1.05rem;
                font-weight: 600;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                color: #000000;
                text-align: center;
                box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
                position: relative;
                overflow: hidden;
            }
            .bookmark-folder-btn::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.2);
                transition: left 0.3s ease;
                border-radius: 10px;
            }
            .bookmark-folder-btn:hover {
                background: linear-gradient(135deg, #FFA500 0%, #FF8C00 100%);
                border-color: #E67E00;
                transform: translateY(-4px);
                box-shadow: 0 8px 24px rgba(255, 165, 0, 0.5);
            }
            .bookmark-folder-btn:hover::before {
                left: 100%;
            }
            .bookmark-folder-btn:active {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(255, 165, 0, 0.3);
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class FolderManagementModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('folder-management-modal');
        
        // ëª¨ë°”ì¼ ê°ì§€
        const isMobile = this.app.isMobile || window.innerWidth <= 768;
        
        // ëª¨ë‹¬ ì „ì²´ ë ˆì´ì•„ì›ƒ ì„¤ì •
        contentEl.style.cssText = `
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: ${isMobile ? '85vh' : '90vh'};
            overflow: hidden;
            padding: ${isMobile ? '12px' : '20px'};
        `;

        // í—¤ë” (ê³ ì •)
        const header = contentEl.createDiv({ cls: 'modal-header-fixed' });
        header.style.cssText = `
            flex: 0 0 auto;
            padding-bottom: ${isMobile ? '8px' : '10px'};
            border-bottom: 1px solid var(--background-modifier-border);
            margin-bottom: ${isMobile ? '8px' : '10px'};
        `;
        header.createEl('h2', { text: 'ğŸ“‚ í´ë” ê´€ë¦¬ v3', attr: { style: isMobile ? 'font-size: 20px; margin: 0 0 8px 0;' : '' } });

        const desc = header.createDiv({ cls: 'folder-desc' });
        desc.innerHTML = 'ë¬¸ì œë¥¼ í´ë”ë³„ë¡œ ë¶„ë¥˜í•˜ì—¬ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. âš™ï¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.';
        if (isMobile) {
            desc.style.fontSize = '13px';
            desc.style.padding = '8px';
            desc.style.marginBottom = '8px';
        }

        // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì˜ì—­
        const scrollContainer = contentEl.createDiv({ cls: 'folder-scroll-container' });
        scrollContainer.style.cssText = `
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: ${isMobile ? '5px 2px' : '10px 5px'};
            margin: ${isMobile ? '5px 0' : '10px 0'};
            -webkit-overflow-scrolling: touch;
        `;

        // í˜„ì¬ í´ë” ëª©ë¡
        const foldersSection = scrollContainer.createDiv({ cls: 'folders-section' });
        foldersSection.createEl('h3', { text: 'í˜„ì¬ í´ë”' });

        const foldersList = foldersSection.createDiv({ cls: 'folders-list' });

        const folders = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        
        folders.forEach((folder, index) => {
            const folderItem = foldersList.createDiv({ cls: 'folder-item' });
            folderItem.style.display = 'flex';
            folderItem.style.justifyContent = 'space-between';
            folderItem.style.alignItems = 'center';
            folderItem.style.padding = '10px';
            folderItem.style.marginBottom = '5px';
            folderItem.style.backgroundColor = 'var(--background-secondary)';
            folderItem.style.borderRadius = '5px';

            const folderInfo = folderItem.createDiv({ cls: 'folder-info' });
            folderInfo.style.flex = '1';
            
            const folderName = folderInfo.createEl('div', { text: `ğŸ“ ${folder}` });
            folderName.style.fontWeight = 'bold';
            folderName.style.marginBottom = '5px';

            const actions = folderItem.createDiv({ cls: 'folder-actions' });
            actions.style.cssText = `
                display: flex !important;
                gap: 5px !important;
                flex-wrap: wrap !important;
                align-items: center !important;
                visibility: visible !important;
            `;


            // ë¬¸ì œ ê°œìˆ˜ í‘œì‹œ
            this.getQuestionCountInFolder(folder).then(count => {
                const countBadge = folderInfo.createEl('span', { text: `${count}ê°œ ë¬¸ì œ` });
                countBadge.style.fontSize = '12px';
                countBadge.style.color = 'var(--text-muted)';
            });

            // í€´ì¦ˆ ì‹œì‘ ë²„íŠ¼
            const quizBtn = actions.createEl('button', { text: 'ğŸ¯ í€´ì¦ˆ' });
            quizBtn.style.padding = '5px 10px';
            quizBtn.style.fontSize = '12px';
            quizBtn.addEventListener('click', async () => {
                this.close();
                await this.plugin.startQuiz(null, false, folder);
            });

            // ë¬¸ì œ ì¶”ê°€ ë²„íŠ¼
            const addBtn = actions.createEl('button', { text: 'â• ë¬¸ì œ' });
            addBtn.style.padding = '5px 10px';
            addBtn.style.fontSize = '12px';
            addBtn.addEventListener('click', () => {
                this.close();
                const modal = new HanziQuestionModal(this.app, this.plugin);
                modal.question.folder = folder;
                modal.open();
            });

            // í´ë” íƒìƒ‰ ë²„íŠ¼
            const exploreBtn = actions.createEl('button', { text: 'ğŸ” íƒìƒ‰ê¸° ë³´ê¸°' });
            exploreBtn.style.padding = '5px 10px';
            exploreBtn.style.fontSize = '12px';
            exploreBtn.addEventListener('click', async () => {
                const folderPath = `${this.plugin.settings.questionsFolder}/${folder}`;
                const folderAbstract = this.app.vault.getAbstractFileByPath(folderPath);
                let revealed = false;
                if (folderAbstract) {
                    let mdFile = null;
                    if (folderAbstract.children && folderAbstract.children.length > 0) {
                        mdFile = folderAbstract.children.find(f => f.extension === 'md');
                    }
                    const explorer = this.app.workspace.getLeavesOfType('file-explorer')[0];
                    if (explorer && explorer.view && explorer.view.revealInFolder) {
                        if (mdFile) {
                            explorer.view.revealInFolder(mdFile);
                            revealed = true;
                        } else {
                            // .md íŒŒì¼ì´ ì—†ìœ¼ë©´ í´ë” ìì²´ë¥¼ reveal
                            explorer.view.revealInFolder(folderAbstract);
                            revealed = true;
                        }
                    }
                    if (!revealed) {
                        new Notice('âŒ íŒŒì¼ íƒìƒ‰ê¸° ë·°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } else {
                    new Notice(`âŒ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${folderPath}`);
                }
                // ìœˆë„ìš° íƒìƒ‰ê¸°ì—ì„œ í´ë” ì—´ê¸° ì¶”ê°€
                try {
                    const absPath = this.app.vault.adapter.getFullPath(folderPath);
                    window.open(`file://${absPath}`);
                } catch (e) {
                    new Notice('âŒ ìœˆë„ìš° íƒìƒ‰ê¸°ì—ì„œ í´ë”ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            });

            // ê´€ë¦¬ ë²„íŠ¼
            const moreBtn = actions.createEl('button', { text: 'âš™ï¸' });
            moreBtn.title = 'í´ë” ê´€ë¦¬';
            moreBtn.style.cssText = `
                padding: 8px 12px !important;
                font-size: 18px !important;
                background-color: #4caf50 !important;
                color: white !important;
                border: 2px solid #45a049 !important;
                border-radius: 5px !important;
                cursor: pointer !important;
                display: inline-block !important;
                visibility: visible !important;
                opacity: 1 !important;
                z-index: 1000 !important;
            `;
            moreBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                const menu = new Menu();
                menu.addItem((item) => {
                    item.setTitle('ğŸ“‹ í´ë” ë³µì‚¬')
                        .setIcon('copy')
                        .onClick(async () => {
                            const inputModal = new TextInputModal(
                                this.app, 
                                'í´ë” ë³µì‚¬', 
                                'ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 
                                `${folder}_ë³µì‚¬ë³¸`,
                                async (newName) => {
                                    if (newName && newName !== folder) {
                                        await this.copyFolder(folder, newName);
                                    }
                                }
                            );
                            inputModal.open();
                        });
                });
                if (folder !== 'ê¸°ë³¸') {
                    menu.addItem((item) => {
                        item.setTitle('âœï¸ ì´ë¦„ ë³€ê²½')
                            .setIcon('pencil')
                            .onClick(async () => {
                                const inputModal = new TextInputModal(
                                    this.app,
                                    'í´ë” ì´ë¦„ ë³€ê²½',
                                    'ìƒˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”',
                                    folder,
                                    async (newName) => {
                                        if (newName && newName !== folder) {
                                            await this.renameFolder(folder, newName);
                                        }
                                    }
                                );
                                inputModal.open();
                            });
                    });
                    menu.addSeparator();
                    menu.addItem((item) => {
                        item.setTitle('ğŸ—‘ï¸ í´ë” ì‚­ì œ')
                            .setIcon('trash')
                            .onClick(async () => {
                                await this.deleteFolder(folder);
                            });
                    });
                }
                menu.showAtMouseEvent(e);
            });

            // ê¸°ì¡´ ì‚­ì œ ë²„íŠ¼ ì œê±°
            if (false && folder !== 'ê¸°ë³¸') {
                const deleteBtn = actions.createEl('button', { text: 'ğŸ—‘ï¸ ì‚­ì œ' });
                deleteBtn.style.padding = '5px 10px';
                deleteBtn.style.fontSize = '12px';
                deleteBtn.addEventListener('click', async () => {
                    const count = await this.getQuestionCountInFolder(folder);
                    if (count > 0) {
                        new Notice(`âŒ í´ë”ì— ${count}ê°œì˜ ë¬¸ì œê°€ ìˆì–´ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    if (confirm(`"${folder}" í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        this.plugin.settings.questionFolders = folders.filter(f => f !== folder);
                        await this.plugin.saveSettings();
                        
                        // í´ë” ì‚­ì œ (ëª¨ë°”ì¼ì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
                        const folderPath = `${this.plugin.settings.questionsFolder}/${folder}`;
                        const folderExists = this.app.vault.getAbstractFileByPath(folderPath);
                        if (folderExists) {
                            try {
                                // ëª¨ë°”ì¼ì—ì„œëŠ” vault.delete()ë¡œ í´ë” ì‚­ì œ
                                await this.app.vault.delete(folderExists, true);
                                new Notice(`âœ… "${folder}" í´ë”ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
                            } catch (e) {
                                console.error('í´ë” ì‚­ì œ ì˜¤ë¥˜:', e);
                                new Notice(`âš ï¸ "${folder}" í´ë” ì‚­ì œ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•˜ì„¸ìš”.`);
                            }
                        } else {
                            new Notice(`âœ… "${folder}" í´ë”ê°€ ëª©ë¡ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        }
                        
                        this.onOpen(); // ìƒˆë¡œê³ ì¹¨
                    }
                });
            }
        });

        // ìƒˆ í´ë” ì¶”ê°€ (ìŠ¤í¬ë¡¤ ì˜ì—­ ë‚´ë¶€)
        const addFolderSection = scrollContainer.createDiv({ cls: 'add-folder-section' });
        addFolderSection.style.marginTop = '20px';
        addFolderSection.createEl('h3', { text: 'ìƒˆ í´ë” ì¶”ê°€' });

        const inputContainer = addFolderSection.createDiv();
        inputContainer.style.display = 'flex';
        inputContainer.style.gap = '10px';
        inputContainer.style.alignItems = 'center';

        const folderInput = inputContainer.createEl('input', { type: 'text' });
        folderInput.placeholder = 'í´ë” ì´ë¦„ ì…ë ¥';
        folderInput.style.flex = '1';
        folderInput.style.padding = '8px';
        folderInput.style.fontSize = '16px'; // iOS ìë™ ì¤Œ ë°©ì§€
        folderInput.style.minHeight = '44px'; // í„°ì¹˜ ìµœì í™”

        // ëª¨ë°”ì¼ í‚¤ë³´ë“œ ëŒ€ì‘: ì…ë ¥ í•„ë“œê°€ í‚¤ë³´ë“œì— ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ ìŠ¤í¬ë¡¤
        if (isMobile) {
            folderInput.addEventListener('focus', () => {
                setTimeout(() => {
                    folderInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300); // í‚¤ë³´ë“œ ì• ë‹ˆë©”ì´ì…˜ ëŒ€ê¸°
            });
        }

        const addBtn = inputContainer.createEl('button', { text: 'â• ì¶”ê°€', cls: 'mod-cta' });
        addBtn.style.minHeight = '44px'; // í„°ì¹˜ ìµœì í™”
        addBtn.addEventListener('click', async () => {
            const folderName = folderInput.value.trim();
            
            if (!folderName) {
                new Notice('âŒ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }

            if (folders.includes(folderName)) {
                new Notice('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í´ë”ì…ë‹ˆë‹¤!');
                return;
            }

            this.plugin.settings.questionFolders.push(folderName);
            await this.plugin.saveSettings();

            // í´ë” ìƒì„± (ëª¨ë°”ì¼ í˜¸í™˜)
            const folderPath = `${this.plugin.settings.questionsFolder}/${folderName}`;
            const folderExists = this.app.vault.getAbstractFileByPath(folderPath);
            if (!folderExists) {
                try {
                    await this.app.vault.createFolder(folderPath);
                } catch (e) {
                    console.log('í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ');
                }
            }

            new Notice(`âœ… "${folderName}" í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            folderInput.value = '';
            this.onOpen(); // ìƒˆë¡œê³ ì¹¨
        });

        // í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ì˜ì—­
        const footer = contentEl.createDiv({ cls: 'modal-footer-fixed' });
        footer.style.cssText = `
            flex: 0 0 auto;
            padding: 20px;
            background: var(--background-primary);
            border-top: 2px solid var(--interactive-accent);
            margin-top: 0;
        `;
        
        const closeBtn = footer.createEl('button', { text: 'âœ… ì €ì¥í•˜ê³  ë‹«ê¸°', cls: 'mod-cta' });
        closeBtn.style.cssText = `
            width: 100%;
            min-height: 48px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
        `;
        
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.transform = 'translateY(-2px)';
            closeBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.transform = 'translateY(0)';
            closeBtn.style.boxShadow = 'none';
        });
        closeBtn.addEventListener('click', () => {
            this.close();
            // ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            this.plugin.openDashboard();
        });

        this.addStyles();
    }

    async getQuestionCountInFolder(folder) {
        const folderPath = `${this.plugin.settings.questionsFolder}/${folder}`;
        
        // ëª¨ë°”ì¼ í˜¸í™˜: getAbstractFileByPath ì‚¬ìš©
        const folderExists = this.app.vault.getAbstractFileByPath(folderPath);
        if (!folderExists) return 0;

        const files = this.app.vault.getMarkdownFiles();
        const questionFiles = files.filter(f => f.path.startsWith(folderPath) && f.path.endsWith('.md'));
        return questionFiles.length;
    }

    addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .folder-management-modal {
                padding: 20px;
                max-width: 500px;
            }
            .folder-desc {
                margin-bottom: 20px;
                padding: 10px;
                background: var(--background-secondary);
                border-radius: 5px;
                font-size: 14px;
                line-height: 1.5;
            }
            .folders-section {
                margin-bottom: 20px;
            }
            .folder-item {
                transition: background 0.2s;
            }
            .folder-item:hover {
                background: var(--background-modifier-hover) !important;
            }
            
            /* ìŠ¤í¬ë¡¤ ì˜ì—­ ìŠ¤íƒ€ì¼ */
            .folder-scroll-container {
                scrollbar-width: thin;
                scrollbar-color: var(--interactive-accent) var(--background-modifier-border);
            }
            
            .folder-scroll-container::-webkit-scrollbar {
                width: 8px;
            }
            
            .folder-scroll-container::-webkit-scrollbar-track {
                background: var(--background-modifier-border);
                border-radius: 4px;
            }
            
            .folder-scroll-container::-webkit-scrollbar-thumb {
                background: var(--interactive-accent);
                border-radius: 4px;
            }
            
            .folder-scroll-container::-webkit-scrollbar-thumb:hover {
                background: var(--interactive-accent-hover);
            }
            
            /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
            @media (max-width: 768px) {
                .folder-management-modal {
                    padding: 12px;
                    max-width: 100%;
                }
                .modal-header-fixed {
                    padding-bottom: 8px;
                }
                .folder-scroll-container {
                    padding: 8px 3px;
                    margin: 8px 0;
                }
                .folder-item {
                    padding: 15px 10px !important;
                    margin-bottom: 10px !important;
                }
                .folder-actions {
                    flex-wrap: wrap !important;
                }
                .folder-actions button {
                    min-height: 44px !important;
                    padding: 10px 15px !important;
                    font-size: 14px !important;
                    touch-action: manipulation;
                    -webkit-tap-highlight-color: transparent;
                }
                .add-folder-section input {
                    font-size: 16px !important; /* iOS ìë™ ì¤Œ ë°©ì§€ */
                    min-height: 44px !important;
                }
            }
            
            @media (max-width: 480px) {
                .folder-management-modal {
                    padding: 10px;
                }
                .folder-item {
                    flex-direction: column;
                    align-items: flex-start !important;
                    gap: 10px;
                }
                .folder-info {
                    width: 100%;
                    margin-bottom: 8px;
                }
                .folder-actions {
                    width: 100%;
                    justify-content: space-between;
                }
                .folder-actions button {
                    flex: 1;
                    min-width: 80px;
                }
            }
        `;
        document.head.appendChild(style);
    }

    async copyFolder(sourceFolder, targetFolder) {
        try {
            if (this.plugin.settings.questionFolders.includes(targetFolder)) {
                new Notice(`âŒ "${targetFolder}" í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                return;
            }
            
            const sourcePath = `${this.plugin.settings.questionsFolder}/${sourceFolder}`;
            const targetPath = `${this.plugin.settings.questionsFolder}/${targetFolder}`;
            
            // ëŒ€ìƒ í´ë” ìƒì„±
            await this.app.vault.createFolder(targetPath).catch(() => {});
            
            // íŒŒì¼ ë³µì‚¬ (í´ë” ì •ë³´ ì—…ë°ì´íŠ¸)
            const files = this.app.vault.getMarkdownFiles();
            const sourceFiles = files.filter(f => f.path.startsWith(sourcePath) && !f.path.includes('ë¬¸ì œëª©ë¡'));
            
            let copiedCount = 0;
            let skippedCount = 0;
            
            for (const file of sourceFiles) {
                const content = await this.app.vault.read(file);
                
                // í´ë” ì •ë³´ë¥¼ ìƒˆ í´ë”ëª…ìœ¼ë¡œ ë³€ê²½ (## í´ë” ì„¹ì…˜ ì—…ë°ì´íŠ¸)
                let updatedContent = content;
                
                // 1. ## í´ë” ì„¹ì…˜ ì—…ë°ì´íŠ¸
                updatedContent = updatedContent.replace(
                    /^## í´ë”\s*\n[^\n]+$/m,
                    `## í´ë”\n${targetFolder}`
                );
                
                // 2. folder: í•„ë“œ ì—…ë°ì´íŠ¸ (YAML frontmatterë‚˜ ì¼ë°˜ í…ìŠ¤íŠ¸)
                updatedContent = updatedContent.replace(
                    /^folder:\s*.+$/m,
                    `folder: ${targetFolder}`
                );
                
                // 3. í´ë” ê²½ë¡œê°€ í¬í•¨ëœ ê²½ìš° ì—…ë°ì´íŠ¸
                updatedContent = updatedContent.replace(
                    new RegExp(`Questions/${sourceFolder}/`, 'g'),
                    `Questions/${targetFolder}/`
                );
                
                // íŒŒì¼ì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
                const targetFilePath = `${targetPath}/${file.name}`;
                const existingFile = this.app.vault.getAbstractFileByPath(targetFilePath);
                
                if (existingFile) {
                    // íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ê±´ë„ˆë›°ê¸°
                    skippedCount++;
                    console.log(`íŒŒì¼ ê±´ë„ˆëœ€ (ì´ë¯¸ ì¡´ì¬): ${targetFilePath}`);
                } else {
                    // íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                    await this.app.vault.create(targetFilePath, updatedContent);
                    copiedCount++;
                }
            }
            
            // í´ë” ëª©ë¡ì— ì¶”ê°€
            this.plugin.settings.questionFolders.push(targetFolder);
            await this.plugin.saveSettings();
            
            const msg = skippedCount > 0 
                ? `âœ… ${targetFolder} í´ë” ìƒì„± ì™„ë£Œ (ë³µì‚¬: ${copiedCount}ê°œ, ê±´ë„ˆëœ€: ${skippedCount}ê°œ)`
                : `âœ… ${targetFolder} í´ë” ìƒì„± ì™„ë£Œ (${copiedCount}ê°œ ë¬¸ì œ)`;
            
            new Notice(msg);
            this.onOpen();
        } catch (error) {
            console.error('í´ë” ë³µì‚¬ ì˜¤ë¥˜:', error);
            new Notice(`âŒ ë³µì‚¬ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    async renameFolder(oldFolder, newFolder) {
        try {
            if (this.plugin.settings.questionFolders.includes(newFolder)) {
                new Notice(`âŒ "${newFolder}" í´ë”ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.`);
                return;
            }
            const oldPath = `${this.plugin.settings.questionsFolder}/${oldFolder}`;
            const newPath = `${this.plugin.settings.questionsFolder}/${newFolder}`;
            await this.app.vault.createFolder(newPath).catch(() => {});
            
            const files = this.app.vault.getMarkdownFiles();
            const oldFiles = files.filter(f => f.path.startsWith(oldPath));
            
            // ê° íŒŒì¼ì˜ ë‚´ìš©ë„ ì—…ë°ì´íŠ¸
            for (const file of oldFiles) {
                const content = await this.app.vault.read(file);
                
                // í´ë” ì •ë³´ ì—…ë°ì´íŠ¸
                let updatedContent = content;
                
                // 1. ## í´ë” ì„¹ì…˜ ì—…ë°ì´íŠ¸
                updatedContent = updatedContent.replace(
                    /^## í´ë”\s*\n[^\n]+$/m,
                    `## í´ë”\n${newFolder}`
                );
                
                // 2. folder: í•„ë“œ ì—…ë°ì´íŠ¸
                updatedContent = updatedContent.replace(
                    /^folder:\s*.+$/m,
                    `folder: ${newFolder}`
                );
                
                // 3. í´ë” ê²½ë¡œ ì—…ë°ì´íŠ¸
                updatedContent = updatedContent.replace(
                    new RegExp(`Questions/${oldFolder}/`, 'g'),
                    `Questions/${newFolder}/`
                );
                
                // ìƒˆ ìœ„ì¹˜ì— íŒŒì¼ ìƒì„±
                await this.app.vault.create(`${newPath}/${file.name}`, updatedContent);
            }
            
            const index = this.plugin.settings.questionFolders.indexOf(oldFolder);
            if (index !== -1) {
                this.plugin.settings.questionFolders[index] = newFolder;
            }
            await this.plugin.saveSettings();
            
            // ì´ì „ í´ë” ì‚­ì œ
            const oldFolderObj = this.app.vault.getAbstractFileByPath(oldPath);
            if (oldFolderObj) await this.app.vault.delete(oldFolderObj, true).catch(() => {});
            
            new Notice(`âœ… ì´ë¦„ ë³€ê²½ ì™„ë£Œ`);
            this.onOpen();
        } catch (error) {
            new Notice(`âŒ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    async deleteFolder(folder) {
        try {
            const count = await this.getQuestionCountInFolder(folder);
            const msg = count > 0 ? `"${folder}" í´ë”ì— ${count}ê°œì˜ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?` : `"${folder}" í´ë”ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            if (!confirm(msg)) return;
            const folderPath = `${this.plugin.settings.questionsFolder}/${folder}`;
            const folderObj = this.app.vault.getAbstractFileByPath(folderPath);
            if (folderObj) await this.app.vault.delete(folderObj, true);
            this.plugin.settings.questionFolders = this.plugin.settings.questionFolders.filter(f => f !== folder);
            await this.plugin.saveSettings();
            
            new Notice(`âœ… ì‚­ì œ ì™„ë£Œ`);
            this.onOpen();
        } catch (error) {
            new Notice(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ìŒì„± íŒŒì¼ ëª©ë¡ ê´€ë¦¬ ëª¨ë‹¬
class AudioListManagementModal extends Modal {
    constructor(app, plugin, quizModal) {
        super(app);
        this.plugin = plugin;
        this.quizModal = quizModal;
        this.audioQuestions = [];
        this.currentIndex = 0;
        this.isPlaying = false;
        this.currentAudio = null;
        this.autoPlayNext = true; // TTSì²˜ëŸ¼ ìë™ ë‹¤ìŒ ì¬ìƒ
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('audio-list-modal');
        
        const isMobile = this.app.isMobile || window.innerWidth <= 768;
        
        contentEl.style.cssText = `
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: ${isMobile ? '85vh' : '90vh'};
            padding: ${isMobile ? '12px' : '20px'};
        `;

        // í—¤ë”
        const header = contentEl.createDiv();
        header.style.cssText = `
            flex: 0 0 auto;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--background-modifier-border);
            margin-bottom: 10px;
        `;
        
        header.createEl('h2', { text: 'ğŸµ ìŒì„± íŒŒì¼ ëª©ë¡ ê´€ë¦¬' });
        
        const desc = header.createDiv();
        desc.style.cssText = 'font-size: 13px; color: var(--text-muted); margin-top: 8px;';
        desc.innerHTML = 'ìŒì„±ì´ ìˆëŠ” ë¬¸ì œë¥¼ ìë™ìœ¼ë¡œ ì—°ì† ì¬ìƒí•©ë‹ˆë‹¤ (Anki ìŠ¤íƒ€ì¼)';

        // ìŒì„± íŒŒì¼ì´ ìˆëŠ” ë¬¸ì œ ìˆ˜ì§‘
        await this.collectAudioQuestions();

        // ì»¨íŠ¸ë¡¤ ë°”
        const controlBar = contentEl.createDiv();
        controlBar.style.cssText = `
            display: flex;
            gap: 10px;
            padding: 15px;
            background: var(--background-secondary);
            border-radius: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        `;

        // ìë™ ì¬ìƒ í† ê¸€
        const autoPlayToggle = controlBar.createDiv();
        autoPlayToggle.style.cssText = 'display: flex; align-items: center; gap: 8px;';
        
        const autoPlayCheckbox = autoPlayToggle.createEl('input', { type: 'checkbox' });
        autoPlayCheckbox.checked = this.autoPlayNext;
        autoPlayCheckbox.style.cssText = 'width: 20px; height: 20px; cursor: pointer;';
        autoPlayCheckbox.onchange = () => {
            this.autoPlayNext = autoPlayCheckbox.checked;
            new Notice(this.autoPlayNext ? 'âœ… ìë™ ì¬ìƒ í™œì„±í™”' : 'âŒ ìë™ ì¬ìƒ ë¹„í™œì„±í™”');
        };
        
        autoPlayToggle.createEl('label', { text: 'ìë™ ë‹¤ìŒ ì¬ìƒ' }).style.cursor = 'pointer';
        autoPlayToggle.onclick = () => autoPlayCheckbox.click();

        // ì „ì²´ ì¬ìƒ ë²„íŠ¼
        const playAllBtn = controlBar.createEl('button', { text: 'â–¶ ì „ì²´ ì¬ìƒ' });
        playAllBtn.style.cssText = `
            padding: 10px 16px;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px;
        `;
        playAllBtn.onclick = () => {
            this.currentIndex = 0;
            this.playCurrentQuestion();
        };

        // ì •ì§€ ë²„íŠ¼
        const stopBtn = controlBar.createEl('button', { text: 'â¹ ì •ì§€' });
        stopBtn.style.cssText = `
            padding: 10px 16px;
            background: var(--background-modifier-error);
            color: var(--text-on-accent);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-height: 44px;
        `;
        stopBtn.onclick = () => {
            this.stopAudio();
        };

        // ìŠ¤í¬ë¡¤ ì˜ì—­
        const scrollArea = contentEl.createDiv();
        scrollArea.style.cssText = `
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        `;

        // ìŒì„± íŒŒì¼ ëª©ë¡
        if (this.audioQuestions.length === 0) {
            scrollArea.createEl('p', { 
                text: 'ìŒì„± íŒŒì¼ì´ ìˆëŠ” ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.',
                cls: 'audio-empty-message'
            }).style.cssText = 'text-align: center; color: var(--text-muted); padding: 40px;';
        } else {
            scrollArea.createEl('h3', { 
                text: `ì´ ${this.audioQuestions.length}ê°œì˜ ìŒì„± ë¬¸ì œ`
            }).style.marginBottom = '15px';

            this.audioQuestions.forEach((q, index) => {
                const item = scrollArea.createDiv();
                item.style.cssText = `
                    padding: 12px;
                    margin-bottom: 10px;
                    background: var(--background-secondary);
                    border-radius: 8px;
                    border: 2px solid ${this.currentIndex === index && this.isPlaying ? 'var(--interactive-accent)' : 'var(--background-modifier-border)'};
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;

                const info = item.createDiv();
                info.style.flex = '1';
                
                const title = info.createEl('div', { 
                    text: `${index + 1}. ${q.hanzi} - ${q.question}`
                });
                title.style.cssText = 'font-weight: 600; margin-bottom: 4px;';
                
                const meta = info.createEl('div', { 
                    text: `í´ë”: ${q.folder || 'ê¸°ë³¸'}`
                });
                meta.style.cssText = 'font-size: 12px; color: var(--text-muted);';

                // ì¬ìƒ ë²„íŠ¼
                const playBtn = item.createEl('button', { 
                    text: this.currentIndex === index && this.isPlaying ? 'â¸' : 'â–¶'
                });
                playBtn.style.cssText = `
                    padding: 8px 12px;
                    background: var(--interactive-accent);
                    color: var(--text-on-accent);
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 14px;
                    min-width: 44px;
                    min-height: 44px;
                `;
                playBtn.onclick = () => {
                    if (this.currentIndex === index && this.isPlaying) {
                        this.stopAudio();
                    } else {
                        this.currentIndex = index;
                        this.playCurrentQuestion();
                    }
                };

                // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ì°¸ì¡° ì €ì¥
                item.dataset.index = index;
            });
        }

        // ë‹«ê¸° ë²„íŠ¼
        const footer = contentEl.createDiv();
        footer.style.cssText = `
            flex: 0 0 auto;
            padding-top: 15px;
            border-top: 1px solid var(--background-modifier-border);
            margin-top: 10px;
            text-align: center;
        `;
        
        const closeBtn = footer.createEl('button', { text: 'ë‹«ê¸°' });
        closeBtn.style.cssText = `
            padding: 10px 24px;
            background: var(--background-secondary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            cursor: pointer;
            min-height: 44px;
        `;
        closeBtn.onclick = () => {
            this.stopAudio();
            this.close();
            if (this.quizModal && !this.quizModal.isPaused) {
                this.quizModal.isPaused = false;
            }
        };
    }

    async collectAudioQuestions() {
        const allQuestions = await this.plugin.loadAllQuestions();
        this.audioQuestions = allQuestions.filter(q => q.audio && q.audio.trim());
    }

    async playCurrentQuestion() {
        if (this.currentIndex >= this.audioQuestions.length) {
            new Notice('âœ… ëª¨ë“  ìŒì„± ì¬ìƒ ì™„ë£Œ');
            this.stopAudio();
            return;
        }

        const question = this.audioQuestions[this.currentIndex];
        
        // ì´ì „ ì˜¤ë””ì˜¤ ì •ì§€
        if (this.currentAudio) {
            this.currentAudio.pause();
            this.currentAudio = null;
        }

        try {
            // ìŒì„± íŒŒì¼ ê²½ë¡œ ì²˜ë¦¬
            let audioPath = question.audio.trim();
            
            // [[audio.mp3]] í˜•ì‹ ì²˜ë¦¬
            if (audioPath.startsWith('[[') && audioPath.endsWith(']]')) {
                audioPath = audioPath.slice(2, -2);
            }

            // íŒŒì¼ ê²½ë¡œ ìƒì„±
            const fullPath = `${this.plugin.settings.questionsFolder}/${question.folder}/${this.plugin.settings.attachmentFolderName}/${audioPath}`;
            const audioFile = this.app.vault.getAbstractFileByPath(fullPath);

            if (audioFile) {
                const audioUrl = this.app.vault.getResourcePath(audioFile);
                this.currentAudio = new Audio(audioUrl);
                
                this.currentAudio.onended = () => {
                    if (this.autoPlayNext) {
                        this.currentIndex++;
                        setTimeout(() => {
                            this.playCurrentQuestion();
                        }, 500); // 0.5ì´ˆ ê°„ê²©
                    } else {
                        this.isPlaying = false;
                        this.onOpen(); // UI ì—…ë°ì´íŠ¸
                    }
                };

                this.currentAudio.onerror = () => {
                    new Notice(`âŒ ìŒì„± ì¬ìƒ ì‹¤íŒ¨: ${question.hanzi}`);
                    if (this.autoPlayNext) {
                        this.currentIndex++;
                        this.playCurrentQuestion();
                    }
                };

                await this.currentAudio.play();
                this.isPlaying = true;
                
                new Notice(`ğŸµ ì¬ìƒ ì¤‘: ${question.hanzi} (${this.currentIndex + 1}/${this.audioQuestions.length})`);
                
                // UI ì—…ë°ì´íŠ¸
                this.onOpen();
            } else {
                new Notice(`âŒ ìŒì„± íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${audioPath}`);
                if (this.autoPlayNext) {
                    this.currentIndex++;
                    this.playCurrentQuestion();
                }
            }
        } catch (error) {
            new Notice(`âŒ ì¬ìƒ ì˜¤ë¥˜: ${error.message}`);
            if (this.autoPlayNext) {
                this.currentIndex++;
                this.playCurrentQuestion();
            }
        }
    }

    stopAudio() {
        if (this.currentAudio) {
            this.currentAudio.pause();
            this.currentAudio = null;
        }
        this.isPlaying = false;
        this.onOpen(); // UI ì—…ë°ì´íŠ¸
    }

    onClose() {
        this.stopAudio();
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ìµœê·¼ íŒŒì¼ ëª¨ë‹¬
class QuizRecentFilesModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
        this.currentPage = 1;
        this.itemsPerPage = 10;
    }

    async onOpen() {
        const { contentEl, modalEl } = this;
        contentEl.empty();
        
        const isMobile = window.innerWidth <= 768;
        modalEl.style.width = isMobile ? '95vw' : '900px';
        modalEl.style.maxWidth = '95vw';
        
        contentEl.createEl('h2', { text: 'ğŸ“‹ Recent Study Records' }).style.fontSize = isMobile ? '1.3rem' : '1.5rem';
        
        const allRecords = this.getRecentRecords();
        
        if (allRecords.length === 0) {
            contentEl.createEl('p', { text: 'ìµœê·¼ í•™ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.' });
            const closeBtn = contentEl.createEl('button', { text: 'ë‹«ê¸°' });
            closeBtn.style.marginTop = '20px';
            closeBtn.addEventListener('click', () => this.close());
            return;
        }
        
        const totalPages = Math.ceil(allRecords.length / this.itemsPerPage);
        const startIdx = (this.currentPage - 1) * this.itemsPerPage;
        const endIdx = startIdx + this.itemsPerPage;
        const currentRecords = allRecords.slice(startIdx, endIdx);
        
        const container = contentEl.createDiv({ cls: 'recent-records-container' });
        container.style.maxHeight = isMobile ? '400px' : '500px';
        container.style.overflowY = 'auto';
        container.style.marginBottom = '15px';
        
        for (const record of currentRecords) {
            const item = container.createDiv({ cls: 'recent-record-item' });
            item.style.backgroundColor = 'var(--background-secondary)';
            item.style.padding = '12px';
            item.style.borderRadius = '8px';
            item.style.marginBottom = '10px';
            item.style.border = '1px solid var(--background-modifier-border)';
            item.style.transition = 'all 0.2s';
            
            item.addEventListener('mouseenter', () => {
                item.style.borderColor = 'var(--interactive-accent)';
                item.style.backgroundColor = 'var(--background-primary-alt)';
            });
            item.addEventListener('mouseleave', () => {
                item.style.borderColor = 'var(--background-modifier-border)';
                item.style.backgroundColor = 'var(--background-secondary)';
            });
            
            const header = item.createDiv();
            header.style.display = 'flex';
            header.style.justifyContent = 'space-between';
            header.style.marginBottom = '8px';
            
            const dateEl = header.createEl('span');
            dateEl.style.fontWeight = 'bold';
            dateEl.style.color = 'var(--text-accent)';
            dateEl.style.fontSize = isMobile ? '0.9rem' : '1rem';
            dateEl.setText(record.displayDate);
            
            const statsEl = header.createEl('span');
            statsEl.style.fontSize = '0.9rem';
            statsEl.style.color = 'var(--text-muted)';
            const percentage = record.total > 0 ? Math.round((record.correct / record.total) * 100) : 0;
            const statusEmoji = percentage === 100 ? 'âœ…' : percentage >= 70 ? 'â­' : 'ğŸ“';
            statsEl.setText(`${statusEmoji} ${record.correct}/${record.total} (${percentage}%)`);
            
            const infoEl = item.createDiv();
            infoEl.style.fontSize = isMobile ? '0.8rem' : '0.85rem';
            infoEl.style.color = 'var(--text-muted)';
            infoEl.style.marginTop = '5px';
            infoEl.style.lineHeight = '1.4';
            
            const timeText = this.formatTime(record.time);
            infoEl.setText(`ğŸ“ ${record.folderName} | â±ï¸ ${timeText}`);
        }
        
        // í˜ì´ì§€ë„¤ì´ì…˜
        if (totalPages > 1) {
            const pagination = contentEl.createDiv({ cls: 'pagination' });
            pagination.style.display = 'flex';
            pagination.style.justifyContent = 'center';
            pagination.style.gap = '8px';
            pagination.style.marginBottom = '10px';
            
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = pagination.createEl('button', { text: i.toString() });
                pageBtn.style.padding = isMobile ? '8px 12px' : '6px 12px';
                pageBtn.style.border = 'none';
                pageBtn.style.borderRadius = '4px';
                pageBtn.style.cursor = 'pointer';
                pageBtn.style.fontWeight = 'bold';
                pageBtn.style.transition = 'all 0.2s';
                pageBtn.style.fontSize = isMobile ? '0.9rem' : '0.85rem';
                pageBtn.style.minWidth = isMobile ? '44px' : '36px';
                pageBtn.style.minHeight = isMobile ? '44px' : '36px';
                
                if (i === this.currentPage) {
                    pageBtn.style.backgroundColor = 'var(--interactive-accent)';
                    pageBtn.style.color = 'var(--text-on-accent)';
                } else {
                    pageBtn.style.backgroundColor = 'var(--background-secondary)';
                    pageBtn.style.color = 'var(--text-normal)';
                    
                    pageBtn.addEventListener('mouseenter', () => {
                        pageBtn.style.backgroundColor = 'var(--background-modifier-border)';
                    });
                    pageBtn.addEventListener('mouseleave', () => {
                        pageBtn.style.backgroundColor = 'var(--background-secondary)';
                    });
                }
                
                pageBtn.addEventListener('click', () => {
                    this.currentPage = i;
                    this.onOpen();
                });
            }
        }
        
        const closeBtn = contentEl.createEl('button', { text: 'ë‹«ê¸°' });
        closeBtn.style.width = '100%';
        closeBtn.style.marginTop = '10px';
        closeBtn.style.padding = isMobile ? '12px' : '8px';
        closeBtn.style.backgroundColor = 'var(--interactive-accent)';
        closeBtn.style.color = 'var(--text-on-accent)';
        closeBtn.style.border = 'none';
        closeBtn.style.borderRadius = '6px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.style.fontSize = isMobile ? '1rem' : '0.95rem';
        closeBtn.style.minHeight = isMobile ? '48px' : '36px';
        closeBtn.addEventListener('click', () => this.close());
    }

    getRecentRecords() {
        const history = this.plugin.settings.stats?.studyHistory || [];
        
        const records = history.map(record => {
            const date = new Date(record.timestamp);
            const displayDate = date.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                weekday: 'short'
            });
            
            return {
                ...record,
                displayDate
            };
        });
        
        records.sort((a, b) => b.timestamp - a.timestamp);
        
        return records;
    }

    formatTime(seconds) {
        if (!seconds || seconds === 0) return '0ì´ˆ';
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return minutes > 0 ? `${minutes}ë¶„ ${secs}ì´ˆ` : `${secs}ì´ˆ`;
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ì„ íƒì§€ ë¶ë§ˆí¬ í€´ì¦ˆ ë¹Œë” ëª¨ë‹¬
class OptionBookmarkQuizBuilderModal extends Modal {
    constructor(app, plugin, bookmarkedOptions) {
        super(app);
        this.plugin = plugin;
        this.allOptions = bookmarkedOptions;
        this.selectedOptions = [...bookmarkedOptions]; // ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë‘ ì„ íƒ
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('option-quiz-builder-modal');

        // ëª¨ë°”ì¼ ê°ì§€
        const isMobile = this.app.isMobile || window.innerWidth <= 768;

        this.titleEl.setText('ğŸ¯ ì„ íƒì§€ í€´ì¦ˆ êµ¬ì„±');

        // ì„¤ëª…
        const descEl = contentEl.createDiv({ cls: 'builder-description' });
        descEl.style.cssText = `padding: ${isMobile ? '12px' : '16px'}; background: var(--background-secondary); border-radius: 8px; margin-bottom: ${isMobile ? '12px' : '16px'};`;
        descEl.createEl('p', { 
            text: `ì´ ${this.allOptions.length}ê°œì˜ ë¶ë§ˆí¬ëœ ì„ íƒì§€ê°€ ìˆìŠµë‹ˆë‹¤.`,
            cls: 'builder-desc-text'
        }).style.cssText = `margin-bottom: 8px; font-size: ${isMobile ? '15px' : '14px'};`;
        descEl.createEl('p', { 
            text: 'ì›í•˜ëŠ” ì„ íƒì§€ë¥¼ ì„ íƒí•˜ê³  ìˆœì„œë¥¼ ì¡°ì •í•˜ì„¸ìš”. (ìµœì†Œ 4ê°œ í•„ìš”)',
            cls: 'builder-desc-hint'
        }).style.cssText = `color: var(--text-muted); font-size: ${isMobile ? '13px' : '14px'};`;

        // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤
        const controlBar = contentEl.createDiv({ cls: 'builder-control-bar' });
        controlBar.style.cssText = `display: flex; gap: ${isMobile ? '6px' : '8px'}; margin-bottom: ${isMobile ? '12px' : '16px'}; flex-wrap: wrap;`;

        const btnStyle = `padding: ${isMobile ? '10px 14px' : '8px 16px'}; border: none; border-radius: 6px; cursor: pointer; font-size: ${isMobile ? '14px' : '13px'}; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0.1); min-height: ${isMobile ? '44px' : 'auto'};`;

        const selectAllBtn = controlBar.createEl('button', { text: 'âœ“ ì „ì²´' });
        selectAllBtn.style.cssText = btnStyle + 'background: var(--interactive-accent); color: var(--text-on-accent); flex: 1;';
        selectAllBtn.onclick = () => {
            this.selectedOptions = [...this.allOptions];
            this.render();
        };
        if (isMobile) {
            selectAllBtn.addEventListener('touchstart', () => { selectAllBtn.style.opacity = '0.7'; });
            selectAllBtn.addEventListener('touchend', () => { selectAllBtn.style.opacity = '1'; });
        }

        const deselectAllBtn = controlBar.createEl('button', { text: 'âœ• í•´ì œ' });
        deselectAllBtn.style.cssText = btnStyle + 'background: var(--background-secondary); border: 1px solid var(--background-modifier-border); flex: 1;';
        deselectAllBtn.onclick = () => {
            this.selectedOptions = [];
            this.render();
        };
        if (isMobile) {
            deselectAllBtn.addEventListener('touchstart', () => { deselectAllBtn.style.opacity = '0.7'; });
            deselectAllBtn.addEventListener('touchend', () => { deselectAllBtn.style.opacity = '1'; });
        }

        const shuffleBtn = controlBar.createEl('button', { text: 'ğŸ”€ ì„ê¸°' });
        shuffleBtn.style.cssText = btnStyle + 'background: var(--background-secondary); border: 1px solid var(--background-modifier-border); flex: 1;';
        shuffleBtn.onclick = () => {
            for (let i = this.selectedOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [this.selectedOptions[i], this.selectedOptions[j]] = [this.selectedOptions[j], this.selectedOptions[i]];
            }
            this.render();
        };
        if (isMobile) {
            shuffleBtn.addEventListener('touchstart', () => { shuffleBtn.style.opacity = '0.7'; });
            shuffleBtn.addEventListener('touchend', () => { shuffleBtn.style.opacity = '1'; });
        }

        const countBadge = controlBar.createEl('span', { text: `${this.selectedOptions.length}ê°œ` });
        countBadge.style.cssText = `padding: ${isMobile ? '10px 14px' : '8px 16px'}; background: var(--interactive-accent); color: var(--text-on-accent); border-radius: 6px; font-weight: 600; ${isMobile ? 'flex: 0 0 auto;' : 'margin-left: auto;'} display: flex; align-items: center; min-height: ${isMobile ? '44px' : 'auto'};`;
        this.countBadge = countBadge;
        this.isMobile = isMobile;

        // ì„ íƒì§€ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ
        const listContainer = contentEl.createDiv({ cls: 'options-list-container' });
        const maxHeight = isMobile ? '50vh' : '400px';
        listContainer.style.cssText = `max-height: ${maxHeight}; overflow-y: auto; overflow-x: hidden; border: 1px solid var(--background-modifier-border); border-radius: 8px; padding: ${isMobile ? '6px' : '8px'}; margin-bottom: ${isMobile ? '12px' : '16px'}; -webkit-overflow-scrolling: touch;`;
        this.listContainer = listContainer;

        // ì•¡ì…˜ ë²„íŠ¼ë“¤
        const actionBar = contentEl.createDiv({ cls: 'builder-action-bar' });
        actionBar.style.cssText = `display: flex; gap: ${isMobile ? '8px' : '8px'}; justify-content: ${isMobile ? 'stretch' : 'flex-end'}; ${isMobile ? 'flex-direction: column-reverse;' : ''}`;

        const startBtn = actionBar.createEl('button', { text: 'ğŸ® í€´ì¦ˆ ì‹œì‘', cls: 'mod-cta' });
        startBtn.style.cssText = `padding: ${isMobile ? '14px 20px' : '10px 20px'}; ${isMobile ? 'width: 100%;' : ''} min-height: ${isMobile ? '48px' : 'auto'}; font-size: ${isMobile ? '16px' : '14px'}; font-weight: 600; border-radius: 6px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0.1);`;
        startBtn.onclick = () => {
            if (this.selectedOptions.length < 4) {
                new Notice('âš ï¸ ìµœì†Œ 4ê°œ ì´ìƒì˜ ì„ íƒì§€ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }
            this.close();
            this.plugin.startOptionBookmarkQuizWithSelected(this.selectedOptions);
        };
        if (isMobile) {
            startBtn.addEventListener('touchstart', () => { startBtn.style.opacity = '0.8'; });
            startBtn.addEventListener('touchend', () => { startBtn.style.opacity = '1'; });
        }

        const cancelBtn = actionBar.createEl('button', { text: 'ì·¨ì†Œ' });
        cancelBtn.style.cssText = `padding: ${isMobile ? '14px 20px' : '10px 20px'}; ${isMobile ? 'width: 100%;' : ''} min-height: ${isMobile ? '48px' : 'auto'}; font-size: ${isMobile ? '16px' : '14px'}; border-radius: 6px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: rgba(0,0,0,0.1);`;
        cancelBtn.onclick = () => this.close();
        if (isMobile) {
            cancelBtn.addEventListener('touchstart', () => { cancelBtn.style.opacity = '0.7'; });
            cancelBtn.addEventListener('touchend', () => { cancelBtn.style.opacity = '1'; });
        }

        // ì´ˆê¸° ë Œë”ë§
        this.render();
    }

    render() {
        this.listContainer.empty();
        this.countBadge.textContent = `${this.selectedOptions.length}ê°œ`;
        
        const isMobile = this.isMobile;

        // ëª¨ë“  ì˜µì…˜ í‘œì‹œ
        this.allOptions.forEach((option, index) => {
            const optionEl = this.listContainer.createDiv({ cls: 'option-item' });
            
            const selectedIndex = this.selectedOptions.indexOf(option);
            const isSelected = selectedIndex !== -1;

            // ëª¨ë°”ì¼ê³¼ ë°ìŠ¤í¬í†±ì—ì„œ ë‹¤ë¥¸ ë ˆì´ì•„ì›ƒ
            if (isMobile) {
                optionEl.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    padding: 12px;
                    background: ${isSelected ? 'var(--background-primary)' : 'var(--background-secondary)'};
                    border: ${isSelected ? '2px solid var(--interactive-accent)' : '1px solid var(--background-modifier-border)'};
                    border-radius: 8px;
                    margin-bottom: 8px;
                    touch-action: manipulation;
                    user-select: none;
                    -webkit-tap-highlight-color: rgba(0,0,0,0.1);
                    min-height: 44px;
                `;
            } else {
                optionEl.style.cssText = `
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    padding: 12px;
                    background: ${isSelected ? 'var(--background-primary)' : 'var(--background-secondary)'};
                    border: ${isSelected ? '2px solid var(--interactive-accent)' : '1px solid var(--background-modifier-border)'};
                    border-radius: 6px;
                    margin-bottom: 8px;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
            }

            // ìƒë‹¨ í–‰ (ì²´í¬ë°•ìŠ¤ + ìˆœì„œ + ì´ë™ ë²„íŠ¼)
            const topRow = optionEl.createDiv({ cls: 'option-top-row' });
            topRow.style.cssText = `display: flex; align-items: center; gap: ${isMobile ? '10px' : '12px'}; ${isMobile ? 'width: 100%;' : ''}`;

            // ì²´í¬ë°•ìŠ¤
            const checkbox = topRow.createEl('input', { type: 'checkbox' });
            checkbox.checked = isSelected;
            checkbox.style.cssText = `width: ${isMobile ? '24px' : '20px'}; height: ${isMobile ? '24px' : '20px'}; cursor: pointer; flex-shrink: 0; touch-action: manipulation;`;
            checkbox.onclick = (e) => {
                e.stopPropagation();
                this.toggleOption(option);
            };

            // ìˆœì„œ ë²ˆí˜¸
            const orderEl = topRow.createEl('span', { 
                text: isSelected ? `${selectedIndex + 1}` : '-',
                cls: 'option-order'
            });
            orderEl.style.cssText = `min-width: ${isMobile ? '35px' : '30px'}; text-align: center; font-weight: 600; color: var(--interactive-accent); font-size: ${isMobile ? '18px' : '16px'}; flex-shrink: 0;`;

            if (!isMobile) {
                // ë°ìŠ¤í¬í†±: ì •ë³´ë¥¼ ê°™ì€ í–‰ì— í‘œì‹œ
                const infoEl = topRow.createDiv({ cls: 'option-info' });
                infoEl.style.cssText = 'flex: 1; min-width: 0;';

                const textEl = infoEl.createEl('div', { 
                    text: option.optionText,
                    cls: 'option-text'
                });
                textEl.style.cssText = 'font-weight: 500; margin-bottom: 4px; word-wrap: break-word;';

                const metaEl = infoEl.createEl('div', { cls: 'option-meta' });
                metaEl.style.cssText = 'font-size: 12px; color: var(--text-muted);';
                metaEl.innerHTML = `${option.question.hanzi} - ${option.folder} ${option.isCorrect ? '<span style="color: var(--color-green); font-weight: 600;">âœ“ ì •ë‹µ</span>' : ''}`;
            }

            // ìœ„/ì•„ë˜ ë²„íŠ¼ (ì„ íƒëœ ê²½ìš°ì—ë§Œ)
            if (isSelected) {
                const moveControls = topRow.createDiv({ cls: 'move-controls' });
                if (isMobile) {
                    moveControls.style.cssText = 'display: flex; gap: 6px; margin-left: auto; flex-shrink: 0;';
                } else {
                    moveControls.style.cssText = 'display: flex; flex-direction: column; gap: 4px; flex-shrink: 0;';
                }

                const buttonSize = isMobile ? '44px' : '28px';
                const fontSize = isMobile ? '16px' : '10px';

                const upBtn = moveControls.createEl('button', { text: 'â–²' });
                upBtn.style.cssText = `
                    ${isMobile ? `width: ${buttonSize}; height: ${buttonSize};` : `padding: 4px 8px;`}
                    background: var(--background-modifier-border);
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: ${fontSize};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    touch-action: manipulation;
                    user-select: none;
                    -webkit-tap-highlight-color: rgba(0,0,0,0.1);
                `;
                upBtn.disabled = selectedIndex === 0;
                if (upBtn.disabled) upBtn.style.opacity = '0.3';
                upBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (selectedIndex > 0) {
                        [this.selectedOptions[selectedIndex], this.selectedOptions[selectedIndex - 1]] = 
                        [this.selectedOptions[selectedIndex - 1], this.selectedOptions[selectedIndex]];
                        this.render();
                    }
                };
                if (isMobile && !upBtn.disabled) {
                    upBtn.addEventListener('touchstart', () => { upBtn.style.opacity = '0.6'; });
                    upBtn.addEventListener('touchend', () => { upBtn.style.opacity = '1'; });
                }

                const downBtn = moveControls.createEl('button', { text: 'â–¼' });
                downBtn.style.cssText = `
                    ${isMobile ? `width: ${buttonSize}; height: ${buttonSize};` : `padding: 4px 8px;`}
                    background: var(--background-modifier-border);
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: ${fontSize};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    touch-action: manipulation;
                    user-select: none;
                    -webkit-tap-highlight-color: rgba(0,0,0,0.1);
                `;
                downBtn.disabled = selectedIndex === this.selectedOptions.length - 1;
                if (downBtn.disabled) downBtn.style.opacity = '0.3';
                downBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (selectedIndex < this.selectedOptions.length - 1) {
                        [this.selectedOptions[selectedIndex], this.selectedOptions[selectedIndex + 1]] = 
                        [this.selectedOptions[selectedIndex + 1], this.selectedOptions[selectedIndex]];
                        this.render();
                    }
                };
                if (isMobile && !downBtn.disabled) {
                    downBtn.addEventListener('touchstart', () => { downBtn.style.opacity = '0.6'; });
                    downBtn.addEventListener('touchend', () => { downBtn.style.opacity = '1'; });
                }
            }

            // ëª¨ë°”ì¼: ì •ë³´ë¥¼ ë³„ë„ í–‰ì— í‘œì‹œ
            if (isMobile) {
                const infoEl = optionEl.createDiv({ cls: 'option-info' });
                infoEl.style.cssText = 'width: 100%;';

                const textEl = infoEl.createEl('div', { 
                    text: option.optionText,
                    cls: 'option-text'
                });
                textEl.style.cssText = 'font-weight: 500; margin-bottom: 6px; word-wrap: break-word; font-size: 15px; line-height: 1.4;';

                const metaEl = infoEl.createEl('div', { cls: 'option-meta' });
                metaEl.style.cssText = 'font-size: 13px; color: var(--text-muted); display: flex; flex-wrap: wrap; gap: 8px; align-items: center;';
                
                const hanziSpan = metaEl.createEl('span', { text: option.question.hanzi });
                hanziSpan.style.cssText = 'font-weight: 600;';
                
                const folderSpan = metaEl.createEl('span', { text: option.folder });
                folderSpan.style.cssText = 'padding: 2px 8px; background: var(--background-secondary); border-radius: 4px;';
                
                if (option.isCorrect) {
                    const correctSpan = metaEl.createEl('span', { text: 'âœ“ ì •ë‹µ' });
                    correctSpan.style.cssText = 'color: var(--color-green); font-weight: 600;';
                }
            }

            // ì „ì²´ í´ë¦­ìœ¼ë¡œ í† ê¸€ (ëª¨ë°”ì¼ì—ì„œë§Œ)
            if (isMobile) {
                optionEl.onclick = () => {
                    this.toggleOption(option);
                };
                
                // í„°ì¹˜ í”¼ë“œë°±
                optionEl.addEventListener('touchstart', () => {
                    optionEl.style.opacity = '0.7';
                });
                optionEl.addEventListener('touchend', () => {
                    optionEl.style.opacity = '1';
                });
                optionEl.addEventListener('touchcancel', () => {
                    optionEl.style.opacity = '1';
                });
            } else {
                // ë°ìŠ¤í¬í†±: í˜¸ë²„ íš¨ê³¼
                optionEl.onclick = () => {
                    this.toggleOption(option);
                };
                
                optionEl.addEventListener('mouseenter', () => {
                    if (!isSelected) {
                        optionEl.style.background = 'var(--background-modifier-hover)';
                    }
                });
                optionEl.addEventListener('mouseleave', () => {
                    if (!isSelected) {
                        optionEl.style.background = 'var(--background-secondary)';
                    }
                });
            }
        });
    }

    toggleOption(option) {
        const index = this.selectedOptions.indexOf(option);
        if (index !== -1) {
            this.selectedOptions.splice(index, 1);
        } else {
            this.selectedOptions.push(option);
        }
        this.render();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

class QuizPlayModal extends Modal {
    constructor(app, plugin, questions, wrongAnswersOnly = false, difficulty = null, allowShuffle = true) {
        super(app);
        this.plugin = plugin;
        this.allQuestions = questions;
        this.wrongAnswersOnly = wrongAnswersOnly;
        this.difficulty = difficulty;
        this.currentIndex = 0;
        this.score = 0;
        this.results = [];
        this.startTime = Date.now();
        this.timeRemaining = this.plugin.settings.timerPerQuestion;
        this.timerInterval = null;
        this.isPaused = false;
        this.pausedTime = 0;
        this.isExiting = false; // ë‚˜ê°€ê¸° ì¤‘ì¸ì§€ í™•ì¸

        // ë¬¸ì œ ì„ê¸° (allowShuffleì´ trueì´ê³  ì„¤ì •ì—ì„œ í™œì„±í™”ëœ ê²½ìš°ë§Œ)
        if (allowShuffle && this.plugin.settings.shuffleQuestions) {
            this.questions = this.shuffleArray([...this.allQuestions]);
        } else {
            this.questions = [...this.allQuestions];
        }
    }

    // ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ëŠ” ë©”ì„œë“œ
    appendLog(message) {
        if (!this.plugin.quizLogHistory) this.plugin.quizLogHistory = [];
        this.plugin.quizLogHistory.push({
            timestamp: new Date().toLocaleString(),
            message
        });
    }

    shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    showImageZoom(imageUrl, altText, imageUrls = null, currentIndex = 0) {
        // ì „ì²´ í™”ë©´ ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.body.createDiv({ cls: 'image-zoom-overlay' });
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
        overlay.style.zIndex = '10000';
        overlay.style.display = 'flex';
        overlay.style.flexDirection = 'column';
        overlay.style.justifyContent = 'center';
        overlay.style.alignItems = 'center';
        overlay.style.cursor = 'pointer';
        overlay.style.padding = '20px';
        overlay.style.boxSizing = 'border-box';
        overlay.style.overflow = 'auto';
        
        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ (í„°ì¹˜ ì´ë²¤íŠ¸ìš©)
        const imgContainer = overlay.createDiv({ cls: 'zoom-image-container' });
        imgContainer.style.position = 'relative';
        imgContainer.style.maxWidth = 'min(90vw, 800px)';
        imgContainer.style.maxHeight = '100%';
        imgContainer.style.width = 'auto';
        imgContainer.style.height = 'auto';
        imgContainer.style.display = 'flex';
        imgContainer.style.justifyContent = 'center';
        imgContainer.style.alignItems = 'center';
        imgContainer.style.touchAction = 'none';
        imgContainer.style.background = 'var(--background-primary)';
        imgContainer.style.borderRadius = '12px';
        imgContainer.style.padding = '15px';
        imgContainer.style.cursor = 'move';
        imgContainer.style.boxShadow = '0 10px 40px rgba(0, 0, 0, 0.3)';
        
        // í™•ëŒ€ëœ ì´ë¯¸ì§€
        const zoomedImg = imgContainer.createEl('img', {
            attr: {
                src: imageUrl,
                alt: altText
            }
        });
        zoomedImg.style.maxWidth = '100%';
        zoomedImg.style.maxHeight = '100%';
        zoomedImg.style.width = 'auto';
        zoomedImg.style.height = 'auto';
        zoomedImg.style.objectFit = 'contain';
        zoomedImg.style.borderRadius = '8px';
        zoomedImg.style.transition = 'transform 0.1s ease-out';
        zoomedImg.style.cursor = 'move';
        zoomedImg.style.userSelect = 'none';
        
        // í•€ì¹˜ ì¤Œ & ë“œë˜ê·¸ ë³€ìˆ˜
        let scale = 1;
        let posX = 0;
        let posY = 0;
        let lastPosX = 0;
        let lastPosY = 0;
        let isDragging = false;
        let startDistance = 0;
        let startScale = 1;
        
        // í„°ì¹˜ ì‹œì‘
        imgContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                // í•€ì¹˜ ì¤Œ ì‹œì‘
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                startDistance = Math.hypot(
                    touch1.clientX - touch2.clientX,
                    touch1.clientY - touch2.clientY
                );
                startScale = scale;
                e.preventDefault();
            } else if (e.touches.length === 1) {
                // ë“œë˜ê·¸ ì‹œì‘
                isDragging = true;
                lastPosX = e.touches[0].clientX - posX;
                lastPosY = e.touches[0].clientY - posY;
            }
        });
        
        // í„°ì¹˜ ì´ë™
        imgContainer.addEventListener('touchmove', (e) => {
            if (e.touches.length === 2) {
                // í•€ì¹˜ ì¤Œ
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const distance = Math.hypot(
                    touch1.clientX - touch2.clientX,
                    touch1.clientY - touch2.clientY
                );
                scale = Math.max(1, Math.min(4, startScale * (distance / startDistance)));
                zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
                e.preventDefault();
            } else if (e.touches.length === 1 && isDragging) {
                // ë“œë˜ê·¸
                posX = e.touches[0].clientX - lastPosX;
                posY = e.touches[0].clientY - lastPosY;
                zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
                e.preventDefault();
            }
        });
        
        // í„°ì¹˜ ì¢…ë£Œ
        imgContainer.addEventListener('touchend', (e) => {
            if (e.touches.length === 0) {
                isDragging = false;
            }
        });
        
        // ë§ˆìš°ìŠ¤ íœ  ì¤Œ (PC)
        imgContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale = Math.max(1, Math.min(4, scale * delta));
            zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        });
        
        // ë§ˆìš°ìŠ¤ ë“œë˜ê·¸ (PC)
        imgContainer.addEventListener('mousedown', (e) => {
            if (e.button === 0) { // ì™¼ìª½ í´ë¦­ë§Œ
                isDragging = true;
                lastPosX = e.clientX - posX;
                lastPosY = e.clientY - posY;
                imgContainer.style.cursor = 'grabbing';
                e.preventDefault();
            }
        });
        
        imgContainer.addEventListener('mousemove', (e) => {
            if (isDragging && scale > 1) {
                posX = e.clientX - lastPosX;
                posY = e.clientY - lastPosY;
                zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
                e.preventDefault();
            }
        });
        
        imgContainer.addEventListener('mouseup', () => {
            isDragging = false;
            imgContainer.style.cursor = 'move';
        });
        
        imgContainer.addEventListener('mouseleave', () => {
            isDragging = false;
            imgContainer.style.cursor = 'move';
        });
        
        // ë”ë¸”í´ë¦­ìœ¼ë¡œ ì¤Œ í† ê¸€ (PC & ëª¨ë°”ì¼)
        let lastTap = 0;
        const handleDoubleTap = () => {
            if (scale > 1) {
                // ì¤Œ ì•„ì›ƒ (ì›ë˜ëŒ€ë¡œ)
                scale = 1;
                posX = 0;
                posY = 0;
            } else {
                // ì¤Œ ì¸ (2ë°°)
                scale = 2;
            }
            zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        };
        
        zoomedImg.addEventListener('dblclick', handleDoubleTap);
        
        // ëª¨ë°”ì¼ ë”ë¸”íƒ­
        zoomedImg.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
                handleDoubleTap();
                e.preventDefault();
            }
            lastTap = currentTime;
        });
        
        // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ì´ë¯¸ì§€ê°€ ì—¬ëŸ¬ ê°œì¼ ë•Œ)
        let navControls = null;
        let updateImage = null;
        
        if (imageUrls && imageUrls.length > 1) {
            navControls = overlay.createDiv({ cls: 'zoom-nav-controls' });
            navControls.style.position = 'absolute';
            navControls.style.bottom = '80px';
            navControls.style.left = '50%';
            navControls.style.transform = 'translateX(-50%)';
            navControls.style.display = 'flex';
            navControls.style.gap = '15px';
            navControls.style.alignItems = 'center';
            navControls.style.zIndex = '10001';
            navControls.style.background = 'rgba(0, 0, 0, 0.8)';
            navControls.style.padding = '12px 20px';
            navControls.style.borderRadius = '30px';
            navControls.style.backdropFilter = 'blur(10px)';
            navControls.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.5)';

            const prevBtn = navControls.createEl('button', { text: 'â—€' });
            prevBtn.type = 'button';
            prevBtn.style.cssText = 'padding: 10px 16px; cursor: pointer; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; font-size: 16px; min-width: 45px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

            const pageInfo = navControls.createEl('span', { text: `${currentIndex + 1}/${imageUrls.length}` });
            pageInfo.style.cssText = 'color: white; font-weight: bold; min-width: 50px; text-align: center; font-size: 16px;';

            const nextBtn = navControls.createEl('button', { text: 'â–¶' });
            nextBtn.type = 'button';
            nextBtn.style.cssText = 'padding: 10px 16px; cursor: pointer; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; font-size: 16px; min-width: 45px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

            // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            updateImage = (newIndex) => {
                currentIndex = newIndex;
                zoomedImg.src = imageUrls[currentIndex];
                pageInfo.textContent = `${currentIndex + 1}/${imageUrls.length}`;
                
                // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                prevBtn.disabled = currentIndex === 0;
                nextBtn.disabled = currentIndex === imageUrls.length - 1;
                prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
                nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
                
                // ì¤Œ ë¦¬ì…‹
                scale = 1;
                posX = 0;
                posY = 0;
                zoomedImg.style.transform = 'translate(0, 0) scale(1)';
            };

            prevBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentIndex > 0) {
                    updateImage(currentIndex - 1);
                }
            };

            nextBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentIndex < imageUrls.length - 1) {
                    updateImage(currentIndex + 1);
                }
            };

            // í„°ì¹˜ í”¼ë“œë°±
            [prevBtn, nextBtn].forEach(btn => {
                btn.addEventListener('touchstart', () => btn.style.opacity = '0.7');
                btn.addEventListener('touchend', () => btn.style.opacity = btn.disabled ? '0.5' : '1');
                btn.addEventListener('touchcancel', () => btn.style.opacity = btn.disabled ? '0.5' : '1');
            });

            // ìŠ¤ì™€ì´í”„ ë„¤ë¹„ê²Œì´ì…˜ ì¶”ê°€
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;
            let isSwiping = false;
            
            overlay.addEventListener('touchstart', (e) => {
                // í•€ì¹˜ ì¤Œ ì¤‘ì´ë©´ ìŠ¤ì™€ì´í”„ ë¬´ì‹œ
                if (e.touches.length > 1) return;
                
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = false;
            }, { passive: true });
            
            overlay.addEventListener('touchmove', (e) => {
                if (e.touches.length > 1) return;
                
                const deltaX = Math.abs(e.touches[0].clientX - touchStartX);
                const deltaY = Math.abs(e.touches[0].clientY - touchStartY);
                
                // ìˆ˜í‰ ì´ë™ì´ ìˆ˜ì§ ì´ë™ë³´ë‹¤ í¬ë©´ ìŠ¤ì™€ì´í”„ë¡œ ê°„ì£¼
                if (deltaX > deltaY && deltaX > 10) {
                    isSwiping = true;
                }
            }, { passive: true });
            
            overlay.addEventListener('touchend', (e) => {
                if (e.touches.length > 0 || !isSwiping) return;
                
                touchEndX = e.changedTouches[0].clientX;
                touchEndY = e.changedTouches[0].clientY;
                
                const swipeThreshold = 50; // ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬
                const diffX = touchEndX - touchStartX;
                const diffY = Math.abs(e.changedTouches[0].clientY - touchStartY);
                
                // ìˆ˜ì§ ì´ë™ì´ ìˆ˜í‰ ì´ë™ë³´ë‹¤ ì‘ì„ ë•Œë§Œ ìŠ¤ì™€ì´í”„ ì¸ì‹
                if (Math.abs(diffX) > swipeThreshold && diffY < 100) {
                    if (diffX > 0) {
                        // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ â†’ ì´ì „ ì´ë¯¸ì§€
                        if (currentIndex > 0) {
                            updateImage(currentIndex - 1);
                        }
                    } else {
                        // ì™¼ìª½ ìŠ¤ì™€ì´í”„ â†’ ë‹¤ìŒ ì´ë¯¸ì§€
                        if (currentIndex < imageUrls.length - 1) {
                            updateImage(currentIndex + 1);
                        }
                    }
                }
                
                isSwiping = false;
            }, { passive: true });

            // ì´ˆê¸° ë²„íŠ¼ ìƒíƒœ
            updateImage(currentIndex);
        }
        
        // ë‹«ê¸° ë²„íŠ¼ - ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìœ„ ìš°ì¸¡ì— ë°°ì¹˜
        const closeBtn = overlay.createEl('button', {
            text: 'âœ•',
            cls: 'image-zoom-close'
        });
        closeBtn.style.position = 'absolute';
        closeBtn.style.bottom = '100px'; // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼(bottom: 30px) ìœ„ì— ë°°ì¹˜
        closeBtn.style.right = '20px';
        closeBtn.style.fontSize = '32px';
        closeBtn.style.color = 'white';
        closeBtn.style.background = 'rgba(0, 0, 0, 0.5)';
        closeBtn.style.border = 'none';
        closeBtn.style.borderRadius = '50%';
        closeBtn.style.width = '50px';
        closeBtn.style.height = '50px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.display = 'flex';
        closeBtn.style.alignItems = 'center';
        closeBtn.style.justifyContent = 'center';
        closeBtn.style.transition = 'background 0.2s';
        closeBtn.style.zIndex = '10001';
        
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        });
        
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'rgba(0, 0, 0, 0.5)';
        });
        
        // ì¤Œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ (ìµœìƒë‹¨ ìš°ì¸¡ì—ì„œ ì‚´ì§ ì•„ë˜)
        const zoomControls = overlay.createDiv({ cls: 'zoom-controls' });
        zoomControls.style.position = 'absolute';
        zoomControls.style.top = '80px'; // 20pxì—ì„œ 80pxë¡œ (60px ì•„ë˜ë¡œ)
        zoomControls.style.right = '20px';
        zoomControls.style.display = 'flex';
        zoomControls.style.flexDirection = 'column';
        zoomControls.style.gap = '10px';
        zoomControls.style.zIndex = '10001';
        
        const createZoomButton = (text, title) => {
            const btn = zoomControls.createEl('button', { text });
            btn.title = title;
            btn.style.cssText = `
                width: 45px;
                height: 45px;
                font-size: 24px;
                color: white;
                background: rgba(0, 0, 0, 0.5);
                border: none;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.2s;
            `;
            btn.addEventListener('mouseenter', () => {
                btn.style.background = 'rgba(255, 255, 255, 0.2)';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.background = 'rgba(0, 0, 0, 0.5)';
            });
            return btn;
        };
        
        const zoomInBtn = createZoomButton('+', 'í™•ëŒ€');
        const zoomOutBtn = createZoomButton('âˆ’', 'ì¶•ì†Œ');
        const resetBtn = createZoomButton('âŸ²', 'ì›ë˜ í¬ê¸°');
        
        zoomInBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            scale = Math.min(4, scale * 1.2);
            zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        });
        
        zoomOutBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            scale = Math.max(1, scale * 0.8);
            if (scale === 1) {
                posX = 0;
                posY = 0;
            }
            zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        });
        
        resetBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            scale = 1;
            posX = 0;
            posY = 0;
            zoomedImg.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        });
        
        // ë‹«ê¸° ì´ë²¤íŠ¸
        const closeOverlay = () => {
            overlay.remove();
            document.removeEventListener('keydown', handleKeydown);
        };
        
        closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            closeOverlay();
        });
        
        // ì˜¤ë²„ë ˆì´ ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆëŠ” ì œì™¸)
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeOverlay();
            }
        });
        
        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ í´ë¦­ ì‹œ ì „íŒŒ ì¤‘ì§€ (ë‹«íˆì§€ ì•Šë„ë¡)
        imgContainer.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ (ESC, ë°©í–¥í‚¤)
        const handleKeydown = (e) => {
            // ESC í‚¤ë¡œ ë‹«ê¸°
            if (e.key === 'Escape' || e.keyCode === 27) {
                e.stopPropagation();
                e.preventDefault();
                closeOverlay();
                return;
            }
            
            // ë°©í–¥í‚¤ ë„¤ë¹„ê²Œì´ì…˜ (ì´ë¯¸ì§€ê°€ ì—¬ëŸ¬ ê°œì¼ ë•Œë§Œ)
            if (imageUrls && imageUrls.length > 1 && updateImage) {
                // ì™¼ìª½ ë°©í–¥í‚¤ â†’ ì´ì „ ì´ë¯¸ì§€
                if ((e.key === 'ArrowLeft' || e.keyCode === 37) && currentIndex > 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    updateImage(currentIndex - 1);
                    return;
                }
                
                // ì˜¤ë¥¸ìª½ ë°©í–¥í‚¤ â†’ ë‹¤ìŒ ì´ë¯¸ì§€
                if ((e.key === 'ArrowRight' || e.keyCode === 39) && currentIndex < imageUrls.length - 1) {
                    e.preventDefault();
                    e.stopPropagation();
                    updateImage(currentIndex + 1);
                    return;
                }
            }
        };
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë“±ë¡ (capture phaseì—ì„œ ì²˜ë¦¬)
        document.addEventListener('keydown', handleKeydown, true);
    }

    async onOpen() {
        // ESC í‚¤ ê¸°ë³¸ ë™ì‘ì„ ë§‰ê³  confirmExitë§Œ í˜¸ì¶œ
        const originalClose = this.close.bind(this);
        this.close = () => {
            // ëª…ì‹œì ìœ¼ë¡œ close()ê°€ í˜¸ì¶œëœ ê²½ìš°ì—ë§Œ ì‹¤ì œë¡œ ë‹«ê¸°
            if (this.isExiting) {
                originalClose();
            }
        };
        
        // ESC í‚¤ ë¦¬ìŠ¤ë„ˆ
        this.scope.register([], 'Escape', (evt) => {
            evt.preventDefault();
            evt.stopPropagation();
            this.confirmExit();
            return false;
        });
        
        const { contentEl } = this;
        contentEl.addClass('quiz-play-modal');
        
        // Flexbox ë ˆì´ì•„ì›ƒ ì ìš© (ì•¡ì…˜ ë²„íŠ¼ì´ í•˜ë‹¨ì— ê³ ì •ë˜ë„ë¡)
        contentEl.style.cssText = `
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        `;

        this.showQuestion();
        this.addStyles();
    }

    async reloadCurrentQuestion(filePath = null) {
        // í˜„ì¬ ë¬¸ì œì˜ íŒŒì¼ ë‹¤ì‹œ ì½ê¸°
        const currentQuestion = this.questions[this.currentIndex];
        console.log('ğŸ” [reloadCurrentQuestion] ì‹œì‘ - currentIndex:', this.currentIndex, 'filePath ë§¤ê°œë³€ìˆ˜:', filePath);
        
        // filePathê°€ ì œê³µë˜ë©´ í•´ë‹¹ íŒŒì¼ ê²½ë¡œ ì‚¬ìš©, ì•„ë‹ˆë©´ currentQuestionì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const targetPath = filePath || (currentQuestion && currentQuestion.filePath);
        
        if (!targetPath) {
            console.warn('âš ï¸ [reloadCurrentQuestion] íŒŒì¼ ê²½ë¡œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
            return;
        }

        console.log('ğŸ“ [reloadCurrentQuestion] íŒŒì¼ ê²½ë¡œ:', targetPath);
        
        // currentQuestionì´ ì—†ìœ¼ë©´ íŒŒì‹±í•œ ë°ì´í„°ë¥¼ ì„ì‹œë¡œ ì €ì¥í•  ê°ì²´ ìƒì„±
        const questionData = currentQuestion || { filePath: targetPath };
        
        try {
            const file = this.app.vault.getAbstractFileByPath(targetPath);
            if (file instanceof TFile) {
                console.log('ğŸ“– [reloadCurrentQuestion] íŒŒì¼ ì½ê¸° ì‹œì‘');
                const content = await this.app.vault.read(file);
                console.log('ğŸ“– [reloadCurrentQuestion] íŒŒì¼ ì½ê¸° ì™„ë£Œ, ê¸¸ì´:', content.length);
                
                // frontmatter íŒŒì‹±
                const frontmatterRegex = /^---\n([\s\S]*?)\n---/;
                const match = content.match(frontmatterRegex);
                
                if (match) {
                    const frontmatter = match[1];
                    console.log('ğŸ” [reloadCurrentQuestion] frontmatter ì²« 500ì:', frontmatter.substring(0, 500));
                    
                    // note í•„ë“œ íŒŒì‹± (ë©€í‹°ë¼ì¸ ì§€ì›)
                    const noteMatch = frontmatter.match(/note:\s*\|-?\s*\n((?:[ \t]+.*\n?)*)/);
                    if (noteMatch) {
                        console.log('âœ… [reloadCurrentQuestion] ë©€í‹°ë¼ì¸ note ë§¤ì¹­ ì„±ê³µ');
                        // ë“¤ì—¬ì“°ê¸° ì œê±°í•˜ê³  ë‚´ìš© ì¶”ì¶œ
                        const noteLines = noteMatch[1].split('\n')
                            .map(line => line.replace(/^[ \t]+/, ''))
                            .filter(line => line.trim())
                            .join('\n');
                        questionData.note = noteLines;
                        console.log(`ğŸ”„ [reloadCurrentQuestion] note ì—…ë°ì´íŠ¸: ${noteLines.substring(0, 100)}...`);
                    } else {
                        console.log('âš ï¸ [reloadCurrentQuestion] ë©€í‹°ë¼ì¸ note ë§¤ì¹­ ì‹¤íŒ¨, ë‹¨ì¼ ë¼ì¸ ì‹œë„');
                        // ë‹¨ì¼ ë¼ì¸ note
                        const singleLineMatch = frontmatter.match(/note:\s*(.+)/);
                        if (singleLineMatch) {
                            questionData.note = singleLineMatch[1].trim();
                            console.log(`ğŸ”„ [reloadCurrentQuestion] note ì—…ë°ì´íŠ¸ (ë‹¨ì¼): ${questionData.note.substring(0, 100)}...`);
                        } else {
                            console.warn('âŒ [reloadCurrentQuestion] note í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                        }
                    }
                    
                    const lines = frontmatter.split('\n');
                    
                    // ë¬¸ì œ ë°ì´í„° ì—…ë°ì´íŠ¸
                    for (const line of lines) {
                        if (line.startsWith('question:')) {
                            questionData.question = line.substring('question:'.length).trim();
                        } else if (line.startsWith('options:')) {
                            const optionsMatch = frontmatter.match(/options:\s*\[(.*?)\]/s);
                            if (optionsMatch) {
                                questionData.options = optionsMatch[1].split(',').map(opt => opt.trim().replace(/['"]/g, ''));
                            }
                        } else if (line.startsWith('optionImages:')) {
                            const imagesMatch = frontmatter.match(/optionImages:\s*\[(.*?)\]/s);
                            if (imagesMatch) {
                                questionData.optionImages = imagesMatch[1].split(',').map(img => img.trim().replace(/['"]/g, ''));
                            }
                        } else if (line.startsWith('noteImage:')) {
                            questionData.noteImage = line.substring('noteImage:'.length).trim();
                        }
                    }
                }
                
                // í™”ë©´ ìƒˆë¡œê³ ì¹¨ - í˜„ì¬ í™”ë©´ ìƒíƒœë¥¼ ê°ì§€í•˜ì—¬ ì ì ˆí•˜ê²Œ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                const { contentEl } = this;
                
                // í˜„ì¬ ì •ë‹µ í™•ì¸ í›„ í™”ë©´(feedback)ì¸ì§€ í™•ì¸
                const feedbackEl = contentEl.querySelector('.feedback-container, .quiz-feedback');
                
                if (feedbackEl) {
                    // ì •ë‹µ í™•ì¸ í›„ í™”ë©´ â†’ ë…¸íŠ¸ ì„¹ì…˜ë§Œ ì—…ë°ì´íŠ¸
                    console.log('ğŸ”„ [ë…¸íŠ¸ ìƒˆë¡œê³ ì¹¨] ì •ë‹µ í™•ì¸ í›„ í™”ë©´ì˜ ë…¸íŠ¸ ì„¹ì…˜ ì—…ë°ì´íŠ¸');
                    
                    // ê¸°ì¡´ ë…¸íŠ¸ ì„¹ì…˜ ì°¾ê¸°
                    const noteSection = contentEl.querySelector('.note-section');
                    if (noteSection) {
                        // ë…¸íŠ¸ ì„¹ì…˜ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                        noteSection.empty();
                        
                        // ë…¸íŠ¸ ì œëª©
                        const noteTitle = noteSection.createEl('div', {
                            text: 'ğŸ“ ë…¸íŠ¸',
                            cls: 'note-title'
                        });
                        noteTitle.style.cssText = `
                            font-size: 20px;
                            font-weight: bold;
                            color: #333;
                            margin-bottom: 15px;
                            padding: 10px 0;
                            border-bottom: 2px solid #4CAF50;
                        `;

                        // ë…¸íŠ¸ ì´ë¯¸ì§€ í‘œì‹œ
                        if (questionData.note) {
                            const imageLinks = questionData.note.split('\n').filter(line => line.trim().startsWith('![['));
                            
                            if (imageLinks.length > 0) {
                                const imageContainer = noteSection.createEl('div', { cls: 'note-images' });
                                imageContainer.style.cssText = `
                                    display: flex;
                                    flex-direction: column;
                                    gap: 15px;
                                    margin-top: 15px;
                                `;

                                const quizFolder = this.plugin?.settings?.quizFolder || 'HanziQuiz';
                                const vault = this.app.vault;
                                const parentPath = file.parent.path;

                                for (const link of imageLinks) {
                                    const imageMatch = link.match(/!\[\[([^\]|]+)(?:\|(\d+))?\]\]/);
                                    if (!imageMatch) continue;

                                    const imagePath = imageMatch[1].trim();
                                    const imageSize = imageMatch[2] || '400';

                                    // ì´ì¤‘ ê²½ë¡œ ì²´í¬
                                    let imagePath1 = `${parentPath}/${imagePath}`;
                                    let imagePath2 = `${quizFolder}/${imagePath}`;
                                    
                                    let imageFile = vault.getAbstractFileByPath(imagePath1);
                                    if (!imageFile) {
                                        imageFile = vault.getAbstractFileByPath(imagePath2);
                                        console.log(`ğŸ–¼ï¸ [ë…¸íŠ¸ ìƒˆë¡œê³ ì¹¨-ì´ë¯¸ì§€] ${imagePath} â†’ ${imagePath2}`);
                                    } else {
                                        console.log(`ğŸ–¼ï¸ [ë…¸íŠ¸ ìƒˆë¡œê³ ì¹¨-ì´ë¯¸ì§€] ${imagePath} â†’ ${imagePath1}`);
                                    }

                                    if (imageFile instanceof TFile) {
                                        const img = imageContainer.createEl('img', {
                                            attr: {
                                                src: this.app.vault.adapter.getResourcePath(imageFile.path),
                                                alt: imagePath
                                            }
                                        });
                                        img.style.cssText = `
                                            max-width: ${imageSize}px;
                                            height: auto;
                                            border-radius: 8px;
                                            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                                        `;
                                        console.log(`âœ… [ë…¸íŠ¸ ìƒˆë¡œê³ ì¹¨-ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ] ${imageFile.path}`);
                                    } else {
                                        console.warn(`âŒ [ë…¸íŠ¸ ìƒˆë¡œê³ ì¹¨-ì´ë¯¸ì§€ ì—†ìŒ] ${imagePath}`);
                                    }
                                }
                            }
                        }
                        
                        console.log('âœ… [ë…¸íŠ¸ ìƒˆë¡œê³ ì¹¨] ë…¸íŠ¸ ì„¹ì…˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                    }
                } else {
                    // ë¬¸ì œ í™”ë©´ â†’ ì „ì²´ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    console.log('ğŸ”„ [ë…¸íŠ¸ ìƒˆë¡œê³ ì¹¨] ë¬¸ì œ í™”ë©´ ì „ì²´ ìƒˆë¡œê³ ì¹¨');
                    this.showQuestion();
                }
                
                // ì»¤ìŠ¤í…€ ì´ë²¤íŠ¸ ë°œìƒ - ë¬¸ì œ í¸ì§‘ ëª¨ë‹¬ì— ì•Œë¦¼
                window.dispatchEvent(new CustomEvent('quiz-question-updated', {
                    detail: { 
                        questionPath: targetPath,
                        questionData: questionData
                    }
                }));
                console.log('ğŸ“¢ [ì´ë²¤íŠ¸ ë°œìƒ] quiz-question-updated, note ê¸¸ì´:', questionData.note ? questionData.note.length : 0);
            }
        } catch (error) {
            console.error('ë¬¸ì œ ìƒˆë¡œê³ ì¹¨ ì˜¤ë¥˜:', error);
        }
    }

    showQuestion() {
        const { contentEl } = this;
        contentEl.empty();

        // ëª¨ë°”ì¼ ì—¬ë¶€ í™•ì¸ (showQuestion ì‹œì‘ ì‹œ í•œ ë²ˆë§Œ ì •ì˜)
        const isMobile = this.app.isMobile || window.innerWidth <= 768;

        if (!this.questions || this.questions.length === 0) {
            contentEl.createEl('h2', { text: 'âŒ ì˜¤ë¥˜: ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤' });
            return;
        }

        if (this.currentIndex >= this.questions.length) {
            this.showResults();
            return;
        }

        const question = this.questions[this.currentIndex];

        // í„°ì¹˜ ìŠ¤ì™€ì´í”„ ì§€ì› ì¶”ê°€
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartTarget = null;
        
        const handleSwipe = () => {
            // ì´ë¯¸ì§€ë‚˜ ë²„íŠ¼ì„ í„°ì¹˜í•œ ê²½ìš° ìŠ¤ì™€ì´í”„ ë¬´ì‹œ
            if (touchStartTarget && (
                touchStartTarget.tagName === 'IMG' || 
                touchStartTarget.tagName === 'BUTTON' ||
                touchStartTarget.closest('.quiz-note-section') ||
                touchStartTarget.closest('.option-button') ||
                touchStartTarget.closest('.image-zoom-overlay')
            )) {
                return;
            }
            
            const swipeThreshold = 50; // ìµœì†Œ ìŠ¤ì™€ì´í”„ ê±°ë¦¬ (í”½ì…€)
            const diffX = touchEndX - touchStartX;
            
            if (Math.abs(diffX) > swipeThreshold) {
                if (diffX > 0) {
                    // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ -> ì´ì „ ë¬¸ì œ
                    if (this.currentIndex > 0) {
                        this.stopTimer();
                        this.currentIndex--;
                        this.showQuestion();
                    }
                } else {
                    // ì™¼ìª½ ìŠ¤ì™€ì´í”„ -> ë‹¤ìŒ ë¬¸ì œ
                    if (this.currentIndex < this.questions.length - 1) {
                        this.stopTimer();
                        this.currentIndex++;
                        this.showQuestion();
                    }
                }
            }
        };
        
        contentEl.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartTarget = e.target;
        }, { passive: true });
        
        contentEl.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì¼ì‹œì •ì§€, ë°©í–¥í‚¤ë¡œ ë¬¸ì œ ì´ë™)
        const handleKeyPress = (e) => {
            // ì…ë ¥ í•„ë“œë‚˜ textareaì—ì„œ í‚¤ë¥¼ ëˆ„ë¥¸ ê²½ìš° ë¬´ì‹œ
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // ìŠ¤í˜ì´ìŠ¤ë°” (ì½”ë“œ 32 ë˜ëŠ” ' ')
            if (e.code === 'Space' || e.key === ' ' || e.keyCode === 32) {
                e.preventDefault(); // ìŠ¤í¬ë¡¤ ë°©ì§€
                this.togglePause();
                
                // ì¼ì‹œì •ì§€ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                if (this.pauseButton) {
                    this.pauseButton.setText(this.isPaused ? 'â–¶ï¸' : 'â¸ï¸');
                    this.pauseButton.title = this.isPaused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
                }
            }
            
            // ì™¼ìª½ ë°©í–¥í‚¤ - ì´ì „ ë¬¸ì œ
            if (e.code === 'ArrowLeft' || e.key === 'ArrowLeft' || e.keyCode === 37) {
                if (this.currentIndex > 0) {
                    e.preventDefault();
                    this.stopTimer();
                    this.currentIndex--;
                    this.showQuestion();
                }
            }
            
            // ì˜¤ë¥¸ìª½ ë°©í–¥í‚¤ - ë‹¤ìŒ ë¬¸ì œ
            if (e.code === 'ArrowRight' || e.key === 'ArrowRight' || e.keyCode === 39) {
                if (this.currentIndex < this.questions.length - 1) {
                    e.preventDefault();
                    this.stopTimer();
                    this.currentIndex++;
                    this.showQuestion();
                }
            }
        };
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë“±ë¡
        document.addEventListener('keydown', handleKeyPress);
        
        // ëª¨ë‹¬ì´ ë‹«í ë•Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ì €ì¥
        if (!this.keyboardHandlers) {
            this.keyboardHandlers = [];
        }
        this.keyboardHandlers.push(handleKeyPress);

        // í—¤ë”
        const header = contentEl.createDiv({ cls: 'quiz-header' });
        
        // ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°”
        const controlBar = header.createDiv({ cls: 'quiz-control-bar' });
        
        // ë¦¬ë³¸ ë©”ë‰´ ë²„íŠ¼ (ë§¨ ì•)
        const ribbonBtn = controlBar.createEl('button', {
            text: 'â‰¡',
            cls: 'control-button ribbon-button'
        });
        ribbonBtn.title = 'ë©”ë‰´';
        ribbonBtn.style.fontSize = isMobile ? '14px' : '20px';
        ribbonBtn.onclick = (e) => {
            const menu = new Menu();
            
            // ì„¤ì •ì—ì„œ í™œì„±í™”ëœ ë©”ë‰´ í•­ëª©ë§Œ í‘œì‹œ
            const menuItems = this.plugin.settings.ribbonMenuItems || [];
            let hasSeparator = false;
            
            for (const menuItem of menuItems) {
                if (!menuItem.enabled) continue;
                
                // editë‚˜ delete í•­ëª© ì „ì— êµ¬ë¶„ì„  ì¶”ê°€
                if (!hasSeparator && (menuItem.id === 'edit' || menuItem.id === 'delete')) {
                    menu.addSeparator();
                    hasSeparator = true;
                }
                
                menu.addItem((item) => {
                    let title = menuItem.title;
                    
                    // ë‚œì´ë„ ì„¤ì •ì˜ ê²½ìš° í˜„ì¬ ë‚œì´ë„ í‘œì‹œ
                    if (menuItem.action === 'difficulty') {
                        const currentDiff = question.difficulty || 'C';
                        title = `ğŸ¯ ë‚œì´ë„ ì„¤ì • (${currentDiff})`;
                    }
                    
                    // ë¶ë§ˆí¬ì˜ ê²½ìš° í˜„ì¬ ìƒíƒœ í‘œì‹œ
                    if (menuItem.action === 'bookmark') {
                        title = question.bookmarkFolder ? `â­ ë¶ë§ˆí¬ë¨ [${question.bookmarkFolder}]` : 'â˜† ë¶ë§ˆí¬';
                    }
                    
                    item.setTitle(title)
                        .setIcon(menuItem.icon);
                    
                    // ê° ì•¡ì…˜ë³„ ì²˜ë¦¬
                    switch (menuItem.action) {
                        case 'dashboard':
                            item.onClick(() => {
                                this.stopTimer();
                                this.close();
                                new DashboardModal(this.app, this.plugin).open();
                            });
                            break;
                            
                        case 'difficulty':
                            item.onClick(() => {
                                new QuizQuestionSettingsModal(this.app, this.plugin, question, (updatedQuestion) => {
                                    Object.assign(question, updatedQuestion);
                                    this.showQuestion();
                                }).open();
                            });
                            break;
                            
                        case 'timer':
                            item.onClick(() => {
                                this.openSettings();
                            });
                            break;
                            
                        case 'bookmark':
                            item.onClick(async () => {
                                // í˜„ì¬ ë¶ë§ˆí¬ ìƒíƒœ í™•ì¸
                                const isCurrentlyBookmarked = question.bookmarkFolder && question.bookmarkFolder.length > 0;
                                
                                if (isCurrentlyBookmarked) {
                                    // ì´ë¯¸ ë¶ë§ˆí¬ëœ ê²½ìš° ì œê±° í™•ì¸
                                    const confirmModal = new Modal(this.app);
                                    confirmModal.titleEl.setText('ë¶ë§ˆí¬ ì œê±°');
                                    confirmModal.contentEl.style.cssText = 'padding: 20px;';
                                    
                                    confirmModal.contentEl.createEl('p').innerHTML = `"<strong>${question.bookmarkFolder}</strong>" í´ë”ì—ì„œ ë¶ë§ˆí¬ë¥¼ ì œê±°í• ê¹Œìš”?`;
                                    
                                    const buttonDiv = confirmModal.contentEl.createDiv();
                                    buttonDiv.style.cssText = 'display: flex; gap: 10px; margin-top: 20px;';
                                    
                                    const cancelBtn = buttonDiv.createEl('button', { text: 'ì·¨ì†Œ' });
                                    cancelBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; min-height: 44px;';
                                    cancelBtn.onclick = () => confirmModal.close();
                                    
                                    const removeBtn = buttonDiv.createEl('button', { text: 'ì œê±°' });
                                    removeBtn.style.cssText = 'flex: 1; padding: 10px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: 500; min-height: 44px;';
                                    removeBtn.onclick = async () => {
                                        question.bookmarkFolder = '';
                                        await this.plugin.saveQuestion(question, false);
                                        await this.plugin.updateBookmarkListTemplate();
                                        this.showQuestion();
                                        confirmModal.close();
                                    };
                                    
                                    confirmModal.open();
                                } else {
                                    // í˜„ì¬ í´ë”ì˜ ì„¤ì •ëœ ë¶ë§ˆí¬ í´ë” í™•ì¸
                                    const folderBookmarkSettings = this.plugin.settings.folderBookmarkSettings || {};
                                    const currentFolder = question.folder || 'ê¸°ë³¸';
                                    const bookmarkFolder = folderBookmarkSettings[currentFolder] || currentFolder;
                                    
                                    // ê°œë³„ ë¶ë§ˆí¬ ì„¤ì • (ì¡°ìš©íˆ ì €ì¥)
                                    question.bookmarkFolder = bookmarkFolder;
                                    await this.plugin.saveQuestion(question, false);
                                    await this.plugin.updateBookmarkListTemplate();
                                    this.showQuestion();
                                }
                            });
                            break;
                            
                        case 'folder':
                            item.onClick(() => {
                                this.stopTimer();
                                this.close();
                                new FolderManagementModal(this.app, this.plugin).open();
                            });
                            break;
                            
                        case 'audio-list':
                            item.onClick(() => {
                                this.stopTimer();
                                this.isPaused = true;
                                new AudioListManagementModal(this.app, this.plugin, this).open();
                            });
                            break;
                            
                        case 'prev':
                            item.onClick(() => {
                                if (this.currentIndex > 0) {
                                    this.stopTimer();
                                    this.currentIndex--;
                                    this.showQuestion();
                                } else {
                                    new Notice('ì²« ë²ˆì§¸ ë¬¸ì œì…ë‹ˆë‹¤');
                                }
                            });
                            break;
                            
                        case 'next':
                            item.onClick(() => {
                                if (this.currentIndex < this.questions.length - 1) {
                                    this.stopTimer();
                                    this.currentIndex++;
                                    this.showQuestion();
                                } else {
                                    new Notice('ë§ˆì§€ë§‰ ë¬¸ì œì…ë‹ˆë‹¤');
                                }
                            });
                            break;
                            
                        case 'pause':
                            item.onClick(() => {
                                if (this.isPaused) {
                                    this.isPaused = false;
                                    this.startTimer();
                                    new Notice('â–¶ï¸ íƒ€ì´ë¨¸ ì¬ê°œ');
                                } else {
                                    this.isPaused = true;
                                    this.stopTimer();
                                    new Notice('â¸ï¸ íƒ€ì´ë¨¸ ì¼ì‹œì •ì§€');
                                }
                                this.showQuestion(); // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                            });
                            break;
                            
                        case 'create-question':
                            item.onClick(() => {
                                this.stopTimer();
                                new HanziQuestionModal(this.app, this.plugin).open();
                            });
                            break;
                            
                        case 'wrong-answer':
                            item.onClick(() => {
                                this.stopTimer();
                                this.close();
                                this.plugin.startWrongAnswerQuiz();
                            });
                            break;
                            
                        case 'bookmark-quiz':
                            item.onClick(() => {
                                this.stopTimer();
                                this.close();
                                this.plugin.startBookmarkQuiz();
                            });
                            break;
                            
                        case 'question-list':
                            item.onClick(() => {
                                this.stopTimer();
                                this.close();
                                new QuestionDashboardModal(this.app, this.plugin).open();
                            });
                            break;
                            
                        case 'record-management':
                            item.onClick(() => {
                                this.stopTimer();
                                new QuizDetailRecordModal(this.app, this.plugin, { 
                                    correct: 0, 
                                    incorrect: 0, 
                                    total: 0, 
                                    percentage: 0, 
                                    time: 0, 
                                    details: [] 
                                }).open();
                            });
                            break;
                            
                        case 'statistics':
                            item.onClick(() => {
                                this.stopTimer();
                                this.close();
                                this.plugin.viewStatistics();
                            });
                            break;
                            
                        case 'clear-records':
                            item.onClick(() => {
                                const confirmModal = new Modal(this.app);
                                confirmModal.titleEl.setText('âš ï¸ ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”');
                                
                                const { contentEl } = confirmModal;
                                contentEl.style.padding = '20px';
                                
                                contentEl.createEl('p', { 
                                    text: 'ì •ë§ë¡œ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                                    cls: 'clear-confirm-message'
                                }).style.cssText = 'margin-bottom: 10px; font-size: 14px; color: var(--text-error);';
                                
                                contentEl.createEl('p', {
                                    text: 'ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                                    cls: 'clear-warning'
                                }).style.cssText = 'margin-bottom: 20px; font-size: 13px; color: var(--text-muted);';
                                
                                const btnContainer = contentEl.createDiv({ cls: 'clear-button-container' });
                                btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
                                
                                const cancelBtn = btnContainer.createEl('button', {
                                    text: 'ì·¨ì†Œ',
                                    cls: 'mod-cta'
                                });
                                cancelBtn.style.cssText = 'padding: 8px 16px;';
                                cancelBtn.onclick = () => {
                                    confirmModal.close();
                                };
                                
                                const confirmClearBtn = btnContainer.createEl('button', {
                                    text: 'ì´ˆê¸°í™”',
                                });
                                confirmClearBtn.style.cssText = 'padding: 8px 16px; background: var(--background-modifier-error); color: var(--text-on-accent);';
                                confirmClearBtn.onclick = async () => {
                                    // ê¸°ë¡ ì´ˆê¸°í™”
                                    this.plugin.quizLogHistory = [];
                                    this.plugin.settings.stats = {
                                        totalAttempts: 0,
                                        totalCorrect: 0,
                                        totalWrong: 0,
                                        totalQuestions: 0,
                                        bookmarkedCount: 0,
                                        lastStudyDate: null,
                                        studyHistory: []
                                    };
                                    await this.plugin.saveSettings();
                                    
                                    confirmModal.close();
                                    new Notice('âœ… ëª¨ë“  í•™ìŠµ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
                                };
                                
                                confirmModal.open();
                            });
                            break;
                            
                        case 'clear-folder-records':
                            item.onClick(() => {
                                // í´ë” ì„ íƒ ëª¨ë‹¬
                                const folderModal = new Modal(this.app);
                                folderModal.titleEl.setText('ğŸ“ í´ë”ë³„ ê¸°ë¡ ì´ˆê¸°í™”');
                                
                                const { contentEl } = folderModal;
                                contentEl.style.padding = '20px';
                                
                                contentEl.createEl('p', { 
                                    text: 'ê¸°ë¡ì„ ì´ˆê¸°í™”í•  í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”:',
                                    cls: 'folder-select-desc'
                                }).style.cssText = 'margin-bottom: 15px; font-size: 14px;';
                                
                                const folderList = contentEl.createDiv({ cls: 'folder-list' });
                                folderList.style.cssText = 'display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;';
                                
                                const folders = this.plugin.settings.questionFolders || [];
                                
                                folders.forEach(folder => {
                                    const folderBtn = folderList.createEl('button', {
                                        text: `ğŸ“ ${folder}`,
                                        cls: 'folder-select-btn'
                                    });
                                    folderBtn.style.cssText = 'padding: 12px; text-align: left; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-primary); cursor: pointer; transition: background 0.2s;';
                                    
                                    folderBtn.onmouseenter = () => {
                                        folderBtn.style.background = 'var(--background-secondary)';
                                    };
                                    folderBtn.onmouseleave = () => {
                                        folderBtn.style.background = 'var(--background-primary)';
                                    };
                                    
                                    folderBtn.onclick = () => {
                                        folderModal.close();
                                        
                                        // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸
                                        const confirmModal = new Modal(this.app);
                                        confirmModal.titleEl.setText('âš ï¸ í´ë” ê¸°ë¡ ì´ˆê¸°í™”');
                                        
                                        const { contentEl: confirmContent } = confirmModal;
                                        confirmContent.style.padding = '20px';
                                        
                                        confirmContent.createEl('p', { 
                                            text: `"${folder}" í´ë”ì˜ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                                            cls: 'clear-confirm-message'
                                        }).style.cssText = 'margin-bottom: 10px; font-size: 14px; color: var(--text-error);';
                                        
                                        confirmContent.createEl('p', {
                                            text: 'ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                                            cls: 'clear-warning'
                                        }).style.cssText = 'margin-bottom: 20px; font-size: 13px; color: var(--text-muted);';
                                        
                                        const btnContainer = confirmContent.createDiv({ cls: 'clear-button-container' });
                                        btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
                                        
                                        const cancelBtn = btnContainer.createEl('button', {
                                            text: 'ì·¨ì†Œ',
                                            cls: 'mod-cta'
                                        });
                                        cancelBtn.style.cssText = 'padding: 8px 16px;';
                                        cancelBtn.onclick = () => {
                                            confirmModal.close();
                                        };
                                        
                                        const confirmClearBtn = btnContainer.createEl('button', {
                                            text: 'ì´ˆê¸°í™”',
                                        });
                                        confirmClearBtn.style.cssText = 'padding: 8px 16px; background: var(--background-modifier-error); color: var(--text-on-accent);';
                                        confirmClearBtn.onclick = async () => {
                                            // í•´ë‹¹ í´ë”ì˜ ê¸°ë¡ë§Œ ì‚­ì œ
                                            const folderPath = `${this.plugin.settings.questionsFolder}/${folder}`;
                                            
                                            // ë¡œê·¸ íˆìŠ¤í† ë¦¬ì—ì„œ í•´ë‹¹ í´ë” í•­ëª© ì œê±°
                                            this.plugin.quizLogHistory = this.plugin.quizLogHistory.filter(log => {
                                                return !log.details || !log.details.some(detail => 
                                                    detail.filePath && detail.filePath.startsWith(folderPath)
                                                );
                                            });
                                            
                                            // í†µê³„ì—ì„œ í•´ë‹¹ í´ë” ë¬¸ì œë“¤ì˜ ê¸°ë¡ ì¬ê³„ì‚°
                                            // (ì „ì²´ ì´ˆê¸°í™” ëŒ€ì‹  í•´ë‹¹ í´ë”ë§Œ ì œì™¸í•˜ê³  ì¬ê³„ì‚°)
                                            let totalCorrect = 0;
                                            let totalWrong = 0;
                                            let totalAttempts = 0;
                                            
                                            this.plugin.quizLogHistory.forEach(log => {
                                                if (log.details) {
                                                    log.details.forEach(detail => {
                                                        if (detail.correct) totalCorrect++;
                                                        else totalWrong++;
                                                        totalAttempts++;
                                                    });
                                                }
                                            });
                                            
                                            this.plugin.settings.stats.totalCorrect = totalCorrect;
                                            this.plugin.settings.stats.totalWrong = totalWrong;
                                            this.plugin.settings.stats.totalAttempts = totalAttempts;
                                            
                                            await this.plugin.saveSettings();
                                            
                                            confirmModal.close();
                                            new Notice(`âœ… "${folder}" í´ë”ì˜ í•™ìŠµ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`);
                                        };
                                        
                                        confirmModal.open();
                                    };
                                });
                                
                                const cancelBtnContainer = contentEl.createDiv({ cls: 'modal-button-container' });
                                cancelBtnContainer.style.cssText = 'display: flex; justify-content: flex-end; margin-top: 15px;';
                                
                                const cancelBtn = cancelBtnContainer.createEl('button', {
                                    text: 'ì·¨ì†Œ'
                                });
                                cancelBtn.style.cssText = 'padding: 8px 16px;';
                                cancelBtn.onclick = () => {
                                    folderModal.close();
                                };
                                
                                folderModal.open();
                            });
                            break;
                            break;
                            
                        case 'timer':
                            item.onClick(() => {
                                this.openSettings();
                            });
                            break;
                            
                        case 'edit':
                            item.onClick(() => {
                                this.stopTimer();
                                this.isPaused = true;
                                
                                const optionModal = new Modal(this.app);
                                optionModal.titleEl.setText('âœï¸ í¸ì§‘ ì˜µì…˜');
                                
                                const { contentEl: modalContent } = optionModal;
                                modalContent.style.padding = '20px';
                                modalContent.style.minWidth = '300px';
                                
                                modalContent.createEl('p', { 
                                    text: 'ì–´ë–»ê²Œ í¸ì§‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                                    cls: 'edit-option-desc'
                                }).style.marginBottom = '20px';
                                
                                const btnContainer = modalContent.createDiv({ cls: 'edit-option-buttons' });
                                btnContainer.style.display = 'flex';
                                btnContainer.style.flexDirection = 'column';
                                btnContainer.style.gap = '10px';
                                
                                const modalEditBtn = btnContainer.createEl('button', {
                                    text: 'ğŸ“ ëª¨ë‹¬ì—ì„œ í¸ì§‘',
                                    cls: 'mod-cta'
                                });
                                modalEditBtn.style.padding = '12px';
                                modalEditBtn.addEventListener('click', () => {
                                    optionModal.close();
                                    const editModal = new HanziQuestionModal(this.app, this.plugin, question);
                                    editModal.open();
                                    editModal.onClose = async () => {
                                        const file = this.app.vault.getAbstractFileByPath(question.filePath);
                                        if (file) {
                                            const content = await this.app.vault.read(file);
                                            const updatedQuestion = this.plugin.parseQuestionFile(content, question.filePath);
                                            if (updatedQuestion) {
                                                Object.assign(question, updatedQuestion);
                                                if (!question.optionImages || question.optionImages.length === 0) {
                                                    question.optionImages = Array(question.options.length).fill('');
                                                } else if (question.optionImages.length < question.options.length) {
                                                    while (question.optionImages.length < question.options.length) {
                                                        question.optionImages.push('');
                                                    }
                                                }
                                            }
                                        }
                                        this.isPaused = false;
                                        this.showQuestion();
                                    };
                                });
                                
                                const fileEditBtn = btnContainer.createEl('button', {
                                    text: 'ğŸ“„ MD íŒŒì¼ì—ì„œ í¸ì§‘',
                                    cls: 'mod-cta'
                                });
                                fileEditBtn.style.padding = '12px';
                                fileEditBtn.addEventListener('click', async () => {
                                    optionModal.close();
                                    const file = this.app.vault.getAbstractFileByPath(question.filePath);
                                    if (file) {
                                        await this.app.workspace.getLeaf().openFile(file);
                                    } else {
                                        new Notice('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                    }
                                });
                                
                                const cancelBtn = btnContainer.createEl('button', {
                                    text: 'âŒ ì·¨ì†Œ'
                                });
                                cancelBtn.style.padding = '12px';
                                cancelBtn.addEventListener('click', () => {
                                    optionModal.close();
                                    this.isPaused = false;
                                });
                                
                                optionModal.open();
                            });
                            break;
                            
                        case 'delete':
                            item.onClick(async () => {
                                const confirmModal = new Modal(this.app);
                                confirmModal.titleEl.setText('âš ï¸ ë¬¸ì œ ì‚­ì œ');
                                
                                const { contentEl } = confirmModal;
                                contentEl.style.padding = '20px';
                                
                                contentEl.createEl('p', { 
                                    text: 'ì •ë§ë¡œ ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                                    cls: 'delete-confirm-message'
                                }).style.cssText = 'margin-bottom: 10px; font-size: 14px;';
                                
                                contentEl.createEl('p', {
                                    text: `ë¬¸ì œ: ${question.question}`,
                                    cls: 'delete-question-preview'
                                }).style.cssText = 'margin-bottom: 10px; padding: 10px; background: var(--background-secondary); border-radius: 4px; font-size: 13px; color: var(--text-muted);';
                                
                                // íŒŒì¼ ê²½ë¡œ í‘œì‹œ
                                contentEl.createEl('p', {
                                    text: `íŒŒì¼: ${question.filePath || 'ê²½ë¡œ ì—†ìŒ'}`,
                                    cls: 'delete-file-path'
                                }).style.cssText = 'margin-bottom: 20px; font-size: 12px; color: var(--text-faint); font-family: monospace;';
                                
                                const btnContainer = contentEl.createDiv({ cls: 'delete-button-container' });
                                btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
                                
                                const cancelBtn = btnContainer.createEl('button', {
                                    text: 'ì·¨ì†Œ',
                                    cls: 'mod-cta'
                                });
                                cancelBtn.style.cssText = 'padding: 8px 16px;';
                                cancelBtn.onclick = () => {
                                    confirmModal.close();
                                    this.isPaused = false;
                                };
                                
                                const confirmDeleteBtn = btnContainer.createEl('button', {
                                    text: 'ì‚­ì œ',
                                });
                                confirmDeleteBtn.style.cssText = 'padding: 8px 16px; background: var(--background-modifier-error); color: var(--text-on-accent);';
                                confirmDeleteBtn.onclick = async () => {
                                    try {
                                        // filePath í™•ì¸
                                        if (!question.filePath) {
                                            new Notice('âŒ íŒŒì¼ ê²½ë¡œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤');
                                            console.error('ë¬¸ì œ ê°ì²´ì— filePathê°€ ì—†ìŒ:', question);
                                            return;
                                        }
                                        
                                        // íŒŒì¼ ì°¾ê¸° (ì—¬ëŸ¬ ë°©ë²• ì‹œë„)
                                        let file = this.app.vault.getAbstractFileByPath(question.filePath);
                                        
                                        // íŒŒì¼ì´ ì—†ìœ¼ë©´ ë‹¤ë¥¸ ê²½ë¡œ ì‹œë„
                                        if (!file) {
                                            // ìƒëŒ€ ê²½ë¡œë¡œ ì‹œë„
                                            const files = this.app.vault.getMarkdownFiles();
                                            file = files.find(f => f.path === question.filePath || f.path.endsWith(question.filePath));
                                        }
                                        
                                        if (file) {
                                            console.log('ì‚­ì œí•  íŒŒì¼:', file.path);
                                            await this.app.vault.delete(file);
                                            new Notice('âœ… ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                                            
                                            // ë¬¸ì œ ëª©ë¡ì—ì„œ ì œê±°
                                            this.questions.splice(this.currentIndex, 1);
                                            
                                            // ëª¨ë“  ë¬¸ì œê°€ ì‚­ì œë˜ë©´ ëŒ€ì‹œë³´ë“œë¡œ
                                            if (this.questions.length === 0) {
                                                confirmModal.close();
                                                this.close();
                                                new DashboardModal(this.app, this.plugin).open();
                                                return;
                                            }
                                            
                                            // ì¸ë±ìŠ¤ ì¡°ì •
                                            if (this.currentIndex >= this.questions.length) {
                                                this.currentIndex = this.questions.length - 1;
                                            }
                                            
                                            confirmModal.close();
                                            this.isPaused = false;
                                            this.showQuestion();
                                        } else {
                                            new Notice('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + question.filePath);
                                            console.error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', question.filePath);
                                            console.log('ì‚¬ìš© ê°€ëŠ¥í•œ íŒŒì¼ë“¤:', this.app.vault.getMarkdownFiles().map(f => f.path));
                                        }
                                    } catch (error) {
                                        console.error('ë¬¸ì œ ì‚­ì œ ì‹¤íŒ¨:', error);
                                        new Notice('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                                    }
                                };
                                
                                confirmModal.open();
                            });
                            break;
                    }
                });
            }
            
            // ë©”ë‰´ ê´€ë¦¬ í•­ëª© ì¶”ê°€
            menu.addSeparator();
            menu.addItem((item) => {
                item.setTitle('âš™ï¸ ë©”ë‰´ ê´€ë¦¬')
                    .setIcon('settings')
                    .onClick(() => {
                        new RibbonMenuManagerModal(this.app, this.plugin).open();
                    });
            });
            
            menu.showAtMouseEvent(e);
        };

        // ê¸°ë¡ ê´€ë¦¬ ë²„íŠ¼ (ë¦¬ë³¸ ë©”ë‰´ ì˜†)
        const recordBtn = controlBar.createEl('button', {
            text: 'ğŸ“Š',
            cls: 'control-button record-button'
        });
        recordBtn.title = 'ê¸°ë¡ ê´€ë¦¬';
        recordBtn.onclick = () => {
            this.stopTimer();
            new QuizDetailRecordModal(this.app, this.plugin, { 
                correct: 0, 
                incorrect: 0, 
                total: 0, 
                percentage: 0, 
                time: 0, 
                details: [] 
            }).open();
        };

        // íŒíŠ¸ í¸ì§‘ ë²„íŠ¼ (ê¸°ë¡ ê´€ë¦¬ ì˜†)
        const hintEditBtn = controlBar.createEl('button', {
            text: 'ğŸ’¡',
            cls: 'control-button hint-edit-button'
        });
        hintEditBtn.title = 'íŒíŠ¸ í¸ì§‘';
        hintEditBtn.style.cssText = 'font-size: 18px;';
        hintEditBtn.onclick = () => {
            this.stopTimer();
            this.isPaused = true;
            
            const hintModal = new Modal(this.app);
            hintModal.titleEl.setText('ğŸ’¡ íŒíŠ¸ í¸ì§‘');
            
            const { contentEl: modalContent } = hintModal;
            modalContent.style.padding = '20px';
            modalContent.style.minWidth = isMobile ? '90vw' : '500px';
            modalContent.style.maxWidth = '600px';
            
            // íŒíŠ¸ í…ìŠ¤íŠ¸ ì„¹ì…˜
            modalContent.createEl('h4', { 
                text: 'íŒíŠ¸ í…ìŠ¤íŠ¸',
                cls: 'hint-edit-label'
            }).style.cssText = 'margin-bottom: 8px; color: var(--text-normal);';
            
            const hintTextArea = modalContent.createEl('textarea', {
                placeholder: 'íŒíŠ¸ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...',
                cls: 'hint-text-input'
            });
            hintTextArea.value = question.hint || '';
            hintTextArea.style.cssText = `
                width: 100%;
                min-height: 120px;
                padding: 12px;
                margin-bottom: 16px;
                border-radius: 6px;
                border: 1px solid var(--background-modifier-border);
                background: var(--background-primary);
                color: var(--text-normal);
                font-size: 14px;
                resize: vertical;
                font-family: var(--font-text);
            `;
            
            // íŒíŠ¸ ì´ë¯¸ì§€ ì„¹ì…˜
            modalContent.createEl('h4', { 
                text: 'íŒíŠ¸ ì´ë¯¸ì§€',
                cls: 'hint-image-label'
            }).style.cssText = 'margin-bottom: 8px; color: var(--text-normal);';
            
            modalContent.createEl('p', {
                text: 'ì´ë¯¸ì§€ ê²½ë¡œë¥¼ í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: [[image.png]] ë˜ëŠ” ![](image.png))',
                cls: 'hint-image-desc'
            }).style.cssText = 'font-size: 12px; color: var(--text-muted); margin-bottom: 8px;';
            
            const hintImageArea = modalContent.createEl('textarea', {
                placeholder: 'ì˜ˆì‹œ:\n[[image1.png]]\n[[image2.jpg]]',
                cls: 'hint-image-input'
            });
            hintImageArea.value = question.hintImage || '';
            hintImageArea.style.cssText = `
                width: 100%;
                min-height: 80px;
                padding: 12px;
                margin-bottom: 20px;
                border-radius: 6px;
                border: 1px solid var(--background-modifier-border);
                background: var(--background-primary);
                color: var(--text-normal);
                font-size: 14px;
                resize: vertical;
                font-family: var(--font-monospace);
            `;
            
            // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ
            const btnContainer = modalContent.createDiv({ cls: 'hint-edit-buttons' });
            btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: flex-end;';
            
            // ì €ì¥ ë²„íŠ¼
            const saveBtn = btnContainer.createEl('button', {
                text: 'ğŸ’¾ ì €ì¥',
                cls: 'mod-cta'
            });
            saveBtn.style.cssText = 'padding: 10px 20px; min-height: 44px;';
            saveBtn.onclick = async () => {
                const newHint = hintTextArea.value.trim();
                const newHintImage = hintImageArea.value.trim();
                
                // question ê°ì²´ ì—…ë°ì´íŠ¸
                question.hint = newHint;
                question.hintImage = newHintImage;
                
                // íŒŒì¼ì— ì €ì¥
                try {
                    const file = this.app.vault.getAbstractFileByPath(question.filePath);
                    if (file) {
                        const content = await this.app.vault.read(file);
                        const lines = content.split('\n');
                        
                        // íŒíŠ¸ ì„¹ì…˜ ì°¾ê¸° ë° ì—…ë°ì´íŠ¸
                        let hintIndex = lines.findIndex(line => line.trim() === '## íŒíŠ¸');
                        let hintImageIndex = lines.findIndex(line => line.trim() === '## íŒíŠ¸ì´ë¯¸ì§€');
                        
                        if (hintIndex !== -1) {
                            // ë‹¤ìŒ ì„¹ì…˜ê¹Œì§€ ì°¾ê¸°
                            let nextSectionIndex = hintIndex + 1;
                            while (nextSectionIndex < lines.length && !lines[nextSectionIndex].startsWith('##')) {
                                nextSectionIndex++;
                            }
                            // íŒíŠ¸ ë‚´ìš© êµì²´
                            lines.splice(hintIndex + 1, nextSectionIndex - hintIndex - 1, newHint);
                        }
                        
                        if (hintImageIndex !== -1) {
                            // ë‹¤ìŒ ì„¹ì…˜ê¹Œì§€ ì°¾ê¸°
                            let nextSectionIndex = hintImageIndex + 1;
                            while (nextSectionIndex < lines.length && !lines[nextSectionIndex].startsWith('##')) {
                                nextSectionIndex++;
                            }
                            // íŒíŠ¸ ì´ë¯¸ì§€ ë‚´ìš© êµì²´
                            lines.splice(hintImageIndex + 1, nextSectionIndex - hintImageIndex - 1, newHintImage);
                        }
                        
                        await this.app.vault.modify(file, lines.join('\n'));
                        new Notice('âœ… íŒíŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                        
                        hintModal.close();
                        this.isPaused = false;
                        
                        // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                        this.showQuestion();
                    }
                } catch (error) {
                    new Notice('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                    console.error('íŒíŠ¸ ì €ì¥ ì˜¤ë¥˜:', error);
                }
            };
            
            // ì·¨ì†Œ ë²„íŠ¼
            const cancelBtn = btnContainer.createEl('button', {
                text: 'âŒ ì·¨ì†Œ'
            });
            cancelBtn.style.cssText = 'padding: 10px 20px; min-height: 44px;';
            cancelBtn.onclick = () => {
                hintModal.close();
                this.isPaused = false;
            };
            
            hintModal.onClose = () => {
                if (this.isPaused) {
                    this.isPaused = false;
                }
            };
            
            hintModal.open();
        };

        // ë…¸íŠ¸ í¸ì§‘ ë²„íŠ¼ (íŒíŠ¸ í¸ì§‘ ì˜†)
        const noteEditBtn = controlBar.createEl('button', {
            text: 'ğŸ“',
            cls: 'control-button note-edit-button'
        });
        noteEditBtn.title = 'ë…¸íŠ¸ í¸ì§‘';
        noteEditBtn.style.cssText = `font-size: ${isMobile ? '14px' : '18px'};`;
        noteEditBtn.onclick = () => {
            this.stopTimer();
            this.isPaused = true;
            
            const noteModal = new Modal(this.app);
            noteModal.titleEl.setText('ğŸ“ ë…¸íŠ¸ í¸ì§‘');
            
            const { contentEl: modalContent } = noteModal;
            modalContent.style.padding = '20px';
            modalContent.style.minWidth = isMobile ? '90vw' : '500px';
            modalContent.style.maxWidth = '600px';
            
            // ë…¸íŠ¸ í…ìŠ¤íŠ¸ ì„¹ì…˜
            modalContent.createEl('h4', { 
                text: 'í•™ìŠµ ë…¸íŠ¸',
                cls: 'note-edit-label'
            }).style.cssText = 'margin-bottom: 8px; color: var(--text-normal);';
            
            const noteTextArea = modalContent.createEl('textarea', {
                placeholder: 'í•™ìŠµ ë…¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”...\nì˜ˆ: ì•”ê¸°ë²•, ê´€ë ¨ ë‹¨ì–´, ì£¼ì˜ì‚¬í•­ ë“±',
                cls: 'note-text-input'
            });
            noteTextArea.value = question.note || '';
            noteTextArea.style.cssText = `
                width: 100%;
                min-height: 150px;
                padding: 12px;
                margin-bottom: 16px;
                border-radius: 6px;
                border: 1px solid var(--background-modifier-border);
                background: var(--background-primary);
                color: var(--text-normal);
                font-size: 14px;
                resize: vertical;
                font-family: var(--font-text);
                line-height: 1.6;
            `;
            
            // ë„ì›€ë§ í…ìŠ¤íŠ¸
            const helpText = modalContent.createEl('p', {
                text: 'ğŸ’¡ íŒ: ì•”ê¸°ë²•, ìœ ì‚¬ í•œì, í˜¼ë™ ì£¼ì˜ ë“±ì„ ê¸°ë¡í•˜ë©´ í•™ìŠµì— ë„ì›€ì´ ë©ë‹ˆë‹¤.'
            });
            helpText.style.cssText = `
                font-size: 12px;
                color: var(--text-muted);
                margin-bottom: 16px;
                padding: 8px;
                background: var(--background-secondary);
                border-radius: 4px;
            `;
            
            // ë²„íŠ¼ ê·¸ë£¹
            const btnContainer = modalContent.createDiv({
                cls: 'note-edit-buttons'
            });
            btnContainer.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end;';
            
            // ì‚­ì œ ë²„íŠ¼ (ë…¸íŠ¸ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ)
            if (question.note && question.note.trim()) {
                const deleteNoteBtn = btnContainer.createEl('button', {
                    text: 'ğŸ—‘ï¸ ì‚­ì œ'
                });
                deleteNoteBtn.style.cssText = `
                    padding: 10px 20px;
                    background: #dc3545;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: 600;
                    min-height: 44px;
                `;
                deleteNoteBtn.onmouseenter = () => deleteNoteBtn.style.background = '#c82333';
                deleteNoteBtn.onmouseleave = () => deleteNoteBtn.style.background = '#dc3545';
                deleteNoteBtn.onclick = async () => {
                    if (confirm('ë…¸íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        try {
                            const file = this.app.vault.getAbstractFileByPath(question.filePath);
                            if (file && file instanceof this.app.vault.constructor.prototype.constructor) {
                                const content = await this.app.vault.read(file);
                                const lines = content.split('\n');
                                
                                let noteIndex = lines.findIndex(line => line.trim() === '## ë…¸íŠ¸');
                                if (noteIndex !== -1) {
                                    let nextSectionIndex = noteIndex + 1;
                                    while (nextSectionIndex < lines.length && !lines[nextSectionIndex].startsWith('##')) {
                                        nextSectionIndex++;
                                    }
                                    lines.splice(noteIndex + 1, nextSectionIndex - noteIndex - 1, '');
                                }
                                
                                await this.app.vault.modify(file, lines.join('\n'));
                                question.note = '';
                                new Notice('âœ… ë…¸íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                                
                                noteModal.close();
                                this.isPaused = false;
                                this.showQuestion();
                            }
                        } catch (error) {
                            new Notice('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                            console.error('ë…¸íŠ¸ ì‚­ì œ ì˜¤ë¥˜:', error);
                        }
                    }
                };
            }
            
            // ì €ì¥ ë²„íŠ¼
            const saveBtn = btnContainer.createEl('button', {
                text: 'ğŸ’¾ ì €ì¥'
            });
            saveBtn.style.cssText = `
                padding: 10px 20px;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 600;
                min-height: 44px;
            `;
            saveBtn.onclick = async () => {
                try {
                    const newNote = noteTextArea.value.trim();
                    
                    const file = this.app.vault.getAbstractFileByPath(question.filePath);
                    if (file && file instanceof this.app.vault.constructor.prototype.constructor) {
                        const content = await this.app.vault.read(file);
                        const lines = content.split('\n');
                        
                        let noteIndex = lines.findIndex(line => line.trim() === '## ë…¸íŠ¸');
                        
                        if (noteIndex !== -1) {
                            let nextSectionIndex = noteIndex + 1;
                            while (nextSectionIndex < lines.length && !lines[nextSectionIndex].startsWith('##')) {
                                nextSectionIndex++;
                            }
                            lines.splice(noteIndex + 1, nextSectionIndex - noteIndex - 1, newNote);
                        }
                        
                        await this.app.vault.modify(file, lines.join('\n'));
                        question.note = newNote;
                        new Notice('âœ… ë…¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                        
                        noteModal.close();
                        this.isPaused = false;
                        this.showQuestion();
                    }
                } catch (error) {
                    new Notice('âŒ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
                    console.error('ë…¸íŠ¸ ì €ì¥ ì˜¤ë¥˜:', error);
                }
            };
            
            // ì·¨ì†Œ ë²„íŠ¼
            const cancelBtn = btnContainer.createEl('button', {
                text: 'âŒ ì·¨ì†Œ'
            });
            cancelBtn.style.cssText = 'padding: 10px 20px; min-height: 44px;';
            cancelBtn.onclick = () => {
                noteModal.close();
                this.isPaused = false;
            };
            
            noteModal.onClose = () => {
                if (this.isPaused) {
                    this.isPaused = false;
                }
            };
            
            noteModal.open();
        };

        // ì™¼ìª½ ì»¨íŠ¸ë¡¤ ê·¸ë£¹ì€ ë‚˜ì¤‘ì— ë¶ë§ˆí¬ ì•„ë˜ì— ìƒì„±ë¨ (ì•„ë˜ ì½”ë“œ ì°¸ì¡°)

        // í´ë” ê´€ë¦¬ ë²„íŠ¼
        const folderBtn = controlBar.createEl('button', {
            text: 'ğŸ“',
            cls: 'control-button folder-button'
        });
        folderBtn.title = 'í´ë” ê´€ë¦¬';
        folderBtn.addEventListener('click', () => {
            this.stopTimer();
            this.close();
            new FolderManagementModal(this.app, this.plugin).open();
        });
        
        // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
        const deleteBtn = controlBar.createEl('button', {
            text: 'ğŸ—‘ï¸',
            cls: 'control-button delete-button'
        });
        deleteBtn.title = 'ë¬¸ì œ ì‚­ì œ';
        
        const handleDelete = async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            const confirmDelete = confirm(`"${question.hanzi}" ë¬¸ì œë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
            if (confirmDelete) {
                this.stopTimer();
                try {
                    await this.plugin.deleteQuestion(question);
                    new Notice('âœ… ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                    
                    // ë¬¸ì œ ëª©ë¡ì—ì„œ ì œê±°
                    this.questions.splice(this.currentIndex, 1);
                    
                    // ëª¨ë“  ë¬¸ì œê°€ ì‚­ì œë˜ë©´ ëŒ€ì‹œë³´ë“œë¡œ
                    if (this.questions.length === 0) {
                        this.close();
                        new DashboardModal(this.app, this.plugin).open();
                        return;
                    }
                    
                    // ì¸ë±ìŠ¤ ì¡°ì •
                    if (this.currentIndex >= this.questions.length) {
                        this.currentIndex = this.questions.length - 1;
                    }
                    
                    this.showQuestion();
                } catch (error) {
                    new Notice('âŒ ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
                }
            }
        };
        
        deleteBtn.addEventListener('click', handleDelete);
        deleteBtn.addEventListener('touchend', handleDelete);
        
        // í¸ì§‘ ë²„íŠ¼ ì¶”ê°€
        const editBtn = controlBar.createEl('button', {
            text: 'âœï¸',
            cls: 'control-button edit-button'
        });
        editBtn.title = 'ë¬¸ì œ í¸ì§‘';
        editBtn.addEventListener('click', () => {
            this.stopTimer();
            this.isPaused = true;
            
            const optionModal = new Modal(this.app);
            optionModal.titleEl.setText('âœï¸ í¸ì§‘ ì˜µì…˜');
            
            const { contentEl: modalContent } = optionModal;
            modalContent.style.padding = '20px';
            modalContent.style.minWidth = '300px';
            
            modalContent.createEl('p', { 
                text: 'ì–´ë–»ê²Œ í¸ì§‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                cls: 'edit-option-desc'
            }).style.marginBottom = '20px';
            
            const btnContainer = modalContent.createDiv({ cls: 'edit-option-buttons' });
            btnContainer.style.display = 'flex';
            btnContainer.style.flexDirection = 'column';
            btnContainer.style.gap = '10px';
            
            const modalEditBtn = btnContainer.createEl('button', {
                text: 'ğŸ“ ëª¨ë‹¬ì—ì„œ í¸ì§‘',
                cls: 'mod-cta'
            });
            modalEditBtn.style.padding = '12px';
            modalEditBtn.addEventListener('click', () => {
                optionModal.close();
                const editModal = new HanziQuestionModal(this.app, this.plugin, question);
                editModal.open();
                editModal.onClose = async () => {
                    console.log('ğŸ”„ [ë¬¸ì œ í¸ì§‘ ëª¨ë‹¬] ë‹«í˜ - ë¬¸ì œ ë‹¤ì‹œ ë¡œë“œ ì‹œì‘');
                    const file = this.app.vault.getAbstractFileByPath(question.filePath);
                    if (file) {
                        const content = await this.app.vault.read(file);
                        const updatedQuestion = this.plugin.parseQuestionFile(content, question.filePath);
                        if (updatedQuestion) {
                            Object.assign(question, updatedQuestion);
                            if (!question.optionImages || question.optionImages.length === 0) {
                                question.optionImages = Array(question.options.length).fill('');
                            } else if (question.optionImages.length < question.options.length) {
                                while (question.optionImages.length < question.options.length) {
                                    question.optionImages.push('');
                                }
                            }
                        }
                    }
                    this.isPaused = false;
                    
                    // í˜„ì¬ í™”ë©´ì´ ì •ë‹µ í™•ì¸ í›„ í™”ë©´ì¸ì§€ ì²´í¬
                    const { contentEl } = this;
                    const feedbackEl = contentEl.querySelector('.feedback-container, .quiz-feedback');
                    
                    if (feedbackEl) {
                        console.log('ğŸ”„ [ë¬¸ì œ í¸ì§‘] ì •ë‹µ í™”ë©´ì—ì„œ í¸ì§‘ë¨ - reloadCurrentQuestion í˜¸ì¶œ');
                        await this.reloadCurrentQuestion();
                    } else {
                        console.log('ğŸ”„ [ë¬¸ì œ í¸ì§‘] ë¬¸ì œ í™”ë©´ì—ì„œ í¸ì§‘ë¨ - showQuestion í˜¸ì¶œ');
                        this.showQuestion();
                    }
                    console.log('âœ… [ë¬¸ì œ í¸ì§‘] í™”ë©´ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ');
                };
            });
            
            const fileEditBtn = btnContainer.createEl('button', {
                text: 'ğŸ“„ MD íŒŒì¼ì—ì„œ í¸ì§‘',
                cls: 'mod-cta'
            });
            fileEditBtn.style.padding = '12px';
            fileEditBtn.addEventListener('click', async () => {
                optionModal.close();
                const file = this.app.vault.getAbstractFileByPath(question.filePath);
                if (file) {
                    await this.app.workspace.getLeaf().openFile(file);
                } else {
                    new Notice('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
            
            const cancelBtn = btnContainer.createEl('button', {
                text: 'âŒ ì·¨ì†Œ'
            });
            cancelBtn.style.padding = '12px';
            cancelBtn.addEventListener('click', () => {
                optionModal.close();
                this.isPaused = false;
            });
            
            optionModal.open();
        });
        
        // ë¬¸ì œ ë²ˆí˜¸ì™€ ì ìˆ˜ í‘œì‹œ
        const progress = header.createDiv({ cls: 'quiz-progress' });
        progress.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: ${isMobile ? '4px 8px' : '8px 12px'};
            background: var(--background-secondary);
            border-radius: 6px;
            margin: ${isMobile ? '4px 0' : '8px 0'};
            font-size: ${isMobile ? '12px' : '14px'};
        `;
        
        const progressLabel = progress.createDiv({ cls: 'progress-label' });
        const difficultyIcon = this.plugin.getDifficultyIcon(question.difficulty || 'C');
        const difficultyGrade = question.difficulty || 'C';
        progressLabel.setText(`${difficultyIcon} ${question.number || (this.currentIndex + 1)}ë²ˆ`);
        progressLabel.style.cssText = 'font-weight: 600; color: var(--text-normal);';
        
        const progressInfo = progress.createDiv({ cls: 'progress-info' });
        progressInfo.innerHTML = `<span style="color: var(--text-muted);">${this.currentIndex + 1}/${this.questions.length}</span> <span style="color: var(--interactive-accent); font-weight: 600; margin-left: 8px;">${this.score}ì </span>`;

        // íƒ€ì´ë¨¸ (ë‘ê»ê³  í™”ë ¤í•˜ê²Œ, ì´ˆ í‘œì‹œ í¬í•¨)
        if (this.plugin.settings.enableTimer) {
            const timerContainer = header.createDiv({ cls: 'hanzi-timer-container' });
            const timerProgress = timerContainer.createDiv({ cls: 'hanzi-timer-progress' });
            this.timerFill = timerProgress.createDiv({ cls: 'hanzi-timer-fill' });
            this.timerText = timerContainer.createDiv({ cls: 'hanzi-timer-text' });
            
            this.timerContainer = timerContainer;
            this.updateTimer();
            this.startTimer();
        }

        // ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì»¨í…ì¸  ì˜ì—­ (ì´ë¯¸ì§€ + ë¬¸ì œ + ì„ íƒì§€)
        const scrollableContent = contentEl.createDiv({ cls: 'quiz-scrollable-content' });
        scrollableContent.style.cssText = `
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 10px;
            margin-bottom: 10px;
        `;

        // ì´ë¯¸ì§€ (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì› + í˜ì´ì§€ ë„˜ê¹€)
        if (question.image && question.image.trim()) {
            const imgContainer = scrollableContent.createDiv({ cls: 'question-image-container' });
            imgContainer.style.cssText = 'display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; padding: 10px; background: var(--background-secondary); border-radius: 8px;';
            
            // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ ì´ë¯¸ì§€ë“¤ ì²˜ë¦¬
            const imageLines = question.image.split('\n').filter(line => line.trim());
            const totalImages = imageLines.length;
            let currentImageIndex = 0;

            // ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­
            const imageDisplayArea = imgContainer.createDiv();
            imageDisplayArea.style.cssText = 'min-height: 200px; display: flex; align-items: center; justify-content: center;';

            // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ì´ë¯¸ì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ)
            let navControls = null;
            if (totalImages > 1) {
                navControls = imgContainer.createDiv();
                navControls.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 15px; margin-top: 10px;';

                const prevBtn = navControls.createEl('button', { text: 'â—€ ì´ì „' });
                prevBtn.type = 'button';
                prevBtn.style.cssText = 'padding: 12px 20px; cursor: pointer; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; font-size: 14px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                const pageInfo = navControls.createEl('span', { text: `${currentImageIndex + 1} / ${totalImages}` });
                pageInfo.style.cssText = 'min-width: 80px; text-align: center; font-weight: bold; color: var(--text-normal); font-size: 14px;';

                const nextBtn = navControls.createEl('button', { text: 'ë‹¤ìŒ â–¶' });
                nextBtn.type = 'button';
                nextBtn.style.cssText = 'padding: 12px 20px; cursor: pointer; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; font-size: 14px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                const zoomBtn = navControls.createEl('button', { text: 'ğŸ” í™•ëŒ€' });
                zoomBtn.type = 'button';
                zoomBtn.style.cssText = 'padding: 12px 20px; cursor: pointer; background: var(--background-modifier-success); color: var(--text-on-accent); border: none; border-radius: 6px; font-size: 14px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                // í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€
                [prevBtn, nextBtn, zoomBtn].forEach(btn => {
                    btn.addEventListener('touchstart', () => {
                        btn.style.opacity = '0.7';
                    });
                    btn.addEventListener('touchend', () => {
                        btn.style.opacity = btn.disabled ? '0.5' : '1';
                    });
                    btn.addEventListener('touchcancel', () => {
                        btn.style.opacity = btn.disabled ? '0.5' : '1';
                    });
                });

                const showImage = (index) => {
                    if (index < 0 || index >= totalImages) return;
                    
                    currentImageIndex = index;
                    imageDisplayArea.empty();

                    const imageLine = imageLines[index].trim();
                    let imageUrl = imageLine;

                    // URL ë””ì½”ë”© (ì¸ì½”ë”©ëœ ê²½ìš°)
                    if (imageUrl.includes('%')) {
                        try {
                            imageUrl = decodeURIComponent(imageUrl);
                        } catch (e) {
                            console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                        }
                    }

                    // í¬ê¸° ì •ë³´ ì¶”ì¶œ
                    let imageWidth = null;
                    const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                    if (sizeMatch) {
                        imageWidth = sizeMatch[1] + 'px';
                    }

                    // ì˜µì‹œë””ì–¸ ë‚´ë¶€ ë§í¬ ì²˜ë¦¬
                    if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                        const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            
                            // ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°ì™€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            // ì´ë¯¸ì§€ ê²½ë¡œê°€ í´ë”ëª…ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ìƒëŒ€ ê²½ë¡œ)
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            }
                            // ì´ë¯¸ì§€ ê²½ë¡œê°€ í€´ì¦ˆ í´ë”ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                            else if (!imagePath.startsWith(quizFolder)) {
                                // íŒŒì¼ëª…ë§Œ ìˆëŠ” ê²½ìš°
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            console.log(`ğŸ–¼ï¸ [ë¬¸ì œ ì´ë¯¸ì§€ ê²½ë¡œ] ${wikiMatch[1]} â†’ ${imagePath}`);
                            
                            // Vaultì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ì°¾ê¸°
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            
                            if (imageFile) {
                                // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                                console.log(`âœ… [ë¬¸ì œ ì´ë¯¸ì§€ ë°œê²¬] ${imagePath} â†’ ${imageUrl}`);
                            } else {
                                // íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆì„ ë•Œë„ ê²½ë¡œë¥¼ ì‹œë„í•´ë´„
                                imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                                console.warn(`âš ï¸ [ë¬¸ì œ ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ, ê²½ë¡œ ì‹œë„] ${imagePath} â†’ ${imageUrl}`);
                            }
                        }
                    } else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                        const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                        if (imgMatch && imgMatch[1]) {
                            imageUrl = imgMatch[1];
                        }
                    }

                    // ì´ë¯¸ì§€ ìƒì„±
                    const img = imageDisplayArea.createEl('img', {
                        attr: { src: imageUrl, alt: 'ë¬¸ì œ ì´ë¯¸ì§€' },
                        cls: 'quiz-question-image'
                    });
                    
                    img.style.cssText = `
                        max-width: 100%;
                        width: ${imageWidth || 'auto'};
                        height: auto;
                        max-height: 500px;
                        cursor: zoom-in;
                        transition: transform 0.2s;
                        border-radius: 6px;
                        object-fit: contain;
                        display: block;
                        margin: 0 auto;
                    `;
                    
                    img.onerror = () => {
                        imageDisplayArea.empty();
                        imageDisplayArea.createEl('p', {
                            text: 'âš ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                            attr: { style: 'color: var(--text-muted); padding: 40px; text-align: center;' }
                        });
                    };

                    // ëª¨ë“  ì´ë¯¸ì§€ URL ë°°ì—´ ìƒì„± (í™•ëŒ€ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
                    const allImageUrls = imageLines.map(line => {
                        let url = line.trim();
                        if (url.includes('[[') && url.includes(']]')) {
                            const wikiMatch = url.match(/\[\[(.+?)(\|\d+)?\]\]/);
                            if (wikiMatch && wikiMatch[1]) {
                                let imagePath = wikiMatch[1];
                                const folderName = question.folder || 'default';
                                const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                                
                                // ê²½ë¡œ ë³´ì •
                                if (imagePath.startsWith(folderName + '/')) {
                                    imagePath = `${quizFolder}/${imagePath}`;
                                } else if (!imagePath.startsWith(quizFolder)) {
                                    if (!imagePath.includes('/')) {
                                        imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                    }
                                }
                                
                                const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                                // íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ ê²½ë¡œ ë°˜í™˜ ì‹œë„
                                return this.app.vault.adapter.getResourcePath(imagePath);
                            }
                        }
                        return url;
                    });

                    // ì´ë¯¸ì§€ í™•ëŒ€ ê¸°ëŠ¥
                    img.addEventListener('click', () => {
                        this.showImageZoom(imageUrl, 'ë¬¸ì œ ì´ë¯¸ì§€', allImageUrls, currentImageIndex);
                    });
                    
                    img.addEventListener('mouseenter', () => {
                        img.style.transform = 'scale(1.05)';
                    });
                    
                    img.addEventListener('mouseleave', () => {
                        img.style.transform = 'scale(1)';
                    });

                    // í™•ëŒ€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                    zoomBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.showImageZoom(imageUrl, 'ë¬¸ì œ ì´ë¯¸ì§€', allImageUrls, currentImageIndex);
                    };

                    // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
                    pageInfo.textContent = `${currentImageIndex + 1} / ${totalImages}`;
                    prevBtn.disabled = currentImageIndex === 0;
                    nextBtn.disabled = currentImageIndex === totalImages - 1;
                    
                    prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                    prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                    nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
                    nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
                };

                prevBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showImage(currentImageIndex - 1);
                };
                nextBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showImage(currentImageIndex + 1);
                };

                // ì´ˆê¸° ì´ë¯¸ì§€ í‘œì‹œ
                showImage(0);
            } else {
                // ì´ë¯¸ì§€ê°€ 1ê°œì¼ ë•Œ
                const imageLine = imageLines[0].trim();
                let imageUrl = imageLine;

                // URL ë””ì½”ë”© (ì¸ì½”ë”©ëœ ê²½ìš°)
                if (imageUrl.includes('%')) {
                    try {
                        imageUrl = decodeURIComponent(imageUrl);
                    } catch (e) {
                        console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                    }
                }

                // í¬ê¸° ì •ë³´ ì¶”ì¶œ
                let imageWidth = null;
                const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                if (sizeMatch) {
                    imageWidth = sizeMatch[1] + 'px';
                }

                if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                    const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                    if (wikiMatch && wikiMatch[1]) {
                        let imagePath = wikiMatch[1];
                        
                        // ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°ì™€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
                        const folderName = question.folder || 'default';
                        const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                        const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                        
                        // ì´ë¯¸ì§€ ê²½ë¡œê°€ í´ë”ëª…ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ìƒëŒ€ ê²½ë¡œ)
                        if (imagePath.startsWith(folderName + '/')) {
                            imagePath = `${quizFolder}/${imagePath}`;
                        }
                        // ì´ë¯¸ì§€ ê²½ë¡œê°€ í€´ì¦ˆ í´ë”ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                        else if (!imagePath.startsWith(quizFolder)) {
                            // íŒŒì¼ëª…ë§Œ ìˆëŠ” ê²½ìš°
                            if (!imagePath.includes('/')) {
                                imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                            }
                        }
                        
                        const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                        
                        if (imageFile) {
                            // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                            imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                            console.log(`âœ… [ë¬¸ì œ ì´ë¯¸ì§€ 1ê°œ] ${imagePath} â†’ ${imageUrl}`);
                        } else {
                            // íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆì„ ë•Œë„ ê²½ë¡œë¥¼ ì‹œë„í•´ë´„
                            imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                            console.warn(`âš ï¸ [ë¬¸ì œ ì´ë¯¸ì§€ 1ê°œ íŒŒì¼ ì—†ìŒ, ê²½ë¡œ ì‹œë„] ${imagePath} â†’ ${imageUrl}`);
                        }
                    }
                } else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                    const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                    if (imgMatch && imgMatch[1]) {
                        imageUrl = imgMatch[1];
                    }
                }

                const img = imageDisplayArea.createEl('img', {
                    attr: { src: imageUrl, alt: 'ë¬¸ì œ ì´ë¯¸ì§€' },
                    cls: 'quiz-question-image'
                });
                
                img.style.cssText = `max-width: 100%; width: ${imageWidth || 'auto'}; height: auto; cursor: zoom-in; transition: transform 0.2s; border-radius: 6px;`;
                
                img.onerror = () => {
                    imageDisplayArea.innerHTML = '<p style="color: var(--text-muted); padding: 20px; text-align: center;">âš ï¸ ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                };

                // ì´ë¯¸ì§€ ë°°ì—´ ìƒì„± (1ê°œì§€ë§Œ í™•ëŒ€ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
                const allImageUrls = [imageUrl];

                img.addEventListener('click', () => {
                    this.showImageZoom(imageUrl, 'ë¬¸ì œ ì´ë¯¸ì§€', allImageUrls, 0);
                });
                
                img.addEventListener('mouseenter', () => {
                    img.style.transform = 'scale(1.05)';
                });
                
                img.addEventListener('mouseleave', () => {
                    img.style.transform = 'scale(1)';
                });

                // í™•ëŒ€ ë²„íŠ¼ ì¶”ê°€ (1ê°œì¼ ë•Œë„)
                const zoomBtnContainer = imgContainer.createDiv();
                zoomBtnContainer.style.cssText = 'display: flex; justify-content: center; margin-top: 10px;';
                
                const zoomBtn = zoomBtnContainer.createEl('button', { text: 'ğŸ” í™•ëŒ€' });
                zoomBtn.type = 'button';
                zoomBtn.style.cssText = 'padding: 12px 20px; cursor: pointer; background: var(--background-modifier-success); color: var(--text-on-accent); border: none; border-radius: 6px; font-size: 14px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';
                
                zoomBtn.onclick = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    this.showImageZoom(imageUrl, 'ë¬¸ì œ ì´ë¯¸ì§€', allImageUrls, 0);
                };

                zoomBtn.addEventListener('touchstart', () => {
                    zoomBtn.style.opacity = '0.7';
                });
                zoomBtn.addEventListener('touchend', () => {
                    zoomBtn.style.opacity = '1';
                });
                zoomBtn.addEventListener('touchcancel', () => {
                    zoomBtn.style.opacity = '1';
                });
            }
        }

        // ë…¹ìŒ ì»¨íŠ¸ë¡¤ (ë¬¸ì œ ìœ„ì— ë°°ì¹˜)
        const audioControlContainer = scrollableContent.createDiv({ cls: 'audio-control-container' });
        audioControlContainer.style.cssText = `
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--background-secondary);
            border-radius: 8px;
            margin-bottom: 15px;
        `;

        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;

        const updateAudioControls = () => {
            audioControlContainer.empty();

            const hasAudio = question.audio && question.audio.trim();

            if (hasAudio) {
                // ì¬ìƒ ë²„íŠ¼
                const playBtn = audioControlContainer.createEl('button', { text: 'â–¶ ì¬ìƒ' });
                playBtn.style.cssText = `padding: 10px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; font-size: 14px; min-height: 44px;`;
                playBtn.onclick = () => {
                    try {
                        const audio = new Audio(question.audio);
                        audio.play();
                        new Notice('ğŸ”Š ìŒì„± ì¬ìƒ ì¤‘...');
                    } catch (error) {
                        new Notice('âŒ ìŒì„± ì¬ìƒ ì‹¤íŒ¨: ' + error.message);
                    }
                };

                // ì‚­ì œ ë²„íŠ¼
                const deleteAudioBtn = audioControlContainer.createEl('button', { text: 'ğŸ—‘ï¸ ì‚­ì œ' });
                deleteAudioBtn.style.cssText = `padding: 10px 16px; background: var(--background-modifier-error); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; font-size: 14px; min-height: 44px;`;
                deleteAudioBtn.onclick = async () => {
                    if (confirm('ìŒì„± ë…¹ìŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        question.audio = '';
                        await this.plugin.saveQuestion(question);
                        new Notice('âœ… ìŒì„±ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                        updateAudioControls();
                    }
                };

                // ì¬ë…¹ìŒ ë²„íŠ¼
                const reRecordBtn = audioControlContainer.createEl('button', { text: 'ğŸ¤ ì¬ë…¹ìŒ' });
                reRecordBtn.style.cssText = `padding: 10px 16px; background: var(--interactive-normal); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; font-size: 14px; min-height: 44px;`;
                reRecordBtn.onclick = async () => {
                    startRecording();
                };
            } else {
                // ë…¹ìŒ ì‹œì‘ ë²„íŠ¼
                const recordBtn = audioControlContainer.createEl('button', { text: 'ğŸ¤ ë…¹ìŒí•˜ê¸°' });
                recordBtn.style.cssText = `padding: 10px 16px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; font-size: 14px; min-height: 44px;`;
                recordBtn.onclick = async () => {
                    startRecording();
                };
            }
        };

        const startRecording = async () => {
            try {
                // ë§ˆì´í¬ ê¶Œí•œ í™•ì¸
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    new Notice('âŒ ì´ ë¸Œë¼ìš°ì €ëŠ” ë…¹ìŒì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ê¶Œí•œ ìš”ì²­ ì•ˆë‚´
                new Notice('ğŸ¤ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”...');
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onloadend = async () => {
                        question.audio = reader.result; // base64 ë°ì´í„°
                        await this.plugin.saveQuestion(question);
                        new Notice('âœ… ë…¹ìŒì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                        updateAudioControls();
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                new Notice('ğŸ¤ ë…¹ìŒ ì¤‘... (ì¤‘ì§€ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”)');

                // ë…¹ìŒ ì¤‘ UI ì—…ë°ì´íŠ¸
                audioControlContainer.empty();
                const recordingText = audioControlContainer.createEl('span', { text: 'ğŸ”´ ë…¹ìŒ ì¤‘...' });
                recordingText.style.cssText = `color: red; font-weight: bold; font-size: 14px;`;

                const stopBtn = audioControlContainer.createEl('button', { text: 'â¹ ì¤‘ì§€' });
                stopBtn.style.cssText = `padding: 10px 16px; background: var(--background-modifier-error); color: var(--text-on-accent); border: none; border-radius: 6px; cursor: pointer; font-size: 14px; margin-left: 10px; min-height: 44px;`;
                stopBtn.onclick = () => {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                    }
                };
            } catch (error) {
                console.error('Recording error:', error);
                
                let errorMessage = 'âŒ ë…¹ìŒ ì‹¤íŒ¨: ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'âŒ ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n';
                    
                    if (this.app.isMobile) {
                        // ëª¨ë°”ì¼
                        errorMessage += 'ğŸ“± ì•ˆë“œë¡œì´ë“œ:\n';
                        errorMessage += 'ì„¤ì • â†’ ì•± â†’ Obsidian â†’ ê¶Œí•œ â†’ ë§ˆì´í¬ í—ˆìš©\n\n';
                        errorMessage += 'ğŸ“± iOS:\n';
                        errorMessage += 'ì„¤ì • â†’ Obsidian â†’ ë§ˆì´í¬ í—ˆìš©';
                    } else {
                        // ë°ìŠ¤í¬í†± ë¸Œë¼ìš°ì €
                        errorMessage += 'ğŸ–¥ï¸ ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”:\n';
                        errorMessage += 'ì£¼ì†Œì°½ ì™¼ìª½ì˜ ìë¬¼ì‡  ì•„ì´ì½˜ í´ë¦­ â†’ ë§ˆì´í¬ í—ˆìš©';
                    }
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'âŒ ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në§ˆì´í¬ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'âŒ ë§ˆì´í¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ì•±ì—ì„œ ë§ˆì´í¬ë¥¼ ì‚¬ìš© ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.';
                } else {
                    errorMessage += error.message;
                }
                
                new Notice(errorMessage, 10000);
                
                // ë…¹ìŒ ë²„íŠ¼ ë³µì›
                updateAudioControls();
            }
        };

        updateAudioControls();

        // ë¬¸ì œ (í´ë¦­í•˜ë©´ íŒíŠ¸ í† ê¸€)
        const questionText = scrollableContent.createDiv({ cls: 'question-text' });
        questionText.style.cssText = `
            text-align: center;
            padding: ${isMobile ? '20px 12px' : '40px 20px'};
            background: var(--background-primary);
            border-radius: 12px;
            margin-bottom: ${isMobile ? '16px' : '24px'};
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        `;
        
        // í•œì í‘œì‹œ - Anki ìŠ¤íƒ€ì¼ë¡œ í¬ê³  ëª…í™•í•˜ê²Œ
        if (question.hanzi) {
            const hanziEl = questionText.createEl('div', { 
                text: question.hanzi,
                cls: 'hanzi-display'
            });
            const hanziFontSize = isMobile ? '48px' : '72px';
            const hanziMargin = isMobile ? '10px' : '20px';
            hanziEl.style.cssText = `
                font-size: ${hanziFontSize};
                font-weight: 700;
                line-height: 1.2;
                margin-bottom: ${hanziMargin};
                color: var(--text-normal);
                font-family: 'Noto Serif KR', 'Noto Serif CJK KR', serif;
            `;
        }
        
        const questionHeading = questionText.createEl('h3', { text: question.question });
        const questionFontSize = isMobile ? '16px' : '20px';
        questionHeading.style.cssText = `
            font-size: ${questionFontSize};
            font-weight: 500;
            line-height: 1.5;
            margin: 0;
            color: var(--text-muted);
        `;
        
        // íŒíŠ¸ ì»¨í…Œì´ë„ˆ (ì„ íƒì§€ ìœ„ì— í‘œì‹œë˜ë„ë¡ position ì¡°ì •)
        let hintEl = null;
        if ((question.hint && question.hint.trim()) || (question.hintImage && question.hintImage.trim())) {
            hintEl = questionText.createDiv({ cls: 'hint-container' });
            hintEl.style.cssText = `
                display: none;
                position: relative;
                z-index: 1000;
                background: var(--background-secondary);
                padding: ${isMobile ? '10px' : '15px'};
                margin: ${isMobile ? '8px 0' : '10px 0'};
                border-radius: 8px;
                border: 2px solid var(--interactive-accent);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            `;
            
            if (question.hint && question.hint.trim()) {
                const hintTextContainer = hintEl.createDiv({ cls: 'hint-text-container' });
                hintTextContainer.style.marginBottom = '8px';
                
                // íŒíŠ¸ í…ìŠ¤íŠ¸ì—ì„œ ì´ë¯¸ì§€ ë§í¬ ì¶”ì¶œ ë° ë Œë”ë§
                const hintLines = question.hint.split('\n');
                
                // ëª¨ë“  ì´ë¯¸ì§€ URL ìˆ˜ì§‘ (ë„¤ë¹„ê²Œì´ì…˜ìš©)
                const allHintTextImages = [];
                for (const line of hintLines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.includes('![[') && trimmedLine.includes(']]')) {
                        const wikiMatch = trimmedLine.match(/!\[\[(.+?)\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            // ê²½ë¡œ ë³´ì •
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            } else if (!imagePath.startsWith(quizFolder)) {
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            if (imageFile) {
                                // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                allHintTextImages.push(this.app.vault.adapter.getResourcePath(imagePath));
                            }
                        }
                    }
                }
                
                let hintTextImageIndex = 0;
                for (const line of hintLines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    // ì˜µì‹œë””ì–¸ ì´ë¯¸ì§€ ë§í¬ ì²´í¬: ![[íŒŒì¼ëª…]] (ì•ë’¤ ê³µë°± í—ˆìš©)
                    if (trimmedLine.includes('![[') && trimmedLine.includes(']]')) {
                        const wikiMatch = trimmedLine.match(/!\[\[(.+?)\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            // ê²½ë¡œ ë³´ì •
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            } else if (!imagePath.startsWith(quizFolder)) {
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            
                            if (imageFile) {
                                // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                const imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                                const currentIndex = hintTextImageIndex;
                                const img = hintTextContainer.createEl('img', {
                                    attr: {
                                        src: imageUrl,
                                        style: 'max-width: 400px; width: 100%; height: auto; border-radius: 6px; cursor: zoom-in; margin: 8px 0;'
                                    }
                                });
                                img.addEventListener('click', () => {
                                    this.showImageZoom(imageUrl, 'íŒíŠ¸ ì´ë¯¸ì§€', allHintTextImages, currentIndex);
                                });
                                hintTextImageIndex++;
                                continue;
                            }
                        }
                    }
                    
                    // ì¼ë°˜ í…ìŠ¤íŠ¸
                    hintTextContainer.createEl('p', { 
                        text: `ğŸ’¡ ${trimmedLine}`,
                        cls: 'hint-text'
                    });
                }
            }
            
            // íŒíŠ¸ ì´ë¯¸ì§€ (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì› + í˜ì´ì§€ ë„˜ê¹€)
            if (question.hintImage && question.hintImage.trim()) {
                const hintImgContainer = hintEl.createDiv({ cls: 'hint-image-container' });
                hintImgContainer.style.cssText = 'margin-top: 10px; display: flex; flex-direction: column; gap: 8px;';
                
                // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ ì´ë¯¸ì§€ë“¤ ì²˜ë¦¬
                const hintImageLines = question.hintImage.split('\n').filter(line => line.trim());
                const totalImages = hintImageLines.length;
                let currentImageIndex = 0;

                // ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­
                const imageDisplayArea = hintImgContainer.createDiv();
                imageDisplayArea.style.cssText = 'min-height: 150px; display: flex; align-items: center; justify-content: center;';

                // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ (ì´ë¯¸ì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ)
                if (totalImages > 1) {
                    const navControls = hintImgContainer.createDiv();
                    navControls.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 10px;';

                    const prevBtn = navControls.createEl('button', { text: 'â—€' });
                    prevBtn.type = 'button';
                    prevBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; font-size: 13px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                    const pageInfo = navControls.createEl('span', { text: `${currentImageIndex + 1} / ${totalImages}` });
                    pageInfo.style.cssText = 'min-width: 60px; text-align: center; font-weight: bold; font-size: 13px;';

                    const nextBtn = navControls.createEl('button', { text: 'â–¶' });
                    nextBtn.type = 'button';
                    nextBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; font-size: 13px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                    const zoomBtn = navControls.createEl('button', { text: 'ğŸ”' });
                    zoomBtn.type = 'button';
                    zoomBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: var(--background-modifier-success); color: var(--text-on-accent); border: none; border-radius: 4px; font-size: 13px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                    // í„°ì¹˜ í”¼ë“œë°± ì¶”ê°€
                    [prevBtn, nextBtn, zoomBtn].forEach(btn => {
                        btn.addEventListener('touchstart', () => {
                            btn.style.opacity = '0.7';
                        });
                        btn.addEventListener('touchend', () => {
                            btn.style.opacity = btn.disabled ? '0.5' : '1';
                        });
                        btn.addEventListener('touchcancel', () => {
                            btn.style.opacity = btn.disabled ? '0.5' : '1';
                        });
                    });

                    const showImage = (index) => {
                        if (index < 0 || index >= totalImages) return;
                        
                        currentImageIndex = index;
                        imageDisplayArea.empty();

                        const imageLine = hintImageLines[index].trim();
                        let imageUrl = imageLine;

                        // URL ë””ì½”ë”© (ì¸ì½”ë”©ëœ ê²½ìš°)
                        if (imageUrl.includes('%')) {
                            try {
                                imageUrl = decodeURIComponent(imageUrl);
                            } catch (e) {
                                console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                            }
                        }

                        // í¬ê¸° ì •ë³´ ì¶”ì¶œ
                        let imageWidth = null;
                        const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                        if (sizeMatch) {
                            imageWidth = sizeMatch[1] + 'px';
                        }

                        // ì˜µì‹œë””ì–¸ ë‚´ë¶€ ë§í¬ ì²˜ë¦¬
                        if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                            const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                            if (wikiMatch && wikiMatch[1]) {
                                let imagePath = wikiMatch[1];
                                
                                // ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°ì™€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
                                const folderName = question.folder || 'default';
                                const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                                
                                // ì´ë¯¸ì§€ ê²½ë¡œê°€ í´ë”ëª…ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ìƒëŒ€ ê²½ë¡œ)
                                if (imagePath.startsWith(folderName + '/')) {
                                    imagePath = `${quizFolder}/${imagePath}`;
                                }
                                // ì´ë¯¸ì§€ ê²½ë¡œê°€ í€´ì¦ˆ í´ë”ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                                else if (!imagePath.startsWith(quizFolder)) {
                                    // íŒŒì¼ëª…ë§Œ ìˆëŠ” ê²½ìš°
                                    if (!imagePath.includes('/')) {
                                        imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                    }
                                }
                                
                                console.log(`ğŸ–¼ï¸ [íŒíŠ¸ ì´ë¯¸ì§€ ê²½ë¡œ] ${wikiMatch[1]} â†’ ${imagePath}`);
                                
                                // Vaultì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ì°¾ê¸°
                                const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                                
                                if (imageFile) {
                                    // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                    imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                                    console.log(`âœ… [íŒíŠ¸ ì´ë¯¸ì§€ ë°œê²¬] ${imagePath} â†’ ${imageUrl}`);
                                } else {
                                    console.warn(`âŒ [íŒíŠ¸ ì´ë¯¸ì§€ ì—†ìŒ] ${imagePath}`);
                                }
                            }
                        } else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                            const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                            if (imgMatch && imgMatch[1]) {
                                imageUrl = imgMatch[1];
                            }
                        }

                        // ëª¨ë“  ì´ë¯¸ì§€ URL ë°°ì—´ ìƒì„± (í™•ëŒ€ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
                        const allImageUrls = hintImageLines.map(line => {
                            let url = line.trim();
                            if (url.includes('[[') && url.includes(']]')) {
                                const wikiMatch = url.match(/\[\[(.+?)(\|\d+)?\]\]/);
                                if (wikiMatch && wikiMatch[1]) {
                                    let imagePath = wikiMatch[1];
                                    
                                    // ê²½ë¡œ ë³€í™˜
                                    const folderName = question.folder || 'default';
                                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                    const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                                    
                                    if (imagePath.startsWith(folderName + '/')) {
                                        imagePath = `${quizFolder}/${imagePath}`;
                                    } else if (!imagePath.startsWith(quizFolder)) {
                                        if (!imagePath.includes('/')) {
                                            imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                        }
                                    }
                                    
                                    const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                                    if (imageFile) {
                                        // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                        return this.app.vault.adapter.getResourcePath(imagePath);
                                    }
                                }
                            }
                            return url;
                        });

                        const img = imageDisplayArea.createEl('img', {
                            attr: {
                                src: imageUrl,
                                style: `max-width: 100%; width: ${imageWidth || 'auto'}; max-height: 200px; height: auto; border-radius: 6px; cursor: zoom-in; transition: transform 0.2s;`
                            }
                        });
                        
                        img.addEventListener('click', () => {
                            this.showImageZoom(imageUrl, 'íŒíŠ¸ ì´ë¯¸ì§€', allImageUrls, currentImageIndex);
                        });
                        
                        img.addEventListener('mouseenter', () => {
                            img.style.transform = 'scale(1.05)';
                        });
                        
                        img.addEventListener('mouseleave', () => {
                            img.style.transform = 'scale(1)';
                        });
                        
                        img.onerror = () => {
                            imageDisplayArea.empty();
                            imageDisplayArea.createEl('p', {
                                text: 'âš ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨',
                                attr: { style: 'color: var(--text-muted); padding: 20px; text-align: center;' }
                            });
                        };

                        // í™•ëŒ€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—…ë°ì´íŠ¸
                        zoomBtn.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.showImageZoom(imageUrl, 'íŒíŠ¸ ì´ë¯¸ì§€', allImageUrls, currentImageIndex);
                        };

                        // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
                        pageInfo.textContent = `${currentImageIndex + 1} / ${totalImages}`;
                        prevBtn.disabled = currentImageIndex === 0;
                        nextBtn.disabled = currentImageIndex === totalImages - 1;
                        
                        prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                        prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                        nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
                        nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
                    };

                    prevBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showImage(currentImageIndex - 1);
                    };
                    nextBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showImage(currentImageIndex + 1);
                    };

                    // ì´ˆê¸° ì´ë¯¸ì§€ í‘œì‹œ
                    showImage(0);
                } else {
                    // ì´ë¯¸ì§€ê°€ 1ê°œì¼ ë•Œ
                    const imageLine = hintImageLines[0].trim();
                    let imageUrl = imageLine;

                    // URL ë””ì½”ë”© (ì¸ì½”ë”©ëœ ê²½ìš°)
                    if (imageUrl.includes('%')) {
                        try {
                            imageUrl = decodeURIComponent(imageUrl);
                        } catch (e) {
                            console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                        }
                    }

                    // í¬ê¸° ì •ë³´ ì¶”ì¶œ
                    let imageWidth = null;
                    const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                    if (sizeMatch) {
                        imageWidth = sizeMatch[1] + 'px';
                    }

                    if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                        const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            // ê²½ë¡œ ë³´ì •
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            } else if (!imagePath.startsWith(quizFolder)) {
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            
                            if (imageFile) {
                                // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                            }
                        }
                    } else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                        const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                        if (imgMatch && imgMatch[1]) {
                            imageUrl = imgMatch[1];
                        }
                    }

                    // ì´ë¯¸ì§€ ë°°ì—´ ìƒì„± (1ê°œì§€ë§Œ í™•ëŒ€ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
                    const allImageUrls = [imageUrl];

                    const img = imageDisplayArea.createEl('img', {
                        attr: {
                            src: imageUrl,
                            style: `max-width: 100%; width: ${imageWidth || '400px'}; height: auto; border-radius: 6px; cursor: zoom-in; transition: transform 0.2s;`
                        }
                    });
                    
                    img.addEventListener('click', () => {
                        this.showImageZoom(imageUrl, 'íŒíŠ¸ ì´ë¯¸ì§€', allImageUrls, 0);
                    });
                    
                    img.addEventListener('mouseenter', () => {
                        img.style.transform = 'scale(1.05)';
                    });
                    
                    img.addEventListener('mouseleave', () => {
                        img.style.transform = 'scale(1)';
                    });
                    
                    img.onerror = () => {
                        imageDisplayArea.empty();
                        imageDisplayArea.createEl('p', {
                            text: 'âš ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨',
                            attr: { style: 'color: var(--text-muted); padding: 10px;' }
                        });
                    };

                    // í™•ëŒ€ ë²„íŠ¼ ì¶”ê°€ (1ê°œì¼ ë•Œë„)
                    const zoomBtnContainer = imageDisplayArea.createDiv();
                    zoomBtnContainer.style.cssText = 'display: flex; justify-content: center; margin-top: 8px;';
                    
                    const zoomBtn = zoomBtnContainer.createEl('button', { text: 'ğŸ” í™•ëŒ€' });
                    zoomBtn.type = 'button';
                    zoomBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: var(--background-modifier-success); color: var(--text-on-accent); border: none; border-radius: 4px; font-size: 13px; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';
                    
                    zoomBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.showImageZoom(imageUrl, 'íŒíŠ¸ ì´ë¯¸ì§€', allImageUrls, 0);
                    };

                    zoomBtn.addEventListener('touchstart', () => {
                        zoomBtn.style.opacity = '0.7';
                    });
                    zoomBtn.addEventListener('touchend', () => {
                        zoomBtn.style.opacity = '1';
                    });
                    zoomBtn.addEventListener('touchcancel', () => {
                        zoomBtn.style.opacity = '1';
                    });
                }
            }
            
            // ë¬¸ì œ í´ë¦­ ì‹œ íŒíŠ¸ í† ê¸€
            questionText.style.cursor = 'pointer';
            questionText.style.userSelect = 'none';
            questionText.addEventListener('click', () => {
                if (hintEl.style.display === 'none') {
                    hintEl.style.display = 'block';
                } else {
                    hintEl.style.display = 'none';
                }
            });
        }

        // ë…¸íŠ¸ ì»¨í…Œì´ë„ˆ (íŒíŠ¸ì™€ ë…ë¦½ì ìœ¼ë¡œ í‘œì‹œ)
        let noteEl = null;
        if ((question.note && question.note.trim()) || (question.noteImage && question.noteImage.trim())) {
            noteEl = questionText.createDiv({ cls: 'note-container' });
            noteEl.style.cssText = `
                position: relative;
                z-index: 999;
                background: linear-gradient(135deg, rgba(100, 149, 237, 0.15), rgba(138, 43, 226, 0.15));
                padding: ${isMobile ? '10px' : '16px'};
                margin: ${isMobile ? '10px 0' : '15px 0'};
                border-radius: 10px;
                border: 2px solid rgba(138, 43, 226, 0.4);
                box-shadow: 0 4px 15px rgba(138, 43, 226, 0.2);
                max-width: 100%;
            `;

            // ë…¸íŠ¸ í—¤ë” (ì œëª© + í† ê¸€ ë²„íŠ¼)
            const noteHeader = noteEl.createDiv();
            noteHeader.style.cssText = `
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
                cursor: pointer;
                user-select: none;
            `;

            const noteTitle = noteHeader.createEl('span', { text: 'ğŸ“ í•™ìŠµ ë…¸íŠ¸' });
            noteTitle.style.cssText = `
                font-size: 16px;
                font-weight: 700;
                color: var(--text-accent);
                background: linear-gradient(135deg, #6495ED, #8A2BE2);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            `;

            const noteToggleBtn = noteHeader.createEl('button', { text: 'â–¼' });
            noteToggleBtn.type = 'button';
            noteToggleBtn.style.cssText = `
                padding: 6px 12px;
                background: rgba(138, 43, 226, 0.3);
                color: var(--text-normal);
                border: 1px solid rgba(138, 43, 226, 0.5);
                border-radius: 6px;
                cursor: pointer;
                font-size: 12px;
                font-weight: 600;
                transition: all 0.3s ease;
                touch-action: manipulation;
                user-select: none;
                -webkit-tap-highlight-color: transparent;
            `;

            // ë…¸íŠ¸ ë‚´ìš© ì»¨í…Œì´ë„ˆ
            const noteContent = noteEl.createDiv({ cls: 'note-content-wrapper' });
            noteContent.style.cssText = `
                display: block;
                overflow: hidden;
                transition: max-height 0.3s ease, opacity 0.3s ease;
                max-height: 1000px;
                opacity: 1;
            `;

            // ë…¸íŠ¸ í…ìŠ¤íŠ¸
            if (question.note && question.note.trim()) {
                const noteTextContainer = noteContent.createDiv({ cls: 'note-text-container' });
                noteTextContainer.style.cssText = `
                    padding: 12px;
                    background: rgba(255, 255, 255, 0.08);
                    border-radius: 8px;
                    margin-bottom: 10px;
                    border-left: 4px solid rgba(138, 43, 226, 0.6);
                `;

                const noteLines = question.note.split('\n');
                
                // ì´ë¯¸ì§€ URL ìˆ˜ì§‘
                const allNoteTextImages = [];
                for (const line of noteLines) {
                    const trimmedLine = line.trim();
                    if (trimmedLine.includes('![[') && trimmedLine.includes(']]')) {
                        const wikiMatch = trimmedLine.match(/!\[\[(.+?)\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            } else if (!imagePath.startsWith(quizFolder)) {
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            if (imageFile) {
                                allNoteTextImages.push(this.app.vault.adapter.getResourcePath(imagePath));
                            }
                        }
                    }
                }

                // ë…¸íŠ¸ í…ìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ ë Œë”ë§
                let noteTextImageIndex = 0;
                for (const line of noteLines) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) continue;
                    
                    // ì´ë¯¸ì§€ ì²´í¬
                    if (trimmedLine.includes('![[') && trimmedLine.includes(']]')) {
                        const wikiMatch = trimmedLine.match(/!\[\[(.+?)\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            } else if (!imagePath.startsWith(quizFolder)) {
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            
                            if (imageFile) {
                                const imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                                const currentIndex = noteTextImageIndex;
                                const img = noteTextContainer.createEl('img', {
                                    attr: {
                                        src: imageUrl,
                                        style: 'max-width: 400px; width: 100%; height: auto; border-radius: 6px; cursor: zoom-in; margin: 10px 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);'
                                    }
                                });
                                img.addEventListener('click', () => {
                                    this.showImageZoom(imageUrl, 'ë…¸íŠ¸ ì´ë¯¸ì§€', allNoteTextImages, currentIndex);
                                });
                                noteTextImageIndex++;
                                continue;
                            }
                        }
                    }
                    
                    // ì¼ë°˜ í…ìŠ¤íŠ¸
                    const noteLine = noteTextContainer.createEl('p', { 
                        text: trimmedLine,
                        cls: 'note-text-line'
                    });
                    noteLine.style.cssText = `
                        font-size: 14.5px;
                        line-height: 1.7;
                        color: var(--text-normal);
                        margin: 6px 0;
                        white-space: pre-line;
                    `;
                }
            }

            // ë…¸íŠ¸ ì´ë¯¸ì§€ (ë‹¤ì¤‘ ì´ë¯¸ì§€ + í˜ì´ì§€ ë„˜ê¹€)
            if (question.noteImage && question.noteImage.trim()) {
                const noteImgContainer = noteContent.createDiv({ cls: 'note-image-container' });
                noteImgContainer.style.cssText = 'margin-top: 12px; display: flex; flex-direction: column; gap: 10px;';
                
                const noteImageLines = question.noteImage.split('\n').filter(line => line.trim());
                const totalImages = noteImageLines.length;
                let currentImageIndex = 0;

                const imageDisplayArea = noteImgContainer.createDiv();
                imageDisplayArea.style.cssText = 'min-height: 150px; display: flex; align-items: center; justify-content: center;';

                if (totalImages > 1) {
                    const navControls = noteImgContainer.createDiv();
                    navControls.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 10px;';

                    const prevBtn = navControls.createEl('button', { text: 'â—€' });
                    prevBtn.type = 'button';
                    prevBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: rgba(138, 43, 226, 0.7); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                    const pageInfo = navControls.createEl('span', { text: `${currentImageIndex + 1} / ${totalImages}` });
                    pageInfo.style.cssText = 'min-width: 60px; text-align: center; font-weight: 700; font-size: 14px; color: var(--text-accent);';

                    const nextBtn = navControls.createEl('button', { text: 'â–¶' });
                    nextBtn.type = 'button';
                    nextBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: rgba(138, 43, 226, 0.7); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                    const zoomBtn = navControls.createEl('button', { text: 'ğŸ”' });
                    zoomBtn.type = 'button';
                    zoomBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: rgba(100, 149, 237, 0.7); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';

                    [prevBtn, nextBtn, zoomBtn].forEach(btn => {
                        btn.addEventListener('touchstart', () => { btn.style.opacity = '0.7'; });
                        btn.addEventListener('touchend', () => { btn.style.opacity = btn.disabled ? '0.5' : '1'; });
                        btn.addEventListener('touchcancel', () => { btn.style.opacity = btn.disabled ? '0.5' : '1'; });
                    });

                    const showImage = (index) => {
                        if (index < 0 || index >= totalImages) return;
                        
                        currentImageIndex = index;
                        imageDisplayArea.empty();

                        const imageLine = noteImageLines[index].trim();
                        let imageUrl = imageLine;

                        if (imageUrl.includes('%')) {
                            try {
                                imageUrl = decodeURIComponent(imageUrl);
                            } catch (e) {
                                console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                            }
                        }

                        let imageWidth = null;
                        const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                        if (sizeMatch) {
                            imageWidth = sizeMatch[1] + 'px';
                        }

                        if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                            const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                            if (wikiMatch && wikiMatch[1]) {
                                let imagePath = wikiMatch[1];
                                const folderName = question.folder || 'default';
                                const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                                
                                if (imagePath.startsWith(folderName + '/')) {
                                    imagePath = `${quizFolder}/${imagePath}`;
                                } else if (!imagePath.startsWith(quizFolder)) {
                                    if (!imagePath.includes('/')) {
                                        imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                    }
                                }
                                
                                const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                                if (imageFile) {
                                    imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                                }
                            }
                        }

                        const allImageUrls = noteImageLines.map(line => {
                            let url = line.trim();
                            if (url.includes('[[') && url.includes(']]')) {
                                const wikiMatch = url.match(/\[\[(.+?)(\|\d+)?\]\]/);
                                if (wikiMatch && wikiMatch[1]) {
                                    let imagePath = wikiMatch[1];
                                    const folderName = question.folder || 'default';
                                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                    const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                                    
                                    if (imagePath.startsWith(folderName + '/')) {
                                        imagePath = `${quizFolder}/${imagePath}`;
                                    } else if (!imagePath.startsWith(quizFolder)) {
                                        if (!imagePath.includes('/')) {
                                            imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                        }
                                    }
                                    
                                    const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                                    if (imageFile) {
                                        return this.app.vault.adapter.getResourcePath(imagePath);
                                    }
                                }
                            }
                            return url;
                        });

                        const img = imageDisplayArea.createEl('img', {
                            attr: {
                                src: imageUrl,
                                style: `max-width: 100%; width: ${imageWidth || 'auto'}; max-height: 200px; height: auto; border-radius: 8px; cursor: zoom-in; transition: transform 0.2s; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);`
                            }
                        });
                        
                        img.addEventListener('click', () => {
                            this.showImageZoom(imageUrl, 'ë…¸íŠ¸ ì´ë¯¸ì§€', allImageUrls, currentImageIndex);
                        });
                        
                        img.addEventListener('mouseenter', () => { img.style.transform = 'scale(1.05)'; });
                        img.addEventListener('mouseleave', () => { img.style.transform = 'scale(1)'; });
                        
                        img.onerror = () => {
                            imageDisplayArea.empty();
                            imageDisplayArea.createEl('p', {
                                text: 'âš ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨',
                                attr: { style: 'color: var(--text-muted); padding: 20px; text-align: center;' }
                            });
                        };

                        zoomBtn.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.showImageZoom(imageUrl, 'ë…¸íŠ¸ ì´ë¯¸ì§€', allImageUrls, currentImageIndex);
                        };

                        pageInfo.textContent = `${currentImageIndex + 1} / ${totalImages}`;
                        prevBtn.disabled = currentImageIndex === 0;
                        nextBtn.disabled = currentImageIndex === totalImages - 1;
                        
                        prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                        prevBtn.style.cursor = prevBtn.disabled ? 'not-allowed' : 'pointer';
                        nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
                        nextBtn.style.cursor = nextBtn.disabled ? 'not-allowed' : 'pointer';
                    };

                    prevBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showImage(currentImageIndex - 1);
                    };
                    nextBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        showImage(currentImageIndex + 1);
                    };

                    showImage(0);
                } else {
                    // 1ê°œ ì´ë¯¸ì§€ì¼ ë•Œ
                    const imageLine = noteImageLines[0].trim();
                    let imageUrl = imageLine;

                    if (imageUrl.includes('%')) {
                        try {
                            imageUrl = decodeURIComponent(imageUrl);
                        } catch (e) {
                            console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                        }
                    }

                    let imageWidth = null;
                    const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                    if (sizeMatch) {
                        imageWidth = sizeMatch[1] + 'px';
                    }

                    if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                        const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            } else if (!imagePath.startsWith(quizFolder)) {
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            if (imageFile) {
                                imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                            }
                        }
                    }

                    const allImageUrls = [imageUrl];
                    const img = imageDisplayArea.createEl('img', {
                        attr: {
                            src: imageUrl,
                            style: `max-width: 100%; width: ${imageWidth || '400px'}; height: auto; border-radius: 8px; cursor: zoom-in; transition: transform 0.2s; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);`
                        }
                    });
                    
                    img.addEventListener('click', () => {
                        this.showImageZoom(imageUrl, 'ë…¸íŠ¸ ì´ë¯¸ì§€', allImageUrls, 0);
                    });
                    
                    img.addEventListener('mouseenter', () => { img.style.transform = 'scale(1.05)'; });
                    img.addEventListener('mouseleave', () => { img.style.transform = 'scale(1)'; });
                    
                    img.onerror = () => {
                        imageDisplayArea.empty();
                        imageDisplayArea.createEl('p', {
                            text: 'âš ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨',
                            attr: { style: 'color: var(--text-muted); padding: 10px;' }
                        });
                    };

                    const zoomBtnContainer = imageDisplayArea.createDiv();
                    zoomBtnContainer.style.cssText = 'display: flex; justify-content: center; margin-top: 10px;';
                    
                    const zoomBtn = zoomBtnContainer.createEl('button', { text: 'ğŸ” í™•ëŒ€' });
                    zoomBtn.type = 'button';
                    zoomBtn.style.cssText = 'padding: 8px 16px; cursor: pointer; background: rgba(100, 149, 237, 0.7); color: white; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; touch-action: manipulation; user-select: none; -webkit-tap-highlight-color: transparent;';
                    
                    zoomBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        this.showImageZoom(imageUrl, 'ë…¸íŠ¸ ì´ë¯¸ì§€', allImageUrls, 0);
                    };

                    zoomBtn.addEventListener('touchstart', () => { zoomBtn.style.opacity = '0.7'; });
                    zoomBtn.addEventListener('touchend', () => { zoomBtn.style.opacity = '1'; });
                    zoomBtn.addEventListener('touchcancel', () => { zoomBtn.style.opacity = '1'; });
                }
            }

            // í† ê¸€ ê¸°ëŠ¥
            let isNoteExpanded = true;
            const toggleNote = () => {
                isNoteExpanded = !isNoteExpanded;
                
                if (isNoteExpanded) {
                    noteContent.style.maxHeight = '1000px';
                    noteContent.style.opacity = '1';
                    noteToggleBtn.setText('â–¼');
                } else {
                    noteContent.style.maxHeight = '0';
                    noteContent.style.opacity = '0';
                    noteToggleBtn.setText('â–¶');
                }
            };

            noteHeader.addEventListener('click', toggleNote);
            noteToggleBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                toggleNote();
            });

            // í„°ì¹˜ í”¼ë“œë°±
            noteToggleBtn.addEventListener('touchstart', () => { noteToggleBtn.style.opacity = '0.7'; });
            noteToggleBtn.addEventListener('touchend', () => { noteToggleBtn.style.opacity = '1'; });
            noteToggleBtn.addEventListener('touchcancel', () => { noteToggleBtn.style.opacity = '1'; });
        }

        // ì„ íƒì§€
        const optionsContainer = scrollableContent.createDiv({ cls: 'options-container' });
        optionsContainer.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: ${isMobile ? '8px' : '12px'};
            margin-bottom: ${isMobile ? '12px' : '20px'};
            padding: 0 ${isMobile ? '12px' : '20px'};
        `;
        
        let options = [...question.options];
        
        if (this.plugin.settings.shuffleOptions) {
            // ì •ë‹µ ì¸ë±ìŠ¤ë¥¼ ì¶”ì í•˜ë©´ì„œ ì„ê¸°
            const correctAnswer = question.options[question.answer];
            options = this.shuffleArray(options);
            question.shuffledAnswerIndex = options.indexOf(correctAnswer);
        } else {
            question.shuffledAnswerIndex = question.answer;
        }

        options.forEach((option, index) => {
            const optionBtn = optionsContainer.createEl('button', {
                cls: 'option-button'
            });
            
            // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ í¬ê¸° ê°•ì œ ì ìš© - Anki ìŠ¤íƒ€ì¼
            optionBtn.style.cssText = `
                padding: ${isMobile ? '12px 16px 12px 42px' : '18px 20px 18px 50px'};
                font-size: ${isMobile ? '15px' : '17px'};
                font-weight: 400;
                text-align: left;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.15s ease;
                background: var(--background-secondary);
                border: 2px solid var(--background-modifier-border);
                min-height: ${isMobile ? '44px' : '56px'};
                width: 100%;
                box-sizing: border-box;
                display: flex;
                align-items: center;
                box-shadow: 0 1px 3px rgba(0,0,0,0.08);
                line-height: 1.4;
                position: relative;
                color: var(--text-normal);
            `;
            
            // ì„ íƒì§€ë³„ ë¶ë§ˆí¬ ë²„íŠ¼ ì¶”ê°€ (ì™¼ìª½ ìƒë‹¨)
            const originalIndex = question.options.indexOf(option);
            if (!question.optionBookmarkFolders) {
                question.optionBookmarkFolders = Array(question.options.length).fill('');
            }
            const optionBookmarkFolder = question.optionBookmarkFolders[originalIndex] || '';
            const isOptionBookmarked = optionBookmarkFolder.length > 0;
            
            const bookmarkBtn = optionBtn.createEl('button', {
                text: isOptionBookmarked ? 'â­' : 'â˜†',
                cls: 'option-bookmark-button'
            });
            bookmarkBtn.title = isOptionBookmarked ? `ë¶ë§ˆí¬ë¨: ${optionBookmarkFolder}` : 'ë¶ë§ˆí¬';
            bookmarkBtn.style.cssText = `
                position: absolute;
                top: 50%;
                left: 12px;
                transform: translateY(-50%);
                padding: 4px;
                background: transparent;
                color: ${isOptionBookmarked ? 'var(--color-yellow)' : 'var(--text-faint)'};
                border: none;
                border-radius: 4px;
                font-size: 16px;
                cursor: pointer;
                transition: all 0.2s;
                z-index: 20;
                opacity: ${isOptionBookmarked ? '1' : '0.5'};
            `;
            
            bookmarkBtn.addEventListener('click', async (e) => {
                e.stopPropagation(); // ì„ íƒì§€ í´ë¦­ ë°©ì§€
                
                const currentlyBookmarked = question.optionBookmarkFolders[originalIndex];
                
                if (currentlyBookmarked) {
                    // ì´ë¯¸ ë¶ë§ˆí¬ëœ ê²½ìš° - ê´€ë¦¬ ì˜µì…˜ ì œê³µ
                    const optionModal = new Modal(this.app);
                    optionModal.titleEl.setText('â­ ë¶ë§ˆí¬ ê´€ë¦¬');
                    optionModal.contentEl.style.cssText = 'padding: 20px;';
                    
                    // í˜„ì¬ ì •ë³´ í‘œì‹œ
                    const infoDiv = optionModal.contentEl.createDiv();
                    infoDiv.style.cssText = 'padding: 12px; background: var(--background-secondary); border-radius: 6px; margin-bottom: 16px;';
                    
                    infoDiv.createEl('div', { 
                        text: `ì„ íƒì§€ ${originalIndex + 1}: ${option}`,
                    }).style.cssText = 'margin-bottom: 8px; font-weight: 600;';
                    
                    infoDiv.createEl('div', { 
                        text: `í˜„ì¬ í´ë”: ${currentlyBookmarked}`,
                    }).style.cssText = 'color: var(--text-muted); font-size: 14px;';
                    
                    optionModal.contentEl.createEl('p', { 
                        text: 'ì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                    }).style.marginBottom = '16px';
                    
                    const buttonDiv = optionModal.contentEl.createDiv();
                    buttonDiv.style.cssText = 'display: flex; flex-direction: column; gap: 10px;';
                    
                    // í´ë” ë³€ê²½ ë²„íŠ¼
                    const changeBtn = buttonDiv.createEl('button', { text: 'ğŸ“ í´ë” ë³€ê²½' });
                    changeBtn.style.cssText = 'padding: 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: 500; min-height: 44px;';
                    changeBtn.onclick = () => {
                        optionModal.close();
                        // ì„ íƒì§€ ë¶ë§ˆí¬ í´ë” ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
                        new BookmarkFolderSelectionModal(this.app, this.plugin, question, async (selectedFolder) => {
                            question.optionBookmarkFolders[originalIndex] = selectedFolder;
                            bookmarkBtn.setText('â­');
                            bookmarkBtn.title = `ë¶ë§ˆí¬ë¨: ${selectedFolder}`;
                            bookmarkBtn.style.color = 'var(--color-yellow)';
                            bookmarkBtn.style.opacity = '1';
                            await this.plugin.saveQuestion(question, false);
                            new Notice(`âœ… ì„ íƒì§€ ${originalIndex + 1}ì„(ë¥¼) [${selectedFolder}]ë¡œ ì´ë™`);
                            await this.showQuestion(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                        }, true, originalIndex).open(); // isOptionBookmark=true
                    };
                    
                    // ë¶ë§ˆí¬ í•´ì œ ë²„íŠ¼
                    const removeBtn = buttonDiv.createEl('button', { text: 'âŒ ë¶ë§ˆí¬ í•´ì œ' });
                    removeBtn.style.cssText = 'padding: 12px; background: var(--background-modifier-error); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer; font-weight: 500; min-height: 44px;';
                    removeBtn.onclick = async () => {
                        question.optionBookmarkFolders[originalIndex] = '';
                        bookmarkBtn.setText('â˜†');
                        bookmarkBtn.title = 'ë¶ë§ˆí¬';
                        bookmarkBtn.style.color = 'var(--text-faint)';
                        bookmarkBtn.style.opacity = '0.5';
                        await this.plugin.saveQuestion(question, false);
                        new Notice(`â˜† ì„ íƒì§€ ${originalIndex + 1} ë¶ë§ˆí¬ í•´ì œ`);
                        await this.showQuestion(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                        optionModal.close();
                    };
                    
                    // ì·¨ì†Œ ë²„íŠ¼
                    const cancelBtn = buttonDiv.createEl('button', { text: 'â†©ï¸ ì·¨ì†Œ' });
                    cancelBtn.style.cssText = 'padding: 12px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 4px; cursor: pointer; min-height: 44px;';
                    cancelBtn.onclick = () => optionModal.close();
                    
                    optionModal.open();
                } else {
                    // ë¶ë§ˆí¬ ì•ˆ ëœ ê²½ìš°: ì„ íƒì§€ ë¶ë§ˆí¬ í´ë” ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
                    new BookmarkFolderSelectionModal(this.app, this.plugin, question, async (selectedFolder) => {
                        question.optionBookmarkFolders[originalIndex] = selectedFolder;
                        bookmarkBtn.setText('â­');
                        bookmarkBtn.title = `ë¶ë§ˆí¬ë¨: ${selectedFolder}`;
                        bookmarkBtn.style.color = 'var(--color-yellow)';
                        bookmarkBtn.style.opacity = '1';
                        await this.plugin.saveQuestion(question, false);
                        new Notice(`âœ… ì„ íƒì§€ ${originalIndex + 1}ì„(ë¥¼) [${selectedFolder}]ì— ë¶ë§ˆí¬`);
                        await this.showQuestion(); // í™”ë©´ ìƒˆë¡œê³ ì¹¨
                    }, true, originalIndex).open(); // isOptionBookmark=true
                }
            });
            
            bookmarkBtn.addEventListener('mouseenter', () => {
                bookmarkBtn.style.opacity = '1';
            });
            bookmarkBtn.addEventListener('mouseleave', () => {
                bookmarkBtn.style.opacity = isOptionBookmarked ? '1' : '0.5';
            });
            
            // ì„ íƒì§€ ë²ˆí˜¸ í‘œì‹œ (ì™¼ìª½)
            const optionNumber = optionBtn.createSpan({
                text: `${index + 1}`,
                cls: 'option-number'
            });
            optionNumber.style.cssText = `
                position: absolute;
                left: 32px;
                font-weight: 600;
                color: var(--text-faint);
                font-size: 14px;
            `;
            
            // ì„ íƒì§€ í…ìŠ¤íŠ¸ ë¨¼ì € í‘œì‹œ
            const optionText = optionBtn.createSpan({ 
                text: option,
                cls: 'option-text'
            });
            optionText.style.cssText = `
                word-wrap: break-word;
                word-break: keep-all;
                white-space: normal;
                flex: 1;
                display: block;
                margin-left: 60px;
            `;
            
            // ì„ íƒì§€ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ "ì´ë¯¸ì§€ ë³´ê¸°" ë²„íŠ¼ í‘œì‹œ
            // originalIndexëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì„ ì–¸ë¨
            
            if (question.optionImages && question.optionImages[originalIndex] && question.optionImages[originalIndex].trim()) {
                // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ ì´ë¯¸ì§€ë“¤ ì²˜ë¦¬ (ì„ íƒì§€ë³„ë¡œ ì—¬ëŸ¬ ì´ë¯¸ì§€ ê°€ëŠ¥)
                const optionImageLines = question.optionImages[originalIndex].split('\n').filter(line => line.trim());
                
                // ì´ë¯¸ì§€ ê°œìˆ˜ í‘œì‹œ
                const imageCount = optionImageLines.length;
                const imageText = imageCount > 1 ? `ğŸ–¼ï¸ ì´ë¯¸ì§€ ${imageCount}ê°œ` : 'ğŸ–¼ï¸ ì´ë¯¸ì§€';
                
                // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ì´ë¯¸ì§€ ë²„íŠ¼ + íŒíŠ¸ ë²„íŠ¼)
                const imageBtnContainer = optionBtn.createEl('div', { cls: 'option-image-buttons' });
                imageBtnContainer.style.cssText = `
                    position: absolute;
                    top: 50%;
                    right: 12px;
                    transform: translateY(-50%);
                    display: flex;
                    gap: 6px;
                    z-index: 10;
                `;
                
                // ì´ë¯¸ì§€ ë³´ê¸° ë²„íŠ¼
                const viewImageBtn = imageBtnContainer.createEl('button', {
                    text: imageText,
                    cls: 'option-image-view-button'
                });
                viewImageBtn.type = 'button';  // ëª…ì‹œì ìœ¼ë¡œ button íƒ€ì… ì§€ì •
                viewImageBtn.style.cssText = `
                    padding: 6px 12px;
                    background: var(--interactive-accent);
                    color: var(--text-on-accent);
                    border: none;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                    white-space: nowrap;
                    touch-action: manipulation;
                    user-select: none;
                    -webkit-tap-highlight-color: transparent;
                `;
                
                // íŒíŠ¸ ë²„íŠ¼ (ì´ë¯¸ì§€ì— ëŒ€í•œ íŒíŠ¸ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ)
                if (!question.optionImageHints) {
                    question.optionImageHints = Array(question.options.length).fill('');
                }
                const optionImageHint = question.optionImageHints[originalIndex] || '';
                
                if (optionImageHint.trim()) {
                    const hintBtn = imageBtnContainer.createEl('button', {
                        text: 'ğŸ’¡',
                        cls: 'option-image-hint-button'
                    });
                    hintBtn.type = 'button';
                    hintBtn.title = 'ì´ë¯¸ì§€ íŒíŠ¸ ë³´ê¸°';
                    hintBtn.style.cssText = `
                        padding: 6px 10px;
                        background: var(--background-modifier-success);
                        color: var(--text-on-accent);
                        border: none;
                        border-radius: 4px;
                        font-size: 14px;
                        cursor: pointer;
                        transition: all 0.2s;
                        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                        touch-action: manipulation;
                        user-select: none;
                        -webkit-tap-highlight-color: transparent;
                    `;
                    
                    hintBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const hintModal = new Modal(this.app);
                        hintModal.titleEl.setText('ğŸ’¡ ì´ë¯¸ì§€ íŒíŠ¸');
                        
                        const { contentEl } = hintModal;
                        contentEl.style.padding = '20px';
                        contentEl.style.minWidth = isMobile ? '90vw' : '400px';
                        
                        contentEl.createEl('p', {
                            text: optionImageHint,
                            cls: 'image-hint-text'
                        }).style.cssText = 'font-size: 16px; line-height: 1.6; color: var(--text-normal); margin-bottom: 20px; white-space: pre-wrap;';
                        
                        const closeBtn = contentEl.createEl('button', {
                            text: 'ë‹«ê¸°',
                            cls: 'mod-cta'
                        });
                        closeBtn.style.cssText = 'width: 100%; padding: 10px; min-height: 44px;';
                        closeBtn.onclick = () => hintModal.close();
                        
                        hintModal.open();
                    };
                    
                    hintBtn.addEventListener('touchstart', () => { hintBtn.style.opacity = '0.7'; });
                    hintBtn.addEventListener('touchend', () => { hintBtn.style.opacity = '1'; });
                    hintBtn.addEventListener('touchcancel', () => { hintBtn.style.opacity = '1'; });
                }
                
                // ëª¨ë“  ì´ë¯¸ì§€ URL ë°°ì—´ ìƒì„± (í™•ëŒ€ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
                const allImageUrls = [];
                
                for (const imageLine of optionImageLines) {
                    let imageUrl = imageLine.trim();
                    
                    // URL ë””ì½”ë”© (ì¸ì½”ë”©ëœ ê²½ìš°)
                    if (imageUrl.includes('%')) {
                        try {
                            imageUrl = decodeURIComponent(imageUrl);
                        } catch (e) {
                            console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                        }
                    }
                    
                    // ì˜µì‹œë””ì–¸ ë‚´ë¶€ ë§í¬ ì²˜ë¦¬
                    if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                        const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                        if (wikiMatch && wikiMatch[1]) {
                            let imagePath = wikiMatch[1];
                            
                            // ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°ì™€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
                            const folderName = question.folder || 'default';
                            const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                            const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                            
                            // ì´ë¯¸ì§€ ê²½ë¡œê°€ í´ë”ëª…ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš° (ìƒëŒ€ ê²½ë¡œ)
                            if (imagePath.startsWith(folderName + '/')) {
                                imagePath = `${quizFolder}/${imagePath}`;
                            }
                            // ì´ë¯¸ì§€ ê²½ë¡œê°€ í€´ì¦ˆ í´ë”ë¡œ ì‹œì‘í•˜ì§€ ì•ŠëŠ” ê²½ìš°
                            else if (!imagePath.startsWith(quizFolder)) {
                                // íŒŒì¼ëª…ë§Œ ìˆëŠ” ê²½ìš°
                                if (!imagePath.includes('/')) {
                                    imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                }
                            }
                            
                            console.log(`ğŸ–¼ï¸ [ì„ íƒì§€ ì´ë¯¸ì§€ ê²½ë¡œ] ${wikiMatch[1]} â†’ ${imagePath}`);
                            
                            // Vaultì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ì°¾ê¸°
                            const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                            
                            if (imageFile) {
                                // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                imageUrl = this.app.vault.adapter.getResourcePath(imagePath);
                                console.log(`âœ… [ì„ íƒì§€ ì´ë¯¸ì§€ ë°œê²¬] ${imagePath} â†’ ${imageUrl}`);
                            } else {
                                console.warn(`âŒ [ì„ íƒì§€ ì´ë¯¸ì§€ ì—†ìŒ] ${imagePath}`);
                            }
                        }
                    }
                    // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ ë¬¸ë²• ì²˜ë¦¬
                    else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                        const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                        if (imgMatch && imgMatch[1]) {
                            imageUrl = imgMatch[1];
                        }
                    }
                    // HTML img íƒœê·¸ ì²˜ë¦¬
                    else if (imageUrl.includes('<img')) {
                        const srcMatch = imageUrl.match(/src=["'](.+?)["']/);
                        if (srcMatch && srcMatch[1]) {
                            imageUrl = srcMatch[1];
                        }
                    }
                    
                    allImageUrls.push(imageUrl);
                }
                
                // ë²„íŠ¼ í´ë¦­ ì‹œ ì²« ì´ë¯¸ì§€ë¶€í„° í™•ëŒ€ ëª¨ë‹¬ (ë„¤ë¹„ê²Œì´ì…˜ ì§€ì›)
                viewImageBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation(); // ì„ íƒì§€ í´ë¦­ ë°©ì§€
                    this.showImageZoom(allImageUrls[0], `ì„ íƒì§€ ${index + 1} ì´ë¯¸ì§€`, allImageUrls, 0);
                });
                
                // ëª¨ë°”ì¼ í„°ì¹˜ íš¨ê³¼
                viewImageBtn.addEventListener('touchstart', (e) => {
                    viewImageBtn.style.opacity = '0.7';
                }, { passive: true });
                
                viewImageBtn.addEventListener('touchend', (e) => {
                    viewImageBtn.style.opacity = '1';
                }, { passive: true });
                
                viewImageBtn.addEventListener('touchcancel', (e) => {
                    viewImageBtn.style.opacity = '1';
                }, { passive: true });
                
                // ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ (ë°ìŠ¤í¬í†±)
                viewImageBtn.addEventListener('mouseenter', () => {
                    viewImageBtn.style.background = 'var(--interactive-accent-hover)';
                });
                
                viewImageBtn.addEventListener('mouseleave', () => {
                    viewImageBtn.style.background = 'var(--interactive-accent)';
                });
            }
            
            // í˜¸ë²„ íš¨ê³¼ ì¶”ê°€
            optionBtn.addEventListener('mouseenter', () => {
                if (!optionBtn.disabled) {
                    optionBtn.style.background = 'var(--background-modifier-hover)';
                    optionBtn.style.borderColor = 'var(--interactive-accent)';
                    optionBtn.style.transform = 'translateX(4px)';
                }
            });
            
            optionBtn.addEventListener('mouseleave', () => {
                if (!optionBtn.disabled) {
                    optionBtn.style.background = 'var(--background-secondary)';
                    optionBtn.style.borderColor = 'var(--background-modifier-border)';
                    optionBtn.style.transform = 'translateX(0)';
                }
            });
            
            optionBtn.addEventListener('click', () => {
                this.selectAnswer(index, question);
            });
        });

        // ë¶ë§ˆí¬ ì²´í¬ë°•ìŠ¤ ì¶”ê°€
        const bookmarkContainer = scrollableContent.createDiv({ cls: 'bookmark-container' });
        bookmarkContainer.style.cssText = `
            display: flex;
            align-items: center;
            gap: ${isMobile ? '12px' : '10px'};
            padding: ${isMobile ? '16px 20px' : '12px 20px'};
            background: var(--background-secondary);
            border-radius: 8px;
            margin: ${isMobile ? '0 12px 16px 12px' : '0 20px 16px 20px'};
            border: 1px solid var(--background-modifier-border);
            transition: all 0.2s;
        `;

        const isBookmarked = question.bookmarked || false;

        const checkbox = bookmarkContainer.createEl('input', { type: 'checkbox' });
        checkbox.checked = isBookmarked;
        checkbox.style.cssText = `
            width: ${isMobile ? '28px' : '24px'};
            height: ${isMobile ? '28px' : '24px'};
            cursor: pointer;
            accent-color: var(--interactive-accent);
            flex-shrink: 0;
        `;

        const label = bookmarkContainer.createEl('label');
        label.style.cssText = `
            cursor: pointer;
            font-weight: 600;
            font-size: ${isMobile ? '16px' : '15px'};
            user-select: none;
            flex: 1;
            touch-action: manipulation;
        `;
        label.textContent = isBookmarked ? 'â­ ë¶ë§ˆí¬ë¨' : 'â˜† ë¶ë§ˆí¬í•˜ê¸°';

        const countBadge = bookmarkContainer.createEl('span');
        countBadge.style.cssText = `
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: bold;
        `;
        
        // ë¶ë§ˆí¬ ê°œìˆ˜ ê³„ì‚° (ë¬¸ì œ ë¶ë§ˆí¬ + ì„ íƒì§€ ë¶ë§ˆí¬)
        const bookmarkCount = this.allQuestions.filter(q => {
            if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
            if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
            return false;
        }).length;
        countBadge.textContent = `${bookmarkCount}ê°œ`;

        const toggleBookmark = async () => {
            const currentlyBookmarked = checkbox.checked;
            
            if (currentlyBookmarked) {
                // ë¶ë§ˆí¬ í´ë” ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
                new BookmarkFolderSelectionModal(this.app, this.plugin, question, async (selectedFolder) => {
                    question.bookmarkFolder = selectedFolder;
                    label.textContent = `â­ ë¶ë§ˆí¬ë¨ [${selectedFolder}]`;
                    
                    // ë¶ë§ˆí¬ ìƒíƒœë¥¼ íŒŒì¼ì— ì €ì¥
                    await this.plugin.toggleBookmark(question, selectedFolder);
                    
                    // ê°œìˆ˜ ì—…ë°ì´íŠ¸
                    const newBookmarkCount = this.allQuestions.filter(q => {
                        if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
                        if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
                        return false;
                    }).length;
                    countBadge.textContent = `${newBookmarkCount}ê°œ`;
                }).open();
            } else {
                question.bookmarkFolder = '';
                label.textContent = 'â˜† ë¶ë§ˆí¬í•˜ê¸°';
                
                // ë¶ë§ˆí¬ ìƒíƒœë¥¼ íŒŒì¼ì— ì €ì¥
                await this.plugin.toggleBookmark(question);
                
                // ê°œìˆ˜ ì—…ë°ì´íŠ¸
                const newBookmarkCount = this.allQuestions.filter(q => {
                    if (q.bookmarkFolder && q.bookmarkFolder.length > 0) return true;
                    if (q.optionBookmarkFolders && q.optionBookmarkFolders.some(f => f && f.length > 0)) return true;
                    return false;
                }).length;
                countBadge.textContent = `${newBookmarkCount}ê°œ`;
            }
        };

        checkbox.onclick = toggleBookmark;
        label.onclick = () => {
            if (!checkbox.checked) {
                checkbox.checked = true;
                toggleBookmark();
            } else {
                checkbox.checked = false;
                toggleBookmark();
            }
        };

        // í˜¸ë²„ íš¨ê³¼
        bookmarkContainer.addEventListener('mouseenter', () => {
            bookmarkContainer.style.borderColor = 'var(--interactive-accent)';
            bookmarkContainer.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        });
        bookmarkContainer.addEventListener('mouseleave', () => {
            bookmarkContainer.style.borderColor = 'var(--background-modifier-border)';
            bookmarkContainer.style.boxShadow = 'none';
        });

        // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ë“¤ (ì´ì „/ì¼ì‹œì •ì§€/ë‹¤ìŒ) - ë¶ë§ˆí¬ ì•„ë˜ì— ë°°ì¹˜
        const navControlsContainer = scrollableContent.createDiv({ cls: 'nav-controls-container' });
        navControlsContainer.style.cssText = `
            display: flex;
            justify-content: center;
            gap: ${isMobile ? '10px' : '12px'};
            padding: ${isMobile ? '12px 12px' : '16px 20px'};
            margin: ${isMobile ? '0 12px 16px 12px' : '0 20px 16px 20px'};
            background: var(--background-secondary);
            border-radius: 8px;
            border: 1px solid var(--background-modifier-border);
        `;

        // ì´ì „ ë¬¸ì œ ë²„íŠ¼
        const prevBtn = navControlsContainer.createEl('button', { 
            text: isMobile ? 'â—€' : 'â—€ ì´ì „',
            cls: 'control-button prev-button'
        });
        prevBtn.title = 'ì´ì „ ë¬¸ì œ';
        prevBtn.disabled = this.currentIndex === 0;
        prevBtn.style.cssText = `
            padding: ${isMobile ? '14px 18px' : '10px 20px'};
            background: ${prevBtn.disabled ? 'var(--background-primary)' : 'var(--interactive-normal)'};
            border: 2px solid var(--background-modifier-border);
            border-radius: 8px;
            cursor: ${prevBtn.disabled ? 'not-allowed' : 'pointer'};
            color: ${prevBtn.disabled ? 'var(--text-faint)' : 'var(--text-normal)'};
            opacity: ${prevBtn.disabled ? '0.5' : '1'};
            transition: all 0.2s;
            font-weight: 600;
            font-size: ${isMobile ? '18px' : '14px'};
            flex: ${isMobile ? '0 0 auto' : '1'};
            min-width: ${isMobile ? '50px' : 'auto'};
            min-height: ${isMobile ? '52px' : 'auto'};
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        `;
        if (!prevBtn.disabled) {
            prevBtn.onmouseenter = () => { 
                prevBtn.style.background = 'var(--interactive-hover)'; 
                prevBtn.style.transform = 'translateY(-2px)';
                prevBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            };
            prevBtn.onmouseleave = () => { 
                prevBtn.style.background = 'var(--interactive-normal)'; 
                prevBtn.style.transform = 'translateY(0)';
                prevBtn.style.boxShadow = 'none';
            };
        }
        prevBtn.onclick = () => {
            if (this.currentIndex > 0) {
                this.stopTimer();
                this.currentIndex--;
                this.showQuestion();
            }
        };

        // ì¼ì‹œì •ì§€ ë²„íŠ¼
        const pauseBtn = navControlsContainer.createEl('button', {
            text: this.isPaused ? (isMobile ? 'â–¶ï¸' : 'â–¶ï¸ ì¬ìƒ') : (isMobile ? 'â¸ï¸' : 'â¸ï¸ ì •ì§€'),
            cls: 'control-button pause-button'
        });
        pauseBtn.title = this.isPaused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
        pauseBtn.style.cssText = `
            padding: ${isMobile ? '14px 24px' : '10px 20px'};
            background: var(--interactive-accent);
            border: 2px solid var(--interactive-accent);
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-on-accent);
            transition: all 0.2s;
            font-weight: 600;
            font-size: ${isMobile ? '18px' : '14px'};
            flex: 1;
            min-height: ${isMobile ? '52px' : 'auto'};
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        `;
        pauseBtn.onmouseenter = () => { 
            pauseBtn.style.opacity = '0.9';
            pauseBtn.style.transform = 'translateY(-2px)';
            pauseBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
        };
        pauseBtn.onmouseleave = () => { 
            pauseBtn.style.opacity = '1';
            pauseBtn.style.transform = 'translateY(0)';
            pauseBtn.style.boxShadow = 'none';
        };
        pauseBtn.onclick = () => {
            this.togglePause();
            pauseBtn.setText(this.isPaused ? (isMobile ? 'â–¶ï¸' : 'â–¶ï¸ ì¬ìƒ') : (isMobile ? 'â¸ï¸' : 'â¸ï¸ ì •ì§€'));
            pauseBtn.title = this.isPaused ? 'ì¬ê°œ' : 'ì¼ì‹œì •ì§€';
        };
        this.pauseButton = pauseBtn;

        // ë‹¤ìŒ ë¬¸ì œ ë²„íŠ¼
        const nextBtn = navControlsContainer.createEl('button', {
            text: isMobile ? 'â–¶' : 'ë‹¤ìŒ â–¶',
            cls: 'control-button next-button'
        });
        nextBtn.title = 'ë‹¤ìŒ ë¬¸ì œ';
        nextBtn.disabled = this.currentIndex >= this.questions.length - 1;
        nextBtn.style.cssText = `
            padding: ${isMobile ? '14px 18px' : '10px 20px'};
            background: ${nextBtn.disabled ? 'var(--background-primary)' : 'var(--interactive-normal)'};
            border: 2px solid var(--background-modifier-border);
            border-radius: 8px;
            cursor: ${nextBtn.disabled ? 'not-allowed' : 'pointer'};
            color: ${nextBtn.disabled ? 'var(--text-faint)' : 'var(--text-normal)'};
            opacity: ${nextBtn.disabled ? '0.5' : '1'};
            transition: all 0.2s;
            font-weight: 600;
            font-size: ${isMobile ? '18px' : '14px'};
            flex: ${isMobile ? '0 0 auto' : '1'};
            min-width: ${isMobile ? '50px' : 'auto'};
            min-height: ${isMobile ? '52px' : 'auto'};
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        `;
        if (!nextBtn.disabled) {
            nextBtn.onmouseenter = () => { 
                nextBtn.style.background = 'var(--interactive-hover)'; 
                nextBtn.style.transform = 'translateY(-2px)';
                nextBtn.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
            };
            nextBtn.onmouseleave = () => { 
                nextBtn.style.background = 'var(--interactive-normal)'; 
                nextBtn.style.transform = 'translateY(0)';
                nextBtn.style.boxShadow = 'none';
            };
        }
        nextBtn.onclick = () => {
            if (this.currentIndex < this.questions.length - 1) {
                this.stopTimer();
                this.currentIndex++;
                this.showQuestion();
            }
        };

        // ì•¡ì…˜ ë²„íŠ¼ ë°” (ì¢…ë£Œë§Œ)
        const actionBar = contentEl.createDiv({ cls: 'action-bar' });
        actionBar.style.cssText = `
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            margin-top: auto;
            position: sticky;
            bottom: 0;
            background: var(--background-primary);
            border-top: 1px solid var(--background-modifier-border);
            z-index: 10;
            justify-content: center;
        `;
        
        // ì¢…ë£Œ ë²„íŠ¼
        const quitBtn = actionBar.createEl('button', { 
            text: 'âœ• ì¢…ë£Œ',
            cls: 'action-button quit-button'
        });
        quitBtn.style.cssText = `
            padding: 10px 24px;
            font-size: 15px;
            background: var(--background-secondary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-normal);
            transition: all 0.2s;
        `;
        quitBtn.onmouseenter = () => { quitBtn.style.background = 'var(--background-modifier-error)'; quitBtn.style.color = 'var(--text-on-accent)'; };
        quitBtn.onmouseleave = () => { quitBtn.style.background = 'var(--background-secondary)'; quitBtn.style.color = 'var(--text-normal)'; };
        quitBtn.addEventListener('click', () => {
            this.confirmExit();
        });
    }
    
    confirmExit() {
        const confirmModal = new Modal(this.app);
        confirmModal.titleEl.setText('â“ í€´ì¦ˆ ë‚˜ê°€ê¸°');
        
        const { contentEl } = confirmModal;
        contentEl.style.padding = '20px';
        contentEl.style.textAlign = 'center';
        
        contentEl.createEl('p', {
            text: 'í€´ì¦ˆë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            cls: 'confirm-message'
        }).style.cssText = 'font-size: 16px; margin-bottom: 20px; color: var(--text-normal);';
        
        const btnContainer = contentEl.createDiv({ cls: 'confirm-buttons' });
        btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
        
        // í´ë” ê´€ë¦¬ë¡œ ì´ë™
        const toFolderBtn = btnContainer.createEl('button', {
            text: 'ğŸ“ í´ë” ê´€ë¦¬',
            cls: 'mod-cta'
        });
        toFolderBtn.style.padding = '10px 20px';
        toFolderBtn.addEventListener('click', () => {
            confirmModal.close();
            this.stopTimer();
            // QuizModalì€ ìœ ì§€í•˜ê³  í´ë” ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
            this.showFolderSelection();
        });
        
        // ì™„ì „íˆ ë‚˜ê°€ê¸°
        const exitBtn = btnContainer.createEl('button', {
            text: 'ğŸšª ì™„ì „íˆ ë‚˜ê°€ê¸°'
        });
        exitBtn.style.padding = '10px 20px';
        exitBtn.addEventListener('click', () => {
            confirmModal.close();
            this.stopTimer();
            this.isExiting = true;  // ì‹¤ì œ ì¢…ë£Œ í”Œë˜ê·¸ ì„¤ì •
            this.close();
            // ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            this.plugin.openDashboard();
        });
        
        // ì·¨ì†Œ
        const cancelBtn = btnContainer.createEl('button', {
            text: 'â†©ï¸ ê³„ì†í•˜ê¸°'
        });
        cancelBtn.style.padding = '10px 20px';
        cancelBtn.addEventListener('click', () => {
            confirmModal.close();
        });
        
        confirmModal.open();
    }
    
    showFolderSelection() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('quiz-play-modal');
        
        // í´ë” ì„ íƒ UI ë Œë”ë§ (FolderSelectionModalê³¼ ìœ ì‚¬í•˜ê²Œ)
        contentEl.createEl('h2', { text: 'ğŸ“ í´ë” ì„ íƒ' });
        
        const folderList = contentEl.createDiv({ cls: 'folder-list' });
        folderList.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        `;
        
        const folders = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        
        // ë¶ë§ˆí¬ í´ë”ë¥¼ ë§¨ ì•ì— ì¶”ê°€
        const allFolders = [];
        const bookmarkFolderName = this.plugin.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬';
        allFolders.push({
            name: bookmarkFolderName,
            path: bookmarkFolderName,
            isBookmarkFolder: true
        });
        
        // ì¼ë°˜ í´ë”ë“¤ ì¶”ê°€
        folders.forEach(folder => {
            allFolders.push({
                name: folder,
                path: folder,
                isBookmarkFolder: false
            });
        });
        
        allFolders.forEach(folder => {
            const folderRow = folderList.createDiv({ cls: 'folder-row', attr: { style: 'display: flex; align-items: center; gap: 8px;' } });

            // í´ë” ì„ íƒ ë²„íŠ¼
            const folderBtn = folderRow.createEl('button', {
                text: folder.isBookmarkFolder ? `â­ ${folder.name}` : `ğŸ“ ${folder.name}`,
                cls: 'folder-select-button'
            });
            folderBtn.style.cssText = `
                padding: 15px;
                font-size: 16px;
                cursor: pointer;
                background: ${folder.isBookmarkFolder ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'var(--interactive-normal)'};
                border: 1px solid ${folder.isBookmarkFolder ? '#FF8C00' : 'var(--background-modifier-border)'};
                border-radius: 8px;
                transition: all 0.2s;
                color: ${folder.isBookmarkFolder ? '#000000' : 'var(--text-normal)'};
                font-weight: ${folder.isBookmarkFolder ? 'bold' : 'normal'};
            `;
            folderBtn.addEventListener('mouseenter', () => {
                folderBtn.style.background = folder.isBookmarkFolder ? 'linear-gradient(135deg, #FFA500, #FF8C00)' : 'var(--interactive-hover)';
            });
            folderBtn.addEventListener('mouseleave', () => {
                folderBtn.style.background = folder.isBookmarkFolder ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'var(--interactive-normal)';
            });
            folderBtn.addEventListener('click', async () => {
                await this.startQuizFromFolder(folder.name);
            });

            // [íƒìƒ‰ê¸°ì—ì„œ ë³´ê¸°] ë²„íŠ¼ (ë¶ë§ˆí¬ í´ë”ëŠ” ì œì™¸)
            if (!folder.isBookmarkFolder) {
                const explorerBtn = folderRow.createEl('button', {
                    text: 'íƒìƒ‰',
                    cls: 'explorer-btn'
                });
                explorerBtn.style.cssText = `padding: 8px 12px; font-size: 13px; background: var(--background-secondary-alt); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; color: var(--text-normal);`;
                explorerBtn.addEventListener('click', (evt) => {
                    evt.stopPropagation();
                    const folderPath = `${this.plugin.settings.questionsFolder}/${folder.name}`;
                    const folderAbstract = this.app.vault.getAbstractFileByPath(folderPath);
                    if (folderAbstract && folderAbstract.children) {
                        // í´ë” ë‚´ ì²« .md íŒŒì¼ì„ íƒìƒ‰ê¸°ì— reveal (í´ë” ìì²´ reveal ë¶ˆê°€ ì‹œ)
                        const mdFile = folderAbstract.children.find(f => f.extension === 'md');
                        if (mdFile) {
                            const explorer = this.app.workspace.getLeavesOfType('file-explorer')[0];
                            if (explorer && explorer.view && explorer.view.revealInFolder) {
                                explorer.view.revealInFolder(mdFile);
                            } else {
                                new Notice('âŒ íŒŒì¼ íƒìƒ‰ê¸° ë·°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        } else {
                            new Notice('âŒ í´ë” ë‚´ .md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        new Notice(`âŒ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${folderPath}`);
                    }
                });

                // [í´ë” í­ì‚¬] ë²„íŠ¼
                const explodeBtn = folderRow.createEl('button', {
                    text: 'í­ì‚¬',
                    cls: 'explode-btn'
                });
                explodeBtn.style.cssText = `padding: 8px 12px; font-size: 13px; background: var(--background-secondary-alt); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; color: var(--text-normal);`;
                explodeBtn.addEventListener('click', async (evt) => {
                    evt.stopPropagation();
                    const folderPath = `${this.plugin.settings.questionsFolder}/${folder.name}`;
                    const folderAbstract = this.app.vault.getAbstractFileByPath(folderPath);
                    if (folderAbstract && folderAbstract.children) {
                        const mdFiles = folderAbstract.children.filter(f => f.extension === 'md');
                        let msg = `ğŸ“‚ ${folder.name} í´ë”ì˜ .md íŒŒì¼ ëª©ë¡:\n`;
                        mdFiles.forEach(f => { msg += `- ${f.name}\n`; });
                        new Notice(msg);
                    } else {
                        new Notice(`âŒ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ .md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: ${folderPath}`);
                    }
                });

                // [ì´ë¦„ ë³€ê²½] ë²„íŠ¼
                const renameBtn = folderRow.createEl('button', {
                    text: 'ì´ë¦„ë³€ê²½',
                    cls: 'rename-btn'
                });
                renameBtn.style.cssText = `padding: 8px 12px; font-size: 13px; background: var(--background-secondary-alt); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; color: var(--text-normal);`;
                renameBtn.addEventListener('click', async (evt) => {
                    evt.stopPropagation();
                    new TextInputModal(this.app, 'ğŸ“ í´ë” ì´ë¦„ ë³€ê²½', 'ìƒˆ í´ë” ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', folder.name, async (newName) => {
                        if (newName && newName !== folder.name) {
                            const folderPath = `${this.plugin.settings.questionsFolder}/${folder.name}`;
                            const newFolderPath = `${this.plugin.settings.questionsFolder}/${newName}`;
                            try {
                                await this.app.vault.adapter.rename(folderPath, newFolderPath);
                                new Notice(`âœ… í´ë” ì´ë¦„ ë³€ê²½: ${folder.name} â†’ ${newName}`);
                                // í´ë” ëª©ë¡ ê°±ì‹  í•„ìš”
                                this.plugin.settings.questionFolders = this.plugin.settings.questionFolders.map(f => f === folder.name ? newName : f);
                                await this.plugin.saveSettings();
                                this.showFolderSelection();
                            } catch (err) {
                                new Notice(`âŒ í´ë” ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨: ${err}`);
                            }
                        }
                    }).open();
                });

                // [ì‚­ì œ] ë²„íŠ¼
                const deleteBtn = folderRow.createEl('button', {
                    text: 'ì‚­ì œ',
                    cls: 'delete-btn'
                });
                deleteBtn.style.cssText = `padding: 8px 12px; font-size: 13px; background: var(--background-secondary-alt); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; color: var(--text-normal);`;
                deleteBtn.addEventListener('click', async (evt) => {
                    evt.stopPropagation();
                    if (confirm(`ì •ë§ë¡œ í´ë” "${folder.name}"ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        const folderPath = `${this.plugin.settings.questionsFolder}/${folder.name}`;
                        try {
                            await this.app.vault.adapter.rmdir(folderPath, true);
                            new Notice(`âœ… í´ë” ì‚­ì œ: ${folder.name}`);
                            this.plugin.settings.questionFolders = this.plugin.settings.questionFolders.filter(f => f !== folder.name);
                            await this.plugin.saveSettings();
                            this.showFolderSelection();
                        } catch (err) {
                            new Notice(`âŒ í´ë” ì‚­ì œ ì‹¤íŒ¨: ${err}`);
                        }
                    }
                });

                // [.md íŒŒì¼ íƒìƒ‰] ë²„íŠ¼
                const mdSearchBtn = folderRow.createEl('button', {
                    text: '.md íƒìƒ‰',
                    cls: 'md-search-btn'
                });
                mdSearchBtn.style.cssText = `padding: 8px 12px; font-size: 13px; background: var(--background-secondary-alt); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; color: var(--text-normal);`;
                mdSearchBtn.addEventListener('click', async (evt) => {
                    evt.stopPropagation();
                    const folderPath = `${this.plugin.settings.questionsFolder}/${folder.name}`;
                    const folderAbstract = this.app.vault.getAbstractFileByPath(folderPath);
                    if (folderAbstract && folderAbstract.children) {
                        const mdFiles = folderAbstract.children.filter(f => f.extension === 'md');
                        if (mdFiles.length === 0) {
                            new Notice(`âŒ .md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: ${folderPath}`);
                            return;
                        }
                        let msg = `ğŸ“‚ ${folder.name} í´ë”ì˜ .md íŒŒì¼ íƒìƒ‰:\n`;
                        mdFiles.forEach(f => {
                            msg += `- ${f.name} [íƒìƒ‰ê¸°ì—ì„œ ë³´ê¸°]\n`;
                        });
                        new Notice(msg);
                    } else {
                        new Notice(`âŒ í´ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ .md íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤: ${folderPath}`);
                    }
                });
            }
        });
        
        // ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
        const backBtn = contentEl.createEl('button', {
            text: 'â† ëŒ€ì‹œë³´ë“œ',
            cls: 'back-button'
        });
        backBtn.style.cssText = 'margin-top: 20px; padding: 10px 20px;';
        backBtn.addEventListener('click', () => {
            this.close();
            new DashboardModal(this.app, this.plugin).open();
        });
    }
    
    async startQuizFromFolder(folder) {
        // í´ë”ì˜ ë¬¸ì œ ë¡œë“œ
        const questions = await this.plugin.getQuestionsByFolder(folder);
        
        console.log(`ğŸ“‚ í´ë” "${folder}" ë¬¸ì œ ë¡œë“œ:`, questions.length, 'ê°œ');
        
        if (questions.length === 0) {
            new Notice(`âŒ ${folder} í´ë”ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        // í€´ì¦ˆ ì´ˆê¸°í™”
        this.questions = this.shuffleArray([...questions]);
        this.allQuestions = [...this.questions];
        this.currentIndex = 0;
        this.score = 0;
        this.results = [];
        this.startTime = Date.now();
        
        console.log('í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ, ë¬¸ì œ í‘œì‹œ ì‹œì‘');
        
        // ë¬¸ì œ í‘œì‹œ
        const { contentEl } = this;
        contentEl.empty();
        this.showQuestion();
    }

    startTimer() {
        if (!this.plugin.settings.enableTimer || this.isPaused) return;

        this.timeRemaining = this.plugin.settings.timerPerQuestion;
        this.updateTimer();

        this.timerInterval = setInterval(() => {
            if (!this.isPaused) {
                this.timeRemaining--;
                this.updateTimer();

                if (this.timeRemaining <= 0) {
                    this.stopTimer();
                    this.selectAnswer(-1, this.questions[this.currentIndex]);
                }
            }
        }, 1000);
    }

    stopTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
    }

    togglePause() {
        this.isPaused = !this.isPaused;
        
        if (this.isPaused) {
            this.pausedTime = this.timeRemaining;
            // ì•Œë¦¼ ì œê±° - UI ë²„íŠ¼ ìƒíƒœë¡œ ì¶©ë¶„íˆ í‘œì‹œë¨
        } else {
            this.timeRemaining = this.pausedTime;
            // ì•Œë¦¼ ì œê±° - UI ë²„íŠ¼ ìƒíƒœë¡œ ì¶©ë¶„íˆ í‘œì‹œë¨
        }
    }

    openSettings() {
        this.isPaused = true;
        if (this.pauseButton) {
            this.pauseButton.setText('â–¶ï¸ ì¬ê°œ');
        }
        
        const settingsModal = new Modal(this.app);
        settingsModal.titleEl.setText('âš™ï¸ í€´ì¦ˆ ì„¤ì •');
        
        const { contentEl } = settingsModal;
        contentEl.style.padding = '20px';
        contentEl.style.minWidth = '400px';

        // íƒ€ì´ë¨¸ ì„¤ì •
        contentEl.createEl('h3', { text: 'â±ï¸ íƒ€ì´ë¨¸ ì„¤ì •' });
        
        const timerSetting = contentEl.createDiv({ cls: 'setting-item' });
        timerSetting.createEl('div', { text: 'íƒ€ì´ë¨¸ ì‚¬ìš©', cls: 'setting-item-name' });
        const timerToggle = timerSetting.createEl('input', { type: 'checkbox' });
        timerToggle.checked = this.plugin.settings.enableTimer;
        timerToggle.onchange = async () => {
            this.plugin.settings.enableTimer = timerToggle.checked;
            await this.plugin.saveSettings();
        };

        const timeSetting = contentEl.createDiv({ cls: 'setting-item' });
        timeSetting.createEl('div', { text: 'ë¬¸ì œë‹¹ ì‹œê°„ (ì´ˆ)', cls: 'setting-item-name' });
        const timeInput = timeSetting.createEl('input', { type: 'number', value: this.plugin.settings.timerPerQuestion });
        timeInput.style.width = '80px';
        timeInput.onchange = async () => {
            this.plugin.settings.timerPerQuestion = parseInt(timeInput.value) || 30;
            await this.plugin.saveSettings();
        };

        // íŒíŠ¸ ì„¤ì •
        contentEl.createEl('h3', { text: 'ğŸ’¡ íŒíŠ¸ ì„¤ì •' });
        
        const hintSetting = contentEl.createDiv({ cls: 'setting-item' });
        hintSetting.createEl('div', { text: 'ì˜¤ë‹µ ì‹œ íŒíŠ¸ í‘œì‹œ', cls: 'setting-item-name' });
        const hintToggle = hintSetting.createEl('input', { type: 'checkbox' });
        hintToggle.checked = this.plugin.settings.showHintAfterWrong;
        hintToggle.onchange = async () => {
            this.plugin.settings.showHintAfterWrong = hintToggle.checked;
            await this.plugin.saveSettings();
        };

        // ë²„íŠ¼
        const btnContainer = contentEl.createDiv({ cls: 'modal-button-container' });
        btnContainer.style.marginTop = '20px';
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'flex-end';

        // í´ë” íƒìƒ‰ ë²„íŠ¼ ì¶”ê°€
        const folderManageBtn = btnContainer.createEl('button', { text: 'í´ë” íƒìƒ‰', cls: 'mod-cta' });
        folderManageBtn.onclick = () => {
            settingsModal.close();
            this.showFolderSelection();
        };

        const closeBtn = btnContainer.createEl('button', { text: 'ë‹«ê¸°', cls: 'mod-cta' });
        closeBtn.onclick = () => {
            settingsModal.close();
            this.isPaused = false;
            if (this.pauseButton) {
                this.pauseButton.setText('â¸ï¸ ì¼ì‹œì •ì§€');
            }
        };

        settingsModal.open();
    }

    updateTimer() {
        if (this.timerFill && this.timerText && this.timerContainer) {
            const totalTime = this.plugin.settings.timerPerQuestion;
            const percentage = (this.timeRemaining / totalTime) * 100;
            
            this.timerFill.style.width = `${percentage}%`;
            this.timerText.setText(`${this.timeRemaining}ì´ˆ`);
            
            // ìƒíƒœë³„ ìŠ¤íƒ€ì¼ ì ìš©
            this.timerContainer.removeClass('timer-warning', 'timer-expired');
            
            if (this.timeRemaining <= 5 && this.timeRemaining > 0) {
                this.timerContainer.addClass('timer-warning');
            } else if (this.timeRemaining <= 0) {
                this.timerContainer.addClass('timer-expired');
            }
        }
    }

    async selectAnswer(selectedIndex, question) {
        console.log("=" .repeat(60));
        console.log("ğŸ¯ selectAnswer í˜¸ì¶œë¨");
        console.log(`  selectedIndex: ${selectedIndex}`);
        
        // ì•ˆì „ì¥ì¹˜: questionì´ undefinedì¸ ê²½ìš°
        if (!question) {
            console.error("âŒ questionì´ undefinedì…ë‹ˆë‹¤!");
            console.error(`  currentIndex: ${this.currentIndex}`);
            console.error(`  questions ê¸¸ì´: ${this.questions?.length}`);
            new Notice("âŒ ì˜¤ë¥˜: ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
            return;
        }
        
        console.log(`  question.shuffledAnswerIndex: ${question.shuffledAnswerIndex}`);
        console.log(`  question.answer: ${question.answer}`);
        console.log(`  question.hanzi: ${question.hanzi}`);
        console.log("=" .repeat(60));
        
        this.stopTimer();

        const isCorrect = selectedIndex === question.shuffledAnswerIndex;
        
        console.log(`  ì •ë‹µ ì—¬ë¶€: ${isCorrect}`);
        
        if (isCorrect) {
            this.score++;
        }

        this.results.push({
            hanzi: question.hanzi,
            question: question.question,
            isCorrect: isCorrect,
            selectedAnswer: selectedIndex >= 0 ? question.options[selectedIndex] : 'ì‹œê°„ ì´ˆê³¼',
            correctAnswer: question.options[question.answer],
            folder: question.folder || 'ê¸°ë³¸',
            time: 0
        });

        await this.plugin.updateQuestionStats(question, isCorrect);

        // í”¼ë“œë°± í‘œì‹œ
        await this.showFeedback(isCorrect, question);
    }

    async showFeedback(isCorrect, question) {
        const { contentEl } = this;
        
        const feedback = contentEl.createDiv({ cls: 'feedback-overlay' });
        feedback.style.position = 'fixed';
        feedback.style.top = '50%';
        feedback.style.left = '50%';
        feedback.style.transform = 'translate(-50%, -50%)';
        feedback.style.width = '90%';
        feedback.style.maxWidth = '500px';
        feedback.style.maxHeight = '80vh';
        feedback.style.overflow = 'auto';
        feedback.style.backgroundColor = isCorrect ? 'rgba(76, 175, 80, 0.98)' : 'rgba(244, 67, 54, 0.98)';
        feedback.style.display = 'flex';
        feedback.style.flexDirection = 'column';
        feedback.style.alignItems = 'center';
        feedback.style.justifyContent = 'center';
        feedback.style.color = 'white';
        feedback.style.zIndex = '1000';
        feedback.style.padding = '30px 20px';
        feedback.style.borderRadius = '15px';
        feedback.style.boxShadow = '0 10px 40px rgba(0,0,0,0.3)';

        const icon = feedback.createEl('div', { 
            text: isCorrect ? 'âœ…' : 'âŒ',
            cls: 'feedback-icon'
        });
        icon.style.fontSize = '50px';
        icon.style.marginBottom = '15px';

        const message = feedback.createEl('h2', { 
            text: isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'í‹€ë ¸ìŠµë‹ˆë‹¤!'
        });
        message.style.fontSize = '24px';
        message.style.marginBottom = '10px';

        if (!isCorrect && (question.hint || question.hintImage) && this.plugin.settings.showHintAfterWrong) {
            const hintContainer = feedback.createDiv({ cls: 'feedback-hint-container' });
            hintContainer.style.marginTop = '15px';
            hintContainer.style.padding = '12px';
            hintContainer.style.backgroundColor = 'rgba(0,0,0,0.3)';
            hintContainer.style.borderRadius = '8px';
            hintContainer.style.maxWidth = '400px';
            
            if (question.hint && question.hint.trim()) {
                hintContainer.createEl('p', { 
                    text: `ğŸ’¡ íŒíŠ¸: ${question.hint}`
                });
            }
            
            // íŒíŠ¸ ì´ë¯¸ì§€
            if (question.hintImage && question.hintImage.trim()) {
                const hintImg = hintContainer.createEl('img', {
                    attr: { src: question.hintImage, alt: 'íŒíŠ¸ ì´ë¯¸ì§€' }
                });
                hintImg.style.maxWidth = '100%';
                hintImg.style.marginTop = '10px';
                hintImg.style.borderRadius = '4px';
            }
        }

        if (!isCorrect) {
            const correctAnswerText = feedback.createEl('p', { 
                text: `ì •ë‹µ: ${question.options[question.answer]}`
            });
            correctAnswerText.style.fontSize = '16px';
            correctAnswerText.style.marginTop = '10px';
            correctAnswerText.style.fontWeight = 'bold';
        }

        // ì •ë‹µ/ì˜¤ë‹µ ëª¨ë‘ ë…¸íŠ¸ í† ê¸€ ë²„íŠ¼
        console.log('ğŸ“ [ë…¸íŠ¸ ì²´í¬]', {
            hasNote: !!(question.note && question.note.trim()),
            hasNoteImage: !!(question.noteImage && question.noteImage.trim()),
            note: question.note,
            noteImage: question.noteImage
        });
        if ((question.note && question.note.trim()) || (question.noteImage && question.noteImage.trim())) {
            const noteToggleBtn = feedback.createEl('button', { text: 'ğŸ“ ë…¸íŠ¸ ë³´ê¸°' });
            noteToggleBtn.style.cssText = `
                margin-top: 15px;
                padding: 10px 20px;
                font-size: 14px;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-radius: 15px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.2s;
                touch-action: manipulation;
                -webkit-tap-highlight-color: rgba(255,255,255,0.1);
            `;
            
            let noteSection = null;
            
            const handleNoteToggle = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                if (noteSection) {
                    noteSection.remove();
                    noteSection = null;
                    noteToggleBtn.setText('ğŸ“ ë…¸íŠ¸ ë³´ê¸°');
                } else {
                    noteSection = feedback.createDiv({ cls: 'quiz-note-section' });
                    noteSection.style.cssText = `
                        margin: 15px 0 0 0;
                        padding: 18px;
                        background: rgba(255, 255, 255, 0.15);
                        border-radius: 10px;
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
                        max-width: 400px;
                    `;
                    
                    const noteTitle = noteSection.createEl('div', { text: 'ğŸ“ ë…¸íŠ¸' });
                    noteTitle.style.cssText = `
                        font-size: 16px;
                        font-weight: 600;
                        color: white;
                        margin-bottom: 8px;
                    `;
                    
                    if (question.note && question.note.trim()) {
                        const noteContent = noteSection.createEl('div', { text: question.note });
                        noteContent.style.cssText = `
                            font-size: 15px;
                            color: white;
                            white-space: pre-line;
                            line-height: 1.6;
                            margin-bottom: 8px;
                        `;
                    }
                    
                    if (question.noteImage && question.noteImage.trim()) {
                        const noteImgContainer = noteSection.createDiv();
                        noteImgContainer.style.marginTop = '10px';
                        
                        const noteImageLines = question.noteImage.split('\n').filter(line => line.trim());
                        noteImageLines.forEach(imageLine => {
                            let imageUrl = imageLine.trim();
                            
                            if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                                const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                                if (wikiMatch && wikiMatch[1]) {
                                    let imagePath = wikiMatch[1];
                                    
                                    // ì ˆëŒ€ ê²½ë¡œì¸ ê²½ìš°ì™€ ìƒëŒ€ ê²½ë¡œì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
                                    const folderName = question.folder || 'default';
                                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                    const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz';
                                    
                                    // ë‘ ê°€ì§€ ê²½ë¡œ ì‹œë„
                                    let imagePath1, imagePath2;
                                    
                                    if (imagePath.startsWith(folderName + '/')) {
                                        imagePath1 = `${quizFolder}/Questions/${imagePath}`;
                                        imagePath2 = `${quizFolder}/${imagePath}`;
                                    } else if (!imagePath.startsWith(quizFolder)) {
                                        if (!imagePath.includes('/')) {
                                            imagePath1 = `${quizFolder}/Questions/${folderName}/${attachmentFolderName}/${imagePath}`;
                                            imagePath2 = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                        } else {
                                            imagePath1 = `${quizFolder}/Questions/${imagePath}`;
                                            imagePath2 = `${quizFolder}/${imagePath}`;
                                        }
                                    } else {
                                        imagePath1 = imagePath;
                                        imagePath2 = imagePath;
                                    }
                                    
                                    let imageFile = this.app.vault.getAbstractFileByPath(imagePath1);
                                    let finalPath = imagePath1;
                                    
                                    if (!imageFile) {
                                        imageFile = this.app.vault.getAbstractFileByPath(imagePath2);
                                        finalPath = imagePath2;
                                    }
                                    
                                    console.log(`ğŸ–¼ï¸ [ì •ë‹µ-ë…¸íŠ¸ ì´ë¯¸ì§€ ê²½ë¡œ] ${wikiMatch[1]} â†’ ${finalPath}`);
                                    
                                    if (imageFile) {
                                        // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                        imageUrl = this.app.vault.adapter.getResourcePath(finalPath);
                                        console.log(`âœ… [ì •ë‹µ-ë…¸íŠ¸ ì´ë¯¸ì§€ ë°œê²¬] ${finalPath} â†’ ${imageUrl}`);
                                    } else {
                                        console.warn(`âŒ [ì •ë‹µ-ë…¸íŠ¸ ì´ë¯¸ì§€ ì—†ìŒ] ê²½ë¡œ1: ${imagePath1}, ê²½ë¡œ2: ${imagePath2}`);
                                    }
                                }
                            }
                            
                            const noteImg = noteImgContainer.createEl('img', {
                                attr: { src: imageUrl, alt: 'ë…¸íŠ¸ ì´ë¯¸ì§€' }
                            });
                            noteImg.style.cssText = `
                                max-width: 100%;
                                border-radius: 6px;
                                margin-top: 8px;
                                cursor: zoom-in;
                            `;
                            noteImg.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                this.showImageZoom(imageUrl, 'ë…¸íŠ¸ ì´ë¯¸ì§€', [imageUrl], 0);
                            });
                        });
                    }
                    
                    // ë²„íŠ¼ ë°”ë¡œ ë’¤ì— ë…¸íŠ¸ ì„¹ì…˜ ì‚½ì…
                    noteToggleBtn.after(noteSection);
                    noteToggleBtn.setText('ğŸ“ ë…¸íŠ¸ ë‹«ê¸°');
                }
            };
            
            noteToggleBtn.addEventListener('click', handleNoteToggle);
            noteToggleBtn.addEventListener('touchend', handleNoteToggle);
        }
            
        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆë¥¼ ë¨¼ì € ìƒì„±
        const btnContainer = feedback.createDiv({ cls: 'feedback-buttons' });
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'center';
        btnContainer.style.marginTop = '20px';
        btnContainer.style.flexWrap = 'wrap';

        // "ë‹¤ì‹œí’€ê¸°" ë²„íŠ¼ (í•­ìƒ í‘œì‹œ)
        const retryBtn = btnContainer.createEl('button', {
            text: 'ğŸ”„ ë‹¤ì‹œí’€ê¸°',
            cls: 'retry-button'
        });
        retryBtn.style.padding = '12px 25px';
        retryBtn.style.fontSize = '16px';
        retryBtn.style.backgroundColor = 'white';
        retryBtn.style.color = '#ff9800';
        retryBtn.style.border = 'none';
        retryBtn.style.borderRadius = '20px';
        retryBtn.style.cursor = 'pointer';
        retryBtn.style.fontWeight = 'bold';
        
        retryBtn.addEventListener('click', () => {
            feedback.remove();
            this.showQuestion();
        });

        // "ë…¸íŠ¸ í¸ì§‘" ë²„íŠ¼ ì¶”ê°€
        const editNoteBtn = btnContainer.createEl('button', {
            text: 'ğŸ“ ë…¸íŠ¸ í¸ì§‘',
            cls: 'edit-note-button'
        });
        editNoteBtn.style.padding = '12px 25px';
        editNoteBtn.style.fontSize = '16px';
        editNoteBtn.style.backgroundColor = 'white';
        editNoteBtn.style.color = '#2196F3';
        editNoteBtn.style.border = 'none';
        editNoteBtn.style.borderRadius = '20px';
        editNoteBtn.style.cursor = 'pointer';
        editNoteBtn.style.fontWeight = 'bold';
        editNoteBtn.style.touchAction = 'manipulation';
        editNoteBtn.style.webkitTapHighlightColor = 'rgba(0,0,0,0.1)';
        
        const handleEditNote = async (e) => {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // í˜„ì¬ ë¬¸ì œì˜ íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const currentQuestion = this.questions[this.currentIndex];
            
            if (!currentQuestion || !currentQuestion.filePath) {
                new Notice('âŒ ë…¸íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // íŒŒì¼ ì°¾ê¸°
            const file = this.app.vault.getAbstractFileByPath(currentQuestion.filePath);
            
            if (file instanceof TFile) {
                // QuizNoteEditModal ì—´ê¸° (ë¶„ë¦¬ëœ ë””ìì¸)
                new QuizNoteEditModal(this.app, this, file, async () => {
                    // ë¬¸ì œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    console.log('ğŸ”„ [ë…¸íŠ¸ í¸ì§‘ ì €ì¥] reloadCurrentQuestion() í˜¸ì¶œ ì‹œì‘');
                    await this.reloadCurrentQuestion();
                    console.log('âœ… [ë…¸íŠ¸ í¸ì§‘ ì €ì¥] reloadCurrentQuestion() ì™„ë£Œ');
                    new Notice('âœ… ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ê³  ë¬¸ì œê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
                }).open();
            } else {
                new Notice('âŒ ë…¸íŠ¸ íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        };
        
        editNoteBtn.addEventListener('click', handleEditNote);
        editNoteBtn.addEventListener('touchend', handleEditNote);

        // "ë‹¤ìŒ ë¬¸ì œ" ë²„íŠ¼
        const nextBtn = btnContainer.createEl('button', { 
            text: 'ë‹¤ìŒ ë¬¸ì œ â†’',
            cls: 'next-button'
        });
        nextBtn.style.padding = '12px 25px';
        nextBtn.style.fontSize = '16px';
        nextBtn.style.backgroundColor = 'white';
        nextBtn.style.color = isCorrect ? '#4caf50' : '#f44336';
        nextBtn.style.border = 'none';
        nextBtn.style.borderRadius = '20px';
        nextBtn.style.cursor = 'pointer';
        nextBtn.style.fontWeight = 'bold';

        nextBtn.style.touchAction = 'manipulation';

        nextBtn.style.webkitTapHighlightColor = 'rgba(0,0,0,0.1)';


        nextBtn.addEventListener('click', () => {
            feedback.remove();
            this.currentIndex++;
            this.showQuestion();
        });
    }

    async showResults() {
        const { contentEl } = this;
        contentEl.empty();

        const endTime = Date.now();
        console.log('ğŸ“Š [showResults] ì‹œê°„ ê³„ì‚° ë””ë²„ê¹…');
        console.log('  startTime:', this.startTime, new Date(this.startTime).toISOString());
        console.log('  endTime:', endTime, new Date(endTime).toISOString());
        
        let totalTimeSeconds = Math.round((endTime - this.startTime) / 1000);
        console.log('  ê³„ì‚°ëœ ì‹œê°„(ì´ˆ):', totalTimeSeconds);
        
        // ë°©ì–´ì : 0ì´ˆë¡œ ì €ì¥ë˜ëŠ” ê²½ìš° ë°©ì§€
        if (!this.startTime || isNaN(this.startTime) || totalTimeSeconds <= 0) {
            console.warn('âš ï¸ [showResults] ì‹œê°„ ê³„ì‚° ì˜¤ë¥˜, ê¸°ë³¸ê°’ 1ì´ˆ ì‚¬ìš©');
            totalTimeSeconds = 1;
        }
        
        // ë¹„ì •ìƒì ìœ¼ë¡œ í° ì‹œê°„(1ì‹œê°„ ì´ìƒ)ì€ ì œí•œ
        if (totalTimeSeconds > 3600) {
            console.warn('âš ï¸ [showResults] ë¹„ì •ìƒì ìœ¼ë¡œ í° ì‹œê°„ ê°ì§€, 3600ì´ˆë¡œ ì œí•œ');
            totalTimeSeconds = 3600;
        }
        
        console.log('  ìµœì¢… ì €ì¥ë  ì‹œê°„(ì´ˆ):', totalTimeSeconds);
        const percentage = Math.round((this.score / this.questions.length) * 100);
        
        // ì‹œê°„ì„ ë¶„ê³¼ ì´ˆë¡œ ë³€í™˜
        const minutes = Math.floor(totalTimeSeconds / 60);
        const seconds = totalTimeSeconds % 60;
        const timeDisplay = minutes > 0 
            ? `${minutes}ë¶„ ${seconds}ì´ˆ` 
            : `${seconds}ì´ˆ`;
        
        // í€´ì¦ˆ ì™„ë£Œ ë¡œê·¸ ë‚¨ê¸°ê¸° (í•œ ì¤„ë¡œ í†µí•©)
        this.appendLog(`í€´ì¦ˆ ì™„ë£Œ: ${this.score}/${this.questions.length} (${percentage}%) - ì†Œìš”ì‹œê°„: ${timeDisplay}`);

        const results = contentEl.createDiv({ cls: 'quiz-results' });
        
        // ì œëª©ê³¼ ì‹œê°„ì„ í•œ ì¤„ì—
        const titleRow = results.createDiv();
        titleRow.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        `;
        
        const title = titleRow.createEl('h1', { text: 'ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!' });
        title.style.cssText = `
            font-size: 24px;
            margin: 0;
        `;
        
        const timeInfo = titleRow.createEl('div', { text: `â±ï¸ ${timeDisplay}` });
        timeInfo.style.cssText = `
            font-size: 18px;
            font-weight: 600;
            color: var(--text-muted);
        `;

        // ì ìˆ˜ í‘œì‹œ - ì»´íŒ©íŠ¸í•˜ê²Œ (2ì¹¸ë§Œ)
        const scoreCard = results.createDiv({ cls: 'score-card' });
        scoreCard.style.cssText = `
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, var(--interactive-accent) 0%, var(--interactive-accent-hover) 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        `;
        scoreCard.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: white;">${this.score} / ${this.questions.length}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">ì •ë‹µ / ì „ì²´</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: white;">${percentage}%</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">ì •ë‹µë¥ </div>
            </div>
        `;

        // ê²°ê³¼ ì €ì¥ (ì‹œê°„ì„ ì´ˆ ë‹¨ìœ„ë¡œ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥)
        const saveResult = {
            correct: this.score,
            incorrect: this.questions.length - this.score,
            total: this.questions.length,
            percentage: percentage,
            details: this.results,
            time: totalTimeSeconds  // ì´ˆ ë‹¨ìœ„ë¡œ ì €ì¥
        };
        
        console.log('ğŸ“Š [showResults] í€´ì¦ˆ ê²°ê³¼ ì €ì¥ - ì‹œê°„(ì´ˆ):', totalTimeSeconds, 'startTime:', this.startTime, 'endTime:', endTime);
        console.log('ğŸ“Š [showResults] saveResult:', JSON.stringify(saveResult, null, 2));

        await this.plugin.saveQuizResult(saveResult);

        // ë¡œê·¸/íˆìŠ¤í† ë¦¬ ì˜ì—­ (ì ìˆ˜ ë°”ë¡œ ë‹¤ìŒì— ë°°ì¹˜)
        const logSection = results.createDiv({ cls: 'quiz-log-history' });
        logSection.style.cssText = `
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid var(--interactive-accent);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
        `;
        
        const logHeaderContainer = logSection.createDiv();
        logHeaderContainer.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        `;
        
        const logHeader = logHeaderContainer.createEl('h3', { text: 'ğŸ“ í€´ì¦ˆ ë¡œê·¸' });
        logHeader.style.cssText = `
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--interactive-accent);
        `;
        
        const logList = logSection.createEl('ul', { cls: 'quiz-log-list' });
        logList.style.cssText = `
            list-style: none;
            padding: 0;
            margin: 0;
        `;
        
        // ì „ì²´ ì‚­ì œ ë²„íŠ¼ (logList ìƒì„± í›„ì— ë°°ì¹˜)
        const clearAllBtn = logHeaderContainer.createEl('button', { text: 'ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ' });
        clearAllBtn.style.cssText = `
            padding: 4px 12px;
            font-size: 11px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        `;
        clearAllBtn.addEventListener('mouseenter', () => {
            clearAllBtn.style.background = '#d32f2f';
        });
        clearAllBtn.addEventListener('mouseleave', () => {
            clearAllBtn.style.background = '#f44336';
        });
        clearAllBtn.addEventListener('click', () => {
            if (confirm('ëª¨ë“  ë¡œê·¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                this.plugin.quizLogHistory = [];
                logList.empty();
                logList.createEl('li', { text: 'ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = `
                    padding: 10px;
                    text-align: center;
                    color: var(--text-muted);
                    font-style: italic;
                `;
            }
        });
        
        // í”ŒëŸ¬ê·¸ì¸ ë ˆë²¨ì˜ logHistory ì‚¬ìš©
        if (this.plugin.quizLogHistory && this.plugin.quizLogHistory.length > 0) {
            this.plugin.quizLogHistory.slice().reverse().forEach((log, idx) => {
                const logItem = logList.createEl('li');
                logItem.style.cssText = `
                    padding: 10px;
                    margin-bottom: 8px;
                    background: var(--background-primary);
                    border-radius: 6px;
                    border-left: 3px solid var(--interactive-accent);
                    font-size: 13px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                `;
                
                const logContent = logItem.createDiv();
                logContent.style.cssText = 'flex: 1;';
                
                const logTime = logContent.createSpan({ text: log.timestamp });
                logTime.style.cssText = `
                    color: var(--text-muted);
                    font-size: 11px;
                    display: block;
                    margin-bottom: 4px;
                `;
                
                const logMsg = logContent.createSpan({ text: log.message });
                logMsg.style.cssText = `
                    color: var(--text-normal);
                    font-weight: 500;
                `;
                
                // ê°œë³„ ì‚­ì œ ë²„íŠ¼
                const deleteBtn = logItem.createEl('button', { text: 'âœ•' });
                deleteBtn.style.cssText = `
                    padding: 2px 8px;
                    font-size: 14px;
                    background: transparent;
                    color: var(--text-muted);
                    border: 1px solid var(--background-modifier-border);
                    border-radius: 4px;
                    cursor: pointer;
                    transition: all 0.2s;
                    margin-left: 10px;
                `;
                deleteBtn.title = 'ì´ ë¡œê·¸ ì‚­ì œ';
                
                deleteBtn.addEventListener('mouseenter', () => {
                    deleteBtn.style.background = '#f44336';
                    deleteBtn.style.color = 'white';
                    deleteBtn.style.borderColor = '#f44336';
                });
                
                deleteBtn.addEventListener('mouseleave', () => {
                    deleteBtn.style.background = 'transparent';
                    deleteBtn.style.color = 'var(--text-muted)';
                    deleteBtn.style.borderColor = 'var(--background-modifier-border)';
                });
                
                deleteBtn.addEventListener('click', () => {
                    const actualIndex = this.plugin.quizLogHistory.length - 1 - idx;
                    this.plugin.quizLogHistory.splice(actualIndex, 1);
                    logItem.remove();
                    
                    if (this.plugin.quizLogHistory.length === 0) {
                        logList.createEl('li', { text: 'ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = `
                            padding: 10px;
                            text-align: center;
                            color: var(--text-muted);
                            font-style: italic;
                        `;
                    }
                });
            });
        } else {
            logList.createEl('li', { text: 'ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.' }).style.cssText = `
                padding: 10px;
                text-align: center;
                color: var(--text-muted);
                font-style: italic;
            `;
        }

        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ìŠ¤í¬ë¡¤ ì˜ì—­ ë°–ì— ê³ ì •)
        const buttonContainer = results.createDiv({ cls: 'results-buttons' });
        buttonContainer.style.cssText = `
            margin-top: 20px !important;
            padding-top: 20px !important;
            border-top: 2px solid var(--background-modifier-border) !important;
            display: flex !important;
            flex-wrap: wrap !important;
            overflow-x: visible !important;
            gap: 8px !important;
            width: 100% !important;
            box-sizing: border-box !important;
            justify-content: flex-start !important;
        `;
        
        // webkit ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ìŠ¤íƒ€ì¼ ì œê±° (ì´ì œ wrap ì‚¬ìš©)
        
        const retryBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ”„ ë‹¤ì‹œí’€ê¸°',
            cls: 'mod-cta results-btn'
        });
        retryBtn.addEventListener('click', () => {
            this.currentIndex = 0;
            this.score = 0;
            this.results = [];
            this.startTime = Date.now();
            if (this.plugin.settings.shuffleQuestions) {
                this.questions = this.shuffleArray([...this.allQuestions]);
            }
            this.showQuestion();
        });
        
        const detailBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ“Š ìƒì„¸ê¸°ë¡',
            cls: 'mod-cta results-btn'
        });
        detailBtn.addEventListener('click', () => {
            this.close();
            new ResultsDetailModal(this.app, this.plugin).open();
        });
        
        const folderBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ“ í´ë”ê´€ë¦¬',
            cls: 'results-btn'
        });
        folderBtn.addEventListener('click', () => {
            this.close();
            new FolderManagementModal(this.app, this.plugin).open();
        });

        const wrongBtn = buttonContainer.createEl('button', { 
            text: 'âŒ ì˜¤ë‹µë³µìŠµ',
            cls: 'results-btn'
        });
        wrongBtn.addEventListener('click', async () => {
            await this.plugin.openWrongAnswersQuiz();
        });

        const dashboardBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ“Š ëŒ€ì‹œë³´ë“œë¡œ',
            cls: 'results-btn'
        });
        dashboardBtn.style.cssText = 'background: #3b82f6; color: white;';
        const dashboardBtnHandler = () => {
            this.close();
            this.plugin.openDashboard();
        };
        dashboardBtn.addEventListener('click', dashboardBtnHandler);
        dashboardBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            dashboardBtnHandler();
        });

        const closeBtn = buttonContainer.createEl('button', { 
            text: 'ğŸšª ì¢…ë£Œ',
            cls: 'results-btn'
        });
        closeBtn.style.cssText = 'background: #ef4444; color: white;';
        closeBtn.addEventListener('click', () => {
            this.close();
        });
        closeBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            this.close();
        });
    }

    addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* QuizPlayModal ìŠ¤íƒ€ì¼ */
            .quiz-play-modal {
                width: 100%;
                height: 100%;
            }
            
            .quiz-header {
                padding: 15px 15px 15px 0;
                background: linear-gradient(135deg, var(--background-primary) 0%, var(--background-secondary) 100%);
                border-bottom: 2px solid var(--background-modifier-border);
            }
            
            .quiz-control-bar {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
                justify-content: flex-start;
                margin-bottom: 12px;
                padding-left: 0;
            }
            
            .control-button {
                padding: 8px 14px;
                font-size: 13px;
                border: 1px solid var(--background-modifier-border);
                background: var(--interactive-normal);
                color: var(--text-normal);
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
            }
            
            .control-button:hover {
                background: var(--interactive-hover);
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .control-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .dashboard-button {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
            }
            
            .dashboard-button:hover {
                background: linear-gradient(135deg, #5568d3 0%, #6a4190 100%);
            }
            
            .quiz-progress {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 12px;
                background: var(--background-secondary);
                border-radius: 8px;
                margin-top: 10px;
            }
            
            .progress-label {
                font-size: 14px;
                font-weight: 600;
                color: var(--text-normal);
            }
            
            .progress-info {
                font-size: 14px;
                color: var(--text-muted);
            }
            
            /* í•œì íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ */
            .hanzi-timer-container {
                position: relative;
                width: 100%;
                height: 40px;
                margin-top: 12px;
                background: var(--background-secondary);
                border-radius: 20px;
                overflow: hidden;
                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            }
            
            .hanzi-timer-progress {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
            
            .hanzi-timer-fill {
                height: 100%;
                background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
                transition: width 1s linear, background 0.3s;
                border-radius: 20px;
            }
            
            .timer-warning .hanzi-timer-fill {
                background: linear-gradient(90deg, #ff9800 0%, #ff5722 100%);
                animation: pulse 0.5s ease-in-out infinite;
            }
            
            .timer-expired .hanzi-timer-fill {
                background: linear-gradient(90deg, #f44336 0%, #e91e63 100%);
            }
            
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.7; }
            }
            
            .hanzi-timer-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 18px;
                font-weight: 700;
                color: var(--text-normal);
                text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                z-index: 1;
            }
            
            .quiz-scrollable-content {
                /* padding-bottomëŠ” ì¸ë¼ì¸ì—ì„œ ì„¤ì • */
            }
            
            .question-text h3 {
                font-size: 22px;
                font-weight: 700;
                line-height: 1.5;
                margin: 15px 0;
                color: var(--text-normal);
            }
            
            .hint-container {
                /* ìŠ¤íƒ€ì¼ì€ ì¸ë¼ì¸ì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì • */
            }
            
            .options-container {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            
            .option-button {
                /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì„¤ì •ë¨ */
            }
            
            .quiz-results {
                padding: 20px;
                max-height: 100%;
                overflow-y: auto;
            }
            
            .score-card {
                /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì„¤ì •ë¨ */
            }
            
            .results-buttons {
                /* ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì„¤ì •ë¨ */
            }
            
            .results-btn {
                flex: 1 1 calc(50% - 4px);
                min-width: 140px;
                padding: 12px 16px;
                font-size: 14px;
                font-weight: 600;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s;
                background: var(--interactive-normal);
                color: var(--text-normal);
                border: 1px solid var(--background-modifier-border);
            }
            
            .results-btn:hover {
                background: var(--interactive-hover);
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .results-btn-full {
                flex: 1 1 100%;
            }
            
            /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
            @media (max-width: 768px) {
                .quiz-header {
                    padding: 12px;
                }
                
                .control-button {
                    padding: 6px 10px;
                    font-size: 12px;
                }
                
                .quiz-progress {
                    flex-direction: column;
                    gap: 6px;
                    align-items: flex-start;
                }
                
                .question-text h3 {
                    font-size: 18px;
                }
                
                .option-button {
                    padding: 16px 18px !important;
                    font-size: 16px !important;
                }
                
                .results-btn {
                    flex: 1 1 100%;
                    min-width: unset;
                }
            }
        `;
        document.head.appendChild(style);
    }
    
    confirmExit() {
        const confirmModal = new Modal(this.app);
        confirmModal.titleEl.setText('â“ í€´ì¦ˆ ë‚˜ê°€ê¸°');
        
        const { contentEl } = confirmModal;
        contentEl.style.padding = '20px';
        contentEl.style.textAlign = 'center';
        
        contentEl.createEl('p', {
            text: 'í€´ì¦ˆë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            cls: 'confirm-message'
        }).style.cssText = 'font-size: 16px; margin-bottom: 20px; color: var(--text-normal);';
        
        const btnContainer = contentEl.createDiv({ cls: 'confirm-buttons' });
        btnContainer.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
        
        // í´ë” ê´€ë¦¬ë¡œ ì´ë™
        const toFolderBtn = btnContainer.createEl('button', {
            text: 'ğŸ“ í´ë” ê´€ë¦¬',
            cls: 'mod-cta'
        });
        toFolderBtn.style.padding = '10px 20px';
        toFolderBtn.addEventListener('click', () => {
            confirmModal.close();
            this.stopTimer();
            // QuizModalì€ ìœ ì§€í•˜ê³  í´ë” ì„ íƒ í™”ë©´ìœ¼ë¡œ ì´ë™
            this.showFolderSelection();
        });
        
        // ì™„ì „íˆ ë‚˜ê°€ê¸°
        const exitBtn = btnContainer.createEl('button', {
            text: 'ğŸšª ì™„ì „íˆ ë‚˜ê°€ê¸°'
        });
        exitBtn.style.padding = '10px 20px';
        exitBtn.addEventListener('click', () => {
            confirmModal.close();
            this.stopTimer();
            this.isExiting = true;  // ì‹¤ì œ ì¢…ë£Œ í”Œë˜ê·¸ ì„¤ì •
            this.close();
            // ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
            this.plugin.openDashboard();
        });
        
        // ì·¨ì†Œ
        const cancelBtn = btnContainer.createEl('button', {
            text: 'â†©ï¸ ê³„ì†í•˜ê¸°'
        });
        cancelBtn.style.padding = '10px 20px';
        cancelBtn.addEventListener('click', () => {
            confirmModal.close();
        });
        
        confirmModal.open();
    }
    
    showFolderSelection() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('quiz-play-modal');
        
        // í´ë” ì„ íƒ UI ë Œë”ë§ (FolderSelectionModalê³¼ ìœ ì‚¬í•˜ê²Œ)
        contentEl.createEl('h2', { text: 'ğŸ“ í´ë” ì„ íƒ' });
        
        const folderList = contentEl.createDiv({ cls: 'folder-list' });
        folderList.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        `;
        
        const folders = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        
        folders.forEach(folder => {
            const folderBtn = folderList.createEl('button', {
                text: `ğŸ“ ${folder}`,
                cls: 'folder-select-button'
            });
            folderBtn.style.cssText = `
                padding: 15px;
                font-size: 16px;
                cursor: pointer;
                background: var(--interactive-normal);
                border: 1px solid var(--background-modifier-border);
                border-radius: 8px;
                transition: all 0.2s;
            `;
            folderBtn.addEventListener('mouseenter', () => {
                folderBtn.style.background = 'var(--interactive-hover)';
            });
            folderBtn.addEventListener('mouseleave', () => {
                folderBtn.style.background = 'var(--interactive-normal)';
            });
            folderBtn.addEventListener('click', async () => {
                await this.startQuizFromFolder(folder);
            });
        });
        
        // ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
        const backBtn = contentEl.createEl('button', {
            text: 'â† ëŒ€ì‹œë³´ë“œ',
            cls: 'back-button'
        });
        backBtn.style.cssText = 'margin-top: 20px; padding: 10px 20px;';
        backBtn.addEventListener('click', () => {
            this.close();
            new DashboardModal(this.app, this.plugin).open();
        });
    }
    
    async startQuizFromFolder(folder) {
        // í´ë”ì˜ ë¬¸ì œ ë¡œë“œ
        const questions = await this.plugin.getQuestionsByFolder(folder);
        
        console.log(`ğŸ“‚ í´ë” "${folder}" ë¬¸ì œ ë¡œë“œ:`, questions.length, 'ê°œ');
        
        if (questions.length === 0) {
            new Notice(`âŒ ${folder} í´ë”ì— ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.`);
            return;
        }
        
        // í€´ì¦ˆ ì´ˆê¸°í™”
        this.questions = this.shuffleArray([...questions]);
        this.allQuestions = [...this.questions];
        this.currentIndex = 0;
        this.score = 0;
        this.results = [];
        this.startTime = Date.now();
        
        console.log('í€´ì¦ˆ ì´ˆê¸°í™” ì™„ë£Œ, ë¬¸ì œ í‘œì‹œ ì‹œì‘');
        
        // ë¬¸ì œ í‘œì‹œ
        const { contentEl } = this;
        contentEl.empty();
        this.showQuestion();
    }

    startTimer() {
        if (!this.plugin.settings.enableTimer || this.isPaused) return;

        this.timeRemaining = this.plugin.settings.timerPerQuestion;
        this.updateTimer();

        this.timerInterval = setInterval(() => {
            if (!this.isPaused) {
                this.timeRemaining--;
                this.updateTimer();

                if (this.timeRemaining <= 0) {
                    this.stopTimer();
                    const currentQuestion = this.questions[this.currentIndex];
                    if (currentQuestion) {
                        this.selectAnswer(-1, currentQuestion); // ì‹œê°„ ì´ˆê³¼ = ì˜¤ë‹µ
                    } else {
                        console.error('âŒ íƒ€ì´ë¨¸ ë§Œë£Œ ì‹œ í˜„ì¬ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤:', this.currentIndex);
                    }
                }
            }
        }, 1000);
    }

    stopTimer() {
        if (this.timerInterval) {
            clearInterval(this.timerInterval);
            this.timerInterval = null;
        }
    }

    togglePause() {
        this.isPaused = !this.isPaused;
        
        if (this.isPaused) {
            this.pausedTime = this.timeRemaining;
            // ì•Œë¦¼ ì œê±° - UI ë²„íŠ¼ ìƒíƒœë¡œ ì¶©ë¶„íˆ í‘œì‹œë¨
        } else {
            this.timeRemaining = this.pausedTime;
            // ì•Œë¦¼ ì œê±° - UI ë²„íŠ¼ ìƒíƒœë¡œ ì¶©ë¶„íˆ í‘œì‹œë¨
        }
    }

    openSettings() {
        this.isPaused = true;
        if (this.pauseButton) {
            this.pauseButton.setText('â–¶ï¸ ì¬ê°œ');
        }
        
        const settingsModal = new Modal(this.app);
        settingsModal.titleEl.setText('âš™ï¸ í€´ì¦ˆ ì„¤ì •');
        
        const { contentEl } = settingsModal;
        contentEl.style.padding = '20px';
        contentEl.style.minWidth = '400px';

        // íƒ€ì´ë¨¸ ì„¤ì •
        contentEl.createEl('h3', { text: 'â±ï¸ íƒ€ì´ë¨¸ ì„¤ì •' });
        
        const timerSetting = contentEl.createDiv({ cls: 'setting-item' });
        timerSetting.createEl('div', { text: 'íƒ€ì´ë¨¸ ì‚¬ìš©', cls: 'setting-item-name' });
        const timerToggle = timerSetting.createEl('input', { type: 'checkbox' });
        timerToggle.checked = this.plugin.settings.enableTimer;
        timerToggle.onchange = async () => {
            this.plugin.settings.enableTimer = timerToggle.checked;
            await this.plugin.saveSettings();
        };

        const timeSetting = contentEl.createDiv({ cls: 'setting-item' });
        timeSetting.createEl('div', { text: 'ë¬¸ì œë‹¹ ì‹œê°„ (ì´ˆ)', cls: 'setting-item-name' });
        const timeInput = timeSetting.createEl('input', { type: 'number', value: this.plugin.settings.timerPerQuestion });
        timeInput.style.width = '80px';
        timeInput.onchange = async () => {
            this.plugin.settings.timerPerQuestion = parseInt(timeInput.value) || 30;
            await this.plugin.saveSettings();
        };

        // íŒíŠ¸ ì„¤ì •
        contentEl.createEl('h3', { text: 'ğŸ’¡ íŒíŠ¸ ì„¤ì •' });
        
        const hintSetting = contentEl.createDiv({ cls: 'setting-item' });
        hintSetting.createEl('div', { text: 'ì˜¤ë‹µ ì‹œ íŒíŠ¸ í‘œì‹œ', cls: 'setting-item-name' });
        const hintToggle = hintSetting.createEl('input', { type: 'checkbox' });
        hintToggle.checked = this.plugin.settings.showHintAfterWrong;
        hintToggle.onchange = async () => {
            this.plugin.settings.showHintAfterWrong = hintToggle.checked;
            await this.plugin.saveSettings();
        };

        // ë²„íŠ¼
        const btnContainer = contentEl.createDiv({ cls: 'modal-button-container' });
        btnContainer.style.marginTop = '20px';
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'flex-end';

        const closeBtn = btnContainer.createEl('button', { text: 'ë‹«ê¸°', cls: 'mod-cta' });
        closeBtn.onclick = () => {
            settingsModal.close();
            this.isPaused = false;
            if (this.pauseButton) {
                this.pauseButton.setText('â¸ï¸ ì¼ì‹œì •ì§€');
            }
        };

        settingsModal.open();
    }

    updateTimer() {
        if (this.timerFill && this.timerText && this.timerContainer) {
            const totalTime = this.plugin.settings.timerPerQuestion;
            const percentage = (this.timeRemaining / totalTime) * 100;
            
            this.timerFill.style.width = `${percentage}%`;
            this.timerText.setText(`${this.timeRemaining}ì´ˆ`);
            
            // ìƒíƒœë³„ ìŠ¤íƒ€ì¼ ì ìš©
            this.timerContainer.removeClass('timer-warning', 'timer-expired');
            
            if (this.timeRemaining <= 5 && this.timeRemaining > 0) {
                this.timerContainer.addClass('timer-warning');
            } else if (this.timeRemaining <= 0) {
                this.timerContainer.addClass('timer-expired');
            }
        }
    }

    async selectAnswer(selectedIndex, question) {
        console.log("=" .repeat(60));
        console.log("ğŸ¯ selectAnswer í˜¸ì¶œë¨");
        console.log(`  selectedIndex: ${selectedIndex}`);
        
        // ì•ˆì „ì¥ì¹˜: questionì´ undefinedì¸ ê²½ìš°
        if (!question) {
            console.error("âŒ questionì´ undefinedì…ë‹ˆë‹¤!");
            console.error(`  currentIndex: ${this.currentIndex}`);
            console.error(`  questions ê¸¸ì´: ${this.questions?.length}`);
            new Notice("âŒ ì˜¤ë¥˜: ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤");
            return;
        }
        
        console.log(`  question.shuffledAnswerIndex: ${question.shuffledAnswerIndex}`);
        console.log(`  question.answer: ${question.answer}`);
        console.log(`  question.hanzi: ${question.hanzi}`);
        console.log("=" .repeat(60));
        
        this.stopTimer();

        const isCorrect = selectedIndex === question.shuffledAnswerIndex;
        
        console.log(`  ì •ë‹µ ì—¬ë¶€: ${isCorrect}`);
        
        if (isCorrect) {
            this.score++;
        }

        this.results.push({
            hanzi: question.hanzi,
            question: question.question,
            isCorrect: isCorrect,
            selectedAnswer: selectedIndex >= 0 ? question.options[selectedIndex] : 'ì‹œê°„ ì´ˆê³¼',
            correctAnswer: question.options[question.answer],
            folder: question.folder || 'ê¸°ë³¸',
            time: 0
        });

        await this.plugin.updateQuestionStats(question, isCorrect);

        // í”¼ë“œë°± í‘œì‹œ
        await this.showFeedback(isCorrect, question);
    }

    async showFeedback(isCorrect, question) {
        const { contentEl } = this;
        
        const feedback = contentEl.createDiv({ cls: 'feedback-overlay' });
        feedback.style.position = 'fixed';
        feedback.style.top = '50%';
        feedback.style.left = '50%';
        feedback.style.transform = 'translate(-50%, -50%)';
        feedback.style.width = '90%';
        feedback.style.maxWidth = '500px';
        feedback.style.maxHeight = '80vh';
        feedback.style.overflow = 'auto';
        feedback.style.backgroundColor = isCorrect ? 'rgba(76, 175, 80, 0.98)' : 'rgba(244, 67, 54, 0.98)';
        feedback.style.display = 'flex';
        feedback.style.flexDirection = 'column';
        feedback.style.alignItems = 'center';
        feedback.style.justifyContent = 'center';
        feedback.style.color = 'white';
        feedback.style.zIndex = '1000';
        feedback.style.padding = '30px 20px';
        feedback.style.borderRadius = '15px';
        feedback.style.boxShadow = '0 10px 40px rgba(0,0,0,0.3)';

        const icon = feedback.createEl('div', { 
            text: isCorrect ? 'âœ…' : 'âŒ',
            cls: 'feedback-icon'
        });
        icon.style.fontSize = '50px';
        icon.style.marginBottom = '15px';

        const message = feedback.createEl('h2', { 
            text: isCorrect ? 'ì •ë‹µì…ë‹ˆë‹¤!' : 'í‹€ë ¸ìŠµë‹ˆë‹¤!'
        });
        message.style.fontSize = '24px';
        message.style.marginBottom = '10px';

        if (!isCorrect && (question.hint || question.hintImage) && this.plugin.settings.showHintAfterWrong) {
            const hintContainer = feedback.createDiv({ cls: 'feedback-hint-container' });
            hintContainer.style.marginTop = '15px';
            hintContainer.style.padding = '12px';
            hintContainer.style.backgroundColor = 'rgba(0,0,0,0.3)';
            hintContainer.style.borderRadius = '8px';
            hintContainer.style.maxWidth = '400px';
            
            if (question.hint && question.hint.trim()) {
                const hint = hintContainer.createEl('p', { text: `ğŸ’¡ íŒíŠ¸: ${question.hint}` });
                hint.style.fontSize = '15px';
                hint.style.margin = '0';
            }
            
            // íŒíŠ¸ ì´ë¯¸ì§€
            if (question.hintImage && question.hintImage.trim()) {
                let imageUrl = question.hintImage.trim();
                
                // ì˜µì‹œë””ì–¸ ë‚´ë¶€ ë§í¬ ì²˜ë¦¬
                if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                    const wikiMatch = imageUrl.match(/\[\[(.+?)\]\]/);
                    if (wikiMatch && wikiMatch[1]) {
                        const fileName = wikiMatch[1];
                        const files = this.app.vault.getFiles();
                        const imageFile = files.find(f => 
                            f.name === fileName || 
                            f.path.endsWith(fileName) ||
                            f.basename === fileName.replace(/\.\w+$/, '')
                        );
                        
                        if (imageFile) {
                            // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                            imageUrl = this.app.vault.adapter.getResourcePath(imageFile.path);
                        }
                    }
                }
                // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ ë¬¸ë²• ì²˜ë¦¬
                else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                    const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                    if (imgMatch && imgMatch[1]) {
                        imageUrl = imgMatch[1];
                    }
                }
                
                const hintImg = hintContainer.createEl('img', {
                    attr: {
                        src: imageUrl,
                        style: 'width: 100%; max-width: 350px; height: auto; margin-top: 10px; border-radius: 6px; display: block;'
                    }
                });
                hintImg.onerror = () => {
                    hintImg.style.display = 'none';
                };
            }
        }

        if (!isCorrect) {
            const correctAnswerText = feedback.createEl('p', { 
                text: `ì •ë‹µ: ${question.options[question.answer]}`
            });
            correctAnswerText.style.fontSize = '16px';
            correctAnswerText.style.marginTop = '10px';
            correctAnswerText.style.fontWeight = 'bold';
        }

        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆë¥¼ ë¨¼ì € ìƒì„±
        const btnContainer = feedback.createDiv({ cls: 'feedback-buttons' });
        btnContainer.style.display = 'flex';
        btnContainer.style.gap = '10px';
        btnContainer.style.justifyContent = 'center';
        btnContainer.style.marginTop = '20px';
        btnContainer.style.flexWrap = 'wrap';

        // "ë‹¤ì‹œí’€ê¸°" ë²„íŠ¼ (í•­ìƒ í‘œì‹œ)
        const retryBtn = btnContainer.createEl('button', {
            text: 'ğŸ”„ ë‹¤ì‹œí’€ê¸°',
            cls: 'retry-button'
        });
        retryBtn.style.padding = '12px 25px';
        retryBtn.style.fontSize = '16px';
        retryBtn.style.backgroundColor = 'white';
        retryBtn.style.color = '#ff9800';
        retryBtn.style.border = 'none';
        retryBtn.style.borderRadius = '20px';
        retryBtn.style.cursor = 'pointer';
        retryBtn.style.fontWeight = 'bold';
        
        retryBtn.addEventListener('click', () => {
            feedback.remove();
            // ê°™ì€ ë¬¸ì œë¥¼ ë‹¤ì‹œ ë³´ì—¬ì¤Œ
            this.showQuestion();
        });

        // "ë…¸íŠ¸ í¸ì§‘" ë²„íŠ¼ ì¶”ê°€
        const editNoteBtn = btnContainer.createEl('button', {
            text: 'ğŸ“ ë…¸íŠ¸ í¸ì§‘',
            cls: 'edit-note-button'
        });
        editNoteBtn.style.padding = '12px 25px';
        editNoteBtn.style.fontSize = '16px';
        editNoteBtn.style.backgroundColor = 'white';
        editNoteBtn.style.color = '#2196F3';
        editNoteBtn.style.border = 'none';
        editNoteBtn.style.borderRadius = '20px';
        editNoteBtn.style.cursor = 'pointer';
        editNoteBtn.style.fontWeight = 'bold';
        editNoteBtn.style.touchAction = 'manipulation';
        editNoteBtn.style.webkitTapHighlightColor = 'rgba(0,0,0,0.1)';
        
        const handleEditNote = async (e) => {
            if (e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // í˜„ì¬ ë¬¸ì œì˜ íŒŒì¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const currentQuestion = this.questions[this.currentIndex];
            
            if (!currentQuestion || !currentQuestion.filePath) {
                new Notice('âŒ ë…¸íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            // íŒŒì¼ ì°¾ê¸°
            const file = this.app.vault.getAbstractFileByPath(currentQuestion.filePath);
            
            if (file instanceof TFile) {
                // QuizNoteEditModal ì—´ê¸° (ë¶„ë¦¬ëœ ë””ìì¸)
                new QuizNoteEditModal(this.app, this, file, async () => {
                    // ë¬¸ì œ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
                    console.log('ğŸ”„ [ì˜¤ë‹µ-ë…¸íŠ¸ í¸ì§‘ ì €ì¥] reloadCurrentQuestion() í˜¸ì¶œ ì‹œì‘, filePath:', currentQuestion.filePath);
                    await this.reloadCurrentQuestion(currentQuestion.filePath);
                    console.log('âœ… [ì˜¤ë‹µ-ë…¸íŠ¸ í¸ì§‘ ì €ì¥] reloadCurrentQuestion() ì™„ë£Œ');
                    new Notice('âœ… ë…¸íŠ¸ê°€ ìˆ˜ì •ë˜ê³  ë¬¸ì œê°€ ìƒˆë¡œê³ ì¹¨ë˜ì—ˆìŠµë‹ˆë‹¤');
                }).open();
            } else {
                new Notice('âŒ ë…¸íŠ¸ íŒŒì¼ì„ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        };
        
        editNoteBtn.addEventListener('click', handleEditNote);
        editNoteBtn.addEventListener('touchend', handleEditNote);

        // ì •ë‹µ/ì˜¤ë‹µ ëª¨ë‘ ë…¸íŠ¸ë³´ê¸° ë²„íŠ¼
        if ((question.note && question.note.trim()) || (question.noteImage && question.noteImage.trim())) {
            const noteBtn = btnContainer.createEl('button', { 
                text: 'ğŸ“ ë…¸íŠ¸ë³´ê¸°',
                cls: 'note-button'
            });
            noteBtn.style.padding = '12px 25px';
            noteBtn.style.fontSize = '16px';
            noteBtn.style.backgroundColor = 'white';
            noteBtn.style.color = '#9c27b0';
            noteBtn.style.border = 'none';
            noteBtn.style.borderRadius = '20px';
            noteBtn.style.cursor = 'pointer';
            noteBtn.style.fontWeight = 'bold';
            noteBtn.style.touchAction = 'manipulation';
            noteBtn.style.webkitTapHighlightColor = 'rgba(0,0,0,0.1)';
            
            const handleNoteToggle = (e) => {
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                // ë…¸íŠ¸ í‘œì‹œ ì˜ì—­ í† ê¸€
                let noteDisplay = feedback.querySelector('.note-display');
                if (noteDisplay) {
                    noteDisplay.remove();
                    noteBtn.setText('ğŸ“ ë…¸íŠ¸ë³´ê¸°');
                } else {
                    noteDisplay = feedback.createEl('div', { cls: 'note-display' });
                    noteDisplay.style.marginTop = '15px';
                    noteDisplay.style.padding = '15px';
                    noteDisplay.style.backgroundColor = 'rgba(0,0,0,0.3)';
                    noteDisplay.style.borderRadius = '8px';
                    noteDisplay.style.maxWidth = '95%';
                    noteDisplay.style.width = '100%';
                    noteDisplay.style.boxSizing = 'border-box';
                    noteDisplay.style.fontSize = '14px';
                    noteDisplay.style.lineHeight = '1.6';
                    noteDisplay.style.textAlign = 'left';
                    noteDisplay.style.overflowX = 'auto';
                    
                    if (question.note && question.note.trim()) {
                        const noteText = noteDisplay.createEl('div');
                        noteText.style.whiteSpace = 'pre-wrap';
                        noteText.setText(question.note);
                    }
                    
                    // ë…¸íŠ¸ ì´ë¯¸ì§€ (ë‹¤ì¤‘ ì´ë¯¸ì§€ ì§€ì›)
                    if (question.noteImage && question.noteImage.trim()) {
                        const noteImgContainer = noteDisplay.createDiv();
                        noteImgContainer.style.display = 'flex';
                        noteImgContainer.style.flexWrap = 'wrap';
                        noteImgContainer.style.gap = '8px';
                        noteImgContainer.style.marginTop = '10px';
                        
                        // ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„ëœ ì´ë¯¸ì§€ë“¤ ì²˜ë¦¬
                        const noteImageLines = question.noteImage.split('\n').filter(line => line.trim());
                        
                        // ëª¨ë“  ì´ë¯¸ì§€ URL ë°°ì—´ ìƒì„± (í™•ëŒ€ ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
                        const allImageUrls = noteImageLines.map(line => {
                            let url = line.trim();
                            // URL ë””ì½”ë”©
                            if (url.includes('%')) {
                                try {
                                    url = decodeURIComponent(url);
                                } catch (e) {
                                    console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', url);
                                }
                            }
                            if (url.includes('[[') && url.includes(']]')) {
                                const wikiMatch = url.match(/\[\[(.+?)(\|\d+)?\]\]/);
                                if (wikiMatch && wikiMatch[1]) {
                                    let imagePath = wikiMatch[1];
                                    
                                    // ê²½ë¡œ ë³€í™˜
                                    const folderName = question.folder || 'default';
                                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                    const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz/Questions';
                                    
                                    if (imagePath.startsWith(folderName + '/')) {
                                        imagePath = `${quizFolder}/${imagePath}`;
                                    } else if (!imagePath.startsWith(quizFolder)) {
                                        if (!imagePath.includes('/')) {
                                            imagePath = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                        }
                                    }
                                    
                                    const imageFile = this.app.vault.getAbstractFileByPath(imagePath);
                                    if (imageFile) {
                                        // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                        return this.app.vault.adapter.getResourcePath(imagePath);
                                    }
                                }
                            }
                            return url;
                        });
                        
                        noteImageLines.forEach((imageLine, imgIndex) => {
                            let imageUrl = imageLine.trim();
                            
                            // URL ë””ì½”ë”© (ì¸ì½”ë”©ëœ ê²½ìš°)
                            if (imageUrl.includes('%')) {
                                try {
                                    imageUrl = decodeURIComponent(imageUrl);
                                } catch (e) {
                                    console.warn('URL ë””ì½”ë”© ì‹¤íŒ¨:', imageUrl);
                                }
                            }
                            
                            // í¬ê¸° ì •ë³´ ì¶”ì¶œ
                            let imageWidth = null;
                            const sizeMatch = imageLine.match(/\|(\d+)\]\]/);
                            if (sizeMatch) {
                                imageWidth = sizeMatch[1] + 'px';
                            }
                            
                            // ì˜µì‹œë””ì–¸ ë‚´ë¶€ ë§í¬ ì²˜ë¦¬
                            if (imageUrl.includes('[[') && imageUrl.includes(']]')) {
                                const wikiMatch = imageUrl.match(/\[\[(.+?)(\|\d+)?\]\]/);
                                if (wikiMatch && wikiMatch[1]) {
                                    let imagePath = wikiMatch[1];
                                    
                                    // ê²½ë¡œ ë³€í™˜
                                    const folderName = question.folder || 'default';
                                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                                    const quizFolder = this.plugin.settings.quizFolder || 'HanziQuiz';
                                    
                                    // ë‘ ê°€ì§€ ê²½ë¡œ ì‹œë„
                                    // ê²½ë¡œ1: HanziQuiz/Questions/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/
                                    // ê²½ë¡œ2: HanziQuiz/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/
                                    let imagePath1, imagePath2;
                                    
                                    if (imagePath.startsWith(folderName + '/')) {
                                        // "200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/image.png" í˜•ì‹
                                        imagePath1 = `${quizFolder}/Questions/${imagePath}`;
                                        imagePath2 = `${quizFolder}/${imagePath}`;
                                    } else if (!imagePath.startsWith(quizFolder)) {
                                        if (!imagePath.includes('/')) {
                                            // "image.png" í˜•ì‹
                                            imagePath1 = `${quizFolder}/Questions/${folderName}/${attachmentFolderName}/${imagePath}`;
                                            imagePath2 = `${quizFolder}/${folderName}/${attachmentFolderName}/${imagePath}`;
                                        } else {
                                            // ê¸°íƒ€ í˜•ì‹
                                            imagePath1 = `${quizFolder}/Questions/${imagePath}`;
                                            imagePath2 = `${quizFolder}/${imagePath}`;
                                        }
                                    } else {
                                        imagePath1 = imagePath;
                                        imagePath2 = imagePath;
                                    }
                                    
                                    // ë‘ ê²½ë¡œ ì¤‘ ì¡´ì¬í•˜ëŠ” íŒŒì¼ ì°¾ê¸°
                                    let imageFile = this.app.vault.getAbstractFileByPath(imagePath1);
                                    let finalPath = imagePath1;
                                    
                                    if (!imageFile) {
                                        imageFile = this.app.vault.getAbstractFileByPath(imagePath2);
                                        finalPath = imagePath2;
                                    }
                                    
                                    console.log(`ğŸ–¼ï¸ [ì˜¤ë‹µ-ë…¸íŠ¸ ì´ë¯¸ì§€ ê²½ë¡œ] ${wikiMatch[1]} â†’ ${finalPath}`);
                                    
                                    if (imageFile) {
                                        // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                        imageUrl = this.app.vault.adapter.getResourcePath(finalPath);
                                        console.log(`âœ… [ì˜¤ë‹µ-ë…¸íŠ¸ ì´ë¯¸ì§€ ë°œê²¬] ${finalPath} â†’ ${imageUrl}`);
                                    } else {
                                        console.warn(`âŒ [ì˜¤ë‹µ-ë…¸íŠ¸ ì´ë¯¸ì§€ ì—†ìŒ] ê²½ë¡œ1: ${imagePath1}, ê²½ë¡œ2: ${imagePath2}`);
                                    }
                                }
                            }
                            // ë§ˆí¬ë‹¤ìš´ ì´ë¯¸ì§€ ë¬¸ë²• ì²˜ë¦¬
                            else if (imageUrl.includes('![') && imageUrl.includes('](')) {
                                const imgMatch = imageUrl.match(/!\[.*?\]\((.*?)\)/);
                                if (imgMatch && imgMatch[1]) {
                                    imageUrl = imgMatch[1];
                                }
                            }
                            
                            // ì´ë¯¸ì§€ ë˜í¼
                            const imgWrapper = noteImgContainer.createDiv();
                            imgWrapper.style.flex = noteImageLines.length === 1 ? '1 1 100%' : '0 0 auto';
                            imgWrapper.style.maxWidth = imageWidth || (noteImageLines.length === 1 ? '400px' : '200px');
                            
                            const noteImg = imgWrapper.createEl('img', {
                                attr: {
                                    src: imageUrl,
                                    style: `width: 100%; height: auto; border-radius: 6px; display: block; cursor: zoom-in;`
                                }
                            });
                            
                            // ì´ë¯¸ì§€ í´ë¦­ ì‹œ í™•ëŒ€ (ë„¤ë¹„ê²Œì´ì…˜ í¬í•¨)
                            noteImg.addEventListener('click', (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                this.showImageZoom(imageUrl, 'ë…¸íŠ¸ ì´ë¯¸ì§€', allImageUrls, imgIndex);
                            });
                            
                            noteImg.onerror = () => {
                                imgWrapper.setText('âš ï¸ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
                                imgWrapper.style.color = 'var(--text-muted)';
                                imgWrapper.style.padding = '10px';
                            };
                        });
                    }
                    
                    // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ì´ì „ì— ì‚½ì…
                    feedback.insertBefore(noteDisplay, btnContainer);
                    noteBtn.setText('ğŸ“ ë…¸íŠ¸ ë‹«ê¸°');
                }
            };
            
            noteBtn.addEventListener('click', handleNoteToggle);
            noteBtn.addEventListener('touchend', handleNoteToggle);
        }

        // "ë‹¤ìŒ ë¬¸ì œ" ë²„íŠ¼
        const nextBtn = btnContainer.createEl('button', { 
            text: 'ë‹¤ìŒ ë¬¸ì œ â†’',
            cls: 'next-button'
        });
        nextBtn.style.padding = '12px 25px';
        nextBtn.style.fontSize = '16px';
        nextBtn.style.backgroundColor = 'white';
        nextBtn.style.color = isCorrect ? '#4caf50' : '#f44336';
        nextBtn.style.border = 'none';
        nextBtn.style.borderRadius = '20px';
        nextBtn.style.cursor = 'pointer';
        nextBtn.style.fontWeight = 'bold';

        nextBtn.style.touchAction = 'manipulation';

        nextBtn.style.webkitTapHighlightColor = 'rgba(0,0,0,0.1)';


        nextBtn.addEventListener('click', () => {
            feedback.remove();
            this.currentIndex++;
            this.showQuestion();
        });
    }

    async showResults() {
        const { contentEl } = this;
        contentEl.empty();

        const endTime = Date.now();
        console.log('ğŸ“Š [showResults] ì‹œê°„ ê³„ì‚° ë””ë²„ê¹…');
        console.log('  startTime:', this.startTime, new Date(this.startTime).toISOString());
        console.log('  endTime:', endTime, new Date(endTime).toISOString());
        
        let totalTimeSeconds = Math.round((endTime - this.startTime) / 1000);
        console.log('  ê³„ì‚°ëœ ì‹œê°„(ì´ˆ):', totalTimeSeconds);
        
        // ë°©ì–´ì : 0ì´ˆë¡œ ì €ì¥ë˜ëŠ” ê²½ìš° ë°©ì§€
        if (!this.startTime || isNaN(this.startTime) || totalTimeSeconds <= 0) {
            console.warn('âš ï¸ startTimeì´ ì˜ëª»ë˜ì—ˆê±°ë‚˜ 0ì´ˆë¡œ ê³„ì‚°ë¨');
            // ê¸°ë³¸ê°’ìœ¼ë¡œ 1ì´ˆ ì„¤ì • (ìµœì†Œ 1ì´ˆ)
            totalTimeSeconds = 1;
        }
        
        // ë¹„ì •ìƒì ìœ¼ë¡œ í° ì‹œê°„(1ì‹œê°„ ì´ìƒ)ì€ ì œí•œ
        if (totalTimeSeconds > 3600) {
            console.warn('âš ï¸ ë¹„ì •ìƒì ìœ¼ë¡œ ê¸´ ì‹œê°„ ê°ì§€:', totalTimeSeconds, 'ì´ˆ');
            totalTimeSeconds = 3600;
        }
        
        console.log('  ìµœì¢… ì €ì¥ë  ì‹œê°„(ì´ˆ):', totalTimeSeconds);
        const percentage = Math.round((this.score / this.questions.length) * 100);
        
        // ì‹œê°„ì„ ë¶„ê³¼ ì´ˆë¡œ ë³€í™˜
        const minutes = Math.floor(totalTimeSeconds / 60);
        const seconds = totalTimeSeconds % 60;
        const timeDisplay = minutes > 0 
            ? `${minutes}ë¶„ ${seconds}ì´ˆ` 
            : `${seconds}ì´ˆ`;
        
        // í€´ì¦ˆ ì™„ë£Œ ë¡œê·¸ ë‚¨ê¸°ê¸° (í•œ ì¤„ë¡œ í†µí•©)
        this.appendLog(`í€´ì¦ˆ ì™„ë£Œ: ${this.score}/${this.questions.length} (${percentage}%) - ì†Œìš”ì‹œê°„: ${timeDisplay}`);

        const results = contentEl.createDiv({ cls: 'quiz-results' });
        
        // ì œëª©ê³¼ ì‹œê°„ì„ í•œ ì¤„ì—
        const titleRow = results.createDiv();
        titleRow.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        `;
        
        const title = titleRow.createEl('h1', { text: 'ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!' });
        title.style.cssText = `
            font-size: 24px;
            margin: 0;
        `;
        
        const timeInfo = titleRow.createEl('div', { text: `â±ï¸ ${timeDisplay}` });
        timeInfo.style.cssText = `
            font-size: 18px;
            font-weight: 600;
            color: var(--text-muted);
        `;

        // ì ìˆ˜ í‘œì‹œ - ì»´íŒ©íŠ¸í•˜ê²Œ (2ì¹¸ë§Œ)
        const scoreCard = results.createDiv({ cls: 'score-card' });
        scoreCard.style.cssText = `
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, var(--interactive-accent) 0%, var(--interactive-accent-hover) 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        `;
        scoreCard.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: white;">${this.score} / ${this.questions.length}</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">ì •ë‹µ / ì „ì²´</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: 32px; font-weight: 700; color: white;">${percentage}%</div>
                <div style="font-size: 12px; color: rgba(255,255,255,0.8); margin-top: 4px;">ì •ë‹µë¥ </div>
            </div>
        `;

        // ê²°ê³¼ ì €ì¥ (ì‹œê°„ì„ ì´ˆ ë‹¨ìœ„ë¡œ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥)
        const saveResult = {
            correct: this.score,
            incorrect: this.questions.length - this.score,
            total: this.questions.length,
            percentage: percentage,
            details: this.results,
            time: totalTimeSeconds  // ì´ˆ ë‹¨ìœ„ë¡œ ì €ì¥
        };
        
        console.log('ğŸ“Š [showResults] í€´ì¦ˆ ê²°ê³¼ ì €ì¥ - ì‹œê°„(ì´ˆ):', totalTimeSeconds, 'startTime:', this.startTime, 'endTime:', endTime);
        console.log('ğŸ“Š [showResults] saveResult:', JSON.stringify(saveResult, null, 2));

        await this.plugin.saveQuizResult(saveResult);

        // ë¡œê·¸/íˆìŠ¤í† ë¦¬ ì˜ì—­ (ì ìˆ˜ ë°”ë¡œ ë‹¤ìŒì— ë°°ì¹˜)
        const logSection = results.createDiv({ cls: 'quiz-log-history' });
        logSection.style.cssText = `
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid var(--interactive-accent);
            border-radius: 12px;
            max-height: 300px;
            overflow-y: auto;
        `;
        
        const logHeaderContainer = logSection.createDiv();
        logHeaderContainer.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        `;
        
        const logHeader = logHeaderContainer.createEl('h3', { text: 'ğŸ“ í€´ì¦ˆ ë¡œê·¸' });
        logHeader.style.cssText = `
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            color: var(--interactive-accent);
        `;
        
        const logList = logSection.createEl('ul', { cls: 'quiz-log-list' });
        logList.style.cssText = `
            list-style: none;
            padding: 0;
            margin: 0;
        `;
        
        // ì „ì²´ ì‚­ì œ ë²„íŠ¼ (logList ìƒì„± í›„ì— ë°°ì¹˜)
        const clearAllBtn = logHeaderContainer.createEl('button', { text: 'ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ' });
        clearAllBtn.style.cssText = `
            padding: 4px 12px;
            font-size: 11px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        `;
        clearAllBtn.addEventListener('mouseenter', () => {
            clearAllBtn.style.background = '#d32f2f';
        });
        clearAllBtn.addEventListener('mouseleave', () => {
            clearAllBtn.style.background = '#f44336';
        });
        clearAllBtn.addEventListener('click', () => {
            this.plugin.quizLogHistory = [];
            logList.empty();
            const emptyMsg = logList.createEl('li');
            emptyMsg.style.cssText = `
                padding: 20px;
                text-align: center;
                color: var(--text-muted);
                font-size: 13px;
            `;
            emptyMsg.textContent = 'ì•„ì§ ê¸°ë¡ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
        });
        
        // í”ŒëŸ¬ê·¸ì¸ ë ˆë²¨ì˜ logHistory ì‚¬ìš©
        if (this.plugin.quizLogHistory && this.plugin.quizLogHistory.length > 0) {
            // ìµœì‹  ë¡œê·¸ë¥¼ ìœ„ì— í‘œì‹œ (ì—­ìˆœ)
            [...this.plugin.quizLogHistory].reverse().forEach((log, reversedIdx) => {
                const idx = this.plugin.quizLogHistory.length - 1 - reversedIdx;
                const logItem = logList.createEl('li', { cls: 'quiz-log-item' });
                logItem.style.cssText = `
                    padding: 10px 12px;
                    margin-bottom: 8px;
                    background: var(--background-primary);
                    border-radius: 6px;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-left: 3px solid var(--interactive-accent);
                    transition: all 0.2s;
                `;
                
                logItem.addEventListener('mouseenter', () => {
                    logItem.style.background = 'var(--background-primary-alt)';
                });
                logItem.addEventListener('mouseleave', () => {
                    logItem.style.background = 'var(--background-primary)';
                });
                
                const logContent = logItem.createDiv();
                logContent.style.flex = '1';
                logContent.innerHTML = `
                    <span style="color: var(--text-muted); font-size: 11px; display: block; margin-bottom: 4px;">${log.timestamp}</span>
                    <span style="color: var(--text-normal); font-size: 13px;">${log.message}</span>
                `;
                
                const deleteBtn = logItem.createEl('button', { cls: 'quiz-log-delete-btn' });
                deleteBtn.setText('Ã—');
                deleteBtn.style.cssText = `
                    margin-left: 12px;
                    background: transparent;
                    border: none;
                    color: #f44336;
                    font-size: 20px;
                    cursor: pointer;
                    padding: 0 8px;
                    line-height: 1;
                    transition: all 0.2s;
                `;
                deleteBtn.addEventListener('mouseenter', () => {
                    deleteBtn.style.color = '#d32f2f';
                    deleteBtn.style.transform = 'scale(1.2)';
                });
                deleteBtn.addEventListener('mouseleave', () => {
                    deleteBtn.style.color = '#f44336';
                    deleteBtn.style.transform = 'scale(1)';
                });
                deleteBtn.addEventListener('click', () => {
                    this.plugin.quizLogHistory.splice(idx, 1);
                    logItem.remove();
                    if (this.plugin.quizLogHistory.length === 0) {
                        const emptyMsg = logList.createEl('li');
                        emptyMsg.style.cssText = `
                            padding: 20px;
                            text-align: center;
                            color: var(--text-muted);
                            font-size: 13px;
                        `;
                        emptyMsg.textContent = 'ì•„ì§ ê¸°ë¡ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    }
                });
            });
        } else {
            const emptyMsg = logList.createEl('li');
            emptyMsg.style.cssText = `
                padding: 20px;
                text-align: center;
                color: var(--text-muted);
                font-size: 13px;
            `;
            emptyMsg.textContent = 'ì•„ì§ ê¸°ë¡ëœ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.';
        }

        // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ (ìŠ¤í¬ë¡¤ ì˜ì—­ ë°–ì— ê³ ì •)
        const buttonContainer = results.createDiv({ cls: 'results-buttons' });
        buttonContainer.style.cssText = `
            margin-top: 20px !important;
            padding-top: 20px !important;
            border-top: 2px solid var(--background-modifier-border) !important;
            display: flex !important;
            flex-wrap: wrap !important;
            overflow-x: visible !important;
            gap: 8px !important;
            width: 100% !important;
            box-sizing: border-box !important;
            justify-content: flex-start !important;
        `;
        
        // webkit ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ ìŠ¤íƒ€ì¼ ì œê±° (ì´ì œ wrap ì‚¬ìš©)
        
        const retryBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ”„ ë‹¤ì‹œí’€ê¸°',
            cls: 'mod-cta results-btn'
        });
        retryBtn.addEventListener('click', () => {
            this.close();
            this.currentIndex = 0;
            this.score = 0;
            this.results = [];
            this.startTime = Date.now();
            this.questions = this.plugin.settings.shuffleQuestions ? 
                this.shuffleArray([...this.allQuestions]) : [...this.allQuestions];
            
            this.showQuestion();
        });
        
        const detailBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ“Š ìƒì„¸ê¸°ë¡',
            cls: 'mod-cta results-btn'
        });
        detailBtn.addEventListener('click', () => {
            this.close();
            new QuizDetailRecordModal(this.app, this.plugin, saveResult).open();
        });
        
        const folderBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ“ í´ë”ê´€ë¦¬',
            cls: 'results-btn'
        });
        folderBtn.addEventListener('click', () => {
            this.showFolderSelection();
        });

        const wrongBtn = buttonContainer.createEl('button', { 
            text: 'âŒ ì˜¤ë‹µë³µìŠµ',
            cls: 'results-btn'
        });
        wrongBtn.addEventListener('click', async () => {
            this.close();
            await this.plugin.startWrongAnswerQuiz();
        });

        const dashboardBtn = buttonContainer.createEl('button', { 
            text: 'ğŸ“Š ëŒ€ì‹œë³´ë“œë¡œ',
            cls: 'results-btn'
        });
        dashboardBtn.style.cssText = 'background: #3b82f6; color: white;';
        const dashboardBtnHandler = () => {
            this.close();
            this.plugin.openDashboard();
        };
        dashboardBtn.addEventListener('click', dashboardBtnHandler);
        dashboardBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            dashboardBtnHandler();
        });

        const closeBtn = buttonContainer.createEl('button', { 
            text: 'ğŸšª ì¢…ë£Œ',
            cls: 'results-btn'
        });
        closeBtn.style.cssText = 'background: #ef4444; color: white;';
        const closeBtnHandler = () => {
            this.close();
            // ëª¨ë“  í€´ì¦ˆ ê´€ë ¨ ë·°ì™€ ëª¨ë‹¬ ì™„ì „íˆ ì¢…ë£Œ
            this.app.workspace.detachLeavesOfType('quiz-dashboard-view');
            const leaves = this.app.workspace.getLeavesOfType('quiz-dashboard-view');
            leaves.forEach(leaf => leaf.detach());
        };
        closeBtn.addEventListener('click', closeBtnHandler);
        closeBtn.addEventListener('touchend', (e) => {
            e.preventDefault();
            closeBtnHandler();
        });
    }

    addStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .quiz-play-modal {
                padding: 20px;
                max-width: 700px;
                width: 100%;
                margin: 0 auto;
                max-height: 90vh;
                overflow-y: auto;
                overflow-x: hidden;
                box-sizing: border-box;
            }
            .quiz-header {
                display: flex;
                flex-direction: column;
                gap: 12px;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid var(--background-modifier-border);
                width: 100%;
                box-sizing: border-box;
            }
            
            /* ì»¨íŠ¸ë¡¤ ë°” ìŠ¤íƒ€ì¼ */
            .quiz-control-bar {
                display: flex;
                gap: 8px;
                justify-content: flex-end;
                margin-bottom: 10px;
                flex-wrap: wrap;
                width: 100%;
            }
            
            .control-button {
                padding: 8px 16px;
                font-size: 14px;
                border-radius: 6px;
                border: 2px solid var(--background-modifier-border);
                background: var(--background-secondary);
                color: var(--text-normal);
                cursor: pointer;
                transition: all 0.2s;
                min-height: 44px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .control-button:hover:not(:disabled) {
                border-color: var(--interactive-accent);
                background: var(--background-modifier-hover);
                transform: translateY(-2px);
            }
            
            .control-button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            
            .control-button.prev-button {
                border-color: rgba(33, 150, 243, 0.5);
            }
            
            .control-button.pause-button {
                border-color: rgba(255, 152, 0, 0.5);
            }
            
            .control-button.settings-button {
                border-color: rgba(158, 158, 158, 0.5);
                min-width: 44px;
                padding: 8px;
            }
            
            .quiz-progress {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                overflow: hidden;
                flex-wrap: wrap;
                gap: 8px;
            
            /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ (ë‘ê»ê³  í™”ë ¤í•˜ê²Œ - 25px, ê·¸ë¼ë°ì´ì…˜, ê·¸ë¦¼ì) */
            .hanzi-timer-container {
                position: relative;
                width: 100%;
                background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
                border-radius: 12px;
                overflow: hidden;
                border: 3px solid var(--interactive-accent);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                height: 25px;
                margin: 10px 0;
            }

            .hanzi-timer-progress {
                width: 100%;
                height: 100%;
                background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
                position: relative;
                overflow: hidden;
            }

            .hanzi-timer-fill {
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, var(--interactive-accent) 0%, #4caf50 50%, #8bc34a 100%);
                transition: width 0.1s linear;
                box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
                position: absolute;
                top: 0;
                left: 0;
            }

            .hanzi-timer-container.timer-warning {
                border-color: #ff9800;
                animation: timer-pulse-warning 1s infinite;
            }

            .hanzi-timer-container.timer-warning .hanzi-timer-fill {
                background: linear-gradient(90deg, #f39c12, #e67e22);
                box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
            }

            .hanzi-timer-container.timer-expired {
                border-color: #f44336;
                animation: timer-pulse-danger 0.5s infinite;
            }

            .hanzi-timer-container.timer-expired .hanzi-timer-fill {
                background: linear-gradient(90deg, #e74c3c, #c0392b);
                box-shadow: 0 0 20px rgba(231, 76, 60, 0.8);
            }

            @keyframes timer-pulse-warning {
                0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3); }
                50% { transform: scale(1.01); box-shadow: 0 6px 20px rgba(243, 156, 18, 0.5); }
            }

            @keyframes timer-pulse-danger {
                0%, 100% { transform: scale(1); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4); }
                50% { transform: scale(1.02); box-shadow: 0 8px 25px rgba(231, 76, 60, 0.7); }
            }
            
            /* íƒ€ì´ë¨¸ í…ìŠ¤íŠ¸ (ì´ˆ í‘œì‹œ) */
            .hanzi-timer-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: #ffffff;
                font-size: 14px;
                font-weight: 900;
                z-index: 10;
                text-align: center;
                text-shadow: 0 0 8px rgba(0, 0, 0, 0.8), 0 2px 4px rgba(0, 0, 0, 0.6);
                font-family: 'Arial Black', Arial, sans-serif;
                min-width: 50px;
                padding: 2px 10px;
                background: rgba(0, 0, 0, 0.3);
                border-radius: 12px;
                backdrop-filter: blur(3px);
            }
            
            .quiz-timer {
                font-size: 18px;
                font-weight: bold;
            }
            
            /* ë‚œì´ë„ ë±ƒì§€ - ì»¨íŠ¸ë¡¤ ë°”ì— í†µí•© */
            .quiz-control-bar .difficulty-badge {
                display: inline-block;
                padding: 6px 12px;
                border-radius: 12px;
                font-size: 0.8em;
                font-weight: 600;
                margin: 0 4px;
            }

            .quiz-control-bar .difficulty-badge.difficulty-ì‰¬ì›€ {
                background: #4caf50;
                color: white;
            }

            .quiz-control-bar .difficulty-badge.difficulty-ë³´í†µ {
                background: #ff9800;
                color: white;
            }

            .quiz-control-bar .difficulty-badge.difficulty-ì–´ë ¤ì›€ {
                background: #f44336;
                color: white;
            }
            
            /* í•œì í‘œì‹œ - í¬ê²Œ */
            .hanzi-display {
                text-align: center;
                margin: 50px 0;
                width: 100%;
                overflow: hidden;
            }
            
            .hanzi-character {
                font-size: clamp(120px, 20vw, 180px);
                font-weight: bold;
                color: var(--text-normal);
                text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.15);
                line-height: 1.2;
                word-break: break-all;
            }
            
            /* ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ - ìŠ¤í¬ë¡¤ ì˜ì—­ ë‚´ í¬í•¨ */
            .question-image-container {
                text-align: center;
                margin: 15px 0;
                padding: 8px;
                background: var(--background-secondary);
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                width: 100%;
                box-sizing: border-box;
                overflow: hidden !important;
                position: relative;
                max-height: 250px;
            }
            
            .question-image-container img,
            .quiz-question-image {
                max-width: 100% !important;
                max-height: 300px !important;
                width: auto !important;
                height: auto !important;
                object-fit: contain !important;
                border-radius: 8px !important;
                display: block !important;
                margin: 0 auto !important;
                cursor: zoom-in !important;
                transition: transform 0.2s ease, box-shadow 0.2s ease !important;
            }
            
            .question-image-container img:hover,
            .quiz-question-image:hover {
                transform: scale(1.02) !important;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
            }
            
            /* ëª¨ë°”ì¼ ìµœì í™” */
            @media (max-width: 768px) {
                .question-image-container img,
                .quiz-question-image {
                    max-height: 250px !important;
                }
            }
            
            @media (max-width: 480px) {
                .question-image-container img,
                .quiz-question-image {
                    max-height: 200px !important;
                }
            }
            
            /* ë¬¸ì œ í…ìŠ¤íŠ¸ - ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì • */
            .question-text {
                text-align: center;
                margin-bottom: 20px;
                font-size: clamp(20px, 5vw, 28px);
                padding: 15px 10px;
                width: 100%;
                box-sizing: border-box;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.6;
                color: var(--text-normal);
                max-height: 300px;
                overflow-y: auto;
                overflow-x: hidden;
                /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
                scrollbar-width: thin;
                scrollbar-color: var(--interactive-accent) var(--background-modifier-border);
            }
            
            .question-text::-webkit-scrollbar {
                width: 8px;
            }
            
            .question-text::-webkit-scrollbar-track {
                background: var(--background-modifier-border);
                border-radius: 4px;
            }
            
            .question-text::-webkit-scrollbar-thumb {
                background: var(--interactive-accent);
                border-radius: 4px;
            }
            
            .question-text::-webkit-scrollbar-thumb:hover {
                background: var(--interactive-accent-hover);
            }
            
            .question-text h3 {
                margin-bottom: 10px;
                font-size: 1.3em;
            }
            
            .options-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 20px;
                width: 100%;
            }
            .option-button {
                padding: 20px 24px;
                font-size: 18px;
                font-weight: 500;
                text-align: left;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.2s;
                background: linear-gradient(135deg, var(--background-secondary) 0%, var(--background-primary-alt) 100%);
                border: 2px solid var(--background-modifier-border);
                min-height: 64px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                width: 100%;
                box-sizing: border-box;
                white-space: normal;
                word-wrap: break-word;
                overflow-wrap: break-word;
                line-height: 1.6;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            }
            
            .option-image-container {
                width: 100%;
                display: flex;
                justify-content: center;
                align-items: center;
                margin-top: 8px;
                max-height: 100px;
                overflow: hidden;
            }
            
            .option-image-container img {
                max-width: 100%;
                max-height: 100px;
                object-fit: contain;
                border-radius: 4px;
            }
            
            .option-text {
                width: 100%;
                text-align: left;
            }
            
            .option-button:hover {
                transform: translateY(-2px);
                background: linear-gradient(135deg, var(--background-modifier-hover) 0%, var(--background-secondary) 100%);
                border-color: var(--interactive-accent);
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            }
            .action-bar {
                display: flex;
                justify-content: flex-start;
                gap: 10px;
                margin-top: 20px;
                flex-wrap: nowrap;
                width: 100%;
                overflow-x: auto;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }
            .action-bar::-webkit-scrollbar {
                display: none;
            }
            .action-bar button {
                min-height: 48px;
                padding: 12px 20px;
                font-size: 16px;
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                border-radius: 8px;
                border: 2px solid var(--background-modifier-border);
                background: linear-gradient(135deg, #f59e0b, #d97706);
                color: #000;
                font-weight: 700;
                cursor: pointer;
                transition: all 0.2s;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex-shrink: 0;
                min-width: 100px;
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
            }
            
            .action-bar button:hover {
                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.6);
            }
            

            .quiz-results {
                text-align: center;
                width: 100%;
                box-sizing: border-box;
            }
            .score-card {
                padding: 40px;
                background: var(--background-secondary);
                border-radius: 15px;
                margin: 30px 0;
                width: 100%;
                box-sizing: border-box;
            }
            .score-big {
                font-size: 60px;
                font-weight: bold;
                color: var(--interactive-accent);
                word-break: break-all;
            }
            .score-percentage {
                font-size: 40px;
                font-weight: bold;
                margin-top: 10px;
            }
            .score-time {
                font-size: 18px;
                color: var(--text-muted);
                margin-top: 10px;
            }
            .results-details {
                margin: 30px 0;
                text-align: left;
                width: 100%;
                overflow: hidden;
            }
                // Part 3: Quiz Results & Statistics

            .result-item {
                padding: 15px;
                margin-bottom: 8px;
                background: var(--background-secondary);
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 15px;
                width: 100%;
                box-sizing: border-box;
                overflow: hidden;
            }
            .result-number {
                font-weight: bold;
                color: var(--text-muted);
                flex-shrink: 0;
            }
            .result-hanzi {
                font-size: 24px;
                font-weight: bold;
                flex-shrink: 0;
                word-break: break-all;
            }
            .results-buttons {
                display: flex !important;
                gap: 8px !important;
                justify-content: flex-start !important;
                margin-top: 20px !important;
                padding-bottom: 20px !important;
                flex-wrap: wrap !important;
                width: 100% !important;
                overflow-x: visible !important;
                box-sizing: border-box !important;
            }
            .results-btn {
                min-height: 44px !important;
                padding: 10px 16px !important;
                font-size: 14px !important;
                flex-shrink: 0 !important;
                touch-action: manipulation !important;
                -webkit-tap-highlight-color: transparent !important;
                white-space: nowrap !important;
                box-sizing: border-box !important;
                border-radius: 8px !important;
                border: 2px solid var(--background-modifier-border) !important;
                background: linear-gradient(135deg, #f59e0b, #d97706) !important;
                color: #000 !important;
                font-weight: 700 !important;
                cursor: pointer !important;
                box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4) !important;
            }
            
            .results-btn:hover {
                background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
                transform: translateY(-2px) !important;
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.6) !important;
            }
            
            .results-btn-full {
                flex-basis: 100% !important;
                width: 100% !important;
            }
            
            /* ëª¨ë°”ì¼ ë°˜ì‘í˜• ìµœì í™” */
            @media (max-width: 768px) {
                .quiz-play-modal { 
                    padding: 12px !important; 
                    max-width: 100vw !important;
                }
                .quiz-header { 
                    gap: 8px !important; 
                    margin-bottom: 12px !important; 
                    padding-bottom: 10px !important; 
                }
                .question-text { 
                    max-height: 250px !important; 
                    margin-bottom: 15px !important; 
                    font-size: clamp(18px, 4.5vw, 24px) !important; 
                    padding: 20px 12px !important; 
                }
                .quiz-control-bar { 
                    flex-wrap: nowrap !important; 
                    gap: 6px !important; 
                    overflow-x: auto !important; 
                    scrollbar-width: none !important; 
                }
                .quiz-control-bar::-webkit-scrollbar { display: none !important; }
                .control-button { 
                    padding: 10px 12px !important; 
                    font-size: 14px !important; 
                    min-height: 44px !important; 
                    flex-shrink: 0 !important; 
                }
                .hanzi-timer-container { height: 48px !important; }
                .hanzi-timer-text { 
                    font-size: 16px !important; 
                    padding: 4px 12px !important; 
                }
                .hanzi-display { 
                    margin: 16px 0 !important;
                    font-size: 64px !important;
                }
                .question-image-container { 
                    margin: 12px 0 !important; 
                    padding: 6px !important; 
                    max-height: 220px !important; 
                }
                .question-image-container img, 
                .quiz-question-image { 
                    max-height: 200px !important; 
                }
                .options-container { 
                    gap: 10px !important; 
                    margin-bottom: 16px !important; 
                }
                .option-button { 
                    padding: 16px 18px !important; 
                    font-size: 16px !important;
                    min-height: 56px !important;
                }
                .option-image-container { max-height: 90px !important; }
                .option-image-container img { max-height: 90px !important; }
                .bookmark-container {
                    padding: 16px 20px !important;
                    margin: 0 12px 16px 12px !important;
                }
                .nav-controls-container {
                    padding: 12px 12px !important;
                    margin: 0 12px 16px 12px !important;
                    gap: 10px !important;
                }
                .nav-controls-container button {
                    min-height: 52px !important;
                    font-size: 18px !important;
                }
                .action-bar { 
                    flex-wrap: nowrap !important; 
                    gap: 10px !important; 
                    overflow-x: auto !important; 
                    scrollbar-width: none !important; 
                    padding: 10px 6px !important; 
                }
                .action-bar::-webkit-scrollbar { display: none !important; }
                .action-bar button { 
                    padding: 14px 18px !important; 
                    font-size: 15px !important; 
                    min-height: 50px !important; 
                    flex-shrink: 0 !important; 
                    min-width: 100px !important; 
                }
                .score-card { 
                    padding: 30px 20px !important; 
                    margin: 20px 0 !important; 
                }
                .score-big { font-size: clamp(40px, 12vw, 60px) !important; }
                .score-percentage { font-size: clamp(28px, 8vw, 40px) !important; }
                .result-item { 
                    padding: 12px !important; 
                    gap: 12px !important; 
                }
                .result-hanzi { font-size: 20px !important; }
                .results-buttons { 
                    padding: 8px 4px 30px 4px !important;
                    gap: 8px !important;
                }
            }
            
            @media (max-width: 480px) {
                .quiz-play-modal { 
                    padding: 10px !important; 
                    max-width: 100vw !important;
                    margin: 0 !important;
                }
                .quiz-control-bar { gap: 4px !important; }
                .control-button { 
                    padding: 8px 10px !important; 
                    font-size: 13px !important; 
                    min-height: 42px !important; 
                }
                .question-text { 
                    max-height: 200px !important; 
                    margin-bottom: 12px !important; 
                    font-size: clamp(16px, 4vw, 20px) !important; 
                    padding: 16px 10px !important; 
                }
                .hanzi-display {
                    font-size: 56px !important;
                    margin: 12px 0 !important;
                }
                .question-image-container { 
                    margin: 10px 0 !important; 
                    padding: 5px !important; 
                    max-height: 180px !important; 
                }
                .question-image-container img, 
                .quiz-question-image { 
                    max-height: 165px !important; 
                }
                .options-container {
                    gap: 8px !important;
                }
                .option-button {
                    padding: 14px 14px !important;
                    font-size: 15px !important;
                    min-height: 52px !important;
                }
                .bookmark-container {
                    padding: 14px 16px !important;
                    margin: 0 8px 12px 8px !important;
                }
                .nav-controls-container {
                    padding: 10px 10px !important;
                    margin: 0 8px 12px 8px !important;
                    gap: 8px !important;
                }
                .nav-controls-container button {
                    min-height: 50px !important;
                    font-size: 16px !important;
                }
                .action-bar { 
                    flex-wrap: nowrap !important; 
                    gap: 8px !important; 
                    padding: 8px 4px !important; 
                }
                .action-bar button { 
                    padding: 12px 16px !important; 
                    font-size: 14px !important; 
                    min-height: 48px !important; 
                    min-width: 90px !important; 
                }
                .results-buttons { 
                    gap: 8px !important; 
                    padding: 8px 4px 30px 4px !important;
                }
                .results-btn {
                    padding: 12px 20px !important;
                    font-size: 15px !important;
                    min-height: 48px !important;
                }
                .quiz-progress { 
                    flex-direction: column !important; 
                    gap: 8px !important; 
                    align-items: flex-start !important; 
                }
                .difficulty-badge { 
                    padding: 4px 12px !important; 
                    font-size: 13px !important; 
                }
                .option-image-container { max-height: 70px !important; }
                .option-image-container img { max-height: 70px !important; }
            }
            
            /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
            @media (hover: none) and (pointer: coarse) {
                .option-button,
                .action-bar button,
                .results-btn,
                .nav-controls-container button,
                .bookmark-container {
                    min-height: 52px !important;
                    padding: 16px 20px !important;
                }
                
                .option-button:active {
                    transform: scale(0.97) !important;
                    background: var(--background-modifier-hover) !important;
                }
                
                .results-btn:active,
                .nav-controls-container button:active {
                    transform: scale(0.97) !important;
                }
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        // ESCë¡œ ë‹«íˆë ¤ê³  í•  ë•Œ í™•ì¸ ëª¨ë‹¬ ëŒ€ì‹  ë°”ë¡œ ë‹«ê¸° í—ˆìš©
        // confirmExitëŠ” ë²„íŠ¼ì´ë‚˜ ëª…ì‹œì  ESCì—ì„œë§Œ í˜¸ì¶œë¨
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        if (this.keyboardHandlers) {
            this.keyboardHandlers.forEach(handler => {
                document.removeEventListener('keydown', handler);
            });
        }
        
        this.stopTimer();
        const { contentEl } = this;
        contentEl.empty();
    }
}

class HanziQuizSettingTab extends PluginSettingTab {
    constructor(app, plugin) {
        super(app, plugin);
        this.plugin = plugin;
    }

    display() {
        const { containerEl } = this;
        containerEl.empty();
        containerEl.addClass('hanzi-quiz-settings');

        // í—¤ë” ì„¹ì…˜
        const header = containerEl.createDiv({ cls: 'settings-header' });
        header.style.cssText = `
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        `;
        
        const title = header.createEl('h1', { text: 'âš™ï¸ í•œì í€´ì¦ˆ ì„¤ì •' });
        title.style.cssText = 'margin: 0 0 10px 0; font-size: 32px;';
        
        const subtitle = header.createEl('p', { text: 'ì„¸ë¶€ ì„¤ì •ì„ ì¡°ì •í•˜ì—¬ ìµœì ì˜ í•™ìŠµ í™˜ê²½ì„ ë§Œë“œì„¸ìš”' });
        subtitle.style.cssText = 'margin: 0; opacity: 0.9; font-size: 14px;';

        // íƒ­ ë„¤ë¹„ê²Œì´ì…˜
        const tabNav = containerEl.createDiv({ cls: 'settings-tab-nav' });
        tabNav.style.cssText = `
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            border-bottom: 2px solid var(--background-modifier-border);
            padding-bottom: 10px;
        `;
        
        const tabs = [
            { id: 'folders', icon: 'ğŸ“', text: 'í´ë” ì„¤ì •' },
            { id: 'quiz', icon: 'ğŸ¯', text: 'í€´ì¦ˆ ì„¤ì •' },
            { id: 'data', icon: 'ğŸ’¾', text: 'ë°ì´í„° ê´€ë¦¬' },
            { id: 'info', icon: 'â„¹ï¸', text: 'ì •ë³´' }
        ];
        
        let activeTab = 'folders';
        const tabButtons = [];
        
        tabs.forEach(tab => {
            const btn = tabNav.createEl('button', { text: `${tab.icon} ${tab.text}` });
            btn.style.cssText = `
                padding: 12px 20px;
                border: none;
                background: var(--background-secondary);
                color: var(--text-normal);
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                transition: all 0.2s;
                min-height: 44px;
            `;
            btn.dataset.tabId = tab.id;
            tabButtons.push(btn);
            
            btn.addEventListener('click', () => {
                activeTab = tab.id;
                updateTabContent();
                
                // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                tabButtons.forEach(b => {
                    b.style.background = b.dataset.tabId === activeTab 
                        ? 'var(--interactive-accent)' 
                        : 'var(--background-secondary)';
                    b.style.color = b.dataset.tabId === activeTab 
                        ? 'var(--text-on-accent)' 
                        : 'var(--text-normal)';
                });
            });
        });
        
        // ì»¨í…Œì´ë„ˆ
        const contentContainer = containerEl.createDiv({ cls: 'settings-content' });
        
        const updateTabContent = () => {
            contentContainer.empty();
            
            if (activeTab === 'folders') {
                this.renderFolderSettings(contentContainer);
            } else if (activeTab === 'quiz') {
                this.renderQuizSettings(contentContainer);
            } else if (activeTab === 'data') {
                this.renderDataSettings(contentContainer);
            } else if (activeTab === 'info') {
                this.renderInfo(contentContainer);
            }
        };
        
        // ì´ˆê¸° íƒ­ í‘œì‹œ
        tabButtons[0].click();

        this.addSettingsStyles();
    }

    renderFolderSettings(container) {
        const section = container.createDiv({ cls: 'settings-section' });
        section.createEl('h2', { text: 'ğŸ“ í´ë” ì„¤ì •' });
        section.createEl('p', { 
            text: 'ë¬¸ì œ íŒŒì¼ê³¼ ê²°ê³¼ê°€ ì €ì¥ë  í´ë” ê²½ë¡œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.',
            cls: 'setting-description'
        }).style.color = 'var(--text-muted)';

        // í´ë” ì„¤ì •

        new Setting(section)
            .setName('í€´ì¦ˆ ë©”ì¸ í´ë”')
            .setDesc('í•œì í€´ì¦ˆ ê´€ë ¨ íŒŒì¼ì´ ì €ì¥ë  ìµœìƒìœ„ í´ë”')
            .addText(text => text
                .setPlaceholder('HanziQuiz')
                .setValue(this.plugin.settings.quizFolder)
                .onChange(async (value) => {
                    this.plugin.settings.quizFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(section)
            .setName('ë¬¸ì œ í´ë”')
            .setDesc('ê°œë³„ ë¬¸ì œ íŒŒì¼ì´ ì €ì¥ë˜ëŠ” í´ë”')
            .addText(text => text
                .setPlaceholder('HanziQuiz/Questions')
                .setValue(this.plugin.settings.questionsFolder)
                .onChange(async (value) => {
                    this.plugin.settings.questionsFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(section)
            .setName('ê²°ê³¼ í´ë”')
            .setDesc('í€´ì¦ˆ ê²°ê³¼ê°€ ì €ì¥ë˜ëŠ” í´ë”')
            .addText(text => text
                .setPlaceholder('HanziQuiz/Results')
                .setValue(this.plugin.settings.resultsFolder)
                .onChange(async (value) => {
                    this.plugin.settings.resultsFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(section)
            .setName('ì˜¤ë‹µ í´ë”')
            .setDesc('ì˜¤ë‹µ ë¬¸ì œê°€ ê¸°ë¡ë˜ëŠ” í´ë”')
            .addText(text => text
                .setPlaceholder('HanziQuiz/WrongAnswers')
                .setValue(this.plugin.settings.wrongAnswersFolder)
                .onChange(async (value) => {
                    this.plugin.settings.wrongAnswersFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(section)
            .setName('ì•„ì¹´ì´ë¸Œ í´ë”')
            .setDesc('ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë¬¸ì œë‚˜ íŒŒì¼ì„ ë³´ê´€í•˜ëŠ” í´ë”')
            .addText(text => text
                .setPlaceholder('HanziQuiz/Archive')
                .setValue(this.plugin.settings.archiveFolder)
                .onChange(async (value) => {
                    this.plugin.settings.archiveFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(section)
            .setName('ë¶ë§ˆí¬ í´ë”')
            .setDesc('ë¶ë§ˆí¬í•œ ë¬¸ì œë“¤ì´ í‘œì‹œë˜ëŠ” ê°€ìƒ í´ë” ì´ë¦„')
            .addText(text => text
                .setPlaceholder('â­ ë¶ë§ˆí¬')
                .setValue(this.plugin.settings.bookmarkFolder)
                .onChange(async (value) => {
                    this.plugin.settings.bookmarkFolder = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(section)
            .setName('ì²¨ë¶€íŒŒì¼ í´ë”ëª…')
            .setDesc('ê° ë¬¸ì œ í´ë” í•˜ìœ„ì— ìƒì„±ë˜ëŠ” ì²¨ë¶€íŒŒì¼ í´ë”ì˜ ì´ë¦„ (ì˜ˆ: 200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/)')
            .addText(text => text
                .setPlaceholder('ì²¨ë¶€íŒŒì¼')
                .setValue(this.plugin.settings.attachmentFolderName)
                .onChange(async (value) => {
                    this.plugin.settings.attachmentFolderName = value;
                    await this.plugin.saveSettings();
                }));

        // í´ë” ê´€ë¦¬ ë²„íŠ¼
        section.createEl('h3', { text: 'ğŸ“‚ í´ë” ê´€ë¦¬' });

        new Setting(section)
            .setName('í•„ìˆ˜ í´ë” ìƒì„±')
            .setDesc('ìœ„ì— ì„¤ì •ëœ ê²½ë¡œì— í´ë”ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ“ í´ë” ìƒì„±')
                .setCta()
                .onClick(async () => {
                    await this.plugin.ensureFolders();
                    new Notice('âœ… í•„ìˆ˜ í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }));

        new Setting(containerEl)
            .setName('ë¬¸ì œ íŒŒì¼ í™•ì¸')
            .setDesc('í˜„ì¬ ì¸ì‹ëœ ë¬¸ì œ íŒŒì¼ ê°œìˆ˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ” ë¬¸ì œ í™•ì¸')
                .onClick(async () => {
                    const questions = await this.plugin.loadAllQuestions();
                    new Notice(`ğŸ“ ì¸ì‹ëœ ë¬¸ì œ: ${questions.length}ê°œ`);
                    console.log('=== ë¬¸ì œ íŒŒì¼ í™•ì¸ ===');
                    console.log('ì´ ë¬¸ì œ ìˆ˜:', questions.length);
                    if (questions.length > 0) {
                        console.log('ì²« 3ê°œ ë¬¸ì œ:', questions.slice(0, 3).map(q => ({
                            í•œì: q.hanzi,
                            í´ë”: q.folder,
                            íŒŒì¼ê²½ë¡œ: q.filePath
                        })));
                    }
                }));

        new Setting(containerEl)
            .setName('ê²½ë¡œ ì§„ë‹¨')
            .setDesc('ë¬¸ì œ í´ë” ê²½ë¡œì™€ íŒŒì¼ ì¸ì‹ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ”§ ì§„ë‹¨ ì‹¤í–‰')
                .onClick(async () => {
                    console.log('=== í•œì í€´ì¦ˆ ê²½ë¡œ ì§„ë‹¨ ===');
                    
                    const allFiles = this.app.vault.getMarkdownFiles();
                    console.log('ì „ì²´ ë§ˆí¬ë‹¤ìš´ íŒŒì¼:', allFiles.length);
                    
                    const questionsFolder = this.plugin.settings.questionsFolder;
                    console.log('ì„¤ì •ëœ ë¬¸ì œ í´ë”:', questionsFolder);
                    
                    // ê²½ë¡œ ì •ê·œí™”
                    const normalizePath = (path) => {
                        if (!path) return '';
                        return path.replace(/\\/g, '/').replace(/\/+/g, '/').replace(/^\/+/, '');
                    };
                    
                    const normalizedFolder = normalizePath(questionsFolder);
                    console.log('ì •ê·œí™”ëœ í´ë”:', normalizedFolder);
                    
                    // HanziQuiz ê´€ë ¨ íŒŒì¼ ì°¾ê¸°
                    const hanziquizFiles = allFiles.filter(f => {
                        const np = normalizePath(f.path);
                        return np.includes('HanziQuiz') || np.includes('hanziquiz');
                    });
                    
                    console.log('HanziQuiz ê´€ë ¨ íŒŒì¼:', hanziquizFiles.length);
                    if (hanziquizFiles.length > 0) {
                        console.log('ìƒ˜í”Œ ê²½ë¡œ:');
                        hanziquizFiles.slice(0, 5).forEach(f => {
                            console.log(' -', f.path);
                        });
                    }
                    
                    // Questions í´ë” íŒŒì¼
                    const questionsFiles = allFiles.filter(f => {
                        const np = normalizePath(f.path);
                        return np.includes(normalizedFolder) && !f.path.includes('ë¬¸ì œëª©ë¡');
                    });
                    
                    console.log('Questions í´ë” ë¬¸ì œ íŒŒì¼:', questionsFiles.length);
                    
                    new Notice(`ğŸ“Š ì§„ë‹¨ ì™„ë£Œ: HanziQuiz íŒŒì¼ ${hanziquizFiles.length}ê°œ, ë¬¸ì œ íŒŒì¼ ${questionsFiles.length}ê°œ`);
                    new Notice('ğŸ’¡ ìì„¸í•œ ë‚´ìš©ì€ ê°œë°œì ì½˜ì†”(Ctrl+Shift+I)ì„ í™•ì¸í•˜ì„¸ìš”');
                }));

        // ì²¨ë¶€íŒŒì¼ ê´€ë¦¬
        containerEl.createEl('h3', { text: 'ğŸ“ ì²¨ë¶€íŒŒì¼ ê´€ë¦¬' });

        new Setting(containerEl)
            .setName('ì „ì²´ ì²¨ë¶€íŒŒì¼ ê°œìˆ˜ í™•ì¸')
            .setDesc('ëª¨ë“  ë¬¸ì œ í´ë”ì˜ ì²¨ë¶€íŒŒì¼ ê°œìˆ˜ë¥¼ í™•ì¸í•©ë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ“Š í†µê³„ ë³´ê¸°')
                .onClick(async () => {
                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                    const questionsFolder = this.plugin.settings.questionsFolder;
                    let totalFiles = 0;
                    const folderStats = [];

                    // ê° ë¬¸ì œ í´ë”ë³„ ì²¨ë¶€íŒŒì¼ í™•ì¸
                    if (this.plugin.settings.questionFolders) {
                        for (const subfolder of this.plugin.settings.questionFolders) {
                            const attachmentPath = `${questionsFolder}/${subfolder}/${attachmentFolderName}`;
                            const archivePath = `${questionsFolder}/${subfolder}/ì•„ì¹´ì´ë¸Œ/${attachmentFolderName}`;
                            
                            // ì¼ë°˜ ì²¨ë¶€íŒŒì¼ ê°œìˆ˜
                            let attachmentCount = 0;
                            const attachmentFolder = this.app.vault.getAbstractFileByPath(attachmentPath);
                            if (attachmentFolder && attachmentFolder.children) {
                                attachmentCount = attachmentFolder.children.filter(f => f.extension !== 'md').length;
                            }
                            
                            // ì•„ì¹´ì´ë¸Œ ì²¨ë¶€íŒŒì¼ ê°œìˆ˜
                            let archiveCount = 0;
                            const archiveFolder = this.app.vault.getAbstractFileByPath(archivePath);
                            if (archiveFolder && archiveFolder.children) {
                                archiveCount = archiveFolder.children.filter(f => f.extension !== 'md').length;
                            }
                            
                            const total = attachmentCount + archiveCount;
                            totalFiles += total;
                            
                            if (total > 0) {
                                folderStats.push({
                                    folder: subfolder,
                                    active: attachmentCount,
                                    archive: archiveCount,
                                    total: total
                                });
                            }
                        }
                    }

                    console.log('=== ì²¨ë¶€íŒŒì¼ í†µê³„ ===');
                    console.log(`ì´ ì²¨ë¶€íŒŒì¼: ${totalFiles}ê°œ`);
                    console.log('í´ë”ë³„ ìƒì„¸:');
                    folderStats.forEach(stat => {
                        console.log(`  ${stat.folder}: ${stat.total}ê°œ (í™œì„±: ${stat.active}, ì•„ì¹´ì´ë¸Œ: ${stat.archive})`);
                    });

                    new Notice(`ğŸ“Š ì „ì²´ ì²¨ë¶€íŒŒì¼: ${totalFiles}ê°œ (ìƒì„¸ ì •ë³´ëŠ” ì½˜ì†” í™•ì¸)`);
                }));

        new Setting(containerEl)
            .setName('ë¯¸ì‚¬ìš© ì²¨ë¶€íŒŒì¼ ì°¾ê¸°')
            .setDesc('ë¬¸ì œì—ì„œ ì°¸ì¡°ë˜ì§€ ì•ŠëŠ” ì²¨ë¶€íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ” ê²€ìƒ‰')
                .onClick(async () => {
                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                    const questionsFolder = this.plugin.settings.questionsFolder;
                    const unusedFiles = [];

                    // ëª¨ë“  ë¬¸ì œ íŒŒì¼ ë¡œë“œ
                    const questions = await this.plugin.loadAllQuestions();
                    const allReferencedFiles = new Set();

                    // ê° ë¬¸ì œì—ì„œ ì°¸ì¡°í•˜ëŠ” íŒŒì¼ëª… ìˆ˜ì§‘
                    for (const q of questions) {
                        const content = q.content || '';
                        const imageMatches = content.match(/!\[\[([^\]]+)\]\]/g);
                        if (imageMatches) {
                            imageMatches.forEach(match => {
                                const filename = match.match(/!\[\[(?:[^/]+\/)*([^\]|]+)/);
                                if (filename && filename[1]) {
                                    allReferencedFiles.add(filename[1]);
                                }
                            });
                        }
                    }

                    console.log('=== ë¯¸ì‚¬ìš© ì²¨ë¶€íŒŒì¼ ê²€ìƒ‰ ===');
                    console.log('ì°¸ì¡°ë˜ëŠ” íŒŒì¼:', allReferencedFiles.size, 'ê°œ');

                    // ê° ì²¨ë¶€íŒŒì¼ í´ë” í™•ì¸
                    if (this.plugin.settings.questionFolders) {
                        for (const subfolder of this.plugin.settings.questionFolders) {
                            const paths = [
                                `${questionsFolder}/${subfolder}/${attachmentFolderName}`,
                                `${questionsFolder}/${subfolder}/ì•„ì¹´ì´ë¸Œ/${attachmentFolderName}`
                            ];

                            for (const path of paths) {
                                const folder = this.app.vault.getAbstractFileByPath(path);
                                if (folder && folder.children) {
                                    const files = folder.children.filter(f => f.extension !== 'md');
                                    files.forEach(file => {
                                        if (!allReferencedFiles.has(file.name)) {
                                            unusedFiles.push({
                                                name: file.name,
                                                path: file.path,
                                                folder: subfolder,
                                                isArchive: path.includes('ì•„ì¹´ì´ë¸Œ')
                                            });
                                        }
                                    });
                                }
                            }
                        }
                    }

                    console.log(`ë¯¸ì‚¬ìš© íŒŒì¼: ${unusedFiles.length}ê°œ`);
                    if (unusedFiles.length > 0) {
                        console.log('ëª©ë¡:');
                        unusedFiles.forEach(file => {
                            console.log(`  ${file.folder}/${file.isArchive ? 'ì•„ì¹´ì´ë¸Œ/' : ''}${file.name}`);
                        });
                    }

                    new Notice(`ğŸ” ë¯¸ì‚¬ìš© ì²¨ë¶€íŒŒì¼: ${unusedFiles.length}ê°œ (ìƒì„¸ ì •ë³´ëŠ” ì½˜ì†” í™•ì¸)`);
                }));

        new Setting(containerEl)
            .setName('ì²¨ë¶€íŒŒì¼ ì•„ì¹´ì´ë¸Œë¡œ ì´ë™')
            .setDesc('ì„ íƒí•œ í´ë”ì˜ ëª¨ë“  ì²¨ë¶€íŒŒì¼ì„ ì•„ì¹´ì´ë¸Œë¡œ ì´ë™í•©ë‹ˆë‹¤')
            .addDropdown(dropdown => {
                dropdown.addOption('', '-- í´ë” ì„ íƒ --');
                if (this.plugin.settings.questionFolders) {
                    this.plugin.settings.questionFolders.forEach(folder => {
                        dropdown.addOption(folder, folder);
                    });
                }
                return dropdown;
            })
            .addButton(button => button
                .setButtonText('ğŸ“¦ ì´ë™')
                .onClick(async () => {
                    const dropdown = button.buttonEl.parentElement.querySelector('select');
                    const selectedFolder = dropdown.value;
                    
                    if (!selectedFolder) {
                        new Notice('âš ï¸ í´ë”ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                        return;
                    }

                    const attachmentFolderName = this.plugin.settings.attachmentFolderName || 'ì²¨ë¶€íŒŒì¼';
                    const questionsFolder = this.plugin.settings.questionsFolder;
                    const sourcePath = `${questionsFolder}/${selectedFolder}/${attachmentFolderName}`;
                    const targetPath = `${questionsFolder}/${selectedFolder}/ì•„ì¹´ì´ë¸Œ/${attachmentFolderName}`;

                    const sourceFolder = this.app.vault.getAbstractFileByPath(sourcePath);
                    if (!sourceFolder || !sourceFolder.children) {
                        new Notice('âŒ ì²¨ë¶€íŒŒì¼ í´ë”ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                        return;
                    }

                    // íƒ€ê²Ÿ í´ë” ìƒì„±
                    const targetExists = this.app.vault.getAbstractFileByPath(targetPath);
                    if (!targetExists) {
                        await this.app.vault.createFolder(targetPath);
                    }

                    // íŒŒì¼ ì´ë™
                    const files = sourceFolder.children.filter(f => f.extension !== 'md');
                    let movedCount = 0;

                    for (const file of files) {
                        const newPath = `${targetPath}/${file.name}`;
                        try {
                            await this.app.fileManager.renameFile(file, newPath);
                            movedCount++;
                        } catch (e) {
                            console.error('íŒŒì¼ ì´ë™ ì‹¤íŒ¨:', file.name, e);
                        }
                    }

                    new Notice(`âœ… ${movedCount}ê°œ íŒŒì¼ì„ ì•„ì¹´ì´ë¸Œë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤`);
                    console.log(`ğŸ“¦ ${selectedFolder}: ${movedCount}ê°œ íŒŒì¼ ì•„ì¹´ì´ë¸Œ ì™„ë£Œ`);
                }));

        // í€´ì¦ˆ ì„¤ì •
        containerEl.createEl('h2', { text: 'ğŸ¯ í€´ì¦ˆ ì„¤ì •' });

        new Setting(containerEl)
            .setName('íƒ€ì´ë¨¸ í™œì„±í™”')
            .setDesc('í€´ì¦ˆ ì¤‘ íƒ€ì´ë¨¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.enableTimer)
                .onChange(async (value) => {
                    this.plugin.settings.enableTimer = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ë¬¸ì œë‹¹ ì œí•œ ì‹œê°„')
            .setDesc('ê° ë¬¸ì œì— ì£¼ì–´ì§€ëŠ” ì‹œê°„(ì´ˆ)')
            .addText(text => text
                .setPlaceholder('30')
                .setValue(this.plugin.settings.timerPerQuestion.toString())
                .onChange(async (value) => {
                    const time = parseInt(value);
                    if (time > 0) {
                        this.plugin.settings.timerPerQuestion = time;
                        await this.plugin.saveSettings();
                    }
                }));

        new Setting(containerEl)
            .setName('ë¬¸ì œ ì„ê¸°')
            .setDesc('í€´ì¦ˆ ì‹œì‘ ì‹œ ë¬¸ì œ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ìŠµë‹ˆë‹¤')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.shuffleQuestions)
                .onChange(async (value) => {
                    this.plugin.settings.shuffleQuestions = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ì„ íƒì§€ ì„ê¸°')
            .setDesc('ê° ë¬¸ì œì˜ ì„ íƒì§€ ìˆœì„œë¥¼ ë¬´ì‘ìœ„ë¡œ ì„ìŠµë‹ˆë‹¤')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.shuffleOptions)
                .onChange(async (value) => {
                    this.plugin.settings.shuffleOptions = value;
                    await this.plugin.saveSettings();
                }));

        new Setting(containerEl)
            .setName('ì˜¤ë‹µ ì‹œ íŒíŠ¸ í‘œì‹œ')
            .setDesc('í‹€ë ¸ì„ ë•Œ íŒíŠ¸ë¥¼ ìë™ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.showHintAfterWrong)
                .onChange(async (value) => {
                    this.plugin.settings.showHintAfterWrong = value;
                    await this.plugin.saveSettings();
                }));

        // ğŸ“± ëª¨ë°”ì¼ ì„¤ì •
        containerEl.createEl('h2', { text: 'âš¡ ì„±ëŠ¥ ìµœì í™”' });

        new Setting(containerEl)
            .setName('ë ‰ ë°©ì§€ ëª¨ë“œ')
            .setDesc('ëª¨ë°”ì¼/ì €ì‚¬ì–‘ ê¸°ê¸°ì—ì„œ ë ‰ì„ ë°©ì§€í•©ë‹ˆë‹¤. ì• ë‹ˆë©”ì´ì…˜ì„ ìµœì†Œí™”í•˜ê³  GPU ê°€ì†ì„ í™œì„±í™”í•©ë‹ˆë‹¤.')
            .addToggle(toggle => toggle
                .setValue(this.plugin.settings.reducedAnimations)
                .onChange(async (value) => {
                    this.plugin.settings.reducedAnimations = value;
                    await this.plugin.saveSettings();
                    this.plugin.injectPerformanceCSS();
                    new Notice(value ? 'âš¡ ë ‰ ë°©ì§€ ëª¨ë“œ í™œì„±í™”ë¨' : 'âœ¨ ì¼ë°˜ ëª¨ë“œë¡œ ì „í™˜ë¨');
                }));

        // ë°ì´í„° ê´€ë¦¬
        containerEl.createEl('h2', { text: 'ğŸ’¾ ë°ì´í„° ê´€ë¦¬' });

        new Setting(containerEl)
            .setName('í†µê³„ ì´ˆê¸°í™”')
            .setDesc('ëª¨ë“  í•™ìŠµ í†µê³„ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤ (ë¬¸ì œëŠ” ì‚­ì œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)')
            .addButton(button => button
                .setButtonText('ğŸ—‘ï¸ í†µê³„ ì´ˆê¸°í™”')
                .setWarning()
                .onClick(async () => {
                    if (confirm('ì •ë§ë¡œ ëª¨ë“  í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        this.plugin.settings.stats = {
                            totalAttempts: 0,
                            totalCorrect: 0,
                            totalWrong: 0,
                            totalQuestions: 0,
                            bookmarkedCount: 0,
                            lastStudyDate: null,
                            studyHistory: []
                        };
                        await this.plugin.saveSettings();
                        new Notice('âœ… í†µê³„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    }
                }));

        new Setting(containerEl)
            .setName('ëª¨ë“  ë¬¸ì œ í†µê³„ ì´ˆê¸°í™”')
            .setDesc('ê° ë¬¸ì œì˜ ì •ë‹µ/ì˜¤ë‹µ íšŸìˆ˜ë¥¼ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ”„ ë¬¸ì œ í†µê³„ ì´ˆê¸°í™”')
                .setWarning()
                .onClick(async () => {
                    if (confirm('ëª¨ë“  ë¬¸ì œì˜ í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        const questions = await this.plugin.loadAllQuestions();
                        for (const question of questions) {
                            question.wrongCount = 0;
                            question.correctCount = 0;
                            question.lastAttempt = null;
                            await this.plugin.saveQuestion(question, false);
                        }
                        new Notice(`âœ… ${questions.length}ê°œ ë¬¸ì œì˜ í†µê³„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    }
                }));

        new Setting(containerEl)
            .setName('ë°ì´í„° ë‚´ë³´ë‚´ê¸°')
            .setDesc('ëª¨ë“  ë¬¸ì œì™€ í†µê³„ë¥¼ JSON íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ“¤ ë‚´ë³´ë‚´ê¸°')
                .onClick(async () => {
                    const questions = await this.plugin.loadAllQuestions();
                    const exportData = {
                        version: '1.0.0',
                        exportDate: new Date().toISOString(),
                        settings: this.plugin.settings,
                        questions: questions
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `hanzi-quiz-export-${Date.now()}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    new Notice('âœ… ë°ì´í„°ê°€ ë‚´ë³´ë‚´ê¸°ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }));

        // í´ë” ê´€ë¦¬ ë²„íŠ¼
        containerEl.createEl('h2', { text: 'ğŸ“‚ í´ë” ê´€ë¦¬' });

        new Setting(containerEl)
            .setName('í´ë” ë‹¤ì‹œ ìƒì„±')
            .setDesc('í•„ìš”í•œ í´ë”ë“¤ì„ ë‹¤ì‹œ ìƒì„±í•©ë‹ˆë‹¤')
            .addButton(button => button
                .setButtonText('ğŸ“ í´ë” ìƒì„±')
                .onClick(async () => {
                    await this.plugin.ensureFolders();
                    new Notice('âœ… í´ë”ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                }));

        // ì •ë³´
        containerEl.createEl('h2', { text: 'â„¹ï¸ ì •ë³´' });
        
        const infoDiv = containerEl.createDiv({ cls: 'hanzi-quiz-info' });
        infoDiv.innerHTML = `
            <p><strong>í•œì í€´ì¦ˆ í”ŒëŸ¬ê·¸ì¸ v1.0.0</strong></p>
            <p>íš¨ê³¼ì ì¸ í•œì í•™ìŠµì„ ìœ„í•œ ë¬¸ì œì€í–‰ ì‹œìŠ¤í…œ</p>
            <p>ğŸ“š ë¬¸ì œ í˜•ì‹: Markdown ê¸°ë°˜</p>
            <p>ğŸ¯ ì§€ì› ê¸°ëŠ¥: ê°ê´€ì‹, íƒ€ì´ë¨¸, ë¶ë§ˆí¬, ì˜¤ë‹µë…¸íŠ¸</p>
            <p>ğŸ“Š í†µê³„ ì¶”ì : ì •ë‹µë¥ , í•™ìŠµ ê¸°ë¡, ë¬¸ì œë³„ ì„±ê³¼</p>
        `;

        this.addInfoStyles();
    }

    addInfoStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .hanzi-quiz-info {
                padding: 20px;
                background: var(--background-secondary);
                border-radius: 8px;
                margin-top: 10px;
            }
            .hanzi-quiz-info p {
                margin: 8px 0;
            }
        `;
        document.head.appendChild(style);
    }

    hide() {
        // ì„¤ì • íƒ­ì´ ë‹«í ë•Œ ëŒ€ì‹œë³´ë“œ ì—´ê¸°
        this.plugin.openDashboard();
    }
}

// Part 4: Utility Functions & Export

// ë¬¸ì œ í•„í„°ë§ ë° ì •ë ¬ ìœ í‹¸ë¦¬í‹°
class QuestionUtils {
    static filterByDifficulty(questions, difficulty) {
        if (!difficulty) return questions;
        return questions.filter(q => q.difficulty === difficulty);
    }

    static filterByBookmark(questions, bookmarkedOnly = false) {
        if (!bookmarkedOnly) return questions;
        return questions.filter(q => q.bookmarked);
    }

    static filterByWrongAnswers(questions, minWrongCount = 1) {
        return questions.filter(q => (q.wrongCount || 0) >= minWrongCount);
    }

    static sortByWrongCount(questions, descending = true) {
        return [...questions].sort((a, b) => {
            const countA = a.wrongCount || 0;
            const countB = b.wrongCount || 0;
            return descending ? countB - countA : countA - countB;
        });
    }

    static sortByLastAttempt(questions, recentFirst = true) {
        return [...questions].sort((a, b) => {
            if (!a.lastAttempt) return 1;
            if (!b.lastAttempt) return -1;
            const dateA = new Date(a.lastAttempt);
            const dateB = new Date(b.lastAttempt);
            return recentFirst ? dateB - dateA : dateA - dateB;
        });
    }

    static getStatistics(questions) {
        const total = questions.length;
        const bookmarked = questions.filter(q => q.bookmarked).length;
        const withWrongAnswers = questions.filter(q => (q.wrongCount || 0) > 0).length;
        
        let totalCorrect = 0;
        let totalWrong = 0;
        
        questions.forEach(q => {
            totalCorrect += (q.correctCount || 0);
            totalWrong += (q.wrongCount || 0);
        });

        const totalAttempts = totalCorrect + totalWrong;
        const accuracy = totalAttempts > 0 ? Math.round((totalCorrect / totalAttempts) * 100) : 0;

        return {
            total,
            bookmarked,
            withWrongAnswers,
            totalCorrect,
            totalWrong,
            totalAttempts,
            accuracy
        };
    }

    static getDifficultyDistribution(questions) {
        const easy = questions.filter(q => q.difficulty === 'ì‰¬ì›€').length;
        const normal = questions.filter(q => q.difficulty === 'ë³´í†µ').length;
        const hard = questions.filter(q => q.difficulty === 'ì–´ë ¤ì›€').length;
        
        return { easy, normal, hard };
    }
}

// CSV ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥
class QuestionExporter {
    static toCSV(questions) {
        const headers = ['ë²ˆí˜¸', 'í•œì', 'ë¬¸ì œ', 'ì •ë‹µ', 'ë‚œì´ë„', 'ì˜¤ë‹µíšŸìˆ˜', 'ì •ë‹µíšŸìˆ˜', 'ë¶ë§ˆí¬'];
        const rows = questions.map(q => [
            q.number || '',
            q.hanzi || '',
            q.question || '',
            q.options && q.options[q.answer] ? q.options[q.answer] : '',
            q.difficulty || 'ë³´í†µ',
            q.wrongCount || 0,
            q.correctCount || 0,
            q.bookmarked ? 'Y' : 'N'
        ]);

        const csvContent = [
            headers.join(','),
            ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
        ].join('\n');

        return csvContent;
    }

    static downloadCSV(questions, filename = 'hanzi-questions.csv') {
        const csv = this.toCSV(questions);
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        link.click();
        URL.revokeObjectURL(url);
    }

    static toJSON(questions, includeStats = true) {
        const exportData = {
            version: '1.0.0',
            exportDate: new Date().toISOString(),
            questions: questions
        };

        if (includeStats) {
            exportData.statistics = QuestionUtils.getStatistics(questions);
        }

        return JSON.stringify(exportData, null, 2);
    }
}

// í•™ìŠµ ì§„ë„ ì¶”ì 
class StudyProgressTracker {
    constructor(plugin) {
        this.plugin = plugin;
    }

    async recordStudySession(duration, questionsAnswered, correctCount) {
        const today = new Date().toLocaleDateString('ko-KR');
        const stats = this.plugin.settings.stats;

        if (!stats.studyHistory) {
            stats.studyHistory = [];
        }

        const todayRecord = stats.studyHistory.find(h => h.date === today);
        
        if (todayRecord) {
            todayRecord.duration += duration;
            todayRecord.questionsAnswered += questionsAnswered;
            todayRecord.correct += correctCount;
            todayRecord.wrong += (questionsAnswered - correctCount);
            todayRecord.timestamp = Date.now();
        } else {
            stats.studyHistory.push({
                date: today,
                duration: duration,
                questionsAnswered: questionsAnswered,
                correct: correctCount,
                wrong: questionsAnswered - correctCount,
                timestamp: Date.now()
            });
        }

        // ìµœê·¼ 30ì¼ë§Œ ìœ ì§€
        if (stats.studyHistory.length > 30) {
            stats.studyHistory = stats.studyHistory.slice(-30);
        }

        await this.plugin.saveSettings();
    }

    getWeeklyProgress() {
        const stats = this.plugin.settings.stats;
        if (!stats.studyHistory) return [];

        return stats.studyHistory.slice(-7);
    }

    getMonthlyProgress() {
        const stats = this.plugin.settings.stats;
        if (!stats.studyHistory) return [];

        return stats.studyHistory.slice(-30);
    }

    getTotalStudyTime() {
        const stats = this.plugin.settings.stats;
        if (!stats.studyHistory) return 0;

        return stats.studyHistory.reduce((total, day) => total + (day.duration || 0), 0);
    }

    getStreak() {
        const stats = this.plugin.settings.stats;
        if (!stats.studyHistory || stats.studyHistory.length === 0) return 0;

        let streak = 0;
        const today = new Date();
        
        for (let i = 0; i < 365; i++) {
            const checkDate = new Date(today);
            checkDate.setDate(checkDate.getDate() - i);
            const dateString = checkDate.toLocaleDateString('ko-KR');
            
            const record = stats.studyHistory.find(h => h.date === dateString);
            
            if (record && record.questionsAnswered > 0) {
                streak++;
            } else if (i > 0) {
                break;
            }
        }

        return streak;
    }
}

// ë³µìŠµ ìŠ¤ì¼€ì¤„ëŸ¬ (ê°„ê²© ë°˜ë³µ í•™ìŠµ)
class SpacedRepetitionScheduler {
    static getNextReviewDate(question) {
        const correctCount = question.correctCount || 0;
        const wrongCount = question.wrongCount || 0;
        
        if (correctCount === 0) {
            return new Date(); // ì•„ì§ ë§ì¶˜ ì  ì—†ìœ¼ë©´ ì¦‰ì‹œ ë³µìŠµ
        }

        // ê°„ê²© ë°˜ë³µ ê°„ê²© (ì¼)
        const intervals = [1, 3, 7, 14, 30, 60, 90];
        const level = Math.min(correctCount - wrongCount, intervals.length - 1);
        const daysUntilReview = intervals[Math.max(0, level)];

        const lastAttempt = question.lastAttempt ? new Date(question.lastAttempt) : new Date();
        const nextReview = new Date(lastAttempt);
        nextReview.setDate(nextReview.getDate() + daysUntilReview);

        return nextReview;
    }

    static getDueQuestions(questions) {
        const now = new Date();
        return questions.filter(q => {
            const nextReview = this.getNextReviewDate(q);
            return nextReview <= now;
        });
    }

    static getPriorityScore(question) {
        const wrongCount = question.wrongCount || 0;
        const correctCount = question.correctCount || 0;
        const daysSinceLastAttempt = question.lastAttempt 
            ? Math.floor((Date.now() - new Date(question.lastAttempt)) / (1000 * 60 * 60 * 24))
            : 999;

        // ìš°ì„ ìˆœìœ„ ê³„ì‚°: ì˜¤ë‹µ ë§ì„ìˆ˜ë¡, ì˜¤ë˜ ì•ˆ ë³¸ ë¬¸ì œì¼ìˆ˜ë¡ ë†’ì€ ì ìˆ˜
        return (wrongCount * 10) + (daysSinceLastAttempt * 0.5) - (correctCount * 2);
    }

    static sortByPriority(questions) {
        return [...questions].sort((a, b) => {
            return this.getPriorityScore(b) - this.getPriorityScore(a);
        });
    }
}

// í€´ì¦ˆ ë¬¸ì œ ì„¤ì • ëª¨ë‹¬ (ë‚œì´ë„, ë¶ë§ˆí¬, ë©”ëª¨ ë“±)
class QuizQuestionSettingsModal extends Modal {
    constructor(app, plugin, question, onUpdate) {
        super(app);
        this.plugin = plugin;
        this.question = question;
        this.onUpdate = onUpdate;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('quiz-question-settings-modal');

        contentEl.createEl('h2', { text: 'âš™ï¸ ë¬¸ì œ ì„¤ì •' });

        const form = contentEl.createDiv({ cls: 'settings-form' });

        // ë¬¸ì œ ì •ë³´ í‘œì‹œ
        const infoSection = form.createDiv({ cls: 'info-section' });
        infoSection.createEl('h3', { text: 'ğŸ“Š ë¬¸ì œ ì •ë³´' });
        
        const infoGrid = infoSection.createDiv({ cls: 'info-grid' });
        infoGrid.innerHTML = `
            <div class="info-item">
                <span class="info-label">í‚¤ì›Œë“œ:</span>
                <span class="info-value">${this.question.hanzi || '-'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ë²ˆí˜¸:</span>
                <span class="info-value">${this.question.number || '-'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">í´ë”:</span>
                <span class="info-value">${this.question.folder || 'ê¸°ë³¸'}</span>
            </div>
            <div class="info-item">
                <span class="info-label">ì •ë‹µ:</span>
                <span class="info-value">${this.question.correctCount || 0}íšŒ</span>
            </div>
            <div class="info-item">
                <span class="info-label">ì˜¤ë‹µ:</span>
                <span class="info-value">${this.question.wrongCount || 0}íšŒ</span>
            </div>
        `;

        // ë‚œì´ë„ ì„¤ì •
        const diffSection = form.createDiv({ cls: 'difficulty-section' });
        diffSection.createEl('h3', { text: 'ğŸ¯ ë‚œì´ë„ ì„¤ì •' });
        
        const difficultyGrid = diffSection.createDiv({ cls: 'difficulty-grid' });
        const difficulties = [
            { value: 'A+', label: 'ğŸ† A+', desc: 'ë§¤ìš° ì‰¬ì›€' },
            { value: 'A', label: 'â­ A', desc: 'ì‰¬ì›€' },
            { value: 'A-', label: 'â­ A-', desc: 'ì•½ê°„ ì‰¬ì›€' },
            { value: 'B', label: 'ğŸ˜Š B', desc: 'ë³´í†µë³´ë‹¤ ì‰¬ì›€' },
            { value: 'B-', label: 'ğŸ˜Š B-', desc: 'ë³´í†µ' },
            { value: 'C', label: 'ğŸ˜ C', desc: 'ì¤‘ê°„' },
            { value: 'D', label: 'ğŸ˜° D', desc: 'ì•½ê°„ ì–´ë ¤ì›€' },
            { value: 'E', label: 'ğŸ˜± E', desc: 'ì–´ë ¤ì›€' },
            { value: 'F', label: 'ğŸ’€ F', desc: 'ë§¤ìš° ì–´ë ¤ì›€' }
        ];

        difficulties.forEach(diff => {
            const diffBtn = difficultyGrid.createEl('button', {
                cls: 'difficulty-option-btn',
                text: diff.label
            });
            diffBtn.createEl('div', { cls: 'diff-desc', text: diff.desc });
            
            if (this.question.difficulty === diff.value) {
                diffBtn.addClass('selected');
            }
            
            diffBtn.onclick = async () => {
                // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected ì œê±°
                difficultyGrid.querySelectorAll('.difficulty-option-btn').forEach(btn => {
                    btn.removeClass('selected');
                });
                
                // í˜„ì¬ ë²„íŠ¼ì— selected ì¶”ê°€
                diffBtn.addClass('selected');
                
                // ë‚œì´ë„ ì—…ë°ì´íŠ¸
                this.question.difficulty = diff.value;
                await this.plugin.updateQuestionDifficulty(this.question, diff.value);
                
                new Notice(`âœ… ë‚œì´ë„ ë³€ê²½: ${diff.label}`);
            };
        });

        // ë¶ë§ˆí¬ í† ê¸€
        const bookmarkSection = form.createDiv({ cls: 'bookmark-section' });
        bookmarkSection.createEl('h3', { text: 'â­ ë¶ë§ˆí¬' });
        
        const bookmarkToggle = bookmarkSection.createEl('button', {
            cls: 'bookmark-toggle-btn',
            text: this.question.bookmarkFolder ? `â­ ë¶ë§ˆí¬ë¨ [${this.question.bookmarkFolder}]` : 'â˜† ë¶ë§ˆí¬ ì¶”ê°€'
        });
        bookmarkToggle.classList.add(this.question.bookmarkFolder ? 'bookmarked' : 'not-bookmarked');
        
        bookmarkToggle.onclick = async () => {
            const hasBookmark = this.question.bookmarkFolder && this.question.bookmarkFolder.length > 0;
            if (hasBookmark) {
                // ë¶ë§ˆí¬ ì œê±° í™•ì¸
                const confirmRemove = confirm(`â˜† "[${this.question.bookmarkFolder}]" í´ë”ì—ì„œ ë¶ë§ˆí¬ë¥¼ ì œê±°í• ê¹Œìš”?`);
                if (confirmRemove) {
                    this.question.bookmarkFolder = '';
                    await this.plugin.toggleBookmark(this.question);
                    
                    bookmarkToggle.setText('â˜† ë¶ë§ˆí¬ ì¶”ê°€');
                    bookmarkToggle.removeClass('bookmarked', 'not-bookmarked');
                    bookmarkToggle.addClass('not-bookmarked');
                    
                    new Notice('â˜† ë¶ë§ˆí¬ì—ì„œ ì œê±°ë¨');
                }
            } else {
                // ë¶ë§ˆí¬ í´ë” ì„ íƒ ëª¨ë‹¬ ì—´ê¸°
                new BookmarkFolderSelectionModal(this.app, this.plugin, this.question, async (selectedFolder) => {
                    this.question.bookmarkFolder = selectedFolder;
                    await this.plugin.toggleBookmark(this.question, selectedFolder);
                    
                    bookmarkToggle.setText(`â­ ë¶ë§ˆí¬ë¨ [${selectedFolder}]`);
                    bookmarkToggle.removeClass('bookmarked', 'not-bookmarked');
                    bookmarkToggle.addClass('bookmarked');
                    
                    new Notice(`â­ [${selectedFolder}] í´ë”ì— ë¶ë§ˆí¬ ì¶”ê°€ë¨`);
                }).open();
            }
        };

        // íŒíŠ¸ ë³´ê¸°
        if (this.question.hint && this.question.hint.trim()) {
            const hintSection = form.createDiv({ cls: 'hint-section' });
            hintSection.createEl('h3', { text: 'ğŸ’¡ íŒíŠ¸' });
            hintSection.createEl('p', { text: this.question.hint, cls: 'hint-text' });
        }

        // ë…¸íŠ¸ ë³´ê¸°
        if (this.question.note && this.question.note.trim()) {
            const noteSection = form.createDiv({ cls: 'note-section' });
            noteSection.createEl('h3', { text: 'ğŸ“ ë…¸íŠ¸' });
            noteSection.createEl('p', { text: this.question.note, cls: 'note-text' });
        }

        // ë¬¸ì œ ìˆ˜ì • ë²„íŠ¼
        const actionSection = form.createDiv({ cls: 'action-section' });
        
        const editBtn = actionSection.createEl('button', {
            text: 'âœï¸ ë¬¸ì œ ìˆ˜ì •',
            cls: 'action-btn edit-btn'
        });
        editBtn.onclick = () => {
            this.close();
            new HanziQuestionModal(this.app, this.plugin, this.question).open();
        };

        // í†µê³„ ì´ˆê¸°í™” ë²„íŠ¼
        const resetStatsBtn = actionSection.createEl('button', {
            text: 'ğŸ”„ í†µê³„ ì´ˆê¸°í™”',
            cls: 'action-btn reset-btn'
        });
        resetStatsBtn.onclick = async () => {
            if (confirm('ì´ ë¬¸ì œì˜ ì •ë‹µ/ì˜¤ë‹µ í†µê³„ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                this.question.correctCount = 0;
                this.question.wrongCount = 0;
                await this.plugin.saveQuestion(this.question, false);
                
                // ì •ë³´ ì—…ë°ì´íŠ¸
                infoGrid.querySelector('.info-item:nth-child(4) .info-value').setText('0íšŒ');
                infoGrid.querySelector('.info-item:nth-child(5) .info-value').setText('0íšŒ');
                
                new Notice('ğŸ“Š í†µê³„ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        };

        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = contentEl.createEl('button', {
            text: 'âœ… ì™„ë£Œ',
            cls: 'modal-close-btn'
        });
        closeBtn.onclick = () => {
            if (this.onUpdate) {
                this.onUpdate(this.question);
            }
            this.close();
        };
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ì„±ì·¨ ì‹œìŠ¤í…œ
class AchievementSystem {
    static checkAchievements(plugin) {
        const achievements = [];
        const stats = plugin.settings.stats;
        const tracker = new StudyProgressTracker(plugin);

        // ë¬¸ì œ ìˆ˜ ë‹¬ì„±
        if (stats.totalQuestions >= 10) achievements.push({ id: 'questions_10', name: 'ğŸ“š ë¬¸ì œ ìˆ˜ì§‘ê°€', desc: '10ê°œ ì´ìƒì˜ ë¬¸ì œ ìƒì„±' });
        if (stats.totalQuestions >= 50) achievements.push({ id: 'questions_50', name: 'ğŸ“– ë¬¸ì œ ì œì‘ì', desc: '50ê°œ ì´ìƒì˜ ë¬¸ì œ ìƒì„±' });
        if (stats.totalQuestions >= 100) achievements.push({ id: 'questions_100', name: 'ğŸ“• ë¬¸ì œ ë§ˆìŠ¤í„°', desc: '100ê°œ ì´ìƒì˜ ë¬¸ì œ ìƒì„±' });

        // ì •ë‹µ íšŸìˆ˜ ë‹¬ì„±
        if (stats.totalCorrect >= 50) achievements.push({ id: 'correct_50', name: 'âœ… ì´ˆë³´ í•™ìŠµì', desc: '50ê°œ ë¬¸ì œ ì •ë‹µ' });
        if (stats.totalCorrect >= 200) achievements.push({ id: 'correct_200', name: 'ğŸ¯ ì¤‘ê¸‰ í•™ìŠµì', desc: '200ê°œ ë¬¸ì œ ì •ë‹µ' });
        if (stats.totalCorrect >= 500) achievements.push({ id: 'correct_500', name: 'ğŸ† ê³ ê¸‰ í•™ìŠµì', desc: '500ê°œ ë¬¸ì œ ì •ë‹µ' });

        // ì •ë‹µë¥  ë‹¬ì„±
        const accuracy = stats.totalAttempts > 0 ? Math.round((stats.totalCorrect / stats.totalAttempts) * 100) : 0;
        if (accuracy >= 80 && stats.totalAttempts >= 20) {
            achievements.push({ id: 'accuracy_80', name: 'ğŸ¯ ì •í™•í•œ ì‚¬ìˆ˜', desc: 'ì •ë‹µë¥  80% ì´ìƒ ìœ ì§€' });
        }
        if (accuracy >= 90 && stats.totalAttempts >= 50) {
            achievements.push({ id: 'accuracy_90', name: 'ğŸ’ ì™„ë²½ì£¼ì˜ì', desc: 'ì •ë‹µë¥  90% ì´ìƒ ìœ ì§€' });
        }

        // ì—°ì† í•™ìŠµ ë‹¬ì„±
        const streak = tracker.getStreak();
        if (streak >= 3) achievements.push({ id: 'streak_3', name: 'ğŸ”¥ 3ì¼ ì—°ì†', desc: '3ì¼ ì—°ì† í•™ìŠµ' });
        if (streak >= 7) achievements.push({ id: 'streak_7', name: 'ğŸ”¥ğŸ”¥ 7ì¼ ì—°ì†', desc: '7ì¼ ì—°ì† í•™ìŠµ' });
        if (streak >= 30) achievements.push({ id: 'streak_30', name: 'ğŸ”¥ğŸ”¥ğŸ”¥ í•œ ë‹¬ ë‹¬ì„±', desc: '30ì¼ ì—°ì† í•™ìŠµ' });

        return achievements;
    }
}

// í€´ì¦ˆ ìƒì„¸ ê¸°ë¡ ëª¨ë‹¬
class QuizDetailRecordModal extends Modal {
    constructor(app, plugin, quizResult) {
        super(app);
        this.plugin = plugin;
        this.result = quizResult;
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('quiz-detail-record-modal');

        // í—¤ë”
        const header = contentEl.createDiv({ cls: 'detail-header' });
        header.innerHTML = `
            <h1>ğŸ“Š í€´ì¦ˆ ìƒì„¸ ê¸°ë¡</h1>
            <p>ëˆ„ì  ê¸°ë¡ê³¼ ë¬¸ì œë³„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”</p>
        `;

        // íƒ­ ë„¤ë¹„ê²Œì´ì…˜
        const tabNav = contentEl.createDiv({ cls: 'tab-navigation' });
        const tabs = [
            { id: 'current', label: 'ì´ë²ˆ í€´ì¦ˆ', icon: 'ğŸ¯' },
            { id: 'folder', label: 'í´ë”ë³„ ê¸°ë¡', icon: 'ğŸ“' },
            { id: 'time', label: 'ì‹œê°„ëŒ€ë³„ ê¸°ë¡', icon: 'â°' }
        ];

        let activeTab = 'current';

        const renderContent = async (tab) => {
            const existingContent = contentEl.querySelector('.tab-content');
            if (existingContent) existingContent.remove();

            if (tab === 'current') {
                this.renderCurrentQuiz(contentEl);
            } else if (tab === 'folder') {
                await this.renderFolderStats(contentEl);
            } else if (tab === 'time') {
                await this.renderTimeStats(contentEl);
            }
        };

        tabs.forEach(tab => {
            const btn = tabNav.createEl('button', {
                text: `${tab.icon} ${tab.label}`,
                cls: 'tab-btn'
            });
            if (tab.id === 'current') btn.addClass('active');

            btn.addEventListener('click', async () => {
                tabNav.querySelectorAll('.tab-btn').forEach(b => b.removeClass('active'));
                btn.addClass('active');
                activeTab = tab.id;
                await renderContent(activeTab);
            });
        });

        // ì´ˆê¸° ë Œë”ë§
        await renderContent('current');

        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = contentEl.createEl('button', {
            text: 'âœ… ë‹«ê¸°',
            cls: 'modal-close-btn-detail'
        });
        closeBtn.addEventListener('click', () => this.close());

        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        this.addStyles();
    }

    renderCurrentQuiz(container) {
        const content = container.createDiv({ cls: 'tab-content' });

        // í†µê³„ ìš”ì•½
        const statsCard = content.createDiv({ cls: 'stats-summary-card' });
        const percentage = this.result.percentage;
        const gradeEmoji = percentage >= 90 ? 'ğŸ†' : percentage >= 80 ? 'ğŸ¥‡' : percentage >= 70 ? 'ğŸ¥ˆ' : percentage >= 60 ? 'ğŸ¥‰' : 'ğŸ˜…';
        
        statsCard.innerHTML = `
            <div class="stat-item">
                <div class="stat-icon">${gradeEmoji}</div>
                <div class="stat-label">ì ìˆ˜</div>
                <div class="stat-value">${this.result.correct}/${this.result.total}</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">ğŸ¯</div>
                <div class="stat-label">ì •ë‹µë¥ </div>
                <div class="stat-value">${percentage}%</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">â±ï¸</div>
                <div class="stat-label">ì†Œìš” ì‹œê°„</div>
                <div class="stat-value">${this.formatTime(this.result.time)}</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">âŒ</div>
                <div class="stat-label">ì˜¤ë‹µ</div>
                <div class="stat-value">${this.result.incorrect}ê°œ</div>
            </div>
        `;

        // ê°„ë‹¨í•œ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸
        const questionList = content.createDiv({ cls: 'simple-question-list' });
        questionList.createEl('h3', { text: 'ğŸ“‹ ë¬¸ì œë³„ ê²°ê³¼' });

        const list = questionList.createDiv({ cls: 'question-items' });
        this.result.details.forEach((item, index) => {
            const row = list.createDiv({ cls: 'question-row' });
            row.classList.add(item.isCorrect ? 'correct-row' : 'incorrect-row');
            
            row.innerHTML = `
                <span class="q-number">${index + 1}</span>
                <span class="q-status">${item.isCorrect ? 'âœ…' : 'âŒ'}</span>
                <span class="q-hanzi">${item.hanzi}</span>
                <span class="q-text">${item.question.substring(0, 30)}${item.question.length > 30 ? '...' : ''}</span>
            `;
        });
    }

    async renderFolderStats(container) {
        const content = container.createDiv({ cls: 'tab-content' });

        // ê²°ê³¼ íŒŒì¼ ë¡œë“œ
        const resultsFolder = this.plugin.settings.resultsFolder;
        const allFiles = this.app.vault.getMarkdownFiles();
        const resultFiles = allFiles.filter(f => f.path.startsWith(resultsFolder));

        if (resultFiles.length === 0) {
            content.innerHTML = '<p class="empty-message">ğŸ“Š ì•„ì§ ì €ì¥ëœ í€´ì¦ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // íŒŒì¼ ì½ê³  íŒŒì‹±
        const records = [];
        for (const file of resultFiles) {
            try {
                const fileContent = await this.app.vault.read(file);
                const record = this.parseResultFile(fileContent, file);
                if (record) records.push(record);
            } catch (err) {
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', file.path, err);
            }
        }

        // í´ë”ë³„ ê·¸ë£¹í™” (ê° í´ë”ì— ì†í•œ ë¬¸ì œë§Œ ì§‘ê³„)
        const folderGroups = {};
        const allQuestions = await this.plugin.loadAllQuestions();
        
        // ë¶ë§ˆí¬ í´ë” ì¶”ê°€
        const bookmarkFolderName = this.plugin.settings.bookmarkFolder || 'â­ ë¶ë§ˆí¬';
        const bookmarkedQuestions = allQuestions.filter(q => q.bookmarked);
        if (bookmarkedQuestions.length > 0) {
            folderGroups[bookmarkFolderName] = {
                folder: bookmarkFolderName,
                isBookmarkFolder: true,
                totalQuizzes: 0,
                totalQuestions: bookmarkedQuestions.length,
                totalCorrect: 0,
                totalWrong: 0,
                totalTime: 0,
                records: []
            };
        }
        
        // ì¼ë°˜ í´ë”ë“¤
        const folders = this.plugin.settings.questionFolders || ['ê¸°ë³¸'];
        folders.forEach(folder => {
            folderGroups[folder] = {
                folder: folder,
                isBookmarkFolder: false,
                totalQuizzes: 0,
                totalQuestions: allQuestions.filter(q => (q.folder || 'ê¸°ë³¸') === folder).length,
                totalCorrect: 0,
                totalWrong: 0,
                totalTime: 0,
                records: []
            };
        });

        // ê° ê¸°ë¡ì˜ ë¬¸ì œ ì¤‘ í´ë”ë³„ë¡œ ì§‘ê³„
        records.forEach(record => {
            // ë¬¸ì œë³„ í´ë” ì§‘ê³„
            const folderStats = {};
            if (record.details && Array.isArray(record.details)) {
                record.details.forEach(q => {
                    const folder = q.folder || 'ê¸°ë³¸';
                    if (!folderStats[folder]) folderStats[folder] = { correct: 0, wrong: 0, time: 0, count: 0 };
                    if (q.isCorrect) folderStats[folder].correct++;
                    else folderStats[folder].wrong++;
                    folderStats[folder].count++;
                    
                    // ë¶ë§ˆí¬ëœ ë¬¸ì œëŠ” ë¶ë§ˆí¬ í´ë”ì—ë„ ì§‘ê³„
                    if (q.bookmarked) {
                        if (!folderStats[bookmarkFolderName]) folderStats[bookmarkFolderName] = { correct: 0, wrong: 0, time: 0, count: 0 };
                        if (q.isCorrect) folderStats[bookmarkFolderName].correct++;
                        else folderStats[bookmarkFolderName].wrong++;
                        folderStats[bookmarkFolderName].count++;
                    }
                });
            }
            // ê° í´ë”ë³„ë¡œ ê¸°ë¡ ë°˜ì˜
            Object.keys(folderStats).forEach(folder => {
                if (folderGroups[folder]) {
                    folderGroups[folder].totalQuizzes++;
                    folderGroups[folder].totalCorrect += folderStats[folder].correct;
                    folderGroups[folder].totalWrong += folderStats[folder].wrong;
                    folderGroups[folder].totalTime += record.time;
                    folderGroups[folder].records.push(record);
                }
            });
        });

        // í´ë”ë³„ í†µê³„ í‘œì‹œ
        content.createEl('h3', { text: 'ğŸ“ í´ë”ë³„ í†µê³„' });

        const folderCardsContainer = content.createDiv({ cls: 'folder-stats-grid' });

        Object.values(folderGroups).forEach(group => {
            const avgAccuracy = group.totalQuizzes > 0 
                ? Math.round((group.totalCorrect / (group.totalCorrect + group.totalWrong)) * 100) 
                : 0;

            const card = folderCardsContainer.createDiv({ cls: 'folder-stat-card clickable' });
            
            // ë¶ë§ˆí¬ í´ë”ì¸ ê²½ìš° íŠ¹ë³„í•œ ìŠ¤íƒ€ì¼ ì ìš©
            if (group.isBookmarkFolder) {
                card.style.cssText = `
                    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
                    border: 2px solid #FF8C00;
                    color: #000;
                `;
            }
            
            card.innerHTML = `
                <div class="folder-stat-header">
                    <span class="folder-stat-name">${group.isBookmarkFolder ? 'â­' : 'ğŸ“'} ${group.folder}</span>
                    <span class="folder-stat-count">${group.totalQuestions}ê°œ ë¬¸ì œ</span>
                </div>
                <div class="folder-stat-body">
                    <div class="folder-stat-item">
                        <div class="folder-stat-label">í€´ì¦ˆ íšŸìˆ˜</div>
                        <div class="folder-stat-value">${group.totalQuizzes}íšŒ</div>
                    </div>
                    <div class="folder-stat-item">
                        <div class="folder-stat-label">ì •ë‹µë¥ </div>
                        <div class="folder-stat-value">${avgAccuracy}%</div>
                    </div>
                    <div class="folder-stat-item">
                        <div class="folder-stat-label">í•™ìŠµ ì‹œê°„</div>
                        <div class="folder-stat-value">${this.formatTime(group.totalTime)}</div>
                    </div>
                </div>
            `;
            
            // ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€
            const btnContainer = card.createDiv({ cls: 'folder-stat-actions' });
            btnContainer.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end; padding: 10px; border-top: 1px solid var(--background-modifier-border); margin-top: 10px;';
            
            const clearBtn = btnContainer.createEl('button', {
                text: 'ğŸ—‘ï¸ ì´ˆê¸°í™”',
                cls: 'folder-clear-btn'
            });
            clearBtn.style.cssText = 'padding: 6px 12px; font-size: 12px; background: var(--background-modifier-error); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer;';
            clearBtn.onclick = async (e) => {
                e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
                
                if (confirm(`"${group.folder}" í´ë”ì˜ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    const folderPath = `${this.plugin.settings.questionsFolder}/${group.folder}`;
                    
                    // í•´ë‹¹ í´ë”ì˜ ê²°ê³¼ íŒŒì¼ ì‚­ì œ
                    const resultsFolder = this.plugin.settings.resultsFolder;
                    const allFiles = this.app.vault.getMarkdownFiles();
                    const resultFiles = allFiles.filter(f => f.path.startsWith(resultsFolder));
                    
                    for (const file of resultFiles) {
                        try {
                            const content = await this.app.vault.read(file);
                            const record = this.parseResultFile(content, file);
                            if (record && record.details) {
                                const hasFolderQuestion = record.details.some(d => 
                                    (d.folder || 'ê¸°ë³¸') === group.folder
                                );
                                if (hasFolderQuestion) {
                                    await this.app.vault.delete(file);
                                }
                            }
                        } catch (err) {
                            console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', err);
                        }
                    }
                    
                    // ë¡œê·¸ íˆìŠ¤í† ë¦¬ì—ì„œ ì œê±°
                    this.plugin.quizLogHistory = this.plugin.quizLogHistory.filter(log => {
                        return !log.details || !log.details.some(detail => 
                            (detail.folder || 'ê¸°ë³¸') === group.folder
                        );
                    });
                    
                    await this.plugin.saveSettings();
                    new Notice(`âœ… "${group.folder}" í´ë”ì˜ í•™ìŠµ ê¸°ë¡ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤`);
                    
                    // ìƒˆë¡œê³ ì¹¨
                    await this.renderFolderStats(container);
                }
            };
            
            const viewBtn = btnContainer.createEl('button', {
                text: 'ğŸ“Š ìƒì„¸ë³´ê¸°',
                cls: 'folder-view-btn'
            });
            viewBtn.style.cssText = 'padding: 6px 12px; font-size: 12px; background: var(--interactive-accent); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer;';
            viewBtn.onclick = async (e) => {
                e.stopPropagation();
                await this.createAndOpenFolderDetailFile(group, allQuestions);
            };
        });
    }

    async renderTimeStats(container) {
        const content = container.createDiv({ cls: 'tab-content' });

        // ê²°ê³¼ íŒŒì¼ ë¡œë“œ
        const resultsFolder = this.plugin.settings.resultsFolder;
        const allFiles = this.app.vault.getMarkdownFiles();
        const resultFiles = allFiles.filter(f => f.path.startsWith(resultsFolder));

        if (resultFiles.length === 0) {
            content.innerHTML = '<p class="empty-message">ğŸ“Š ì•„ì§ ì €ì¥ëœ í€´ì¦ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        // íŒŒì¼ ì½ê³  íŒŒì‹±
        const records = [];
        for (const file of resultFiles) {
            try {
                const fileContent = await this.app.vault.read(file);
                const record = this.parseResultFile(fileContent, file);
                if (record) records.push(record);
            } catch (err) {
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', file.path, err);
            }
        }

        // ë‚ ì§œë³„ ê·¸ë£¹í™”
        const dateGroups = {};
        records.forEach(record => {
            const date = new Date(record.timestamp);
            const dateKey = date.toLocaleDateString('ko-KR', { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit' 
            });
            
            if (!dateGroups[dateKey]) {
                dateGroups[dateKey] = {
                    date: dateKey,
                    timestamp: date.setHours(0, 0, 0, 0),
                    totalQuizzes: 0,
                    totalCorrect: 0,
                    totalWrong: 0,
                    totalTime: 0,
                    records: []
                };
            }
            
            dateGroups[dateKey].totalQuizzes++;
            dateGroups[dateKey].totalCorrect += record.correct;
            dateGroups[dateKey].totalWrong += record.incorrect;
            dateGroups[dateKey].totalTime += record.time;
            dateGroups[dateKey].records.push(record);
        });

        // ë‚ ì§œìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
        const sortedDates = Object.values(dateGroups).sort((a, b) => b.timestamp - a.timestamp);

        // ì „ì²´ í†µê³„
        const totalStats = content.createDiv({ cls: 'time-total-stats' });
        const totalQuizzes = records.length;
        const totalCorrect = records.reduce((sum, r) => sum + r.correct, 0);
        const totalWrong = records.reduce((sum, r) => sum + r.incorrect, 0);
        const totalTime = records.reduce((sum, r) => sum + r.time, 0);
        const avgAccuracy = totalQuizzes > 0 ? Math.round((totalCorrect / (totalCorrect + totalWrong)) * 100) : 0;

        totalStats.innerHTML = `
            <h3>â° ì‹œê°„ëŒ€ë³„ í†µê³„</h3>
            <div class="total-stats-grid">
                <div class="total-stat-item">
                    <div class="total-stat-value">${totalQuizzes}</div>
                    <div class="total-stat-label">ì´ í€´ì¦ˆ íšŸìˆ˜</div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">${avgAccuracy}%</div>
                    <div class="total-stat-label">í‰ê·  ì •ë‹µë¥ </div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">${this.formatTime(totalTime)}</div>
                    <div class="total-stat-label">ì´ í•™ìŠµ ì‹œê°„</div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">${sortedDates.length}</div>
                    <div class="total-stat-label">í•™ìŠµí•œ ë‚ </div>
                </div>
            </div>
        `;

        // ë‚ ì§œë³„ ê¸°ë¡
        const dateList = content.createDiv({ cls: 'date-stats-list' });
        dateList.createEl('h3', { text: 'ğŸ“… ë‚ ì§œë³„ í•™ìŠµ ê¸°ë¡' });

        const list = dateList.createDiv({ cls: 'date-items' });
        sortedDates.forEach(group => {
            const avgAccuracy = group.totalQuizzes > 0 
                ? Math.round((group.totalCorrect / (group.totalCorrect + group.totalWrong)) * 100) 
                : 0;

            const card = list.createDiv({ cls: 'date-card' });
            card.innerHTML = `
                <div class="date-card-header">
                    <span class="date-label">ğŸ“… ${group.date}</span>
                    <span class="date-count">${group.totalQuizzes}íšŒ í€´ì¦ˆ</span>
                </div>
                <div class="date-card-body">
                    <div class="date-stat">
                        <span class="date-stat-label">ì •ë‹µë¥ </span>
                        <span class="date-stat-value">${avgAccuracy}%</span>
                    </div>
                    <div class="date-stat">
                        <span class="date-stat-label">í’€ì´í•œ ë¬¸ì œ</span>
                        <span class="date-stat-value">${group.totalCorrect + group.totalWrong}ê°œ</span>
                    </div>
                    <div class="date-stat">
                        <span class="date-stat-label">í•™ìŠµ ì‹œê°„</span>
                        <span class="date-stat-value">${this.formatTime(group.totalTime)}</span>
                    </div>
                </div>
            `;
            
            // ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€
            const btnContainer = card.createDiv({ cls: 'date-stat-actions' });
            btnContainer.style.cssText = 'display: flex; gap: 8px; justify-content: flex-end; padding: 10px; border-top: 1px solid var(--background-modifier-border); margin-top: 10px;';
            
            const clearBtn = btnContainer.createEl('button', {
                text: 'ğŸ—‘ï¸ ì´ ë‚ ì§œ ê¸°ë¡ ì‚­ì œ',
                cls: 'date-clear-btn'
            });
            clearBtn.style.cssText = 'padding: 6px 12px; font-size: 12px; background: var(--background-modifier-error); color: var(--text-on-accent); border: none; border-radius: 4px; cursor: pointer;';
            clearBtn.onclick = async (e) => {
                e.stopPropagation();
                
                if (confirm(`${group.date}ì˜ ëª¨ë“  í•™ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                    // í•´ë‹¹ ë‚ ì§œì˜ ê²°ê³¼ íŒŒì¼ ì‚­ì œ
                    for (const record of group.records) {
                        if (record.file) {
                            try {
                                await this.app.vault.delete(record.file);
                                console.log(`âœ… íŒŒì¼ ì‚­ì œë¨: ${record.file.path}`);
                            } catch (err) {
                                console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', record.file?.path, err);
                            }
                        }
                    }
                    
                    // ë¡œê·¸ íˆìŠ¤í† ë¦¬ì—ì„œ ì œê±°
                    this.plugin.quizLogHistory = this.plugin.quizLogHistory.filter(log => {
                        const logDate = new Date(log.timestamp);
                        const logDateKey = logDate.toLocaleDateString('ko-KR', { 
                            year: 'numeric', 
                            month: '2-digit', 
                            day: '2-digit' 
                        });
                        return logDateKey !== group.date;
                    });
                    
                    await this.plugin.saveSettings();
                    new Notice(`âœ… ${group.date}ì˜ í•™ìŠµ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
                    
                    // ìƒˆë¡œê³ ì¹¨
                    await this.renderTimeStats(container);
                }
            };

            // í•´ë‹¹ ë‚ ì§œ ìƒì„¸ ê¸°ë¡ ì»¨í…Œì´ë„ˆ ë¨¼ì € ìƒì„±
            const isMobile = window.innerWidth <= 768;
            const detailContainer = card.createDiv({ cls: 'date-detail-records' });
            detailContainer.style.display = isMobile ? 'none' : 'block';

            group.records.sort((a, b) => b.timestamp - a.timestamp).forEach((record, idx) => {
                const timeStr = new Date(record.timestamp).toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                // ë¬¸ì œë¥¼ í’€ì—ˆë˜ í´ë”ëª… í‘œì‹œ (record.folder ë˜ëŠ” record.question.folder)
                let solvedFolder = '';
                if (record.folder) {
                    solvedFolder = record.folder;
                } else if (record.question && record.question.folder) {
                    solvedFolder = record.question.folder;
                }
                const folderLabel = solvedFolder ? `<span class="detail-folder">ğŸ“ ${solvedFolder}</span>` : '';

                const detailRow = detailContainer.createDiv({ cls: 'detail-record-row' });
                detailRow.innerHTML = `
                    ${folderLabel}
                    <span class="detail-time">${timeStr}</span>
                    <span class="detail-score">${record.correct}/${record.total} (${record.percentage}%)</span>
                    <span class="detail-duration">${this.formatTime(record.time)}</span>
                `;

                // íŒŒì¼ ì—´ê¸° ë²„íŠ¼
                const openBtn = detailRow.createEl('button', {
                    text: 'ğŸ“„',
                    cls: 'detail-open-btn'
                });
                openBtn.addEventListener('click', async () => {
                    const leaf = this.app.workspace.getLeaf(false);
                    await leaf.openFile(record.file);
                    this.close();
                });
            });

            // í† ê¸€ ë²„íŠ¼ì„ ë§ˆì§€ë§‰ì— ìƒì„±
            const detailBtn = card.createEl('button', {
                text: isMobile ? 'â–¼ ìƒì„¸ ë³´ê¸°' : 'â–² ì ‘ê¸°',
                cls: 'date-detail-toggle'
            });

            detailBtn.addEventListener('click', () => {
                if (detailContainer.style.display === 'none') {
                    detailContainer.style.display = 'block';
                    detailBtn.setText('â–² ì ‘ê¸°');
                } else {
                    detailContainer.style.display = 'none';
                    detailBtn.setText('â–¼ ìƒì„¸ ë³´ê¸°');
                }
            });
        });
    }

    async renderHistory(container) {
        // ì‚¬ìš©ë˜ì§€ ì•ŠëŠ” ë©”ì„œë“œ (ì‚­ì œ ì˜ˆì •)
    }

    parseResultFile(content, file) {
        try {
            // frontmatter íŒŒì‹±
            let frontmatterTime = 0;
            const frontmatterMatch = content.match(/---([\s\S]*?)---/);
            if (frontmatterMatch) {
                const fm = frontmatterMatch[1];
                const timeMatch = fm.match(/ì†Œìš”ì‹œê°„\(ì´ˆ\):\s*(\d+)/);
                if (timeMatch) {
                    frontmatterTime = parseInt(timeMatch[1]);
                }
            }
            // (ì¤‘ë³µ ì„ ì–¸ ì œê±°)
            let folderName = '';
            // frontmatterì—ì„œ í´ë”ëª… íŒŒì‹± ì‹œë„
            if (frontmatterMatch) {
                const fm = frontmatterMatch[1];
                const folderMatch = fm.match(/ë¬¸ì œí´ë”ëª…:\s*(.+)/);
                if (folderMatch) {
                    folderName = folderMatch[1].trim();
                }
            }
            const lines = content.split('\n');
            const record = {
                file: file,
                timestamp: file.stat.mtime,
                correct: 0,
                incorrect: 0,
                total: 0,
                percentage: 0,
                time: frontmatterTime,
                folder: folderName,
                details: [] // ë¬¸ì œë³„ ìƒì„¸ ì •ë³´ ì¶”ê°€
            };

            // ë³¸ë¬¸ì—ì„œ í´ë”ëª… íŒŒì‹± (ë°±ì—…)
            let inDetailsSection = false;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (!record.folder && (line.includes('ë¬¸ì œí´ë”:') || line.includes('ë¬¸ì œí´ë”ëª…:'))) {
                    const match = line.match(/ë¬¸ì œí´ë”(?:ëª…)?:\s*(.+)/);
                    if (match) record.folder = match[1].trim();
                }
                if (line.includes('**ì •ë‹µ**:')) {
                    const match = line.match(/(\d+)ê°œ/);
                    if (match) record.correct = parseInt(match[1]);
                }
                if (line.includes('**ì˜¤ë‹µ**:')) {
                    const match = line.match(/(\d+)ê°œ/);
                    if (match) record.incorrect = parseInt(match[1]);
                }
                if (line.includes('**ì´ ë¬¸ì œ**:')) {
                    const match = line.match(/(\d+)ê°œ/);
                    if (match) record.total = parseInt(match[1]);
                }
                if (line.includes('**ì •ë‹µë¥ **:')) {
                    const match = line.match(/(\d+)%/);
                    if (match) record.percentage = parseInt(match[1]);
                }
                
                // ìƒì„¸ ê²°ê³¼ ì„¹ì…˜ ì‹œì‘
                if (line.includes('## ğŸ“ ìƒì„¸ ê²°ê³¼') || line.includes('## ğŸ“‹ ìƒì„¸ ê²°ê³¼')) {
                    inDetailsSection = true;
                    console.log('ğŸ“ ìƒì„¸ ê²°ê³¼ ì„¹ì…˜ ì‹œì‘');
                    continue;
                }
                
                // ìƒì„¸ ê²°ê³¼ íŒŒì‹± (ì˜ˆ: "1. [100ë²ˆëŒ€ ë…ìŒ_ë³µì‚¬ë³¸] 001-090 - âœ… 1ë²ˆë°© (0ì´ˆ)")
                if (inDetailsSection && line.match(/^\d+\./)) {
                    console.log('ğŸ“‹ ìƒì„¸ ë¼ì¸ íŒŒì‹± ì‹œë„:', line);
                    // íŒ¨í„´: "ë²ˆí˜¸. [í´ë”] í•œì - âœ…/âŒ ë¬¸ì œ (ì‹œê°„ì´ˆ)"
                    // âœ…/âŒ ì•ê¹Œì§€ê°€ í•œì, ê·¸ ì´í›„ë¶€í„° (ì‹œê°„) ì „ê¹Œì§€ê°€ ë¬¸ì œ
                    const detailMatch = line.match(/^\d+\.\s*\[([^\]]+)\]\s*(.+?)\s*-\s*(âœ…|âŒ)\s*(.+?)(?:\s*\((\d+)ì´ˆ\))?$/);
                    if (detailMatch) {
                        const folder = detailMatch[1].trim();
                        const hanzi = detailMatch[2].trim();
                        const isCorrect = detailMatch[3] === 'âœ…';
                        const question = detailMatch[4].trim();
                        const time = detailMatch[5] ? parseInt(detailMatch[5]) : 0;
                        
                        console.log(`  âœ… íŒŒì‹± ì„±ê³µ: [${folder}] ${hanzi} - ${isCorrect ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'}`);
                        
                        record.details.push({
                            folder: folder,
                            hanzi: hanzi,
                            isCorrect: isCorrect,
                            question: question,
                            time: time
                        });
                    } else {
                        console.warn('  âŒ ìƒì„¸ íŒŒì‹± ì‹¤íŒ¨:', line);
                    }
                }
                
                // ì†Œìš” ì‹œê°„ íŒŒì‹± (ì´ˆ ë‹¨ìœ„ë¡œ ë³€í™˜) - ê°œì„ ëœ ë²„ì „ v2
                if (line.includes('ì†Œìš” ì‹œê°„') || line.includes('ì‹œê°„:')) {
                    console.log('ğŸ• ì‹œê°„ íŒŒì‹± ì‹œë„:', line);
                    // "ë¶„ ì´ˆ" í˜•ì‹ ë¨¼ì € ì‹œë„
                    const minuteSecondMatch = line.match(/(\d+)ë¶„\s*(\d+)ì´ˆ/);
                    if (minuteSecondMatch) {
                        record.time = parseInt(minuteSecondMatch[1]) * 60 + parseInt(minuteSecondMatch[2]);
                        console.log('  âœ… ë¶„+ì´ˆ íŒŒì‹±:', record.time, 'ì´ˆ');
                    } else {
                        // "ì´ˆ" í˜•ì‹ë§Œ ìˆëŠ” ê²½ìš°
                        const secondMatch = line.match(/(\d+)ì´ˆ/);
                        if (secondMatch) {
                            record.time = parseInt(secondMatch[1]);
                            console.log('  âœ… ì´ˆë§Œ íŒŒì‹±:', record.time, 'ì´ˆ');
                        } else {
                            // ìˆ«ìë§Œ ìˆëŠ” ê²½ìš° (ë°±ì—…)
                            const numberMatch = line.match(/(\d+)/);
                            if (numberMatch) {
                                record.time = parseInt(numberMatch[1]);
                                console.log('  âš ï¸ ìˆ«ìë§Œ íŒŒì‹±:', record.time, 'ì´ˆ');
                            } else {
                                console.warn('  âŒ ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨');
                            }
                        }
                    }
                }
            }

            return record.total > 0 ? record : null;
        } catch (err) {
            console.error('íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜:', err);
            return null;
        }
    }

    formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return minutes > 0 ? `${minutes}ë¶„ ${secs}ì´ˆ` : `${secs}ì´ˆ`;
    }

    async createAndOpenFolderDetailFile(folderGroup, allQuestions) {
        const folderName = folderGroup.folder;
        const avgAccuracy = folderGroup.totalQuizzes > 0 
            ? Math.round((folderGroup.totalCorrect / (folderGroup.totalCorrect + folderGroup.totalWrong)) * 100) 
            : 0;

        // í´ë”ë³„ ë¬¸ì œ ëª©ë¡
        const folderQuestions = allQuestions.filter(q => (q.folder || 'ê¸°ë³¸') === folderName);
        
        // ì •ë‹µë¥  ê¸°ì¤€ ì •ë ¬ (ì˜¤ë‹µ ë§ì€ ìˆœ)
        const sortedQuestions = folderQuestions.sort((a, b) => {
            const ratioA = (a.correctCount || 0) + (a.wrongCount || 0) > 0 
                ? (a.correctCount || 0) / ((a.correctCount || 0) + (a.wrongCount || 0))
                : 1;
            const ratioB = (b.correctCount || 0) + (b.wrongCount || 0) > 0 
                ? (b.correctCount || 0) / ((b.correctCount || 0) + (b.wrongCount || 0))
                : 1;
            return ratioA - ratioB;
        });

        // ìµœê·¼ í€´ì¦ˆ ê¸°ë¡ (ìµœëŒ€ 10ê°œ)
        const recentRecords = folderGroup.records
            .sort((a, b) => b.timestamp - a.timestamp)
            .slice(0, 10);

        // ë§ˆí¬ë‹¤ìš´ ë‚´ìš© ìƒì„±
        let content = `---
í´ë”: ${folderName}
ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}
---

# ğŸ“ ${folderName} í´ë” í†µê³„

## ğŸ“Š ì „ì²´ í†µê³„

- **ì´ ë¬¸ì œ ìˆ˜**: ${folderGroup.totalQuestions}ê°œ
- **í€´ì¦ˆ ì‹œë„ íšŸìˆ˜**: ${folderGroup.totalQuizzes}íšŒ
- **í‰ê·  ì •ë‹µë¥ **: ${avgAccuracy}%
- **ì´ í•™ìŠµ ì‹œê°„**: ${this.formatTime(folderGroup.totalTime)}
- **ì •ë‹µ ë¬¸ì œ**: ${folderGroup.totalCorrect}ê°œ
- **ì˜¤ë‹µ ë¬¸ì œ**: ${folderGroup.totalWrong}ê°œ

---

## ğŸ“‹ ë¬¸ì œë³„ ìƒì„¸ í†µê³„

`;

        // ë¬¸ì œë³„ í†µê³„ í‘œ
        content += `| ë²ˆí˜¸ | í•œì | ë¬¸ì œ | ì •ë‹µ íšŸìˆ˜ | ì˜¤ë‹µ íšŸìˆ˜ | ì •ë‹µë¥  | ë¶ë§ˆí¬ |\n`;
        content += `|------|------|------|-----------|-----------|--------|--------|\n`;

        sortedQuestions.forEach(q => {
            const totalAttempts = (q.correctCount || 0) + (q.wrongCount || 0);
            const accuracy = totalAttempts > 0 
                ? Math.round(((q.correctCount || 0) / totalAttempts) * 100) 
                : 0;
            const bookmark = q.bookmarked ? 'â­' : '';
            const questionText = q.question ? q.question.substring(0, 20) : '-';
            
            content += `| ${q.number || '-'} | ${q.hanzi || '-'} | ${questionText} | ${q.correctCount || 0} | ${q.wrongCount || 0} | ${accuracy}% | ${bookmark} |\n`;
        });

        content += `\n---\n\n## ğŸ“… ìµœê·¼ í€´ì¦ˆ ê¸°ë¡\n\n`;

        if (recentRecords.length > 0) {
            recentRecords.forEach((record, idx) => {
                const date = new Date(record.timestamp).toLocaleString('ko-KR');
                content += `### ${idx + 1}. ${date}\n\n`;
                content += `- **ì ìˆ˜**: ${record.correct}/${record.total} (${record.percentage}%)\n`;
                content += `- **ì†Œìš” ì‹œê°„**: ${this.formatTime(record.time)}\n`;
                content += `- **íŒŒì¼**: [[${record.file.basename}]]\n\n`;
            });
        } else {
            content += `> ì•„ì§ ì´ í´ë”ì˜ í€´ì¦ˆ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.\n\n`;
        }

        content += `---\n\n## ğŸ¯ ì¶”ì²œ í•™ìŠµ ì „ëµ\n\n`;

        // í•™ìŠµ ì „ëµ ì¶”ì²œ
        if (avgAccuracy >= 90) {
            content += `âœ… **ìš°ìˆ˜í•œ ì„±ì ì…ë‹ˆë‹¤!**\n- í˜„ì¬ ì´ í´ë”ì˜ ë¬¸ì œë“¤ì„ ì˜ ì´í•´í•˜ê³  ìˆìŠµë‹ˆë‹¤.\n- ìƒˆë¡œìš´ ë¬¸ì œì— ë„ì „í•´ë³´ì„¸ìš”.\n\n`;
        } else if (avgAccuracy >= 70) {
            content += `ğŸ‘ **ì¢‹ì€ ì„±ì ì…ë‹ˆë‹¤!**\n- ì¡°ê¸ˆë§Œ ë” ë³µìŠµí•˜ë©´ ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n- ì˜¤ë‹µë¥ ì´ ë†’ì€ ë¬¸ì œë¥¼ ì§‘ì¤‘ì ìœ¼ë¡œ ë³µìŠµí•˜ì„¸ìš”.\n\n`;
        } else if (avgAccuracy >= 50) {
            content += `ğŸ“š **ì¶”ê°€ í•™ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.**\n- ì˜¤ë‹µ ë¬¸ì œë¥¼ ë‹¤ì‹œ í•œ ë²ˆ ë³µìŠµí•˜ì„¸ìš”.\n- íŒíŠ¸ì™€ ë…¸íŠ¸ë¥¼ í™œìš©í•˜ì—¬ ê°œë…ì„ ì •ë¦¬í•˜ì„¸ìš”.\n\n`;
        } else {
            content += `ğŸ’ª **ê¾¸ì¤€í•œ í•™ìŠµì´ í•„ìš”í•©ë‹ˆë‹¤.**\n- ê¸°ì´ˆë¶€í„° ì°¨ê·¼ì°¨ê·¼ í•™ìŠµí•˜ì„¸ìš”.\n- ë§¤ì¼ ì¡°ê¸ˆì”©ì´ë¼ë„ ê¾¸ì¤€íˆ í•™ìŠµí•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•©ë‹ˆë‹¤.\n\n`;
        }

        // ë³µìŠµì´ í•„ìš”í•œ ë¬¸ì œ (ì •ë‹µë¥  50% ì´í•˜)
        const needReview = sortedQuestions.filter(q => {
            const totalAttempts = (q.correctCount || 0) + (q.wrongCount || 0);
            const accuracy = totalAttempts > 0 ? ((q.correctCount || 0) / totalAttempts) * 100 : 100;
            return totalAttempts > 0 && accuracy < 50;
        });

        if (needReview.length > 0) {
            content += `### ğŸ“Œ ë³µìŠµì´ í•„ìš”í•œ ë¬¸ì œ (ì •ë‹µë¥  50% ë¯¸ë§Œ)\n\n`;
            needReview.forEach(q => {
                const totalAttempts = (q.correctCount || 0) + (q.wrongCount || 0);
                const accuracy = Math.round(((q.correctCount || 0) / totalAttempts) * 100);
                content += `- **${q.hanzi || q.number}**: ${q.question} (ì •ë‹µë¥  ${accuracy}%)\n`;
            });
        }

        content += `\n---\n\n*ì´ í†µê³„ëŠ” ${new Date().toLocaleString('ko-KR')}ì— ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*\n`;

        // íŒŒì¼ ì €ì¥
        const statsFolder = `${this.plugin.settings.quizFolder}/í´ë”ë³„í†µê³„`;
        await this.app.vault.adapter.mkdir(statsFolder);
        
        const fileName = `${statsFolder}/${folderName}_í†µê³„.md`;
        const file = this.app.vault.getAbstractFileByPath(fileName);
        
        if (file) {
            await this.app.vault.modify(file, content);
        } else {
            await this.app.vault.create(fileName, content);
        }

        // íŒŒì¼ ì—´ê¸°
        const createdFile = this.app.vault.getAbstractFileByPath(fileName);
        if (createdFile) {
            const leaf = this.app.workspace.getLeaf(false);
            await leaf.openFile(createdFile);
            this.close();
        }
    }

    addStyles() {
        if (document.getElementById('quiz-detail-record-styles')) return;

        const style = document.createElement('style');
        style.id = 'quiz-detail-record-styles';
        style.textContent = `
            .quiz-detail-record-modal {
                padding: 0;
                max-width: 900px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .detail-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
                border-radius: 12px 12px 0 0;
            }

            .detail-header h1 {
                margin: 0 0 10px 0;
                font-size: 28px;
            }

            .detail-header p {
                margin: 0;
                opacity: 0.9;
            }

            /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
            .tab-navigation {
                display: flex;
                gap: 0;
                background: var(--background-secondary);
                border-bottom: 2px solid var(--background-modifier-border);
            }

            .tab-btn {
                flex: 1;
                padding: 15px 20px;
                background: transparent;
                border: none;
                border-bottom: 3px solid transparent;
                cursor: pointer;
                font-size: 15px;
                font-weight: 600;
                color: var(--text-muted);
                transition: all 0.2s;
            }

            .tab-btn:hover {
                background: var(--background-modifier-hover);
                color: var(--text-normal);
            }

            .tab-btn.active {
                border-bottom-color: var(--interactive-accent);
                color: var(--interactive-accent);
                background: var(--background-primary);
            }

            .tab-content {
                padding: 20px;
            }

            .stats-summary-card {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                padding: 0 0 25px 0;
                background: transparent;
            }

            .stat-item {
                text-align: center;
                padding: 20px;
                background: var(--background-secondary);
                border-radius: 10px;
                border: 2px solid var(--background-modifier-border);
            }

            .stat-icon {
                font-size: 32px;
                margin-bottom: 8px;
            }

            .stat-label {
                font-size: 13px;
                color: var(--text-muted);
                margin-bottom: 5px;
            }

            .stat-value {
                font-size: 24px;
                font-weight: bold;
                color: var(--text-normal);
            }

            /* ê°„ë‹¨í•œ ë¬¸ì œ ë¦¬ìŠ¤íŠ¸ */
            .simple-question-list h3 {
                margin: 0 0 15px 0;
                font-size: 18px;
            }

            .question-items {
                display: flex;
                flex-direction: column;
                gap: 6px;
            }

            .question-row {
                display: grid;
                grid-template-columns: 40px 40px 80px 1fr;
                gap: 10px;
                padding: 10px 15px;
                background: var(--background-secondary);
                border-radius: 6px;
                border-left: 3px solid var(--background-modifier-border);
                align-items: center;
                transition: all 0.2s;
            }

            .question-row:hover {
                transform: translateX(3px);
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }

            .question-row.correct-row {
                border-left-color: #4caf50;
            }

            .question-row.incorrect-row {
                border-left-color: #f44336;
            }

            .q-number {
                font-weight: bold;
                color: var(--text-muted);
                font-size: 14px;
            }

            .q-status {
                font-size: 18px;
            }

            .q-hanzi {
                font-weight: bold;
                font-size: 16px;
                color: var(--text-accent);
            }

            .q-text {
                font-size: 14px;
                color: var(--text-normal);
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* ëˆ„ì  í†µê³„ */
            .history-total-stats h3 {
                margin: 0 0 15px 0;
                font-size: 20px;
            }

            .total-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                margin-bottom: 30px;
            }

            .total-stat-item {
                text-align: center;
                padding: 20px;
                background: linear-gradient(135deg, var(--background-secondary), var(--background-primary-alt));
                border-radius: 10px;
                border: 2px solid var(--interactive-accent);
            }

            .total-stat-value {
                font-size: 32px;
                font-weight: bold;
                color: var(--interactive-accent);
                margin-bottom: 5px;
            }

            .total-stat-label {
                font-size: 13px;
                color: var(--text-muted);
            }

            /* ê¸°ë¡ ëª©ë¡ */
            .history-list h3 {
                margin: 0 0 15px 0;
                font-size: 18px;
            }

            .history-items {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .history-card {
                background: var(--background-secondary);
                border: 2px solid var(--background-modifier-border);
                border-radius: 10px;
                overflow: hidden;
                transition: all 0.2s;
            }

            .history-card:hover {
                border-color: var(--interactive-accent);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }

            .history-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 12px 20px;
                background: var(--background-primary);
                border-bottom: 1px solid var(--background-modifier-border);
            }

            .history-number {
                font-weight: bold;
                font-size: 14px;
                color: var(--interactive-accent);
            }

            .history-date {
                font-size: 13px;
                color: var(--text-muted);
            }

            .history-card-body {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                padding: 15px 20px;
            }

            .history-stat {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .history-stat-label {
                font-size: 12px;
                color: var(--text-muted);
                margin-bottom: 5px;
            }

            .history-stat-value {
                font-size: 18px;
                font-weight: bold;
                color: var(--text-normal);
            }

            .history-link-btn {
                width: 100%;
                padding: 10px;
                background: var(--interactive-accent);
                color: white;
                border: none;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600;
                transition: all 0.2s;
            }

            .history-link-btn:hover {
                background: var(--interactive-accent-hover);
            }

            .empty-message {
                text-align: center;
                padding: 60px 20px;
                color: var(--text-muted);
                font-size: 16px;
            }

            .modal-close-btn-detail {
                width: 100%;
                padding: 15px;
                font-size: 16px;
                font-weight: bold;
                border-radius: 0 0 12px 12px;
                background: var(--interactive-accent);
                color: white;
                cursor: pointer;
                transition: all 0.2s;
                border: none;
            }

            .modal-close-btn-detail:hover {
                background: var(--interactive-accent-hover);
            }

            /* í´ë”ë³„ í†µê³„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
            .folder-stats-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
                margin-top: 15px;
            }

            .folder-stat-card {
                background: var(--background-secondary);
                border: 2px solid var(--background-modifier-border);
                border-radius: 10px;
                overflow: hidden;
                transition: all 0.3s ease;
            }

            .folder-stat-card.clickable {
                cursor: pointer;
            }

            .folder-stat-card.clickable:hover {
                transform: translateY(-4px);
                box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
                border-color: var(--interactive-accent);
            }

            .folder-stat-card.clickable:active {
                transform: translateY(-2px);
            }

            .folder-stat-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: var(--background-primary);
                border-bottom: 1px solid var(--background-modifier-border);
            }

            .folder-stat-name {
                font-weight: bold;
                font-size: 16px;
                color: var(--text-normal);
            }

            .folder-stat-count {
                font-size: 13px;
                color: var(--text-muted);
            }

            .folder-stat-body {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                padding: 15px;
            }

            .folder-stat-item {
                text-align: center;
            }

            .folder-stat-label {
                font-size: 12px;
                color: var(--text-muted);
                margin-bottom: 5px;
            }

            .folder-stat-value {
                font-size: 18px;
                font-weight: bold;
                color: var(--text-normal);
            }

            @media (max-width: 768px) {
                .stats-summary-card {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 10px;
                }

                .total-stats-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .question-row {
                    grid-template-columns: 30px 30px 60px 1fr;
                    gap: 8px;
                    padding: 8px 12px;
                    font-size: 13px;
                }

                .history-card-body {
                    grid-template-columns: 1fr;
                    gap: 10px;
                }

                .tab-btn {
                    padding: 12px 15px;
                    font-size: 14px;
                }
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
        
        // ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°
        new DashboardModal(this.app, this.plugin).open();
    }
}

// ì£¼ê´€ì‹ Q&A ëª¨ë‹¬
class SubjectiveQAModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
        
        // ëª¨ë‹¬ì—ì„œ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í—ˆìš©
        this.scope.register([], 'Escape', () => {
            this.close();
            return false;
        });
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('subjective-qa-modal');
        
        // ëª¨ë‹¬ ì»¨í…Œì´ë„ˆì— í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì „íŒŒ í—ˆìš©
        contentEl.addEventListener('keydown', (e) => {
            // Ctrl+V, Ctrl+C, Ctrl+X, Ctrl+A ë“± ê¸°ë³¸ í¸ì§‘ í‚¤ í—ˆìš©
            if (e.ctrlKey || e.metaKey) {
                e.stopPropagation(); // ìƒìœ„ë¡œ ì „íŒŒ ì°¨ë‹¨í•˜ì—¬ ëª¨ë‹¬ ë‚´ì—ì„œë§Œ ì²˜ë¦¬
            }
        }, true); // capture phaseì—ì„œ ì²˜ë¦¬

        // í—¤ë”
        const header = contentEl.createDiv('modal-header');
        header.innerHTML = `
            <h2>ğŸ“ ì£¼ê´€ì‹ ë¬¸ì œ ë§Œë“¤ê¸°</h2>
            <p>ë¬¸ì œë¥¼ ì½ê³  ë‹µì„ í™•ì¸í•˜ëŠ” í•™ìŠµ ì¹´ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤</p>
        `;

        // í¼ ì»¨í…Œì´ë„ˆ
        const formContainer = contentEl.createDiv('qa-form-container');

        // ë¬¸ì œ ì…ë ¥
        const questionGroup = formContainer.createDiv('form-group');
        const questionLabel = questionGroup.createDiv('label-with-button');
        questionLabel.createEl('label', { text: 'ğŸ“‹ ë¬¸ì œ *' });
        
        // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ë²„íŠ¼
        const pasteBtn = questionLabel.createEl('button', {
            text: 'ğŸ“‹ í´ë¦½ë³´ë“œì—ì„œ ë¶™ì—¬ë„£ê¸°',
            cls: 'paste-btn'
        });
        
        const questionInput = questionGroup.createEl('textarea', {
            attr: {
                placeholder: 'ì˜ˆ: ì¼ë³¸ì–´ë¡œ "ì•ˆë…•í•˜ì„¸ìš”"ëŠ”?\n\nğŸ’¡ íŒ: Ctrl+Vë¡œ PDFë‚˜ ë‹¤ë¥¸ ê³³ì—ì„œ ë³µì‚¬í•œ í…ìŠ¤íŠ¸ë¥¼ ë°”ë¡œ ë¶™ì—¬ë„£ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤!',
                rows: 6,
                spellcheck: 'false',
                autocomplete: 'off',
                autocorrect: 'off',
                autocapitalize: 'off'
            }
        });
        questionInput.addClass('qa-input', 'qa-textarea');
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ê°€ ëª¨ë‹¬ì— ì°¨ë‹¨ë˜ì§€ ì•Šë„ë¡ ì„¤ì •
        questionInput.addEventListener('keydown', (e) => {
            // Ctrl+V, Ctrl+C, Ctrl+X, Ctrl+A í—ˆìš©
            if ((e.ctrlKey || e.metaKey) && ['v', 'c', 'x', 'a', 'z'].includes(e.key.toLowerCase())) {
                e.stopPropagation(); // ëª¨ë‹¬ì˜ í‚¤ í•¸ë“¤ëŸ¬ ì°¨ë‹¨
                console.log('í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ í—ˆìš©:', e.key);
                return; // ê¸°ë³¸ ë™ì‘ í—ˆìš©
            }
        }, true);
        
        // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ëª…ì‹œì  í—ˆìš©
        questionInput.addEventListener('paste', (e) => {
            e.stopPropagation(); // ëª¨ë‹¬ ì°¨ë‹¨ ë°©ì§€
            console.log('ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ ê°ì§€');
            
            // í´ë¦½ë³´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                const pastedText = clipboardData.getData('text');
                console.log('ë¶™ì—¬ë„£ì€ í…ìŠ¤íŠ¸:', pastedText);
                new Notice('âœ… í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸° ì™„ë£Œ!', 1500);
            }
        }, true);
        
        // ëª¨ë‹¬ ì—´ë¦¬ìë§ˆì í¬ì»¤ìŠ¤
        setTimeout(() => {
            questionInput.focus();
            console.log('ë¬¸ì œ ì…ë ¥ë€ í¬ì»¤ìŠ¤ë¨');
        }, 150);

        // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        pasteBtn.addEventListener('click', async () => {
            try {
                const text = await navigator.clipboard.readText();
                if (text) {
                    questionInput.value = text;
                    questionInput.focus();
                    // ì»¤ì„œë¥¼ í…ìŠ¤íŠ¸ ëìœ¼ë¡œ ì´ë™
                    questionInput.selectionStart = questionInput.value.length;
                    questionInput.selectionEnd = questionInput.value.length;
                    new Notice('âœ… í´ë¦½ë³´ë“œ ë‚´ìš©ì´ ë¶™ì—¬ë„£ì–´ì¡ŒìŠµë‹ˆë‹¤!');
                } else {
                    new Notice('âš ï¸ í´ë¦½ë³´ë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ì½ê¸° ì˜¤ë¥˜:', err);
                new Notice('âŒ í´ë¦½ë³´ë“œ ì½ê¸° ì‹¤íŒ¨. Ctrl+Vë¥¼ ì§ì ‘ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
            }
        });

        // ë‹µ ì…ë ¥
        const answerGroup = formContainer.createDiv('form-group');
        answerGroup.createEl('label', { text: 'âœ… ë‹µ *' });
        const answerInput = answerGroup.createEl('textarea', {
            attr: {
                placeholder: 'ì˜ˆ: ã“ã‚“ã«ã¡ã¯',
                rows: 3,
                spellcheck: 'false'
            }
        });
        answerInput.addClass('qa-input', 'qa-textarea');
        
        // ë‹µ ì…ë ¥ë€ì—ë„ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í—ˆìš©
        answerInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && ['v', 'c', 'x', 'a', 'z'].includes(e.key.toLowerCase())) {
                e.stopPropagation();
            }
        }, true);
        
        answerInput.addEventListener('paste', (e) => {
            e.stopPropagation();
        }, true);

        // í•´ì„¤ ì…ë ¥
        const explanationGroup = formContainer.createDiv('form-group');
        explanationGroup.createEl('label', { text: 'ğŸ’¡ í•´ì„¤ (ì„ íƒ)' });
        const explanationInput = explanationGroup.createEl('textarea', {
            attr: {
                placeholder: 'ë¬¸ì œì— ëŒ€í•œ ì¶”ê°€ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”',
                rows: 3,
                spellcheck: 'false'
            }
        });
        explanationInput.addClass('qa-input', 'qa-textarea');
        
        // í•´ì„¤ ì…ë ¥ë€ì—ë„ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í—ˆìš©
        explanationInput.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && ['v', 'c', 'x', 'a', 'z'].includes(e.key.toLowerCase())) {
                e.stopPropagation();
            }
        }, true);
        
        explanationInput.addEventListener('paste', (e) => {
            e.stopPropagation();
        }, true);

        // 2ì—´ ë ˆì´ì•„ì›ƒ
        const rowContainer = formContainer.createDiv('form-row');

        // ê³¼ëª© ì…ë ¥
        const subjectGroup = rowContainer.createDiv('form-group');
        subjectGroup.createEl('label', { text: 'ğŸ“š ê³¼ëª©' });
        const subjectInput = subjectGroup.createEl('input', {
            attr: {
                type: 'text',
                placeholder: 'ì˜ˆ: ì¼ë³¸ì–´',
                value: 'ì¼ë³¸ì–´'
            }
        });
        subjectInput.addClass('qa-input');

        // ë‚œì´ë„ ì„ íƒ
        const levelGroup = rowContainer.createDiv('form-group');
        levelGroup.createEl('label', { text: 'â­ ë‚œì´ë„' });
        const levelSelect = levelGroup.createEl('select');
        levelSelect.addClass('qa-input');
        ['1 - ì‰¬ì›€', '2', '3 - ë³´í†µ', '4', '5 - ì–´ë ¤ì›€'].forEach((level, idx) => {
            const option = levelSelect.createEl('option', {
                text: 'â­'.repeat(idx + 1) + ' ' + level,
                value: (idx + 1).toString()
            });
            if (idx === 2) option.selected = true;
        });

        // 2ì—´ ë ˆì´ì•„ì›ƒ
        const row2Container = formContainer.createDiv('form-row');

        // í‚¤ì›Œë“œ ì…ë ¥
        const keywordsGroup = row2Container.createDiv('form-group');
        keywordsGroup.createEl('label', { text: 'ğŸ”‘ í‚¤ì›Œë“œ' });
        const keywordsInput = keywordsGroup.createEl('input', {
            attr: {
                type: 'text',
                placeholder: 'ì‰¼í‘œë¡œ êµ¬ë¶„ (ì˜ˆ: ì¸ì‚¬, ê¸°ë³¸í‘œí˜„)'
            }
        });
        keywordsInput.addClass('qa-input');

        // íƒ€ì´ë¨¸ ì…ë ¥
        const timerGroup = row2Container.createDiv('form-group');
        timerGroup.createEl('label', { text: 'â±ï¸ íƒ€ì´ë¨¸ (ì´ˆ)' });
        const timerInput = timerGroup.createEl('input', {
            attr: {
                type: 'number',
                min: 5,
                max: 300,
                value: 30,
                placeholder: 'ì œí•œ ì‹œê°„'
            }
        });
        timerInput.addClass('qa-input');

        // ë²„íŠ¼ ì˜ì—­
        const buttonArea = contentEl.createDiv('button-area');

        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼
        const previewBtn = buttonArea.createEl('button', {
            text: 'ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°',
            cls: 'mod-cta qa-btn-secondary'
        });

        // ìƒì„± ë²„íŠ¼
        const createBtn = buttonArea.createEl('button', {
            text: 'âœ¨ ì¹´ë“œ ìƒì„±',
            cls: 'mod-cta'
        });

        // ë¯¸ë¦¬ë³´ê¸° ì˜ì—­
        const previewArea = contentEl.createDiv('preview-area');
        previewArea.style.display = 'none';

        // ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        previewBtn.addEventListener('click', () => {
            const question = questionInput.value.trim();
            const answer = answerInput.value.trim();

            if (!question || !answer) {
                new Notice('âš ï¸ ë¬¸ì œì™€ ë‹µì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤!');
                return;
            }

            const explanation = explanationInput.value.trim();
            const subject = subjectInput.value.trim() || 'ë¯¸ë¶„ë¥˜';
            const level = levelSelect.value;
            const keywords = keywordsInput.value.trim();
            const timer = timerInput.value;

            let codeBlock = '```qa\n';
            codeBlock += `ë¬¸ì œ: ${question}\n`;
            codeBlock += `ë‹µ: ${answer}\n`;
            if (explanation) codeBlock += `í•´ì„¤: ${explanation}\n`;
            codeBlock += `ê³¼ëª©: ${subject}\n`;
            codeBlock += `ë‚œì´ë„: ${level}\n`;
            if (keywords) codeBlock += `í‚¤ì›Œë“œ: ${keywords}\n`;
            if (timer) codeBlock += `íƒ€ì´ë¨¸: ${timer}\n`;
            codeBlock += '```';

            previewArea.empty();
            previewArea.createEl('h3', { text: 'ğŸ“º ë¯¸ë¦¬ë³´ê¸°' });
            const pre = previewArea.createEl('pre');
            pre.style.cssText = `
                background: #1e1e1e;
                color: #d4d4d4;
                padding: 20px;
                border-radius: 8px;
                overflow-x: auto;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 14px;
                line-height: 1.6;
            `;
            pre.textContent = codeBlock;
            previewArea.style.display = 'block';

            // ìŠ¤í¬ë¡¤
            previewArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            new Notice('âœ… ë¯¸ë¦¬ë³´ê¸°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

        // ìƒì„± ë²„íŠ¼ ì´ë²¤íŠ¸
        createBtn.addEventListener('click', async () => {
            const question = questionInput.value.trim();
            const answer = answerInput.value.trim();

            if (!question || !answer) {
                new Notice('âš ï¸ ë¬¸ì œì™€ ë‹µì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤!');
                return;
            }

            const explanation = explanationInput.value.trim();
            const subject = subjectInput.value.trim() || 'ë¯¸ë¶„ë¥˜';
            const level = levelSelect.value;
            const keywords = keywordsInput.value.trim();
            const timer = timerInput.value;

            let codeBlock = '```qa\n';
            codeBlock += `ë¬¸ì œ: ${question}\n`;
            codeBlock += `ë‹µ: ${answer}\n`;
            if (explanation) codeBlock += `í•´ì„¤: ${explanation}\n`;
            codeBlock += `ê³¼ëª©: ${subject}\n`;
            codeBlock += `ë‚œì´ë„: ${level}\n`;
            if (keywords) codeBlock += `í‚¤ì›Œë“œ: ${keywords}\n`;
            if (timer) codeBlock += `íƒ€ì´ë¨¸: ${timer}\n`;
            codeBlock += '```\n\n';

            // í˜„ì¬ í™œì„± íŒŒì¼ì— ì‚½ì…
            const activeFile = this.app.workspace.getActiveFile();
            if (activeFile) {
                const content = await this.app.vault.read(activeFile);
                const newContent = content + '\n' + codeBlock;
                await this.app.vault.modify(activeFile, newContent);
                new Notice('âœ… ì£¼ê´€ì‹ Q&A ì¹´ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                // íŒŒì¼ì´ ì—†ìœ¼ë©´ í´ë¦½ë³´ë“œì— ë³µì‚¬
                navigator.clipboard.writeText(codeBlock);
                new Notice('ğŸ“‹ ì½”ë“œ ë¸”ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }

            this.close();
        });

        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        this.addModalStyles();
    }

    addModalStyles() {
        if (document.getElementById('subjective-qa-modal-styles')) return;

        const style = document.createElement('style');
        style.id = 'subjective-qa-modal-styles';
        style.textContent = `
            .subjective-qa-modal {
                padding: 0;
            }

            .subjective-qa-modal .modal-content {
                padding: 0;
            }

            .subjective-qa-modal .modal-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 32px;
                text-align: center;
                border-radius: 8px 8px 0 0;
            }

            .subjective-qa-modal .modal-header h2 {
                margin: 0 0 12px 0;
                font-size: 28px;
                font-weight: 700;
            }

            .subjective-qa-modal .modal-header p {
                margin: 0;
                opacity: 0.95;
                font-size: 15px;
            }

            .subjective-qa-modal .qa-form-container {
                padding: 32px;
                background: var(--background-primary);
            }

            .subjective-qa-modal .form-group {
                margin-bottom: 24px;
                flex: 1;
            }

            .subjective-qa-modal .label-with-button {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px;
            }

            .subjective-qa-modal .form-group label {
                display: block;
                font-weight: 600;
                margin-bottom: 0;
                color: var(--text-normal);
                font-size: 15px;
            }

            .subjective-qa-modal .paste-btn {
                padding: 6px 14px;
                font-size: 13px;
                font-weight: 600;
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s ease;
                box-shadow: 0 2px 8px rgba(17, 153, 142, 0.3);
            }

            .subjective-qa-modal .paste-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(17, 153, 142, 0.4);
            }

            .subjective-qa-modal .paste-btn:active {
                transform: translateY(0);
            }

            .subjective-qa-modal .qa-input {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid var(--background-modifier-border);
                border-radius: 8px;
                background: var(--background-primary);
                color: var(--text-normal);
                font-size: 14px;
                font-family: inherit;
                transition: all 0.2s ease;
                user-select: text;
                -webkit-user-select: text;
                -moz-user-select: text;
                -ms-user-select: text;
            }

            .subjective-qa-modal .qa-textarea {
                resize: vertical;
                min-height: 120px;
                line-height: 1.6;
                font-family: inherit;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .subjective-qa-modal .qa-input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                background: var(--background-primary-alt);
            }

            /* textarea í¬ì»¤ìŠ¤ ê°•ì¡° */
            .subjective-qa-modal .qa-textarea:focus {
                border-color: #11998e;
                box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.15);
            }

            .subjective-qa-modal .form-row {
                display: flex;
                gap: 20px;
                margin-bottom: 24px;
            }

            .subjective-qa-modal .button-area {
                display: flex;
                gap: 12px;
                justify-content: flex-end;
                padding: 24px 32px;
                background: var(--background-secondary);
                border-top: 1px solid var(--background-modifier-border);
            }

            .subjective-qa-modal .button-area button {
                padding: 12px 24px;
                font-size: 15px;
                font-weight: 600;
                cursor: pointer;
                border-radius: 8px;
                transition: all 0.2s ease;
            }

            .subjective-qa-modal .qa-btn-secondary {
                background: var(--interactive-normal);
                color: var(--text-normal);
            }

            .subjective-qa-modal .qa-btn-secondary:hover {
                background: var(--interactive-hover);
            }

            .subjective-qa-modal .preview-area {
                padding: 24px 32px;
                background: var(--background-secondary);
                border-top: 1px solid var(--background-modifier-border);
            }

            .subjective-qa-modal .preview-area h3 {
                margin: 0 0 16px 0;
                color: var(--text-normal);
                font-size: 18px;
            }

            @media (max-width: 768px) {
                .subjective-qa-modal .modal-header {
                    padding: 24px 20px;
                }

                .subjective-qa-modal .modal-header h2 {
                    font-size: 24px;
                }

                .subjective-qa-modal .qa-form-container {
                    padding: 24px 20px;
                }

                .subjective-qa-modal .label-with-button {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 8px;
                }

                .subjective-qa-modal .paste-btn {
                    width: 100%;
                    padding: 10px 14px;
                }

                .subjective-qa-modal .form-row {
                    flex-direction: column;
                    gap: 0;
                }

                .subjective-qa-modal .button-area {
                    flex-direction: column;
                    padding: 20px;
                }

                .subjective-qa-modal .button-area button {
                    width: 100%;
                }
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ë¦¬ë³¸ ë©”ë‰´ ê´€ë¦¬ ëª¨ë‹¬
class RibbonMenuManagerModal extends Modal {
    constructor(app, plugin) {
        super(app);
        this.plugin = plugin;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('ribbon-menu-manager-modal');
        
        this.titleEl.setText('âš™ï¸ ë¦¬ë³¸ ë©”ë‰´ ê´€ë¦¬');
        
        // ì„¤ëª…
        const desc = contentEl.createDiv({ cls: 'ribbon-menu-desc' });
        desc.createEl('p', { 
            text: 'ë¦¬ë³¸ ë©”ë‰´(â‰¡)ì— í‘œì‹œí•  í•­ëª©ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•­ëª©ì„ ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œë¥¼ ë³€ê²½í•˜ê±°ë‚˜, í† ê¸€ë¡œ í‘œì‹œ/ìˆ¨ê¹€ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
            cls: 'setting-item-description'
        });
        
        // ë©”ë‰´ í•­ëª© ë¦¬ìŠ¤íŠ¸
        const listContainer = contentEl.createDiv({ cls: 'ribbon-menu-list' });
        
        const menuItems = this.plugin.settings.ribbonMenuItems || [];
        
        menuItems.forEach((item, index) => {
            const itemEl = listContainer.createDiv({ cls: 'ribbon-menu-item' });
            itemEl.draggable = true;
            itemEl.dataset.index = index;
            
            // ë“œë˜ê·¸ í•¸ë“¤
            const dragHandle = itemEl.createDiv({ cls: 'drag-handle' });
            dragHandle.setText('â‹®â‹®');
            
            // ì•„ì´ì½˜
            const iconEl = itemEl.createDiv({ cls: 'menu-item-icon' });
            iconEl.setText(item.title.split(' ')[0]); // ì´ëª¨ì§€ ì¶”ì¶œ
            
            // ì œëª©
            const titleEl = itemEl.createDiv({ cls: 'menu-item-title' });
            titleEl.setText(item.title);
            
            // í† ê¸€
            const toggleContainer = itemEl.createDiv({ cls: 'menu-item-toggle' });
            const toggle = toggleContainer.createEl('input', { type: 'checkbox' });
            toggle.checked = item.enabled;
            toggle.addEventListener('change', async () => {
                this.plugin.settings.ribbonMenuItems[index].enabled = toggle.checked;
                await this.plugin.saveSettings();
            });
            
            // í¸ì§‘ ë²„íŠ¼
            const editBtn = itemEl.createEl('button', { 
                text: 'âœï¸',
                cls: 'menu-item-edit-btn'
            });
            editBtn.title = 'í¸ì§‘';
            editBtn.addEventListener('click', () => {
                new RibbonMenuItemEditModal(this.app, this.plugin, item, index, () => {
                    this.onOpen(); // ìƒˆë¡œê³ ì¹¨
                }).open();
            });
            
            // ì‚­ì œ ë²„íŠ¼
            const deleteBtn = itemEl.createEl('button', { 
                text: 'ğŸ—‘ï¸',
                cls: 'menu-item-delete-btn'
            });
            deleteBtn.title = 'ì‚­ì œ';
            deleteBtn.addEventListener('click', async () => {
                if (confirm(`"${item.title}" í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    this.plugin.settings.ribbonMenuItems.splice(index, 1);
                    await this.plugin.saveSettings();
                    this.onOpen(); // ìƒˆë¡œê³ ì¹¨
                    new Notice('âœ… ë©”ë‰´ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });
            
            // ë“œë˜ê·¸ ì´ë²¤íŠ¸
            itemEl.addEventListener('dragstart', (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', index);
                itemEl.classList.add('dragging');
            });
            
            itemEl.addEventListener('dragend', () => {
                itemEl.classList.remove('dragging');
            });
            
            itemEl.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                const afterElement = this.getDragAfterElement(listContainer, e.clientY);
                const draggingElement = listContainer.querySelector('.dragging');
                
                if (afterElement == null) {
                    listContainer.appendChild(draggingElement);
                } else {
                    listContainer.insertBefore(draggingElement, afterElement);
                }
            });
            
            itemEl.addEventListener('drop', async (e) => {
                e.preventDefault();
                const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                const toIndex = parseInt(itemEl.dataset.index);
                
                if (fromIndex !== toIndex) {
                    const items = this.plugin.settings.ribbonMenuItems;
                    const [movedItem] = items.splice(fromIndex, 1);
                    items.splice(toIndex, 0, movedItem);
                    await this.plugin.saveSettings();
                    this.onOpen(); // ìƒˆë¡œê³ ì¹¨
                    new Notice('âœ… ë©”ë‰´ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
                }
            });
        });
        
        // ì¶”ê°€ ë²„íŠ¼
        const addBtnContainer = contentEl.createDiv({ cls: 'ribbon-menu-add-container' });
        const addBtn = addBtnContainer.createEl('button', {
            text: 'â• ìƒˆ ë©”ë‰´ í•­ëª© ì¶”ê°€',
            cls: 'mod-cta'
        });
        addBtn.addEventListener('click', () => {
            new RibbonMenuItemEditModal(this.app, this.plugin, null, -1, () => {
                this.onOpen(); // ìƒˆë¡œê³ ì¹¨
            }).open();
        });
        
        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        this.injectStyles();
    }

    getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.ribbon-menu-item:not(.dragging)')];
        
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    injectStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .ribbon-menu-manager-modal .modal-content {
                padding: 20px;
            }

            .ribbon-menu-desc {
                margin-bottom: 20px;
                padding: 15px;
                background: var(--background-secondary);
                border-radius: 8px;
            }

            .ribbon-menu-list {
                margin-bottom: 20px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 8px;
                overflow: hidden;
            }

            .ribbon-menu-item {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 12px 16px;
                background: var(--background-primary);
                border-bottom: 1px solid var(--background-modifier-border);
                cursor: move;
                transition: background 0.2s;
            }

            .ribbon-menu-item:last-child {
                border-bottom: none;
            }

            .ribbon-menu-item:hover {
                background: var(--background-secondary);
            }

            .ribbon-menu-item.dragging {
                opacity: 0.5;
            }

            .drag-handle {
                color: var(--text-muted);
                cursor: grab;
                font-size: 16px;
                user-select: none;
            }

            .drag-handle:active {
                cursor: grabbing;
            }

            .menu-item-icon {
                font-size: 18px;
                width: 24px;
                text-align: center;
            }

            .menu-item-title {
                flex: 1;
                font-weight: 500;
            }

            .menu-item-toggle {
                display: flex;
                align-items: center;
            }

            .menu-item-toggle input[type="checkbox"] {
                cursor: pointer;
            }

            .menu-item-edit-btn,
            .menu-item-delete-btn {
                padding: 6px 10px;
                border: none;
                background: transparent;
                cursor: pointer;
                border-radius: 4px;
                transition: background 0.2s;
            }

            .menu-item-edit-btn:hover {
                background: var(--background-modifier-hover);
            }

            .menu-item-delete-btn:hover {
                background: var(--background-modifier-error);
            }

            .ribbon-menu-add-container {
                text-align: center;
                padding: 10px 0;
            }

            .ribbon-menu-add-container button {
                padding: 10px 20px;
            }

            /* ëª¨ë°”ì¼ ìµœì í™” */
            @media (max-width: 768px) {
                .ribbon-menu-manager-modal .modal-content {
                    padding: 15px;
                }

                .ribbon-menu-desc {
                    padding: 12px;
                    font-size: 14px;
                }

                .ribbon-menu-item {
                    gap: 8px;
                    padding: 10px 12px;
                }

                .drag-handle {
                    font-size: 14px;
                    min-width: 20px;
                }

                .menu-item-icon {
                    font-size: 16px;
                    width: 20px;
                }

                .menu-item-title {
                    font-size: 14px;
                }

                .menu-item-edit-btn,
                .menu-item-delete-btn {
                    padding: 8px 12px;
                    font-size: 16px;
                    min-width: 40px;
                    min-height: 40px;
                }

                .ribbon-menu-add-container button {
                    width: 100%;
                    padding: 12px 20px;
                    font-size: 15px;
                }
            }

            @media (max-width: 480px) {
                .ribbon-menu-item {
                    gap: 6px;
                    padding: 8px 10px;
                }

                .menu-item-title {
                    font-size: 13px;
                }
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// ë¦¬ë³¸ ë©”ë‰´ í•­ëª© í¸ì§‘ ëª¨ë‹¬
class RibbonMenuItemEditModal extends Modal {
    constructor(app, plugin, item, index, onSave) {
        super(app);
        this.plugin = plugin;
        this.item = item || {
            id: '',
            title: '',
            icon: 'star',
            action: 'custom',
            enabled: true
        };
        this.index = index;
        this.onSave = onSave;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        contentEl.addClass('ribbon-menu-item-edit-modal');
        
        this.titleEl.setText(this.index === -1 ? 'â• ìƒˆ ë©”ë‰´ í•­ëª©' : 'âœï¸ ë©”ë‰´ í•­ëª© í¸ì§‘');
        
        const form = contentEl.createDiv({ cls: 'menu-item-form' });
        
        // ì œëª©
        const titleGroup = form.createDiv({ cls: 'form-group' });
        titleGroup.createEl('label', { text: 'ì œëª©' });
        const titleInput = titleGroup.createEl('input', { 
            type: 'text',
            value: this.item.title,
            placeholder: 'ì˜ˆ: ğŸ“ ë©”ëª¨ ì¶”ê°€'
        });
        
        // ì•„ì´ì½˜ (Obsidian ì•„ì´ì½˜ ì´ë¦„)
        const iconGroup = form.createDiv({ cls: 'form-group' });
        iconGroup.createEl('label', { text: 'Obsidian ì•„ì´ì½˜ ì´ë¦„' });
        const iconInput = iconGroup.createEl('input', { 
            type: 'text',
            value: this.item.icon,
            placeholder: 'ì˜ˆ: star, pencil, trash'
        });
        const iconDesc = iconGroup.createEl('div', {
            text: 'ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ì½˜: home, star, pencil, trash, target, settings, book, folder, tag ë“±',
            cls: 'setting-item-description'
        });
        
        // ì•¡ì…˜ íƒ€ì…
        const actionGroup = form.createDiv({ cls: 'form-group' });
        actionGroup.createEl('label', { text: 'ì•¡ì…˜ íƒ€ì…' });
        const actionSelect = actionGroup.createEl('select');
        const actions = [
            { value: 'dashboard', label: 'ğŸ“Š ëŒ€ì‹œë³´ë“œ' },
            { value: 'difficulty', label: 'ğŸ¯ ë‚œì´ë„ ì„¤ì •' },
            { value: 'timer', label: 'âš™ï¸ íƒ€ì´ë¨¸ ì„¤ì •' },
            { value: 'separator', label: 'â”€â”€â”€ êµ¬ë¶„ì„  â”€â”€â”€' },
            { value: 'edit', label: 'âœï¸ í¸ì§‘' },
            { value: 'delete', label: 'ğŸ—‘ï¸ ì‚­ì œ' },
            { value: 'bookmark', label: 'â­ ë¶ë§ˆí¬ í† ê¸€' },
            { value: 'folder', label: 'ğŸ“ í´ë” ê´€ë¦¬' },
            { value: 'separator', label: 'â”€â”€â”€ êµ¬ë¶„ì„  â”€â”€â”€' },
            { value: 'prev', label: 'â¬…ï¸ ì´ì „ ë¬¸ì œ' },
            { value: 'next', label: 'â¡ï¸ ë‹¤ìŒ ë¬¸ì œ' },
            { value: 'pause', label: 'â¸ï¸ ì¼ì‹œì •ì§€' },
            { value: 'separator', label: 'â”€â”€â”€ êµ¬ë¶„ì„  â”€â”€â”€' },
            { value: 'create-question', label: 'ğŸ“ ë¬¸ì œ ë§Œë“¤ê¸°' },
            { value: 'wrong-answer', label: 'âŒ ì˜¤ë‹µ ë³µìŠµ' },
            { value: 'bookmark-quiz', label: 'â­ ë¶ë§ˆí¬ í€´ì¦ˆ' },
            { value: 'question-list', label: 'ğŸ“‹ ë¬¸ì œ ëª©ë¡' },
            { value: 'record-management', label: 'ğŸ“Š ê¸°ë¡ ê´€ë¦¬' },
            { value: 'statistics', label: 'ğŸ“ˆ í•™ìŠµ í†µê³„' },
            { value: 'separator', label: 'â”€â”€â”€ êµ¬ë¶„ì„  â”€â”€â”€' },
            { value: 'clear-records', label: 'ğŸ—‘ï¸ ì „ì²´ ê¸°ë¡ ì´ˆê¸°í™”' },
            { value: 'clear-folder-records', label: 'ğŸ“ í´ë”ë³„ ê¸°ë¡ ì´ˆê¸°í™”' }
        ];
        
        actions.forEach(action => {
            const option = actionSelect.createEl('option', {
                value: action.value,
                text: action.label
            });
            if (action.value === 'separator') {
                option.disabled = true;
                option.style.textAlign = 'center';
            }
            if (this.item.action === action.value) {
                option.selected = true;
            }
        });
        
        // ID (ìë™ ìƒì„±)
        const idGroup = form.createDiv({ cls: 'form-group' });
        idGroup.createEl('label', { text: 'ID (ìë™ ìƒì„±)' });
        const idInput = idGroup.createEl('input', { 
            type: 'text',
            value: this.item.id,
            placeholder: 'ìë™ ìƒì„±ë¨',
            disabled: true
        });
        
        // ë²„íŠ¼
        const btnContainer = contentEl.createDiv({ cls: 'modal-button-container' });
        
        const cancelBtn = btnContainer.createEl('button', {
            text: 'ì·¨ì†Œ'
        });
        cancelBtn.addEventListener('click', () => {
            this.close();
        });
        
        const saveBtn = btnContainer.createEl('button', {
            text: 'ì €ì¥',
            cls: 'mod-cta'
        });
        saveBtn.addEventListener('click', async () => {
            const title = titleInput.value.trim();
            const icon = iconInput.value.trim();
            const action = actionSelect.value;
            
            if (!title) {
                new Notice('âŒ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!icon) {
                new Notice('âŒ ì•„ì´ì½˜ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            const newItem = {
                id: this.item.id || `custom-${Date.now()}`,
                title: title,
                icon: icon,
                action: action,
                enabled: true
            };
            
            if (this.index === -1) {
                // ìƒˆ í•­ëª© ì¶”ê°€
                this.plugin.settings.ribbonMenuItems.push(newItem);
            } else {
                // ê¸°ì¡´ í•­ëª© ìˆ˜ì •
                this.plugin.settings.ribbonMenuItems[this.index] = newItem;
            }
            
            await this.plugin.saveSettings();
            new Notice('âœ… ë©”ë‰´ í•­ëª©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
            this.close();
            
            if (this.onSave) {
                this.onSave();
            }
        });
        
        // ìŠ¤íƒ€ì¼ ì¶”ê°€
        this.injectStyles();
    }

    injectStyles() {
        const style = document.createElement('style');
        style.textContent = `
            .ribbon-menu-item-edit-modal .modal-content {
                padding: 20px;
                min-width: 400px;
            }

            .menu-item-form {
                display: flex;
                flex-direction: column;
                gap: 16px;
                margin-bottom: 20px;
            }

            .form-group {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .form-group label {
                font-weight: 600;
                color: var(--text-normal);
            }

            .form-group input,
            .form-group select {
                padding: 8px 12px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                background: var(--background-primary);
                color: var(--text-normal);
            }

            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: var(--interactive-accent);
            }

            .modal-button-container {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }

            .modal-button-container button {
                padding: 8px 16px;
            }

            /* ëª¨ë°”ì¼ ìµœì í™” */
            @media (max-width: 768px) {
                .ribbon-menu-item-edit-modal .modal-content {
                    padding: 15px;
                    min-width: auto;
                    max-width: 100%;
                }

                .menu-item-form {
                    gap: 14px;
                }

                .form-group input,
                .form-group select {
                    padding: 10px 12px;
                    font-size: 16px; /* iOSì—ì„œ ìë™ ì¤Œ ë°©ì§€ */
                }

                .modal-button-container {
                    flex-direction: column-reverse;
                    gap: 8px;
                }

                .modal-button-container button {
                    width: 100%;
                    padding: 12px 16px;
                    font-size: 15px;
                }
            }

            @media (max-width: 480px) {
                .ribbon-menu-item-edit-modal .modal-content {
                    padding: 12px;
                }

                .menu-item-form {
                    gap: 12px;
                }

                .form-group label {
                    font-size: 14px;
                }
            }
        `;
        document.head.appendChild(style);
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// =====================================================
// ë…¸íŠ¸ í¸ì§‘ ëª¨ë‹¬ (ë¶„ë¦¬ëœ ë””ìì¸)
// =====================================================
class QuizNoteEditModal extends Modal {
    constructor(app, plugin, file, onSave) {
        super(app);
        this.plugin = plugin;
        this.file = file;
        this.onSave = onSave;
        this.content = '';
    }

    async onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        // íŒŒì¼ ë‚´ìš© ì½ê¸°
        this.content = await this.app.vault.read(this.file);
        
        // ## ë…¸íŠ¸ ì„¹ì…˜ì—ì„œ ë‚´ìš© ì¶”ì¶œ
        let noteContent = '';
        const noteSectionRegex = /## ë…¸íŠ¸\n([\s\S]*?)(?=\n## |$)/;
        const noteMatch = this.content.match(noteSectionRegex);
        
        if (noteMatch) {
            noteContent = noteMatch[1].trim();
        }
        
        // ## ë…¸íŠ¸ ì´ë¯¸ì§€ ì„¹ì…˜ì—ì„œ ë‚´ìš© ì¶”ì¶œ
        let noteImageContent = '';
        const noteImageRegex = /## ë…¸íŠ¸ ì´ë¯¸ì§€\n([\s\S]*?)(?=\n## |$)/;
        const imageMatch = this.content.match(noteImageRegex);
        
        if (imageMatch) {
            noteImageContent = imageMatch[1].trim();
        }
        
        contentEl.createEl('h2', { text: `ğŸ“ ${this.file.basename} - ë…¸íŠ¸ í¸ì§‘` });
        
        // ===== ë…¸íŠ¸ í…ìŠ¤íŠ¸ ì„¹ì…˜ =====
        const noteSection = contentEl.createDiv();
        noteSection.style.cssText = 'margin: 20px 0; padding: 20px; background: var(--background-primary-alt); border: 2px solid var(--interactive-accent); border-radius: 12px;';
        
        const noteHeader = noteSection.createEl('h3');
        noteHeader.innerHTML = 'ğŸ“„ ë…¸íŠ¸';
        noteHeader.style.cssText = 'margin: 0 0 15px 0; color: var(--interactive-accent); font-size: 18px;';
        
        const noteInfo = noteSection.createEl('p');
        noteInfo.textContent = 'ì¶”ê°€ ì„¤ëª…ì´ë‚˜ ê¸°ì–µí•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)';
        noteInfo.style.cssText = 'color: var(--text-muted); font-size: 13px; margin-bottom: 12px;';
        
        const textarea = noteSection.createEl('textarea');
        textarea.value = noteContent;
        textarea.placeholder = 'ì˜ˆ: ì´ ë¬¸ì œëŠ” ìì£¼ ë‚˜ì˜¤ëŠ” ìœ í˜•ì…ë‹ˆë‹¤...';
        textarea.style.cssText = `
            width: 100%;
            height: 250px;
            font-family: var(--font-monospace);
            font-size: 14px;
            padding: 12px;
            border: 2px solid var(--background-modifier-border);
            border-radius: 8px;
            resize: vertical;
            background: var(--background-primary);
        `;
        
        // ===== ë…¸íŠ¸ ì´ë¯¸ì§€ ì„¹ì…˜ =====
        const imageSection = contentEl.createDiv();
        imageSection.style.cssText = 'margin: 20px 0; padding: 20px; background: var(--background-secondary); border-radius: 12px; border: 2px solid var(--background-modifier-border);';
        
        const imageHeader = imageSection.createEl('h3');
        imageHeader.innerHTML = 'ğŸ–¼ï¸ ë…¸íŠ¸ ì´ë¯¸ì§€';
        imageHeader.style.cssText = 'margin: 0 0 15px 0; color: var(--text-accent); font-size: 18px;';
        
        const imageInfo = imageSection.createEl('p');
        imageInfo.innerHTML = 'ğŸ“Œ <strong>Ctrl+V</strong>ë¡œ í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸° | ğŸ‘† ì´ë¯¸ì§€ ì¢Œìš° ìŠ¤ì™€ì´í”„ ê°€ëŠ¥';
        imageInfo.style.cssText = 'color: var(--text-accent); font-size: 13px; margin-bottom: 12px; padding: 8px; background: var(--background-secondary); border-radius: 6px; border-left: 3px solid var(--interactive-accent);';
        
        // ê¸°ì¡´ ì´ë¯¸ì§€ ë§í¬ ë°°ì—´ (ìƒìœ„ ìŠ¤ì½”í”„ì— ì„ ì–¸)
        let imageLinks = [];
        if (noteImageContent) {
            imageLinks = noteImageContent.split('\n').filter(line => line.trim().startsWith('![['));
        }
        
        // ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ (ë¯¸ë¦¬ë³´ê¸° ê°€ëŠ¥)
        const existingImagesDiv = imageSection.createDiv();
        existingImagesDiv.style.cssText = 'margin-bottom: 15px;';
        
        // galleryContainerë¥¼ ìƒìœ„ ìŠ¤ì½”í”„ì— ì„ ì–¸ (ìƒˆë¡œê³ ì¹¨ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
        let galleryContainer = null;
        
        if (noteImageContent) {
            const existingHeader = existingImagesDiv.createEl('h4');
            existingHeader.textContent = 'í˜„ì¬ ì´ë¯¸ì§€:';
            existingHeader.style.cssText = 'margin-bottom: 10px; font-size: 14px;';
            
            // ìŠ¤ì™€ì´í”„ ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬
            const galleryWrapper = existingImagesDiv.createDiv();
            galleryWrapper.style.cssText = 'position: relative; margin-bottom: 15px;';
            
            galleryContainer = galleryWrapper.createDiv();
            galleryContainer.style.cssText = `
                display: flex;
                transition: transform 0.3s ease;
                gap: 10px;
                overflow-x: auto;
                scroll-snap-type: x mandatory;
                -webkit-overflow-scrolling: touch;
                padding: 10px 0;
                scroll-behavior: smooth;
            `;
            
            // ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì§€ì›
            let touchStartX = 0;
            let touchEndX = 0;
            let scrollLeft = 0;
            
            galleryContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                scrollLeft = galleryContainer.scrollLeft;
            }, { passive: true });
            
            galleryContainer.addEventListener('touchmove', (e) => {
                if (!touchStartX) return;
                touchEndX = e.touches[0].clientX;
                const diff = touchStartX - touchEndX;
                galleryContainer.scrollLeft = scrollLeft + diff;
            }, { passive: true });
            
            galleryContainer.addEventListener('touchend', () => {
                touchStartX = 0;
                touchEndX = 0;
            }, { passive: true });
            
            let currentImageIndex = 0;
            
            imageLinks.forEach((link, index) => {
                const imgWrapper = galleryContainer.createDiv();
                imgWrapper.style.cssText = `
                    min-width: 250px;
                    max-width: 250px;
                    height: 180px;
                    position: relative;
                    border: 2px solid var(--background-modifier-border);
                    border-radius: 8px;
                    padding: 5px;
                    scroll-snap-align: center;
                    scroll-snap-stop: always;
                    flex-shrink: 0;
                    background: var(--background-primary);
                `;
                
                // ì´ë¯¸ì§€ ê²½ë¡œ ì¶”ì¶œ
                const imgPathMatch = link.match(/!\[\[(.+?)(?:\|(\d+))?\]\]/);
                if (imgPathMatch) {
                    let imagePath = imgPathMatch[1];
                    
                    // ì‹¤ì œ íŒŒì¼ ìœ„ì¹˜ í™•ì¸ (ë‘ ê°€ì§€ ê²½ë¡œ ì‹œë„)
                    // 1) HanziQuiz/Questions/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/ (ë…¸íŠ¸ íŒŒì¼ ê¸°ì¤€)
                    // 2) HanziQuiz/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/ (ì„¤ì • ê¸°ì¤€)
                    
                    const parentPath = this.file.parent.path; // "HanziQuiz/Questions/200ë²ˆëŒ€"
                    const quizFolder = this.plugin?.settings?.quizFolder || 'HanziQuiz';
                    
                    let imagePath1, imagePath2;
                    
                    if (imagePath.includes('/')) {
                        // "200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/image.png" í˜•ì‹
                        const parts = imagePath.split('/');
                        const relPath = parts.slice(1).join('/'); // "ì²¨ë¶€íŒŒì¼/image.png"
                        imagePath1 = `${parentPath}/${relPath}`; // HanziQuiz/Questions/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/...
                        imagePath2 = `${quizFolder}/${imagePath}`; // HanziQuiz/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/...
                    } else {
                        // "image.png" í˜•ì‹
                        imagePath1 = `${parentPath}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
                        imagePath2 = `${quizFolder}/${this.file.parent.name}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
                    }
                    
                    // ë‘ ê²½ë¡œ ì¤‘ ì¡´ì¬í•˜ëŠ” íŒŒì¼ ì°¾ê¸°
                    let file = this.app.vault.getAbstractFileByPath(imagePath1);
                    let finalPath = imagePath1;
                    
                    if (!file) {
                        file = this.app.vault.getAbstractFileByPath(imagePath2);
                        finalPath = imagePath2;
                    }
                    
                    console.log(`ğŸ–¼ï¸ [ë…¸íŠ¸ í¸ì§‘ ëª¨ë‹¬ ì´ë¯¸ì§€] ${imgPathMatch[1]} â†’ ${finalPath}`);
                    
                    if (file) {
                        const imgEl = imgWrapper.createEl('img');
                        // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                        imgEl.src = this.app.vault.adapter.getResourcePath(finalPath);
                        imgEl.style.cssText = `
                            width: 100%;
                            height: 150px;
                            object-fit: cover;
                            border-radius: 4px;
                            cursor: pointer;
                        `;
                        
                        // í´ë¦­í•˜ë©´ ì „ì²´í™”ë©´ ë¯¸ë¦¬ë³´ê¸°
                        imgEl.onclick = () => {
                            this.showImagePreview(imageLinks, index);
                        };
                        
                        // ì‚­ì œ ë²„íŠ¼ì„ ì´ë¯¸ì§€ ìœ„ì— ì˜¤ë²„ë ˆì´
                        const deleteBtn = imgWrapper.createEl('button', { text: 'âœ•' });
                        deleteBtn.style.cssText = `
                            position: absolute;
                            top: 8px;
                            right: 8px;
                            width: 28px;
                            height: 28px;
                            padding: 0;
                            background: rgba(0, 0, 0, 0.7);
                            color: white;
                            border: none;
                            border-radius: 50%;
                            cursor: pointer;
                            font-size: 16px;
                            font-weight: bold;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: all 0.2s;
                            z-index: 10;
                        `;
                        deleteBtn.type = 'button';
                        deleteBtn.title = 'ì´ë¯¸ì§€ ì‚­ì œ';
                        
                        deleteBtn.addEventListener('mouseenter', () => {
                            deleteBtn.style.background = 'rgba(255, 0, 0, 0.8)';
                            deleteBtn.style.transform = 'scale(1.1)';
                        });
                        
                        deleteBtn.addEventListener('mouseleave', () => {
                            deleteBtn.style.background = 'rgba(0, 0, 0, 0.7)';
                            deleteBtn.style.transform = 'scale(1)';
                        });
                        
                        deleteBtn.onclick = async (e) => {
                            e.stopPropagation();
                            
                            try {
                                // ë‘ ê°€ì§€ ê²½ë¡œ ì‹œë„
                                let imagePath = imgPathMatch[1];
                                const parentPath = this.file.parent.path;
                                const quizFolder = this.plugin?.settings?.quizFolder || 'HanziQuiz';
                                
                                let imagePath1, imagePath2;
                                
                                if (imagePath.includes('/')) {
                                    const parts = imagePath.split('/');
                                    const relPath = parts.slice(1).join('/');
                                    imagePath1 = `${parentPath}/${relPath}`;
                                    imagePath2 = `${quizFolder}/${imagePath}`;
                                } else {
                                    imagePath1 = `${parentPath}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
                                    imagePath2 = `${quizFolder}/${this.file.parent.name}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
                                }
                                
                                let imageFile = this.app.vault.getAbstractFileByPath(imagePath1);
                                let finalPath = imagePath1;
                                
                                if (!imageFile) {
                                    imageFile = this.app.vault.getAbstractFileByPath(imagePath2);
                                    finalPath = imagePath2;
                                }
                                
                                if (imageFile) {
                                    await this.app.vault.delete(imageFile);
                                    console.log(`ğŸ—‘ï¸ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ: ${finalPath}`);
                                } else {
                                    console.warn(`âš ï¸ ì‚­ì œí•  íŒŒì¼ ì—†ìŒ - ê²½ë¡œ1: ${imagePath1}, ê²½ë¡œ2: ${imagePath2}`);
                                }
                                
                                // frontmatterì—ì„œ ë§í¬ ì œê±°
                                imageLinks.splice(index, 1);
                                
                                // 1. frontmatter ì—…ë°ì´íŠ¸
                                await this.app.fileManager.processFrontMatter(this.file, (frontmatter) => {
                                    frontmatter.note = imageLinks.join('\n');
                                });
                                
                                // 2. ë³¸ë¬¸ì˜ "## ë…¸íŠ¸ ì´ë¯¸ì§€" ì„¹ì…˜ë„ ì—…ë°ì´íŠ¸
                                const content = await this.app.vault.read(this.file);
                                const newImageValue = imageLinks.join('\n');
                                const noteImageRegex = /(## ë…¸íŠ¸ ì´ë¯¸ì§€\n)([\s\S]*?)(?=\n## |$)/;
                                
                                let updatedContent = content;
                                if (updatedContent.match(noteImageRegex)) {
                                    if (imageLinks.length > 0) {
                                        updatedContent = updatedContent.replace(
                                            noteImageRegex,
                                            `$1${newImageValue}\n\n`
                                        );
                                    } else {
                                        // ëª¨ë“  ì´ë¯¸ì§€ ì‚­ì œ ì‹œ ì„¹ì…˜ ë¹„ìš°ê¸°
                                        updatedContent = updatedContent.replace(
                                            noteImageRegex,
                                            `$1\n`
                                        );
                                    }
                                    await this.app.vault.modify(this.file, updatedContent);
                                }
                                
                                console.log(`âœ… frontmatter & ë³¸ë¬¸ ë™ê¸°í™” ì™„ë£Œ (${imageLinks.length}ê°œ ì´ë¯¸ì§€)`);
                                
                                // ê°¤ëŸ¬ë¦¬ì—ì„œ ì¦‰ì‹œ ì œê±°
                                imgWrapper.remove();
                                
                                // ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì‚­ì œë˜ë©´ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
                                if (imageLinks.length === 0) {
                                    existingImagesDiv.empty();
                                    existingImagesDiv.createEl('p', {
                                        text: 'í˜„ì¬ ì €ì¥ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.',
                                        attr: { style: 'color: var(--text-muted); text-align: center; padding: 20px;' }
                                    });
                                } else {
                                    const countDiv = existingImagesDiv.querySelector('div:last-child');
                                    if (countDiv && countDiv.textContent.includes('ì´')) {
                                        countDiv.textContent = `ì´ ${imageLinks.length}ê°œì˜ ì´ë¯¸ì§€`;
                                    }
                                }
                            } catch (err) {
                                console.error('âŒ ì´ë¯¸ì§€ ì‚­ì œ ì˜¤ë¥˜:', err);
                                new Notice('ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
                            }
                        };
                        
                        console.log(`âœ… [ë…¸íŠ¸ í¸ì§‘ ëª¨ë‹¬ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ] ${finalPath}`);
                    } else {
                        console.warn(`âŒ [ë…¸íŠ¸ í¸ì§‘ ëª¨ë‹¬ ì´ë¯¸ì§€ ì—†ìŒ] ê²½ë¡œ1: ${imagePath1}, ê²½ë¡œ2: ${imagePath2}`);
                        imgWrapper.createEl('p', { 
                            text: 'âš ï¸ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
                            attr: { style: 'color: var(--text-muted); text-align: center; padding: 20px;' }
                        });
                    }
                }
            });
            
            // ì´ë¯¸ì§€ ê°œìˆ˜ í‘œì‹œ
            if (imageLinks.length > 0) {
                const countDiv = existingImagesDiv.createEl('div');
                countDiv.textContent = `ì´ ${imageLinks.length}ê°œì˜ ì´ë¯¸ì§€`;
                countDiv.style.cssText = 'text-align: center; color: var(--text-muted); font-size: 12px; margin-top: 5px;';
            }
        }
        
        // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜ì—­
        const previewArea = imageSection.createDiv();
        previewArea.style.cssText = 'margin: 12px 0; min-height: 100px; border: 2px dashed var(--background-modifier-border); border-radius: 8px; padding: 12px; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: center; background: var(--background-primary);';
        
        let selectedFiles = [];
        
        const updatePreview = () => {
            previewArea.empty();
            if (selectedFiles.length === 0) {
                const placeholder = previewArea.createEl('div');
                placeholder.textContent = 'ì´ë¯¸ì§€ ì„ íƒ ë˜ëŠ” ë¶™ì—¬ë„£ê¸°';
                placeholder.style.cssText = 'color: var(--text-muted); font-size: 14px;';
            } else {
                selectedFiles.forEach((file, index) => {
                    const imgWrapper = previewArea.createDiv();
                    imgWrapper.style.cssText = 'position: relative; display: inline-block;';
                    
                    const img = imgWrapper.createEl('img');
                    img.src = URL.createObjectURL(file);
                    img.style.cssText = 'max-width: 150px; max-height: 150px; border-radius: 6px; object-fit: cover; cursor: pointer;';
                    
                    // í´ë¦­ ì‹œ ì „ì²´í™”ë©´ ë¯¸ë¦¬ë³´ê¸°
                    img.onclick = () => {
                        this.showNewImagePreview(selectedFiles, index);
                    };
                    
                    const deleteBtn = imgWrapper.createEl('button', { text: 'âœ•' });
                    deleteBtn.style.cssText = `
                        position: absolute;
                        top: 4px;
                        right: 4px;
                        background: rgba(0,0,0,0.7);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 24px;
                        height: 24px;
                        cursor: pointer;
                        font-size: 16px;
                        line-height: 1;
                    `;
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        selectedFiles.splice(index, 1);
                        updatePreview();
                    };
                });
                
                const fileCountText = previewArea.createEl('div');
                fileCountText.textContent = `${selectedFiles.length}ê°œ ì„ íƒë¨`;
                fileCountText.style.cssText = 'color: var(--text-accent); font-weight: bold; width: 100%; text-align: center; margin-top: 8px;';
            }
        };
        
        updatePreview();
        
        // íŒŒì¼ ì„ íƒ ë²„íŠ¼ (ìˆ¨ê¹€)
        const fileInput = imageSection.createEl('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*';
        fileInput.multiple = true;
        fileInput.style.display = 'none';
        fileInput.onchange = () => {
            if (fileInput.files) {
                selectedFiles = [...selectedFiles, ...Array.from(fileInput.files)];
                updatePreview();
            }
        };
        
        // ì´ë¯¸ì§€ ì¶”ê°€ ë²„íŠ¼ (ëª¨ë°”ì¼ ì¹œí™”ì )
        const addImageBtn = imageSection.createEl('button', { text: 'ğŸ“ ì´ë¯¸ì§€ ì¶”ê°€' });
        addImageBtn.style.cssText = `
            width: 100%;
            padding: 14px;
            background: var(--interactive-accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 12px;
            touch-action: manipulation;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        `;
        addImageBtn.type = 'button';
        addImageBtn.onclick = () => {
            fileInput.click();
        };
        
        // í„°ì¹˜ í”¼ë“œë°±
        addImageBtn.addEventListener('touchstart', () => {
            addImageBtn.style.opacity = '0.7';
        });
        addImageBtn.addEventListener('touchend', () => {
            addImageBtn.style.opacity = '1';
        });
        addImageBtn.addEventListener('touchcancel', () => {
            addImageBtn.style.opacity = '1';
        });
        
        // ë¶™ì—¬ë„£ê¸° ì´ë²¤íŠ¸ (ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ)
        const pasteHandler = async (e) => {
            // ëª¨ë‹¬ì´ ë‹«í˜”ìœ¼ë©´ ë¦¬ìŠ¤ë„ˆ ì œê±°
            if (!document.body.contains(contentEl)) {
                document.removeEventListener('paste', pasteHandler);
                return;
            }
            
            const items = e.clipboardData?.items;
            if (!items) return;
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                if (item.type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = item.getAsFile();
                    if (blob) {
                        selectedFiles.push(blob);
                        updatePreview();
                        new Notice('ğŸ“‹ ì´ë¯¸ì§€ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤ (Ctrl+V)');
                        console.log('âœ… í´ë¦½ë³´ë“œ ì´ë¯¸ì§€ ì¶”ê°€:', blob.name);
                    }
                }
            }
        };
        document.addEventListener('paste', pasteHandler);
        
        // ì´ë¯¸ì§€ í¬ê¸° ì…ë ¥
        const sizeContainer = imageSection.createDiv();
        sizeContainer.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 12px;';
        
        const sizeLabel = sizeContainer.createEl('label');
        sizeLabel.textContent = 'ì´ë¯¸ì§€ í¬ê¸°:';
        sizeLabel.style.cssText = 'font-weight: 500;';
        
        const sizeInput = sizeContainer.createEl('input');
        sizeInput.type = 'number';
        sizeInput.value = '400';
        sizeInput.placeholder = '400';
        sizeInput.style.cssText = 'width: 80px; padding: 6px; border-radius: 4px; border: 1px solid var(--background-modifier-border);';
        
        const sizeUnit = sizeContainer.createEl('span');
        sizeUnit.textContent = 'px';
        
        const autoSizeCheckbox = sizeContainer.createEl('input');
        autoSizeCheckbox.type = 'checkbox';
        autoSizeCheckbox.style.cssText = 'margin-left: 12px;';
        
        const autoSizeLabel = sizeContainer.createEl('label');
        autoSizeLabel.textContent = 'í¬ê¸° ì§€ì • ì•ˆí•¨';
        autoSizeLabel.style.cssText = 'cursor: pointer;';
        
        autoSizeCheckbox.onchange = () => {
            sizeInput.disabled = autoSizeCheckbox.checked;
        };
        
        // í•˜ë‹¨ ë²„íŠ¼ - í…ìŠ¤íŠ¸ì™€ ì´ë¯¸ì§€ ì €ì¥ ë¶„ë¦¬
        const buttonContainer = contentEl.createDiv();
        buttonContainer.style.cssText = 'margin-top: 20px; display: flex; gap: 12px; justify-content: space-between; flex-wrap: wrap; padding: 15px; background: var(--background-secondary); border-radius: 8px;';
        
        // ì™¼ìª½: í…ìŠ¤íŠ¸ ë…¸íŠ¸ ì €ì¥
        const textButtonGroup = buttonContainer.createDiv();
        textButtonGroup.style.cssText = 'display: flex; gap: 10px;';
        
        const saveTextBtn = textButtonGroup.createEl('button', { text: 'ğŸ“ í…ìŠ¤íŠ¸ ë…¸íŠ¸ ì €ì¥' });
        saveTextBtn.style.cssText = 'background: var(--interactive-accent); color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none;';
        saveTextBtn.onclick = async () => {
            try {
                // í…ìŠ¤íŠ¸ ë…¸íŠ¸ë§Œ ì €ì¥
                const newNoteValue = textarea.value.trim();
                let updatedContent = await this.app.vault.read(this.file);
                
                const noteSectionRegex = /(## ë…¸íŠ¸\n)([\s\S]*?)(?=\n## |$)/;
                
                if (updatedContent.match(noteSectionRegex)) {
                    updatedContent = updatedContent.replace(
                        noteSectionRegex,
                        `$1${newNoteValue}\n\n`
                    );
                } else {
                    const difficultyIndex = updatedContent.indexOf('## ë‚œì´ë„');
                    if (difficultyIndex > -1) {
                        updatedContent = 
                            updatedContent.substring(0, difficultyIndex) +
                            `## ë…¸íŠ¸\n${newNoteValue}\n\n` +
                            updatedContent.substring(difficultyIndex);
                    } else {
                        updatedContent += `\n\n## ë…¸íŠ¸\n${newNoteValue}\n`;
                    }
                }
                
                await this.app.vault.modify(this.file, updatedContent);
                new Notice('âœ… í…ìŠ¤íŠ¸ ë…¸íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                
                // CustomEvent ë°œìƒí•˜ì—¬ í€´ì¦ˆ í™”ë©´ ì—…ë°ì´íŠ¸
                window.dispatchEvent(new CustomEvent('quiz-question-updated', {
                    detail: { questionPath: this.file.path }
                }));
                
                // onSave ì½œë°± í˜¸ì¶œ (í€´ì¦ˆ í™”ë©´ ìƒˆë¡œê³ ì¹¨)
                if (this.onSave) {
                    await this.onSave();
                }
                
                console.log('âœ… í…ìŠ¤íŠ¸ ë…¸íŠ¸ ì €ì¥ ì™„ë£Œ');
            } catch (err) {
                console.error('âŒ í…ìŠ¤íŠ¸ ë…¸íŠ¸ ì €ì¥ ì˜¤ë¥˜:', err);
                new Notice('í…ìŠ¤íŠ¸ ë…¸íŠ¸ ì €ì¥ ì‹¤íŒ¨: ' + err.message);
            }
        };
        
        // ì˜¤ë¥¸ìª½: ì´ë¯¸ì§€ ì €ì¥
        const imageButtonGroup = buttonContainer.createDiv();
        imageButtonGroup.style.cssText = 'display: flex; gap: 10px;';
        
        const saveImageBtn = imageButtonGroup.createEl('button', { text: 'ğŸ–¼ï¸ ì´ë¯¸ì§€ ì €ì¥' });
        saveImageBtn.style.cssText = 'background: #4CAF50; color: white; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none;';
        saveImageBtn.onclick = async () => {
            try {
                // ìƒˆ ì´ë¯¸ì§€ ì—…ë¡œë“œ ë° ë§í¬ ìƒì„±
                let newImageLinks = [];
                
                if (selectedFiles.length > 0) {
                    // ê¸°ì¡´ ì´ë¯¸ì§€ê°€ ìˆëŠ” ìœ„ì¹˜ í™•ì¸
                    // ê²½ë¡œ1: HanziQuiz/Questions/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼ (ë…¸íŠ¸ íŒŒì¼ ê¸°ì¤€)
                    // ê²½ë¡œ2: HanziQuiz/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼ (ì„¤ì • ê¸°ì¤€)
                    const parentPath = this.file.parent.path; // "HanziQuiz/Questions/200ë²ˆëŒ€"
                    const quizFolder = this.plugin?.settings?.quizFolder || 'HanziQuiz';
                    const folderName = this.file.parent.name; // "200ë²ˆëŒ€"
                    
                    const path1 = `${parentPath}/ì²¨ë¶€íŒŒì¼`;
                    const path2 = `${quizFolder}/${folderName}/ì²¨ë¶€íŒŒì¼`;
                    
                    // ê¸°ì¡´ ì´ë¯¸ì§€ ìœ„ì¹˜ í™•ì¸
                    let attachmentFolderPath = path2; // ê¸°ë³¸ê°’: HanziQuiz/200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼
                    
                    if (imageLinks.length > 0) {
                        // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ì˜ ì‹¤ì œ ìœ„ì¹˜ í™•ì¸
                        const firstImgMatch = imageLinks[0].match(/!\[\[(.+?)(?:\|(\d+))?\]\]/);
                        if (firstImgMatch) {
                            let testPath = firstImgMatch[1];
                            if (testPath.includes('/')) {
                                const parts = testPath.split('/');
                                const relPath = parts.slice(1).join('/');
                                const testPath1 = `${parentPath}/${relPath}`;
                                const testPath2 = `${quizFolder}/${testPath}`;
                                
                                // ì–´ëŠ ê²½ë¡œì— íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
                                if (this.app.vault.getAbstractFileByPath(testPath1)) {
                                    attachmentFolderPath = path1; // Questions í´ë” ì‚¬ìš©
                                    console.log(`ğŸ“ ê¸°ì¡´ ì´ë¯¸ì§€ ìœ„ì¹˜: ${path1}`);
                                } else if (this.app.vault.getAbstractFileByPath(testPath2)) {
                                    attachmentFolderPath = path2; // ì„¤ì • í´ë” ì‚¬ìš©
                                    console.log(`ğŸ“ ê¸°ì¡´ ì´ë¯¸ì§€ ìœ„ì¹˜: ${path2}`);
                                }
                            }
                        }
                    }
                    
                    // ì²¨ë¶€íŒŒì¼ í´ë” ìƒì„± (ì—†ìœ¼ë©´)
                    const folder = this.app.vault.getAbstractFileByPath(attachmentFolderPath);
                    if (!folder) {
                        await this.app.vault.createFolder(attachmentFolderPath);
                        console.log(`ğŸ“ í´ë” ìƒì„±: ${attachmentFolderPath}`);
                    }
                    
                    const imageSize = autoSizeCheckbox.checked ? '' : sizeInput.value;
                    
                    for (const file of selectedFiles) {
                        const arrayBuffer = await file.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        const timestamp = Date.now();
                        const ext = file.name.split('.').pop();
                        const imageName = `image-${timestamp}.${ext}`;
                        const absoluteImagePath = `${attachmentFolderPath}/${imageName}`;
                        
                        console.log(`ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥: ${absoluteImagePath}`);
                        await this.app.vault.createBinary(absoluteImagePath, uint8Array);
                        
                        // ìƒëŒ€ ê²½ë¡œë¡œ ë§í¬ ìƒì„± (ì˜ˆ: 200ë²ˆëŒ€/ì²¨ë¶€íŒŒì¼/image-xxx.png)
                        const relativeImagePath = `${folderName}/ì²¨ë¶€íŒŒì¼/${imageName}`;
                        
                        if (imageSize) {
                            newImageLinks.push(`![[${relativeImagePath}|${imageSize}]]`);
                        } else {
                            newImageLinks.push(`![[${relativeImagePath}]]`);
                        }
                        
                        console.log(`âœ… ì´ë¯¸ì§€ ë§í¬ ìƒì„±: ![[${relativeImagePath}]]`);
                        
                        await new Promise(resolve => setTimeout(resolve, 10));
                    }
                }
                
                // ## ë…¸íŠ¸ ì´ë¯¸ì§€ ì„¹ì…˜ë§Œ ì—…ë°ì´íŠ¸
                if (newImageLinks.length > 0) {
                    // ê¸°ì¡´ ì´ë¯¸ì§€ + ìƒˆ ì´ë¯¸ì§€
                    const allImages = [...imageLinks, ...newImageLinks];
                    const newImageValue = allImages.join('\n');
                    
                    // 1. ë³¸ë¬¸ ì—…ë°ì´íŠ¸
                    let updatedContent = await this.app.vault.read(this.file);
                    const noteImageRegex = /(## ë…¸íŠ¸ ì´ë¯¸ì§€\n)([\s\S]*?)(?=\n## |$)/;
                    
                    if (updatedContent.match(noteImageRegex)) {
                        updatedContent = updatedContent.replace(
                            noteImageRegex,
                            `$1${newImageValue}\n\n`
                        );
                    } else {
                        const statsIndex = updatedContent.indexOf('## í†µê³„');
                        if (statsIndex > -1) {
                            updatedContent = 
                                updatedContent.substring(0, statsIndex) +
                                `## ë…¸íŠ¸ ì´ë¯¸ì§€\n${newImageValue}\n\n` +
                                updatedContent.substring(statsIndex);
                        } else {
                            updatedContent += `\n\n## ë…¸íŠ¸ ì´ë¯¸ì§€\n${newImageValue}\n`;
                        }
                    }
                    
                    await this.app.vault.modify(this.file, updatedContent);
                    
                    // 2. frontmatterë„ ì—…ë°ì´íŠ¸
                    await this.app.fileManager.processFrontMatter(this.file, (frontmatter) => {
                        frontmatter.note = newImageValue;
                    });
                    
                    console.log(`âœ… ì´ë¯¸ì§€ ì €ì¥ ì™„ë£Œ: ${allImages.length}ê°œ ì´ë¯¸ì§€`);
                    new Notice(`âœ… ${newImageLinks.length}ê°œì˜ ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤`);
                    
                    // CustomEvent ë°œìƒí•˜ì—¬ í€´ì¦ˆ í™”ë©´ ì—…ë°ì´íŠ¸
                    window.dispatchEvent(new CustomEvent('quiz-question-updated', {
                        detail: { questionPath: this.file.path }
                    }));
                    
                    // onSave ì½œë°± í˜¸ì¶œ (í€´ì¦ˆ í™”ë©´ ìƒˆë¡œê³ ì¹¨)
                    if (this.onSave) {
                        await this.onSave();
                    }
                    
                    // ì„ íƒëœ íŒŒì¼ ì´ˆê¸°í™” ë° ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                    selectedFiles = [];
                    updatePreview();
                    
                    // ê¸°ì¡´ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ ìƒˆë¡œê³ ì¹¨
                    imageLinks = allImages;
                    if (galleryContainer) {
                        // ê°¤ëŸ¬ë¦¬ ë‹¤ì‹œ ë Œë”ë§
                        const galleryParent = galleryContainer.parentElement;
                        if (galleryParent) {
                            const newGalleryContainer = galleryParent.createDiv();
                            newGalleryContainer.style.cssText = galleryContainer.style.cssText;
                            
                            imageLinks.forEach((link, index) => {
                                const imgWrapper = newGalleryContainer.createDiv();
                                imgWrapper.style.cssText = `
                                    min-width: 250px;
                                    max-width: 250px;
                                    height: 180px;
                                    position: relative;
                                    border: 2px solid var(--background-modifier-border);
                                    border-radius: 8px;
                                    padding: 5px;
                                    scroll-snap-align: center;
                                    scroll-snap-stop: always;
                                    flex-shrink: 0;
                                    background: var(--background-primary);
                                `;
                                
                                const imgPathMatch = link.match(/!\[\[(.+?)(?:\|(\d+))?\]\]/);
                                if (imgPathMatch) {
                                    let imagePath = imgPathMatch[1];
                                    
                                    const parentPath = this.file.parent.path;
                                    const quizFolder = this.plugin?.settings?.quizFolder || 'HanziQuiz';
                                    
                                    let imagePath1, imagePath2;
                                    
                                    if (imagePath.includes('/')) {
                                        const parts = imagePath.split('/');
                                        const relPath = parts.slice(1).join('/');
                                        imagePath1 = `${parentPath}/${relPath}`;
                                        imagePath2 = `${quizFolder}/${imagePath}`;
                                    } else {
                                        imagePath1 = `${parentPath}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
                                        imagePath2 = `${quizFolder}/${this.file.parent.name}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
                                    }
                                    
                                    let imageFile = this.app.vault.getAbstractFileByPath(imagePath1);
                                    let finalPath = imagePath1;
                                    
                                    if (!imageFile) {
                                        imageFile = this.app.vault.getAbstractFileByPath(imagePath2);
                                        finalPath = imagePath2;
                                    }
                                    
                                    if (imageFile) {
                                        const img = imgWrapper.createEl('img');
                                        // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                                        img.src = this.app.vault.adapter.getResourcePath(finalPath);
                                        img.style.cssText = 'width: 100%; height: 100%; object-fit: contain; border-radius: 6px; cursor: pointer;';
                                        img.onclick = () => this.showImagePreview(imageLinks, index);
                                        
                                        const deleteBtn = imgWrapper.createEl('button', { text: 'ğŸ—‘ï¸' });
                                        deleteBtn.style.cssText = `
                                            position: absolute;
                                            top: 8px;
                                            right: 8px;
                                            background: rgba(255, 0, 0, 0.8);
                                            color: white;
                                            border: none;
                                            border-radius: 50%;
                                            width: 32px;
                                            height: 32px;
                                            cursor: pointer;
                                            font-size: 16px;
                                        `;
                                        deleteBtn.onclick = async (e) => {
                                            e.stopPropagation();
                                            if (!confirm(`ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n${imagePath}`)) return;
                                            
                                            try {
                                                imageLinks.splice(index, 1);
                                                
                                                await this.app.fileManager.processFrontMatter(this.file, (frontmatter) => {
                                                    frontmatter.note = imageLinks.join('\n');
                                                });
                                                
                                                const content = await this.app.vault.read(this.file);
                                                const newImageValue = imageLinks.join('\n');
                                                const noteImageRegex = /(## ë…¸íŠ¸ ì´ë¯¸ì§€\n)([\s\S]*?)(?=\n## |$)/;
                                                
                                                let updatedContent = content;
                                                if (updatedContent.match(noteImageRegex)) {
                                                    if (imageLinks.length > 0) {
                                                        updatedContent = updatedContent.replace(
                                                            noteImageRegex,
                                                            `$1${newImageValue}\n\n`
                                                        );
                                                    } else {
                                                        updatedContent = updatedContent.replace(
                                                            noteImageRegex,
                                                            `$1\n`
                                                        );
                                                    }
                                                    await this.app.vault.modify(this.file, updatedContent);
                                                }
                                                
                                                imgWrapper.remove();
                                                new Notice('âœ… ì´ë¯¸ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                                            } catch (err) {
                                                console.error('âŒ ì´ë¯¸ì§€ ì‚­ì œ ì˜¤ë¥˜:', err);
                                                new Notice('ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: ' + err.message);
                                            }
                                        };
                                    }
                                }
                            });
                            
                            galleryContainer.replaceWith(newGalleryContainer);
                            galleryContainer = newGalleryContainer;
                        }
                    }
                } else {
                    new Notice('âš ï¸ ì¶”ê°€í•  ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');
                }
            } catch (error) {
                console.error('âŒ [ì´ë¯¸ì§€ ì €ì¥ ì˜¤ë¥˜]', error);
                new Notice('âŒ ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: ' + error.message);
            }
        };
        
        const cancelBtn = imageButtonGroup.createEl('button', { text: 'âŒ ë‹«ê¸°' });
        cancelBtn.style.cssText = 'background: var(--background-modifier-border); padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; border: none;';
        cancelBtn.onclick = () => this.close();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }

    // ì´ë¯¸ì§€ ì „ì²´í™”ë©´ ë¯¸ë¦¬ë³´ê¸° ë©”ì„œë“œ
    showImagePreview(imageLinks, startIndex) {
        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.body.createDiv();
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        `;

        let currentIndex = startIndex;

        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = overlay.createEl('button', { text: 'âœ•' });
        closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10001;
            transition: background 0.2s;
        `;
        closeBtn.onmouseover = () => {
            closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
        };
        closeBtn.onmouseout = () => {
            closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        };
        closeBtn.onclick = () => overlay.remove();

        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ
        const imgContainer = overlay.createDiv();
        imgContainer.style.cssText = `
            position: relative;
            max-width: 90vw;
            max-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        // ì´ë¯¸ì§€ ì—˜ë¦¬ë¨¼íŠ¸
        const imgEl = imgContainer.createEl('img');
        imgEl.style.cssText = `
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            user-select: none;
            transform-origin: center;
            transition: transform 0.2s;
        `;
        
        // í™•ëŒ€/ì¶•ì†Œ ë³€ìˆ˜
        let scale = 1;
        let posX = 0;
        let posY = 0;
        
        // í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤
        const zoomControls = overlay.createDiv();
        zoomControls.style.cssText = `
            position: absolute;
            top: 100px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10001;
        `;
        
        const createZoomButton = (text, title) => {
            const btn = zoomControls.createEl('button', { text });
            btn.title = title;
            btn.type = 'button';
            btn.style.cssText = `
                width: 50px;
                height: 50px;
                font-size: 24px;
                color: white;
                background: rgba(0, 0, 0, 0.5);
                border: 2px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s;
            `;
            btn.addEventListener('mouseenter', () => {
                btn.style.background = 'rgba(255, 255, 255, 0.2)';
                btn.style.transform = 'scale(1.1)';
            });
            btn.addEventListener('mouseleave', () => {
                btn.style.background = 'rgba(0, 0, 0, 0.5)';
                btn.style.transform = 'scale(1)';
            });
            return btn;
        };
        
        const zoomInBtn = createZoomButton('+', 'í™•ëŒ€');
        const zoomOutBtn = createZoomButton('âˆ’', 'ì¶•ì†Œ');
        const resetBtn = createZoomButton('âŸ²', 'ì›ë˜ í¬ê¸°');
        
        zoomInBtn.onclick = (e) => {
            e.stopPropagation();
            scale = Math.min(4, scale * 1.2);
            imgEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        };
        
        zoomOutBtn.onclick = (e) => {
            e.stopPropagation();
            scale = Math.max(1, scale * 0.8);
            if (scale === 1) {
                posX = 0;
                posY = 0;
            }
            imgEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        };
        
        resetBtn.onclick = (e) => {
            e.stopPropagation();
            scale = 1;
            posX = 0;
            posY = 0;
            imgEl.style.transform = `translate(0px, 0px) scale(1)`;
        };
        
        // ë§ˆìš°ìŠ¤ íœ  ì¤Œ
        imgContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            scale = Math.max(1, Math.min(4, scale * delta));
            imgEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        });
        
        // ë“œë˜ê·¸ë¡œ ì´ë™
        let isDragging = false;
        let startX, startY;
        
        imgEl.addEventListener('mousedown', (e) => {
            if (scale > 1) {
                isDragging = true;
                startX = e.clientX - posX;
                startY = e.clientY - posY;
                imgEl.style.cursor = 'grabbing';
            }
        });
        
        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                posX = e.clientX - startX;
                posY = e.clientY - startY;
                imgEl.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                imgEl.style.cursor = 'pointer';
            }
        });

        // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updateImage = async (index) => {
            const link = imageLinks[index];
            const pathMatch = link.match(/!\[\[(.+?)(?:\|(\d+))?\]\]/);
            if (!pathMatch) return;

            let imagePath = pathMatch[1];
            
            // ë‘ ê°€ì§€ ê²½ë¡œ ì‹œë„
            const parentPath = this.file.parent.path;
            const quizFolder = this.plugin?.settings?.quizFolder || 'HanziQuiz';
            
            let imagePath1, imagePath2;
            
            if (imagePath.includes('/')) {
                const parts = imagePath.split('/');
                const relPath = parts.slice(1).join('/');
                imagePath1 = `${parentPath}/${relPath}`;
                imagePath2 = `${quizFolder}/${imagePath}`;
            } else {
                imagePath1 = `${parentPath}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
                imagePath2 = `${quizFolder}/${this.file.parent.name}/ì²¨ë¶€íŒŒì¼/${imagePath}`;
            }
            
            let imageFile = this.app.vault.getAbstractFileByPath(imagePath1);
            let finalPath = imagePath1;
            
            if (!imageFile) {
                imageFile = this.app.vault.getAbstractFileByPath(imagePath2);
                finalPath = imagePath2;
            }
            
            console.log(`ğŸ–¼ï¸ [ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ê²½ë¡œ] ${pathMatch[1]} â†’ ${finalPath}`);

            if (imageFile) {
                // ëª¨ë°”ì¼ í˜¸í™˜: adapter.getResourcePath ì‚¬ìš©
                imgEl.src = this.app.vault.adapter.getResourcePath(finalPath);
                console.log(`âœ… [ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ë¡œë“œ] ${imagePath}`);
            } else {
                console.warn(`âŒ [ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ ì—†ìŒ] ${imagePath}`);
            }

            // ì¹´ìš´í„° ì—…ë°ì´íŠ¸
            counter.textContent = `${index + 1} / ${imageLinks.length}`;
        };

        // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ (ì´ë¯¸ì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ)
        if (imageLinks.length > 1) {
            const prevBtn = overlay.createEl('button', { text: 'â€¹' });
            prevBtn.style.cssText = `
                position: absolute;
                left: 20px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 48px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                cursor: pointer;
                z-index: 10001;
                transition: background 0.2s;
            `;
            prevBtn.onmouseover = () => {
                prevBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            };
            prevBtn.onmouseout = () => {
                prevBtn.style.background = 'rgba(255, 255, 255, 0.2)';
            };
            prevBtn.onclick = () => {
                currentIndex = (currentIndex - 1 + imageLinks.length) % imageLinks.length;
                updateImage(currentIndex);
            };

            const nextBtn = overlay.createEl('button', { text: 'â€º' });
            nextBtn.style.cssText = `
                position: absolute;
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 48px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                cursor: pointer;
                z-index: 10001;
                transition: background 0.2s;
            `;
            nextBtn.onmouseover = () => {
                nextBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            };
            nextBtn.onmouseout = () => {
                nextBtn.style.background = 'rgba(255, 255, 255, 0.2)';
            };
            nextBtn.onclick = () => {
                currentIndex = (currentIndex + 1) % imageLinks.length;
                updateImage(currentIndex);
            };

            // ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì§€ì›
            let touchStartX = 0;
            let touchEndX = 0;

            imgContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            imgContainer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            const handleSwipe = () => {
                const swipeThreshold = 50;
                if (touchStartX - touchEndX > swipeThreshold) {
                    // ì™¼ìª½ ìŠ¤ì™€ì´í”„ - ë‹¤ìŒ ì´ë¯¸ì§€
                    currentIndex = (currentIndex + 1) % imageLinks.length;
                    updateImage(currentIndex);
                } else if (touchEndX - touchStartX > swipeThreshold) {
                    // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ - ì´ì „ ì´ë¯¸ì§€
                    currentIndex = (currentIndex - 1 + imageLinks.length) % imageLinks.length;
                    updateImage(currentIndex);
                }
            };
        }

        // ì´ë¯¸ì§€ ì¹´ìš´í„°
        const counter = overlay.createEl('div');
        counter.style.cssText = `
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        `;

        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                overlay.remove();
            }
        };

        // ESC í‚¤ë¡œ ë‹«ê¸°
        const handleKeyDown = (e) => {
            if (e.key === 'Escape') {
                overlay.remove();
                document.removeEventListener('keydown', handleKeyDown);
            } else if (imageLinks.length > 1) {
                if (e.key === 'ArrowLeft') {
                    currentIndex = (currentIndex - 1 + imageLinks.length) % imageLinks.length;
                    updateImage(currentIndex);
                } else if (e.key === 'ArrowRight') {
                    currentIndex = (currentIndex + 1) % imageLinks.length;
                    updateImage(currentIndex);
                }
            }
        };
        document.addEventListener('keydown', handleKeyDown);

        // ì´ˆê¸° ì´ë¯¸ì§€ ë¡œë“œ
        updateImage(currentIndex);
    }

    // ìƒˆë¡œ ì„ íƒí•œ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° (File ê°ì²´ìš©)
    showNewImagePreview(fileArray, startIndex) {
        // ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ ìƒì„±
        const overlay = document.body.createDiv();
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        `;

        let currentIndex = startIndex;

        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = overlay.createEl('button', { text: 'âœ•' });
        closeBtn.style.cssText = `
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10001;
            transition: background 0.2s;
        `;
        closeBtn.onmouseover = () => {
            closeBtn.style.background = 'rgba(255, 255, 255, 0.3)';
        };
        closeBtn.onmouseout = () => {
            closeBtn.style.background = 'rgba(255, 255, 255, 0.2)';
        };
        closeBtn.onclick = () => {
            // URL ê°ì²´ ì •ë¦¬
            fileArray.forEach(file => {
                if (imgEl.src) URL.revokeObjectURL(imgEl.src);
            });
            overlay.remove();
        };

        // ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆ
        const imgContainer = overlay.createDiv();
        imgContainer.style.cssText = `
            position: relative;
            max-width: 90vw;
            max-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        `;

        // ì´ë¯¸ì§€ ì—˜ë¦¬ë¨¼íŠ¸
        const imgEl = imgContainer.createEl('img');
        imgEl.style.cssText = `
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
            user-select: none;
        `;

        // ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updateImage = (index) => {
            const file = fileArray[index];
            imgEl.src = URL.createObjectURL(file);
            counter.textContent = `${index + 1} / ${fileArray.length}`;
        };

        // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ (ì´ë¯¸ì§€ê°€ 2ê°œ ì´ìƒì¼ ë•Œë§Œ)
        if (fileArray.length > 1) {
            const prevBtn = overlay.createEl('button', { text: 'â€¹' });
            prevBtn.style.cssText = `
                position: absolute;
                left: 20px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 48px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                cursor: pointer;
                z-index: 10001;
                transition: background 0.2s;
            `;
            prevBtn.onmouseover = () => {
                prevBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            };
            prevBtn.onmouseout = () => {
                prevBtn.style.background = 'rgba(255, 255, 255, 0.2)';
            };
            prevBtn.onclick = () => {
                currentIndex = (currentIndex - 1 + fileArray.length) % fileArray.length;
                updateImage(currentIndex);
            };

            const nextBtn = overlay.createEl('button', { text: 'â€º' });
            nextBtn.style.cssText = `
                position: absolute;
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.2);
                border: none;
                color: white;
                font-size: 48px;
                width: 60px;
                height: 60px;
                border-radius: 50%;
                cursor: pointer;
                z-index: 10001;
                transition: background 0.2s;
            `;
            nextBtn.onmouseover = () => {
                nextBtn.style.background = 'rgba(255, 255, 255, 0.3)';
            };
            nextBtn.onmouseout = () => {
                nextBtn.style.background = 'rgba(255, 255, 255, 0.2)';
            };
            nextBtn.onclick = () => {
                currentIndex = (currentIndex + 1) % fileArray.length;
                updateImage(currentIndex);
            };

            // ëª¨ë°”ì¼ ìŠ¤ì™€ì´í”„ ì§€ì›
            let touchStartX = 0;
            let touchEndX = 0;

            imgContainer.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
            });

            imgContainer.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            });

            const handleSwipe = () => {
                const swipeThreshold = 50;
                if (touchStartX - touchEndX > swipeThreshold) {
                    // ì™¼ìª½ ìŠ¤ì™€ì´í”„ - ë‹¤ìŒ ì´ë¯¸ì§€
                    currentIndex = (currentIndex + 1) % fileArray.length;
                    updateImage(currentIndex);
                } else if (touchEndX - touchStartX > swipeThreshold) {
                    // ì˜¤ë¥¸ìª½ ìŠ¤ì™€ì´í”„ - ì´ì „ ì´ë¯¸ì§€
                    currentIndex = (currentIndex - 1 + fileArray.length) % fileArray.length;
                    updateImage(currentIndex);
                }
            };
        }

        // ì´ë¯¸ì§€ ì¹´ìš´í„°
        const counter = overlay.createEl('div');
        counter.style.cssText = `
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
        `;

        // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        overlay.onclick = (e) => {
            if (e.target === overlay) {
                fileArray.forEach(file => {
                    if (imgEl.src) URL.revokeObjectURL(imgEl.src);
                });
                overlay.remove();
            }
        };

        // ESC í‚¤ë¡œ ë‹«ê¸°
        const handleKeyDown = (e) => {
            if (e.key === 'Escape') {
                fileArray.forEach(file => {
                    if (imgEl.src) URL.revokeObjectURL(imgEl.src);
                });
                overlay.remove();
                document.removeEventListener('keydown', handleKeyDown);
            } else if (fileArray.length > 1) {
                if (e.key === 'ArrowLeft') {
                    currentIndex = (currentIndex - 1 + fileArray.length) % fileArray.length;
                    updateImage(currentIndex);
                } else if (e.key === 'ArrowRight') {
                    currentIndex = (currentIndex + 1) % fileArray.length;
                    updateImage(currentIndex);
                }
            }
        };
        document.addEventListener('keydown', handleKeyDown);

        // ì´ˆê¸° ì´ë¯¸ì§€ ë¡œë“œ
        updateImage(currentIndex);
    }
}

// =====================================================
// ì²´í¬ë¦¬ìŠ¤íŠ¸ í…œí”Œë¦¿ ê´€ë¦¬ ëª¨ë‹¬
// =====================================================
class ChecklistTemplateModal extends Modal {
    constructor(app, plugin, onApply, currentItems = []) {
        super(app);
        this.plugin = plugin;
        this.onApply = onApply;
        this.currentItems = currentItems;
    }

    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        
        contentEl.createEl('h2', { text: 'ğŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸ í…œí”Œë¦¿' });
        
        // í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥
        if (this.currentItems.length > 0) {
            const saveSection = contentEl.createDiv();
            saveSection.style.cssText = 'background: var(--background-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px;';
            
            saveSection.createEl('h3', { text: 'í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í…œí”Œë¦¿ìœ¼ë¡œ ì €ì¥' });
            saveSection.createEl('p', { 
                text: `í˜„ì¬ ${this.currentItems.length}ê°œ í•­ëª©`,
                cls: 'setting-item-description'
            });
            
            const nameInput = saveSection.createEl('input', { 
                type: 'text', 
                placeholder: 'í…œí”Œë¦¿ ì´ë¦„ (ì˜ˆ: ì¼ì¼ ë£¨í‹´)' 
            });
            nameInput.style.cssText = 'width: 100%; padding: 8px; margin: 10px 0; font-size: 1em;';
            
            const saveBtn = saveSection.createEl('button', { text: 'ğŸ’¾ í˜„ì¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì €ì¥' });
            saveBtn.style.cssText = 'padding: 8px 16px; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer; width: 100%;';
            saveBtn.onclick = async () => {
                const name = nameInput.value.trim();
                if (!name) {
                    new Notice('í…œí”Œë¦¿ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                    return;
                }
                
                const items = this.currentItems.map(item => typeof item === 'string' ? item : item.text);
                this.plugin.settings.checklistTemplates.push({ name, items });
                await this.plugin.saveSettings();
                new Notice(`âœ… '${name}' í…œí”Œë¦¿ ì €ì¥ë¨`);
                this.onOpen(); // ìƒˆë¡œê³ ì¹¨
            };
        }
        
        // ì €ì¥ëœ í…œí”Œë¦¿ ëª©ë¡
        const templateSection = contentEl.createDiv();
        templateSection.style.cssText = 'margin-top: 20px;';
        
        templateSection.createEl('h3', { text: 'ì €ì¥ëœ í…œí”Œë¦¿' });
        
        const templates = this.plugin.settings.checklistTemplates || [];
        
        if (templates.length === 0) {
            templateSection.createEl('p', { 
                text: 'ì €ì¥ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤.',
                cls: 'setting-item-description'
            });
        } else {
            const templateList = templateSection.createDiv();
            templateList.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';
            
            templates.forEach((template, index) => {
                const templateBox = templateList.createDiv();
                templateBox.style.cssText = 'background: var(--background-secondary); padding: 12px; border-radius: 8px;';
                
                const header = templateBox.createDiv();
                header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;';
                
                header.createEl('strong', { text: template.name });
                header.createEl('span', { 
                    text: `${template.items.length}ê°œ í•­ëª©`,
                    cls: 'setting-item-description'
                });
                
                const itemPreview = templateBox.createDiv();
                itemPreview.style.cssText = 'font-size: 0.9em; color: var(--text-muted); margin-bottom: 8px;';
                itemPreview.setText(template.items.slice(0, 3).join(', ') + (template.items.length > 3 ? '...' : ''));
                
                const btnGroup = templateBox.createDiv();
                btnGroup.style.cssText = 'display: flex; gap: 8px;';
                
                const applyBtn = btnGroup.createEl('button', { text: 'ì ìš©' });
                applyBtn.style.cssText = 'flex: 1; padding: 6px 12px; background: var(--interactive-accent); color: white; border: none; border-radius: 6px; cursor: pointer;';
                applyBtn.onclick = () => {
                    this.onApply(template.items);
                    this.close();
                    new Notice(`âœ… '${template.name}' í…œí”Œë¦¿ ì ìš©ë¨`);
                };
                
                const editBtn = btnGroup.createEl('button', { text: 'ìˆ˜ì •' });
                editBtn.style.cssText = 'padding: 6px 12px; background: var(--background-modifier-border); border: none; border-radius: 6px; cursor: pointer;';
                editBtn.onclick = () => {
                    new TemplateEditModal(this.app, this.plugin, template, index, () => {
                        this.onOpen(); // ìƒˆë¡œê³ ì¹¨
                    }).open();
                };
                
                const deleteBtn = btnGroup.createEl('button', { text: 'ì‚­ì œ' });
                deleteBtn.style.cssText = 'padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;';
                deleteBtn.onclick = async () => {
                    new ConfirmModal(this.app, `'${template.name}' í…œí”Œë¦¿ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, async (confirmed) => {
                        if (confirmed) {
                            this.plugin.settings.checklistTemplates.splice(index, 1);
                            await this.plugin.saveSettings();
                            new Notice(`ğŸ—‘ï¸ '${template.name}' í…œí”Œë¦¿ ì‚­ì œë¨`);
                            this.onOpen(); // ìƒˆë¡œê³ ì¹¨
                        }
                    }).open();
                };
            });
        }
        
        const cancelBtn = contentEl.createEl('button', { text: 'ë‹«ê¸°' });
        cancelBtn.style.cssText = 'margin-top: 20px; padding: 8px 16px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px; cursor: pointer; width: 100%;';
        cancelBtn.onclick = () => this.close();
    }

    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}

// Obsidian í”ŒëŸ¬ê·¸ì¸ ë©”ì¸ export
module.exports = HanziQuizPlugin;